# 指标定义功能PRD文档

## 1. 功能目标

### 1.1 主要目标
- 为数字孪生平台提供完整的指标定义和管理功能
- 支持用户自定义业务指标的计算公式和参与变量
- 实现指标的可视化配置和实时计算
- 提供指标阈值设置和告警功能

### 1.2 具体目标
- 支持多种数量变量（静态属性、动态变量、业务属性）的指标计算
- 提供直观的公式编辑器，支持拖拽式变量插入
- 实现指标的分类管理和方向标识
- 支持指标的批量操作和状态管理

## 2. 功能描述

### 2.1 核心功能
- **指标列表管理**：显示所有已定义的指标，支持增删改查操作
- **指标定义编辑**：通过抽屉式界面编辑指标详细信息
- **公式编辑器**：支持拖拽式变量插入和语法高亮的公式编辑
- **变量选择器**：从静态属性、动态变量、业务属性中选择参与变量
- **阈值设置**：配置指标的警告和告警阈值

### 2.2 功能特点
- **抽屉式交互**：指标编辑采用从底部滑出的抽屉式界面
- **拖拽式操作**：支持拖拽变量到公式编辑器的任意位置
- **实时验证**：公式格式的实时校验和错误提示
- **分类管理**：支持指标的分类和方向标识

## 3. 交互说明

### 3.1 指标列表交互
- **查看指标**：点击指标名称链接，以只读模式查看指标详情
- **编辑指标**：点击编辑按钮，打开指标编辑抽屉
- **删除指标**：点击删除按钮，确认后删除指标
- **批量操作**：支持全选/取消全选，批量删除操作

### 3.2 指标编辑交互
- **抽屉打开**：从底部滑出，占据85%屏幕高度
- **表单填写**：按字段顺序填写指标信息
- **变量选择**：点击"添加变量"按钮，打开变量选择模态框
- **公式编辑**：在公式编辑器中输入计算公式

### 3.3 变量选择交互
- **模态框打开**：居中显示变量选择界面
- **分类切换**：通过标签页切换静态属性、动态变量、业务属性
- **搜索过滤**：支持变量名称的实时搜索
- **多选确认**：支持多选变量，确认后添加到参与变量列表

### 3.4 公式编辑交互
- **拖拽插入**：拖拽参与变量到公式编辑器的任意位置
- **运算符插入**：点击工具栏按钮插入运算符和函数
- **语法高亮**：实时显示变量、运算符、数字的不同颜色
- **格式验证**：点击校验按钮验证公式格式

## 4. 字段说明

### 4.1 基本信息字段
| 字段名称 | 字段类型 | 是否必填 | 说明 |
|---------|---------|---------|------|
| 指标名称 | 文本输入 | 是 | 指标名称，如"设备效率" |
| 指标编码 | 文本输入 | 是 | 指标的英文编码，如"device_efficiency" |
| 数据分类 | 下拉选择 | 是 | 性能、环境、安全、经济等分类 |
| 指标方向 | 单选按钮 | 是 | 正向（越大越好）、负向（越小越好） |
| 单位 | 文本输入 | 否 | 指标的单位，如"%"、"kWh/吨" |
| 计算周期 | 下拉选择 | 是 | 小时、天、月等计算周期 |
| 更新频率 | 下拉选择 | 是 | 指标更新的频率，如"1h"、"1d" |

### 4.2 计算公式字段
| 字段名称 | 字段类型 | 是否必填 | 说明 |
|---------|---------|---------|------|
| 参与变量 | 变量列表 | 是 | 参与计算的变量列表 |
| 计算公式 | 公式编辑器 | 是 | 使用参与变量编写的计算公式 |



### 4.3 其他字段
| 字段名称 | 字段类型 | 是否必填 | 说明 |
|---------|---------|---------|------|
| 显示顺序 | 数字输入 | 否 | 指标在列表中的显示顺序 |
| 描述 | 文本域 | 否 | 指标的详细描述信息 |

## 5. 业务规则

### 5.1 指标命名规则
- **指标名称**：长度2-20个字符
- **指标编码**：必须为英文，长度3-50个字符，只能包含字母、数字、下划线
- **编码唯一性**：同一资产类型下指标编码必须唯一

### 5.2 计算公式规则
- **变量引用**：只能使用已添加到参与变量列表中的变量
- **运算符支持**：支持+、-、*、/、()、=、%、**等运算符
- **函数支持**：支持sqrt、abs、max、min、avg、sum、count、if、round、floor、ceil等函数
- **括号匹配**：左右括号必须成对出现
- **除零检查**：公式中不能出现除零操作

### 5.3 参与变量规则
- **变量来源**：只能从静态属性、动态变量、业务属性中选择
- **变量数量**：参与变量数量不限，但建议不超过10个
- **变量重复**：同一变量不能在参与变量列表中重复出现
- **变量状态**：只能选择状态为"启用"的变量



### 5.4 计算周期规则
- **周期选择**：计算周期必须与更新频率匹配
  - 小时级周期：更新频率为1h、2h等
  - 天级周期：更新频率为1d、7d等
  - 月级周期：更新频率为1m、3m等
- **实时计算**：支持实时计算和定时计算两种模式

### 5.5 数据分类规则
- **分类定义**：预定义性能、环境、安全、经济四大分类
- **分类用途**：用于指标的分类管理和统计分析
- **分类扩展**：支持后续添加新的分类

### 5.6 指标方向规则
- **正向指标**：数值越大表示越好，如效率、产量等
- **负向指标**：数值越小表示越好，如能耗、成本等
- **方向影响**：指标方向影响指标的计算逻辑

### 5.7 权限控制规则
- **查看权限**：所有用户都可以查看指标列表和详情
- **编辑权限**：只有具有指标管理权限的用户才能编辑指标
- **删除权限**：只有具有指标管理权限的用户才能删除指标
- **操作日志**：所有指标操作都需要记录操作日志

### 5.8 数据验证规则
- **必填字段**：指标名称、指标编码、数据分类、指标方向、计算公式为必填
- **格式验证**：指标编码必须符合命名规范
- **公式验证**：计算公式必须通过语法检查


### 5.9 状态管理规则
- **启用状态**：新创建的指标默认为启用状态
- **停用状态**：停用的指标不会参与计算
- **删除状态**：删除的指标会从列表中移除，但保留历史数据
- **状态变更**：状态变更需要记录操作人和操作时间 