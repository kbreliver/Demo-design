# 计算公式配置 - 三种输入模式功能说明

## 功能概述

在工厂模型管理页面的数据绑定配置中，我们实现了三种不同的公式输入模式，满足不同用户的使用习惯和技术水平：

1. **自然语言输入** - AI理解并翻译成表达式
2. **可视化输入** - 可双击变量名、点击符号
3. **表达式输入** - 直接编辑变量编码和表达式

所有模式都支持自动转换为标准表达式格式，并提供完整的语法验证功能。

## 三种输入模式详解

### 1. 自然语言输入模式

#### 功能特点
- 支持中文自然语言描述计算公式
- AI自动翻译为标准表达式
- 实时翻译状态显示
- 智能识别变量名和运算符

#### 使用示例
```
输入：温度传感器1的值加上温度传感器2的值除以2
输出：[RTU].[温度传感器1] + [RTU].[温度传感器2] / 2

输入：如果温度传感器1大于80度，那么温度乘以1.2，否则保持原值
输出：if [RTU].[温度传感器1] > 80 then [RTU].[温度传感器1] * 1.2 else [RTU].[温度传感器1]
```

#### 支持的翻译规则
- **变量识别**：温度传感器1、温度1、压力传感器1、压力1、电流传感器1、电流1
- **运算符翻译**：
  - 加/加上/+ → +
  - 减/减去/- → -
  - 乘/乘以/* → *
  - 除/除以// → /
  - 大于/> → >
  - 小于/< → <
  - 等于/= → =
  - 并且/且/and → and
  - 或者/或/or → or

### 2. 可视化输入模式

#### 功能特点
- 双击变量名快速插入
- 点击运算符按钮添加符号
- 实时预览公式构建过程
- 支持数字输入
- 直观的拖拽式操作

#### 操作方式
1. **变量插入**：双击变量列表中的变量名
2. **运算符插入**：点击运算符按钮
3. **数字输入**：在数字输入框中输入数值，点击"添加"按钮
4. **实时预览**：在公式预览区域查看当前构建的公式

#### 界面元素
- **公式预览区**：显示当前构建的公式
- **变量列表**：显示可用的数据点位变量
- **数字输入**：输入常数值
- **运算符工具栏**：分类显示各种运算符

### 3. 表达式输入模式

#### 功能特点
- 直接编辑标准表达式格式
- 支持完整的语法高亮
- 实时语法检查
- 专业的编程体验

#### 表达式格式
```
[数据源].[变量名] 运算符 [数据源].[变量名]
```

#### 示例
```
[RTU].[温度传感器1] + [RTU].[温度传感器2] / 2
[RTU].[温度传感器1] > 50 and [RTU].[压力传感器1] < 100
if [RTU].[温度传感器1] > 80 then [RTU].[温度传感器1] * 1.2 else [RTU].[温度传感器1]
```

## 核心功能

### 1. 模式间自动转换

#### 转换规则
- **自然语言 → 表达式**：AI翻译后自动更新表达式
- **可视化 → 表达式**：实时同步可视化构建结果到表达式
- **表达式 → 可视化**：切换到可视化模式时自动解析表达式

#### 转换示例
```
自然语言：温度传感器1加上温度传感器2
↓ AI翻译
表达式：[RTU].[温度传感器1] + [RTU].[温度传感器2]
↓ 可视化解析
可视化：[温度传感器1] [+] [温度传感器2]
```

### 2. 语法验证功能

#### 验证项目
- **括号匹配检查**：方括号[]和圆括号()的匹配
- **if-then结构检查**：条件语句的完整性
- **变量格式检查**：数据源和变量名的格式
- **运算符语法检查**：运算符的使用是否正确

#### 验证结果
- ✅ 语法正确：显示成功消息
- ❌ 语法错误：显示具体错误信息和建议

### 3. 运算符支持

#### 算术运算符
- `+` 加法
- `-` 减法
- `*` 乘法
- `/` 除法
- `(` `)` 圆括号
- `=` 等于
- `%` 取模
- `**` 幂运算

#### 逻辑运算符
- `and` 逻辑与
- `or` 逻辑或
- `!` 逻辑非
- `==` 等于
- `!=` 不等于
- `>` 大于
- `<` 小于
- `>=` 大于等于
- `<=` 小于等于

#### 条件运算符
- `if` 条件判断
- `then` 条件成立时执行
- `else` 条件不成立时执行

## 技术实现

### 1. 前端架构
- **Vue.js**：响应式数据绑定
- **Element UI**：UI组件库
- **CSS3**：现代化样式设计

### 2. 核心方法
- `handleInputModeChange()`：处理输入模式切换
- `handleNaturalLanguageInput()`：处理自然语言输入
- `translateNaturalLanguage()`：自然语言翻译
- `insertVariable()`：插入变量
- `insertOperator()`：插入运算符
- `insertNumber()`：插入数字
- `syncVisualToExpression()`：可视化转表达式
- `syncExpressionToVisual()`：表达式转可视化
- `validateFormula()`：公式验证

### 3. 数据结构
```javascript
{
  formulaInputMode: 'expression', // 当前输入模式
  naturalLanguageInput: '', // 自然语言输入
  isTranslating: false, // 翻译状态
  translatedExpression: '', // 翻译结果
  visualFormulaParts: [], // 可视化公式部分
  numberInput: '' // 数字输入
}
```

## 用户体验优化

### 1. 界面设计
- **标签页切换**：清晰的模式区分
- **颜色主题**：不同运算符类型使用不同颜色
- **响应式布局**：适配不同屏幕尺寸
- **动画效果**：平滑的交互体验

### 2. 操作便利性
- **一键切换**：模式间无缝切换
- **实时预览**：即时查看输入结果
- **智能提示**：操作引导和错误提示
- **快捷键支持**：提高操作效率

### 3. 错误处理
- **输入验证**：实时检查输入格式
- **错误提示**：友好的错误信息
- **自动修复**：智能纠错建议
- **撤销功能**：支持操作回退

## 测试验证

### 测试页面
- `test-formula-input-modes.html`：完整的功能测试页面

### 测试项目
1. **模式切换测试**：验证三种模式间的切换
2. **自然语言翻译测试**：验证AI翻译准确性
3. **可视化构建测试**：验证拖拽式操作
4. **表达式编辑测试**：验证直接编辑功能
5. **语法验证测试**：验证错误检测功能
6. **自动转换测试**：验证模式间数据同步

### 测试用例
```
自然语言测试：
输入："温度传感器1大于50并且压力传感器1小于100"
预期：[RTU].[温度传感器1] > 50 and [RTU].[压力传感器1] < 100

可视化测试：
双击变量 → 点击运算符 → 输入数字 → 验证结果

表达式测试：
直接输入复杂表达式 → 验证语法 → 检查结果
```

## 后续优化计划

### 1. AI功能增强
- 集成真实的AI翻译服务
- 支持更复杂的自然语言理解
- 添加机器学习优化翻译准确性

### 2. 可视化功能扩展
- 支持公式模板库
- 添加拖拽排序功能
- 实现公式可视化预览

### 3. 表达式功能增强
- 添加语法高亮显示
- 支持代码补全功能
- 实现公式调试工具

### 4. 用户体验提升
- 添加操作历史记录
- 支持公式收藏功能
- 实现批量公式处理

## 兼容性说明

- **浏览器支持**：Chrome、Firefox、Safari、Edge
- **移动端适配**：响应式设计，支持移动设备
- **数据格式**：兼容现有的数据绑定配置格式
- **向后兼容**：保持与原有功能的完全兼容 