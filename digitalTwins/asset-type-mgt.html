<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>资产类型管理 - 数字孪生平台</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* 上方基本信息区域 */
        .asset-info-header {
            background: white;
            padding: 15px 30px;
            margin-bottom: 0;
            border-bottom: 1px solid #ebeef5;
            box-shadow: 0 2px 4px rgba(0,0,0,0.12), 0 0 6px rgba(0,0,0,0.04);
            width: 100%;
        }

        .asset-info-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .asset-basic-info {
            flex: 1;
        }

        .asset-name {
            font-size: 24px;
            font-weight: 600;
            color: #303133;
            margin-bottom: 6px;
        }

        .asset-desc {
            color: #606266;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .asset-tags {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .tag {
            background-color: #ecf5ff;
            color: #409eff;
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            border: 1px solid #d9ecff;
        }

        .asset-actions {
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 10px 16px;
            border: 1px solid #dcdfe6;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            background: #ffffff;
            color: #606266;
            line-height: 1;
            white-space: nowrap;
            outline: none;
        }

        .btn:hover {
            color: #409eff;
            border-color: #c6e2ff;
            background-color: #ecf5ff;
        }

        .btn-primary {
            background: #409eff;
            border-color: #409eff;
            color: #ffffff;
        }

        .btn-primary:hover {
            background: #66b1ff;
            border-color: #66b1ff;
            color: #ffffff;
        }

        .btn-success {
            background: #67c23a;
            border-color: #67c23a;
            color: #ffffff;
        }

        .btn-success:hover {
            background: #85ce61;
            border-color: #85ce61;
            color: #ffffff;
        }

        .btn-warning {
            background: #e6a23c;
            border-color: #e6a23c;
            color: #ffffff;
        }

        .btn-warning:hover {
            background: #ebb563;
            border-color: #ebb563;
            color: #ffffff;
        }

        .btn-danger {
            background: #f56c6c;
            border-color: #f56c6c;
            color: #ffffff;
        }

        .btn-danger:hover {
            background: #f78989;
            border-color: #f78989;
            color: #ffffff;
        }

        .btn-back {
            background: #f5f7fa;
            border-color: #dcdfe6;
            color: #606266;
            font-size: 13px;
            padding: 8px 12px;
        }

        .btn-back:hover {
            background: #e6e8eb;
            border-color: #c0c4cc;
            color: #409eff;
        }

        /* 下方内容区域 */
        .content-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* 左侧步骤导航 */
        .sidebar {
            width: 320px;
            background: #ffffff;
            color: #303133;
            padding: 15px 0;
            border-right: 1px solid #ebeef5;
            box-shadow: 0 2px 4px rgba(0,0,0,0.12), 0 0 6px rgba(0,0,0,0.04);
        }

        .sidebar-header {
            padding: 0 20px 15px;
            border-bottom: 1px solid #ebeef5;
            margin-bottom: 15px;
        }

        .sidebar-header h2 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
            color: #303133;
        }

        .sidebar-header p {
            font-size: 12px;
            color: #909399;
        }

        /* 步骤导航样式 */
        .step-nav {
            padding: 0 20px;
        }

        .step-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-left: 3px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .step-item:hover {
            background-color: #f5f7fa;
            border-left-color: #c0c4cc;
        }

        .step-item.active {
            background-color: #ecf5ff;
            border-left-color: #409eff;
        }

        .step-item.completed {
            border-left-color: #67c23a;
        }

        .step-number {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background-color: #f5f7fa;
            border: 1px solid #dcdfe6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-right: 12px;
            font-size: 13px;
            color: #909399;
        }

        .step-item.active .step-number {
            background-color: #409eff;
            border-color: #409eff;
            color: #ffffff;
        }

        .step-item.completed .step-number {
            background-color: #67c23a;
            border-color: #67c23a;
            color: #ffffff;
        }

        .step-content {
            flex: 1;
        }

        .step-title {
            font-weight: 600;
            margin-bottom: 2px;
            font-size: 14px;
            color: #303133;
        }

        .step-desc {
            font-size: 12px;
            color: #909399;
        }

        /* 主内容区域 */
        .main-content {
            flex: 1;
            padding: 0;
            overflow-y: auto;
        }

        /* 资产详细信息 */
        .asset-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 0;
            padding-top: 0;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-size: 12px;
            color: #909399;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .detail-value {
            font-size: 14px;
            color: #303133;
            font-weight: 600;
        }

        /* 内容区域 */
        .content-area {
            background: white;
            padding: 15px;
            min-height: 400px;
            border-bottom: 1px solid #ebeef5;
        }

        .content-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 300px;
            color: #909399;
            font-size: 16px;
        }

        /* 状态标签 */
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            border: 1px solid;
        }

        .status-active {
            background-color: #f0f9ff;
            color: #67c23a;
            border-color: #b3d8ff;
        }

        .status-draft {
            background-color: #fdf6ec;
            color: #e6a23c;
            border-color: #f5dab1;
        }

        .status-fixed {
            background-color: #f0f9ff;
            color: #409eff;
            border-color: #b3d8ff;
        }

        .status-system {
            background-color: #f0f9ff;
            color: #67c23a;
            border-color: #b3d8ff;
        }

        .status-custom {
            background-color: #fdf6ec;
            color: #e6a23c;
            border-color: #f5dab1;
        }

        /* 隐藏页面 */
        .page-content {
            display: none;
        }

        .page-content.active {
            display: block;
        }

        /* 新增样式 */
        .basic-info-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-section {
            background: #f9fafc;
            padding: 15px 20px;
            border-radius: 8px;
            border: 1px solid #ebeef5;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #303133;
            margin-bottom: 15px;
            border-bottom: 1px solid #ebeef5;
            padding-bottom: 10px;
        }

        .form-grid { 
            display: grid; 
            grid-template-columns: 2fr 1fr; 
            gap: 30px; 
            align-items: start; 
        }

        .nested-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 15px; 
            width: 100%; 
        }

        /* 图片上传区域样式 */
        .image-upload-section {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .image-upload-area {
            border: 1px dashed #dcdfe6;
            border-radius: 4px;
            padding: 20px;
            text-align: center;
            margin-top: 10px;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #fafafa;
            transition: border-color 0.3s ease;
        }

        .image-upload-area:hover {
            border-color: #409eff;
        }

        .upload-placeholder {
            width: 120px;
            height: 120px;
            background-color: #f5f7fa;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            border: 1px solid #ebeef5;
        }

        .upload-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .upload-buttons .btn {
            padding: 8px 12px;
            font-size: 12px;
        }

        .upload-tip {
            font-size: 12px;
            color: #909399;
            line-height: 1.4;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.description-group,
        .form-group.tags-group {
            grid-column: 1 / -1;
        }

        .form-label {
            font-size: 14px;
            color: #606266;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-label.required::after {
            content: " *";
            color: #f56c6c;
            font-weight: 600;
        }

        .form-input, .form-textarea, .form-select {
            padding: 10px 12px;
            border: 1px solid #dcdfe6;
            border-radius: 4px;
            font-size: 14px;
            color: #303133;
            outline: none;
            transition: border-color 0.3s;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            border-color: #409eff;
        }

        .form-input.required.error, .form-textarea.required.error, .form-select.required.error {
            border-color: #f56c6c;
        }

        .form-input.required.error:focus, .form-textarea.required.error:focus, .form-select.required.error:focus {
            border-color: #f56c6c;
            box-shadow: 0 0 0 2px rgba(245, 108, 108, 0.2);
        }

        /* 禁用状态样式 */
        .form-select:disabled {
            background-color: #f5f7fa;
            color: #c0c4cc;
            cursor: not-allowed;
        }

        .form-select[multiple] {
            min-height: 100px;
        }

        .form-select[multiple] option {
            padding: 8px 12px;
        }

        .form-select[multiple] option:checked {
            background-color: #409eff;
            color: white;
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 0;
            padding-top: 0;
            min-height: 32px; /* 与select框高度保持一致 */
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            height: 100%;
        }

        .checkbox-label input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
            width: 16px;
            height: 16px;
        }

        .checkbox-text {
            margin-left: 8px;
            font-size: 14px;
            color: #606266;
            line-height: 1.4;
        }

        .log-table {
            overflow-x: auto;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            color: #606266;
        }

        .table th, .table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #ebeef5;
        }

        .table th {
            background-color: #f5f7fa;
            font-weight: 600;
            color: #303133;
        }

        .table tbody tr:hover {
            background-color: #f5f7fa;
        }

        .form-row {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .form-row .form-group {
            flex: 1;
        }

                /* 继承关系特殊样式 */
        .form-row .form-group:first-child {
            flex: 1;
        }

        .form-row .form-group:last-child {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .form-row .form-group:last-child .form-label {
            margin-bottom: 8px; /* 确保label间距一致 */
        }

        .form-row .form-group:last-child .checkbox-group {
            padding-top: 0;
            height: 32px; /* 与select框高度完全一致 */
            display: flex;
            align-items: center;
        }

        /* 父类型容器样式 */
        .parent-type-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .parent-type-container .form-select {
            flex: 1;
        }

        .parent-type-container .btn {
            white-space: nowrap;
            flex-shrink: 0;
        }

        /* 警告消息样式 */
        .warning-message {
            display: flex;
            gap: 15px;
            align-items: flex-start;
        }

        .warning-icon {
            font-size: 24px;
            color: #e6a23c;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .warning-content h4 {
            margin: 0 0 10px 0;
            color: #303133;
            font-size: 16px;
        }

        .warning-content p {
            margin: 0 0 10px 0;
            color: #606266;
            font-size: 14px;
        }

        .warning-content ul {
            margin: 0;
            padding-left: 20px;
            color: #606266;
            font-size: 14px;
            line-height: 1.6;
        }

        .warning-content li {
            margin-bottom: 5px;
        }

        /* 数据标签多选样式 */
        .placeholder-text {
            color: #c0c4cc;
            font-style: italic;
        }

        .selected-tags .tag-item {
            display: inline-flex;
            align-items: center;
            background-color: #ecf5ff;
            color: #409eff;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 12px;
            margin-right: 5px;
            margin-bottom: 3px;
        }

        .selected-tags .tag-remove {
            margin-left: 5px;
            cursor: pointer;
            font-weight: bold;
            color: #409eff;
        }

        .selected-tags .tag-remove:hover {
            color: #f56c6c;
        }

        /* Custom Select Styles */
        .custom-select {
            position: relative;
            width: 100%;
        }

        .select-trigger {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            border: 1px solid #dcdfe6;
            border-radius: 4px;
            background-color: #ffffff;
            cursor: pointer;
            font-size: 14px;
            color: #303133;
            transition: border-color 0.3s;
        }

        .select-trigger:hover {
            border-color: #c6e2ff;
        }

        .select-trigger.active {
            border-color: #409eff;
            box-shadow: 0 0 0 2px rgba(64, 158, 255, 0.2);
        }

        .select-arrow {
            font-size: 12px;
            color: #909399;
            transition: transform 0.3s ease;
        }

        .select-trigger.active .select-arrow {
            transform: rotate(180deg);
        }

        .select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background-color: #ffffff;
            border: 1px solid #ebeef5;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 10;
            max-height: 200px; /* Limit height for dropdown */
            overflow-y: auto;
            display: none; /* Hidden by default */
        }

        .select-dropdown.active {
            display: block;
        }

        .select-option {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .select-option:hover {
            background-color: #f5f7fa;
        }

        .select-option input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(0.8);
        }

        .selected-text {
            flex-grow: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .selected-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            flex-grow: 1;
            min-height: 20px;
        }

        .tag-item {
            display: inline-flex;
            align-items: center;
            background-color: #ecf5ff;
            color: #409eff;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            border: 1px solid #d9ecff;
            cursor: default;
        }

        .tag-remove {
            margin-left: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            line-height: 1;
            color: #409eff;
            transition: color 0.2s;
        }

                 .tag-remove:hover {
             color: #f56c6c;
         }

         /* 静态属性定义样式 */

         .property-table-container {
             overflow-x: auto;
             border: 1px solid #ebeef5;
             border-radius: 6px;
         }

         .property-table {
             width: 100%;
             border-collapse: collapse;
             font-size: 13px;
             color: #606266;
         }

         .property-table th {
             background-color: #f5f7fa;
             padding: 12px 8px;
             text-align: left;
             font-weight: 600;
             color: #303133;
             border-bottom: 1px solid #ebeef5;
             white-space: nowrap;
         }

         .property-table td {
             padding: 12px 8px;
             border-bottom: 1px solid #ebeef5;
             white-space: nowrap;
         }

         .property-table tbody tr:hover {
             background-color: #f5f7fa;
         }

         .btn-sm {
             padding: 6px 10px;
             font-size: 12px;
             border-radius: 3px;
         }

         /* 模态框样式 */
         .modal-overlay {
             position: fixed;
             top: 0;
             left: 0;
             width: 100%;
             height: 100%;
             background-color: rgba(0, 0, 0, 0.5);
             display: none;
             justify-content: center;
             align-items: center;
             z-index: 1000;
         }

         .modal-overlay.active {
             display: flex;
         }

         .modal-content {
             background-color: #ffffff;
             border-radius: 8px;
             padding: 20px;
             min-width: 500px;
             max-width: 600px;
             max-height: 80vh;
             overflow-y: auto;
             box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
         }

         .modal-header {
             display: flex;
             justify-content: space-between;
             align-items: center;
             margin-bottom: 20px;
             padding-bottom: 15px;
             border-bottom: 1px solid #ebeef5;
         }

         .modal-title {
             font-size: 18px;
             font-weight: 600;
             color: #303133;
         }

         .modal-close {
             background: none;
             border: none;
             font-size: 20px;
             cursor: pointer;
             color: #909399;
             padding: 0;
             width: 24px;
             height: 24px;
             display: flex;
             align-items: center;
             justify-content: center;
         }

         .modal-close:hover {
             color: #606266;
         }

         .modal-form {
             display: flex;
             flex-direction: column;
             gap: 15px;
         }

         .form-row {
             display: grid;
             grid-template-columns: 1fr 1fr;
             gap: 15px;
         }

         .form-row.full-width {
             grid-template-columns: 1fr;
         }

         .modal-actions {
             display: flex;
             justify-content: flex-end;
             gap: 10px;
             margin-top: 20px;
             padding-top: 15px;
             border-top: 1px solid #ebeef5;
         }

         .property-group-selector {
             display: flex;
             flex-direction: column;
             gap: 10px;
             margin-top: 10px;
         }

         .group-selector-item {
             padding: 10px;
             border: 1px solid #ebeef5;
             border-radius: 4px;
             background-color: #fafafa;
             transition: all 0.3s ease;
         }

         .group-selector-item:hover {
             border-color: #c6e2ff;
             background-color: #f0f9ff;
         }

         .group-selector-item {
             padding: 12px;
             border: 1px solid #ebeef5;
             border-radius: 6px;
             background-color: #fafafa;
             transition: all 0.3s ease;
             cursor: pointer;
         }

         .group-selector-item:hover {
             border-color: #c6e2ff;
             background-color: #f0f9ff;
         }

         .group-selector-item.selected {
             border-color: #409eff;
             background-color: #ecf5ff;
         }

         .group-item-header {
             display: flex;
             align-items: center;
             gap: 10px;
             margin-bottom: 6px;
         }

         .group-item-name {
             font-weight: 500;
             color: #303133;
             flex: 1;
         }

         .group-item-count {
             background-color: #f0f0f0;
             color: #606266;
             padding: 2px 6px;
             border-radius: 10px;
             font-size: 12px;
         }

         .group-item-description {
             color: #909399;
             font-size: 13px;
             line-height: 1.4;
             margin-top: 4px;
         }

         .group-item-category {
             background-color: #e1f3d8;
             color: #67c23a;
             padding: 2px 6px;
             border-radius: 10px;
             font-size: 11px;
             margin-left: auto;
         }

         .no-results {
             text-align: center;
             color: #909399;
             padding: 20px;
             font-style: italic;
         }

         /* 系统字段样式 */
         .property-checkbox:disabled {
             cursor: not-allowed;
             opacity: 0.6;
         }

         .system-field-row {
             background-color: #f8f9fa;
         }

         .system-field-row:hover {
             background-color: #e9ecef;
         }

         /* 左侧抽屉样式 */
         .drawer-backdrop {
             position: fixed;
             top: 0;
             left: 0;
             width: 100%;
             height: 100%;
             background-color: rgba(0, 0, 0, 0.5);
             z-index: 1000;
             visibility: hidden;
             opacity: 0;
             transition: all 0.3s;
         }

         .drawer-backdrop.active {
             visibility: visible;
             opacity: 1;
         }

         .drawer {
             position: fixed;
             top: 0;
             right: -700px;
             width: 700px;
             height: 100%;
             background-color: white;
             box-shadow: -2px 0 8px rgba(0, 0, 0, 0.15);
             transition: right 0.3s ease;
             z-index: 1001;
             display: flex;
             flex-direction: column;
         }

         .drawer-backdrop.active .drawer {
             right: 0;
         }

         /* 规则抽屉特殊样式 - 从下方滑出 */
         #rule-drawer .drawer {
             position: fixed;
             bottom: -100%;
             left: 0;
             right: 0;
             width: 100% !important;
             height: 85vh;
             background-color: #fff;
             box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.15);
             transition: bottom 0.3s ease;
             display: flex;
             flex-direction: column;
             border-radius: 8px 8px 0 0;
             top: auto;
         }

         #rule-drawer.drawer-backdrop.active .drawer {
             bottom: 0;
         }

         .drawer-header {
             padding: 20px 24px;
             border-bottom: 1px solid #ebeef5;
             display: flex;
             justify-content: space-between;
             align-items: center;
             background-color: #fafafa;
         }

         /* 指标抽屉特殊头部布局 */
         #indicator-drawer .drawer-header {
             padding: 24px 48px;
         }

         .drawer-title {
             font-size: 18px;
             font-weight: 600;
             color: #303133;
         }

         .drawer-close {
             background: none;
             border: none;
             font-size: 20px;
             cursor: pointer;
             color: #909399;
             transition: color 0.2s;
             width: 32px;
             height: 32px;
             display: flex;
             align-items: center;
             justify-content: center;
             border-radius: 4px;
         }

         .drawer-close:hover {
             color: #f56c6c;
             background-color: #fef0f0;
         }

         .drawer-body {
             flex: 1;
             overflow-y: auto;
             padding: 24px;
         }

         /* 指标抽屉特殊布局 */
         #indicator-drawer .drawer-body {
             padding: 32px 48px;
         }

         .drawer-footer {
             padding: 16px 24px;
             border-top: 1px solid #ebeef5;
             display: flex;
             justify-content: flex-end;
             gap: 12px;
             background-color: #fafafa;
         }

         /* 指标抽屉特殊底部布局 */
         #indicator-drawer .drawer-footer {
             padding: 20px 48px;
         }

         /* 抽屉表单样式 */
         .drawer-form {
             display: flex;
             flex-direction: column;
             gap: 20px;
         }

         .drawer-form-row {
             display: grid;
             grid-template-columns: 1fr 1fr;
             gap: 20px;
         }

         .drawer-form-row.full-width {
             grid-template-columns: 1fr;
         }

         .drawer-form-group {
             display: flex;
             flex-direction: column;
         }

         .drawer-form-label {
             font-size: 14px;
             color: #606266;
             margin-bottom: 8px;
             font-weight: 500;
         }

         .drawer-form-label.required::after {
             content: " *";
             color: #f56c6c;
             font-weight: 600;
         }

         .drawer-form-input, .drawer-form-textarea, .drawer-form-select {
             width: 100%;
             padding: 10px 12px;
             border: 1px solid #dcdfe6;
             border-radius: 4px;
             font-size: 14px;
             color: #303133;
             outline: none;
             transition: border-color 0.3s;
             box-sizing: border-box;
         }

         .drawer-form-textarea {
             min-height: 80px;
             resize: vertical;
         }

         .drawer-form-input:focus, .drawer-form-textarea:focus, .drawer-form-select:focus {
             border-color: #409eff;
         }

         .drawer-form-hint {
             font-size: 12px;
             color: #909399;
             margin-top: 4px;
         }

         .drawer-checkbox-group {
             display: flex;
             align-items: center;
             gap: 10px;
             margin-top: 0;
             padding-top: 8px;
         }

         .drawer-checkbox-label {
             display: flex;
             align-items: center;
             cursor: pointer;
         }

         .drawer-checkbox-label input[type="checkbox"] {
             margin: 0;
             cursor: pointer;
         }

         .drawer-checkbox-text {
             margin-left: 5px;
             font-size: 14px;
             color: #606266;
         }

         /* 链接样式 */
         .property-link, .variable-link, .business-property-link, .indicator-link {
             color: #409eff;
             text-decoration: none;
             font-weight: 500;
             transition: color 0.2s;
         }

         .property-link:hover, .variable-link:hover, .business-property-link:hover, .indicator-link:hover {
             color: #66b1ff;
             text-decoration: underline;
         }

         /* 指标相关样式 */
         .variable-selector {
             border: 1px solid #dcdfe6;
             border-radius: 4px;
             padding: 10px;
             background-color: #fafafa;
             min-height: 200px;
         }

         .variable-list {
             margin-bottom: 10px;
             max-height: 150px;
             overflow-y: auto;
         }

         .variable-item {
             display: flex;
             align-items: center;
             justify-content: space-between;
             padding: 8px;
             margin-bottom: 5px;
             background-color: #fff;
             border: 1px solid #e4e7ed;
             border-radius: 4px;
         }

         .variable-item .variable-item-info {
             display: flex;
             align-items: center;
             gap: 8px;
             flex: 1;
             flex-wrap: wrap;
         }

         .variable-item:last-child {
             margin-bottom: 0;
         }

         .variable-item-name {
             font-weight: 500;
             color: #303133;
         }

         /* 参与变量列表中的变量名称样式 */
         .variable-item {
             cursor: grab;
             user-select: none;
         }
         
         .variable-item:active {
             cursor: grabbing;
         }
         
         .variable-item.dragging {
             opacity: 0.5;
         }
         
         .variable-item .variable-item-name {
             font-size: 13px;
             cursor: grab;
             user-select: none;
         }

         .variable-item .variable-item-name:hover {
             color: #409eff;
             text-decoration: underline;
         }
         
         .variable-item .variable-item-name:active {
             cursor: grabbing;
         }
         
         .variable-item-description {
             font-size: 12px;
             color: #909399;
             margin-left: 8px;
             font-style: italic;
             flex-basis: 100%;
             margin-top: 4px;
         }
         
         .formula-display.drag-over {
             background-color: #f0f8ff;
             border: 2px dashed #007bff;
         }
         
         .formula-display .drop-indicator {
             display: none;
             position: absolute;
             width: 2px;
             height: 20px;
             background-color: #007bff;
             animation: blink 1s infinite;
             pointer-events: none;
             z-index: 1000;
         }
         
         @keyframes blink {
             0%, 50% { opacity: 1; }
             51%, 100% { opacity: 0; }
         }

         .variable-item-remove {
             color: #f56c6c;
             cursor: pointer;
             font-size: 16px;
             line-height: 1;
         }



         /* 指标抽屉特殊样式 - 从下方滑出 */
         #indicator-drawer .drawer {
             position: fixed;
             bottom: -100%;
             left: 0;
             right: 0;
             width: 100%;
             height: 85vh;
             background-color: #fff;
             box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.15);
             transition: bottom 0.3s ease;
             display: flex;
             flex-direction: column;
             border-radius: 8px 8px 0 0;
             top: auto;
         }

         #indicator-drawer.drawer-backdrop.active .drawer {
             bottom: 0;
         }

         /* 指标方向样式 */
         .direction-badge {
             display: inline-block;
             padding: 2px 8px;
             border-radius: 12px;
             font-size: 12px;
             font-weight: 500;
             text-align: center;
             min-width: 40px;
         }

         .direction-positive {
             background-color: #f0f9ff;
             color: #0369a1;
             border: 1px solid #0ea5e9;
         }

         .direction-negative {
             background-color: #fef2f2;
             color: #dc2626;
             border: 1px solid #f87171;
         }

         /* 公式输入容器样式 */
         .formula-input-container {
             display: flex;
             flex-direction: column;
             gap: 10px;
         }

         .formula-editor {
             border: 1px solid #dcdfe6;
             border-radius: 4px;
             background-color: #fff;
         }

         .formula-toolbar {
             display: flex;
             flex-wrap: wrap;
             gap: 4px;
             padding: 8px;
             border-bottom: 1px solid #ebeef5;
             background-color: #fafafa;
         }

         .formula-btn {
             padding: 4px 8px;
             border: 1px solid #dcdfe6;
             border-radius: 3px;
             background-color: #fff;
             color: #606266;
             font-size: 12px;
             cursor: pointer;
             transition: all 0.2s;
             min-width: 24px;
             text-align: center;
         }

         .formula-btn:hover {
             background-color: #409eff;
             color: #fff;
             border-color: #409eff;
         }

         .formula-btn:active {
             transform: scale(0.95);
         }

         .formula-input-wrapper {
             position: relative;
         }

         .formula-textarea {
             width: 100%;
             min-height: 100px;
             padding: 12px;
             border: none;
             outline: none;
             resize: vertical;
             font-family: 'Courier New', monospace;
             font-size: 14px;
             line-height: 1.5;
             background-color: #fff;
         }

         .formula-textarea:focus {
             background-color: #fafafa;
         }

         .formula-display {
             width: 100%;
             min-height: 100px;
             padding: 12px;
             border: none;
             outline: none;
             font-family: 'Courier New', monospace;
             font-size: 14px;
             line-height: 1.5;
             background-color: #fff;
             overflow-y: auto;
             white-space: pre-wrap;
             word-wrap: break-word;
         }

         .formula-display:focus {
             background-color: #fafafa;
         }

         .formula-display:empty:before {
             content: attr(placeholder);
             color: #c0c4cc;
             pointer-events: none;
         }

         /* 变量徽标样式 */
         .variable-badge {
             display: inline-block;
             background-color: #e1f3d8;
             color: #67c23a;
             padding: 2px 6px;
             border-radius: 12px;
             font-size: 12px;
             font-weight: 500;
             margin: 0 2px;
             border: 1px solid #b3d8a4;
             cursor: pointer;
             transition: all 0.2s;
         }

         .variable-badge:hover {
             background-color: #f0f9ff;
             color: #409eff;
             border-color: #409eff;
         }

         /* 运算符颜色样式 */
         .operator-plus { color: #67c23a; font-weight: bold; }
         .operator-minus { color: #f56c6c; font-weight: bold; }
         .operator-multiply { color: #e6a23c; font-weight: bold; }
         .operator-divide { color: #909399; font-weight: bold; }
         .operator-equals { color: #409eff; font-weight: bold; }
         .operator-percent { color: #9c27b0; font-weight: bold; }
         .operator-power { color: #ff9800; font-weight: bold; }
         .operator-bracket { color: #607d8b; font-weight: bold; }

         /* 函数样式 */
         .function-name {
             color: #673ab7;
             font-weight: bold;
         }

         /* 数字样式 */
         .number {
             color: #2196f3;
             font-weight: 500;
         }

         .formula-status {
             position: absolute;
             top: 8px;
             right: 8px;
             font-size: 12px;
             padding: 2px 6px;
             border-radius: 10px;
             display: none;
         }

         .formula-status.valid {
             display: block;
             background-color: #f0f9ff;
             color: #0369a1;
             border: 1px solid #0ea5e9;
         }

         .formula-status.invalid {
             display: block;
             background-color: #fef2f2;
             color: #dc2626;
             border: 1px solid #f87171;
         }

         .formula-actions {
             display: flex;
             gap: 8px;
             justify-content: flex-end;
         }

         .formula-hint {
             font-size: 12px;
             color: #909399;
             margin-top: 5px;
         }

         /* 变量选择器模态框样式 */
         .modal-backdrop {
             position: fixed;
             top: 0;
             left: 0;
             width: 100%;
             height: 100%;
             background-color: rgba(0, 0, 0, 0.5);
             z-index: 2000;
             display: none;
             justify-content: center;
             align-items: center;
         }

         .modal-backdrop.active {
             display: flex;
         }

         .modal {
             background-color: #fff;
             border-radius: 8px;
             width: 800px;
             max-width: 90vw;
             max-height: 80vh;
             display: flex;
             flex-direction: column;
             box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
         }

         .modal-header {
             padding: 16px 20px;
             border-bottom: 1px solid #ebeef5;
             display: flex;
             justify-content: space-between;
             align-items: center;
         }

         .modal-title {
             font-size: 16px;
             font-weight: 600;
             color: #303133;
             margin: 0;
         }

         .modal-close {
             background: none;
             border: none;
             font-size: 20px;
             cursor: pointer;
             color: #909399;
             width: 32px;
             height: 32px;
             display: flex;
             align-items: center;
             justify-content: center;
             border-radius: 4px;
         }

         .modal-close:hover {
             color: #f56c6c;
             background-color: #fef0f0;
         }

         .modal-body {
             flex: 1;
             padding: 20px;
             overflow-y: auto;
         }

         .modal-footer {
             padding: 16px 20px;
             border-top: 1px solid #ebeef5;
             display: flex;
             justify-content: flex-end;
             gap: 12px;
         }

         /* 规则定义相关样式 */
         .rule-link {
             color: #409eff;
             text-decoration: none;
             font-weight: 500;
             transition: color 0.2s;
             cursor: pointer;
         }

         .rule-link:hover {
             color: #66b1ff;
             text-decoration: underline;
         }

         .rule-checkbox {
             cursor: pointer;
         }

         .rule-checkbox:checked {
             background-color: #409eff;
             border-color: #409eff;
         }

         /* 规则表格行选中状态 */
         .rule-row-selected {
             background-color: #f0f9ff !important;
             border-left: 3px solid #f56c6c;
         }

         /* 规则名称列样式 */
         .rule-name-cell {
             font-size: 14px;
             color: #303133;
             font-weight: 500;
             line-height: 1.4;
         }

         /* 附加操作列样式 */
         .additional-actions-cell {
             font-size: 12px;
             color: #606266;
             line-height: 1.5;
         }

         .additional-actions-cell div {
             margin-bottom: 2px;
         }

         .additional-actions-cell div:last-child {
             margin-bottom: 0;
         }

         /* 规则编辑抽屉样式 */
         .rule-steps-container {
             display: flex;
             flex-direction: row;
             gap: 20px;
             padding: 20px;
             background-color: #f8f9fa;
             border-bottom: 1px solid #ebeef5;
             justify-content: center;
             align-items: center;
             position: sticky;
             top: 0;
             z-index: 10;
         }

         .rule-step {
             cursor: pointer;
             transition: all 0.2s;
         }

         .rule-step:hover {
             transform: translateY(-2px);
         }

         .rule-step {
             display: flex;
             align-items: center;
             gap: 10px;
             padding: 10px;
             border-radius: 6px;
             cursor: pointer;
             transition: all 0.3s ease;
         }

         .rule-step.active {
             background-color: #ecf5ff;
             color: #409eff;
         }

         .rule-step.completed {
             background-color: #f0f9ff;
             color: #67c23a;
         }

         .step-circle {
             width: 24px;
             height: 24px;
             border-radius: 50%;
             display: flex;
             align-items: center;
             justify-content: center;
             font-size: 12px;
             font-weight: 600;
             background-color: #f5f7fa;
             border: 1px solid #dcdfe6;
             color: #909399;
         }

         .rule-step.active .step-circle {
             background-color: #409eff;
             border-color: #409eff;
             color: #ffffff;
         }

         .rule-step.completed .step-circle {
             background-color: #67c23a;
             border-color: #67c23a;
             color: #ffffff;
         }

         .step-text {
             font-size: 14px;
             font-weight: 500;
         }

         .rule-content-container {
             padding: 20px;
             height: 100%;
             overflow-y: auto;
         }

         .rule-step-content {
             display: none;
         }

         .rule-step-content.active {
             display: block;
         }

         .step-description {
             color: #606266;
             margin-bottom: 20px;
             font-size: 14px;
         }

         /* 变量选择区域样式 */
         .variable-selection-area {
             margin-bottom: 30px;
         }

         .variable-search-box {
             display: flex;
             gap: 10px;
             margin-bottom: 15px;
         }

         .variable-search-box input {
             flex: 1;
             padding: 8px 12px;
             border: 1px solid #dcdfe6;
             border-radius: 4px;
             font-size: 14px;
         }

         .variable-list {
             display: flex;
             flex-direction: column;
             gap: 10px;
             max-height: 300px;
             overflow-y: auto;
         }

         .variable-item {
             display: flex;
             justify-content: space-between;
             align-items: center;
             padding: 15px;
             border: 1px solid #ebeef5;
             border-radius: 6px;
             background-color: #ffffff;
             transition: all 0.3s ease;
         }

         .variable-item:hover {
             border-color: #409eff;
             box-shadow: 0 2px 8px rgba(64, 158, 255, 0.1);
         }

         .variable-info {
             flex: 1;
         }

         .variable-name {
             font-weight: 600;
             color: #303133;
             margin-bottom: 4px;
         }

         .variable-path {
             font-family: 'Courier New', monospace;
             font-size: 12px;
             color: #606266;
             margin-bottom: 2px;
         }

         .variable-type {
             font-size: 12px;
             color: #909399;
         }

         .selected-variables {
             border-top: 1px solid #ebeef5;
             padding-top: 20px;
         }

         .selected-variables h5 {
             margin-bottom: 15px;
             color: #303133;
         }

         /* 条件配置样式 */
         .conditions-container {
             display: flex;
             flex-direction: column;
             gap: 15px;
         }

         .condition-block {
             border: 1px solid #ebeef5;
             border-radius: 8px;
             padding: 15px;
             background-color: #ffffff;
         }

         .condition-block {
             background-color: #fff;
             border: 1px solid #e4e7ed;
             border-radius: 8px;
             margin-bottom: 15px;
             box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
         }

         .condition-content {
             display: flex;
             align-items: center;
             gap: 20px;
             padding: 20px;
         }

         .condition-variable-section {
             display: flex;
             align-items: center;
             gap: 12px;
             min-width: 350px;
         }

         .condition-label {
             font-weight: 600;
             color: #303133;
             font-size: 14px;
         }

         .variable-display {
             flex: 1;
         }

         .variable-name {
             font-size: 13px;
             color: #303133;
             font-weight: 500;
             margin-bottom: 4px;
             word-break: break-all;
         }

         .variable-type {
             font-size: 11px;
             color: #909399;
             font-family: 'Courier New', monospace;
         }

         .condition-operator-section {
             display: flex;
             align-items: center;
             gap: 12px;
             min-width: 200px;
         }

         .operator-label {
             font-size: 14px;
             color: #606266;
             font-weight: 500;
         }

         .operator-field {
             flex: 1;
         }

         .condition-operator-select {
             width: 100%;
             padding: 8px 12px;
             border: 1px solid #dcdfe6;
             border-radius: 4px;
             font-size: 13px;
             background-color: #fff;
             transition: border-color 0.2s;
         }

         .condition-operator-select:focus {
             outline: none;
             border-color: #409eff;
         }

         .condition-threshold-section {
             min-width: 150px;
         }

         .threshold-field {
             display: flex;
             flex-direction: column;
         }

         .condition-threshold-input {
             width: 100%;
             padding: 8px 12px;
             border: 1px solid #dcdfe6;
             border-radius: 4px;
             font-size: 13px;
             background-color: #fff;
             transition: border-color 0.2s;
         }

         .condition-threshold-input:focus {
             outline: none;
             border-color: #409eff;
         }

         .field-hint {
             font-size: 11px;
             color: #c0c4cc;
             margin-top: 4px;
             font-style: italic;
         }

         .condition-connector {
             display: flex;
             align-items: center;
             justify-content: center;
             padding: 10px 0;
             margin: 10px 0;
         }

         .connector-text {
             font-weight: 600;
             color: #606266;
             font-size: 14px;
             background-color: #f8f9fa;
             padding: 6px 16px;
             border-radius: 20px;
             border: 1px solid #e4e7ed;
         }

         .condition-actions {
             display: flex;
             align-items: center;
             gap: 12px;
             justify-content: center;
             padding: 15px;
             background-color: #f8f9fa;
             border-radius: 6px;
             margin-top: 10px;
         }

         .condition-actions .btn {
             padding: 6px 12px;
             font-size: 13px;
         }

         .condition-actions-inline {
             display: flex;
             align-items: center;
             gap: 8px;
         }

         .condition-actions-inline .btn {
             padding: 4px 8px;
             font-size: 12px;
         }

         .btn-outline {
             background-color: transparent;
             border: 1px solid #dcdfe6;
             color: #606266;
         }

         .btn-outline:hover {
             background-color: #f5f7fa;
             border-color: #c0c4cc;
         }

         /* 配置动作样式 */
         .actions-container {
             margin-top: 20px;
         }

         .action-section {
             background-color: #fff;
             border: 1px solid #e4e7ed;
             border-radius: 8px;
             margin-bottom: 15px;
             overflow: hidden;
         }

         .action-header {
             display: flex;
             align-items: center;
             gap: 12px;
             padding: 15px 20px;
             background-color: #f8f9fa;
             border-bottom: 1px solid #e4e7ed;
         }

         .toggle-label {
             position: relative;
             display: inline-block;
             width: 40px;
             height: 20px;
             cursor: pointer;
         }

         .toggle-label input {
             opacity: 0;
             width: 0;
             height: 0;
         }

         .toggle-slider {
             position: absolute;
             cursor: pointer;
             top: 0;
             left: 0;
             right: 0;
             bottom: 0;
             background-color: #ccc;
             transition: .4s;
             border-radius: 20px;
         }

         .toggle-slider:before {
             position: absolute;
             content: "";
             height: 16px;
             width: 16px;
             left: 2px;
             bottom: 2px;
             background-color: white;
             transition: .4s;
             border-radius: 50%;
         }

         input:checked + .toggle-slider {
             background-color: #409eff;
         }

         input:checked + .toggle-slider:before {
             transform: translateX(20px);
         }

         .action-title {
             font-weight: 600;
             color: #303133;
             font-size: 14px;
         }

         .status-badge {
             padding: 2px 8px;
             border-radius: 12px;
             font-size: 11px;
             font-weight: 500;
         }

         .status-info {
             background-color: #e1f3ff;
             color: #409eff;
             border: 1px solid #b3d8ff;
         }

         .status-warning {
             background-color: #fff7e6;
             color: #e6a23c;
             border: 1px solid #f0c78a;
         }

         .status-error {
             background-color: #fef0f0;
             color: #f56c6c;
             border: 1px solid #fbc4c4;
         }

         .status-critical {
             background-color: #fef0f0;
             color: #f56c6c;
             border: 1px solid #fbc4c4;
         }

         .action-content {
             padding: 20px;
         }

         .action-description {
             color: #606266;
             font-size: 13px;
             margin-bottom: 15px;
         }

         .action-fields {
             display: flex;
             flex-direction: column;
             gap: 15px;
         }

         .form-group {
             display: flex;
             flex-direction: column;
             gap: 8px;
         }

         .form-group label {
             font-size: 13px;
             color: #606266;
             font-weight: 500;
         }

         .limit-config {
             display: flex;
             align-items: center;
             gap: 8px;
             margin-top: 8px;
             padding: 10px;
             background-color: #f8f9fa;
             border-radius: 4px;
         }

         .limit-config span {
             font-size: 12px;
             color: #606266;
         }

         .limit-config .form-input {
             width: 60px;
         }

         .limit-config .form-select {
             width: 80px;
         }

         /* 配置规则名称样式 */
         .rule-name-config {
             margin-top: 20px;
         }

         .name-input-group {
             display: flex;
             align-items: flex-start;
             gap: 12px;
         }

         .name-input-group .btn {
             margin-top: 0;
             white-space: nowrap;
         }

         .input-wrapper {
             flex: 1;
             position: relative;
         }

         .input-wrapper .form-input {
             width: 100%;
             padding-right: 120px;
         }

         .input-hint {
             position: absolute;
             right: 12px;
             top: 50%;
             transform: translateY(-50%);
             font-size: 12px;
             color: #c0c4cc;
             pointer-events: none;
         }

         .advanced-options {
             margin-top: 20px;
             padding: 15px;
             background-color: #f8f9fa;
             border-radius: 6px;
         }

         .option-group {
             display: flex;
             align-items: center;
             gap: 10px;
             margin-bottom: 10px;
         }

         .debouncing-config {
             display: flex;
             align-items: center;
             gap: 8px;
             margin-left: 20px;
         }

         .debouncing-config input {
             width: 80px;
         }

         .debouncing-config select {
             width: 100px;
         }

         .info-icon {
             color: #909399;
             cursor: help;
             font-style: italic;
         }

         /* 动作配置样式 */
         .actions-container {
             display: flex;
             flex-direction: column;
             gap: 20px;
         }

         .action-section {
             border: 1px solid #ebeef5;
             border-radius: 8px;
             overflow: hidden;
         }

         .action-header {
             display: flex;
             align-items: center;
             gap: 10px;
             padding: 15px;
             background-color: #f8f9fa;
             border-bottom: 1px solid #ebeef5;
         }

         .action-title {
             font-weight: 600;
             color: #303133;
         }

         .action-content {
             padding: 15px;
         }

         .action-description {
             color: #606266;
             font-size: 14px;
             margin-bottom: 15px;
         }

         .action-fields {
             display: flex;
             flex-direction: column;
             gap: 15px;
         }

         .limit-config {
             display: flex;
             align-items: center;
             gap: 8px;
             margin-top: 10px;
         }

         .limit-config input {
             width: 80px;
         }

         .limit-config select {
             width: 100px;
         }

         .email-input-container,
         .sms-input-container {
             display: flex;
             gap: 8px;
             margin-bottom: 10px;
         }

         .email-input-container input,
         .sms-input-container input {
             flex: 1;
         }

         .email-tag {
             display: inline-flex;
             align-items: center;
             gap: 5px;
             background-color: #ecf5ff;
             color: #409eff;
             padding: 4px 8px;
             border-radius: 12px;
             font-size: 12px;
             margin-right: 8px;
             margin-bottom: 8px;
         }

         .email-remove {
             background: none;
             border: none;
             color: #409eff;
             cursor: pointer;
             font-size: 14px;
             line-height: 1;
         }

         .email-remove:hover {
             color: #f56c6c;
         }

         /* 规则名称配置样式 */
         .rule-name-config {
             display: flex;
             flex-direction: column;
             gap: 15px;
         }

         .name-input-group {
             display: flex;
             gap: 10px;
             align-items: flex-start;
         }

         .name-input-group .btn {
             white-space: nowrap;
         }

         .input-wrapper {
             flex: 1;
             position: relative;
         }

         .input-hint {
             font-size: 12px;
             color: #909399;
             margin-top: 5px;
         }

         /* 开关样式 */
         .toggle-label {
             position: relative;
             display: inline-block;
             width: 40px;
             height: 20px;
             cursor: pointer;
         }

         .toggle-label input {
             opacity: 0;
             width: 0;
             height: 0;
         }

         .toggle-slider {
             position: absolute;
             cursor: pointer;
             top: 0;
             left: 0;
             right: 0;
             bottom: 0;
             background-color: #ccc;
             transition: .4s;
             border-radius: 20px;
         }

         .toggle-slider:before {
             position: absolute;
             content: "";
             height: 16px;
             width: 16px;
             left: 2px;
             bottom: 2px;
             background-color: white;
             transition: .4s;
             border-radius: 50%;
         }

         input:checked + .toggle-slider {
             background-color: #409eff;
         }

         input:disabled + .toggle-slider {
             background-color: #f5f7fa;
             cursor: not-allowed;
         }

         input:checked + .toggle-slider:before {
             transform: translateX(20px);
         }

         /* 按钮样式 */
         .btn-outline {
             background-color: transparent;
             border: 1px solid #409eff;
             color: #409eff;
         }

         .btn-outline:hover {
             background-color: #409eff;
             color: #ffffff;
         }

         /* 变量选择区域样式 */
         .variable-selection-section {
             margin-bottom: 30px;
             padding: 20px;
             background-color: #f8f9fa;
             border-radius: 8px;
         }

         .variable-selection-section h5 {
             margin-bottom: 15px;
             color: #303133;
         }

         .variable-selector {
             border: 1px solid #dcdfe6;
             border-radius: 4px;
             background-color: #ffffff;
         }

         .variable-category-tabs {
             display: flex;
             border-bottom: 1px solid #ebeef5;
             background-color: #fafafa;
         }

         .tab-btn {
             padding: 10px 20px;
             background: none;
             border: none;
             cursor: pointer;
             color: #606266;
             border-bottom: 2px solid transparent;
             transition: all 0.2s;
         }

         .tab-btn.active {
             color: #409eff;
             border-bottom-color: #409eff;
         }

         .tab-btn:hover {
             color: #409eff;
         }

         .variable-search {
             padding: 15px;
             border-bottom: 1px solid #ebeef5;
         }

         .variable-search input {
             width: 100%;
             padding: 8px 12px;
             border: 1px solid #dcdfe6;
             border-radius: 4px;
             font-size: 14px;
         }

         .variable-search input:focus {
             outline: none;
             border-color: #409eff;
         }

         .variable-list-container {
             max-height: 300px;
             overflow-y: auto;
             padding: 15px;
         }

         .variable-tab-content {
             display: none;
         }

         .variable-tab-content.active {
             display: block;
         }

         .variable-item-selectable {
             display: flex;
             align-items: center;
             padding: 10px;
             border: 1px solid #e4e7ed;
             border-radius: 4px;
             margin-bottom: 8px;
             cursor: pointer;
             transition: all 0.2s;
         }

         .variable-item-selectable:hover {
             background-color: #f5f7fa;
             border-color: #409eff;
         }

         .variable-item-selectable.selected {
             background-color: #ecf5ff;
             border-color: #409eff;
         }

         .variable-item-checkbox {
             margin-right: 10px;
         }

         .variable-item-info {
             flex: 1;
         }

         .variable-item-name {
             font-weight: 500;
             color: #303133;
             margin-bottom: 2px;
         }

         .variable-item-desc {
             font-size: 12px;
             color: #909399;
             margin-bottom: 2px;
         }

         .variable-item-category {
             font-size: 11px;
             color: #409eff;
             background-color: #ecf5ff;
             padding: 2px 6px;
             border-radius: 10px;
             display: inline-block;
         }

         /* 条件配置区域样式 */
         .conditions-section {
             padding: 20px;
             background-color: #ffffff;
             border: 1px solid #ebeef5;
             border-radius: 8px;
         }

         .conditions-section h5 {
             margin-bottom: 15px;
             color: #303133;
         }

         .conditions-container {
             margin-bottom: 20px;
         }

         .condition-block {
             border: 1px solid #e4e7ed;
             border-radius: 6px;
             margin-bottom: 15px;
             background-color: #fafafa;
         }

         .condition-header {
             display: flex;
             justify-content: space-between;
             align-items: center;
             padding: 10px 15px;
             background-color: #f5f7fa;
             border-bottom: 1px solid #e4e7ed;
             border-radius: 6px 6px 0 0;
         }

         .condition-actions {
             display: flex;
             align-items: center;
             gap: 10px;
         }

         .condition-logic {
             width: 80px;
             padding: 4px 8px;
             border: 1px solid #dcdfe6;
             border-radius: 4px;
             font-size: 12px;
         }

         .condition-group {
             margin-bottom: 20px;
             padding: 15px;
             border: 1px solid #e4e7ed;
             border-radius: 6px;
             background-color: #fafafa;
         }

         .nested-condition {
             margin-left: 20px;
             padding-left: 20px;
             border-left: 2px solid #409eff;
             background-color: #fafbfc;
             border-radius: 8px;
             padding: 15px;
         }

         .nested-condition .condition-block {
             box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
         }

         .condition-label {
             font-weight: 500;
             color: #303133;
         }

         .condition-content {
             display: flex;
             align-items: flex-start;
             gap: 20px;
             padding: 20px;
         }

         .condition-column {
             flex: 1;
             min-width: 150px;
         }

         .condition-column-label {
             display: block;
             font-size: 13px;
             color: #606266;
             margin-bottom: 8px;
             font-weight: 500;
         }

         .condition-variable-select,
         .condition-operator-select,
         .condition-threshold-input {
             width: 100%;
             padding: 8px 12px;
             border: 1px solid #dcdfe6;
             border-radius: 4px;
             font-size: 14px;
             background-color: #fff;
             transition: border-color 0.2s;
         }

         .condition-variable-select:focus,
         .condition-operator-select:focus,
         .condition-threshold-input:focus {
             outline: none;
             border-color: #409eff;
         }

         .condition-variable-select {
             min-width: 180px;
         }

         .condition-operator-select {
             min-width: 140px;
         }

         .condition-threshold-input {
             min-width: 100px;
         }

         .condition-connector {
             display: flex;
             align-items: center;
             gap: 10px;
             margin: 10px 0;
             padding: 10px;
             background-color: #f8f9fa;
             border-radius: 4px;
             justify-content: center;
         }

         .condition-connector span {
             font-weight: 500;
             color: #606266;
         }

         .advanced-options {
             display: flex;
             gap: 30px;
             padding: 15px;
             background-color: #f8f9fa;
             border-radius: 4px;
         }

         .option-group {
             display: flex;
             align-items: center;
             gap: 10px;
         }

         .checkbox-label {
             display: flex;
             align-items: center;
             gap: 8px;
             cursor: pointer;
         }

         .checkbox-text {
             font-size: 14px;
             color: #303133;
         }

         .debouncing-config {
             display: flex;
             align-items: center;
             gap: 5px;
         }

         .debouncing-config input {
             width: 60px;
             padding: 4px 8px;
             border: 1px solid #dcdfe6;
             border-radius: 4px;
             font-size: 12px;
         }

         .debouncing-config select {
             padding: 4px 8px;
             border: 1px solid #dcdfe6;
             border-radius: 4px;
             font-size: 12px;
         }

         .info-icon {
             color: #909399;
             font-style: normal;
             cursor: help;
             font-size: 14px;
         }

         /* 已选择变量列表样式 */
         .selected-variables-section {
             margin-top: 30px;
             padding: 20px;
             background-color: #f8f9fa;
             border-radius: 8px;
         }

         .selected-variables-section h5 {
             margin-bottom: 15px;
             color: #303133;
         }

         #selected-variables-list {
             display: flex;
             flex-wrap: wrap;
             gap: 10px;
         }



         /* 规则变量选择器样式 */
         .variable-selector-header {
             display: flex;
             justify-content: space-between;
             align-items: center;
             margin-bottom: 20px;
             padding: 15px;
             background-color: #f8f9fa;
             border-radius: 8px;
         }

         .variable-selector-header h5 {
             margin: 0;
             color: #303133;
         }

         .no-variables-hint {
             text-align: center;
             padding: 40px 20px;
             color: #909399;
             background-color: #fafafa;
             border-radius: 8px;
             border: 2px dashed #dcdfe6;
         }

         .no-variables-hint p {
             margin: 0;
             font-size: 14px;
         }

         #rule-selected-variables-list {
             margin-bottom: 10px;
             max-height: 150px;
             overflow-y: auto;
             min-height: 60px;
         }

         #rule-selected-variables-list:empty + .no-variables-hint {
             display: block;
         }

         #rule-selected-variables-list:not(:empty) + .no-variables-hint {
             display: none;
         }

         /* 只读模式样式 */
         .readonly-mode input,
         .readonly-mode select,
         .readonly-mode textarea {
             background-color: #f5f7fa !important;
             color: #606266 !important;
             cursor: not-allowed !important;
             pointer-events: none !important;
         }

         .readonly-mode .btn:not(.btn-primary) {
             display: none !important;
         }

         .readonly-mode .toggle-label {
             pointer-events: none !important;
         }

         .readonly-mode .toggle-slider {
             background-color: #f5f7fa !important;
             cursor: not-allowed !important;
         }

         /* 变量分类标签页 */
         .variable-category-tabs {
             display: flex;
             border-bottom: 1px solid #ebeef5;
             margin-bottom: 15px;
         }

         .tab-btn {
             padding: 10px 20px;
             background: none;
             border: none;
             cursor: pointer;
             color: #606266;
             border-bottom: 2px solid transparent;
             transition: all 0.2s;
         }

         .tab-btn.active {
             color: #409eff;
             border-bottom-color: #409eff;
         }

         .tab-btn:hover {
             color: #409eff;
         }

         /* 变量搜索 */
         .variable-search {
             margin-bottom: 15px;
         }

         .variable-search input {
             width: 100%;
             padding: 8px 12px;
             border: 1px solid #dcdfe6;
             border-radius: 4px;
             font-size: 14px;
         }

         .variable-search input:focus {
             outline: none;
             border-color: #409eff;
         }

         /* 变量列表容器 */
         .variable-list-container {
             max-height: 300px;
             overflow-y: auto;
         }

         .variable-tab-content {
             display: none;
         }

         .variable-tab-content.active {
             display: block;
         }

         .variable-item-selectable {
             display: flex;
             align-items: center;
             padding: 10px;
             border: 1px solid #e4e7ed;
             border-radius: 4px;
             margin-bottom: 8px;
             cursor: pointer;
             transition: all 0.2s;
         }

         .variable-item-selectable:hover {
             background-color: #f5f7fa;
             border-color: #409eff;
         }

         .variable-item-selectable.selected {
             background-color: #ecf5ff;
             border-color: #409eff;
         }

         .variable-item-checkbox {
             margin-right: 10px;
         }

         .variable-item-info {
             flex: 1;
         }

         .variable-item-name {
             font-weight: 500;
             color: #303133;
             margin-bottom: 2px;
         }

         .variable-item-desc {
             font-size: 12px;
             color: #909399;
             margin-bottom: 2px;
         }

         .variable-item-category {
             font-size: 11px;
             color: #409eff;
             background-color: #ecf5ff;
             padding: 2px 6px;
             border-radius: 10px;
             display: inline-block;
         }

         /* 参与变量列表中的分类标签样式 */
         .variable-item .variable-item-category {
             font-size: 10px;
             padding: 1px 4px;
         }
    </style>
</head>
<body>
    <div class="container">
        <!-- 上方基本信息区域 -->
        <div class="asset-info-header">
            <div class="asset-info-top">
                <div class="asset-basic-info">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 8px;">
                        <button class="btn btn-back" onclick="goBackToList()" style="margin-right: 10px;">
                            <span style="margin-right: 5px;">←</span>返回列表
                        </button>
                        <div class="asset-name">水泥磨机</div>
                        <span class="status-badge status-active">已发布</span>
                        <span style="color: #909399; font-size: 14px;">v1.2.0</span>
                    </div>
                    <div class="asset-desc">用于水泥粉磨这一类资产，包括球磨机、立磨等</div>
                    <div class="asset-tags">
                        <span class="tag">设备</span>
                        <span class="tag">粉磨</span>
                        <span class="tag">核心设备</span>
                    </div>
                </div>
                <div class="asset-actions">
                    <button class="btn" onclick="editAssetType()">编辑</button>
                    <button class="btn btn-primary" onclick="alert('此按钮应实现保存当前资产类型信息功能')">保存</button>
                    <button class="btn" onclick="alert('此按钮应实现预览资产类型详情功能')">预览</button>
                    <button class="btn btn-success" onclick="alert('此按钮应实现发布资产类型功能')">发布</button>
                    <button class="btn btn-warning" id="deprecate-btn" onclick="alert('此按钮应实现废弃当前资产类型功能')">废弃</button>
                    <button class="btn btn-danger" id="delete-btn" style="display: none;" onclick="alert('此按钮应实现删除当前资产类型功能')">删除</button>
                </div>
            </div>
        </div>

        <!-- 下方内容区域 -->
        <div class="content-container">
            <!-- 左侧步骤导航 -->
            <div class="sidebar">

                
                <div class="step-nav">
                    <div class="step-item active" data-step="basic-info">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <div class="step-title">类型基本信息</div>
                            <div class="step-desc">定义资产类型的基本信息和继承关系</div>
                        </div>
                    </div>
                    
                    <div class="step-item" data-step="static-properties">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <div class="step-title">静态属性定义</div>
                            <div class="step-desc">定义资产类型的静态属性字段</div>
                        </div>
                    </div>
                    
                    <div class="step-item" data-step="dynamic-variables">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <div class="step-title">动态变量定义</div>
                            <div class="step-desc">定义数据采集变量</div>
                        </div>
                    </div>
                    
                    <div class="step-item" data-step="data-processing">
                        <div class="step-number">4</div>
                        <div class="step-content">
                            <div class="step-title">业务属性定义</div>
                            <div class="step-desc">定义与业务管理相关的属性</div>
                        </div>
                    </div>
                    
                    <div class="step-item" data-step="indicator-cards">
                        <div class="step-number">5</div>
                        <div class="step-content">
                            <div class="step-title">指标定义</div>
                            <div class="step-desc">定义需要监控的指标</div>
                        </div>
                    </div>
                    
                    <div class="step-item" data-step="alarm-rules">
                        <div class="step-number">6</div>
                        <div class="step-content">
                            <div class="step-title">规则定义</div>
                            <div class="step-desc">定义异常告警等事件的触发规则</div>
                        </div>
                    </div>
                    
                    <div class="step-item" data-step="geometry-models">
                        <div class="step-number">7</div>
                        <div class="step-content">
                            <div class="step-title">几何/组态模型</div>
                            <div class="step-desc">管理3D模型和2D组态图</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 主内容区域 -->
            <div class="main-content">
                <!-- 内容区域 -->
                <div class="content-area">
                    <!-- 类型基本信息内容 -->
                    <div id="basic-info" class="page-content active">
                        <div class="basic-info-container">
                            <!-- 继承关系 -->
                            <div class="form-section">
                                <h3 class="section-title">继承关系</h3>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">父类型</label>
                                        <div class="parent-type-container">
                                            <select class="form-select" disabled>
                                                <option value="">无父类型</option>
                                                <option value="equipment" selected>设备</option>
                                                <option value="pipeline">管道</option>
                                                <option value="valve">阀门</option>
                                            </select>
                                            <button class="btn btn-warning btn-sm" onclick="showRemoveInheritanceModal()" id="remove-inheritance-btn">
                                                解除继承关系
                                            </button>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">是否可被继承</label>
                                        <div class="checkbox-group">
                                            <label class="checkbox-label">
                                                <input type="checkbox" checked>
                                                <span class="checkbox-text">允许其他类型继承此类型</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 基本信息表单 -->
                            <div class="form-section">
                                <h3 class="section-title">基本信息</h3>
                                <div class="form-grid">
                                    <!-- 左侧表单区域 -->
                                    <div class="nested-grid">
                                        <div class="form-group">
                                            <label class="form-label required">类型名称</label>
                                            <input type="text" class="form-input required" value="水泥磨机" placeholder="请输入资产类型名称">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label required">类型编码</label>
                                            <input type="text" class="form-input required" value="cement_mill_001" placeholder="请输入类型编码">
                                        </div>
                                        <!-- <div class="form-group">
                                            <label class="form-label required">版本号</label>
                                            <input type="text" class="form-input required" value="v1.2.0" placeholder="请输入版本号">
                                        </div> -->
                                        <div class="form-group description-group">
                                            <label class="form-label">描述</label>
                                            <textarea class="form-textarea" placeholder="请输入类型描述">用于水泥粉磨这一类资产，包括球磨机、立磨等</textarea>
                                        </div>
                                        <div class="form-group tags-group">
                                            <label class="form-label">标签</label>
                                            <div class="custom-select">
                                                <div class="select-trigger" onclick="toggleDropdown()">
                                                    <div class="selected-tags" id="selectedTags">
                                                        <span class="tag-item">
                                                            设备
                                                            <span class="tag-remove" onclick="removeTag('tag-equipment', event)">×</span>
                                                        </span>
                                                        <span class="tag-item">
                                                            粉磨
                                                            <span class="tag-remove" onclick="removeTag('tag-grinding', event)">×</span>
                                                        </span>
                                                        <span class="tag-item">
                                                            核心设备
                                                            <span class="tag-remove" onclick="removeTag('tag-core', event)">×</span>
                                                        </span>
                                                    </div>
                                                    <span class="select-arrow">▼</span>
                                                </div>
                                                <div class="select-dropdown" id="tagDropdown">
                                                    <div class="select-option">
                                                        <input type="checkbox" id="tag-equipment" checked>
                                                        <label for="tag-equipment">设备</label>
                                                    </div>
                                                    <div class="select-option">
                                                        <input type="checkbox" id="tag-grinding" checked>
                                                        <label for="tag-grinding">粉磨</label>
                                                    </div>
                                                    <div class="select-option">
                                                        <input type="checkbox" id="tag-core" checked>
                                                        <label for="tag-core">核心设备</label>
                                                    </div>
                                                    <div class="select-option">
                                                        <input type="checkbox" id="tag-pipeline">
                                                        <label for="tag-pipeline">管道</label>
                                                    </div>
                                                    <div class="select-option">
                                                        <input type="checkbox" id="tag-valve">
                                                        <label for="tag-valve">阀门</label>
                                                    </div>
                                                    <div class="select-option">
                                                        <input type="checkbox" id="tag-motor">
                                                        <label for="tag-motor">电机</label>
                                                    </div>
                                                    <div class="select-option">
                                                        <input type="checkbox" id="tag-pump">
                                                        <label for="tag-pump">泵</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- 右侧图片上传区域 -->
                                    <div class="image-upload-section">
                                        <label class="form-label">资产类型示意图</label>
                                        <div class="image-upload-area">
                                            <div class="upload-placeholder">
                                                <svg width="40" height="40" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg">
                                                    <path fill="#909399" d="M832 256H600c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h184v496c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V264c0-4.4-3.6-8-8-8z m-216 0H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h288v496c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V264c0-4.4-3.6-8-8-8z m-432 0H192c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h184v496c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V264c0-4.4-3.6-8-8-8z m320 640H304V352h288v552z m-432 0H128V352h288v552z"/>
                                                </svg>
                                            </div>
                                            <div class="upload-buttons">
                                                <button class="btn btn-primary" onclick="alert('打开文件选择对话框选择图片')">选择文件</button>
                                                <button class="btn btn-danger" onclick="alert('删除当前选中的图片')">删除</button>
                                                <!-- <button class="btn" onclick="alert('浏览图片库选择图片')">浏览</button> -->
                                            </div>
                                            <div class="upload-tip">最大文件大小：5MB，仅支持图片格式</div>
                                        </div>
                                    </div>
                                </div>
                            </div>



                            <!-- 日志信息 -->
                            <div class="form-section">
                                <h3 class="section-title">操作日志</h3>
                                <div class="log-table">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>操作时间</th>
                                                <th>操作类型</th>
                                                <th>操作人</th>
                                                <th>操作内容</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>2024-01-20 14:25:00</td>
                                                <td><span class="status-badge status-active">修改</span></td>
                                                <td>张三</td>
                                                <td>更新类型描述</td>
                                            </tr>
                                            <tr>
                                                <td>2024-01-18 09:15:00</td>
                                                <td><span class="status-badge status-active">发布</span></td>
                                                <td>李四</td>
                                                <td>发布资产类型</td>
                                            </tr>
                                            <tr>
                                                <td>2024-01-15 10:30:00</td>
                                                <td><span class="status-badge status-active">创建</span></td>
                                                <td>王五</td>
                                                <td>创建资产类型</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                                         <!-- 静态属性定义 -->
                     <div id="static-properties" class="page-content">
                         <div class="basic-info-container">
                             <!-- 静态属性列表 -->
                             <div class="form-section">
                                 <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                     <h3 class="section-title" style="margin-bottom: 0;">静态属性列表</h3>
                                     <div style="display: flex; gap: 10px;">
                                         <button class="btn" onclick="showPropertyGroupSelector()">引用属性组</button>
                                         <button class="btn btn-primary" onclick="openPropertyDrawer('add')">新增属性</button>
                                     </div>
                                 </div>
                                 
                                 <!-- 属性表格 -->
                                 <div class="property-table-container">
                                     <table class="property-table">
                                         <thead>
                                             <tr>
                                                 <th style="width: 50px;">
                                                     <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                                                 </th>
                                                 <th style="width: 80px;">序号</th>
                                                 <th style="width: 150px;">属性名称</th>
                                                 <th style="width: 120px;">属性编码</th>
                                                 <th style="width: 100px;">数据类型</th>
                                                 <th style="width: 120px;">所属属性组</th>
                                                 <th style="width: 80px;">必填</th>
                                                 <th style="width: 100px;">默认值</th>
                                                 <th style="width: 200px;">描述</th>
                                                 <th style="width: 80px;">字段类型</th>
                                                 <th style="width: 120px;">操作</th>
                                             </tr>
                                         </thead>
                                         <tbody>
                                             <tr class="system-field-row">
                                                 <td><input type="checkbox" class="property-checkbox" value="1" disabled></td>
                                                 <td>1</td>
                                                 <td><a href="#" class="property-link" onclick="viewPropertyFromDrawer(1)">设备名称</a></td>
                                                 <td>device_name</td>
                                                 <td>字符串</td>
                                                 <td>基本信息</td>
                                                 <td><span class="status-badge status-active">是</span></td>
                                                 <td>-</td>
                                                 <td>设备的名称标识</td>
                                                 <td><span class="status-badge status-fixed">固定字段</span></td>
                                                 <td>
                                                     <button class="btn btn-sm" onclick="editPropertyFromDrawer(1)">编辑</button>
                                                 </td>
                                             </tr>
                                             <tr class="system-field-row">
                                                 <td><input type="checkbox" class="property-checkbox" value="2" disabled></td>
                                                 <td>2</td>
                                                 <td><a href="#" class="property-link" onclick="viewPropertyFromDrawer(2)">型号</a></td>
                                                 <td>model</td>
                                                 <td>字符串</td>
                                                 <td>基本信息</td>
                                                 <td><span class="status-badge status-active">是</span></td>
                                                 <td>-</td>
                                                 <td>设备的型号标识</td>
                                                 <td><span class="status-badge status-system">继承字段</span></td>
                                                 <td>
                                                     <button class="btn btn-sm" onclick="editPropertyFromDrawer(2)">编辑</button>
                                                 </td>
                                             </tr>
                                             <tr class="system-field-row">
                                                 <td><input type="checkbox" class="property-checkbox" value="3" disabled></td>
                                                 <td>3</td>
                                                 <td><a href="#" class="property-link" onclick="viewPropertyFromDrawer(3)">规格</a></td>
                                                 <td>specification</td>
                                                 <td>字符串</td>
                                                 <td>基本信息</td>
                                                 <td><span class="status-badge status-active">是</span></td>
                                                 <td>-</td>
                                                 <td>设备的规格参数</td>
                                                 <td><span class="status-badge status-system">继承字段</span></td>
                                                 <td>
                                                     <button class="btn btn-sm" onclick="editPropertyFromDrawer(3)">编辑</button>
                                                 </td>
                                             </tr>
                                             <tr class="system-field-row">
                                                 <td><input type="checkbox" class="property-checkbox" value="4" disabled></td>
                                                 <td>4</td>
                                                 <td><a href="#" class="property-link" onclick="viewPropertyFromDrawer(4)">供应商</a></td>
                                                 <td>supplier</td>
                                                 <td>字符串</td>
                                                 <td>基本信息</td>
                                                 <td><span class="status-badge status-active">是</span></td>
                                                 <td>-</td>
                                                 <td>设备供应商信息</td>
                                                 <td><span class="status-badge status-system">继承字段</span></td>
                                                 <td>
                                                     <button class="btn btn-sm" onclick="editPropertyFromDrawer(4)">编辑</button>
                                                 </td>
                                             </tr>
                                             <tr class="system-field-row">
                                                 <td><input type="checkbox" class="property-checkbox" value="5" disabled></td>
                                                 <td>5</td>
                                                 <td><a href="#" class="property-link" onclick="viewPropertyFromDrawer(5)">制造商</a></td>
                                                 <td>manufacturer</td>
                                                 <td>字符串</td>
                                                 <td>基本信息</td>
                                                 <td><span class="status-badge status-active">是</span></td>
                                                 <td>-</td>
                                                 <td>设备制造商信息</td>
                                                 <td><span class="status-badge status-system">继承字段</span></td>
                                                 <td>
                                                     <button class="btn btn-sm" onclick="editPropertyFromDrawer(5)">编辑</button>
                                                 </td>
                                             </tr>
                                             <tr class="system-field-row">
                                                 <td><input type="checkbox" class="property-checkbox" value="6" disabled></td>
                                                 <td>6</td>
                                                 <td><a href="#" class="property-link" onclick="viewPropertyFromDrawer(6)">状态</a></td>
                                                 <td>status</td>
                                                 <td>枚举</td>
                                                 <td>基本信息</td>
                                                 <td><span class="status-badge status-active">是</span></td>
                                                 <td>正常</td>
                                                 <td>设备运行状态</td>
                                                 <td><span class="status-badge status-system">继承字段</span></td>
                                                 <td>
                                                     <button class="btn btn-sm" onclick="editPropertyFromDrawer(6)">编辑</button>
                                                 </td>
                                             </tr>
                                             <tr class="system-field-row">
                                                 <td><input type="checkbox" class="property-checkbox" value="6" disabled></td>
                                                 <td>6</td>
                                                 <td><a href="#" class="property-link" onclick="viewPropertyFromDrawer(6)">备注</a></td>
                                                 <td>remark</td>
                                                 <td>字符串</td>
                                                 <td>基本信息</td>
                                                 <td><span class="status-badge status-active">否</span></td>
                                                 <td>-</td>
                                                 <td>备注信息</td>
                                                 <td><span class="status-badge status-system">继承字段</span></td>
                                                 <td>
                                                     <button class="btn btn-sm" onclick="editPropertyFromDrawer(6)">编辑</button>
                                                 </td>
                                             </tr>
                                             <tr class="system-field-row">
                                                 <td><input type="checkbox" class="property-checkbox" value="9" disabled></td>
                                                 <td>9</td>
                                                 <td><a href="#" class="property-link" onclick="viewPropertyFromDrawer(9)">设备编码</a></td>
                                                 <td>device_code</td>
                                                 <td>字符串</td>
                                                 <td>基本信息</td>
                                                 <td><span class="status-badge status-active">是</span></td>
                                                 <td>-</td>
                                                 <td>设备的唯一编码</td>
                                                 <td><span class="status-badge status-fixed">固定字段</span></td>
                                                 <td>
                                                     <button class="btn btn-sm" onclick="editPropertyFromDrawer(9)">编辑</button>
                                                 </td>
                                             </tr>
                                             <tr class="system-field-row">
                                                 <td><input type="checkbox" class="property-checkbox" value="10" disabled></td>
                                                 <td>10</td>
                                                 <td><a href="#" class="property-link" onclick="viewPropertyFromDrawer(10)">ABC类别</a></td>
                                                 <td>abc_category</td>
                                                 <td>枚举</td>
                                                 <td>基本信息</td>
                                                 <td><span class="status-badge status-active">是</span></td>
                                                 <td>A</td>
                                                 <td>设备重要性分类</td>
                                                 <td><span class="status-badge status-system">继承字段</span></td>
                                                 <td>
                                                     <button class="btn btn-sm" onclick="editPropertyFromDrawer(10)">编辑</button>
                                                 </td>
                                             </tr>
                                             <tr class="system-field-row">
                                                 <td><input type="checkbox" class="property-checkbox" value="11" disabled></td>
                                                 <td>11</td>
                                                 <td><a href="#" class="property-link" onclick="viewPropertyFromDrawer(11)">报修年限</a></td>
                                                 <td>repair_years</td>
                                                 <td>数值</td>
                                                 <td>基本信息</td>
                                                 <td><span class="status-badge status-active">否</span></td>
                                                 <td>5</td>
                                                 <td>设备报修年限</td>
                                                 <td><span class="status-badge status-system">继承字段</span></td>
                                                 <td>
                                                     <button class="btn btn-sm" onclick="editPropertyFromDrawer(11)">编辑</button>
                                                 </td>
                                             </tr>
                                             <tr class="system-field-row">
                                                 <td><input type="checkbox" class="property-checkbox" value="12" disabled></td>
                                                 <td>12</td>
                                                 <td><a href="#" class="property-link" onclick="viewPropertyFromDrawer(12)">使用年限</a></td>
                                                 <td>service_years</td>
                                                 <td>数值</td>
                                                 <td>基本信息</td>
                                                 <td><span class="status-badge status-active">否</span></td>
                                                 <td>15</td>
                                                 <td>设备使用年限</td>
                                                 <td><span class="status-badge status-system">继承字段</span></td>
                                                 <td>
                                                     <button class="btn btn-sm" onclick="editPropertyFromDrawer(12)">编辑</button>
                                                 </td>
                                             </tr>
                                             <tr class="system-field-row">
                                                 <td><input type="checkbox" class="property-checkbox" value="13" disabled></td>
                                                 <td>13</td>
                                                 <td><a href="#" class="property-link" onclick="viewPropertyFromDrawer(13)">保管人</a></td>
                                                 <td>custodian</td>
                                                 <td>字符串</td>
                                                 <td>基本信息</td>
                                                 <td><span class="status-badge status-active">否</span></td>
                                                 <td>-</td>
                                                 <td>设备保管责任人</td>
                                                 <td><span class="status-badge status-system">继承字段</span></td>
                                                 <td>
                                                     <button class="btn btn-sm" onclick="editPropertyFromDrawer(13)">编辑</button>
                                                 </td>
                                             </tr>
                                             <tr>
                                                 <td><input type="checkbox" class="property-checkbox" value="7"></td>
                                                 <td>7</td>
                                                 <td><a href="#" class="property-link" onclick="viewPropertyFromDrawer(7)">额定功率</a></td>
                                                 <td>rated_power</td>
                                                 <td>数值</td>
                                                 <td>技术参数</td>
                                                 <td><span class="status-badge status-draft">否</span></td>
                                                 <td>0</td>
                                                 <td>设备的额定功率值</td>
                                                 <td><span class="status-badge status-custom">类型专属字段</span></td>
                                                 <td>
                                                     <button class="btn btn-sm" onclick="editPropertyFromDrawer(7)">编辑</button>
                                                     <button class="btn btn-sm btn-danger" onclick="deleteProperty(7)">删除</button>
                                                 </td>
                                             </tr>
                                             <tr>
                                                 <td><input type="checkbox" class="property-checkbox" value="8"></td>
                                                 <td>8</td>
                                                 <td><a href="#" class="property-link" onclick="viewPropertyFromDrawer(8)">生产日期</a></td>
                                                 <td>production_date</td>
                                                 <td>日期</td>
                                                 <td>基本信息</td>
                                                 <td><span class="status-badge status-draft">否</span></td>
                                                 <td>-</td>
                                                 <td>设备的生产制造日期</td>
                                                 <td><span class="status-badge status-custom">类型专属字段</span></td>
                                                 <td>
                                                     <button class="btn btn-sm" onclick="editPropertyFromDrawer(8)">编辑</button>
                                                     <button class="btn btn-sm btn-danger" onclick="deleteProperty(8)">删除</button>
                                                 </td>
                                             </tr>
                                         </tbody>
                                     </table>
                                 </div>
                             </div>
                         </div>
                     </div>
                    
                    <div id="dynamic-variables" class="page-content">
                        <div class="basic-info-container">
                            <!-- 动态变量定义 -->
                            <div class="form-section">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <h3 class="section-title" style="margin-bottom: 0;">动态变量列表</h3>
                                    <div style="display: flex; gap: 10px;">
                                        <button class="btn" onclick="showVariableGroupSelector()">引用变量组</button>
                                        <button class="btn btn-primary" onclick="openVariableDrawer('add')">新增变量</button>
                                    </div>
                                </div>
                                
                                <!-- 变量表格 -->
                                <div class="property-table-container">
                                    <table class="property-table">
                                        <thead>
                                            <tr>
                                                <th style="width: 50px;">
                                                    <input type="checkbox" id="selectAllVariables" onchange="toggleSelectAllVariables()">
                                                </th>
                                                <th style="width: 80px;">序号</th>
                                                <th style="width: 150px;">变量名称</th>
                                                <th style="width: 120px;">变量编码</th>
                                                <th style="width: 100px;">数据类型</th>
                                                <th style="width: 100px;">变量分类</th>
                                                <th style="width: 120px;">所属变量组</th>
                                                <th style="width: 80px;">单位</th>
                                                <th style="width: 100px;">精度</th>
                                                <th style="width: 120px;">采集频率</th>
                                                <th style="width: 200px;">描述</th>
                                                <th style="width: 120px;">操作</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td><input type="checkbox" class="variable-checkbox" value="1"></td>
                                                <td>1</td>
                                                <td><a href="#" class="variable-link" onclick="viewVariableFromDrawer(1)">设备温度</a></td>
                                                <td>device_temp</td>
                                                <td>数值</td>
                                                <td>实时数据</td>
                                                <td>温度监控组</td>
                                                <td>℃</td>
                                                <td>0.1</td>
                                                <td>1秒</td>
                                                <td>设备运行时的温度值</td>
                                                <td>
                                                    <button class="btn btn-sm" onclick="editVariableFromDrawer(1)">编辑</button>
                                                    <button class="btn btn-sm btn-danger" onclick="deleteVariable(1)">删除</button>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td><input type="checkbox" class="variable-checkbox" value="2"></td>
                                                <td>2</td>
                                                <td><a href="#" class="variable-link" onclick="viewVariableFromDrawer(2)">运行压力</a></td>
                                                <td>operating_pressure</td>
                                                <td>数值</td>
                                                <td>实时数据</td>
                                                <td>压力监控组</td>
                                                <td>MPa</td>
                                                <td>0.01</td>
                                                <td>5秒</td>
                                                <td>设备运行时的压力值</td>
                                                <td>
                                                    <button class="btn btn-sm" onclick="editVariableFromDrawer(2)">编辑</button>
                                                    <button class="btn btn-sm btn-danger" onclick="deleteVariable(2)">删除</button>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td><input type="checkbox" class="variable-checkbox" value="3"></td>
                                                <td>3</td>
                                                <td><a href="#" class="variable-link" onclick="viewVariableFromDrawer(3)">累计运行时间</a></td>
                                                <td>total_runtime</td>
                                                <td>数值</td>
                                                <td>累计数据</td>
                                                <td>累计数据组</td>
                                                <td>小时</td>
                                                <td>1</td>
                                                <td>1分钟</td>
                                                <td>设备累计运行时间</td>
                                                <td>
                                                    <button class="btn btn-sm" onclick="editVariableFromDrawer(3)">编辑</button>
                                                    <button class="btn btn-sm btn-danger" onclick="deleteVariable(3)">删除</button>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td><input type="checkbox" class="variable-checkbox" value="4"></td>
                                                <td>4</td>
                                                <td><a href="#" class="variable-link" onclick="viewVariableFromDrawer(4)">设备状态</a></td>
                                                <td>device_status</td>
                                                <td>枚举</td>
                                                <td>状态数据</td>
                                                <td>运行状态组</td>
                                                <td>-</td>
                                                <td>-</td>
                                                <td>10秒</td>
                                                <td>设备运行状态：运行/停止/故障</td>
                                                <td>
                                                    <button class="btn btn-sm" onclick="editVariableFromDrawer(4)">编辑</button>
                                                    <button class="btn btn-sm btn-danger" onclick="deleteVariable(4)">删除</button>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="data-processing" class="page-content">
                        <div class="form-section">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 class="section-title" style="margin-bottom: 0;">业务属性列表</h3>
                                <div style="display: flex; gap: 10px;">
                                    <button class="btn" onclick="showBusinessPropertyGroupSelector()">引用属性组</button>
                                    <button class="btn btn-primary" onclick="openBusinessPropertyDrawer('add')">新增业务属性</button>
                                </div>
                            </div>
                            
                            <!-- 业务属性表格 -->
                            <div class="property-table-container">
                                <table class="property-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 50px;">
                                                <input type="checkbox" id="selectAllBusiness" onchange="toggleSelectAllBusiness()">
                                            </th>
                                            <th style="width: 80px;">序号</th>
                                            <th style="width: 150px;">属性名称</th>
                                            <th style="width: 120px;">属性编码</th>
                                            <th style="width: 100px;">数据类型</th>
                                            <th style="width: 120px;">所属属性组</th>
                                            <th style="width: 80px;">必填</th>
                                            <th style="width: 100px;">默认值</th>
                                            <th style="width: 200px;">描述</th>
                                            <th style="width: 120px;">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><input type="checkbox" class="business-property-checkbox" value="1"></td>
                                            <td>1</td>
                                            <td><a href="#" class="business-property-link" onclick="viewBusinessPropertyFromDrawer(1)">设备负责人</a></td>
                                            <td>device_manager</td>
                                            <td>字符串</td>
                                            <td>业务管理组</td>
                                            <td><span class="status-badge status-active">是</span></td>
                                            <td>-</td>
                                            <td>设备的负责人信息</td>
                                            <td>
                                                <button class="btn btn-sm" onclick="editBusinessPropertyFromDrawer(1)">编辑</button>
                                                <button class="btn btn-sm btn-danger" onclick="deleteBusinessProperty(1)">删除</button>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><input type="checkbox" class="business-property-checkbox" value="2"></td>
                                            <td>2</td>
                                            <td><a href="#" class="business-property-link" onclick="viewBusinessPropertyFromDrawer(2)">维护周期</a></td>
                                            <td>maintenance_cycle</td>
                                            <td>数值</td>
                                            <td>业务管理组</td>
                                            <td><span class="status-badge status-draft">否</span></td>
                                            <td>30</td>
                                            <td>设备维护周期（天）</td>
                                            <td>
                                                <button class="btn btn-sm" onclick="editBusinessPropertyFromDrawer(2)">编辑</button>
                                                <button class="btn btn-sm btn-danger" onclick="deleteBusinessProperty(2)">删除</button>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><input type="checkbox" class="business-property-checkbox" value="3"></td>
                                            <td>3</td>
                                            <td><a href="#" class="business-property-link" onclick="viewBusinessPropertyFromDrawer(3)">设备状态</a></td>
                                            <td>device_status</td>
                                            <td>枚举</td>
                                            <td>业务管理组</td>
                                            <td><span class="status-badge status-active">是</span></td>
                                            <td>正常</td>
                                            <td>设备的业务状态</td>
                                            <td>
                                                <button class="btn btn-sm" onclick="editBusinessPropertyFromDrawer(3)">编辑</button>
                                                <button class="btn btn-sm btn-danger" onclick="deleteBusinessProperty(3)">删除</button>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><input type="checkbox" class="business-property-checkbox" value="4"></td>
                                            <td>4</td>
                                            <td><a href="#" class="business-property-link" onclick="viewBusinessPropertyFromDrawer(4)">采购日期</a></td>
                                            <td>purchase_date</td>
                                            <td>日期</td>
                                            <td>业务管理组</td>
                                            <td><span class="status-badge status-draft">否</span></td>
                                            <td>-</td>
                                            <td>设备采购日期</td>
                                            <td>
                                                <button class="btn btn-sm" onclick="editBusinessPropertyFromDrawer(4)">编辑</button>
                                                <button class="btn btn-sm btn-danger" onclick="deleteBusinessProperty(4)">删除</button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div id="indicator-cards" class="page-content">
                        <div class="form-section">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 class="section-title" style="margin-bottom: 0;">指标定义列表</h3>
                                <div style="display: flex; gap: 10px;">
                                    <button class="btn" onclick="showIndicatorTemplateSelector()">引用指标模板</button>
                                    <button class="btn btn-primary" onclick="openIndicatorDrawer('add')">新增指标</button>
                                </div>
                            </div>
                            
                            <!-- 指标定义表格 -->
                            <div class="property-table-container">
                                <table class="property-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 50px;">
                                                <input type="checkbox" id="selectAllIndicators" onchange="toggleSelectAllIndicators()">
                                            </th>
                                            <th style="width: 80px;">序号</th>
                                            <th style="width: 150px;">指标名称</th>
                                            <th style="width: 120px;">指标编码</th>
                                            <th style="width: 100px;">指标分类</th>
                                            <th style="width: 80px;">指标方向</th>
                                            <th style="width: 120px;">计算周期</th>
                                            <th style="width: 100px;">更新频率</th>
                                            <th style="width: 120px;">参与变量数</th>
                                            <th style="width: 200px;">描述</th>
                                            <th style="width: 120px;">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><input type="checkbox" class="indicator-checkbox" value="1"></td>
                                            <td>1</td>
                                            <td><a href="#" class="indicator-link" onclick="viewIndicatorFromDrawer(1)">设备效率</a></td>
                                            <td>device_efficiency</td>
                                            <td>性能指标</td>
                                            <td><span class="direction-badge direction-positive">正向</span></td>
                                            <td>小时</td>
                                            <td>1小时</td>
                                            <td>3</td>
                                            <td>设备运行效率，基于实际产量与理论产量的比值</td>
                                            <td>
                                                <button class="btn btn-sm" onclick="editIndicatorFromDrawer(1)">编辑</button>
                                                <button class="btn btn-sm btn-danger" onclick="deleteIndicator(1)">删除</button>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><input type="checkbox" class="indicator-checkbox" value="2"></td>
                                            <td>2</td>
                                            <td><a href="#" class="indicator-link" onclick="viewIndicatorFromDrawer(2)">单位能耗</a></td>
                                            <td>unit_energy_consumption</td>
                                            <td>环保指标</td>
                                            <td><span class="direction-badge direction-negative">负向</span></td>
                                            <td>天</td>
                                            <td>1天</td>
                                            <td>2</td>
                                            <td>单位产品的能源消耗量</td>
                                            <td>
                                                <button class="btn btn-sm" onclick="editIndicatorFromDrawer(2)">编辑</button>
                                                <button class="btn btn-sm btn-danger" onclick="deleteIndicator(2)">删除</button>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><input type="checkbox" class="indicator-checkbox" value="3"></td>
                                            <td>3</td>
                                            <td><a href="#" class="indicator-link" onclick="viewIndicatorFromDrawer(3)">故障率</a></td>
                                            <td>failure_rate</td>
                                            <td>安全指标</td>
                                            <td><span class="direction-badge direction-negative">负向</span></td>
                                            <td>月</td>
                                            <td>1天</td>
                                            <td>1</td>
                                            <td>设备故障次数与运行时间的比值</td>
                                            <td>
                                                <button class="btn btn-sm" onclick="editIndicatorFromDrawer(3)">编辑</button>
                                                <button class="btn btn-sm btn-danger" onclick="deleteIndicator(3)">删除</button>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><input type="checkbox" class="indicator-checkbox" value="4"></td>
                                            <td>4</td>
                                            <td><a href="#" class="indicator-link" onclick="viewIndicatorFromDrawer(4)">运营成本</a></td>
                                            <td>operating_cost</td>
                                            <td>经济指标</td>
                                            <td><span class="direction-badge direction-negative">负向</span></td>
                                            <td>月</td>
                                            <td>1天</td>
                                            <td>4</td>
                                            <td>设备运营总成本，包括能源、维护、人工等费用</td>
                                            <td>
                                                <button class="btn btn-sm" onclick="editIndicatorFromDrawer(4)">编辑</button>
                                                <button class="btn btn-sm btn-danger" onclick="deleteIndicator(4)">删除</button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div id="alarm-rules" class="page-content">
                        <div class="form-section">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 class="section-title" style="margin-bottom: 0;">规则定义列表</h3>
                                <div style="display: flex; gap: 10px;">
                                    <button class="btn" onclick="showRuleTemplateSelector()">引用规则模板</button>
                                    <button class="btn btn-primary" onclick="openRuleDrawer('add')">新增规则</button>
                                    <button class="btn btn-warning" onclick="testRuleDrawer()">测试抽屉</button>
                                </div>
                            </div>
                            
                            <!-- 规则定义表格 -->
                            <div class="property-table-container">
                                <table class="property-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 50px;">
                                                <input type="checkbox" id="selectAllRules" onchange="toggleSelectAllRules()">
                                            </th>
                                            <th style="width: 80px;">序号</th>
                                            <th style="width: 300px;">规则名称</th>
                                            <th style="width: 200px;">描述</th>
                                            <th style="width: 200px;">触发动作</th>
                                            <th style="width: 80px;">状态</th>
                                            <th style="width: 120px;">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><input type="checkbox" class="rule-checkbox" value="1"></td>
                                            <td>1</td>
                                            <td class="rule-name-cell"><a href="#" class="rule-link" onclick="viewRuleFromDrawer(1)">电机转速温度复合告警</a></td>
                                            <td>电机转速过高且温度过高时的告警规则</td>
                                            <td class="additional-actions-cell">
                                                <div>资产状态: 错误</div>
                                                <div>邮件: operator@factory.com</div>
                                            </td>
                                            <td><span class="status-badge status-active">启用</span></td>
                                            <td>
                                                <button class="btn btn-sm" onclick="editRuleFromDrawer(1)">编辑</button>
                                                <button class="btn btn-sm" onclick="copyRule(1)">复制</button>
                                                <button class="btn btn-sm btn-warning" onclick="toggleRuleStatus(1)">停用</button>
                                                <button class="btn btn-sm btn-danger" onclick="deleteRule(1)">删除</button>
                                            </td>
                                        </tr>
                                        <tr class="rule-row-selected">
                                            <td><input type="checkbox" class="rule-checkbox" value="2" checked></td>
                                            <td>2</td>
                                            <td class="rule-name-cell"><a href="#" class="rule-link" onclick="viewRuleFromDrawer(2)">电机温度过高告警</a></td>
                                            <td>电机温度过高告警规则</td>
                                            <td class="additional-actions-cell">
                                                <div>资产状态: 错误</div>
                                            </td>
                                            <td><span class="status-badge status-active">启用</span></td>
                                            <td>
                                                <button class="btn btn-sm" onclick="editRuleFromDrawer(2)">编辑</button>
                                                <button class="btn btn-sm" onclick="copyRule(2)">复制</button>
                                                <button class="btn btn-sm btn-warning" onclick="toggleRuleStatus(2)">停用</button>
                                                <button class="btn btn-sm btn-danger" onclick="deleteRule(2)">删除</button>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><input type="checkbox" class="rule-checkbox" value="3"></td>
                                            <td>3</td>
                                            <td class="rule-name-cell"><a href="#" class="rule-link" onclick="viewRuleFromDrawer(3)">压力过低告警</a></td>
                                            <td>压力过低告警规则</td>
                                            <td class="additional-actions-cell">
                                                <div>资产状态: 警告</div>
                                                <div>短信: 13800138000</div>
                                            </td>
                                            <td><span class="status-badge status-active">启用</span></td>
                                            <td>
                                                <button class="btn btn-sm" onclick="editRuleFromDrawer(3)">编辑</button>
                                                <button class="btn btn-sm" onclick="copyRule(3)">复制</button>
                                                <button class="btn btn-sm btn-warning" onclick="toggleRuleStatus(3)">停用</button>
                                                <button class="btn btn-sm btn-danger" onclick="deleteRule(3)">删除</button>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><input type="checkbox" class="rule-checkbox" value="4"></td>
                                            <td>4</td>
                                            <td class="rule-name-cell"><a href="#" class="rule-link" onclick="viewRuleFromDrawer(4)">振动异常告警</a></td>
                                            <td>振动异常告警规则</td>
                                            <td class="additional-actions-cell">
                                                <div>资产状态: 错误</div>
                                                <div>邮件: maintenance@factory.com</div>
                                                <div>短信: 13900139000</div>
                                            </td>
                                            <td><span class="status-badge status-draft">停用</span></td>
                                            <td>
                                                <button class="btn btn-sm" onclick="editRuleFromDrawer(4)">编辑</button>
                                                <button class="btn btn-sm" onclick="copyRule(4)">复制</button>
                                                <button class="btn btn-sm btn-success" onclick="toggleRuleStatus(4)">启用</button>
                                                <button class="btn btn-sm btn-danger" onclick="deleteRule(4)">删除</button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div id="geometry-models" class="page-content">
                        <div class="content-placeholder">
                            （待设计）几何/组态模型 - 配置内容将在这里显示
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 变量选择器模态框 -->
    <div class="modal-backdrop" id="variable-selector-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">选择参与变量</h3>
                <button class="modal-close" onclick="closeVariableSelector()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="variable-category-tabs">
                    <button class="tab-btn active" onclick="switchVariableTab('static')">静态属性</button>
                    <button class="tab-btn" onclick="switchVariableTab('dynamic')">动态变量</button>
                    <button class="tab-btn" onclick="switchVariableTab('business')">业务属性</button>
                    <button class="tab-btn" onclick="switchVariableTab('indicator')">指标</button>
                </div>
                <div class="variable-search">
                    <input type="text" id="variable-search-input" placeholder="搜索变量..." oninput="searchVariables()">
                </div>
                <div class="variable-list-container">
                    <div id="static-variables" class="variable-tab-content active">
                        <!-- 静态属性列表 -->
                    </div>
                    <div id="dynamic-variables" class="variable-tab-content">
                        <!-- 动态变量列表 -->
                    </div>
                    <div id="business-variables" class="variable-tab-content">
                        <!-- 业务属性列表 -->
                    </div>
                    <div id="indicator-variables" class="variable-tab-content">
                        <!-- 指标列表 -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeVariableSelector()">取消</button>
                <button class="btn btn-primary" id="variable-selector-confirm-btn" onclick="confirmVariableSelection()">确定</button>
            </div>
        </div>
    </div>

    <script>
        // 步骤导航功能
        document.addEventListener('DOMContentLoaded', function() {
            const stepItems = document.querySelectorAll('.step-item');
            const pageContents = document.querySelectorAll('.page-content');

            stepItems.forEach(item => {
                item.addEventListener('click', function() {
                    // 移除所有活动状态
                    stepItems.forEach(step => step.classList.remove('active'));
                    pageContents.forEach(p => p.classList.remove('active'));
                    
                    // 添加当前活动状态
                    this.classList.add('active');
                    
                    // 显示对应页面内容
                    const stepName = this.getAttribute('data-step');
                    const targetContent = document.getElementById(stepName);
                    if (targetContent) {
                        targetContent.classList.add('active');
                    }
                });
            });

            // 根据当前状态控制操作按钮
            function updateActionButtons() {
                const currentStatus = 'active'; // 当前状态：active(已发布), draft(草稿), deprecated(已废弃)
                const deleteBtn = document.getElementById('delete-btn');
                const deprecateBtn = document.getElementById('deprecate-btn');
                const publishBtn = document.querySelector('.btn-success');

                if (currentStatus === 'active') {
                    // 已发布状态：显示废弃按钮，隐藏删除按钮
                    deleteBtn.style.display = 'none';
                    deprecateBtn.style.display = 'inline-block';
                    publishBtn.style.display = 'none'; // 已发布状态不需要发布按钮
                } else if (currentStatus === 'draft') {
                    // 草稿状态：显示删除按钮，隐藏废弃按钮
                    deleteBtn.style.display = 'inline-block';
                    deprecateBtn.style.display = 'none';
                    publishBtn.style.display = 'inline-block';
                } else if (currentStatus === 'deprecated') {
                    // 已废弃状态：显示删除按钮，隐藏废弃按钮
                    deleteBtn.style.display = 'inline-block';
                    deprecateBtn.style.display = 'none';
                    publishBtn.style.display = 'none';
                }
            }

            // 必填项验证和边框颜色控制
            function validateRequiredFields() {
                const requiredFields = document.querySelectorAll('.form-input.required, .form-textarea.required, .form-select.required');
                
                requiredFields.forEach(field => {
                    const hasValue = field.value.trim() !== '';
                    
                    if (hasValue) {
                        field.classList.remove('error');
                    } else {
                        field.classList.add('error');
                    }
                });
            }

            // 监听必填项输入事件
            function setupRequiredFieldValidation() {
                const requiredFields = document.querySelectorAll('.form-input.required, .form-textarea.required, .form-select.required');
                
                requiredFields.forEach(field => {
                    // 初始验证
                    validateRequiredFields();
                    
                    // 监听输入事件
                    field.addEventListener('input', validateRequiredFields);
                    field.addEventListener('blur', validateRequiredFields);
                    field.addEventListener('change', validateRequiredFields);
                });
            }

            // 初始化按钮状态
            updateActionButtons();
            setupRequiredFieldValidation(); // 初始化必填项验证
        });

        // Custom Select Functionality
        function toggleDropdown() {
            const dropdown = document.getElementById('tagDropdown');
            const trigger = dropdown.previousElementSibling; // The select-trigger div
            const isActive = trigger.classList.contains('active');

            // Close all dropdowns
            document.querySelectorAll('.custom-select .select-dropdown').forEach(dd => {
                dd.classList.remove('active');
            });
            document.querySelectorAll('.custom-select .select-trigger').forEach(t => {
                t.classList.remove('active');
            });

            if (!isActive) {
                dropdown.classList.add('active');
                trigger.classList.add('active');
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const customSelects = document.querySelectorAll('.custom-select');
            customSelects.forEach(select => {
                const trigger = select.querySelector('.select-trigger');
                const dropdown = select.querySelector('.select-dropdown');

                if (dropdown && trigger && !trigger.contains(event.target) && !dropdown.contains(event.target)) {
                    dropdown.classList.remove('active');
                    trigger.classList.remove('active');
                }
            });
        });

        // Update selected text in trigger
        document.addEventListener('DOMContentLoaded', function() {
            const customSelects = document.querySelectorAll('.custom-select');
            customSelects.forEach(select => {
                const trigger = select.querySelector('.select-trigger');
                const checkboxes = select.querySelectorAll('.select-option input[type="checkbox"]');
                const selectedTagsDiv = select.querySelector('.selected-tags');
                
                // Update display tags
                function updateSelectedTags() {
                    if (!selectedTagsDiv) return;
                    
                    selectedTagsDiv.innerHTML = '';
                    const selectedOptions = Array.from(checkboxes).filter(cb => cb.checked);
                    
                    if (selectedOptions.length === 0) {
                        selectedTagsDiv.innerHTML = '<span style="color: #909399; font-style: italic;">请选择标签</span>';
                        return;
                    }
                    
                    selectedOptions.forEach(checkbox => {
                        const label = checkbox.nextElementSibling.textContent.trim();
                        const tagItem = document.createElement('span');
                        tagItem.className = 'tag-item';
                        tagItem.innerHTML = `
                            ${label}
                            <span class="tag-remove" onclick="removeTag('${checkbox.id}', event)">×</span>
                        `;
                        selectedTagsDiv.appendChild(tagItem);
                    });
                }
                
                // Initial update
                updateSelectedTags();
                
                // Add event listeners to checkboxes
                checkboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', updateSelectedTags);
                });
            });
        });

        // Function to remove a tag
        function removeTag(checkboxId, event) {
            event.stopPropagation(); // Prevent triggering dropdown
            const checkbox = document.getElementById(checkboxId);
            if (checkbox) {
                checkbox.checked = false;
                // Trigger change event to update display
                checkbox.dispatchEvent(new Event('change'));
            }
        }

        // 静态属性定义相关功能
        function showPropertyModal() {
            // 重置编辑状态
            currentEditingPropertyId = null;
            
            // 重置模态框标题为新增模式
            document.querySelector('#propertyModal .modal-title').textContent = '新增属性';
            
            // 清空表单数据
            document.getElementById('propertyName').value = '';
            document.getElementById('propertyCode').value = '';
            document.getElementById('dataType').value = '';
            document.getElementById('propertyGroup').value = '';
            document.getElementById('defaultValue').value = '';
            document.getElementById('valueRange').value = '';
            document.getElementById('formatValidation').value = '';
            document.getElementById('displayOrder').value = '';
            document.getElementById('propertyDescription').value = '';
            document.getElementById('isRequired').checked = false;
            
            document.getElementById('propertyModal').classList.add('active');
        }

        function closePropertyModal() {
            document.getElementById('propertyModal').classList.remove('active');
        }

        // 模拟属性组数据 - 仅包含静态属性类别
        const propertyGroupData = [
            {
                id: 1,
                name: '基本信息组',
                description: '包含设备的基本标识信息，如名称、型号、制造商等',
                category: '静态属性类别',
                propertyCount: 5,
                properties: ['设备名称', '设备型号', '制造商', '生产日期', '设备编号']
            },
            {
                id: 2,
                name: '技术参数组',
                description: '包含设备的技术规格参数，如功率、转速、容量等',
                category: '静态属性类别',
                propertyCount: 8,
                properties: ['额定功率', '额定转速', '最大容量', '工作温度', '工作压力', '电压等级', '频率', '重量']
            },
            {
                id: 3,
                name: '维护信息组',
                description: '包含设备的维护相关信息，如维护周期、维护人员等',
                category: '静态属性类别',
                propertyCount: 3,
                properties: ['维护周期', '维护人员', '维护记录']
            },
            {
                id: 4,
                name: '安全参数组',
                description: '包含设备的安全相关参数，如安全等级、防护等级等',
                category: '静态属性类别',
                propertyCount: 4,
                properties: ['安全等级', '防护等级', '防爆等级', '安全认证']
            },
            {
                id: 5,
                name: '环境参数组',
                description: '包含设备的环境适应参数，如工作环境、安装要求等',
                category: '静态属性类别',
                propertyCount: 6,
                properties: ['工作温度范围', '工作湿度范围', '海拔要求', '安装方式', '环境要求', '防护要求']
            }
        ];

        // 模拟业务属性组数据 - 仅包含业务属性类别
        const businessPropertyGroupData = [
            {
                id: 1,
                name: '生产管理组',
                description: '包含生产相关的业务属性，如生产计划、生产状态等',
                category: '业务属性类别',
                propertyCount: 4,
                properties: ['生产计划', '生产状态', '生产批次', '生产负责人']
            },
            {
                id: 2,
                name: '质量管理组',
                description: '包含质量相关的业务属性，如质量标准、质量等级等',
                category: '业务属性类别',
                propertyCount: 5,
                properties: ['质量标准', '质量等级', '质量检验员', '质量报告', '质量认证']
            },
            {
                id: 3,
                name: '运维管理组',
                description: '包含运维相关的业务属性，如维护计划、运维人员等',
                category: '业务属性类别',
                propertyCount: 6,
                properties: ['维护计划', '运维人员', '维护记录', '故障记录', '维修费用', '运维状态']
            },
            {
                id: 4,
                name: '物流管理组',
                description: '包含物流相关的业务属性，如运输方式、物流状态等',
                category: '业务属性类别',
                propertyCount: 4,
                properties: ['运输方式', '物流状态', '物流公司', '物流费用']
            },
            {
                id: 5,
                name: '成本管理组',
                description: '包含成本相关的业务属性，如采购成本、运营成本等',
                category: '业务属性类别',
                propertyCount: 5,
                properties: ['采购成本', '运营成本', '维护成本', '能源成本', '人工成本']
            }
        ];

        // 全局变量
        let currentEditingPropertyId = null;
        let selectedPropertyGroups = new Set();
        let selectedBusinessPropertyGroups = new Set();

        function showPropertyGroupSelector() {
            // 清空搜索框
            document.getElementById('propertyGroupSearch').value = '';
            // 重置选择状态
            selectedPropertyGroups.clear();
            // 加载属性组列表
            loadPropertyGroups();
            document.getElementById('propertyGroupSelectorModal').classList.add('active');
        }

        function closePropertyGroupSelectorModal() {
            document.getElementById('propertyGroupSelectorModal').classList.remove('active');
            // 清空搜索框和选择状态
            document.getElementById('propertyGroupSearch').value = '';
            selectedPropertyGroups.clear();
        }

        function loadPropertyGroups(searchTerm = '') {
            const container = document.getElementById('propertyGroupList');
            const filteredGroups = propertyGroupData.filter(group => 
                group.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                group.description.toLowerCase().includes(searchTerm.toLowerCase())
            );

            if (filteredGroups.length === 0) {
                container.innerHTML = '<div class="no-results">未找到匹配的属性组</div>';
                return;
            }

            container.innerHTML = filteredGroups.map(group => `
                <div class="group-selector-item" onclick="togglePropertyGroupSelection(${group.id})">
                    <div class="group-item-header">
                        <label class="checkbox-label">
                            <input type="checkbox" id="group_${group.id}" ${selectedPropertyGroups.has(group.id) ? 'checked' : ''} onclick="event.stopPropagation()">
                            <span class="checkbox-text"></span>
                        </label>
                        <div class="group-item-name">${group.name}</div>
                        <div class="group-item-count">${group.propertyCount}个属性</div>
                        <div class="group-item-category">${group.category}</div>
                    </div>
                    <div class="group-item-description">${group.description}</div>
                </div>
            `).join('');

            // 更新复选框状态
            filteredGroups.forEach(group => {
                const checkbox = document.getElementById(`group_${group.id}`);
                if (checkbox) {
                    checkbox.checked = selectedPropertyGroups.has(group.id);
                }
            });
        }

        function togglePropertyGroupSelection(groupId) {
            if (selectedPropertyGroups.has(groupId)) {
                selectedPropertyGroups.delete(groupId);
            } else {
                selectedPropertyGroups.add(groupId);
            }
            
            // 更新复选框状态
            const checkbox = document.getElementById(`group_${groupId}`);
            if (checkbox) {
                checkbox.checked = selectedPropertyGroups.has(groupId);
            }
        }

        function searchPropertyGroups() {
            const searchTerm = document.getElementById('propertyGroupSearch').value;
            loadPropertyGroups(searchTerm);
        }

        function saveProperty() {
            const name = document.getElementById('propertyName').value;
            const code = document.getElementById('propertyCode').value;
            const dataType = document.getElementById('dataType').value;
            const isRequired = document.getElementById('isRequired').checked;
            
            if (!name.trim() || !code.trim() || !dataType) {
                alert('请填写必填字段');
                return;
            }
            
            // 判断是新增还是编辑模式
            if (currentEditingPropertyId) {
                // 编辑模式
                alert(`更新属性：${name} (ID: ${currentEditingPropertyId})`);
            } else {
                // 新增模式
                alert(`新增属性：${name}`);
            }
            
            // 重置编辑状态
            currentEditingPropertyId = null;
            closePropertyModal();
        }

        function applyPropertyGroups() {
            if (selectedPropertyGroups.size === 0) {
                alert('请选择要引用的属性组');
                return;
            }
            
            const selectedGroupNames = Array.from(selectedPropertyGroups).map(id => {
                const group = propertyGroupData.find(g => g.id === id);
                return group ? group.name : '';
            }).filter(name => name);
            
            // 这里应该调用API引用属性组
            alert(`引用属性组：${selectedGroupNames.join(', ')}`);
            closePropertyGroupSelectorModal();
        }

        // 业务属性组相关函数
        function showBusinessPropertyGroupSelector() {
            // 清空搜索框
            document.getElementById('businessPropertyGroupSearch').value = '';
            // 重置选择状态
            selectedBusinessPropertyGroups.clear();
            // 加载业务属性组列表
            loadBusinessPropertyGroups();
            document.getElementById('businessPropertyGroupSelectorModal').classList.add('active');
        }

        function closeBusinessPropertyGroupSelectorModal() {
            document.getElementById('businessPropertyGroupSelectorModal').classList.remove('active');
            // 清空搜索框和选择状态
            document.getElementById('businessPropertyGroupSearch').value = '';
            selectedBusinessPropertyGroups.clear();
        }

        function loadBusinessPropertyGroups(searchTerm = '') {
            const container = document.getElementById('businessPropertyGroupList');
            const filteredGroups = businessPropertyGroupData.filter(group => 
                group.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                group.description.toLowerCase().includes(searchTerm.toLowerCase())
            );

            if (filteredGroups.length === 0) {
                container.innerHTML = '<div class="no-results">未找到匹配的业务属性组</div>';
                return;
            }

            container.innerHTML = filteredGroups.map(group => `
                <div class="group-selector-item" onclick="toggleBusinessPropertyGroupSelection(${group.id})">
                    <div class="group-item-header">
                        <label class="checkbox-label">
                            <input type="checkbox" id="business_group_${group.id}" ${selectedBusinessPropertyGroups.has(group.id) ? 'checked' : ''} onclick="event.stopPropagation()">
                            <span class="checkbox-text"></span>
                        </label>
                        <div class="group-item-name">${group.name}</div>
                        <div class="group-item-count">${group.propertyCount}个属性</div>
                        <div class="group-item-category">${group.category}</div>
                    </div>
                    <div class="group-item-description">${group.description}</div>
                </div>
            `).join('');

            // 更新复选框状态
            filteredGroups.forEach(group => {
                const checkbox = document.getElementById(`business_group_${group.id}`);
                if (checkbox) {
                    checkbox.checked = selectedBusinessPropertyGroups.has(group.id);
                }
            });
        }

        function toggleBusinessPropertyGroupSelection(groupId) {
            if (selectedBusinessPropertyGroups.has(groupId)) {
                selectedBusinessPropertyGroups.delete(groupId);
            } else {
                selectedBusinessPropertyGroups.add(groupId);
            }
            
            // 更新复选框状态
            const checkbox = document.getElementById(`business_group_${groupId}`);
            if (checkbox) {
                checkbox.checked = selectedBusinessPropertyGroups.has(groupId);
            }
        }

        function searchBusinessPropertyGroups() {
            const searchTerm = document.getElementById('businessPropertyGroupSearch').value;
            loadBusinessPropertyGroups(searchTerm);
        }

        function applyBusinessPropertyGroups() {
            if (selectedBusinessPropertyGroups.size === 0) {
                alert('请选择要引用的业务属性组');
                return;
            }
            
            const selectedGroupNames = Array.from(selectedBusinessPropertyGroups).map(id => {
                const group = businessPropertyGroupData.find(g => g.id === id);
                return group ? group.name : '';
            }).filter(name => name);
            
            // 这里应该调用API引用业务属性组
            alert(`引用业务属性组：${selectedGroupNames.join(', ')}`);
            closeBusinessPropertyGroupSelectorModal();
        }



        function editPropertyFromDrawer(propertyId) {
            // 系统字段可以编辑，但只允许编辑特定字段
            const systemFields = [1, 2, 3, 4, 5, 6, 9, 10, 11, 12, 13]; // 设备名称、型号、规格、供应商、制造商、状态、设备编码、ABC类别、报修年限、使用年限、保管人
            const isSystemField = systemFields.includes(propertyId);
            
            // 模拟属性数据 - 包含所有属性（包括系统字段）
            const propertyData = {
                1: {
                    id: 1,
                    propertyGroup: 'basic',
                    name: '设备名称',
                    code: 'device_name',
                    dataType: 'string',
                    precision: '',
                    unit: '',
                    valueRange: '',
                    defaultValue: '',
                    formatValidation: '',
                    category: 'status',
                    businessCategory: 'production',
                    displayOrder: 1,
                    description: '设备的名称标识',
                    isRequired: true
                },
                2: {
                    id: 2,
                    propertyGroup: 'basic',
                    name: '型号',
                    code: 'model',
                    dataType: 'string',
                    precision: '',
                    unit: '',
                    valueRange: '',
                    defaultValue: '',
                    formatValidation: '',
                    category: 'status',
                    businessCategory: 'production',
                    displayOrder: 2,
                    description: '设备的型号标识',
                    isRequired: true
                },
                3: {
                    id: 3,
                    propertyGroup: 'basic',
                    name: '规格',
                    code: 'specification',
                    dataType: 'string',
                    precision: '',
                    unit: '',
                    valueRange: '',
                    defaultValue: '',
                    formatValidation: '',
                    category: 'status',
                    businessCategory: 'production',
                    displayOrder: 3,
                    description: '设备的规格参数',
                    isRequired: true
                },
                4: {
                    id: 4,
                    propertyGroup: 'basic',
                    name: '供应商',
                    code: 'supplier',
                    dataType: 'string',
                    precision: '',
                    unit: '',
                    valueRange: '',
                    defaultValue: '',
                    formatValidation: '',
                    category: 'system',
                    displayOrder: 4,
                    description: '设备供应商信息',
                    isRequired: true
                },
                5: {
                    id: 5,
                    propertyGroup: 'basic',
                    name: '制造商',
                    code: 'manufacturer',
                    dataType: 'string',
                    precision: '',
                    unit: '',
                    valueRange: '',
                    defaultValue: '',
                    formatValidation: '',
                    category: 'system',
                    displayOrder: 5,
                    description: '设备制造商信息',
                    isRequired: true
                },
                6: {
                    id: 6,
                    propertyGroup: 'basic',
                    name: '状态',
                    code: 'status',
                    dataType: 'enum',
                    precision: '',
                    unit: '',
                    valueRange: '正常,维护中,故障,停用',
                    defaultValue: '正常',
                    formatValidation: '',
                    category: 'status',
                    businessCategory: 'maintenance',
                    displayOrder: 6,
                    description: '设备运行状态',
                    isRequired: true
                },
                7: {
                    id: 7,
                    propertyGroup: 'tech',
                    name: '额定功率',
                    code: 'rated_power',
                    dataType: 'number',
                    precision: '0.1',
                    unit: 'kW',
                    valueRange: '0-10000',
                    defaultValue: '0',
                    formatValidation: '',
                    category: 'static',
                    displayOrder: 7,
                    description: '设备的额定功率值',
                    isRequired: false
                },
                8: {
                    id: 8,
                    propertyGroup: 'basic',
                    name: '生产日期',
                    code: 'production_date',
                    dataType: 'date',
                    precision: '',
                    unit: '',
                    valueRange: '',
                    defaultValue: '',
                    formatValidation: '',
                    category: 'static',
                    displayOrder: 8,
                    description: '设备的生产制造日期',
                    isRequired: false
                },
                9: {
                    id: 9,
                    propertyGroup: 'basic',
                    name: '设备编码',
                    code: 'device_code',
                    dataType: 'string',
                    precision: '',
                    unit: '',
                    valueRange: '',
                    defaultValue: '',
                    formatValidation: '',
                    category: 'system',
                    displayOrder: 9,
                    description: '设备的唯一编码',
                    isRequired: true
                },
                10: {
                    id: 10,
                    propertyGroup: 'basic',
                    name: 'ABC类别',
                    code: 'abc_category',
                    dataType: 'enum',
                    precision: '',
                    unit: '',
                    valueRange: 'A,B,C',
                    defaultValue: 'A',
                    formatValidation: '',
                    category: 'system',
                    displayOrder: 10,
                    description: '设备重要性分类',
                    isRequired: true
                },
                11: {
                    id: 11,
                    propertyGroup: 'basic',
                    name: '报修年限',
                    code: 'repair_years',
                    dataType: 'number',
                    precision: '0',
                    unit: '年',
                    valueRange: '0-50',
                    defaultValue: '5',
                    formatValidation: '',
                    category: 'system',
                    displayOrder: 11,
                    description: '设备报修年限',
                    isRequired: false
                },
                12: {
                    id: 12,
                    propertyGroup: 'basic',
                    name: '使用年限',
                    code: 'service_years',
                    dataType: 'number',
                    precision: '0',
                    unit: '年',
                    valueRange: '0-100',
                    defaultValue: '15',
                    formatValidation: '',
                    category: 'system',
                    displayOrder: 12,
                    description: '设备使用年限',
                    isRequired: false
                },
                13: {
                    id: 13,
                    propertyGroup: 'basic',
                    name: '保管人',
                    code: 'custodian',
                    dataType: 'string',
                    precision: '',
                    unit: '',
                    valueRange: '',
                    defaultValue: '',
                    formatValidation: '',
                    category: 'system',
                    displayOrder: 13,
                    description: '设备保管责任人',
                    isRequired: false
                }
            };

            const property = propertyData[propertyId];
            if (!property) {
                alert('未找到属性数据');
                return;
            }

            // 打开抽屉并填充数据
            openPropertyDrawer('edit', property);
        }

        function viewPropertyFromDrawer(propertyId) {
            // 模拟属性数据 - 包含所有属性（包括系统字段）
            const propertyData = {
                1: {
                    id: 1,
                    propertyGroup: 'basic',
                    name: '设备名称',
                    code: 'device_name',
                    dataType: 'string',
                    precision: '',
                    unit: '',
                    valueRange: '',
                    defaultValue: '',
                    formatValidation: '',
                    category: 'status',
                    businessCategory: 'production',
                    displayOrder: 1,
                    description: '设备的名称标识',
                    isRequired: true
                },
                2: {
                    id: 2,
                    propertyGroup: 'basic',
                    name: '型号',
                    code: 'model',
                    dataType: 'string',
                    precision: '',
                    unit: '',
                    valueRange: '',
                    defaultValue: '',
                    formatValidation: '',
                    category: 'status',
                    businessCategory: 'production',
                    displayOrder: 2,
                    description: '设备的型号标识',
                    isRequired: true
                },
                3: {
                    id: 3,
                    propertyGroup: 'basic',
                    name: '规格',
                    code: 'specification',
                    dataType: 'string',
                    precision: '',
                    unit: '',
                    valueRange: '',
                    defaultValue: '',
                    formatValidation: '',
                    category: 'status',
                    businessCategory: 'production',
                    displayOrder: 3,
                    description: '设备的规格参数',
                    isRequired: true
                },
                4: {
                    id: 4,
                    propertyGroup: 'basic',
                    name: '供应商',
                    code: 'supplier',
                    dataType: 'string',
                    precision: '',
                    unit: '',
                    valueRange: '',
                    defaultValue: '',
                    formatValidation: '',
                    category: 'system',
                    displayOrder: 4,
                    description: '设备供应商信息',
                    isRequired: true
                },
                5: {
                    id: 5,
                    propertyGroup: 'basic',
                    name: '制造商',
                    code: 'manufacturer',
                    dataType: 'string',
                    precision: '',
                    unit: '',
                    valueRange: '',
                    defaultValue: '',
                    formatValidation: '',
                    category: 'system',
                    displayOrder: 5,
                    description: '设备制造商信息',
                    isRequired: true
                },
                6: {
                    id: 6,
                    propertyGroup: 'basic',
                    name: '状态',
                    code: 'status',
                    dataType: 'enum',
                    precision: '',
                    unit: '',
                    valueRange: '正常,维护中,故障,停用',
                    defaultValue: '正常',
                    formatValidation: '',
                    category: 'status',
                    businessCategory: 'maintenance',
                    displayOrder: 6,
                    description: '设备运行状态',
                    isRequired: true
                },
                7: {
                    id: 7,
                    propertyGroup: 'tech',
                    name: '额定功率',
                    code: 'rated_power',
                    dataType: 'number',
                    precision: '0.1',
                    unit: 'kW',
                    valueRange: '0-10000',
                    defaultValue: '0',
                    formatValidation: '',
                    category: 'static',
                    displayOrder: 7,
                    description: '设备的额定功率值',
                    isRequired: false
                },
                8: {
                    id: 8,
                    propertyGroup: 'basic',
                    name: '生产日期',
                    code: 'production_date',
                    dataType: 'date',
                    precision: '',
                    unit: '',
                    valueRange: '',
                    defaultValue: '',
                    formatValidation: '',
                    category: 'static',
                    displayOrder: 8,
                    description: '设备的生产制造日期',
                    isRequired: false
                },
                9: {
                    id: 9,
                    propertyGroup: 'basic',
                    name: '设备编码',
                    code: 'device_code',
                    dataType: 'string',
                    precision: '',
                    unit: '',
                    valueRange: '',
                    defaultValue: '',
                    formatValidation: '',
                    category: 'system',
                    displayOrder: 9,
                    description: '设备的唯一编码',
                    isRequired: true
                },
                10: {
                    id: 10,
                    propertyGroup: 'basic',
                    name: 'ABC类别',
                    code: 'abc_category',
                    dataType: 'enum',
                    precision: '',
                    unit: '',
                    valueRange: 'A,B,C',
                    defaultValue: 'A',
                    formatValidation: '',
                    category: 'system',
                    displayOrder: 10,
                    description: '设备重要性分类',
                    isRequired: true
                },
                11: {
                    id: 11,
                    propertyGroup: 'basic',
                    name: '报修年限',
                    code: 'repair_years',
                    dataType: 'number',
                    precision: '0',
                    unit: '年',
                    valueRange: '0-50',
                    defaultValue: '5',
                    formatValidation: '',
                    category: 'system',
                    displayOrder: 11,
                    description: '设备报修年限',
                    isRequired: false
                },
                12: {
                    id: 12,
                    propertyGroup: 'basic',
                    name: '使用年限',
                    code: 'service_years',
                    dataType: 'number',
                    precision: '0',
                    unit: '年',
                    valueRange: '0-100',
                    defaultValue: '15',
                    formatValidation: '',
                    category: 'system',
                    displayOrder: 12,
                    description: '设备使用年限',
                    isRequired: false
                },
                13: {
                    id: 13,
                    propertyGroup: 'basic',
                    name: '保管人',
                    code: 'custodian',
                    dataType: 'string',
                    precision: '',
                    unit: '',
                    valueRange: '',
                    defaultValue: '',
                    formatValidation: '',
                    category: 'system',
                    displayOrder: 13,
                    description: '设备保管责任人',
                    isRequired: false
                }
            };

            const property = propertyData[propertyId];
            if (!property) {
                alert('未找到属性数据');
                return;
            }

            // 打开抽屉并填充数据（只读模式）
            openPropertyDrawer('view', property);
        }

        function deleteProperty(propertyId) {
            // 系统字段不可删除
            const systemFields = [1, 2, 3, 4, 5, 6, 9, 10, 11, 12, 13]; // 设备名称、型号、规格、供应商、制造商、状态、设备编码、ABC类别、报修年限、使用年限、保管人
            if (systemFields.includes(propertyId)) {
                alert('系统字段不可删除！');
                return;
            }
            
            if (confirm('确定要删除这个属性吗？')) {
                alert(`删除属性：${propertyId}`);
            }
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.property-checkbox');
            
            checkboxes.forEach(checkbox => {
                // 系统字段的复选框不可选中
                if (!checkbox.disabled) {
                    checkbox.checked = selectAll.checked;
                }
            });
        }

        // 编辑资产类型基本信息
        function editAssetType() {
            // 模拟资产类型数据 - 在实际应用中，这里应该从API获取数据
            const assetTypeData = {
                name: '水泥磨机',
                code: 'cement_mill_001',
                description: '用于水泥粉磨这一类资产，包括球磨机、立磨等',
                tags: ['设备', '粉磨', '核心设备'],
                parentType: 'equipment',
                canBeInherited: true
            };

            // 填充表单字段
            document.querySelector('#basic-info input[placeholder="请输入资产类型名称"]').value = assetTypeData.name;
            document.querySelector('#basic-info input[placeholder="请输入类型编码"]').value = assetTypeData.code;
            document.querySelector('#basic-info textarea[placeholder="请输入类型描述"]').value = assetTypeData.description;
            
            // 设置父类型
            const parentTypeSelect = document.querySelector('#basic-info select');
            if (parentTypeSelect) {
                parentTypeSelect.value = assetTypeData.parentType;
            }
            
            // 设置是否可被继承
            const inheritCheckbox = document.querySelector('#basic-info input[type="checkbox"]');
            if (inheritCheckbox) {
                inheritCheckbox.checked = assetTypeData.canBeInherited;
            }
            
            // 设置分类标签
            const tagCheckboxes = document.querySelectorAll('#basic-info .select-option input[type="checkbox"]');
            tagCheckboxes.forEach(checkbox => {
                const label = checkbox.nextElementSibling.textContent.trim();
                checkbox.checked = assetTypeData.tags.includes(label);
            });
            
            // 触发标签显示更新
            const tagDropdown = document.querySelector('#basic-info .select-trigger');
            if (tagDropdown) {
                tagDropdown.click(); // 触发下拉框更新
            }
            
            // 滚动到基本信息区域
            document.getElementById('basic-info').scrollIntoView({ behavior: 'smooth' });
            
            alert('已加载资产类型基本信息到表单中');
        }

        // 动态变量相关功能
        let currentEditingVariableId = null;
        let selectedVariableGroups = new Set();

        // 模拟变量组数据 - 仅包含动态变量类别
        const variableGroupData = [
            {
                id: 1,
                name: '温度监控组',
                description: '包含设备温度相关的监控变量，如设备温度、环境温度等',
                category: '动态变量类别',
                variableCount: 3,
                variables: ['设备温度', '环境温度', '冷却水温度']
            },
            {
                id: 2,
                name: '压力监控组',
                description: '包含设备压力相关的监控变量，如运行压力、系统压力等',
                category: '动态变量类别',
                variableCount: 4,
                variables: ['运行压力', '系统压力', '油压', '气压']
            },
            {
                id: 3,
                name: '运行状态组',
                description: '包含设备运行状态相关的变量，如开关状态、运行模式等',
                category: '动态变量类别',
                variableCount: 5,
                variables: ['设备状态', '运行模式', '开关状态', '故障状态', '维护状态']
            },
            {
                id: 4,
                name: '累计数据组',
                description: '包含设备累计运行数据，如运行时间、产量、能耗等',
                category: '动态变量类别',
                variableCount: 6,
                variables: ['累计运行时间', '累计产量', '累计能耗', '累计维护次数', '累计故障次数', '累计停机时间']
            },
            {
                id: 5,
                name: '效率计算组',
                description: '包含设备效率相关的计算变量，如运行效率、产能利用率等',
                category: '动态变量类别',
                variableCount: 4,
                variables: ['运行效率', '产能利用率', '设备可用率', '综合效率']
            }
        ];

        function showVariableModal() {
            // 重置编辑状态
            currentEditingVariableId = null;
            
            // 重置模态框标题为新增模式
            document.querySelector('#variableModal .modal-title').textContent = '新增变量';
            
            // 清空表单数据
            document.getElementById('variableName').value = '';
            document.getElementById('variableCode').value = '';
            document.getElementById('variableDataType').value = '';
            document.getElementById('variableCategory').value = '';
            document.getElementById('variableGroup').value = '';
            document.getElementById('variableUnit').value = '';
            document.getElementById('variablePrecision').value = '';
            document.getElementById('variableRange').value = '';
            document.getElementById('variableFrequency').value = '';
            document.getElementById('variableDescription').value = '';
            
            document.getElementById('variableModal').classList.add('active');
            
            // 如果是新增模式，尝试自动设置所属变量组
            if (!currentEditingVariableId) {
                autoSetVariableGroup();
            }
        }

        function closeVariableModal() {
            document.getElementById('variableModal').classList.remove('active');
        }

        function saveVariable() {
            const name = document.getElementById('variableName').value;
            const code = document.getElementById('variableCode').value;
            const dataType = document.getElementById('variableDataType').value;
            const category = document.getElementById('variableCategory').value;
            const frequency = document.getElementById('variableFrequency').value;
            
            if (!name.trim() || !code.trim() || !dataType || !category || !frequency) {
                alert('请填写必填字段');
                return;
            }
            
            // 判断是新增还是编辑模式
            if (currentEditingVariableId) {
                // 编辑模式
                alert(`更新变量：${name} (ID: ${currentEditingVariableId})`);
            } else {
                // 新增模式
                alert(`新增变量：${name}`);
            }
            
            // 重置编辑状态
            currentEditingVariableId = null;
            closeVariableModal();
        }



        function editVariableFromDrawer(variableId) {
            // 模拟变量数据 - 在实际应用中，这里应该从API获取数据
            const variableData = {
                1: {
                    variableGroup: 'temp_group',
                    name: '设备温度',
                    code: 'device_temp',
                    dataType: 'number',
                    precision: '0.1',
                    unit: '℃',
                    valueRange: '0-200',
                    defaultValue: '',
                    formatValidation: '',
                    category: 'realtime',
                    displayOrder: 1,
                    description: '设备运行时的温度值',
                    collectionFrequency: '1s',
                    isRequired: false
                },
                2: {
                    variableGroup: 'pressure_group',
                    name: '运行压力',
                    code: 'operating_pressure',
                    dataType: 'number',
                    precision: '0.01',
                    unit: 'MPa',
                    valueRange: '0-10',
                    defaultValue: '',
                    formatValidation: '',
                    category: 'realtime',
                    displayOrder: 2,
                    description: '设备运行时的压力值',
                    collectionFrequency: '5s',
                    isRequired: false
                },
                3: {
                    variableGroup: 'cumulative_group',
                    name: '累计运行时间',
                    code: 'total_runtime',
                    dataType: 'number',
                    precision: '1',
                    unit: '小时',
                    valueRange: '0-8760',
                    defaultValue: '0',
                    formatValidation: '',
                    category: 'cumulative',
                    displayOrder: 3,
                    description: '设备累计运行时间',
                    collectionFrequency: '1m',
                    isRequired: false
                },
                4: {
                    variableGroup: 'status_group',
                    name: '设备状态',
                    code: 'device_status',
                    dataType: 'enum',
                    precision: '',
                    unit: '',
                    valueRange: '运行,停止,故障',
                    defaultValue: '停止',
                    formatValidation: '',
                    category: 'status',
                    displayOrder: 4,
                    description: '设备运行状态：运行/停止/故障',
                    collectionFrequency: '10s',
                    isRequired: false
                }
            };

            const variable = variableData[variableId];
            if (!variable) {
                alert('未找到变量数据');
                return;
            }

            // 打开抽屉并填充数据
            openVariableDrawer('edit', variable);
        }

        function viewVariableFromDrawer(variableId) {
            // 模拟变量数据 - 在实际应用中，这里应该从API获取数据
            const variableData = {
                1: {
                    variableGroup: 'temp_group',
                    name: '设备温度',
                    code: 'device_temp',
                    dataType: 'number',
                    precision: '0.1',
                    unit: '℃',
                    valueRange: '0-200',
                    defaultValue: '',
                    formatValidation: '',
                    category: 'realtime',
                    displayOrder: 1,
                    description: '设备运行时的温度值',
                    collectionFrequency: '1s',
                    isRequired: false
                },
                2: {
                    variableGroup: 'pressure_group',
                    name: '运行压力',
                    code: 'operating_pressure',
                    dataType: 'number',
                    precision: '0.01',
                    unit: 'MPa',
                    valueRange: '0-10',
                    defaultValue: '',
                    formatValidation: '',
                    category: 'realtime',
                    displayOrder: 2,
                    description: '设备运行时的压力值',
                    collectionFrequency: '5s',
                    isRequired: false
                },
                3: {
                    variableGroup: 'cumulative_group',
                    name: '累计运行时间',
                    code: 'total_runtime',
                    dataType: 'number',
                    precision: '1',
                    unit: '小时',
                    valueRange: '0-8760',
                    defaultValue: '0',
                    formatValidation: '',
                    category: 'cumulative',
                    displayOrder: 3,
                    description: '设备累计运行时间',
                    collectionFrequency: '1m',
                    isRequired: false
                },
                4: {
                    variableGroup: 'status_group',
                    name: '设备状态',
                    code: 'device_status',
                    dataType: 'enum',
                    precision: '',
                    unit: '',
                    valueRange: '运行,停止,故障',
                    defaultValue: '停止',
                    formatValidation: '',
                    category: 'status',
                    displayOrder: 4,
                    description: '设备运行状态：运行/停止/故障',
                    collectionFrequency: '10s',
                    isRequired: false
                }
            };

            const variable = variableData[variableId];
            if (!variable) {
                alert('未找到变量数据');
                return;
            }

            // 打开抽屉并填充数据（只读模式）
            openVariableDrawer('view', variable);
        }

        function deleteVariable(variableId) {
            if (confirm('确定要删除这个变量吗？')) {
                alert(`删除变量：${variableId}`);
            }
        }

        function toggleSelectAllVariables() {
            const selectAll = document.getElementById('selectAllVariables');
            const checkboxes = document.querySelectorAll('.variable-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
        }

        function showVariableGroupSelector() {
            // 清空搜索框
            document.getElementById('variableGroupSearch').value = '';
            // 重置选择状态
            selectedVariableGroups.clear();
            // 加载变量组列表
            loadVariableGroups();
            document.getElementById('variableGroupSelectorModal').classList.add('active');
        }

        function closeVariableGroupSelectorModal() {
            document.getElementById('variableGroupSelectorModal').classList.remove('active');
            // 清空搜索框和选择状态
            document.getElementById('variableGroupSearch').value = '';
            selectedVariableGroups.clear();
        }

        function loadVariableGroups(searchTerm = '') {
            const container = document.getElementById('variableGroupList');
            const filteredGroups = variableGroupData.filter(group => 
                group.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                group.description.toLowerCase().includes(searchTerm.toLowerCase())
            );

            if (filteredGroups.length === 0) {
                container.innerHTML = '<div class="no-results">未找到匹配的变量组</div>';
                return;
            }

            container.innerHTML = filteredGroups.map(group => `
                <div class="group-selector-item" onclick="toggleVariableGroupSelection(${group.id})">
                    <div class="group-item-header">
                        <label class="checkbox-label">
                            <input type="checkbox" id="vgroup_${group.id}" ${selectedVariableGroups.has(group.id) ? 'checked' : ''} onclick="event.stopPropagation()">
                            <span class="checkbox-text"></span>
                        </label>
                        <div class="group-item-name">${group.name}</div>
                        <div class="group-item-count">${group.variableCount}个变量</div>
                        <div class="group-item-category">${group.category}</div>
                    </div>
                    <div class="group-item-description">${group.description}</div>
                </div>
            `).join('');

            // 更新复选框状态
            filteredGroups.forEach(group => {
                const checkbox = document.getElementById(`vgroup_${group.id}`);
                if (checkbox) {
                    checkbox.checked = selectedVariableGroups.has(group.id);
                }
            });
        }

        function toggleVariableGroupSelection(groupId) {
            if (selectedVariableGroups.has(groupId)) {
                selectedVariableGroups.delete(groupId);
            } else {
                selectedVariableGroups.add(groupId);
            }
            
            // 更新复选框状态
            const checkbox = document.getElementById(`vgroup_${groupId}`);
            if (checkbox) {
                checkbox.checked = selectedVariableGroups.has(groupId);
            }
        }

        function searchVariableGroups() {
            const searchTerm = document.getElementById('variableGroupSearch').value;
            loadVariableGroups(searchTerm);
        }

        function applyVariableGroups() {
            if (selectedVariableGroups.size === 0) {
                alert('请选择要引用的变量组');
                return;
            }
            
            const selectedGroupNames = Array.from(selectedVariableGroups).map(id => {
                const group = variableGroupData.find(g => g.id === id);
                return group ? group.name : '';
            }).filter(name => name);
            
            // 这里应该调用API引用变量组，并自动设置所属变量组
            alert(`引用变量组：${selectedGroupNames.join(', ')}\n\n引用变量组后，新增的变量将自动设置所属变量组字段。`);
            
            // 设置全局变量，用于后续新增变量时自动设置所属变量组
            window.lastReferencedVariableGroups = Array.from(selectedVariableGroups);
            
            closeVariableGroupSelectorModal();
        }

        // 当引用变量组后，新增变量时自动设置所属变量组
        function autoSetVariableGroup() {
            if (window.lastReferencedVariableGroups && window.lastReferencedVariableGroups.length > 0) {
                // 如果有最近引用的变量组，自动设置第一个作为默认值
                const firstGroupId = window.lastReferencedVariableGroups[0];
                const group = variableGroupData.find(g => g.id === firstGroupId);
                if (group) {
                    // 根据组名映射到对应的value
                    const groupValueMap = {
                        '温度监控组': 'temp_group',
                        '压力监控组': 'pressure_group',
                        '运行状态组': 'status_group',
                        '累计数据组': 'cumulative_group',
                        '效率计算组': 'efficiency_group'
                    };
                    const groupValue = groupValueMap[group.name];
                    if (groupValue) {
                        document.getElementById('variableGroup').value = groupValue;
                    }
                }
            }
        }

        // 属性编辑抽屉功能
        function openPropertyDrawer(mode = 'add', data = null) {
            const drawer = document.getElementById('property-drawer');
            const title = document.getElementById('property-drawer-title');
            const saveBtn = document.querySelector('#property-drawer .btn-primary');
            
            if (mode === 'edit' && data) {
                title.textContent = '编辑属性';
                saveBtn.textContent = '保存';
                // 填充表单数据
                document.getElementById('drawer-property-group').value = data.propertyGroup || '';
                document.getElementById('drawer-property-name').value = data.name || '';
                document.getElementById('drawer-property-code').value = data.code || '';
                document.getElementById('drawer-data-type').value = data.dataType || '';
                document.getElementById('drawer-precision').value = data.precision || '';
                document.getElementById('drawer-unit').value = data.unit || '';
                document.getElementById('drawer-value-range').value = data.valueRange || '';
                document.getElementById('drawer-default-value').value = data.defaultValue || '';
                document.getElementById('drawer-format-validation').value = data.formatValidation || '';
                setDataTags('drawer-category', data.category ? data.category.split(',') : []);
                document.getElementById('drawer-business-category').value = data.businessCategory || '';
                document.getElementById('drawer-display-order').value = data.displayOrder || '';
                document.getElementById('drawer-property-description').value = data.description || '';
                document.getElementById('drawer-is-required').checked = data.isRequired || false;
                
                // 检查是否为系统字段，如果是则使用特殊的字段启用逻辑
                const systemFields = [1, 2, 3, 4, 5, 6, 9, 10, 11, 12, 13];
                const isSystemField = systemFields.includes(data.id);
                
                if (isSystemField) {
                    enableSystemFieldFormFields();
                } else {
                    enablePropertyFormFields();
                }
            } else if (mode === 'view' && data) {
                title.textContent = '查看属性';
                saveBtn.textContent = '关闭';
                // 填充表单数据
                document.getElementById('drawer-property-group').value = data.propertyGroup || '';
                document.getElementById('drawer-property-name').value = data.name || '';
                document.getElementById('drawer-property-code').value = data.code || '';
                document.getElementById('drawer-data-type').value = data.dataType || '';
                document.getElementById('drawer-precision').value = data.precision || '';
                document.getElementById('drawer-unit').value = data.unit || '';
                document.getElementById('drawer-value-range').value = data.valueRange || '';
                document.getElementById('drawer-default-value').value = data.defaultValue || '';
                document.getElementById('drawer-format-validation').value = data.formatValidation || '';
                setDataTags('drawer-category', data.category ? data.category.split(',') : []);
                document.getElementById('drawer-business-category').value = data.businessCategory || '';
                document.getElementById('drawer-display-order').value = data.displayOrder || '';
                document.getElementById('drawer-property-description').value = data.description || '';
                document.getElementById('drawer-is-required').checked = data.isRequired || false;
                
                // 禁用表单字段（只读模式）
                disablePropertyFormFields();
            } else {
                title.textContent = '新增属性';
                saveBtn.textContent = '保存';
                // 清空表单
                document.getElementById('drawer-property-group').value = '';
                document.getElementById('drawer-property-name').value = '';
                document.getElementById('drawer-property-code').value = '';
                document.getElementById('drawer-data-type').value = '';
                document.getElementById('drawer-precision').value = '';
                document.getElementById('drawer-unit').value = '';
                document.getElementById('drawer-value-range').value = '';
                document.getElementById('drawer-default-value').value = '';
                document.getElementById('drawer-format-validation').value = '';
                setDataTags('drawer-category', []);
                document.getElementById('drawer-business-category').value = '';
                document.getElementById('drawer-display-order').value = '';
                document.getElementById('drawer-property-description').value = '';
                document.getElementById('drawer-is-required').checked = false;
                
                // 启用表单字段
                enablePropertyFormFields();
            }
            
            drawer.classList.add('active');
        }

        function closePropertyDrawer() {
            document.getElementById('property-drawer').classList.remove('active');
        }

        function savePropertyFromDrawer() {
            const saveBtn = document.querySelector('#property-drawer .btn-primary');
            
            // 如果是查看模式，直接关闭抽屉
            if (saveBtn.textContent === '关闭') {
                closePropertyDrawer();
                return;
            }
            
            const name = document.getElementById('drawer-property-name').value;
            const code = document.getElementById('drawer-property-code').value;
            const dataType = document.getElementById('drawer-data-type').value;
            const isRequired = document.getElementById('drawer-is-required').checked;
            
            if (!name.trim() || !code.trim() || !dataType) {
                alert('请填写必填字段');
                return;
            }
            
            // 收集表单数据
            const propertyData = {
                propertyGroup: document.getElementById('drawer-property-group').value,
                name: name,
                code: code,
                dataType: dataType,
                precision: document.getElementById('drawer-precision').value,
                unit: document.getElementById('drawer-unit').value,
                valueRange: document.getElementById('drawer-value-range').value,
                defaultValue: document.getElementById('drawer-default-value').value,
                formatValidation: document.getElementById('drawer-format-validation').value,
                category: getSelectedDataTags('drawer-category').join(','),
                businessCategory: document.getElementById('drawer-business-category').value,
                displayOrder: document.getElementById('drawer-display-order').value,
                description: document.getElementById('drawer-property-description').value,
                isRequired: isRequired
            };
            
            console.log('保存属性数据:', propertyData);
            alert('属性保存成功');
            closePropertyDrawer();
        }

        function enablePropertyFormFields() {
            const fields = [
                'drawer-property-group',
                'drawer-property-name',
                'drawer-property-code',
                'drawer-data-type',
                'drawer-precision',
                'drawer-unit',
                'drawer-value-range',
                'drawer-default-value',
                'drawer-format-validation',
                'drawer-category',
                'drawer-business-category',
                'drawer-display-order',
                'drawer-property-description',
                'drawer-is-required'
            ];
            
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.disabled = false;
                }
            });
        }

        function enableSystemFieldFormFields() {
            // 系统字段只允许编辑特定字段：取值范围、默认值
            const editableFields = [
                'drawer-value-range',
                'drawer-default-value'
            ];
            
            const readOnlyFields = [
                'drawer-property-group',
                'drawer-property-name',
                'drawer-property-code',
                'drawer-data-type',
                'drawer-precision',
                'drawer-unit',
                'drawer-format-validation',
                'drawer-category',
                'drawer-business-category',
                'drawer-display-order',
                'drawer-property-description',
                'drawer-is-required'
            ];
            
            // 启用可编辑字段
            editableFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.disabled = false;
                }
            });
            
            // 禁用只读字段
            readOnlyFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.disabled = true;
                }
            });
        }

        function disablePropertyFormFields() {
            const fields = [
                'drawer-property-group',
                'drawer-property-name',
                'drawer-property-code',
                'drawer-data-type',
                'drawer-precision',
                'drawer-unit',
                'drawer-value-range',
                'drawer-default-value',
                'drawer-format-validation',
                'drawer-category',
                'drawer-business-category',
                'drawer-display-order',
                'drawer-property-description',
                'drawer-is-required'
            ];
            
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.disabled = true;
                }
            });
        }

        // 动态变量编辑抽屉功能
        function openVariableDrawer(mode = 'add', data = null) {
            const drawer = document.getElementById('variable-drawer');
            const title = document.getElementById('variable-drawer-title');
            const saveBtn = document.querySelector('#variable-drawer .btn-primary');
            
            if (mode === 'edit' && data) {
                title.textContent = '编辑动态变量';
                saveBtn.textContent = '保存';
                // 填充表单数据
                document.getElementById('drawer-variable-group').value = data.variableGroup || '';
                document.getElementById('drawer-variable-name').value = data.name || '';
                document.getElementById('drawer-variable-code').value = data.code || '';
                document.getElementById('drawer-variable-data-type').value = data.dataType || '';
                document.getElementById('drawer-variable-precision').value = data.precision || '';
                document.getElementById('drawer-variable-unit').value = data.unit || '';
                document.getElementById('drawer-variable-range').value = data.valueRange || data.range || '';
                document.getElementById('drawer-variable-default-value').value = data.defaultValue || '';
                document.getElementById('drawer-variable-format-validation').value = data.formatValidation || '';
                document.getElementById('drawer-variable-category').value = data.category || '';
                document.getElementById('drawer-variable-business-category').value = data.businessCategory || '';
                document.getElementById('drawer-variable-display-order').value = data.displayOrder || '';
                document.getElementById('drawer-variable-description').value = data.description || '';
                document.getElementById('drawer-variable-collection-frequency').value = data.collectionFrequency || data.frequency || '';
                document.getElementById('drawer-variable-is-required').checked = data.isRequired || false;
                
                // 启用表单字段
                enableVariableFormFields();
            } else if (mode === 'view' && data) {
                title.textContent = '查看动态变量';
                saveBtn.textContent = '关闭';
                // 填充表单数据
                document.getElementById('drawer-variable-group').value = data.variableGroup || '';
                document.getElementById('drawer-variable-name').value = data.name || '';
                document.getElementById('drawer-variable-code').value = data.code || '';
                document.getElementById('drawer-variable-data-type').value = data.dataType || '';
                document.getElementById('drawer-variable-precision').value = data.precision || '';
                document.getElementById('drawer-variable-unit').value = data.unit || '';
                document.getElementById('drawer-variable-range').value = data.valueRange || data.range || '';
                document.getElementById('drawer-variable-default-value').value = data.defaultValue || '';
                document.getElementById('drawer-variable-format-validation').value = data.formatValidation || '';
                document.getElementById('drawer-variable-category').value = data.category || '';
                document.getElementById('drawer-variable-business-category').value = data.businessCategory || '';
                document.getElementById('drawer-variable-display-order').value = data.displayOrder || '';
                document.getElementById('drawer-variable-description').value = data.description || '';
                document.getElementById('drawer-variable-collection-frequency').value = data.collectionFrequency || data.frequency || '';
                document.getElementById('drawer-variable-is-required').checked = data.isRequired || false;
                
                // 禁用表单字段（只读模式）
                disableVariableFormFields();
            } else {
                title.textContent = '新增动态变量';
                saveBtn.textContent = '保存';
                // 清空表单
                document.getElementById('drawer-variable-group').value = '';
                document.getElementById('drawer-variable-name').value = '';
                document.getElementById('drawer-variable-code').value = '';
                document.getElementById('drawer-variable-data-type').value = '';
                document.getElementById('drawer-variable-precision').value = '';
                document.getElementById('drawer-variable-unit').value = '';
                document.getElementById('drawer-variable-range').value = '';
                document.getElementById('drawer-variable-default-value').value = '';
                document.getElementById('drawer-variable-format-validation').value = '';
                document.getElementById('drawer-variable-category').value = '';
                document.getElementById('drawer-variable-business-category').value = '';
                document.getElementById('drawer-variable-display-order').value = '';
                document.getElementById('drawer-variable-description').value = '';
                document.getElementById('drawer-variable-collection-frequency').value = '';
                document.getElementById('drawer-variable-is-required').checked = false;
                
                // 启用表单字段
                enableVariableFormFields();
            }
            
            drawer.classList.add('active');
        }

        function closeVariableDrawer() {
            document.getElementById('variable-drawer').classList.remove('active');
        }

        function saveVariableFromDrawer() {
            const saveBtn = document.querySelector('#variable-drawer .btn-primary');
            
            // 如果是查看模式，直接关闭抽屉
            if (saveBtn.textContent === '关闭') {
                closeVariableDrawer();
                return;
            }
            
            const name = document.getElementById('drawer-variable-name').value;
            const code = document.getElementById('drawer-variable-code').value;
            const dataType = document.getElementById('drawer-variable-data-type').value;
            const category = document.getElementById('drawer-variable-category').value;
            
            if (!name.trim() || !code.trim() || !dataType || !category) {
                alert('请填写必填字段');
                return;
            }
            
            // 收集表单数据
            const variableData = {
                variableGroup: document.getElementById('drawer-variable-group').value,
                name: name,
                code: code,
                dataType: dataType,
                precision: document.getElementById('drawer-variable-precision').value,
                unit: document.getElementById('drawer-variable-unit').value,
                valueRange: document.getElementById('drawer-variable-range').value,
                defaultValue: document.getElementById('drawer-variable-default-value').value,
                formatValidation: document.getElementById('drawer-variable-format-validation').value,
                category: category,
                businessCategory: document.getElementById('drawer-variable-business-category').value,
                displayOrder: document.getElementById('drawer-variable-display-order').value,
                description: document.getElementById('drawer-variable-description').value,
                collectionFrequency: document.getElementById('drawer-variable-collection-frequency').value,
                isRequired: document.getElementById('drawer-variable-is-required').checked
            };
            
            console.log('保存变量数据:', variableData);
            alert('动态变量保存成功');
            closeVariableDrawer();
        }

        function enableVariableFormFields() {
            const fields = [
                'drawer-variable-group',
                'drawer-variable-name',
                'drawer-variable-code',
                'drawer-variable-data-type',
                'drawer-variable-precision',
                'drawer-variable-unit',
                'drawer-variable-range',
                'drawer-variable-default-value',
                'drawer-variable-format-validation',
                'drawer-variable-category',
                'drawer-variable-business-category',
                'drawer-variable-display-order',
                'drawer-variable-description',
                'drawer-variable-collection-frequency',
                'drawer-variable-is-required'
            ];
            
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.disabled = false;
                }
            });
        }

        function disableVariableFormFields() {
            const fields = [
                'drawer-variable-group',
                'drawer-variable-name',
                'drawer-variable-code',
                'drawer-variable-data-type',
                'drawer-variable-precision',
                'drawer-variable-unit',
                'drawer-variable-range',
                'drawer-variable-default-value',
                'drawer-variable-format-validation',
                'drawer-variable-category',
                'drawer-variable-business-category',
                'drawer-variable-display-order',
                'drawer-variable-description',
                'drawer-variable-collection-frequency',
                'drawer-variable-is-required'
            ];
            
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.disabled = true;
                }
            });
        }

        // 抽屉事件绑定
        document.addEventListener('DOMContentLoaded', function() {
            // 属性抽屉关闭事件
            document.getElementById('property-drawer-close').addEventListener('click', closePropertyDrawer);
            
            // 变量抽屉关闭事件
            document.getElementById('variable-drawer-close').addEventListener('click', closeVariableDrawer);

            // 业务属性抽屉关闭事件
            document.getElementById('business-property-drawer-close').addEventListener('click', closeBusinessPropertyDrawer);

            // 指标抽屉关闭事件
            document.getElementById('indicator-drawer-close').addEventListener('click', closeIndicatorDrawer);

            // 点击抽屉背景关闭
            document.getElementById('property-drawer').addEventListener('click', function(e) {
                if (e.target === this) {
                    closePropertyDrawer();
                }
            });

            document.getElementById('variable-drawer').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeVariableDrawer();
                }
            });

            document.getElementById('business-property-drawer').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeBusinessPropertyDrawer();
                }
            });

            document.getElementById('indicator-drawer').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeIndicatorDrawer();
                }
            });

            // 变量选择器模态框事件
            document.getElementById('variable-selector-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeVariableSelector();
                }
            });

            // 公式显示器事件
            const formulaDisplay = document.getElementById('formula-display');
            if (formulaDisplay) {
                formulaDisplay.addEventListener('input', function() {
                    applySyntaxHighlighting();
                });
                
                formulaDisplay.addEventListener('keydown', function(e) {
                    // 处理括号成对出入
                    if (e.key === '(') {
                        e.preventDefault();
                        insertOperator('(');
                    }
                });
            }
        });

        // 全局函数，供外部调用
        // 拖拽功能实现
        function setupDragAndDrop() {
            const formulaDisplay = document.getElementById('formula-display');
            if (!formulaDisplay) return;
            
            // 拖拽开始
            document.addEventListener('dragstart', function(e) {
                const variableItem = e.target.closest('.variable-item');
                if (variableItem) {
                    variableItem.classList.add('dragging');
                    const variableName = variableItem.querySelector('.variable-item-name').getAttribute('data-variable');
                    e.dataTransfer.setData('text/plain', variableName);
                    e.dataTransfer.effectAllowed = 'copy';
                }
            });
            
            // 拖拽结束
            document.addEventListener('dragend', function(e) {
                const variableItem = e.target.closest('.variable-item');
                if (variableItem) {
                    variableItem.classList.remove('dragging');
                }
            });
            
            // 拖拽进入公式编辑器
            formulaDisplay.addEventListener('dragenter', function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'copy';
                this.classList.add('drag-over');
            });
            
            // 拖拽离开公式编辑器
            formulaDisplay.addEventListener('dragleave', function(e) {
                if (!this.contains(e.relatedTarget)) {
                    this.classList.remove('drag-over');
                }
            });
            
            // 拖拽在公式编辑器上移动
            formulaDisplay.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'copy';
                
                // 显示拖拽指示器
                let dropIndicator = this.querySelector('.drop-indicator');
                if (!dropIndicator) {
                    dropIndicator = document.createElement('div');
                    dropIndicator.className = 'drop-indicator';
                    this.appendChild(dropIndicator);
                }
                
                // 计算插入位置
                const rect = this.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                // 找到插入点
                const insertPoint = findInsertPoint(this, x, y);
                if (insertPoint) {
                    dropIndicator.style.left = insertPoint.x + 'px';
                    dropIndicator.style.top = insertPoint.y + 'px';
                    dropIndicator.style.display = 'block';
                } else {
                    dropIndicator.style.display = 'none';
                }
            });
            
            // 拖拽放置
            formulaDisplay.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('drag-over');
                
                // 隐藏拖拽指示器
                const dropIndicator = this.querySelector('.drop-indicator');
                if (dropIndicator) {
                    dropIndicator.style.display = 'none';
                }
                
                const variableName = e.dataTransfer.getData('text/plain');
                if (variableName) {
                    // 计算放置位置
                    const rect = this.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    const insertPoint = findInsertPoint(this, x, y);
                    if (insertPoint && insertPoint.element) {
                        // 在指定位置插入变量
                        insertVariableToFormula(variableName, insertPoint.element, insertPoint.offset);
                    } else {
                        // 在末尾插入变量
                        insertVariableToFormula(variableName);
                    }
                }
            });
        }
        
        // 查找插入点
        function findInsertPoint(container, x, y) {
            // 获取所有文本节点和元素节点
            const walker = document.createTreeWalker(
                container,
                NodeFilter.SHOW_TEXT | NodeFilter.SHOW_ELEMENT,
                null,
                false
            );
            
            let node;
            let closestNode = null;
            let closestDistance = Infinity;
            let closestOffset = 0;
            
            while (node = walker.nextNode()) {
                const rect = node.getBoundingClientRect();
                const containerRect = container.getBoundingClientRect();
                
                // 检查鼠标是否在节点范围内
                if (x >= rect.left - containerRect.left && 
                    x <= rect.right - containerRect.left &&
                    y >= rect.top - containerRect.top && 
                    y <= rect.bottom - containerRect.top) {
                    
                    if (node.nodeType === Node.TEXT_NODE) {
                        // 对于文本节点，计算字符偏移量
                        const textContent = node.textContent;
                        const nodeWidth = rect.width;
                        const charWidth = nodeWidth / textContent.length;
                        const relativeX = x - (rect.left - containerRect.left);
                        const offset = Math.min(Math.floor(relativeX / charWidth), textContent.length);
                        
                        return {
                            element: node,
                            offset: offset,
                            x: rect.left - containerRect.left + (offset * charWidth),
                            y: rect.top - containerRect.top
                        };
                    } else {
                        // 对于元素节点，在元素前插入
                        return {
                            element: node,
                            offset: 0,
                            x: rect.left - containerRect.left,
                            y: rect.top - containerRect.top
                        };
                    }
                }
                
                // 如果不在节点范围内，计算距离
                const nodeX = rect.left - containerRect.left;
                const nodeY = rect.top - containerRect.top;
                const distance = Math.sqrt((x - nodeX) ** 2 + (y - nodeY) ** 2);
                
                if (distance < closestDistance) {
                    closestDistance = distance;
                    closestNode = node;
                    if (node.nodeType === Node.TEXT_NODE) {
                        const textContent = node.textContent;
                        const nodeWidth = rect.width;
                        const charWidth = nodeWidth / textContent.length;
                        const relativeX = x - nodeX;
                        closestOffset = Math.min(Math.max(0, Math.floor(relativeX / charWidth)), textContent.length);
                    } else {
                        closestOffset = 0;
                    }
                }
            }
            
            if (closestNode) {
                const rect = closestNode.getBoundingClientRect();
                const containerRect = container.getBoundingClientRect();
                
                return {
                    element: closestNode,
                    offset: closestOffset,
                    x: rect.left - containerRect.left,
                    y: rect.top - containerRect.top
                };
            }
            
            // 如果没有找到合适的节点，返回容器末尾
            return {
                element: container,
                offset: container.childNodes.length,
                x: container.offsetWidth,
                y: container.offsetHeight
            };
        }
        
        window.openPropertyDrawer = openPropertyDrawer;
        window.openVariableDrawer = openVariableDrawer;
        window.openBusinessPropertyDrawer = openBusinessPropertyDrawer;
        window.openIndicatorDrawer = openIndicatorDrawer;
        window.showVariableSelector = showVariableSelector;
        window.validateFormula = validateFormula;
        window.insertOperator = insertOperator;
        window.formatFormula = formatFormula;
        window.clearFormula = clearFormula;

        // 业务属性相关函数
        function toggleSelectAllBusiness() {
            const selectAllCheckbox = document.getElementById('selectAllBusiness');
            const checkboxes = document.querySelectorAll('.business-property-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
        }

        // function showBusinessPropertyGroupSelector() {
        //     // 显示业务属性组选择模态框
        //     alert('业务属性组选择功能待实现');
        // }

        function openBusinessPropertyDrawer(mode = 'add', data = null) {
            const drawer = document.getElementById('business-property-drawer');
            const title = document.getElementById('business-property-drawer-title');
            const saveBtn = document.querySelector('#business-property-drawer .btn-primary');
            
            if (mode === 'edit' && data) {
                title.textContent = '编辑业务属性';
                saveBtn.textContent = '保存';
                // 填充表单数据
                document.getElementById('drawer-business-property-group').value = data.propertyGroup || '';
                document.getElementById('drawer-business-property-name').value = data.name || '';
                document.getElementById('drawer-business-property-code').value = data.code || '';
                document.getElementById('drawer-business-data-type').value = data.dataType || '';
                document.getElementById('drawer-business-precision').value = data.precision || '';
                document.getElementById('drawer-business-unit').value = data.unit || '';
                document.getElementById('drawer-business-value-range').value = data.valueRange || '';
                document.getElementById('drawer-business-default-value').value = data.defaultValue || '';
                document.getElementById('drawer-business-format-validation').value = data.formatValidation || '';
                setDataTags('drawer-business-category', data.category ? data.category.split(',') : []);
                document.getElementById('drawer-business-business-category').value = data.businessCategory || '';
                document.getElementById('drawer-business-display-order').value = data.displayOrder || '';
                document.getElementById('drawer-business-property-description').value = data.description || '';
                document.getElementById('drawer-business-collection-frequency').value = data.collectionFrequency || '';
                document.getElementById('drawer-business-is-required').checked = data.isRequired || false;
                
                // 启用表单字段
                enableBusinessPropertyFormFields();
            } else if (mode === 'view' && data) {
                title.textContent = '查看业务属性';
                saveBtn.textContent = '关闭';
                // 填充表单数据
                document.getElementById('drawer-business-property-group').value = data.propertyGroup || '';
                document.getElementById('drawer-business-property-name').value = data.name || '';
                document.getElementById('drawer-business-property-code').value = data.code || '';
                document.getElementById('drawer-business-data-type').value = data.dataType || '';
                document.getElementById('drawer-business-precision').value = data.precision || '';
                document.getElementById('drawer-business-unit').value = data.unit || '';
                document.getElementById('drawer-business-value-range').value = data.valueRange || '';
                document.getElementById('drawer-business-default-value').value = data.defaultValue || '';
                document.getElementById('drawer-business-format-validation').value = data.formatValidation || '';
                document.getElementById('drawer-business-category').value = data.category || '';
                document.getElementById('drawer-business-business-category').value = data.businessCategory || '';
                document.getElementById('drawer-business-display-order').value = data.displayOrder || '';
                document.getElementById('drawer-business-property-description').value = data.description || '';
                document.getElementById('drawer-business-collection-frequency').value = data.collectionFrequency || '';
                document.getElementById('drawer-business-is-required').checked = data.isRequired || false;
                
                // 禁用表单字段（只读模式）
                disableBusinessPropertyFormFields();
            } else {
                title.textContent = '新增业务属性';
                saveBtn.textContent = '保存';
                // 清空表单
                document.getElementById('drawer-business-property-group').value = '';
                document.getElementById('drawer-business-property-name').value = '';
                document.getElementById('drawer-business-property-code').value = '';
                document.getElementById('drawer-business-data-type').value = '';
                document.getElementById('drawer-business-precision').value = '';
                document.getElementById('drawer-business-unit').value = '';
                document.getElementById('drawer-business-value-range').value = '';
                document.getElementById('drawer-business-default-value').value = '';
                document.getElementById('drawer-business-format-validation').value = '';
                document.getElementById('drawer-business-category').value = '';
                document.getElementById('drawer-business-business-category').value = '';
                document.getElementById('drawer-business-display-order').value = '';
                document.getElementById('drawer-business-property-description').value = '';
                document.getElementById('drawer-business-collection-frequency').value = '';
                document.getElementById('drawer-business-is-required').checked = false;
                
                // 启用表单字段
                enableBusinessPropertyFormFields();
            }
            
            drawer.classList.add('active');
        }

        function closeBusinessPropertyDrawer() {
            document.getElementById('business-property-drawer').classList.remove('active');
        }

        function saveBusinessPropertyFromDrawer() {
            const saveBtn = document.querySelector('#business-property-drawer .btn-primary');
            
            // 如果是查看模式，直接关闭抽屉
            if (saveBtn.textContent === '关闭') {
                closeBusinessPropertyDrawer();
                return;
            }
            
            const name = document.getElementById('drawer-business-property-name').value;
            const code = document.getElementById('drawer-business-property-code').value;
            const dataType = document.getElementById('drawer-business-data-type').value;
            const isRequired = document.getElementById('drawer-business-is-required').checked;
            
            if (!name.trim() || !code.trim() || !dataType) {
                alert('请填写必填字段');
                return;
            }
            
            // 收集表单数据
            const businessPropertyData = {
                propertyGroup: document.getElementById('drawer-business-property-group').value,
                name: name,
                code: code,
                dataType: dataType,
                precision: document.getElementById('drawer-business-precision').value,
                unit: document.getElementById('drawer-business-unit').value,
                valueRange: document.getElementById('drawer-business-value-range').value,
                defaultValue: document.getElementById('drawer-business-default-value').value,
                formatValidation: document.getElementById('drawer-business-format-validation').value,
                category: document.getElementById('drawer-business-category').value,
                businessCategory: document.getElementById('drawer-business-business-category').value,
                displayOrder: document.getElementById('drawer-business-display-order').value,
                description: document.getElementById('drawer-business-property-description').value,
                collectionFrequency: document.getElementById('drawer-business-collection-frequency').value,
                isRequired: isRequired
            };
            
            console.log('保存业务属性数据:', businessPropertyData);
            alert('业务属性保存成功');
            closeBusinessPropertyDrawer();
        }

        function enableBusinessPropertyFormFields() {
            const fields = [
                'drawer-business-property-group',
                'drawer-business-property-name',
                'drawer-business-property-code',
                'drawer-business-data-type',
                'drawer-business-precision',
                'drawer-business-unit',
                'drawer-business-value-range',
                'drawer-business-default-value',
                'drawer-business-format-validation',
                'drawer-business-category',
                'drawer-business-business-category',
                'drawer-business-display-order',
                'drawer-business-property-description',
                'drawer-business-collection-frequency',
                'drawer-business-is-required'
            ];
            
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.disabled = false;
                }
            });
        }

        function disableBusinessPropertyFormFields() {
            const fields = [
                'drawer-business-property-group',
                'drawer-business-property-name',
                'drawer-business-property-code',
                'drawer-business-data-type',
                'drawer-business-precision',
                'drawer-business-unit',
                'drawer-business-value-range',
                'drawer-business-default-value',
                'drawer-business-format-validation',
                'drawer-business-category',
                'drawer-business-business-category',
                'drawer-business-display-order',
                'drawer-business-property-description',
                'drawer-business-collection-frequency',
                'drawer-business-is-required'
            ];
            
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.disabled = true;
                }
            });
        }

        function editBusinessPropertyFromDrawer(businessPropertyId) {
            // 模拟业务属性数据 - 在实际应用中，这里应该从API获取数据
            const businessPropertyData = {
                1: {
                    propertyGroup: 'business',
                    name: '设备负责人',
                    code: 'device_manager',
                    dataType: 'string',
                    precision: '',
                    unit: '',
                    valueRange: '',
                    defaultValue: '',
                    formatValidation: '',
                    category: 'status',
                    businessCategory: 'maintenance',
                    displayOrder: 1,
                    description: '设备的负责人信息',
                    collectionFrequency: '1d',
                    isRequired: true
                },
                2: {
                    propertyGroup: 'business',
                    name: '维护周期',
                    code: 'maintenance_cycle',
                    dataType: 'number',
                    precision: '1',
                    unit: '天',
                    valueRange: '1-365',
                    defaultValue: '30',
                    formatValidation: '',
                    category: 'cumulative',
                    businessCategory: 'maintenance',
                    displayOrder: 2,
                    description: '设备维护周期（天）',
                    collectionFrequency: '1d',
                    isRequired: false
                },
                3: {
                    propertyGroup: 'business',
                    name: '设备状态',
                    code: 'device_status',
                    dataType: 'enum',
                    precision: '',
                    unit: '',
                    valueRange: '正常,维护中,故障,停用',
                    defaultValue: '正常',
                    formatValidation: '',
                    category: 'status',
                    businessCategory: 'maintenance',
                    displayOrder: 3,
                    description: '设备的业务状态',
                    collectionFrequency: '1h',
                    isRequired: true
                },
                4: {
                    propertyGroup: 'business',
                    name: '采购日期',
                    code: 'purchase_date',
                    dataType: 'date',
                    precision: '',
                    unit: '',
                    valueRange: '',
                    defaultValue: '',
                    formatValidation: '',
                    category: 'business',
                    displayOrder: 4,
                    description: '设备采购日期',
                    collectionFrequency: '1d',
                    isRequired: false
                }
            };

            const businessProperty = businessPropertyData[businessPropertyId];
            if (!businessProperty) {
                alert('未找到业务属性数据');
                return;
            }

            // 打开抽屉并填充数据
            openBusinessPropertyDrawer('edit', businessProperty);
        }

        function viewBusinessPropertyFromDrawer(businessPropertyId) {
            // 模拟业务属性数据 - 在实际应用中，这里应该从API获取数据
            const businessPropertyData = {
                1: {
                    propertyGroup: 'business',
                    name: '设备负责人',
                    code: 'device_manager',
                    dataType: 'string',
                    precision: '',
                    unit: '',
                    valueRange: '',
                    defaultValue: '',
                    formatValidation: '',
                    category: 'status',
                    businessCategory: 'maintenance',
                    displayOrder: 1,
                    description: '设备的负责人信息',
                    collectionFrequency: '1d',
                    isRequired: true
                },
                2: {
                    propertyGroup: 'business',
                    name: '维护周期',
                    code: 'maintenance_cycle',
                    dataType: 'number',
                    precision: '1',
                    unit: '天',
                    valueRange: '1-365',
                    defaultValue: '30',
                    formatValidation: '',
                    category: 'cumulative',
                    businessCategory: 'maintenance',
                    displayOrder: 2,
                    description: '设备维护周期（天）',
                    collectionFrequency: '1d',
                    isRequired: false
                },
                3: {
                    propertyGroup: 'business',
                    name: '设备状态',
                    code: 'device_status',
                    dataType: 'enum',
                    precision: '',
                    unit: '',
                    valueRange: '正常,维护中,故障,停用',
                    defaultValue: '正常',
                    formatValidation: '',
                    category: 'status',
                    businessCategory: 'maintenance',
                    displayOrder: 3,
                    description: '设备的业务状态',
                    collectionFrequency: '1h',
                    isRequired: true
                },
                4: {
                    propertyGroup: 'business',
                    name: '采购日期',
                    code: 'purchase_date',
                    dataType: 'date',
                    precision: '',
                    unit: '',
                    valueRange: '',
                    defaultValue: '',
                    formatValidation: '',
                    category: 'business',
                    displayOrder: 4,
                    description: '设备采购日期',
                    collectionFrequency: '1d',
                    isRequired: false
                }
            };

            const businessProperty = businessPropertyData[businessPropertyId];
            if (!businessProperty) {
                alert('未找到业务属性数据');
                return;
            }

            // 打开抽屉并填充数据（只读模式）
            openBusinessPropertyDrawer('view', businessProperty);
        }

        function deleteBusinessProperty(businessPropertyId) {
            if (confirm('确定要删除这个业务属性吗？')) {
                console.log('删除业务属性:', businessPropertyId);
                alert('业务属性删除成功');
            }
        }

        // 指标相关函数
        function toggleSelectAllIndicators() {
            const selectAllCheckbox = document.getElementById('selectAllIndicators');
            const checkboxes = document.querySelectorAll('.indicator-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
        }

        function showIndicatorTemplateSelector() {
            // 显示指标模板选择模态框
            alert('指标模板选择功能待实现');
        }

        function openIndicatorDrawer(mode = 'add', data = null) {
            const drawer = document.getElementById('indicator-drawer');
            const title = document.getElementById('indicator-drawer-title');
            const saveBtn = document.querySelector('#indicator-drawer .btn-primary');
            
            if (mode === 'edit' && data) {
                title.textContent = '编辑指标';
                saveBtn.textContent = '保存';
                // 填充表单数据
                document.getElementById('drawer-indicator-name').value = data.name || '';
                document.getElementById('drawer-indicator-code').value = data.code || '';
                document.getElementById('drawer-indicator-category').value = data.category || '';
                document.getElementById('drawer-indicator-direction').value = data.direction || '';
                document.getElementById('drawer-indicator-unit').value = data.unit || '';
                document.getElementById('drawer-calculation-cycle').value = data.calculationCycle || '';
                document.getElementById('drawer-update-frequency').value = data.updateFrequency || '';
                document.getElementById('formula-display').textContent = data.formula || '';
                applySyntaxHighlighting();
                document.getElementById('drawer-indicator-description').value = data.description || '';
                
                // 加载参与变量
                loadParticipatingVariables(data.participatingVariables || []);
                
                // 启用表单字段
                enableIndicatorFormFields();
            } else if (mode === 'view' && data) {
                title.textContent = '查看指标';
                saveBtn.textContent = '关闭';
                // 填充表单数据
                document.getElementById('drawer-indicator-name').value = data.name || '';
                document.getElementById('drawer-indicator-code').value = data.code || '';
                document.getElementById('drawer-indicator-category').value = data.category || '';
                document.getElementById('drawer-indicator-direction').value = data.direction || '';
                document.getElementById('drawer-indicator-unit').value = data.unit || '';
                document.getElementById('drawer-calculation-cycle').value = data.calculationCycle || '';
                document.getElementById('drawer-update-frequency').value = data.updateFrequency || '';
                document.getElementById('formula-display').textContent = data.formula || '';
                applySyntaxHighlighting();
                document.getElementById('drawer-indicator-description').value = data.description || '';
                
                // 加载参与变量
                loadParticipatingVariables(data.participatingVariables || []);
                
                // 禁用表单字段（只读模式）
                disableIndicatorFormFields();
            } else {
                title.textContent = '新增指标';
                saveBtn.textContent = '保存';
                // 清空表单
                document.getElementById('drawer-indicator-name').value = '';
                document.getElementById('drawer-indicator-code').value = '';
                document.getElementById('drawer-indicator-category').value = '';
                document.getElementById('drawer-indicator-direction').value = '';
                document.getElementById('drawer-indicator-unit').value = '';
                document.getElementById('drawer-calculation-cycle').value = '';
                document.getElementById('drawer-update-frequency').value = '';
                document.getElementById('formula-display').textContent = '';
                document.getElementById('drawer-indicator-description').value = '';
                
                // 清空参与变量
                document.getElementById('drawer-participating-variables').querySelector('.variable-list').innerHTML = '';
                
                // 启用表单字段
                enableIndicatorFormFields();
            }
            
            drawer.classList.add('active');
            
            // 确保公式显示器正确初始化
            setTimeout(() => {
                const formulaDisplay = document.getElementById('formula-display');
                if (formulaDisplay) {
                    // 重新应用语法高亮
                    applySyntaxHighlighting();
                }
            }, 100);
        }

        function closeIndicatorDrawer() {
            document.getElementById('indicator-drawer').classList.remove('active');
        }

        function saveIndicatorFromDrawer() {
            const saveBtn = document.querySelector('#indicator-drawer .btn-primary');
            
            // 如果是查看模式，直接关闭抽屉
            if (saveBtn.textContent === '关闭') {
                closeIndicatorDrawer();
                return;
            }
            
            const name = document.getElementById('drawer-indicator-name').value;
            const code = document.getElementById('drawer-indicator-code').value;
            const category = document.getElementById('drawer-indicator-category').value;
            const direction = document.getElementById('drawer-indicator-direction').value;
            const calculationCycle = document.getElementById('drawer-calculation-cycle').value;
            const updateFrequency = document.getElementById('drawer-update-frequency').value;
            
            if (!name.trim() || !code.trim() || !category || !direction || !calculationCycle || !updateFrequency) {
                alert('请填写必填字段');
                return;
            }
            
            // 收集参与变量
            const participatingVariables = [];
            const variableItems = document.querySelectorAll('#drawer-participating-variables .variable-item');
            variableItems.forEach(item => {
                const variableName = item.querySelector('.variable-item-name').textContent;
                participatingVariables.push(variableName);
            });
            
            // 收集表单数据
            const indicatorData = {
                name: name,
                code: code,
                category: category,
                direction: direction,
                unit: document.getElementById('drawer-indicator-unit').value,
                calculationCycle: calculationCycle,
                updateFrequency: updateFrequency,
                formula: document.getElementById('drawer-calculation-formula').value,
                participatingVariables: participatingVariables,
                description: document.getElementById('drawer-indicator-description').value
            };
            
            console.log('保存指标数据:', indicatorData);
            alert('指标保存成功');
            closeIndicatorDrawer();
        }

        function enableIndicatorFormFields() {
            const fields = [
                'drawer-indicator-name',
                'drawer-indicator-code',
                'drawer-indicator-category',
                'drawer-indicator-direction',
                'drawer-indicator-unit',
                'drawer-calculation-cycle',
                'drawer-update-frequency',
                'drawer-calculation-formula',
                'drawer-indicator-description'
            ];
            
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.disabled = false;
                }
            });
        }

        function disableIndicatorFormFields() {
            const fields = [
                'drawer-indicator-name',
                'drawer-indicator-code',
                'drawer-indicator-category',
                'drawer-indicator-direction',
                'drawer-indicator-unit',
                'drawer-calculation-cycle',
                'drawer-update-frequency',
                'drawer-calculation-formula',
                'drawer-indicator-description'
            ];
            
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.disabled = true;
                }
            });
        }

        function loadParticipatingVariables(variables) {
            const container = document.querySelector('#drawer-participating-variables .variable-list');
            container.innerHTML = '';
            
            // 变量分类映射
            const variableCategories = {
                '实际产量': '动态变量',
                '理论产量': '动态变量',
                '运行时间': '动态变量',
                '总能耗': '动态变量',
                '总产量': '动态变量',
                '故障次数': '动态变量',
                '能源成本': '业务属性',
                '维护成本': '业务属性',
                '人工成本': '业务属性',
                '其他成本': '业务属性',
                '设备名称': '静态属性',
                '设备编码': '静态属性',
                '设备类型': '静态属性',
                '制造商': '静态属性',
                '安装日期': '静态属性',
                '状态': '静态属性',
                '设备负责人': '业务属性',
                '维护周期': '业务属性',
                '设备状态': '业务属性',
                '采购日期': '业务属性',
                '设备温度': '动态变量',
                '设备压力': '动态变量',
                '运行速度': '动态变量',
                '产量': '动态变量',
                '能耗': '动态变量'
            };

            // 变量描述映射
            const variableDescriptions = {
                '实际产量': '设备实际生产的产量',
                '理论产量': '设备理论最大产量',
                '运行时间': '设备运行的总时间',
                '总能耗': '设备总能耗',
                '总产量': '设备总产量',
                '故障次数': '设备故障次数',
                '能源成本': '设备能源消耗成本',
                '维护成本': '设备维护成本',
                '人工成本': '设备人工成本',
                '其他成本': '设备其他相关成本',
                '设备名称': '设备的基本名称',
                '设备编码': '设备的唯一编码',
                '设备类型': '设备的分类类型',
                '制造商': '设备制造商信息',
                '安装日期': '设备安装日期',
                '状态': '设备运行状态',
                '设备负责人': '设备的负责人信息',
                '维护周期': '设备维护周期（天）',
                '设备状态': '设备的业务状态',
                '采购日期': '设备采购日期',
                '设备温度': '设备当前温度',
                '设备压力': '设备当前压力',
                '运行速度': '设备运行速度',
                '产量': '设备当前产量',
                '能耗': '设备能耗'
            };
            
            variables.forEach(variable => {
                const variableItem = document.createElement('div');
                variableItem.className = 'variable-item';
                
                const category = variableCategories[variable] || '动态变量';
                const description = variableDescriptions[variable] || '变量描述';
                
                variableItem.innerHTML = `
                    <div class="variable-item-info">
                        <span class="variable-item-name" data-variable="${variable}" title="${description}">${variable}</span>
                        <span class="variable-item-category">${category}</span>
                        <span class="variable-item-description">${description}</span>
                    </div>
                    <span class="variable-item-remove" onclick="removeParticipatingVariable(this)">&times;</span>
                `;
                variableItem.setAttribute('draggable', 'true');
                container.appendChild(variableItem);
            });
            
            // 设置拖拽功能
            setupDragAndDrop();
        }

        function addParticipatingVariable() {
            // 这里应该打开变量选择器，暂时使用模拟数据
            const availableVariables = ['设备温度', '设备压力', '运行速度', '产量', '能耗', '故障次数'];
            const selectedVariable = prompt('请选择要添加的变量：\n' + availableVariables.join('\n'));
            
            if (selectedVariable && availableVariables.includes(selectedVariable)) {
                const container = document.querySelector('#drawer-participating-variables .variable-list');
                const variableItem = document.createElement('div');
                variableItem.className = 'variable-item';
                
                // 获取变量分类和描述
                const variableCategories = {
                    '设备温度': '动态变量',
                    '设备压力': '动态变量',
                    '运行速度': '动态变量',
                    '产量': '动态变量',
                    '能耗': '动态变量',
                    '故障次数': '动态变量'
                };
                
                const variableDescriptions = {
                    '设备温度': '设备当前温度',
                    '设备压力': '设备当前压力',
                    '运行速度': '设备运行速度',
                    '产量': '设备当前产量',
                    '能耗': '设备能耗',
                    '故障次数': '设备故障次数'
                };
                
                const category = variableCategories[selectedVariable] || '动态变量';
                const description = variableDescriptions[selectedVariable] || '变量描述';
                
                                    variableItem.innerHTML = `
                        <div class="variable-item-info">
                            <span class="variable-item-name" data-variable="${selectedVariable}" title="${description}">${selectedVariable}</span>
                            <span class="variable-item-category">${category}</span>
                            <span class="variable-item-description">${description}</span>
                        </div>
                        <span class="variable-item-remove" onclick="removeParticipatingVariable(this)">&times;</span>
                    `;
                                    variableItem.setAttribute('draggable', 'true');
                container.appendChild(variableItem);
                
                // 重新设置拖拽功能
                setupDragAndDrop();
            }
        }

        function removeParticipatingVariable(element) {
            element.parentElement.remove();
        }

        function editIndicatorFromDrawer(indicatorId) {
            // 模拟指标数据 - 在实际应用中，这里应该从API获取数据
            const indicatorData = {
                1: {
                    name: '设备效率',
                    code: 'device_efficiency',
                    category: 'performance',
                    direction: 'positive',
                    unit: '%',
                    calculationCycle: 'hour',
                    updateFrequency: '1h',
                    formula: '实际产量/理论产量*100%',
                    participatingVariables: ['实际产量', '理论产量', '运行时间'],
                    description: '设备运行效率，基于实际产量与理论产量的比值'
                },
                2: {
                    name: '单位能耗',
                    code: 'unit_energy_consumption',
                    category: 'environmental',
                    direction: 'negative',
                    unit: 'kWh/吨',
                    calculationCycle: 'day',
                    updateFrequency: '1d',
                    formula: '总能耗/总产量',
                    participatingVariables: ['总能耗', '总产量'],
                    description: '单位产品的能源消耗量'
                },
                3: {
                    name: '故障率',
                    code: 'failure_rate',
                    category: 'safety',
                    direction: 'negative',
                    unit: '次/月',
                    calculationCycle: 'month',
                    updateFrequency: '1d',
                    formula: '故障次数/运行时间*30',
                    participatingVariables: ['故障次数'],
                    description: '设备故障次数与运行时间的比值'
                },
                4: {
                    name: '运营成本',
                    code: 'operating_cost',
                    category: 'economic',
                    direction: 'negative',
                    unit: '元/月',
                    calculationCycle: 'month',
                    updateFrequency: '1d',
                    formula: '能源成本+维护成本+人工成本',
                    participatingVariables: ['能源成本', '维护成本', '人工成本', '其他成本'],
                    description: '设备运营总成本，包括能源、维护、人工等费用'
                }
            };

            const indicator = indicatorData[indicatorId];
            if (!indicator) {
                alert('未找到指标数据');
                return;
            }

            // 打开抽屉并填充数据
            openIndicatorDrawer('edit', indicator);
        }

        function viewIndicatorFromDrawer(indicatorId) {
            // 模拟指标数据 - 在实际应用中，这里应该从API获取数据
            const indicatorData = {
                1: {
                    name: '设备效率',
                    code: 'device_efficiency',
                    category: 'performance',
                    direction: 'positive',
                    unit: '%',
                    calculationCycle: 'hour',
                    updateFrequency: '1h',
                    formula: '实际产量/理论产量*100%',
                    participatingVariables: ['实际产量', '理论产量', '运行时间'],
                    description: '设备运行效率，基于实际产量与理论产量的比值'
                },
                2: {
                    name: '单位能耗',
                    code: 'unit_energy_consumption',
                    category: 'environmental',
                    direction: 'negative',
                    unit: 'kWh/吨',
                    calculationCycle: 'day',
                    updateFrequency: '1d',
                    formula: '总能耗/总产量',
                    participatingVariables: ['总能耗', '总产量'],
                    description: '单位产品的能源消耗量'
                },
                3: {
                    name: '故障率',
                    code: 'failure_rate',
                    category: 'safety',
                    direction: 'negative',
                    unit: '次/月',
                    calculationCycle: 'month',
                    updateFrequency: '1d',
                    formula: '故障次数/运行时间*30',
                    participatingVariables: ['故障次数'],
                    description: '设备故障次数与运行时间的比值'
                },
                4: {
                    name: '运营成本',
                    code: 'operating_cost',
                    category: 'economic',
                    direction: 'negative',
                    unit: '元/月',
                    calculationCycle: 'month',
                    updateFrequency: '1d',
                    formula: '能源成本+维护成本+人工成本',
                    participatingVariables: ['能源成本', '维护成本', '人工成本', '其他成本'],
                    description: '设备运营总成本，包括能源、维护、人工等费用'
                }
            };

            const indicator = indicatorData[indicatorId];
            if (!indicator) {
                alert('未找到指标数据');
                return;
            }

            // 打开抽屉并填充数据（只读模式）
            openIndicatorDrawer('view', indicator);
        }

        function deleteIndicator(indicatorId) {
            if (confirm('确定要删除这个指标吗？')) {
                console.log('删除指标:', indicatorId);
                alert('指标删除成功');
            }
        }

        // 变量选择器相关函数
        let selectedVariables = new Set();
        let currentVariableTab = 'static';

        function showVariableSelector() {
            const modal = document.getElementById('variable-selector-modal');
            const title = modal.querySelector('.modal-title');
            title.textContent = '选择参与变量';
            modal.classList.add('active');
            loadVariableData();
        }

        function closeVariableSelector() {
            const modal = document.getElementById('variable-selector-modal');
            modal.classList.remove('active');
            selectedVariables.clear();
            document.getElementById('variable-search-input').value = '';
        }

        function switchVariableTab(tab) {
            currentVariableTab = tab;
            
            // 更新标签页状态
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // 更新内容显示
            document.querySelectorAll('.variable-tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tab + '-variables').classList.add('active');
            
            // 重新加载数据
            loadVariableData();
        }

        function loadVariableData() {
            // 模拟数据 - 在实际应用中应该从API获取
            const staticVariables = [
                { id: 'device_name', name: '设备名称', desc: '设备的基本名称', type: 'string' },
                { id: 'device_code', name: '设备编码', desc: '设备的唯一编码', type: 'string' },
                { id: 'device_type', name: '设备类型', desc: '设备的分类类型', type: 'enum' },
                { id: 'manufacturer', name: '制造商', desc: '设备制造商信息', type: 'string' },
                { id: 'install_date', name: '安装日期', desc: '设备安装日期', type: 'date' },
                { id: 'status', name: '状态', desc: '设备运行状态', type: 'enum' }
            ];

            const dynamicVariables = [
                { id: 'temperature', name: '设备温度', desc: '设备当前温度', type: 'number', unit: '°C' },
                { id: 'pressure', name: '设备压力', desc: '设备当前压力', type: 'number', unit: 'MPa' },
                { id: 'speed', name: '运行速度', desc: '设备运行速度', type: 'number', unit: 'rpm' },
                { id: 'output', name: '产量', desc: '设备当前产量', type: 'number', unit: '吨/小时' },
                { id: 'energy_consumption', name: '能耗', desc: '设备能耗', type: 'number', unit: 'kWh' },
                { id: 'fault_count', name: '故障次数', desc: '设备故障次数', type: 'number', unit: '次' }
            ];

            const businessVariables = [
                { id: 'device_manager', name: '设备负责人', desc: '设备的负责人信息', type: 'string' },
                { id: 'maintenance_cycle', name: '维护周期', desc: '设备维护周期', type: 'number', unit: '天' },
                { id: 'device_status', name: '设备状态', desc: '设备的业务状态', type: 'enum' },
                { id: 'purchase_date', name: '采购日期', desc: '设备采购日期', type: 'date' }
            ];

            const indicatorVariables = [
                { id: 'efficiency_rate', name: '设备效率', desc: '设备运行效率指标', type: 'number', unit: '%' },
                { id: 'energy_efficiency', name: '能效比', desc: '设备能效比指标', type: 'number', unit: 'kWh/吨' },
                { id: 'maintenance_score', name: '维护评分', desc: '设备维护质量评分', type: 'number', unit: '分' },
                { id: 'reliability_index', name: '可靠性指数', desc: '设备可靠性评估指标', type: 'number', unit: '%' },
                { id: 'availability_rate', name: '可用率', desc: '设备可用率指标', type: 'number', unit: '%' },
                { id: 'quality_score', name: '质量评分', desc: '产品质量评分指标', type: 'number', unit: '分' }
            ];

            const variables = {
                static: staticVariables,
                dynamic: dynamicVariables,
                business: businessVariables,
                indicator: indicatorVariables
            };

            const container = document.getElementById(currentVariableTab + '-variables');
            container.innerHTML = '';

            variables[currentVariableTab].forEach(variable => {
                const item = document.createElement('div');
                item.className = 'variable-item-selectable';
                item.onclick = () => toggleVariableSelection(variable.id);
                
                // 获取分类名称
                const categoryNames = {
                    static: '静态属性',
                    dynamic: '动态变量',
                    business: '业务属性',
                    indicator: '指标'
                };
                
                item.innerHTML = `
                    <input type="checkbox" class="variable-item-checkbox" ${selectedVariables.has(variable.id) ? 'checked' : ''}>
                    <div class="variable-item-info">
                        <div class="variable-item-name" title="${variable.desc}${variable.unit ? ' (' + variable.unit + ')' : ''}">${variable.name}</div>
                        <div class="variable-item-desc">${variable.desc}${variable.unit ? ' (' + variable.unit + ')' : ''}</div>
                        <div class="variable-item-category">${categoryNames[currentVariableTab]}</div>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function toggleVariableSelection(variableId) {
            if (selectedVariables.has(variableId)) {
                selectedVariables.delete(variableId);
            } else {
                selectedVariables.add(variableId);
            }
            
            // 更新复选框状态
            const item = event.currentTarget;
            const checkbox = item.querySelector('.variable-item-checkbox');
            checkbox.checked = selectedVariables.has(variableId);
            
            // 更新选中状态样式
            if (selectedVariables.has(variableId)) {
                item.classList.add('selected');
            } else {
                item.classList.remove('selected');
            }
        }

        function searchVariables() {
            const searchTerm = document.getElementById('variable-search-input').value.toLowerCase();
            const items = document.querySelectorAll('.variable-item-selectable');
            
            items.forEach(item => {
                const name = item.querySelector('.variable-item-name').textContent.toLowerCase();
                const desc = item.querySelector('.variable-item-desc').textContent.toLowerCase();
                
                if (name.includes(searchTerm) || desc.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function confirmVariableSelection() {
            // 检查是否有条件变量选择的回调函数
            if (window.confirmConditionVariableSelection) {
                window.confirmConditionVariableSelection();
                window.confirmConditionVariableSelection = null; // 清除回调
                return;
            }
            
            // 检查是否有规则变量选择的回调函数
            if (window.confirmRuleVariableSelection) {
                window.confirmRuleVariableSelection();
                window.confirmRuleVariableSelection = null; // 清除回调
                return;
            }

            // 默认的指标定义变量选择逻辑
            // 获取选中的变量名称
            const selectedVariableNames = [];
            selectedVariables.forEach(id => {
                // 根据ID获取变量名称 - 这里简化处理
                const variableMap = {
                    'device_name': '设备名称',
                    'device_code': '设备编码',
                    'device_type': '设备类型',
                    'manufacturer': '制造商',
                    'install_date': '安装日期',
                    'status': '状态',
                    'abc_category': 'ABC类别',
                    'repair_years': '报修年限',
                    'service_years': '使用年限',
                    'custodian': '保管人',
                    'temperature': '设备温度',
                    'pressure': '设备压力',
                    'speed': '运行速度',
                    'output': '产量',
                    'energy_consumption': '能耗',
                    'fault_count': '故障次数',
                    'device_manager': '设备负责人',
                    'maintenance_cycle': '维护周期',
                    'device_status': '设备状态',
                    'purchase_date': '采购日期',
                    'efficiency_rate': '设备效率',
                    'energy_efficiency': '能效比',
                    'maintenance_score': '维护评分',
                    'reliability_index': '可靠性指数',
                    'availability_rate': '可用率',
                    'quality_score': '质量评分'
                };
                
                if (variableMap[id]) {
                    selectedVariableNames.push(variableMap[id]);
                }
            });

            // 添加到参与变量列表
            const container = document.querySelector('#drawer-participating-variables .variable-list');
            if (container) {
                selectedVariableNames.forEach(name => {
                    // 检查是否已存在
                    const existingItems = container.querySelectorAll('.variable-item-name');
                    let exists = false;
                    existingItems.forEach(item => {
                        if (item.textContent === name) {
                            exists = true;
                        }
                    });
                    
                    if (!exists) {
                        const variableItem = document.createElement('div');
                        variableItem.className = 'variable-item';
                        
                        // 根据变量名称判断分类
                        let category = '动态变量';
                        if (['设备名称', '设备编码', '设备类型', '制造商', '安装日期', '状态', 'ABC类别', '报修年限', '使用年限', '保管人'].includes(name)) {
                            category = '静态属性';
                        } else if (['设备负责人', '维护周期', '设备状态', '采购日期'].includes(name)) {
                            category = '业务属性';
                        } else if (['设备效率', '能效比', '维护评分', '可靠性指数', '可用率', '质量评分'].includes(name)) {
                            category = '指标';
                        }
                        
                        variableItem.innerHTML = `
                            <div class="variable-item-info">
                                <span class="variable-item-name" data-variable="${name}">${name}</span>
                                <span class="variable-item-category">${category}</span>
                                <span class="variable-item-description">${variableDescriptions[name] || '变量描述'}</span>
                            </div>
                            <span class="variable-item-remove" onclick="removeParticipatingVariable(this)">&times;</span>
                        `;
                        variableItem.setAttribute('draggable', 'true');
                        container.appendChild(variableItem);
                    }
                });
                
                // 重新设置拖拽功能
                if (typeof setupDragAndDrop === 'function') {
                    setupDragAndDrop();
                }
            }

            closeVariableSelector();
        }

        function insertVariableToFormula(variableName, targetElement = null, offset = 0) {
            const formulaDisplay = document.getElementById('formula-display');
            const formulaInput = document.getElementById('drawer-calculation-formula');
            
            if (!formulaDisplay) {
                console.error('formula-display element not found');
                return;
            }
            
            let insertPosition = null;
            
            if (targetElement) {
                // 如果指定了目标元素，在目标位置插入
                const variableSpan = document.createElement('span');
                variableSpan.className = 'variable-badge';
                variableSpan.textContent = variableName;
                
                if (targetElement.nodeType === Node.TEXT_NODE) {
                    // 在文本节点中插入
                    const range = document.createRange();
                    range.setStart(targetElement, offset);
                    range.insertNode(variableSpan);
                    
                    // 在变量后添加空格
                    const space = document.createTextNode(' ');
                    range.setStartAfter(variableSpan);
                    range.insertNode(space);
                } else if (targetElement === formulaDisplay) {
                    // 在容器末尾插入
                    formulaDisplay.appendChild(variableSpan);
                    formulaDisplay.appendChild(document.createTextNode(' '));
                } else {
                    // 在元素前插入
                    targetElement.parentNode.insertBefore(variableSpan, targetElement);
                    // 在变量后添加空格
                    const space = document.createTextNode(' ');
                    targetElement.parentNode.insertBefore(space, targetElement);
                }
                insertPosition = variableSpan;
            } else {
                // 在光标位置插入变量
                const selection = window.getSelection();
                
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    
                    // 创建变量徽标
                    const badge = document.createElement('span');
                    badge.className = 'variable-badge';
                    badge.textContent = variableName;
                    range.insertNode(badge);
                    
                    // 在徽标后添加空格
                    const space = document.createTextNode(' ');
                    range.setStartAfter(badge);
                    range.insertNode(space);
                    
                    range.collapse(false);
                    selection.removeAllRanges();
                    selection.addRange(range);
                    insertPosition = badge;
                } else {
                    // 如果没有选中范围，添加到末尾
                    const badge = document.createElement('span');
                    badge.className = 'variable-badge';
                    badge.textContent = variableName;
                    formulaDisplay.appendChild(badge);
                    formulaDisplay.appendChild(document.createTextNode(' '));
                    insertPosition = badge;
                }
            }
            
            // 同步到隐藏的textarea
            formulaInput.value = formulaDisplay.textContent;
            
            // 延迟应用语法高亮
            setTimeout(() => {
                applySyntaxHighlighting();
            }, 50);
            
            return insertPosition;
        }

        function validateFormula() {
            const formula = document.getElementById('formula-display').textContent;
            const statusElement = document.getElementById('formula-status');
            
            if (!formula.trim()) {
                statusElement.textContent = '请输入计算公式';
                statusElement.className = 'formula-status invalid';
                return;
            }

            // 简单的公式格式检查
            const errors = [];
            
            // 检查基本运算符
            const operators = ['+', '-', '*', '/', '(', ')', '=', '%', '**'];
            const hasOperator = operators.some(op => formula.includes(op));
            if (!hasOperator) {
                errors.push('公式应包含运算符（+、-、*、/、()、=等）');
            }

            // 检查括号匹配
            const openBrackets = (formula.match(/\(/g) || []).length;
            const closeBrackets = (formula.match(/\)/g) || []).length;
            if (openBrackets !== closeBrackets) {
                errors.push('括号不匹配');
            }

            // 检查除零
            if (formula.includes('/0')) {
                errors.push('公式中包含除零操作');
            }

            // 检查变量是否存在
            const variableNames = [];
            const variableItems = document.querySelectorAll('#drawer-participating-variables .variable-item-name');
            variableItems.forEach(item => {
                variableNames.push(item.textContent);
            });

            // 简单的变量检查（这里可以根据实际需求完善）
            const words = formula.match(/[\u4e00-\u9fa5a-zA-Z_]+/g) || [];
            const undefinedVariables = words.filter(word => 
                !operators.includes(word) && 
                !['实际', '理论', '产量', '时间', '次数', '成本', '能耗', 'sqrt', 'abs', 'max', 'min', 'avg', 'sum', 'count', 'if', 'round', 'floor', 'ceil'].includes(word) &&
                !variableNames.includes(word)
            );

            if (undefinedVariables.length > 0) {
                errors.push(`未定义的变量: ${undefinedVariables.join(', ')}`);
            }

            if (errors.length > 0) {
                statusElement.textContent = '校验失败';
                statusElement.className = 'formula-status invalid';
                setTimeout(() => {
                    alert('公式校验失败：\n' + errors.join('\n'));
                }, 100);
            } else {
                statusElement.textContent = '格式正确';
                statusElement.className = 'formula-status valid';
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 2000);
            }
        }

        function insertOperator(operator) {
            const formulaDisplay = document.getElementById('formula-display');
            const formulaInput = document.getElementById('drawer-calculation-formula');
            
            // 处理括号成对出入
            if (operator === '(') {
                insertTextAtCursor('()');
                // 将光标移动到括号中间
                setTimeout(() => {
                    const range = document.createRange();
                    const selection = window.getSelection();
                    const textNodes = getTextNodes(formulaDisplay);
                    let currentPos = 0;
                    
                    for (let node of textNodes) {
                        if (node.nodeType === Node.TEXT_NODE) {
                            const text = node.textContent;
                            const openBracketIndex = text.lastIndexOf('(');
                            if (openBracketIndex !== -1) {
                                range.setStart(node, openBracketIndex + 1);
                                range.setEnd(node, openBracketIndex + 1);
                                selection.removeAllRanges();
                                selection.addRange(range);
                                break;
                            }
                            currentPos += text.length;
                        }
                    }
                }, 10);
            } else {
                insertTextAtCursor(operator);
            }
            
            // 同步到隐藏的textarea
            formulaInput.value = formulaDisplay.textContent;
            
            // 延迟应用语法高亮，避免显示HTML源码
            setTimeout(() => {
                applySyntaxHighlighting();
            }, 50);
        }

        function insertTextAtCursor(text) {
            const formulaDisplay = document.getElementById('formula-display');
            const selection = window.getSelection();
            
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                range.deleteContents();
                range.insertNode(document.createTextNode(text));
                range.collapse(false);
                selection.removeAllRanges();
                selection.addRange(range);
            } else {
                formulaDisplay.textContent += text;
            }
            
            // 移除这里的语法高亮调用，由调用方控制
        }

        function getTextNodes(element) {
            const textNodes = [];
            const walker = document.createTreeWalker(
                element,
                NodeFilter.SHOW_TEXT,
                null,
                false
            );
            
            let node;
            while (node = walker.nextNode()) {
                textNodes.push(node);
            }
            
            return textNodes;
        }

        function formatFormula() {
            const formulaDisplay = document.getElementById('formula-display');
            let formula = formulaDisplay.textContent;
            
            // 基本的格式化规则
            formula = formula.replace(/\s+/g, ' '); // 合并多个空格
            formula = formula.replace(/\s*([+\-*/=()])\s*/g, ' $1 '); // 运算符前后加空格
            formula = formula.replace(/\s*,\s*/g, ', '); // 逗号后加空格
            formula = formula.trim(); // 去除首尾空格
            
            formulaDisplay.textContent = formula;
            applySyntaxHighlighting();
        }

        function clearFormula() {
            if (confirm('确定要清空计算公式吗？')) {
                document.getElementById('formula-display').innerHTML = '';
                document.getElementById('drawer-calculation-formula').value = '';
                document.getElementById('formula-status').style.display = 'none';
            }
        }

        function applySyntaxHighlighting() {
            const formulaDisplay = document.getElementById('formula-display');
            const formulaInput = document.getElementById('drawer-calculation-formula');
            const content = formulaDisplay.textContent;
            
            // 保存光标位置
            const selection = window.getSelection();
            let cursorOffset = 0;
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                cursorOffset = range.startOffset;
            }
            
            // 清空内容
            formulaDisplay.innerHTML = '';
            
            // 获取变量列表
            const variableNames = [];
            const variableItems = document.querySelectorAll('#drawer-participating-variables .variable-item-name');
            variableItems.forEach(item => {
                variableNames.push(item.textContent);
            });
            
            // 简单的字符级处理
            let result = '';
            let i = 0;
            
            while (i < content.length) {
                let matched = false;
                
                // 检查是否是变量
                for (let variable of variableNames) {
                    if (content.substring(i, i + variable.length) === variable) {
                        result += `<span class="variable-badge">${variable}</span>`;
                        i += variable.length;
                        matched = true;
                        break;
                    }
                }
                
                if (matched) continue;
                
                // 检查是否是函数名
                const functionMatch = content.substring(i).match(/^(sqrt|abs|max|min|avg|sum|count|if|round|floor|ceil)\s*\(/i);
                if (functionMatch) {
                    result += `<span class="function-name">${functionMatch[1]}</span>(`;
                    i += functionMatch[1].length + 1;
                    continue;
                }
                
                // 检查是否是数字
                const numberMatch = content.substring(i).match(/^(\d+(?:\.\d+)?)/);
                if (numberMatch) {
                    result += `<span class="number">${numberMatch[1]}</span>`;
                    i += numberMatch[1].length;
                    continue;
                }
                
                // 检查运算符
                const operators = {
                    '**': 'operator-power',
                    '*': 'operator-multiply',
                    '/': 'operator-divide',
                    '+': 'operator-plus',
                    '-': 'operator-minus',
                    '=': 'operator-equals',
                    '%': 'operator-percent',
                    '(': 'operator-bracket',
                    ')': 'operator-bracket'
                };
                
                let operatorMatched = false;
                for (let [op, className] of Object.entries(operators)) {
                    if (content.substring(i, i + op.length) === op) {
                        result += `<span class="${className}">${op}</span>`;
                        i += op.length;
                        operatorMatched = true;
                        break;
                    }
                }
                
                if (!operatorMatched) {
                    // 普通文本
                    result += content[i];
                    i++;
                }
            }
            
            // 设置HTML内容
            formulaDisplay.innerHTML = result;
            
            // 恢复光标位置
            restoreCursorPosition(formulaDisplay, cursorOffset);
            
            // 同步到隐藏的textarea
            formulaInput.value = content;
        }



        function restoreCursorPosition(element, offset) {
            const selection = window.getSelection();
            const range = document.createRange();
            
            // 找到对应位置的节点
            let currentOffset = 0;
            const walker = document.createTreeWalker(
                element,
                NodeFilter.SHOW_TEXT,
                null,
                false
            );
            
            let node;
            while (node = walker.nextNode()) {
                if (currentOffset + node.textContent.length >= offset) {
                    range.setStart(node, offset - currentOffset);
                    range.setEnd(node, offset - currentOffset);
                    selection.removeAllRanges();
                    selection.addRange(range);
                    break;
                }
                currentOffset += node.textContent.length;
            }
        }
    </script>

    

    <!-- 属性模态框 -->
    <div id="propertyModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">属性定义</h3>
                <button class="modal-close" onclick="closePropertyModal()">&times;</button>
            </div>
            <div class="modal-form">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label required">属性名称</label>
                        <input type="text" class="form-input required" id="propertyName" placeholder="请输入属性名称">
                    </div>
                    <div class="form-group">
                        <label class="form-label required">属性编码</label>
                        <input type="text" class="form-input required" id="propertyCode" placeholder="请输入属性编码">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label required">数据类型</label>
                        <select class="form-select required" id="dataType">
                            <option value="">请选择数据类型</option>
                            <option value="string">字符串</option>
                            <option value="number">数值</option>
                            <option value="date">日期</option>
                            <option value="datetime">日期时间</option>
                            <option value="boolean">布尔值</option>
                            <option value="enum">枚举</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">所属属性组</label>
                        <select class="form-select" id="propertyGroup" disabled>
                            <option value="">请选择属性组</option>
                            <option value="basic">基本信息</option>
                            <option value="tech">技术参数</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">格式验证</label>
                        <input type="text" class="form-input" id="formatValidation" placeholder="如：正则表达式或验证规则">
                    </div>
                    <div class="form-group">
                        <label class="form-label">显示顺序</label>
                        <input type="number" class="form-input" id="displayOrder" placeholder="数字越小越靠前">
                    </div>
                </div>
                <div class="form-row full-width">
                    <div class="form-group">
                        <label class="form-label">描述</label>
                        <textarea class="form-textarea" id="propertyDescription" placeholder="请输入属性描述"></textarea>
                    </div>
                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">默认值</label>
                                        <input type="text" class="form-input" id="defaultValue" placeholder="请输入默认值">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">取值范围</label>
                                        <input type="text" class="form-input" id="valueRange" placeholder="如：0-100 或 选项1,选项2">
                                    </div>
                                </div>
                <div class="form-row full-width">
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="isRequired">
                            <span class="checkbox-text">是否必填</span>
                        </label>
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn" onclick="closePropertyModal()">取消</button>
                    <button class="btn btn-primary" onclick="saveProperty()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 属性组选择模态框 -->
    <div id="propertyGroupSelectorModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">引用属性组</h3>
                <button class="modal-close" onclick="closePropertyGroupSelectorModal()">&times;</button>
            </div>
            <div class="modal-form">
                <div class="form-group">
                    <label class="form-label">搜索属性组</label>
                    <input type="text" class="form-input" id="propertyGroupSearch" placeholder="请输入属性组名称进行搜索" oninput="searchPropertyGroups()">
                </div>
                <div class="form-group">
                    <label class="form-label">选择要引用的属性组（仅显示静态属性类别）</label>
                    <div class="property-group-selector" id="propertyGroupList">
                        <!-- 属性组列表将通过JavaScript动态生成 -->
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn" onclick="closePropertyGroupSelectorModal()">取消</button>
                    <button class="btn btn-primary" onclick="applyPropertyGroups()">确定引用</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 业务属性组选择模态框 -->
    <div id="businessPropertyGroupSelectorModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">引用业务属性组</h3>
                <button class="modal-close" onclick="closeBusinessPropertyGroupSelectorModal()">&times;</button>
            </div>
            <div class="modal-form">
                <div class="form-group">
                    <label class="form-label">搜索业务属性组</label>
                    <input type="text" class="form-input" id="businessPropertyGroupSearch" placeholder="请输入业务属性组名称进行搜索" oninput="searchBusinessPropertyGroups()">
                </div>
                <div class="form-group">
                    <label class="form-label">选择要引用的业务属性组（仅显示业务属性类别）</label>
                    <div class="property-group-selector" id="businessPropertyGroupList">
                        <!-- 业务属性组列表将通过JavaScript动态生成 -->
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn" onclick="closeBusinessPropertyGroupSelectorModal()">取消</button>
                    <button class="btn btn-primary" onclick="applyBusinessPropertyGroups()">确定引用</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 动态变量模态框 -->
    <div id="variableModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">变量定义</h3>
                <button class="modal-close" onclick="closeVariableModal()">&times;</button>
            </div>
            <div class="modal-form">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label required">变量名称</label>
                        <input type="text" class="form-input required" id="variableName" placeholder="请输入变量名称">
                    </div>
                    <div class="form-group">
                        <label class="form-label required">变量编码</label>
                        <input type="text" class="form-input required" id="variableCode" placeholder="请输入变量编码">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label required">数据类型</label>
                        <select class="form-select required" id="variableDataType">
                            <option value="">请选择数据类型</option>
                            <option value="number">数值</option>
                            <option value="string">字符串</option>
                            <option value="boolean">布尔值</option>
                            <option value="enum">枚举</option>
                            <option value="date">日期</option>
                            <option value="datetime">日期时间</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label required">变量分类</label>
                        <select class="form-select required" id="variableCategory">
                            <option value="">请选择变量分类</option>
                            <option value="realtime">实时数据</option>
                            <option value="cumulative">累计数据</option>
                            <option value="status">状态数据</option>
                            <option value="calculated">计算数据</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">所属变量组</label>
                        <select class="form-select" id="variableGroup" disabled>
                            <option value="">请选择变量组</option>
                            <option value="temp_group">温度监控组</option>
                            <option value="pressure_group">压力监控组</option>
                            <option value="status_group">运行状态组</option>
                            <option value="cumulative_group">累计数据组</option>
                            <option value="efficiency_group">效率计算组</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">单位</label>
                        <input type="text" class="form-input" id="variableUnit" placeholder="如：℃、MPa、小时等">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">精度</label>
                        <input type="number" class="form-input" id="variablePrecision" placeholder="如：0.1、0.01等" step="0.01" min="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">取值范围</label>
                        <input type="text" class="form-input" id="variableRange" placeholder="如：0-100 或 选项1,选项2">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label required">采集频率</label>
                        <select class="form-select required" id="variableFrequency">
                            <option value="">请选择采集频率</option>
                            <option value="1s">1秒</option>
                            <option value="5s">5秒</option>
                            <option value="10s">10秒</option>
                            <option value="30s">30秒</option>
                            <option value="1m">1分钟</option>
                            <option value="5m">5分钟</option>
                            <option value="10m">10分钟</option>
                            <option value="1h">1小时</option>
                            <option value="1d">1天</option>
                        </select>
                    </div>
                </div>
                <div class="form-row full-width">
                    <div class="form-group">
                        <label class="form-label">描述</label>
                        <textarea class="form-textarea" id="variableDescription" placeholder="请输入变量描述"></textarea>
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn" onclick="closeVariableModal()">取消</button>
                    <button class="btn btn-primary" onclick="saveVariable()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 变量组选择模态框 -->
    <div id="variableGroupSelectorModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">引用变量组</h3>
                <button class="modal-close" onclick="closeVariableGroupSelectorModal()">&times;</button>
            </div>
            <div class="modal-form">
                <div class="form-group">
                    <label class="form-label">搜索变量组</label>
                    <input type="text" class="form-input" id="variableGroupSearch" placeholder="请输入变量组名称进行搜索" oninput="searchVariableGroups()">
                </div>
                <div class="form-group">
                    <label class="form-label">选择要引用的变量组（仅显示动态变量类别）</label>
                    <div class="property-group-selector" id="variableGroupList">
                        <!-- 变量组列表将通过JavaScript动态生成 -->
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn" onclick="closeVariableGroupSelectorModal()">取消</button>
                    <button class="btn btn-primary" onclick="applyVariableGroups()">确定引用</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 属性编辑抽屉 -->
    <div class="drawer-backdrop" id="property-drawer">
        <div class="drawer">
            <div class="drawer-header">
                <h3 class="drawer-title" id="property-drawer-title">编辑属性</h3>
                <button class="drawer-close" id="property-drawer-close">&times;</button>
            </div>
            <div class="drawer-body">
                <div class="drawer-form">
                    <div class="drawer-form-row">
                        <div class="drawer-form-group">
                            <label class="drawer-form-label">属性组</label>
                            <select class="drawer-form-select" id="drawer-property-group" disabled>
                                <option value="">请选择变量属性组</option>
                                <option value="basic">基本信息组</option>
                                <option value="tech">技术参数组</option>
                                <option value="business">业务管理组</option>
                            </select>
                        </div>
                        <div class="drawer-form-group">
                            <label class="drawer-form-label required">名称</label>
                            <input type="text" class="drawer-form-input" id="drawer-property-name" placeholder="请输入属性名称">
                        </div>
                    </div>
                    <div class="drawer-form-row">
                        <div class="drawer-form-group">
                            <label class="drawer-form-label required">编码</label>
                            <input type="text" class="drawer-form-input" id="drawer-property-code" placeholder="请输入属性编码">
                            <div class="drawer-form-hint">如果不填写，系统将自动生成</div>
                        </div>
                        <div class="drawer-form-group">
                            <label class="drawer-form-label required">数据类型</label>
                            <select class="drawer-form-select" id="drawer-data-type">
                                <option value="">请选择数据类型</option>
                                <option value="string">字符串</option>
                                <option value="number">数值</option>
                                <option value="date">日期</option>
                                <option value="datetime">日期时间</option>
                                <option value="boolean">布尔值</option>
                                <option value="enum">枚举</option>
                            </select>
                        </div>
                    </div>
                                        <div class="drawer-form-row">
                                            <div class="drawer-form-group">
                                                <label class="drawer-form-label">业务域</label>
                                                <select class="drawer-form-select" id="drawer-business-category">
                                                    <option value="">请选择业务域</option>
                                                    <option value="production">生产</option>
                                                    <option value="quality">质量</option>
                                                    <option value="maintenance">运维</option>
                                                    <option value="logistics">物流</option>
                                                    <option value="cost">成本</option>
                                                </select>
                                            </div>
                                            <div class="drawer-form-group">
                                                <label class="drawer-form-label">显示顺序</label>
                                                <input type="number" class="drawer-form-input" id="drawer-display-order" placeholder="数字越小越靠前">
                                            </div>
                                        </div>
                                        <div class="drawer-form-row">
                                            <div class="drawer-form-group">
                                                <label class="drawer-form-label">描述</label>
                                                <input type="text" class="drawer-form-input" id="drawer-property-description" placeholder="请输入属性描述">
                                            </div>
                                        </div>
                    <div class="drawer-form-row">
                        <div class="drawer-form-group">
                            <label class="drawer-form-label">精度</label>
                            <input type="number" class="drawer-form-input" id="drawer-precision" placeholder="如：0.1、0.01等" step="0.01" min="0">
                        </div>
                        <div class="drawer-form-group">
                            <label class="drawer-form-label">单位</label>
                            <input type="text" class="drawer-form-input" id="drawer-unit" placeholder="如：℃、MPa、小时等">
                        </div>
                    </div>

                    <div class="drawer-form-row">
                        <div class="drawer-form-group">
                            <label class="drawer-form-label">格式验证</label>
                            <input type="text" class="drawer-form-input" id="drawer-format-validation" placeholder="如：正则表达式或验证规则">
                        </div>
                        <div class="drawer-form-group">
                            <label class="drawer-form-label">数据标签</label>
                            <div class="custom-select">
                                <div class="select-trigger" onclick="toggleDataTagDropdown('drawer-category')">
                                    <div class="selected-tags" id="drawer-category-tags">
                                        <span class="placeholder-text">请选择数据标签</span>
                                    </div>
                                    <span class="select-arrow">▼</span>
                                </div>
                                <div class="select-dropdown" id="drawer-category-dropdown">
                                    <div class="select-option">
                                        <input type="checkbox" id="tag-electricity" value="electricity">
                                        <label for="tag-electricity">电耗</label>
                                    </div>
                                    <div class="select-option">
                                        <input type="checkbox" id="tag-coal" value="coal">
                                        <label for="tag-coal">煤耗</label>
                                    </div>
                                    <div class="select-option">
                                        <input type="checkbox" id="tag-energy" value="energy">
                                        <label for="tag-energy">能耗</label>
                                    </div>
                                    <div class="select-option">
                                        <input type="checkbox" id="tag-machine_hours" value="machine_hours">
                                        <label for="tag-machine_hours">台时</label>
                                    </div>
                                    <div class="select-option">
                                        <input type="checkbox" id="tag-ratio" value="ratio">
                                        <label for="tag-ratio">配比</label>
                                    </div>
                                    <div class="select-option">
                                        <input type="checkbox" id="tag-operation_rate" value="operation_rate">
                                        <label for="tag-operation_rate">运转率</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="drawer-form-row">
                        <div class="drawer-form-group">
                            <label class="drawer-form-label">取值范围</label>
                            <input type="text" class="drawer-form-input" id="drawer-value-range" placeholder="如：0-100 或 选项1,选项2">
                        </div>
                        <div class="drawer-form-group">
                            <label class="drawer-form-label">默认值</label>
                            <input type="text" class="drawer-form-input" id="drawer-default-value" placeholder="请输入默认值">
                        </div>
                    </div>
                    <div class="drawer-form-row">
                        <div class="drawer-form-group">
                            <label class="drawer-form-label">是否必填</label>
                            <div class="drawer-checkbox-group">
                                <label class="drawer-checkbox-label">
                                    <input type="checkbox" id="drawer-is-required">
                                    <span class="drawer-checkbox-text">是</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="drawer-footer">
                <button class="btn" onclick="closePropertyDrawer()">取消</button>
                <button class="btn btn-primary" onclick="savePropertyFromDrawer()">保存</button>
            </div>
        </div>
    </div>

    <!-- 业务属性编辑抽屉 -->
    <div class="drawer-backdrop" id="business-property-drawer">
        <div class="drawer">
            <div class="drawer-header">
                <h3 class="drawer-title" id="business-property-drawer-title">编辑业务属性</h3>
                <button class="drawer-close" id="business-property-drawer-close">&times;</button>
            </div>
            <div class="drawer-body">
                <div class="drawer-form">
                    <div class="drawer-form-row">
                        <div class="drawer-form-group">
                            <label class="drawer-form-label">所属变量属性组</label>
                            <select class="drawer-form-select" id="drawer-business-property-group" disabled>
                                <option value="">请选择变量属性组</option>
                                <option value="basic">基本信息组</option>
                                <option value="tech">技术参数组</option>
                                <option value="business">业务管理组</option>
                            </select>
                        </div>
                        <div class="drawer-form-group">
                            <label class="drawer-form-label required">名称</label>
                            <input type="text" class="drawer-form-input" id="drawer-business-property-name" placeholder="请输入业务属性名称">
                        </div>
                    </div>
                    <div class="drawer-form-row">
                        <div class="drawer-form-group">
                            <label class="drawer-form-label required">编码</label>
                            <input type="text" class="drawer-form-input" id="drawer-business-property-code" placeholder="请输入业务属性编码">
                            <div class="drawer-form-hint">如果不填写，系统将自动生成</div>
                        </div>
                        <div class="drawer-form-group">
                            <label class="drawer-form-label required">数据类型</label>
                            <select class="drawer-form-select" id="drawer-business-data-type">
                                <option value="">请选择数据类型</option>
                                <option value="string">字符串</option>
                                <option value="number">数值</option>
                                <option value="date">日期</option>
                                <option value="datetime">日期时间</option>
                                <option value="boolean">布尔值</option>
                                <option value="enum">枚举</option>
                            </select>
                        </div>
                    </div>
                                        <div class="drawer-form-row">
                                            <div class="drawer-form-group">
                                                <label class="drawer-form-label">描述</label>
                                                <input type="text" class="drawer-form-input" id="drawer-business-property-description" placeholder="请输入业务属性描述">
                                            </div>
                                        </div>
                    <div class="drawer-form-row">
                        <div class="drawer-form-group">
                            <label class="drawer-form-label">精度</label>
                            <input type="number" class="drawer-form-input" id="drawer-business-precision" placeholder="如：0.1、0.01等" step="0.01" min="0">
                        </div>
                        <div class="drawer-form-group">
                            <label class="drawer-form-label">单位</label>
                            <input type="text" class="drawer-form-input" id="drawer-business-unit" placeholder="如：℃、MPa、小时等">
                        </div>
                    </div>

                    <div class="drawer-form-row">
                        <div class="drawer-form-group">
                            <label class="drawer-form-label">格式验证</label>
                            <input type="text" class="drawer-form-input" id="drawer-business-format-validation" placeholder="如：正则表达式或验证规则">
                        </div>
                        <div class="drawer-form-group">
                            <label class="drawer-form-label">数据标签</label>
                            <div class="custom-select">
                                <div class="select-trigger" onclick="toggleDataTagDropdown('drawer-business-category')">
                                    <div class="selected-tags" id="drawer-business-category-tags">
                                        <span class="placeholder-text">请选择数据标签</span>
                                    </div>
                                    <span class="select-arrow">▼</span>
                                </div>
                                <div class="select-dropdown" id="drawer-business-category-dropdown">
                                    <div class="select-option">
                                        <input type="checkbox" id="business-tag-current" value="current">
                                        <label for="business-tag-current">电流</label>
                                    </div>
                                    <div class="select-option">
                                        <input type="checkbox" id="business-tag-pressure" value="pressure">
                                        <label for="business-tag-pressure">压力</label>
                                    </div>
                                    <div class="select-option">
                                        <input type="checkbox" id="business-tag-temperature" value="temperature">
                                        <label for="business-tag-temperature">温度</label>
                                    </div>
                                    <div class="select-option">
                                        <input type="checkbox" id="business-tag-vibration" value="vibration">
                                        <label for="business-tag-vibration">振动</label>
                                    </div>
                                    <div class="select-option">
                                        <input type="checkbox" id="business-tag-flow" value="flow">
                                        <label for="business-tag-flow">流量</label>
                                    </div>
                                    <div class="select-option">
                                        <input type="checkbox" id="business-tag-operation" value="operation">
                                        <label for="business-tag-operation">运行</label>
                                    </div>
                                    <div class="select-option">
                                        <input type="checkbox" id="business-tag-output" value="output">
                                        <label for="business-tag-output">产量</label>
                                    </div>
                                    <div class="select-option">
                                        <input type="checkbox" id="business-tag-power" value="power">
                                        <label for="business-tag-power">电量</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="drawer-form-row">
                        <div class="drawer-form-group">
                            <label class="drawer-form-label">业务域</label>
                            <select class="drawer-form-select" id="drawer-business-business-category">
                                <option value="">请选择业务域</option>
                                <option value="production">生产</option>
                                <option value="quality">质量</option>
                                <option value="maintenance">运维</option>
                                <option value="logistics">物流</option>
                                <option value="cost">成本</option>
                            </select>
                        </div>
                        <div class="drawer-form-group">
                            <label class="drawer-form-label">显示顺序</label>
                            <input type="number" class="drawer-form-input" id="drawer-business-display-order" placeholder="数字越小越靠前">
                        </div>
                    </div>
                    <div class="drawer-form-row">
                        <div class="drawer-form-group">
                            <label class="drawer-form-label">取值范围</label>
                            <input type="text" class="drawer-form-input" id="drawer-business-value-range" placeholder="如：0-100 或 选项1,选项2">
                        </div>
                        <div class="drawer-form-group">
                            <label class="drawer-form-label">默认值</label>
                            <input type="text" class="drawer-form-input" id="drawer-business-default-value" placeholder="请输入默认值">
                        </div>
                    </div>
                    <div class="drawer-form-row">
                        <div class="drawer-form-group">
                            <label class="drawer-form-label">采集频率</label>
                            <select class="drawer-form-select" id="drawer-business-collection-frequency">
                                <option value="">请选择采集频率</option>
                                <option value="1s">1秒</option>
                                <option value="5s">5秒</option>
                                <option value="10s">10秒</option>
                                <option value="30s">30秒</option>
                                <option value="1m">1分钟</option>
                                <option value="5m">5分钟</option>
                                <option value="10m">10分钟</option>
                                <option value="1h">1小时</option>
                                <option value="1d">1天</option>
                            </select>
                        </div>
                        <div class="drawer-form-group">
                            <label class="drawer-form-label">是否必填</label>
                            <div class="drawer-checkbox-group">
                                <label class="drawer-checkbox-label">
                                    <input type="checkbox" id="drawer-business-is-required">
                                    <span class="drawer-checkbox-text">是</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="drawer-footer">
                <button class="btn" onclick="closeBusinessPropertyDrawer()">取消</button>
                <button class="btn btn-primary" onclick="saveBusinessPropertyFromDrawer()">保存</button>
            </div>
        </div>
    </div>

    <!-- 指标编辑抽屉 -->
    <div class="drawer-backdrop" id="indicator-drawer">
        <div class="drawer">
            <div class="drawer-header">
                <h3 class="drawer-title" id="indicator-drawer-title">编辑指标</h3>
                <button class="drawer-close" id="indicator-drawer-close">&times;</button>
            </div>
            <div class="drawer-body">
                <div class="drawer-form">
                    <div class="drawer-form-row">
                        <div class="drawer-form-group">
                            <label class="drawer-form-label required">指标名称</label>
                            <input type="text" class="drawer-form-input" id="drawer-indicator-name" placeholder="请输入指标名称">
                        </div>
                        <div class="drawer-form-group">
                            <label class="drawer-form-label required">指标编码</label>
                            <input type="text" class="drawer-form-input" id="drawer-indicator-code" placeholder="请输入指标编码">
                            <div class="drawer-form-hint">如果不填写，系统将自动生成</div>
                        </div>
                    </div>
                    <div class="drawer-form-row">
                        <div class="drawer-form-group">
                            <label class="drawer-form-label required">指标分类</label>
                            <select class="drawer-form-select" id="drawer-indicator-category">
                                <option value="">请选择指标分类</option>
                                <option value="performance">性能指标</option>
                                <option value="economic">经济指标</option>
                                <option value="safety">安全指标</option>
                                <option value="environmental">环保指标</option>
                            </select>
                        </div>
                        <div class="drawer-form-group">
                            <label class="drawer-form-label">指标单位</label>
                            <input type="text" class="drawer-form-input" id="drawer-indicator-unit" placeholder="如：%、元/吨、次/月等">
                        </div>
                    </div>
                    <div class="drawer-form-row">
                        <div class="drawer-form-group">
                            <label class="drawer-form-label required">指标方向</label>
                            <select class="drawer-form-select" id="drawer-indicator-direction">
                                <option value="">请选择指标方向</option>
                                <option value="positive">正向</option>
                                <option value="negative">负向</option>
                            </select>
                        </div>
                        <div class="drawer-form-group">
                            <!-- 占位，保持布局 -->
                        </div>
                    </div>
                    <div class="drawer-form-row">
                        <div class="drawer-form-group">
                            <label class="drawer-form-label required">计算周期</label>
                            <select class="drawer-form-select" id="drawer-calculation-cycle">
                                <option value="">请选择计算周期</option>
                                <option value="minute">分钟</option>
                                <option value="hour">小时</option>
                                <option value="day">天</option>
                                <option value="week">周</option>
                                <option value="month">月</option>
                                <option value="quarter">季度</option>
                                <option value="year">年</option>
                            </select>
                        </div>
                        <div class="drawer-form-group">
                            <label class="drawer-form-label required">更新频率</label>
                            <select class="drawer-form-select" id="drawer-update-frequency">
                                <option value="">请选择更新频率</option>
                                <option value="1min">1分钟</option>
                                <option value="5min">5分钟</option>
                                <option value="10min">10分钟</option>
                                <option value="30min">30分钟</option>
                                <option value="1h">1小时</option>
                                <option value="6h">6小时</option>
                                <option value="1d">1天</option>
                                <option value="1w">1周</option>
                                <option value="1m">1月</option>
                            </select>
                        </div>
                    </div>
                    <div class="drawer-form-row">
                        <div class="drawer-form-group">
                                                         <label class="drawer-form-label">参与变量（提示：拖拽参与变量到公式中任意位置）</label>
                            <div class="variable-selector" id="drawer-participating-variables">
                                <div class="variable-list">
                                    <!-- 变量列表将通过JavaScript动态生成 -->
                                </div>
                                <button type="button" class="btn btn-sm" onclick="showVariableSelector()">添加变量</button>
                            </div>
                        </div>
                        <div class="drawer-form-group">
                            <label class="drawer-form-label">计算公式</label>
                            <div class="formula-input-container">
                                <div class="formula-editor">
                                    <div class="formula-toolbar">
                                        <button type="button" class="formula-btn" onclick="insertOperator('+')" title="加法">+</button>
                                        <button type="button" class="formula-btn" onclick="insertOperator('-')" title="减法">-</button>
                                        <button type="button" class="formula-btn" onclick="insertOperator('*')" title="乘法">×</button>
                                        <button type="button" class="formula-btn" onclick="insertOperator('/')" title="除法">÷</button>
                                        <button type="button" class="formula-btn" onclick="insertOperator('(')" title="左括号">(</button>
                                        <button type="button" class="formula-btn" onclick="insertOperator(')')" title="右括号">)</button>
                                        <button type="button" class="formula-btn" onclick="insertOperator('=')" title="等于">=</button>
                                        <button type="button" class="formula-btn" onclick="insertOperator('%')" title="百分比">%</button>
                                        <button type="button" class="formula-btn" onclick="insertOperator('**')" title="幂运算">^</button>
                                        <button type="button" class="formula-btn" onclick="insertOperator('sqrt(')" title="平方根">√</button>
                                        <button type="button" class="formula-btn" onclick="insertOperator('abs(')" title="绝对值">|x|</button>
                                        <button type="button" class="formula-btn" onclick="insertOperator('max(')" title="最大值">max</button>
                                        <button type="button" class="formula-btn" onclick="insertOperator('min(')" title="最小值">min</button>
                                        <button type="button" class="formula-btn" onclick="insertOperator('avg(')" title="平均值">avg</button>
                                        <button type="button" class="formula-btn" onclick="insertOperator('sum(')" title="求和">sum</button>
                                        <button type="button" class="formula-btn" onclick="insertOperator('count(')" title="计数">count</button>
                                        <button type="button" class="formula-btn" onclick="insertOperator('if(')" title="条件判断">if</button>
                                        <button type="button" class="formula-btn" onclick="insertOperator('round(')" title="四舍五入">round</button>
                                        <button type="button" class="formula-btn" onclick="insertOperator('floor(')" title="向下取整">floor</button>
                                        <button type="button" class="formula-btn" onclick="insertOperator('ceil(')" title="向上取整">ceil</button>
                                    </div>
                                    <div class="formula-input-wrapper">
                                        <div class="formula-display" id="formula-display" contenteditable="true" placeholder="请输入计算公式，如：实际产量/理论产量*100%"></div>
                                        <textarea class="formula-textarea" id="drawer-calculation-formula" style="display: none;"></textarea>
                                        <div class="formula-status" id="formula-status"></div>
                                    </div>
                                </div>
                                <div class="formula-actions">
                                    <button type="button" class="btn btn-sm btn-primary" onclick="validateFormula()">校验</button>
                                    <button type="button" class="btn btn-sm" onclick="formatFormula()">格式化</button>
                                    <button type="button" class="btn btn-sm" onclick="clearFormula()">清空</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="drawer-form-row">
                        <div class="drawer-form-group">
                            <label class="drawer-form-label">描述</label>
                            <input type="text" class="drawer-form-input" id="drawer-indicator-description" placeholder="请输入指标描述">
                        </div>
                    </div>
                </div>
            </div>
            <div class="drawer-footer">
                <button class="btn" onclick="closeIndicatorDrawer()">取消</button>
                <button class="btn btn-primary" onclick="saveIndicatorFromDrawer()">保存</button>
            </div>
        </div>
    </div>

    <!-- 动态变量编辑抽屉 -->
    <div class="drawer-backdrop" id="variable-drawer">
        <div class="drawer">
            <div class="drawer-header">
                <h3 class="drawer-title" id="variable-drawer-title">编辑动态变量</h3>
                <button class="drawer-close" id="variable-drawer-close">&times;</button>
            </div>
            <div class="drawer-body">
                <div class="drawer-form">
                    <div class="drawer-form-row">
                        <div class="drawer-form-group">
                            <label class="drawer-form-label">所属变量属性组</label>
                            <select class="drawer-form-select" id="drawer-variable-group" disabled>
                                <option value="">请选择变量属性组</option>
                                <option value="temp_group">温度监控组</option>
                                <option value="pressure_group">压力监控组</option>
                                <option value="status_group">运行状态组</option>
                                <option value="cumulative_group">累计数据组</option>
                                <option value="efficiency_group">效率计算组</option>
                            </select>
                        </div>
                        <div class="drawer-form-group">
                            <label class="drawer-form-label required">名称</label>
                            <input type="text" class="drawer-form-input" id="drawer-variable-name" placeholder="请输入变量名称">
                        </div>
                    </div>
                    <div class="drawer-form-row">
                        <div class="drawer-form-group">
                            <label class="drawer-form-label required">编码</label>
                            <input type="text" class="drawer-form-input" id="drawer-variable-code" placeholder="请输入变量编码">
                            <div class="drawer-form-hint">如果不填写，系统将自动生成</div>
                        </div>
                        <div class="drawer-form-group">
                            <label class="drawer-form-label required">数据类型</label>
                            <select class="drawer-form-select" id="drawer-variable-data-type">
                                <option value="">请选择数据类型</option>
                                <option value="number">数值</option>
                                <option value="string">字符串</option>
                                <option value="boolean">布尔值</option>
                                <option value="enum">枚举</option>
                                <option value="date">日期</option>
                                <option value="datetime">日期时间</option>
                            </select>
                        </div>
                    </div>
                                        <div class="drawer-form-row">
                                            <div class="drawer-form-group">
                                                <label class="drawer-form-label">描述</label>
                                                <input type="text" class="drawer-form-input" id="drawer-variable-description" placeholder="请输入变量描述">
                                            </div>
                                        </div>
                    <div class="drawer-form-row">
                        <div class="drawer-form-group">
                            <label class="drawer-form-label">精度</label>
                            <input type="number" class="drawer-form-input" id="drawer-variable-precision" placeholder="如：0.1、0.01等" step="0.01" min="0">
                        </div>
                        <div class="drawer-form-group">
                            <label class="drawer-form-label">单位</label>
                            <input type="text" class="drawer-form-input" id="drawer-variable-unit" placeholder="如：℃、MPa、小时等">
                        </div>
                    </div>

                    <div class="drawer-form-row">
                        <div class="drawer-form-group">
                            <label class="drawer-form-label">格式验证</label>
                            <input type="text" class="drawer-form-input" id="drawer-variable-format-validation" placeholder="如：正则表达式或验证规则">
                        </div>
                        <div class="drawer-form-group">
                            <label class="drawer-form-label">数据标签</label>
                            <div class="custom-select">
                                <div class="select-trigger" onclick="toggleDataTagDropdown('drawer-variable-category')">
                                    <div class="selected-tags" id="drawer-variable-category-tags">
                                        <span class="placeholder-text">请选择数据标签</span>
                                    </div>
                                    <span class="select-arrow">▼</span>
                                </div>
                                <div class="select-dropdown" id="drawer-variable-category-dropdown">
                                    <div class="select-option">
                                        <input type="checkbox" id="variable-tag-current" value="current">
                                        <label for="variable-tag-current">电流</label>
                                    </div>
                                    <div class="select-option">
                                        <input type="checkbox" id="variable-tag-pressure" value="pressure">
                                        <label for="variable-tag-pressure">压力</label>
                                    </div>
                                    <div class="select-option">
                                        <input type="checkbox" id="variable-tag-temperature" value="temperature">
                                        <label for="variable-tag-temperature">温度</label>
                                    </div>
                                    <div class="select-option">
                                        <input type="checkbox" id="variable-tag-vibration" value="vibration">
                                        <label for="variable-tag-vibration">振动</label>
                                    </div>
                                    <div class="select-option">
                                        <input type="checkbox" id="variable-tag-flow" value="flow">
                                        <label for="variable-tag-flow">流量</label>
                                    </div>
                                    <div class="select-option">
                                        <input type="checkbox" id="variable-tag-operation" value="operation">
                                        <label for="variable-tag-operation">运行</label>
                                    </div>
                                    <div class="select-option">
                                        <input type="checkbox" id="variable-tag-output" value="output">
                                        <label for="variable-tag-output">产量</label>
                                    </div>
                                    <div class="select-option">
                                        <input type="checkbox" id="variable-tag-power" value="power">
                                        <label for="variable-tag-power">电量</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="drawer-form-row">
                        <div class="drawer-form-group">
                            <label class="drawer-form-label">业务域</label>
                            <select class="drawer-form-select" id="drawer-variable-business-category">
                                <option value="">请选择业务域</option>
                                <option value="production">生产</option>
                                <option value="quality">质量</option>
                                <option value="maintenance">运维</option>
                                <option value="logistics">物流</option>
                                <option value="cost">成本</option>
                            </select>
                        </div>
                        <div class="drawer-form-group">
                            <label class="drawer-form-label">显示顺序</label>
                            <input type="number" class="drawer-form-input" id="drawer-variable-display-order" placeholder="数字越小越靠前">
                        </div>
                    </div>
                    <div class="drawer-form-row">
                        <div class="drawer-form-group">
                            <label class="drawer-form-label">取值范围</label>
                            <input type="text" class="drawer-form-input" id="drawer-variable-range" placeholder="如：0-100 或 选项1,选项2">
                        </div>
                        <div class="drawer-form-group">
                            <label class="drawer-form-label">默认值</label>
                            <input type="text" class="drawer-form-input" id="drawer-variable-default-value" placeholder="请输入默认值">
                        </div>
                    </div>
                    <div class="drawer-form-row">
                        <div class="drawer-form-group">
                            <label class="drawer-form-label">采集频率</label>
                            <select class="drawer-form-select" id="drawer-variable-collection-frequency">
                                <option value="">请选择采集频率</option>
                                <option value="1s">1秒</option>
                                <option value="5s">5秒</option>
                                <option value="10s">10秒</option>
                                <option value="30s">30秒</option>
                                <option value="1m">1分钟</option>
                                <option value="5m">5分钟</option>
                                <option value="10m">10分钟</option>
                                <option value="1h">1小时</option>
                                <option value="1d">1天</option>
                            </select>
                        </div>
                        <div class="drawer-form-group">
                            <label class="drawer-form-label">取值周期</label>
                            <select class="drawer-form-select" id="drawer-variable-value-cycle">
                                <option value="">请选择取值周期</option>
                                <option value="1s">1秒</option>
                                <option value="5s">5秒</option>
                                <option value="10s">10秒</option>
                                <option value="30s">30秒</option>
                                <option value="1m">1分钟</option>
                                <option value="5m">5分钟</option>
                                <option value="10m">10分钟</option>
                                <option value="1h">1小时</option>
                                <option value="1d">1天</option>
                            </select>
                        </div>
                    </div>
                    <div class="drawer-form-row">
                        <div class="drawer-form-group">
                            <label class="drawer-form-label">取值方式</label>
                            <select class="drawer-form-select" id="drawer-variable-value-method">
                                <option value="">请选择取值方式</option>
                                <option value="min">最小值</option>
                                <option value="instant">瞬时值</option>
                                <option value="first">第一个值</option>
                                <option value="delta">差值</option>
                                <option value="average">平均值</option>
                                <option value="last">最后一个值</option>
                                <option value="max">最大值</option>
                                <option value="std">标准方差</option>
                            </select>
                        </div>
                    </div>
                    <div class="drawer-form-row">
                        <div class="drawer-form-group">
                            <label class="drawer-form-label">是否必填</label>
                            <div class="drawer-checkbox-group">
                                <label class="drawer-checkbox-label">
                                    <input type="checkbox" id="drawer-variable-is-required">
                                    <span class="drawer-checkbox-text">是</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="drawer-footer">
                <button class="btn" onclick="closeVariableDrawer()">取消</button>
                <button class="btn btn-primary" onclick="saveVariableFromDrawer()">保存</button>
            </div>
        </div>
    </div>

    <!-- 规则编辑抽屉 -->
    <div class="drawer-backdrop" id="rule-drawer">
        <div class="drawer">
            <div class="drawer-header">
                <h3 class="drawer-title" id="rule-drawer-title">创建规则</h3>
                <button class="drawer-close" onclick="closeRuleDrawer()">&times;</button>
            </div>
            <div class="drawer-body">
                <!-- 步骤指示器 -->
                <div class="rule-steps-container">
                    <div class="rule-step active" data-step="1" onclick="jumpToStep(1)">
                        <div class="step-circle">1</div>
                        <div class="step-text">选择变量</div>
                    </div>
                    <div class="rule-step" data-step="2" onclick="jumpToStep(2)">
                        <div class="step-circle">2</div>
                        <div class="step-text">配置条件</div>
                    </div>
                    <div class="rule-step" data-step="3" onclick="jumpToStep(3)">
                        <div class="step-circle">3</div>
                        <div class="step-text">配置动作</div>
                    </div>
                    <div class="rule-step" data-step="4" onclick="jumpToStep(4)">
                        <div class="step-circle">4</div>
                        <div class="step-text">配置规则名称</div>
                    </div>
                </div>

                <!-- 步骤内容区域 -->
                <div class="rule-content-container">
                    <!-- 步骤1：选择变量 -->
                    <div id="step-1" class="rule-step-content active">
                        <h4>选择变量</h4>
                        <p class="step-description">请选择要监控的变量</p>
                        
                        <!-- 变量选择区域 -->
                        <div class="variable-selection-section">
                            <div class="variable-selector-header">
                                <h5>监控变量</h5>
                                <button class="btn btn-primary" onclick="openRuleVariableSelector()">选择变量</button>
                            </div>
                            
                            <!-- 已选择的变量列表 -->
                            <div class="selected-variables-section">
                                <div class="variable-list" id="rule-selected-variables-list">
                                    <!-- 已选择的变量将在这里显示 -->
                                </div>
                                <div class="no-variables-hint" id="no-variables-hint">
                                    <p>暂未选择变量，请点击"选择变量"按钮添加监控变量</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 步骤2：配置条件 -->
                    <div id="step-2" class="rule-step-content">
                        <h4>配置条件</h4>
                        <p class="step-description">请配置所选变量的监控条件 （***可复用当前已有的规则组件***）</p>
                        
                        <div class="conditions-container">
                            <div class="condition-group">
                                <div class="condition-block">
                                    <div class="condition-content">
                                        <div class="condition-variable-section">
                                            <span class="condition-label">如果</span>
                                            <div class="variable-display">
                                                <div class="variable-name">presiot.am_5c_sim_type/anomaly_output_aspect_Electricity/anomaly_code</div>
                                                <div class="variable-type">Type: INT</div>
                                            </div>
                                            <button class="btn btn-sm btn-outline" onclick="selectVariableForCondition(this)">选择变量</button>
                                        </div>
                                        <div class="condition-operator-section">
                                            <span class="operator-label">是</span>
                                            <div class="operator-field">
                                                <select class="form-select condition-operator-select">
                                                    <option value="on_change" selected>发生变化</option>
                                                    <option value="greater_than">大于</option>
                                                    <option value="less_than">小于</option>
                                                    <option value="equals">等于</option>
                                                    <option value="not_equals">不等于</option>
                                                </select>
                                                <div class="field-hint">选择操作符</div>
                                            </div>
                                        </div>
                                        <div class="condition-actions-inline">
                                            <button class="btn btn-sm btn-danger" onclick="removeCondition(this)">删除</button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="condition-connector">
                                    <span class="connector-text">并且</span>
                                </div>
                                
                                <div class="condition-block">
                                    <div class="condition-content">
                                        <div class="condition-variable-section">
                                            <span class="condition-label">如果</span>
                                            <div class="variable-display">
                                                <div class="variable-name">presiot.am_5c_sim_type/anomaly_output_aspect_Good_Parts/anomaly_code</div>
                                                <div class="variable-type">Type: INT</div>
                                            </div>
                                            <button class="btn btn-sm btn-outline" onclick="selectVariableForCondition(this)">选择变量</button>
                                        </div>
                                        <div class="condition-operator-section">
                                            <span class="operator-label">是</span>
                                            <div class="operator-field">
                                                <select class="form-select condition-operator-select">
                                                    <option value="on_change">发生变化</option>
                                                    <option value="greater_than" selected>大于</option>
                                                    <option value="less_than">小于</option>
                                                    <option value="equals">等于</option>
                                                    <option value="not_equals">不等于</option>
                                                </select>
                                                <div class="field-hint">选择操作符</div>
                                            </div>
                                        </div>
                                        <div class="condition-threshold-section">
                                            <div class="threshold-field">
                                                <input type="number" class="form-input condition-threshold-input" value="100" placeholder="配置阈值">
                                                <div class="field-hint">配置阈值</div>
                                            </div>
                                        </div>
                                        <div class="condition-actions-inline">
                                            <button class="btn btn-sm btn-danger" onclick="removeCondition(this)">删除</button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="condition-actions">
                                    <button class="btn btn-sm" onclick="addCondition()">添加条件</button>
                                    <button class="btn btn-sm" onclick="addNestedCondition()">添加嵌套条件</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- <div class="advanced-options">
                            <div class="option-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="hysteresis">
                                    <span class="checkbox-text">滞后</span>
                                </label>
                            </div>
                            
                            <div class="option-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="debouncing" checked>
                                    <span class="checkbox-text">防抖时间</span>
                                </label>
                                <div class="debouncing-config">
                                    <input type="number" class="form-input" value="1" min="0">
                                    <select class="form-select">
                                        <option value="ms">毫秒</option>
                                        <option value="s">秒</option>
                                        <option value="m">分钟</option>
                                    </select>
                                    <i class="info-icon" title="防抖时间说明">ℹ</i>
                                </div>
                            </div>
                        </div> -->
                    </div>

                    <!-- 步骤3：配置动作 -->
                    <div id="step-3" class="rule-step-content">
                        <h4>配置动作</h4>
                        <p class="step-description">请配置规则触发时要执行的动作</p>
                        
                        <div class="actions-container">
                            <!-- 严重性选择 -->
                            <div class="severity-section">
                                <div class="severity-header">
                                    <label>严重性级别</label>
                                    <span class="severity-description">选择规则的严重性级别，将影响事件和资产状态的显示</span>
                                </div>
                                <div class="severity-selector">
                                    <select class="form-select severity-select" id="severity-select" onchange="updateSeverity()">
                                        <option value="info" data-color="#409eff">信息</option>
                                        <option value="warning" data-color="#e6a23c" selected>警告</option>
                                        <option value="error" data-color="#f56c6c">错误</option>
                                        <option value="critical" data-color="#f56c6c">严重</option>
                                    </select>
                                    <div class="severity-preview">
                                        <span class="severity-badge" id="severity-badge">警告</span>
                                    </div>
                                </div>
                            </div>

                            <!-- 触发事件 -->
                            <div class="action-section">
                                <div class="action-header">
                                    <label class="toggle-label">
                                        <input type="checkbox" id="trigger-event" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="action-title">触发事件</span>
                                </div>
                                <div class="action-content">
                                    <p class="action-description">默认会创建一个事件，需要设置描述</p>
                                    <div class="action-fields">
                                        <div class="form-group">
                                            <label>描述 *</label>
                                            <input type="text" class="form-input" value="监控变量超出阈值范围" placeholder="插入事件描述">
                                        </div>
                                        <div class="form-group">
                                            <label class="checkbox-label">
                                                <input type="checkbox" id="limit-events" checked>
                                                <span class="checkbox-text">限制事件频率</span>
                                            </label>
                                            <div class="limit-config">
                                                <span>不超过</span>
                                                <input type="number" class="form-input" value="1" min="1">
                                                <select class="form-select">
                                                    <option value="minute" selected>分钟</option>
                                                    <option value="hour">小时</option>
                                                    <option value="day">天</option>
                                                </select>
                                                <span>内的事件</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 设置资产状态 -->
                            <div class="action-section">
                                <div class="action-header">
                                    <label class="toggle-label">
                                        <input type="checkbox" id="set-asset-state" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="action-title">设置资产状态</span>
                                    <span class="status-badge" id="asset-status-badge">警告</span>
                                </div>
                                <div class="action-content">
                                    <p class="action-description">如果动作被触发，设置资产健康状态</p>
                                </div>
                            </div>


                        </div>
                    </div>



                    <!-- 步骤4：配置规则名称 -->
                    <div id="step-4" class="rule-step-content">
                        <h4>配置规则名称</h4>
                        <p class="step-description">请配置规则的名称或根据变量和条件生成一个</p>
                        
                        <div class="rule-name-config">
                            <div class="name-input-group">
                                <button class="btn btn-outline" onclick="generateRuleName()">生成</button>
                                <div class="input-wrapper">
                                    <input type="text" class="form-input" id="rule-name-input" value="电机温度转速复合告警" placeholder="添加规则名称">
                                    <div class="input-hint">添加规则名称</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="drawer-footer">
                <button class="btn" onclick="closeRuleDrawer()">取消</button>
                <button class="btn" id="back-btn" onclick="previousStep()" style="display: none;">&lt; 上一步</button>
                <button class="btn btn-primary" id="next-btn" onclick="nextStep()">下一步 &gt;</button>
                <button class="btn btn-success" id="create-btn" onclick="createRule()" style="display: none;">创建</button>
            </div>
        </div>
    </div>

    <!-- 规则定义相关JavaScript功能 -->
    <script>
        // 规则定义列表管理功能
        function toggleSelectAllRules() {
            const selectAllCheckbox = document.getElementById('selectAllRules');
            const ruleCheckboxes = document.querySelectorAll('.rule-checkbox');
            
            ruleCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
        }

        function showRuleTemplateSelector() {
            alert('此功能应打开规则模板选择模态框，允许用户选择预定义的规则模板');
        }

        let currentRuleStep = 1;
        let selectedRuleVariables = [];
        let ruleData = {
            variables: [],
            conditions: [],
            actions: {
                triggerEvent: false,
                setAssetState: true,
                emailNotify: true,
                smsNotify: false
            },
            ruleName: ''
        };

        function openRuleDrawer(action) {
            console.log('openRuleDrawer called with action:', action);
            const backdrop = document.getElementById('rule-drawer');
            
            if (!backdrop) {
                console.error('Rule drawer backdrop not found!');
                return;
            }
            
            if (action === 'add') {
                document.getElementById('rule-drawer-title').textContent = '创建规则';
                resetRuleData();
            } else if (action === 'edit') {
                document.getElementById('rule-drawer-title').textContent = '编辑规则';
                // 这里可以加载现有规则数据
            }
            
            backdrop.classList.add('active');
            currentRuleStep = 1;
            updateStepDisplay();
            console.log('Rule drawer opened successfully');
        }

        function closeRuleDrawer() {
            const backdrop = document.getElementById('rule-drawer');
            const drawer = backdrop.querySelector('.drawer');
            
            // 清理只读模式
            drawer.classList.remove('readonly-mode');
            
            // 清理动态添加的按钮
            const closeBtn = document.querySelector('.drawer-footer .btn-primary:last-child');
            if (closeBtn && closeBtn.textContent === '关闭') {
                closeBtn.remove();
            }
            
            backdrop.classList.remove('active');
        }

        function resetRuleData() {
            currentRuleStep = 1;
            selectedRuleVariables = [];
            ruleData = {
                variables: [],
                conditions: [],
                actions: {
                    triggerEvent: false,
                    setAssetState: true,
                    emailNotify: true,
                    smsNotify: false
                },
                ruleName: ''
            };
            updateStepDisplay();
        }

        function updateStepDisplay() {
            // 更新步骤指示器
            document.querySelectorAll('.rule-step').forEach((step, index) => {
                const stepNum = index + 1;
                step.classList.remove('active', 'completed');
                
                if (stepNum === currentRuleStep) {
                    step.classList.add('active');
                } else if (stepNum < currentRuleStep) {
                    step.classList.add('completed');
                }
            });

            // 更新步骤内容
            document.querySelectorAll('.rule-step-content').forEach((content, index) => {
                const stepNum = index + 1;
                content.classList.remove('active');
                
                if (stepNum === currentRuleStep) {
                    content.classList.add('active');
                }
            });

            // 更新按钮状态
            const backBtn = document.getElementById('back-btn');
            const nextBtn = document.getElementById('next-btn');
            const createBtn = document.getElementById('create-btn');

            backBtn.style.display = currentRuleStep > 1 ? 'inline-block' : 'none';
            nextBtn.style.display = currentRuleStep < 4 ? 'inline-block' : 'none';
            createBtn.style.display = currentRuleStep === 4 ? 'inline-block' : 'none';
        }

        function jumpToStep(stepNumber) {
            if (stepNumber >= 1 && stepNumber <= 4) {
                currentRuleStep = stepNumber;
                updateStepDisplay();
            }
        }

        function nextStep() {
            if (currentRuleStep < 4) {
                currentRuleStep++;
                updateStepDisplay();
            }
        }

        function previousStep() {
            if (currentRuleStep > 1) {
                currentRuleStep--;
                updateStepDisplay();
            }
        }

        function selectVariable(variableId) {
            const variableItem = document.querySelector(`[data-variable="${variableId}"]`);
            const variableName = variableItem.querySelector('.variable-name').textContent;
            const variablePath = variableItem.querySelector('.variable-path').textContent;
            const variableType = variableItem.querySelector('.variable-type').textContent;

            if (!selectedRuleVariables.find(v => v.id === variableId)) {
                selectedRuleVariables.push({
                    id: variableId,
                    name: variableName,
                    path: variablePath,
                    type: variableType
                });
                updateSelectedVariablesList();
            }
        }

        function updateSelectedVariablesList() {
            const container = document.getElementById('selected-variables-list');
            container.innerHTML = '';

            selectedRuleVariables.forEach(variable => {
                const variableElement = document.createElement('div');
                variableElement.className = 'variable-item';
                variableElement.innerHTML = `
                    <div class="variable-info">
                        <div class="variable-name">${variable.name}</div>
                        <div class="variable-path">${variable.path}</div>
                        <div class="variable-type">${variable.type}</div>
                    </div>
                    <div class="variable-actions">
                        <button class="btn btn-sm btn-danger" onclick="removeVariable('${variable.id}')">移除</button>
                    </div>
                `;
                container.appendChild(variableElement);
            });
        }

        function removeVariable(variableId) {
            selectedRuleVariables = selectedRuleVariables.filter(v => v.id !== variableId);
            updateSelectedVariablesList();
        }

        function addCondition() {
            const conditionsContainer = document.querySelector('.conditions-container');
            const newCondition = document.createElement('div');
            newCondition.className = 'condition-block';
            newCondition.innerHTML = `
                <div class="condition-content">
                    <div class="condition-variable-section">
                        <span class="condition-label">如果</span>
                        <div class="variable-display">
                            <div class="variable-name">请选择变量</div>
                            <div class="variable-type">Type: 未知</div>
                        </div>
                        <button class="btn btn-sm btn-outline" onclick="selectVariableForCondition(this)">选择变量</button>
                    </div>
                    <div class="condition-operator-section">
                        <span class="operator-label">是</span>
                        <div class="operator-field">
                            <select class="form-select condition-operator-select">
                                <option value="on_change">发生变化</option>
                                <option value="greater_than">大于</option>
                                <option value="less_than">小于</option>
                                <option value="equals">等于</option>
                                <option value="not_equals">不等于</option>
                            </select>
                            <div class="field-hint">选择操作符</div>
                        </div>
                    </div>
                    <div class="condition-threshold-section">
                        <div class="threshold-field">
                            <input type="number" class="form-input condition-threshold-input" placeholder="配置阈值">
                            <div class="field-hint">配置阈值</div>
                        </div>
                    </div>
                    <div class="condition-actions-inline">
                        <button class="btn btn-sm btn-danger" onclick="removeCondition(this)">删除</button>
                    </div>
                </div>
            `;
            
            const connector = conditionsContainer.querySelector('.condition-connector');
            if (connector) {
                conditionsContainer.insertBefore(newCondition, connector);
            } else {
                conditionsContainer.appendChild(newCondition);
            }
        }

        function addNestedCondition() {
            const conditionsContainer = document.querySelector('.conditions-container');
            const nestedGroup = document.createElement('div');
            nestedGroup.className = 'condition-group nested-condition';
            nestedGroup.innerHTML = `
                <div class="condition-block">
                    <div class="condition-content">
                        <div class="condition-variable-section">
                            <span class="condition-label">如果</span>
                            <div class="variable-display">
                                <div class="variable-name">请选择变量</div>
                                <div class="variable-type">Type: 未知</div>
                            </div>
                            <button class="btn btn-sm btn-outline" onclick="selectVariableForCondition(this)">选择变量</button>
                        </div>
                        <div class="condition-operator-section">
                            <span class="operator-label">是</span>
                            <div class="operator-field">
                                <select class="form-select condition-operator-select">
                                    <option value="on_change">发生变化</option>
                                    <option value="greater_than">大于</option>
                                    <option value="less_than">小于</option>
                                    <option value="equals">等于</option>
                                    <option value="not_equals">不等于</option>
                                </select>
                                <div class="field-hint">选择操作符</div>
                            </div>
                        </div>
                        <div class="condition-threshold-section">
                            <div class="threshold-field">
                                <input type="number" class="form-input condition-threshold-input" placeholder="配置阈值">
                                <div class="field-hint">配置阈值</div>
                            </div>
                        </div>
                        <div class="condition-actions-inline">
                            <button class="btn btn-sm btn-danger" onclick="removeCondition(this)">删除</button>
                        </div>
                    </div>
                </div>
                <div class="condition-connector">
                    <span class="connector-text">并且</span>
                </div>
                <div class="condition-actions">
                    <button class="btn btn-sm" onclick="addCondition()">添加条件</button>
                    <button class="btn btn-sm" onclick="addNestedCondition()">添加嵌套条件</button>
                </div>
            `;
            conditionsContainer.appendChild(nestedGroup);
        }

        function removeCondition(button) {
            const conditionBlock = button.closest('.condition-block');
            conditionBlock.remove();
        }

        function selectVariableForCondition(button) {
            // 设置当前选择变量的上下文为条件变量选择
            window.currentConditionButton = button;
            
            // 打开变量选择器
            const modal = document.getElementById('variable-selector-modal');
            const modalTitle = modal.querySelector('.modal-title');
            modalTitle.textContent = '选择监控变量';
            
            // 设置回调函数
            window.confirmConditionVariableSelection = function() {
                const selectedVariables = Array.from(ruleSelectedVariables);
                if (selectedVariables.length > 0) {
                    const variable = selectedVariables[0]; // 取第一个选中的变量
                    const variableDisplay = button.parentElement.querySelector('.variable-display');
                    const variableName = variableDisplay.querySelector('.variable-name');
                    const variableType = variableDisplay.querySelector('.variable-type');
                    
                    variableName.textContent = variable.name;
                    variableType.textContent = `Type: ${variable.type}`;
                    
                    // 隐藏选择变量按钮
                    button.style.display = 'none';
                }
                
                // 关闭模态框
                const modal = document.getElementById('variable-selector-modal');
                modal.style.display = 'none';
                
                // 清除回调
                delete window.confirmConditionVariableSelection;
            };
            
            modal.style.display = 'block';
        }

        function generateRuleName() {
            // 根据选中的变量和条件生成规则名称
            let ruleName = '';
            
            if (selectedRuleVariables.length > 0) {
                const variableNames = selectedRuleVariables.map(v => v.name).join('、');
                ruleName = `${variableNames}监控规则`;
            } else {
                ruleName = '新规则';
            }
            
            // 更新输入框
            const nameInput = document.getElementById('rule-name-input');
            if (nameInput) {
                nameInput.value = ruleName;
            }
        }

        function updateSeverity() {
            const severitySelect = document.getElementById('severity-select');
            const severityBadge = document.getElementById('severity-badge');
            const assetStatusBadge = document.getElementById('asset-status-badge');
            
            const selectedValue = severitySelect.value;
            const selectedOption = severitySelect.options[severitySelect.selectedIndex];
            const severityText = selectedOption.text;
            
            // 更新严重性预览徽章
            severityBadge.textContent = severityText;
            severityBadge.className = `severity-badge ${selectedValue}`;
            
            // 更新资产状态徽章
            assetStatusBadge.textContent = severityText;
            assetStatusBadge.className = `status-badge status-${selectedValue}`;
        }

        function createRule() {
            const ruleName = document.getElementById('rule-name-input').value;
            if (!ruleName.trim()) {
                alert('请输入规则名称');
                return;
            }
            
            // 这里可以添加规则创建的逻辑
            alert(`规则"${ruleName}"创建成功！`);
            closeRuleDrawer();
        }



        // 规则变量选择器相关函数
        let ruleSelectedVariables = new Set();

        function openRuleVariableSelector() {
            const modal = document.getElementById('variable-selector-modal');
            const title = modal.querySelector('.modal-title');
            title.textContent = '选择监控变量';
            modal.classList.add('active');
            
            // 清空之前的选择
            selectedVariables.clear();
            document.getElementById('variable-search-input').value = '';
            
            // 加载变量数据
            loadVariableData();
            
            // 设置确认按钮的回调
            window.confirmRuleVariableSelection = confirmRuleVariableSelection;
        }

        function confirmRuleVariableSelection() {
            // 获取选中的变量信息
            const selectedVariableNames = [];
            selectedVariables.forEach(id => {
                // 根据ID获取变量名称 - 这里简化处理
                const variableMap = {
                    'device_name': '设备名称',
                    'device_code': '设备编码',
                    'device_type': '设备类型',
                    'manufacturer': '制造商',
                    'install_date': '安装日期',
                    'status': '状态',
                    'abc_category': 'ABC类别',
                    'repair_years': '报修年限',
                    'service_years': '使用年限',
                    'custodian': '保管人',
                    'temperature': '设备温度',
                    'pressure': '设备压力',
                    'speed': '运行速度',
                    'output': '产量',
                    'energy_consumption': '能耗',
                    'fault_count': '故障次数',
                    'device_manager': '设备负责人',
                    'maintenance_cycle': '维护周期',
                    'device_status': '设备状态',
                    'purchase_date': '采购日期',
                    'efficiency_rate': '设备效率',
                    'energy_efficiency': '能效比',
                    'maintenance_score': '维护评分',
                    'reliability_index': '可靠性指数',
                    'availability_rate': '可用率',
                    'quality_score': '质量评分'
                };
                
                if (variableMap[id]) {
                    selectedVariableNames.push({
                        id: id,
                        name: variableMap[id],
                        category: getVariableCategory(id)
                    });
                }
            });

            // 添加到规则变量列表
            const container = document.getElementById('rule-selected-variables-list');
            selectedVariableNames.forEach(variable => {
                // 检查是否已存在
                const existingItems = container.querySelectorAll('.variable-item-name');
                let exists = false;
                existingItems.forEach(item => {
                    if (item.textContent === variable.name) {
                        exists = true;
                    }
                });
                
                if (!exists) {
                    const variableItem = document.createElement('div');
                    variableItem.className = 'variable-item';
                    variableItem.setAttribute('data-variable', variable.id);
                    
                    variableItem.innerHTML = `
                        <div class="variable-item-info">
                            <span class="variable-item-name" data-variable="${variable.name}">${variable.name}</span>
                            <span class="variable-item-category">${variable.category}</span>
                            <span class="variable-item-description">监控变量</span>
                        </div>
                        <span class="variable-item-remove" onclick="removeRuleVariable('${variable.id}')">&times;</span>
                    `;
                    container.appendChild(variableItem);
                    
                    // 添加到规则变量集合
                    ruleSelectedVariables.add(variable.id);
                }
            });

            closeVariableSelector();
        }

        function removeRuleVariable(variableId) {
            const variableItem = document.querySelector(`#rule-selected-variables-list [data-variable="${variableId}"]`);
            if (variableItem) {
                variableItem.remove();
                ruleSelectedVariables.delete(variableId);
            }
        }

        function getVariableCategory(variableId) {
            const staticVars = ['device_name', 'device_code', 'device_type', 'manufacturer', 'install_date', 'status', 'abc_category', 'repair_years', 'service_years', 'custodian'];
            const businessVars = ['device_manager', 'maintenance_cycle', 'device_status', 'purchase_date'];
            const indicatorVars = ['efficiency_rate', 'energy_efficiency', 'maintenance_score', 'reliability_index', 'availability_rate', 'quality_score'];
            
            if (staticVars.includes(variableId)) {
                return '静态属性';
            } else if (businessVars.includes(variableId)) {
                return '业务属性';
            } else if (indicatorVars.includes(variableId)) {
                return '指标';
            } else {
                return '动态变量';
            }
        }

        // 邮件和短信相关功能
        function addEmail() {
            const emailInput = document.getElementById('email-input');
            const email = emailInput.value.trim();
            
            if (email && isValidEmail(email)) {
                const emailList = document.getElementById('email-list');
                const emailTag = document.createElement('div');
                emailTag.className = 'email-tag';
                emailTag.innerHTML = `
                    ${email}
                    <button class="email-remove" onclick="removeEmail(this)">×</button>
                `;
                emailList.appendChild(emailTag);
                emailInput.value = '';
            }
        }

        function removeEmail(button) {
            button.closest('.email-tag').remove();
        }

        function addSms() {
            const smsInput = document.getElementById('sms-input');
            const sms = smsInput.value.trim();
            
            if (sms && isValidPhone(sms)) {
                const smsList = document.getElementById('sms-list');
                const smsTag = document.createElement('div');
                smsTag.className = 'email-tag'; // 复用样式
                smsTag.innerHTML = `
                    ${sms}
                    <button class="email-remove" onclick="removeSms(this)">×</button>
                `;
                smsList.appendChild(smsTag);
                smsInput.value = '';
            }
        }

        function removeSms(button) {
            button.closest('.email-tag').remove();
        }

        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function isValidPhone(phone) {
            const phoneRegex = /^1[3-9]\d{9}$/;
            return phoneRegex.test(phone);
        }

        // 监听邮件和短信输入框的回车事件
        document.addEventListener('DOMContentLoaded', function() {
            const emailInput = document.getElementById('email-input');
            const smsInput = document.getElementById('sms-input');
            
            if (emailInput) {
                emailInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        addEmail();
                    }
                });
            }
            
            if (smsInput) {
                smsInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        addSms();
                    }
                });
            }
        });

        function viewRuleFromDrawer(ruleId) {
            console.log('viewRuleFromDrawer called with ruleId:', ruleId);
            const backdrop = document.getElementById('rule-drawer');
            const drawer = backdrop.querySelector('.drawer');
            
            document.getElementById('rule-drawer-title').textContent = '查看规则';
            
            // 设置为只读模式
            drawer.classList.add('readonly-mode');
            
            // 加载规则数据（这里可以加载实际的规则数据）
            loadRuleData(ruleId);
            
            backdrop.classList.add('active');
            currentRuleStep = 1;
            updateStepDisplay();
            
            // 隐藏操作按钮
            document.getElementById('back-btn').style.display = 'none';
            document.getElementById('next-btn').style.display = 'none';
            document.getElementById('create-btn').style.display = 'none';
            
            // 添加关闭按钮
            const closeBtn = document.createElement('button');
            closeBtn.className = 'btn btn-primary';
            closeBtn.textContent = '关闭';
            closeBtn.onclick = closeRuleDrawer;
            document.querySelector('.drawer-footer').appendChild(closeBtn);
        }

        function loadRuleData(ruleId) {
            // 这里可以加载实际的规则数据
            // 目前使用模拟数据
            const ruleData = {
                1: {
                    name: '电机转速温度复合告警',
                    variables: ['电机温度', '电机转速'],
                    conditions: [
                        { variable: '电机温度', operator: 'greater than', threshold: 80 },
                        { variable: '电机转速', operator: 'greater than', threshold: 910 }
                    ],
                    actions: {
                        triggerEvent: true,
                        setAssetState: true,
                        emailNotify: true,
                        emails: ['operator@factory.com']
                    }
                }
            };
            
            const rule = ruleData[ruleId];
            if (rule) {
                document.getElementById('rule-name-input').value = rule.name;
                // 这里可以设置其他字段的值
            }
        }

        function editRuleFromDrawer(ruleId) {
            console.log('editRuleFromDrawer called with ruleId:', ruleId);
            const backdrop = document.getElementById('rule-drawer');
            
            document.getElementById('rule-drawer-title').textContent = '编辑规则';
            
            // 加载规则数据
            loadRuleData(ruleId);
            
            backdrop.classList.add('active');
            currentRuleStep = 1;
            updateStepDisplay();
        }

        function deleteRule(ruleId) {
            if (confirm('确定要删除这个规则吗？')) {
                alert(`此功能应删除规则ID：${ruleId}`);
            }
        }

        function copyRule(ruleId) {
            if (confirm('确定要复制这个规则吗？')) {
                alert(`此功能应复制规则ID：${ruleId}，并创建新规则`);
            }
        }

        function toggleRuleStatus(ruleId) {
            const row = document.querySelector(`tr:has(input[value="${ruleId}"])`);
            const statusCell = row.querySelector('td:nth-child(6)');
            const statusBadge = statusCell.querySelector('.status-badge');
            const toggleButton = row.querySelector('button[onclick*="toggleRuleStatus"]');
            
            if (statusBadge.textContent === '启用') {
                statusBadge.textContent = '停用';
                statusBadge.className = 'status-badge status-draft';
                toggleButton.textContent = '启用';
                toggleButton.className = 'btn btn-sm btn-success';
                alert(`规则ID：${ruleId} 已停用`);
            } else {
                statusBadge.textContent = '启用';
                statusBadge.className = 'status-badge status-active';
                toggleButton.textContent = '停用';
                toggleButton.className = 'btn btn-sm btn-warning';
                alert(`规则ID：${ruleId} 已启用`);
            }
        }

        // 测试函数
        function testRuleDrawer() {
            console.log('Testing rule drawer...');
            const backdrop = document.getElementById('rule-drawer');
            console.log('Backdrop element:', backdrop);
            if (backdrop) {
                backdrop.classList.add('active');
                console.log('Added active class to backdrop');
            }
        }

        // 规则表格行悬停效果
        document.addEventListener('DOMContentLoaded', function() {
            const ruleRows = document.querySelectorAll('#alarm-rules tbody tr');
            ruleRows.forEach(row => {
                row.addEventListener('mouseenter', function() {
                    if (!this.classList.contains('rule-row-selected')) {
                        this.style.backgroundColor = '#f5f7fa';
                    }
                });
                
                row.addEventListener('mouseleave', function() {
                    if (!this.classList.contains('rule-row-selected')) {
                        this.style.backgroundColor = '';
                    }
                });
            });

            // 规则复选框选中状态处理
            const ruleCheckboxes = document.querySelectorAll('.rule-checkbox');
            ruleCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const row = this.closest('tr');
                    if (this.checked) {
                        row.classList.add('rule-row-selected');
                    } else {
                        row.classList.remove('rule-row-selected');
                    }
                });
            });
        });

        // 解除继承关系弹窗控制
        function showRemoveInheritanceModal() {
            const modal = document.getElementById('remove-inheritance-modal');
            if (modal) {
                modal.classList.add('active');
            } else {
                console.error('Remove inheritance modal not found');
            }
        }

        function removeInheritance() {
            // 解除继承关系的逻辑
            const select = document.querySelector('.parent-type-container select');
            const button = document.getElementById('remove-inheritance-btn');
            const modal = document.getElementById('remove-inheritance-modal');
            
            if (select) {
                // 清空父类型选择
                select.value = '';
                select.disabled = true;
            }
            
            if (button) {
                // 隐藏解除按钮
                button.style.display = 'none';
            }
            
            if (modal) {
                // 关闭弹窗
                modal.classList.remove('active');
            }
            
            // 显示成功提示
            alert('继承关系已成功解除！当前继承的属性将保留，但不再接收父类型的更新。');
        }

        // 解除继承弹窗关闭事件
        document.addEventListener('DOMContentLoaded', function() {
            const modalClose = document.getElementById('remove-inheritance-modal-close');
            const modalCancel = document.getElementById('remove-inheritance-cancel');
            const modalConfirm = document.getElementById('remove-inheritance-confirm');
            const modal = document.getElementById('remove-inheritance-modal');

            if (modalClose) {
                modalClose.addEventListener('click', function() {
                    modal.classList.remove('active');
                });
            }

            if (modalCancel) {
                modalCancel.addEventListener('click', function() {
                    modal.classList.remove('active');
                });
            }

            if (modalConfirm) {
                modalConfirm.addEventListener('click', function() {
                    removeInheritance();
                });
            }

            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.classList.remove('active');
                    }
                });
            }

            // 数据标签多选功能
            // 为所有数据标签复选框添加change事件
            document.querySelectorAll('[id$="-dropdown"] input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const fieldId = this.closest('.select-dropdown').id.replace('-dropdown', '');
                    updateDataTags(fieldId);
                });
            });

            // 点击外部关闭下拉框
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.custom-select')) {
                    document.querySelectorAll('.select-dropdown').forEach(dd => {
                        dd.classList.remove('active');
                        dd.previousElementSibling.classList.remove('active');
                    });
                }
            });
        });

        // 数据标签多选功能
        function toggleDataTagDropdown(fieldId) {
            const dropdown = document.getElementById(fieldId + '-dropdown');
            const trigger = dropdown.previousElementSibling;
            
            // 关闭其他下拉框
            document.querySelectorAll('.select-dropdown').forEach(dd => {
                if (dd !== dropdown) {
                    dd.classList.remove('active');
                    dd.previousElementSibling.classList.remove('active');
                }
            });
            
            // 切换当前下拉框
            dropdown.classList.toggle('active');
            trigger.classList.toggle('active');
        }

        // 更新数据标签显示
        function updateDataTags(fieldId) {
            const tagsContainer = document.getElementById(fieldId + '-tags');
            const checkboxes = document.querySelectorAll(`#${fieldId}-dropdown input[type="checkbox"]:checked`);
            
            if (checkboxes.length === 0) {
                tagsContainer.innerHTML = '<span class="placeholder-text">请选择数据标签</span>';
            } else {
                let tagsHtml = '';
                checkboxes.forEach(checkbox => {
                    const label = checkbox.nextElementSibling.textContent;
                    const value = checkbox.value;
                    tagsHtml += `<span class="tag-item">${label}<span class="tag-remove" onclick="removeDataTag('${fieldId}', '${value}')">×</span></span>`;
                });
                tagsContainer.innerHTML = tagsHtml;
            }
        }

        // 移除数据标签
        function removeDataTag(fieldId, value) {
            const checkbox = document.querySelector(`#${fieldId}-dropdown input[value="${value}"]`);
            if (checkbox) {
                checkbox.checked = false;
                updateDataTags(fieldId);
            }
        }

        // 获取选中的数据标签值
        function getSelectedDataTags(fieldId) {
            const checkboxes = document.querySelectorAll(`#${fieldId}-dropdown input[type="checkbox"]:checked`);
            return Array.from(checkboxes).map(cb => cb.value);
        }

        // 设置数据标签值
        function setDataTags(fieldId, values) {
            // 先清空所有选择
            const checkboxes = document.querySelectorAll(`#${fieldId}-dropdown input[type="checkbox"]`);
            checkboxes.forEach(cb => cb.checked = false);
            
            // 设置选中的值
            if (values && values.length > 0) {
                values.forEach(value => {
                    const checkbox = document.querySelector(`#${fieldId}-dropdown input[value="${value}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });
            }
            
            updateDataTags(fieldId);
        }

        // 返回资产类型列表
        function goBackToList() {
            // 检查是否有未保存的更改
            if (hasUnsavedChanges()) {
                if (confirm('您有未保存的更改，确定要离开吗？')) {
                    window.location.href = 'asset-type-list.html';
                }
            } else {
                window.location.href = 'asset-type-list.html';
            }
        }

        // 检查是否有未保存的更改
        function hasUnsavedChanges() {
            // 这里可以添加检查逻辑，比如检查表单是否有修改
            // 暂时返回false，表示没有未保存的更改
            return false;
        }
    </script>

    <!-- 解除继承关系确认弹窗 -->
    <div class="modal-backdrop" id="remove-inheritance-modal">
        <div class="modal" style="width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">解除继承关系</h3>
                <button class="modal-close" id="remove-inheritance-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="warning-message">
                    <div class="warning-icon">⚠️</div>
                    <div class="warning-content">
                        <h4>确认解除继承关系？</h4>
                        <p>解除继承关系后：</p>
                        <ul>
                            <li>当前继承自父类型的所有属性、规则等信息都将保留</li>
                            <li>父类型后续的变更将不再同步更新到此类型</li>
                            <li>此操作不可撤销，请谨慎操作</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" id="remove-inheritance-cancel">取消</button>
                <button class="btn btn-danger" id="remove-inheritance-confirm">确认解除</button>
            </div>
        </div>
    </div>
</body>
</html>
