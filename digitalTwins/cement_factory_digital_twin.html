<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ê∞¥Ê≥•Â∑•ÂéÇÊï∞Â≠óÂ≠™ÁîüÁ≥ªÁªü</title>
    <script src="https://unpkg.com/three@0.128.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <!--
    <script src="https://cdn.bootcdn.net/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/three.js/r128/controls/OrbitControls.js"></script>
    -->
    
    <!-- Â§áÁî®CDNÈìæÊé•ÔºåÂ¶ÇÊûú‰∏äÈù¢ÁöÑÂ§±Ë¥•ÂèØ‰ª•Â∞ùËØï‰∏ãÈù¢ÁöÑ -->
    <!--
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    
    ÊàñËÄÖ‰ΩøÁî®UNPKG:
    <script src="https://unpkg.com/three@0.128.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: #1a1a1a;
            color: #fff;
            overflow: hidden;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .content-wrapper {
            display: flex;
            flex: 1;
        }

        /* Â∑¶‰æßÊåáÊ†áÈù¢Êùø */
        .sidebar {
            width: 300px;
            background: #2d2d2d;
            border-right: 1px solid #444;
            overflow-y: auto;
            position: relative;
            z-index: 1001;
            padding: 20px;
        }

        .sidebar-header {
            padding: 0 0 20px 0;
            background: transparent;
            border-bottom: 1px solid #444;
            display: none;
        }

        /* Ê†ëÂΩ¢‰∏ãÊãâÊ°ÜÊ†∑Âºè */
        .tree-dropdown {
            position: relative;
            display: inline-block;
        }

        .tree-dropdown-button {
            padding: 8px 16px;
            background: #404040;
            border: 1px solid #666;
            color: #fff;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 200px;
            justify-content: space-between;
        }

        .tree-dropdown-button:hover {
            background: #505050;
        }

        .tree-dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: #2d2d2d;
            border: 1px solid #666;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            min-width: 280px;
            max-height: 400px;
            overflow-y: auto;
        }

        .tree-dropdown-content.show {
            display: block;
        }

        .tree-container {
            padding: 10px;
        }

        .tree-node {
            margin: 5px 0;
            cursor: pointer;
            user-select: none;
        }

        .tree-node-content {
            padding: 8px 12px;
            border-radius: 4px;
            transition: background 0.3s;
            position: relative;
        }

        .tree-node-content:hover {
            background: #404040;
        }

        .tree-node-content.active {
            background: #0078d4;
        }

        .tree-node-content.alarm-low {
            animation: blinkYellow 1s infinite;
        }

        .tree-node-content.alarm-medium {
            animation: blinkOrange 1s infinite;
        }

        .tree-node-content.alarm-high {
            animation: blinkRed 1s infinite;
        }

        .tree-node-icon {
            display: inline-block;
            width: 16px;
            margin-right: 8px;
        }

        /* Â±ïÂºÄ/ÊäòÂè†ÂõæÊ†á */
        .tree-expand-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            margin-right: 4px;
            cursor: pointer;
            text-align: center;
            font-size: 12px;
            line-height: 16px;
            color: #999;
            transition: transform 0.2s, color 0.2s;
            user-select: none;
        }

        .tree-expand-icon:hover {
            color: #0078d4;
        }

        .tree-expand-icon.expanded {
            transform: rotate(90deg);
        }

        .tree-node-label {
            cursor: pointer;
            flex: 1;
        }

        .tree-node-content {
            display: flex;
            align-items: center;
        }

        .tree-children {
            margin-left: 20px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .tree-children.expanded {
            max-height: 1000px;
        }

        /* ‰∏ªÊòæÁ§∫Âå∫Âüü */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* È°∂ÈÉ®Â∑•ÂÖ∑Ê†è */
        .toolbar {
            height: 60px;
            background: #333;
            border-bottom: 1px solid #444;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            gap: 20px;
            width: 100%;
            box-sizing: border-box;
        }

        .toolbar-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toolbar-center {
            display: flex;
            align-items: center;
            gap: 20px;
            flex: 1;
            justify-content: center;
        }

        .toolbar-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mode-selector, .view-selector {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            padding: 8px 16px;
            background: #404040;
            border: 1px solid #666;
            color: #fff;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #505050;
        }

        .btn.active {
            background: #0078d4;
        }

        /* 3D/2DÊòæÁ§∫Âå∫Âüü */
        .display-area {
            flex: 1;
            position: relative;
            background: #1a1a1a;
            min-height: 0;
        }

        #canvas-container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        #three-canvas {
            position: absolute;
            top: 0;
            left: 0;
        }

        #svg-canvas {
            position: absolute;
            top: 0;
            left: 0;
            display: none;
        }

        /* ‰ø°ÊÅØÊÇ¨ÊµÆÊ°Ü */
        .info-tooltip {
            position: fixed;
            background: rgba(45, 45, 45, 0.98);
            color: white;
            padding: 0;
            border-radius: 8px;
            font-size: 12px;
            pointer-events: none;
            z-index: 10001;
            border: 1px solid #666;
            max-width: 280px;
            min-width: 200px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px);
            display: none;
        }

        .tooltip-header {
            background: #0078d4;
            color: white;
            padding: 8px 12px;
            border-radius: 8px 8px 0 0;
            font-weight: bold;
            font-size: 13px;
        }

        .tooltip-section {
            padding: 8px 12px;
            border-bottom: 1px solid #555;
        }

        .tooltip-section:last-child {
            border-bottom: none;
        }

        .tooltip-label {
            font-weight: bold;
            color: #ccc;
            margin-bottom: 4px;
            font-size: 11px;
            text-transform: uppercase;
        }

        .tooltip-metric {
            margin: 2px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tooltip-metric .metric-value {
            color: #0078d4;
            font-weight: bold;
        }

        .tooltip-status {
            padding: 6px 12px;
            font-weight: bold;
            text-align: center;
            border-radius: 0 0 8px 8px;
        }

        .tooltip-status.Ê≠£Â∏∏ {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }

        .tooltip-status.ÂëäË≠¶ {
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
        }

        .tooltip-note {
            padding: 6px 12px;
            background: rgba(0, 120, 212, 0.1);
            color: #87ceeb;
            font-size: 11px;
            border-radius: 0 0 8px 8px;
        }

        .tooltip-trend {
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0 0 8px 8px;
        }

        .trend-indicators {
            display: flex;
            gap: 8px;
            margin-top: 4px;
        }

        .trend-up {
            color: #ff6b6b;
        }

        .trend-stable {
            color: #ffd93d;
        }

        .trend-down {
            color: #6bcf7f;
        }

        .prediction-indicator {
            font-size: 10px;
            margin-left: 4px;
        }

        /* Âè≥‰æßÊåáÊ†áÈù¢Êùø */
        .right-metrics-panel {
            width: 300px;
            background: #2d2d2d;
            border-left: 1px solid #444;
            padding: 20px;
            overflow-y: auto;
            position: relative;
            z-index: 1001;
        }

        .right-metrics-panel.hidden {
            display: none;
        }

        /* ÊåáÊ†áÈ°πÊ†∑Âºè */
        .metric-item {
            margin-bottom: 15px;
            padding: 10px;
            background: #3d3d3d;
            border-radius: 4px;
        }

        .metric-label {
            font-size: 12px;
            color: #ccc;
            margin-bottom: 5px;
        }

        .metric-value {
            font-size: 18px;
            font-weight: bold;
            color: #0078d4;
        }

        /* ÂºÇÂ∏∏ÊåáÊ†áÊ†∑Âºè */
        .metric-value.abnormal {
            color: #ff4444 !important;
            animation: metricBlink 1.5s infinite;
        }

        @keyframes metricBlink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.6; }
        }

        .metric-unit {
            font-size: 12px;
            color: #999;
            margin-left: 5px;
        }

        /* ÁºñËæëÊ®°ÂºèÈù¢Êùø */
        .edit-panel {
            position: fixed;
            top: 60px;
            right: 0;
            width: 350px;
            height: calc(100vh - 60px);
            background: #2d2d2d;
            border-left: 1px solid #444;
            padding: 20px;
            overflow-y: auto;
            transform: translateX(100%);
            transition: transform 0.3s;
            z-index: 1001;
        }

        .edit-panel.visible {
            transform: translateX(0);
        }

        /* Ê®°ÂºèÊéßÂà∂Èù¢Êùø */
        .mode-control-panel {
            position: fixed;
            top: 60px;
            left: 300px;
            width: 350px;
            height: calc(100vh - 60px);
            background: #2d2d2d;
            border-right: 1px solid #444;
            padding: 20px;
            overflow-y: auto;
            transform: translateX(-100%);
            transition: transform 0.3s;
            z-index: 999;
            display: none;
        }

        .mode-control-panel.visible {
            transform: translateX(0);
            display: block;
        }

        .time-selector {
            margin-bottom: 20px;
        }

        .time-selector label {
            display: block;
            margin-bottom: 5px;
            color: #ccc;
        }

        .time-selector input, .time-selector select {
            width: 100%;
            padding: 8px;
            background: #404040;
            border: 1px solid #666;
            color: #fff;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .simulation-controls {
            margin-top: 20px;
        }

        .parameter-control {
            margin-bottom: 15px;
        }

        .parameter-control label {
            display: block;
            margin-bottom: 5px;
            color: #ccc;
            font-size: 12px;
        }

        .parameter-slider {
            width: 100%;
            margin-bottom: 5px;
        }

        .parameter-value {
            color: #0078d4;
            font-weight: bold;
        }

        .prediction-info {
            background: #1a4d3a;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            border-left: 4px solid #00ff88;
        }

        .history-info {
            background: #3d2a1a;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            border-left: 4px solid #ff8800;
        }

        .checkbox-group {
            margin-bottom: 20px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .checkbox-item input {
            margin-right: 10px;
        }

        /* ÂëäË≠¶Âä®Áîª */
        @keyframes blinkYellow {
            0%, 50% { background-color: rgba(255, 255, 0, 0.3); }
            51%, 100% { background-color: transparent; }
        }

        @keyframes blinkOrange {
            0%, 50% { background-color: rgba(255, 165, 0, 0.3); }
            51%, 100% { background-color: transparent; }
        }

        @keyframes blinkRed {
            0%, 50% { background-color: rgba(255, 0, 0, 0.3); }
            51%, 100% { background-color: transparent; }
        }

        /* Èù¢ÂåÖÂ±ëÂØºËà™ */
        .breadcrumb {
            padding: 0px 20px;
            background: #3d3d3d;
            border-bottom: 1px solid #444;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .breadcrumb-content {
            display: flex;
            align-items: center;
        }

        .breadcrumb-item {
            color: #0078d4;
            cursor: pointer;
        }

        .breadcrumb-item:hover {
            text-decoration: underline;
        }

        .breadcrumb-separator {
            margin: 0 8px;
            color: #666;
        }

        /* ÊéßÂà∂ÊåâÈíÆÁªÑ */
        .control-buttons {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-left: 10px;
        }

        /* ÊâÅÂπ≥ÂåñÂõæÊ†áÊåâÈíÆ */
        .icon-button {
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 18px;
            padding: 8px;
            border-radius: 4px;
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 36px;
            min-height: 36px;
        }

        /* ÈáçÁΩÆÊåâÈíÆÁâπÊÆäÊ†∑Âºè */
        #reset-view-btn {
            transition: all 0.3s ease, transform 0.5s ease;
        }

        .icon-button:hover {
            background: #404040;
            color: #0078d4;
            transform: translateY(-1px);
        }

        .icon-button.active {
            color: #ff6600;
            background: rgba(255, 102, 0, 0.1);
        }

        /* ÂÖ®Â±ÄÂ∑•ÂÖ∑ÊèêÁ§∫ */
        .global-tooltip {
            position: fixed;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            z-index: 10000;
            pointer-events: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transform: translateX(-50%);
        }

        .global-tooltip.show {
            opacity: 1;
            visibility: visible;
        }

        /* ‰ºòÂåñÂõæÊ†áÊòæÁ§∫ */
        #reset-view-btn {
            font-weight: bold;
        }

        #expand-toggle {
            font-size: 16px;
        }

        #edit-toggle {
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #edit-toggle.active {
            background: rgba(255, 102, 0, 0.2);
        }

        /* ÊâÅÂπ≥ÂåñÁºñËæëÂõæÊ†á - ÈΩøËΩÆÁä∂ */
        .flat-edit-icon {
            width: 16px;
            height: 16px;
            position: relative;
            transform: rotate(0deg);
            transition: transform 0.3s ease;
        }

        .edit-icon-inner {
            width: 16px;
            height: 16px;
            position: relative;
            box-sizing: border-box;
        }

        .edit-icon-inner::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 8px;
            height: 8px;
            background: #888;
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }

        /* ÈΩøËΩÆÁöÑ8‰∏™ÈΩø */
        .edit-icon-inner::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 14px;
            height: 14px;
            background: 
                conic-gradient(from 0deg, 
                    transparent 0deg, #888 22.5deg, transparent 45deg,
                    transparent 45deg, #888 67.5deg, transparent 90deg,
                    transparent 90deg, #888 112.5deg, transparent 135deg,
                    transparent 135deg, #888 157.5deg, transparent 180deg,
                    transparent 180deg, #888 202.5deg, transparent 225deg,
                    transparent 225deg, #888 247.5deg, transparent 270deg,
                    transparent 270deg, #888 292.5deg, transparent 315deg,
                    transparent 315deg, #888 337.5deg, transparent 360deg
                );
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }

        #edit-toggle:hover .flat-edit-icon {
            transform: rotate(90deg);
        }

        #edit-toggle.active .flat-edit-icon {
            transform: rotate(180deg);
        }

        #edit-toggle:hover .edit-icon-inner::before,
        #edit-toggle:hover .edit-icon-inner::after {
            background: #0078d4;
        }

        #edit-toggle:hover .edit-icon-inner::after {
            background: 
                conic-gradient(from 0deg, 
                    transparent 0deg, #0078d4 22.5deg, transparent 45deg,
                    transparent 45deg, #0078d4 67.5deg, transparent 90deg,
                    transparent 90deg, #0078d4 112.5deg, transparent 135deg,
                    transparent 135deg, #0078d4 157.5deg, transparent 180deg,
                    transparent 180deg, #0078d4 202.5deg, transparent 225deg,
                    transparent 225deg, #0078d4 247.5deg, transparent 270deg,
                    transparent 270deg, #0078d4 292.5deg, transparent 315deg,
                    transparent 315deg, #0078d4 337.5deg, transparent 360deg
                );
        }

        #edit-toggle.active .edit-icon-inner::before,
        #edit-toggle.active .edit-icon-inner::after {
            background: #ff6600;
        }

        #edit-toggle.active .edit-icon-inner::after {
            background: 
                conic-gradient(from 0deg, 
                    transparent 0deg, #ff6600 22.5deg, transparent 45deg,
                    transparent 45deg, #ff6600 67.5deg, transparent 90deg,
                    transparent 90deg, #ff6600 112.5deg, transparent 135deg,
                    transparent 135deg, #ff6600 157.5deg, transparent 180deg,
                    transparent 180deg, #ff6600 202.5deg, transparent 225deg,
                    transparent 225deg, #ff6600 247.5deg, transparent 270deg,
                    transparent 270deg, #ff6600 292.5deg, transparent 315deg,
                    transparent 315deg, #ff6600 337.5deg, transparent 360deg
                );
        }

        /* ÂëäË≠¶ÊåâÈíÆÊ†∑Âºè */
        #alarm-toggle {
            position: relative;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #alarm-toggle:hover .flat-alarm-icon {
            border-bottom-color: #ff8833;
        }

        #alarm-toggle:hover .flat-alarm-icon::after {
            color: #fff;
        }

        /* ÊâÅÂπ≥ÂåñÂëäË≠¶ÂõæÊ†á */
        .flat-alarm-icon {
            width: 0;
            height: 0;
            border-left: 9px solid transparent;
            border-right: 9px solid transparent;
            border-bottom: 16px solid #ff6600;
            position: relative;
            animation: pulse 2s infinite;
            transition: all 0.3s ease;
        }

        .flat-alarm-icon::after {
            content: '!';
            position: absolute;
            top: 4px;
            left: -3.5px;
            color: #fff;
            font-size: 11px;
            font-weight: bold;
            text-align: center;
            width: 7px;
        }

        .alarm-count {
            position: absolute;
            top: -6px;
            right: -6px;
            background: #ff4444;
            color: white;
            border-radius: 10px;
            width: 18px;
            height: 18px;
            font-size: 10px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 18px;
            border: 2px solid #333;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            z-index: 1;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* ÂëäË≠¶ÂºπÊ°Ü */
        .alarm-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10001;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(2px);
        }

        .alarm-modal.show {
            display: flex;
        }

        .alarm-content {
            background: #2d2d2d;
            border-radius: 8px;
            width: 500px;
            max-height: 600px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .alarm-header {
            background: #333;
            padding: 15px 20px;
            border-bottom: 1px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .alarm-header h3 {
            color: #fff;
            margin: 0;
            font-size: 16px;
        }

        .alarm-close {
            background: none;
            border: none;
            color: #888;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 3px;
            transition: all 0.3s;
        }

        .alarm-close:hover {
            background: #404040;
            color: #fff;
        }

        .alarm-stats {
            padding: 15px 20px;
            background: #353535;
            display: flex;
            gap: 15px;
        }

        .alarm-stat {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .alarm-stat:hover {
            background: #404040;
            transform: translateY(-1px);
        }

        .alarm-stat.active {
            background: #505050;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .alarm-stat-icon {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .alarm-stat-high .alarm-stat-icon {
            background: #ff4444;
        }

        .alarm-stat-medium .alarm-stat-icon {
            background: #ff8800;
        }

        .alarm-stat-low .alarm-stat-icon {
            background: #ffdd00;
        }

        .alarm-stat-text {
            color: #ccc;
            margin-right: 8px;
        }

        .alarm-stat-badge {
            background: #666;
            color: white;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 12px;
            font-weight: bold;
            min-width: 20px;
            text-align: center;
        }

        .alarm-stat-high .alarm-stat-badge {
            background: #ff4444;
        }

        .alarm-stat-medium .alarm-stat-badge {
            background: #ff8800;
        }

        .alarm-stat-low .alarm-stat-badge {
            background: #ffdd00;
            color: #333;
        }

        .alarm-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .alarm-item {
            padding: 15px 20px;
            border-bottom: 1px solid #444;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .alarm-item:hover {
            background: #353535;
        }

        .alarm-item:last-child {
            border-bottom: none;
        }

        .alarm-item-level {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .alarm-item-level.high {
            background: #ff4444;
        }

        .alarm-item-level.medium {
            background: #ff8800;
        }

        .alarm-item-level.low {
            background: #ffdd00;
        }

        .alarm-item-content {
            flex: 1;
            cursor: pointer;
        }

        .alarm-item-title {
            color: #fff;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 2px;
        }

        .alarm-item-desc {
            color: #ccc;
            font-size: 12px;
        }

        .alarm-item-time {
            color: #888;
            font-size: 11px;
            flex-shrink: 0;
            margin-right: 12px;
        }

        /* ÂëäË≠¶Êìç‰ΩúÊåâÈíÆ */
        .alarm-actions {
            display: flex;
            gap: 6px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .alarm-item:hover .alarm-actions {
            opacity: 1;
        }

        .alarm-action-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            font-weight: 500;
        }

        .alarm-action-handle {
            background: #28a745;
        }

        .alarm-action-handle:hover {
            background: #218838;
        }

        .alarm-action-forward {
            background: #007bff;
        }

        .alarm-action-forward:hover {
            background: #0056b3;
        }

        .alarm-action-ignore {
            background: #6c757d;
        }

        .alarm-action-ignore:hover {
            background: #545b62;
        }

        /* ËøáÊª§ÊèêÁ§∫ */
        .alarm-filter-tip {
            padding: 8px 20px;
            background: #404040;
            color: #ccc;
            font-size: 12px;
            border-bottom: 1px solid #444;
            display: none;
        }

        .alarm-filter-tip.show {
            display: block;
        }

        .alarm-filter-clear {
            color: #0078d4;
            cursor: pointer;
            text-decoration: underline;
            margin-left: 8px;
        }

        .alarm-filter-clear:hover {
            color: #40a0e6;
        }

        /* ÂèØÁÇπÂáªÂÖÉÁ¥†Ê†∑Âºè */
        .equipment, .component, .workshop-area {
            cursor: pointer;
            transition: opacity 0.3s, transform 0.2s;
        }

        .equipment:hover, .component:hover, .workshop-area:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }

        .back-button {
            cursor: pointer;
            transition: transform 0.2s;
        }

        .back-button:hover {
            transform: scale(1.1);
        }

        /* 3DÂú∫ÊôØ‰∏≠ÂèØÁÇπÂáªÊèêÁ§∫ */
        #canvas-container {
            cursor: pointer;
        }

        /* ‰∏ãÈíªÂ±ÇÁ∫ßÊåáÁ§∫ */
        .drill-level-indicator {
            position: absolute;
            top: 10px;
            right: 20px;
            background: rgba(0, 120, 212, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            z-index: 1000;
            display: none;
        }

        /* ÁªÑÊÄÅËßÜÂõæÊ†∑Âºè */
        #scada-canvas {
            width: 100%;
            height: 100%;
            background: #1a1a1a;
            position: relative;
        }

        .scada-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .scada-header {
            height: 50px;
            background: #2d2d2d;
            border-bottom: 1px solid #444;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            flex-shrink: 0;
        }

        .scada-title {
            color: #fff;
            font-size: 16px;
            font-weight: bold;
        }

        .scada-toolbar {
            display: flex;
            gap: 10px;
        }

        .scada-btn {
            background: #404040;
            border: 1px solid #666;
            color: #fff;
            border-radius: 4px;
            padding: 6px 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .scada-btn:hover {
            background: #505050;
            border-color: #0078d4;
        }

        .scada-btn.active {
            background: #0078d4;
            border-color: #0078d4;
        }

        .scada-workspace {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: 
                radial-gradient(circle at 1px 1px, rgba(255,255,255,0.1) 1px, transparent 0);
            background-size: 20px 20px;
        }

        .scada-grid {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.3;
            background-image: 
                linear-gradient(rgba(255,255,255,0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            pointer-events: none;
        }

        .scada-component {
            position: absolute;
            background: rgba(45, 45, 45, 0.95);
            border: 2px solid #666;
            border-radius: 6px;
            min-width: 120px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px);
            cursor: move;
            user-select: none;
            transition: all 0.3s ease;
        }

        .scada-component:hover {
            border-color: #0078d4;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
        }

        .scada-component.selected {
            border-color: #ff6600;
            box-shadow: 0 0 0 2px rgba(255, 102, 0, 0.3);
        }

        .component-header {
            background: #0078d4;
            color: white;
            padding: 6px 10px;
            font-size: 12px;
            font-weight: bold;
            border-radius: 4px 4px 0 0;
            text-align: center;
        }

        .equipment-monitor .component-header {
            background: #0078d4;
        }

        .dashboard-panel .component-header {
            background: #ff6600;
        }

        .component-body {
            padding: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin: 0 auto 8px;
            background: #00ff88;
            animation: statusPulse 2s infinite;
        }

        .status-indicator.alarm {
            background: #ff4444;
            animation: statusBlink 1s infinite;
        }

        .status-indicator.warning {
            background: #ffaa00;
        }

        @keyframes statusPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.1); }
        }

        @keyframes statusBlink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        .param-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
            font-size: 11px;
        }

        .param-label {
            color: #ccc;
        }

        .param-value {
            color: #0078d4;
            font-weight: bold;
        }

        .param-value.abnormal {
            color: #ff4444;
            animation: valueAlert 1.5s infinite;
        }

        @keyframes valueAlert {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.6; }
        }

        .dashboard-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            padding: 4px 0;
            border-bottom: 1px solid #444;
            font-size: 12px;
        }

        .dashboard-metric:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .dashboard-metric .metric-label {
            color: #ccc;
        }

        .dashboard-metric .metric-value {
            color: #00ff88;
            font-weight: bold;
        }

        .dashboard-metric .metric-value.alarm-count {
            color: #ff4444;
        }

        .scada-connections {
            z-index: 1;
        }

        /* ÁªÑÊÄÅÁºñËæëÊ®°ÂºèÊ†∑Âºè */
        .scada-edit-mode .scada-component {
            border-style: dashed;
        }

        .scada-edit-mode .scada-component::after {
            content: '';
            position: absolute;
            top: -4px;
            right: -4px;
            width: 8px;
            height: 8px;
            background: #0078d4;
            border-radius: 50%;
            cursor: se-resize;
        }

        /* ÁªÑÊÄÅÂÖÉÁ¥†ÊãñÊãΩÊïàÊûú */
        .scada-component.dragging {
            opacity: 0.7;
            transform: rotate(2deg);
            z-index: 1000;
        }

        /* ÁªÑÊÄÅÂ∑•ÂÖ∑Èù¢Êùø */
        .scada-toolbox {
            position: absolute;
            top: 60px;
            right: 10px;
            width: 200px;
            background: rgba(45, 45, 45, 0.95);
            border: 1px solid #666;
            border-radius: 6px;
            padding: 10px;
            display: none;
        }

        .scada-toolbox.show {
            display: block;
        }

        .toolbox-item {
            padding: 8px;
            margin-bottom: 5px;
            background: #404040;
            border: 1px solid #666;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            text-align: center;
            transition: all 0.3s;
        }

        .toolbox-item:hover {
            background: #505050;
            border-color: #0078d4;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- È°∂ÈÉ®Â∑•ÂÖ∑Ê†è - Âç†Êª°ÊµèËßàÂô®ÂÆΩÂ∫¶ -->
        <div class="toolbar">
            <!-- Â∑¶‰æßÔºöËµÑ‰∫ßÂ±ÇÁ∫ß‰∏ãÊãâÈÄâÊã©Âô® -->
            <div class="toolbar-left">
                <div class="tree-dropdown">
                    <div class="tree-dropdown-button" id="tree-dropdown-btn">
                        <span id="selected-asset">Ê∞¥Ê≥•Â∑•ÂéÇ</span>
                        <span>‚ñº</span>
                    </div>
                    <div class="tree-dropdown-content" id="tree-dropdown-content">
                        <div class="tree-container">
                            <div class="tree-node">
                                <div class="tree-node-content" data-level="factory" data-id="cement-factory">
                                    <span class="tree-expand-icon expanded">‚ñ∂</span>
                                    <span class="tree-node-icon">üè≠</span>
                                    <span class="tree-node-label">Ê∞¥Ê≥•Â∑•ÂéÇ</span>
                                </div>
                                <div class="tree-children expanded">
                                    <div class="tree-node">
                                        <div class="tree-node-content alarm-medium" data-level="workshop" data-id="crushing-workshop">
                                            <span class="tree-expand-icon expanded">‚ñ∂</span>
                                            <span class="tree-node-icon">üî®</span>
                                            <span class="tree-node-label">Á†¥Á¢éÂ∑•ÊÆµ</span>
                                        </div>
                                        <div class="tree-children expanded">
                                            <div class="tree-node">
                                                <div class="tree-node-content" data-level="equipment" data-id="crusher-1">
                                                    <span class="tree-expand-icon expanded">‚ñ∂</span>
                                                    <span class="tree-node-icon">‚öôÔ∏è</span>
                                                    <span class="tree-node-label">È¢öÂºèÁ†¥Á¢éÊú∫</span>
                                                </div>
                                                <div class="tree-children expanded">
                                                    <div class="tree-node">
                                                        <div class="tree-node-content alarm-high" data-level="component" data-id="crusher-motor">
                                                            <span class="tree-expand-icon" style="visibility: hidden;">‚ñ∂</span>
                                                            <span class="tree-node-icon">üîß</span>
                                                            <span class="tree-node-label">ÁîµÊú∫</span>
                                                        </div>
                                                    </div>
                                                    <div class="tree-node">
                                                        <div class="tree-node-content" data-level="component" data-id="crusher-bearing">
                                                            <span class="tree-expand-icon" style="visibility: hidden;">‚ñ∂</span>
                                                            <span class="tree-node-icon">üîß</span>
                                                            <span class="tree-node-label">ËΩ¥Êâø</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="tree-node">
                                                <div class="tree-node-content" data-level="equipment" data-id="conveyor-1">
                                                    <span class="tree-expand-icon" style="visibility: hidden;">‚ñ∂</span>
                                                    <span class="tree-node-icon">‚öôÔ∏è</span>
                                                    <span class="tree-node-label">ÁöÆÂ∏¶ËæìÈÄÅÊú∫</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="tree-node">
                                        <div class="tree-node-content" data-level="workshop" data-id="grinding-workshop">
                                            <span class="tree-expand-icon expanded">‚ñ∂</span>
                                            <span class="tree-node-icon">üå™Ô∏è</span>
                                            <span class="tree-node-label">Á≤âÁ£®Â∑•ÊÆµ</span>
                                        </div>
                                        <div class="tree-children expanded">
                                            <div class="tree-node">
                                                <div class="tree-node-content alarm-low" data-level="equipment" data-id="ball-mill">
                                                    <span class="tree-expand-icon expanded">‚ñ∂</span>
                                                    <span class="tree-node-icon">‚öôÔ∏è</span>
                                                    <span class="tree-node-label">ÁêÉÁ£®Êú∫</span>
                                                </div>
                                                <div class="tree-children expanded">
                                                    <div class="tree-node">
                                                        <div class="tree-node-content" data-level="component" data-id="mill-motor">
                                                            <span class="tree-expand-icon" style="visibility: hidden;">‚ñ∂</span>
                                                            <span class="tree-node-icon">üîß</span>
                                                            <span class="tree-node-label">‰∏ªÁîµÊú∫</span>
                                                        </div>
                                                    </div>
                                                    <div class="tree-node">
                                                        <div class="tree-node-content" data-level="component" data-id="mill-gearbox">
                                                            <span class="tree-expand-icon" style="visibility: hidden;">‚ñ∂</span>
                                                            <span class="tree-node-icon">üîß</span>
                                                            <span class="tree-node-label">ÂáèÈÄüÂô®</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="tree-node">
                                                <div class="tree-node-content" data-level="equipment" data-id="separator">
                                                    <span class="tree-expand-icon" style="visibility: hidden;">‚ñ∂</span>
                                                    <span class="tree-node-icon">‚öôÔ∏è</span>
                                                    <span class="tree-node-label">ÈÄâÁ≤âÊú∫</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="tree-node">
                                        <div class="tree-node-content" data-level="workshop" data-id="burning-workshop">
                                            <span class="tree-expand-icon expanded">‚ñ∂</span>
                                            <span class="tree-node-icon">üî•</span>
                                            <span class="tree-node-label">ÁÖÖÁÉßÂ∑•ÊÆµ</span>
                                        </div>
                                        <div class="tree-children expanded">
                                            <div class="tree-node">
                                                <div class="tree-node-content" data-level="equipment" data-id="rotary-kiln">
                                                    <span class="tree-expand-icon expanded">‚ñ∂</span>
                                                    <span class="tree-node-icon">‚öôÔ∏è</span>
                                                    <span class="tree-node-label">ÂõûËΩ¨Á™ë</span>
                                                </div>
                                                <div class="tree-children expanded">
                                                    <div class="tree-node">
                                                        <div class="tree-node-content" data-level="component" data-id="kiln-burner">
                                                            <span class="tree-expand-icon" style="visibility: hidden;">‚ñ∂</span>
                                                            <span class="tree-node-icon">üîß</span>
                                                            <span class="tree-node-label">ÁáÉÁÉßÂô®</span>
                                                        </div>
                                                    </div>
                                                    <div class="tree-node">
                                                        <div class="tree-node-content" data-level="component" data-id="kiln-cylinder">
                                                            <span class="tree-expand-icon" style="visibility: hidden;">‚ñ∂</span>
                                                            <span class="tree-node-icon">üîß</span>
                                                            <span class="tree-node-label">Á™ëÁ≠í‰Ωì</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ‰∏≠Èó¥ÔºöÊ®°ÂºèÂíåËßÜÂõæÈÄâÊã©Âô® -->
            <div class="toolbar-center">
                <div class="mode-selector">
                    <label>ËøêË°åÊ®°ÂºèÔºö</label>
                    <button class="btn active" data-mode="realtime">ÂÆûÊó∂ÁõëÊéß</button>
                    <button class="btn" data-mode="history">ÂéÜÂè≤ÂõûÁúã</button>
                    <button class="btn" data-mode="simulation">Ê®°ÊãüÊé®Êºî</button>
                </div>
                
                <div class="view-selector">
                    <label>ËßÜÂõæÊ®°ÂºèÔºö</label>
                    <button class="btn active" data-view="3d">‰∏âÁª¥ËßÜÂõæ</button>
                    <button class="btn" data-view="2d">Âπ≥Èù¢ËßÜÂõæ</button>
                    <button class="btn" data-view="scada">ÁªÑÊÄÅËßÜÂõæ</button>
                </div>
            </div>
            
            <!-- Âè≥‰æßÔºöÂëäË≠¶ÂíåÁºñËæëÊ®°Âºè -->
            <div class="toolbar-right">
                <button class="icon-button" id="alarm-toggle" data-tooltip="ÂëäË≠¶ÂàóË°®">
                    <div class="flat-alarm-icon"></div>
                    <span class="alarm-count" id="alarm-count">3</span>
                </button>
                <button class="icon-button" id="edit-toggle" data-tooltip="ËßÜÂõæÁºñËæë">
                    <div class="flat-edit-icon">
                        <div class="edit-icon-inner"></div>
                    </div>
                </button>
            </div>
        </div>

        <!-- ÂÜÖÂÆπÂå∫ÂüüÂåÖË£ÖÂô® -->
        <div class="content-wrapper">
            <!-- Â∑¶‰æßÊåáÊ†áÈù¢Êùø -->
            <div class="sidebar" id="metrics-panel">
                <div class="sidebar-header">
                    <h3>ÂÆûÊó∂ÊåáÊ†á</h3>
                </div>
                <div class="metric-item">
                    <div class="metric-label">Áîü‰∫ßÊïàÁéá</div>
                    <div class="metric-value">85.6<span class="metric-unit">%</span></div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">ËÆæÂ§áËøêË°åÁéá</div>
                    <div class="metric-value">92.3<span class="metric-unit">%</span></div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">ËÉΩËÄóÊåáÊ†á</div>
                    <div class="metric-value">245.8<span class="metric-unit">kWh/t</span></div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">Ê∏©Â∫¶</div>
                    <div class="metric-value">1450<span class="metric-unit">‚ÑÉ</span></div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">ÂéãÂäõ</div>
                    <div class="metric-value">2.5<span class="metric-unit">MPa</span></div>
                </div>
            </div>

            <!-- ‰∏ªÂÜÖÂÆπÂå∫Âüü -->
            <div class="main-content">

            <!-- Èù¢ÂåÖÂ±ëÂØºËà™ -->
            <div class="breadcrumb">
                <div class="breadcrumb-content">
                    <span class="breadcrumb-item" data-id="cement-factory">Ê∞¥Ê≥•Â∑•ÂéÇ</span>
                </div>
                <div class="control-buttons">
                    <button class="icon-button" id="reset-view-btn" data-tooltip="ÈáçÁΩÆËßÜËßí" onclick="resetCameraView()">
                        ‚Üª
                    </button>
                    <button class="icon-button" id="expand-toggle" data-tooltip="ÂÖ®Â±èËßÜÂõæ">
                        ‚§¢
                    </button>
                </div>
            </div>

            <!-- ‰∏ãÈíªÂ±ÇÁ∫ßÊåáÁ§∫Âô® -->
            <div class="drill-level-indicator" id="drill-indicator">
                Â∑•ÂéÇÊÄªËßà
            </div>

            <!-- ÊòæÁ§∫Âå∫Âüü -->
            <div class="display-area">
                <div id="canvas-container">
                    <canvas id="three-canvas"></canvas>
                    <svg id="svg-canvas" width="100%" height="100%"></svg>
                    <div id="scada-canvas" style="display: none;">
                        <div class="scada-container">
                            <div class="scada-header">
                                <div class="scada-title">Ê∞¥Ê≥•Â∑•ÂéÇÁªÑÊÄÅÁõëÊéß</div>
                                <div class="scada-toolbar">
                                    <button class="scada-btn" id="scada-edit-mode" data-tooltip="ÁºñËæëÊ®°Âºè">
                                        <span>‚úèÔ∏è</span>
                                    </button>
                                    <button class="scada-btn" id="scada-save" data-tooltip="‰øùÂ≠òÈÖçÁΩÆ">
                                        <span>üíæ</span>
                                    </button>
                                    <button class="scada-btn" id="scada-load" data-tooltip="Âä†ËΩΩÈÖçÁΩÆ">
                                        <span>üìÅ</span>
                                    </button>
                                    <button class="scada-btn" id="scada-fullscreen" data-tooltip="ÂÖ®Â±èÊ®°Âºè">
                                        <span>‚õ∂</span>
                                    </button>
                                </div>
                            </div>
                            <div class="scada-workspace" id="scada-workspace">
                                <!-- ÁªÑÊÄÅÁîªÂ∏ÉÂå∫Âüü -->
                                <div class="scada-grid" id="scada-grid"></div>
                                
                                <!-- È¢ÑÁΩÆÁªÑÊÄÅÂÖÉÁ¥† -->
                                <div class="scada-component equipment-monitor" data-id="crusher-1" style="left: 100px; top: 100px;">
                                    <div class="component-header">È¢öÂºèÁ†¥Á¢éÊú∫</div>
                                    <div class="component-body">
                                        <div class="status-indicator" id="crusher-status"></div>
                                        <div class="param-display">
                                            <span class="param-label">Ê∏©Â∫¶:</span>
                                            <span class="param-value" id="crusher-temp">75.2¬∞C</span>
                                        </div>
                                        <div class="param-display">
                                            <span class="param-label">ÂäüÁéá:</span>
                                            <span class="param-value" id="crusher-power">450kW</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="scada-component equipment-monitor" data-id="ball-mill" style="left: 300px; top: 100px;">
                                    <div class="component-header">ÁêÉÁ£®Êú∫</div>
                                    <div class="component-body">
                                        <div class="status-indicator" id="mill-status"></div>
                                        <div class="param-display">
                                            <span class="param-label">Ê∏©Â∫¶:</span>
                                            <span class="param-value" id="mill-temp">82.5¬∞C</span>
                                        </div>
                                        <div class="param-display">
                                            <span class="param-label">ËΩ¨ÈÄü:</span>
                                            <span class="param-value" id="mill-speed">18rpm</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="scada-component equipment-monitor" data-id="rotary-kiln" style="left: 500px; top: 100px;">
                                    <div class="component-header">ÂõûËΩ¨Á™ë</div>
                                    <div class="component-body">
                                        <div class="status-indicator" id="kiln-status"></div>
                                        <div class="param-display">
                                            <span class="param-label">Ê∏©Â∫¶:</span>
                                            <span class="param-value" id="kiln-temp">950¬∞C</span>
                                        </div>
                                        <div class="param-display">
                                            <span class="param-label">ËΩ¨ÈÄü:</span>
                                            <span class="param-value" id="kiln-speed">3.5rpm</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- ÊµÅÁ®ãËøûÊé•Á∫ø -->
                                <svg class="scada-connections" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;">
                                    <defs>
                                        <marker id="scada-arrow" markerWidth="10" markerHeight="7" 
                                                refX="9" refY="3.5" orient="auto">
                                            <polygon points="0 0, 10 3.5, 0 7" fill="#00ff88" />
                                        </marker>
                                    </defs>
                                    
                                    <!-- Á†¥Á¢éÊú∫Âà∞ÁêÉÁ£®Êú∫ -->
                                    <line x1="220" y1="140" x2="300" y2="140" stroke="#00ff88" stroke-width="3" 
                                          marker-end="url(#scada-arrow)" opacity="0.8">
                                        <animate attributeName="stroke-dasharray" values="0,10;10,0" dur="2s" repeatCount="indefinite"/>
                                    </line>
                                    
                                    <!-- ÁêÉÁ£®Êú∫Âà∞ÂõûËΩ¨Á™ë -->
                                    <line x1="420" y1="140" x2="500" y2="140" stroke="#00ff88" stroke-width="3" 
                                          marker-end="url(#scada-arrow)" opacity="0.8">
                                        <animate attributeName="stroke-dasharray" values="0,10;10,0" dur="2s" repeatCount="indefinite"/>
                                    </line>
                                </svg>

                                <!-- ÊÄªËßà‰ª™Ë°®Êùø -->
                                <div class="scada-component dashboard-panel" style="left: 50px; top: 300px;">
                                    <div class="component-header">Áîü‰∫ßÊÄªËßà</div>
                                    <div class="component-body">
                                        <div class="dashboard-metric">
                                            <span class="metric-label">ÊÄª‰∫ßÈáè</span>
                                            <span class="metric-value" id="total-output">2,340t</span>
                                        </div>
                                        <div class="dashboard-metric">
                                            <span class="metric-label">ÊïàÁéá</span>
                                            <span class="metric-value" id="overall-efficiency">85.6%</span>
                                        </div>
                                        <div class="dashboard-metric">
                                            <span class="metric-label">ÂëäË≠¶</span>
                                            <span class="metric-value alarm-count" id="dashboard-alarms">3È°π</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ‰ø°ÊÅØÊÇ¨ÊµÆÊ°Ü -->
                <div class="info-tooltip" id="tooltip">
                    <div class="tooltip-content"></div>
                </div>
                
                <!-- ÂÖ®Â±ÄÂ∑•ÂÖ∑ÊèêÁ§∫ -->
                <div class="global-tooltip" id="global-tooltip"></div>
            </div>
                </div>

        <!-- ÂëäË≠¶ÂºπÊ°Ü -->
        <div class="alarm-modal" id="alarm-modal">
            <div class="alarm-content">
                <div class="alarm-header">
                    <h3>Á≥ªÁªüÂëäË≠¶</h3>
                    <button class="alarm-close" id="alarm-close">√ó</button>
                </div>
                <div class="alarm-stats">
                    <div class="alarm-stat alarm-stat-high" data-filter="high">
                        <div class="alarm-stat-icon"></div>
                        <span class="alarm-stat-text">È´òÁ∫ßÂëäË≠¶</span>
                        <span class="alarm-stat-badge" id="high-alarm-count">1</span>
                    </div>
                    <div class="alarm-stat alarm-stat-medium" data-filter="medium">
                        <div class="alarm-stat-icon"></div>
                        <span class="alarm-stat-text">‰∏≠Á∫ßÂëäË≠¶</span>
                        <span class="alarm-stat-badge" id="medium-alarm-count">1</span>
                    </div>
                    <div class="alarm-stat alarm-stat-low" data-filter="low">
                        <div class="alarm-stat-icon"></div>
                        <span class="alarm-stat-text">‰ΩéÁ∫ßÂëäË≠¶</span>
                        <span class="alarm-stat-badge" id="low-alarm-count">1</span>
                    </div>
                </div>
                <div class="alarm-filter-tip" id="alarm-filter-tip">
                    Ê≠£Âú®ÊòæÁ§∫Ôºö<span id="filter-text">ÊâÄÊúâÂëäË≠¶</span>
                    <span class="alarm-filter-clear" onclick="clearAlarmFilter()">ÊòæÁ§∫ÂÖ®ÈÉ®</span>
                </div>
                <div class="alarm-list" id="alarm-list">
                    <!-- ÂëäË≠¶È°πÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
                </div>
            </div>
        </div>

            <!-- Âè≥‰æßÊåáÊ†áÈù¢Êùø -->
            <div class="right-metrics-panel" id="right-metrics-panel">
                <div class="sidebar-header">
                    <h3>Á≥ªÁªüÊ¶ÇËßà</h3>
                </div>
                <div class="metric-item">
                    <div class="metric-label">Êï¥‰ΩìÁîü‰∫ßÊïàÁéá</div>
                    <div class="metric-value">85.6<span class="metric-unit">%</span></div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">ËÆæÂ§áÊÄªËøêË°åÁéá</div>
                    <div class="metric-value">92.3<span class="metric-unit">%</span></div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">Âπ≥ÂùáËÉΩËÄó</div>
                    <div class="metric-value">245.8<span class="metric-unit">kWh/t</span></div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">‰ªäÊó•‰∫ßÈáè</div>
                    <div class="metric-value">2,340<span class="metric-unit">t</span></div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">ÂëäË≠¶Êï∞Èáè</div>
                    <div class="metric-value">3<span class="metric-unit">È°π</span></div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">Âú®Á∫øËÆæÂ§á</div>
                    <div class="metric-value">24/26<span class="metric-unit">Âè∞</span></div>
                </div>
            </div>
        </div>

                <!-- Ê®°ÂºèÊéßÂà∂Èù¢Êùø -->
        <div class="mode-control-panel" id="mode-control-panel">
            <h3 id="mode-panel-title">ÂÆûÊó∂ÁõëÊéß</h3>
            
            <!-- ÂéÜÂè≤ÂõûÁúãÊéßÂà∂ -->
            <div id="history-controls" style="display: none;">
                <div class="time-selector">
                    <label for="history-date">ÈÄâÊã©Êó•Êúü:</label>
                    <input type="date" id="history-date" value="2024-01-15">
                    
                    <label for="history-time-start">ÂºÄÂßãÊó∂Èó¥:</label>
                    <input type="time" id="history-time-start" value="08:00">
                    
                    <label for="history-time-end">ÁªìÊùüÊó∂Èó¥:</label>
                    <input type="time" id="history-time-end" value="18:00">
                    
                    <button class="btn" onclick="loadHistoryData()">Âä†ËΩΩÂéÜÂè≤Êï∞ÊçÆ</button>
                </div>
                
                <div class="history-info">
                    <h4>ÂéÜÂè≤Êï∞ÊçÆ‰ø°ÊÅØ</h4>
                    <p>ÊòæÁ§∫Êó∂Èó¥ÊÆµ: <span id="history-time-range">--</span></p>
                    <p>Êï∞ÊçÆÁÇπÊï∞Èáè: <span id="history-data-points">--</span></p>
                </div>
            </div>
            
            <!-- Ê®°ÊãüÊé®ÊºîÊéßÂà∂ -->
            <div id="simulation-controls" style="display: none;">
                <div class="time-selector">
                    <label for="sim-base-date">Âü∫Á°ÄÊï∞ÊçÆÊó∂Èó¥:</label>
                    <input type="date" id="sim-base-date" value="2024-01-15">
                    <input type="time" id="sim-base-time" value="14:00">
                    
                    <label for="sim-target-time">È¢ÑÊµãÂà∞Êó∂Èó¥:</label>
                    <select id="sim-target-time">
                        <option value="1">1Â∞èÊó∂Âêé</option>
                        <option value="4">4Â∞èÊó∂Âêé</option>
                        <option value="8">8Â∞èÊó∂Âêé</option>
                        <option value="24">24Â∞èÊó∂Âêé</option>
                    </select>
                </div>
                
                <div class="simulation-controls">
                    <h4>Ë∞ÉÊï¥ÂèÇÊï∞</h4>
                    
                    <div class="parameter-control">
                        <label>Áîü‰∫ßË¥üËç∑Ë∞ÉÊï¥: <span class="parameter-value" id="load-value">100%</span></label>
                        <input type="range" class="parameter-slider" id="load-slider" min="50" max="150" value="100">
                    </div>
                    
                    <div class="parameter-control">
                        <label>ÂéüÊñôË¥®ÈáèÁ≥ªÊï∞: <span class="parameter-value" id="quality-value">1.0</span></label>
                        <input type="range" class="parameter-slider" id="quality-slider" min="0.8" max="1.2" step="0.1" value="1.0">
                    </div>
                    
                    <div class="parameter-control">
                        <label>ËÆæÂ§áÊïàÁéáÁ≥ªÊï∞: <span class="parameter-value" id="efficiency-value">100%</span></label>
                        <input type="range" class="parameter-slider" id="efficiency-slider" min="80" max="120" value="100">
                    </div>
                    
                    <button class="btn" onclick="runSimulation()">ÂºÄÂßãÊ®°ÊãüÊé®Êºî</button>
                </div>
                
                <div class="prediction-info">
                    <h4>È¢ÑÊµãÁªìÊûú</h4>
                    <p>È¢ÑÊµã‰∫ßÈáè: <span id="predicted-output">--</span> t/h</p>
                    <p>ËÉΩËÄóÈ¢ÑÊµã: <span id="predicted-energy">--</span> kWh/t</p>
                    <p>ËÆæÂ§áÁä∂ÊÄÅ: <span id="predicted-status">--</span></p>
                </div>
            </div>
        </div>

        <!-- ÁºñËæëÊ®°ÂºèÈù¢Êùø -->
        <div class="edit-panel" id="edit-panel">
            <h3>ÁºñËæëËÆæÁΩÆ</h3>
            
            <div class="checkbox-group">
                <h4>ÊòæÁ§∫ÊåáÊ†á</h4>
                <div class="checkbox-item">
                    <input type="checkbox" id="metric-efficiency" checked>
                    <label for="metric-efficiency">Áîü‰∫ßÊïàÁéá</label>
                        </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="metric-runtime" checked>
                    <label for="metric-runtime">ËÆæÂ§áËøêË°åÁéá</label>
                        </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="metric-energy" checked>
                    <label for="metric-energy">ËÉΩËÄóÊåáÊ†á</label>
                        </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="metric-temperature" checked>
                    <label for="metric-temperature">Ê∏©Â∫¶</label>
                    </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="metric-pressure" checked>
                    <label for="metric-pressure">ÂéãÂäõ</label>
                </div>
            </div>

            <div class="checkbox-group">
                <h4>È°µÈù¢Â∏ÉÂ±Ä</h4>
                <div class="checkbox-item">
                    <input type="checkbox" id="layout-sidebar" checked>
                    <label for="layout-sidebar">Â∑¶‰æßÊåáÊ†áÈù¢Êùø</label>
                    </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="layout-right-metrics" checked>
                    <label for="layout-right-metrics">Âè≥‰æßÊåáÊ†áÈù¢Êùø</label>
                    </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="layout-breadcrumb" checked>
                    <label for="layout-breadcrumb">Èù¢ÂåÖÂ±ëÂØºËà™</label>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ÂÖ®Â±ÄÂèòÈáè
        let scene, camera, renderer, controls;
        let currentView = '3d';
        let currentMode = 'realtime';
        let editMode = false;
        let selectedNode = null;
        let factoryData = {};
        let historyData = {};
        let simulationParams = {
            loadFactor: 1.0,
            qualityFactor: 1.0,
            efficiencyFactor: 1.0
        };
        let realTimeInterval = null;
        let isDataLoading = false;
        let currentDrillLevel = 'factory'; // ÂΩìÂâç‰∏ãÈíªÂ±ÇÁ∫ß
        let drillPath = []; // ‰∏ãÈíªË∑ØÂæÑ

        // ÂëäË≠¶Êï∞ÊçÆ
        let alarmData = [
            {
                id: 'alarm-001',
                level: 'high',
                deviceId: 'crusher-motor',
                deviceName: 'È¢öÂºèÁ†¥Á¢éÊú∫ÁîµÊú∫',
                title: 'ÁîµÊú∫Ê∏©Â∫¶ËøáÈ´ò',
                description: 'ÁîµÊú∫Ê∏©Â∫¶ËææÂà∞95‚ÑÉÔºåË∂ÖËøáÂÆâÂÖ®ÈòàÂÄº',
                time: '10:25',
                timestamp: Date.now() - 1000 * 60 * 35,
                status: 'active'
            },
            {
                id: 'alarm-002', 
                level: 'medium',
                deviceId: 'crushing-workshop',
                deviceName: 'Á†¥Á¢éÂ∑•ÊÆµ',
                title: 'ÊåØÂä®ÂºÇÂ∏∏',
                description: 'Ê£ÄÊµãÂà∞ÂºÇÂ∏∏ÊåØÂä®Ê®°ÂºèÔºåÂª∫ËÆÆÊ£ÄÊü•ËÆæÂ§á',
                time: '09:45',
                timestamp: Date.now() - 1000 * 60 * 75,
                status: 'active'
            },
            {
                id: 'alarm-003',
                level: 'low',
                deviceId: 'ball-mill',
                deviceName: 'ÁêÉÁ£®Êú∫',
                title: 'ÊïàÁéá‰∏ãÈôç',
                description: 'Áîü‰∫ßÊïàÁéáËæÉÊò®Êó•‰∏ãÈôç5%ÔºåËØ∑ÂÖ≥Ê≥®',
                time: '09:12',
                timestamp: Date.now() - 1000 * 60 * 108,
                status: 'active'
            }
        ];

        // ÂëäË≠¶ËøáÊª§Áä∂ÊÄÅ
        let currentAlarmFilter = null;

        // ÂàùÂßãÂåñÂ∫îÁî®
        function init() {
            initTreeDropdown();
            init3DView();
            init2DView();
            initEventListeners();
            loadFactoryData();
            
            // Á°Æ‰øùÂ∑¶‰æßÊåáÊ†áÈù¢ÊùøÂßãÁªàÂèØËßÅ
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.style.display = 'block';
                sidebar.style.visibility = 'visible';
            }
            
            // Á°Æ‰øù‰æßËæπÊ†èÂ§çÈÄâÊ°ÜÈÄâ‰∏≠
            const sidebarCheckbox = document.getElementById('layout-sidebar');
            if (sidebarCheckbox) {
                sidebarCheckbox.checked = true;
            }
            
            // ÂêØÂä®ÂÆûÊó∂Ê®°Âºè
            switchMode('realtime');
            
            // ËÆæÁΩÆÈªòËÆ§ÈÄâ‰∏≠ËäÇÁÇπ
            selectedNode = { 
                id: 'cement-factory', 
                level: 'factory', 
                name: 'Ê∞¥Ê≥•Â∑•ÂéÇ' 
            };
            
            // ËÆæÁΩÆÈªòËÆ§activeÁä∂ÊÄÅ
            const defaultNode = document.querySelector('[data-id="cement-factory"]');
            if (defaultNode) {
                defaultNode.classList.add('active');
            }
            
            updateBreadcrumb();
            updateMetricsForNode('cement-factory');
            
            // ÂàùÂßãÂåñÂè≥‰æßÊåáÊ†áÈù¢Êùø
            updateRightMetricsPanel();
            
            // ÂàùÂßãÂåñÊéßÂà∂ÊåâÈíÆÁä∂ÊÄÅ
            const expandButton = document.getElementById('expand-toggle');
            if (expandButton) {
                expandButton.textContent = '‚§¢';
                expandButton.setAttribute('data-tooltip', 'ÂÖ®Â±èËßÜÂõæ');
            }
            
            // ÂàùÂßãÂåñÂëäË≠¶ÊòæÁ§∫
            updateAlarmDisplay();
            
            // È°µÈù¢ÂàùÂßãÂåñÊó∂‰ΩøÁî®ÈáçÁΩÆËßÜËßí
            setTimeout(() => {
                if (camera && controls) {
                    // Ë∞ÉÁî®ÈáçÁΩÆËßÜËßíÂäüËÉΩÔºåËÆæÁΩÆÂà∞ÊúÄ‰Ω≥ËßÇÁúãËßíÂ∫¶
                    resetCameraView();
                }
            }, 500);
        }

        // ÂàùÂßãÂåñÊ†ëÂΩ¢‰∏ãÊãâÊ°Ü
        function initTreeDropdown() {
            const dropdownBtn = document.getElementById('tree-dropdown-btn');
            const dropdownContent = document.getElementById('tree-dropdown-content');
            const selectedAssetSpan = document.getElementById('selected-asset');
            
            // ‰∏ãÊãâÊ°ÜÂºÄÂÖ≥‰∫ã‰ª∂
            dropdownBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                dropdownContent.classList.toggle('show');
            });
            
            // ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠‰∏ãÊãâÊ°Ü
            document.addEventListener('click', function() {
                dropdownContent.classList.remove('show');
            });
            
            // ÈòªÊ≠¢‰∏ãÊãâÊ°ÜÂÜÖÈÉ®ÁÇπÂáªÂÖ≥Èó≠
            dropdownContent.addEventListener('click', function(e) {
                e.stopPropagation();
            });
            
            // ÂàùÂßãÂåñÊ†ëÂΩ¢ÁªìÊûÑ
            initTreeView();
        }

        // ÂàùÂßãÂåñÊ†ëÂΩ¢ËßÜÂõæ
        function initTreeView() {
            const treeNodes = document.querySelectorAll('.tree-node-content');
            
            treeNodes.forEach(node => {
                // Â±ïÂºÄ/ÊäòÂè†ÂõæÊ†áÁÇπÂáª‰∫ã‰ª∂
                const expandIcon = node.querySelector('.tree-expand-icon');
                if (expandIcon && expandIcon.style.visibility !== 'hidden') {
                    expandIcon.addEventListener('click', function(e) {
                        e.stopPropagation();
                        
                        // ÂàáÊç¢Â±ïÂºÄÁä∂ÊÄÅ
                        const parent = node.parentElement;
                        const children = parent.querySelector('.tree-children');
                        if (children) {
                            children.classList.toggle('expanded');
                            this.classList.toggle('expanded');
                        }
                    });
                }
                
                // ËäÇÁÇπÂêçÁß∞ÁÇπÂáª‰∫ã‰ª∂
                const nodeLabel = node.querySelector('.tree-node-label');
                if (nodeLabel) {
                    nodeLabel.addEventListener('click', function(e) {
                        e.stopPropagation();
                        
                        // ‰ΩøÁî®Áªü‰∏ÄÁöÑËäÇÁÇπÂàáÊç¢ÂáΩÊï∞
                        switchToNode(node.dataset.id, 'tree_click');
                    });
                }
            });
        }

        // ÂàùÂßãÂåñ3DËßÜÂõæ
        function init3DView() {
            const container = document.getElementById('canvas-container');
            const canvas = document.getElementById('three-canvas');
            
            // ÂàõÂª∫Âú∫ÊôØ
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a1a);
            
            // ÂàõÂª∫Áõ∏Êú∫
            camera = new THREE.PerspectiveCamera(75, container.offsetWidth / container.offsetHeight, 0.1, 1000);
            camera.position.set(0, 25, 30); // Ë∞ÉÊï¥Âà∞Êõ¥Â•ΩÁöÑ‰øØËßÜËßíÂ∫¶
            
            // ÂàõÂª∫Ê∏≤ÊüìÂô®
            renderer = new THREE.WebGLRenderer({ canvas: canvas });
            renderer.setSize(container.offsetWidth, container.offsetHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            
            // ÂàõÂª∫ÊéßÂà∂Âô®
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.1;
            controls.target.set(0, 0, -10); // ËÅöÁÑ¶Âú®Â∑•ÊÆµÂå∫Âüü‰∏≠ÂøÉ
            controls.maxPolarAngle = Math.PI * 0.8; // ÈôêÂà∂ÂûÇÁõ¥ÊóãËΩ¨ËßíÂ∫¶
            controls.minDistance = 10; // ÊúÄÂ∞èÁº©ÊîæË∑ùÁ¶ª
            controls.maxDistance = 100; // ÊúÄÂ§ßÁº©ÊîæË∑ùÁ¶ª
            
            // Ê∑ªÂä†ÂÖâÊ∫ê
            const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(50, 50, 50);
            directionalLight.castShadow = true;
            scene.add(directionalLight);
            
            // ÂàõÂª∫Â∑•ÂéÇÊ®°Âûã
            createFactoryModel();
            
            // Â∫îÁî®ÂëäË≠¶ÊïàÊûú
            setTimeout(() => {
                saveOriginalColors();
                apply3DAlarmEffects();
                addEquipmentAnimations();
            }, 100);
            
            // Èº†Ê†á‰∫ã‰ª∂
            const raycaster = new THREE.Raycaster();
            const mouse = new THREE.Vector2();
            
            // Èº†Ê†áÁßªÂä®‰∫ã‰ª∂ÔºàÂ∑•ÂÖ∑ÊèêÁ§∫Ôºâ
            canvas.addEventListener('mousemove', function(event) {
                const rect = canvas.getBoundingClientRect();
                mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
                mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
                
                raycaster.setFromCamera(mouse, camera);
                const intersects = raycaster.intersectObjects(scene.children, true);
                
                if (intersects.length > 0) {
                    const object = intersects[0].object;
                    if (object.userData && object.userData.id) {
                        // ‰∏∫Â∑•ÂÖ∑ÊèêÁ§∫Ê°ÜÂàõÂª∫Ê≠£Á°ÆÁöÑ‰∫ã‰ª∂ÂØπË±°
                        const tooltipEvent = {
                            clientX: event.clientX,
                            clientY: event.clientY,
                            pageX: event.clientX + window.pageXOffset,
                            pageY: event.clientY + window.pageYOffset
                        };
                        showTooltip(tooltipEvent, object.userData);
                    } else {
                        hideTooltip();
                    }
                } else {
                    hideTooltip();
                }
            });

            // Èº†Ê†áÁÇπÂáª‰∫ã‰ª∂Ôºà‰∏ãÈíªÔºâ
            canvas.addEventListener('click', function(event) {
                const rect = canvas.getBoundingClientRect();
                mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
                mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
                
                raycaster.setFromCamera(mouse, camera);
                const intersects = raycaster.intersectObjects(scene.children, true);
                
                if (intersects.length > 0) {
                    const object = intersects[0].object;
                    if (object.userData && object.userData.id) {
                        // ‰ΩøÁî®Áªü‰∏ÄÁöÑËäÇÁÇπÂàáÊç¢ÂáΩÊï∞
                        switchToNode(object.userData.id, '3d_click');
                    }
                }
            });
            
            // Ê∏≤ÊüìÂæ™ÁéØ
            let lastTime = 0;
            function animate(currentTime) {
                requestAnimationFrame(animate);
                
                const deltaTime = (currentTime - lastTime) * 0.001; // ËΩ¨Êç¢‰∏∫Áßí
                lastTime = currentTime;
                
                // Êõ¥Êñ∞ÊéßÂà∂Âô®
                controls.update();
                
                // Êõ¥Êñ∞ÂëäË≠¶Èó™ÁÉÅÊïàÊûú
                updateBlinkingEffects();
                
                // Êõ¥Êñ∞ËÆæÂ§áÂä®Áîª
                updateEquipmentAnimations(deltaTime);
                
                // Ê∏≤ÊüìÂú∫ÊôØ
                renderer.render(scene, camera);
            }
            animate();
            
            // Á™óÂè£Â§ßÂ∞èË∞ÉÊï¥
            window.addEventListener('resize', function() {
                const width = container.offsetWidth;
                const height = container.offsetHeight;
                
                camera.aspect = width / height;
                camera.updateProjectionMatrix();
                renderer.setSize(width, height);
            });
        }

        // ÂàùÂßãÂåñ2DËßÜÂõæ
        function init2DView() {
            const svg = document.getElementById('svg-canvas');
            
            // ÂàõÂª∫2DÂ∑•ÂéÇÂ∏ÉÂ±Ä
            const factoryLayout = `
                <defs>
                    <!-- ÁÆ≠Â§¥Ê†áËÆ∞ÂÆö‰πâ -->
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                            refX="9" refY="3.5" orient="auto" markerUnits="strokeWidth">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#00ff88" />
                    </marker>
                    
                    <!-- ÊµÅÂä®Âä®ÁîªÂÆö‰πâ -->
                    <marker id="flow-dot" markerWidth="8" markerHeight="8" 
                            refX="4" refY="4" markerUnits="strokeWidth">
                        <circle cx="4" cy="4" r="3" fill="#00ff88" opacity="0.8">
                            <animate attributeName="opacity" values="0.3;1;0.3" dur="2s" repeatCount="indefinite"/>
                        </circle>
                    </marker>
                </defs>
                
                <g transform="translate(50, 50)">
                    <rect x="0" y="0" width="800" height="600" fill="#333" stroke="#666" stroke-width="2"/>
                    <text x="400" y="30" text-anchor="middle" fill="#fff" font-size="20">Ê∞¥Ê≥•Â∑•ÂéÇÂπ≥Èù¢Âõæ</text>
                    
                    <!-- ÂéüÊñôÂå∫Âüü -->
                    <g class="material-area">
                        <rect x="20" y="280" width="80" height="120" fill="#555" stroke="#888" stroke-width="1" stroke-dasharray="5,5"/>
                        <text x="60" y="330" text-anchor="middle" fill="#ccc" font-size="12">ÂéüÊñôÂå∫</text>
                        <circle cx="60" cy="350" r="8" fill="#8b4513"/>
                        <text x="60" y="365" text-anchor="middle" fill="#ccc" font-size="8">Áü≥ÁÅ∞Áü≥</text>
                    </g>
                    
                    <!-- Á†¥Á¢éÂ∑•ÊÆµ -->
                    <g class="workshop-area" data-id="crushing-workshop">
                        <rect x="130" y="80" width="180" height="150" fill="#554400" stroke="#ffaa00" stroke-width="3"/>
                        <text x="220" y="105" text-anchor="middle" fill="#fff" font-weight="bold">Á†¥Á¢éÂ∑•ÊÆµ</text>
                        
                        <!-- È¢öÂºèÁ†¥Á¢éÊú∫ -->
                        <rect x="160" y="130" width="40" height="30" fill="#666" stroke="#333" stroke-width="1" class="equipment" data-id="crusher-1"/>
                        <circle cx="180" cy="145" r="15" fill="#ff0000" class="alarm-high equipment" data-id="crusher-1" opacity="0.7"/>
                        <text x="180" y="150" text-anchor="middle" fill="#fff" font-size="9">Á†¥Á¢éÊú∫</text>
                        
                        <!-- ÁöÆÂ∏¶ËæìÈÄÅÊú∫ -->
                        <rect x="220" y="140" width="60" height="10" fill="#222" class="equipment" data-id="conveyor-1"/>
                        <text x="250" y="165" text-anchor="middle" fill="#ccc" font-size="8">ËæìÈÄÅÊú∫</text>
                    </g>
                    
                    <!-- Á≤âÁ£®Â∑•ÊÆµ -->
                    <g class="workshop-area" data-id="grinding-workshop">
                        <rect x="340" y="80" width="180" height="150" fill="#004455" stroke="#00aaff" stroke-width="3"/>
                        <text x="430" y="105" text-anchor="middle" fill="#fff" font-weight="bold">Á≤âÁ£®Â∑•ÊÆµ</text>
                        
                        <!-- ÁêÉÁ£®Êú∫ -->
                        <ellipse cx="380" cy="145" rx="25" ry="12" fill="#ffdd44" class="equipment" data-id="ball-mill"/>
                        <circle cx="380" cy="145" r="18" fill="#ffff00" class="alarm-low equipment" data-id="ball-mill" opacity="0.6"/>
                        <text x="380" y="150" text-anchor="middle" fill="#333" font-size="9">ÁêÉÁ£®Êú∫</text>
                        
                        <!-- ÈÄâÁ≤âÊú∫ -->
                        <circle cx="460" cy="145" r="15" fill="#777" class="equipment" data-id="separator"/>
                        <text x="460" y="150" text-anchor="middle" fill="#fff" font-size="8">ÈÄâÁ≤âÊú∫</text>
                    </g>
                    
                    <!-- ÁÖÖÁÉßÂ∑•ÊÆµ -->
                    <g class="workshop-area" data-id="burning-workshop">
                        <rect x="550" y="80" width="180" height="150" fill="#550022" stroke="#ff6600" stroke-width="3"/>
                        <text x="640" y="105" text-anchor="middle" fill="#fff" font-weight="bold">ÁÖÖÁÉßÂ∑•ÊÆµ</text>
                        
                        <!-- ÂõûËΩ¨Á™ë -->
                        <ellipse cx="640" cy="145" rx="45" ry="18" fill="#888" class="equipment" data-id="rotary-kiln"/>
                        <text x="640" y="150" text-anchor="middle" fill="#fff" font-size="10">ÂõûËΩ¨Á™ë</text>
                        
                        <!-- ÁáÉÁÉßÂô® -->
                        <circle cx="680" cy="145" r="8" fill="#ff6600">
                            <animate attributeName="fill" values="#ff6600;#ff3300;#ff6600" dur="1s" repeatCount="indefinite"/>
                        </circle>
                        <text x="680" y="165" text-anchor="middle" fill="#ccc" font-size="7">ÁáÉÁÉßÂô®</text>
                    </g>
                    
                    <!-- ÊàêÂìÅÂå∫Âüü -->
                    <g class="material-area">
                        <rect x="760" y="280" width="80" height="120" fill="#555" stroke="#888" stroke-width="1" stroke-dasharray="5,5"/>
                        <text x="800" y="330" text-anchor="middle" fill="#ccc" font-size="12">ÊàêÂìÅÂå∫</text>
                        <circle cx="800" cy="350" r="8" fill="#666"/>
                        <text x="800" y="365" text-anchor="middle" fill="#ccc" font-size="8">Ê∞¥Ê≥•</text>
                    </g>
                    
                    <!-- ‰∏ªË¶ÅÁâ©ÊñôÊµÅÂêëÁ∫ø -->
                    <g class="flow-lines">
                        <!-- ÂéüÊñôÂà∞Á†¥Á¢é -->
                        <line x1="100" y1="340" x2="160" y2="145" stroke="#00ff88" stroke-width="4" 
                              marker-end="url(#arrowhead)" opacity="0.8"/>
                        <text x="125" y="235" text-anchor="middle" fill="#00ff88" font-size="10">ÂéüÊñôÊäïÂÖ•</text>
                        
                        <!-- Á†¥Á¢éÂà∞Á≤âÁ£® -->
                        <line x1="310" y1="145" x2="340" y2="145" stroke="#00ff88" stroke-width="4" 
                              marker-end="url(#arrowhead)" opacity="0.8"/>
                        <text x="325" y="135" text-anchor="middle" fill="#00ff88" font-size="9">Á≤óÁ¢éÊñô</text>
                        
                        <!-- Á≤âÁ£®Âà∞ÁÖÖÁÉß -->
                        <line x1="520" y1="145" x2="550" y2="145" stroke="#00ff88" stroke-width="4" 
                              marker-end="url(#arrowhead)" opacity="0.8"/>
                        <text x="535" y="135" text-anchor="middle" fill="#00ff88" font-size="9">ÁîüÊñô</text>
                        
                        <!-- ÁÖÖÁÉßÂà∞ÊàêÂìÅ -->
                        <line x1="730" y1="145" x2="760" y2="340" stroke="#00ff88" stroke-width="4" 
                              marker-end="url(#arrowhead)" opacity="0.8"/>
                        <text x="750" y="235" text-anchor="middle" fill="#00ff88" font-size="10">ÁÜüÊñô/Ê∞¥Ê≥•</text>
                    </g>
                    
                    <!-- ËæÖÂä©ÊµÅÂêë -->
                    <g class="auxiliary-flows">
                        <!-- Âæ™ÁéØÁâ©ÊñôÊµÅ -->
                        <path d="M 445 160 Q 430 180, 415 160" stroke="#ffa500" stroke-width="2" 
                              fill="none" marker-end="url(#arrowhead)" opacity="0.6"/>
                        <text x="430" y="185" text-anchor="middle" fill="#ffa500" font-size="8">ËøîÊñô</text>
                        
                        <!-- Â∑•Ëâ∫ÊµÅÂêëÁÇπ -->
                        <circle cx="275" cy="145" r="3" fill="#00ff88" opacity="0.8">
                            <animate attributeName="r" values="2;5;2" dur="1.5s" repeatCount="indefinite"/>
                        </circle>
                        
                        <circle cx="535" cy="145" r="3" fill="#00ff88" opacity="0.8">
                            <animate attributeName="r" values="2;5;2" dur="1.5s" repeatCount="indefinite" begin="0.5s"/>
                        </circle>
                    </g>
                    
                    <!-- ÊµÅÂêëËØ¥Êòé -->
                    <g class="flow-legend">
                        <rect x="20" y="500" width="200" height="80" fill="#222" stroke="#555" stroke-width="1"/>
                        <text x="30" y="520" fill="#fff" font-size="12" font-weight="bold">Áâ©ÊñôÊµÅÂêëËØ¥Êòé</text>
                        
                        <line x1="30" y1="535" x2="60" y2="535" stroke="#00ff88" stroke-width="3" marker-end="url(#arrowhead)"/>
                        <text x="70" y="540" fill="#ccc" font-size="10">‰∏ªË¶ÅÁâ©ÊñôÊµÅ</text>
                        
                        <line x1="30" y1="550" x2="60" y2="550" stroke="#ffa500" stroke-width="2" marker-end="url(#arrowhead)"/>
                        <text x="70" y="555" fill="#ccc" font-size="10">Âæ™ÁéØ/ËøîÊñôÊµÅ</text>
                        
                        <circle cx="45" cy="565" r="3" fill="#00ff88"/>
                        <text x="55" y="570" fill="#ccc" font-size="10">ÊµÅÂêëÁõëÊµãÁÇπ</text>
                    </g>
                </g>
            `;
            
            svg.innerHTML = factoryLayout;
            
            // Ê∑ªÂä†2DÈº†Ê†á‰∫ã‰ª∂
            svg.addEventListener('mousemove', function(event) {
                const target = event.target;
                if (target.classList.contains('equipment') || target.classList.contains('workshop-area')) {
                    // ‰∏∫Â∑•ÂÖ∑ÊèêÁ§∫Ê°ÜÂàõÂª∫Ê≠£Á°ÆÁöÑ‰∫ã‰ª∂ÂØπË±°
                    const tooltipEvent = {
                        clientX: event.clientX,
                        clientY: event.clientY,
                        pageX: event.clientX + window.pageXOffset,
                        pageY: event.clientY + window.pageYOffset
                    };
                    showTooltip(tooltipEvent, target.dataset);
                } else {
                    hideTooltip();
                }
            });

            // Ê∑ªÂä†2DÁÇπÂáª‰∫ã‰ª∂Ôºà‰∏ãÈíªÔºâ
            svg.addEventListener('click', function(event) {
                const target = event.target;
                if (target.dataset && target.dataset.id) {
                    // ‰ΩøÁî®Áªü‰∏ÄÁöÑËäÇÁÇπÂàáÊç¢ÂáΩÊï∞
                    switchToNode(target.dataset.id, '2d_click');
                }
            });
            
            // Ê∑ªÂä†ÊµÅÂêëÂä®ÁîªÊïàÊûú
            animate2DFlows();
        }

        // 2DÊµÅÂêëÂä®Áîª
        function animate2DFlows() {
            // ‰∏∫ÊµÅÂêëÁ∫øÊ∑ªÂä†ËôöÁ∫øÂä®ÁîªÊïàÊûú
            const flowLines = document.querySelectorAll('.flow-lines line');
            flowLines.forEach((line, index) => {
                // ÂàõÂª∫Âä®ÁîªËôöÁ∫øÊïàÊûú
                line.style.strokeDasharray = '10,5';
                line.style.animation = `flow-animation 2s linear infinite`;
                line.style.animationDelay = `${index * 0.3}s`;
            });
            
            // Ê∑ªÂä†CSSÂä®ÁîªÊ†∑Âºè
            if (!document.getElementById('flow-animation-style')) {
                const style = document.createElement('style');
                style.id = 'flow-animation-style';
                style.textContent = `
                    @keyframes flow-animation {
                        0% { stroke-dashoffset: 0; }
                        100% { stroke-dashoffset: 15; }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        // ÂàõÂª∫3DÂ∑•ÂéÇÊ®°Âûã
        function createFactoryModel() {
            // Ê∏ÖÁ©∫Áé∞ÊúâÂú∫ÊôØ‰∏≠ÁöÑÁΩëÊ†º
            const objectsToRemove = [];
            scene.children.forEach(child => {
                if (child instanceof THREE.Mesh) {
                    objectsToRemove.push(child);
                }
            });
            objectsToRemove.forEach(obj => scene.remove(obj));

            // ÂàõÂª∫Âú∞Èù¢
            createGround();
            
            // ÂàõÂª∫Â∑•ÂéÇ‰∏ª‰ΩìÂª∫Á≠ë
            createMainBuilding();
            
            // ÂàõÂª∫ÂêÑÂ∑•ÊÆµÂå∫Âüü
            createWorkshopAreas();
            
            // ÂàõÂª∫ËÆæÂ§á
            createEquipment();
            
            // ÂàõÂª∫Â≠êÈÉ®‰ª∂
            createComponents();
            
            // ÂàõÂª∫ËøûÊé•ÁÆ°ÈÅìÂíåËæìÈÄÅÂ∏¶
            createInfrastructure();
        }

        // ÂàõÂª∫Âú∞Èù¢
        function createGround() {
            const groundGeometry = new THREE.PlaneGeometry(120, 80);
            const groundMaterial = new THREE.MeshLambertMaterial({ 
                color: 0x2a2a2a,
                transparent: true,
                opacity: 0.8 
            });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            ground.userData = { id: 'factory-ground', name: 'Â∑•ÂéÇÂú∞Èù¢', selectable: false };
            scene.add(ground);

            // Ê∑ªÂä†ÁΩëÊ†ºÁ∫ø
            const gridHelper = new THREE.GridHelper(120, 50, 0x444444, 0x333333);
            gridHelper.userData = { selectable: false };
            scene.add(gridHelper);
        }

        // ÂàõÂª∫Â∑•ÂéÇÊ†áËØÜÔºàÁÆÄÂåñÁâàÊú¨ÔºåÂè™‰øùÁïôÂøÖË¶ÅÁöÑÊ†áËØÜÔºâ
        function createMainBuilding() {
            const factoryGroup = new THREE.Group();
            factoryGroup.userData = { id: 'cement-factory', name: 'Ê∞¥Ê≥•Â∑•ÂéÇ', type: 'factory' };

            // Â∑•ÂéÇÊ†áËØÜÁâåÔºàÊõø‰ª£Â§ßÂûãÂª∫Á≠ëÔºâ
            const signGeometry = new THREE.BoxGeometry(8, 3, 0.2);
            const signMaterial = new THREE.MeshLambertMaterial({ color: 0x0078d4 });
            const sign = new THREE.Mesh(signGeometry, signMaterial);
            sign.position.set(0, 8, -25);
            factoryGroup.add(sign);

            // Ê∑ªÂä†ÊñáÂ≠óÁ∫πÁêÜÔºàÊ®°ÊãüÂ∑•ÂéÇÊ†áËØÜÔºâ
            const canvas = document.createElement('canvas');
            canvas.width = 512;
            canvas.height = 128;
            const context = canvas.getContext('2d');
            context.fillStyle = '#ffffff';
            context.font = 'bold 48px Arial';
            context.textAlign = 'center';
            context.fillText('Ê∞¥Ê≥•Â∑•ÂéÇÊï∞Â≠óÂ≠™Áîü', 256, 80);
            
            const texture = new THREE.CanvasTexture(canvas);
            const textMaterial = new THREE.MeshLambertMaterial({ map: texture });
            const textSign = new THREE.Mesh(signGeometry, textMaterial);
            textSign.position.set(0, 8, -24.9);
            factoryGroup.add(textSign);

            scene.add(factoryGroup);
        }

        // ÂàõÂª∫Â∑•ÊÆµÂå∫Âüü
        function createWorkshopAreas() {
            // Á†¥Á¢éÂ∑•ÊÆµÂå∫Âüü
            const crushingArea = createWorkshopArea('crushing-workshop', 'Á†¥Á¢éÂ∑•ÊÆµ', 
                new THREE.Vector3(-25, 0, -15), new THREE.Vector3(18, 15), 0xffaa00);
            
            // Á≤âÁ£®Â∑•ÊÆµÂå∫Âüü  
            const grindingArea = createWorkshopArea('grinding-workshop', 'Á≤âÁ£®Â∑•ÊÆµ',
                new THREE.Vector3(0, 0, -15), new THREE.Vector3(20, 15), 0x00aaff);
            
            // ÁÖÖÁÉßÂ∑•ÊÆµÂå∫Âüü
            const burningArea = createWorkshopArea('burning-workshop', 'ÁÖÖÁÉßÂ∑•ÊÆµ',
                new THREE.Vector3(25, 0, -5), new THREE.Vector3(18, 20), 0xff6600);

            scene.add(crushingArea, grindingArea, burningArea);
        }

        // ÂàõÂª∫Â∑•ÊÆµÂå∫ÂüüËæÖÂä©ÂáΩÊï∞
        function createWorkshopArea(id, name, position, size, color) {
            const workshopGroup = new THREE.Group();
            workshopGroup.userData = { id: id, name: name, type: 'workshop' };
            workshopGroup.position.copy(position);

            // Âú∞Èù¢Âå∫ÂüüÊ†áËØÜ
            const floorGeometry = new THREE.BoxGeometry(size.x, 0.2, size.z);
            const floorMaterial = new THREE.MeshLambertMaterial({ 
                color: color, 
                transparent: true, 
                opacity: 0.4 
            });
            const floor = new THREE.Mesh(floorGeometry, floorMaterial);
            floor.position.y = 0.1;
            workshopGroup.add(floor);

            // ËæπÁïåÂõ¥Ê†è
            const fenceHeight = 3;
            const fenceMaterial = new THREE.MeshLambertMaterial({ 
                color: color, 
                transparent: true, 
                opacity: 0.6 
            });

            // ÂõõÈù¢Âõ¥Ê†è
            const fences = [
                { pos: [0, fenceHeight/2, size.z/2], size: [size.x, fenceHeight, 0.1] }, // Ââç
                { pos: [0, fenceHeight/2, -size.z/2], size: [size.x, fenceHeight, 0.1] }, // Âêé
                { pos: [size.x/2, fenceHeight/2, 0], size: [0.1, fenceHeight, size.z] }, // Âè≥
                { pos: [-size.x/2, fenceHeight/2, 0], size: [0.1, fenceHeight, size.z] }, // Â∑¶
            ];

            fences.forEach(fence => {
                const fenceGeometry = new THREE.BoxGeometry(...fence.size);
                const fenceMesh = new THREE.Mesh(fenceGeometry, fenceMaterial);
                fenceMesh.position.set(...fence.pos);
                workshopGroup.add(fenceMesh);
            });

            // Â∑•ÊÆµÊ†áËØÜÁâå
            const signGeometry = new THREE.BoxGeometry(6, 2, 0.1);
            const signMaterial = new THREE.MeshLambertMaterial({ color: 0xffffff });
            const sign = new THREE.Mesh(signGeometry, signMaterial);
            sign.position.set(0, fenceHeight + 1, -size.z/2 - 0.5);

            // Ê∑ªÂä†Â∑•ÊÆµÂêçÁß∞ÊñáÂ≠ó
            const canvas = document.createElement('canvas');
            canvas.width = 256;
            canvas.height = 64;
            const context = canvas.getContext('2d');
            context.fillStyle = color === 0xffaa00 ? '#ff8800' : 
                               color === 0x00aaff ? '#0088ff' : '#ff4400';
            context.font = 'bold 32px Arial';
            context.textAlign = 'center';
            context.fillText(name, 128, 42);
            
            const texture = new THREE.CanvasTexture(canvas);
            const textMaterial = new THREE.MeshLambertMaterial({ map: texture });
            const textSign = new THREE.Mesh(signGeometry, textMaterial);
            textSign.position.set(0, fenceHeight + 1, -size.z/2 - 0.4);
            
            workshopGroup.add(sign, textSign);

            return workshopGroup;
        }

        // ÂàõÂª∫ËÆæÂ§á
        function createEquipment() {
            // È¢öÂºèÁ†¥Á¢éÊú∫
            const crusher = createCrusher();
            scene.add(crusher);

            // ÁöÆÂ∏¶ËæìÈÄÅÊú∫
            const conveyor = createConveyor();
            scene.add(conveyor);

            // ÁêÉÁ£®Êú∫
            const ballMill = createBallMill();
            scene.add(ballMill);

            // ÈÄâÁ≤âÊú∫
            const separator = createSeparator();
            scene.add(separator);

            // ÂõûËΩ¨Á™ë
            const rotaryKiln = createRotaryKiln();
            scene.add(rotaryKiln);
        }

        // ÂàõÂª∫È¢öÂºèÁ†¥Á¢éÊú∫
        function createCrusher() {
            const crusherGroup = new THREE.Group();
            crusherGroup.userData = { id: 'crusher-1', name: 'È¢öÂºèÁ†¥Á¢éÊú∫', type: 'equipment' };
            crusherGroup.position.set(-25, 0, -10);

            // ‰∏ª‰Ωì
            const bodyGeometry = new THREE.BoxGeometry(6, 4, 4);
            const bodyMaterial = new THREE.MeshLambertMaterial({ color: 0x666666 });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.position.set(0, 2, 0);
            body.castShadow = true;
            crusherGroup.add(body);

            // ËøõÊñôÂè£
            const inletGeometry = new THREE.ConeGeometry(2, 3, 8);
            const inletMaterial = new THREE.MeshLambertMaterial({ color: 0x555555 });
            const inlet = new THREE.Mesh(inletGeometry, inletMaterial);
            inlet.position.set(0, 5.5, 0);
            crusherGroup.add(inlet);

            // Âü∫Á°Ä
            const baseGeometry = new THREE.BoxGeometry(8, 1, 6);
            const baseMaterial = new THREE.MeshLambertMaterial({ color: 0x444444 });
            const base = new THREE.Mesh(baseGeometry, baseMaterial);
            base.position.set(0, 0.5, 0);
            crusherGroup.add(base);

            return crusherGroup;
        }

        // ÂàõÂª∫ÁöÆÂ∏¶ËæìÈÄÅÊú∫
        function createConveyor() {
            const conveyorGroup = new THREE.Group();
            conveyorGroup.userData = { id: 'conveyor-1', name: 'ÁöÆÂ∏¶ËæìÈÄÅÊú∫', type: 'equipment' };
            conveyorGroup.position.set(-15, 0, -10);

            // ÁöÆÂ∏¶
            const beltGeometry = new THREE.BoxGeometry(12, 0.3, 1.2);
            const beltMaterial = new THREE.MeshLambertMaterial({ color: 0x222222 });
            const belt = new THREE.Mesh(beltGeometry, beltMaterial);
            belt.position.set(0, 1.5, 0);
            conveyorGroup.add(belt);

            // ÊîØÊíëÊû∂
            for (let i = -5; i <= 5; i += 2.5) {
                const supportGeometry = new THREE.BoxGeometry(0.2, 3, 0.2);
                const supportMaterial = new THREE.MeshLambertMaterial({ color: 0x555555 });
                const support = new THREE.Mesh(supportGeometry, supportMaterial);
                support.position.set(i, 1.5, 0.7);
                conveyorGroup.add(support);
                
                const support2 = support.clone();
                support2.position.z = -0.7;
                conveyorGroup.add(support2);
            }

            return conveyorGroup;
        }

        // ÂàõÂª∫ÁêÉÁ£®Êú∫
        function createBallMill() {
            const millGroup = new THREE.Group();
            millGroup.userData = { id: 'ball-mill', name: 'ÁêÉÁ£®Êú∫', type: 'equipment' };
            millGroup.position.set(0, 0, -10);

            // ‰∏ªÁ≠í‰Ωì
            const cylinderGeometry = new THREE.CylinderGeometry(3.5, 3.5, 10, 20);
            const cylinderMaterial = new THREE.MeshLambertMaterial({ color: 0xffdd44 });
            const cylinder = new THREE.Mesh(cylinderGeometry, cylinderMaterial);
            cylinder.rotation.z = Math.PI / 2;
            cylinder.position.set(0, 3.5, 0);
            cylinder.castShadow = true;
            millGroup.add(cylinder);

            // ÊîØÊíëÂ∫ß
            const support1Geometry = new THREE.BoxGeometry(2, 7, 3);
            const supportMaterial = new THREE.MeshLambertMaterial({ color: 0x555555 });
            const support1 = new THREE.Mesh(support1Geometry, supportMaterial);
            support1.position.set(-4, 3.5, 0);
            millGroup.add(support1);

            const support2 = support1.clone();
            support2.position.x = 4;
            millGroup.add(support2);

            // Á´ØÁõñ
            const endCapGeometry = new THREE.CylinderGeometry(3.5, 3.5, 0.5, 20);
            const endCapMaterial = new THREE.MeshLambertMaterial({ color: 0x444444 });
            const endCap1 = new THREE.Mesh(endCapGeometry, endCapMaterial);
            endCap1.rotation.z = Math.PI / 2;
            endCap1.position.set(-5.25, 3.5, 0);
            millGroup.add(endCap1);

            const endCap2 = endCap1.clone();
            endCap2.position.x = 5.25;
            millGroup.add(endCap2);

            return millGroup;
        }

        // ÂàõÂª∫ÈÄâÁ≤âÊú∫
        function createSeparator() {
            const separatorGroup = new THREE.Group();
            separatorGroup.userData = { id: 'separator', name: 'ÈÄâÁ≤âÊú∫', type: 'equipment' };
            separatorGroup.position.set(10, 0, -10);

            // ‰∏ª‰ΩìÂúÜÊü±
            const bodyGeometry = new THREE.CylinderGeometry(2, 2.5, 6, 12);
            const bodyMaterial = new THREE.MeshLambertMaterial({ color: 0x777777 });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.position.set(0, 3, 0);
            body.castShadow = true;
            separatorGroup.add(body);

            // È°∂ÈÉ®Èî•‰Ωì
            const topGeometry = new THREE.ConeGeometry(2, 2, 12);
            const topMaterial = new THREE.MeshLambertMaterial({ color: 0x666666 });
            const top = new THREE.Mesh(topGeometry, topMaterial);
            top.position.set(0, 7, 0);
            separatorGroup.add(top);

            // ËøõÊñôÁÆ°
            const pipeGeometry = new THREE.CylinderGeometry(0.5, 0.5, 3, 8);
            const pipeMaterial = new THREE.MeshLambertMaterial({ color: 0x555555 });
            const pipe = new THREE.Mesh(pipeGeometry, pipeMaterial);
            pipe.position.set(0, 8.5, 0);
            separatorGroup.add(pipe);

            return separatorGroup;
        }

        // ÂàõÂª∫ÂõûËΩ¨Á™ë
        function createRotaryKiln() {
            const kilnGroup = new THREE.Group();
            kilnGroup.userData = { id: 'rotary-kiln', name: 'ÂõûËΩ¨Á™ë', type: 'equipment' };
            kilnGroup.position.set(25, 0, 0);

            // ‰∏ªÁ≠í‰Ωì
            const kilnGeometry = new THREE.CylinderGeometry(2.5, 3, 15, 20);
            const kilnMaterial = new THREE.MeshLambertMaterial({ color: 0x888888 });
            const kiln = new THREE.Mesh(kilnGeometry, kilnMaterial);
            kiln.rotation.z = Math.PI / 2;
            kiln.rotation.x = 0.1; // Á®çÂæÆÂÄæÊñú
            kiln.position.set(0, 3, 0);
            kiln.castShadow = true;
            kilnGroup.add(kiln);

            // ÊîØÊíëËΩÆ
            for (let i = 0; i < 4; i++) {
                const wheelGeometry = new THREE.CylinderGeometry(0.8, 0.8, 0.5, 12);
                const wheelMaterial = new THREE.MeshLambertMaterial({ color: 0x333333 });
                const wheel = new THREE.Mesh(wheelGeometry, wheelMaterial);
                wheel.position.set(-6 + i * 4, 0.8, 0);
                kilnGroup.add(wheel);
            }

            // Á™ëÂ§¥ÁΩ©
            const hoodGeometry = new THREE.CylinderGeometry(3.5, 3, 4, 12);
            const hoodMaterial = new THREE.MeshLambertMaterial({ color: 0x666666 });
            const hood = new THREE.Mesh(hoodGeometry, hoodMaterial);
            hood.rotation.z = Math.PI / 2;
            hood.position.set(9, 3, 0);
            kilnGroup.add(hood);

            return kilnGroup;
        }

        // ÂàõÂª∫Â≠êÈÉ®‰ª∂
        function createComponents() {
            // Á†¥Á¢éÊú∫ÁîµÊú∫
            const crusherMotor = createMotor('crusher-motor', 'Á†¥Á¢éÊú∫ÁîµÊú∫', 
                new THREE.Vector3(-28, 2, -8), 0xff4444);
            scene.add(crusherMotor);

            // Á†¥Á¢éÊú∫ËΩ¥Êâø
            const crusherBearing = createBearing('crusher-bearing', 'Á†¥Á¢éÊú∫ËΩ¥Êâø', 
                new THREE.Vector3(-22, 3, -10));
            scene.add(crusherBearing);

            // ÁêÉÁ£®Êú∫‰∏ªÁîµÊú∫
            const millMotor = createMotor('mill-motor', 'ÁêÉÁ£®Êú∫‰∏ªÁîµÊú∫', 
                new THREE.Vector3(-6, 1, -8), 0x4444ff);
            scene.add(millMotor);

            // ÁêÉÁ£®Êú∫ÂáèÈÄüÂô®
            const gearbox = createGearbox('mill-gearbox', 'ÁêÉÁ£®Êú∫ÂáèÈÄüÂô®', 
                new THREE.Vector3(-3, 2, -10));
            scene.add(gearbox);

            // ÂõûËΩ¨Á™ëÁáÉÁÉßÂô®
            const burner = createBurner('kiln-burner', 'ÂõûËΩ¨Á™ëÁáÉÁÉßÂô®', 
                new THREE.Vector3(32, 3, 0));
            scene.add(burner);

            // ÂõûËΩ¨Á™ëÁ≠í‰ΩìÔºà‰Ωú‰∏∫Â≠êÈÉ®‰ª∂Ê†áËØÜÔºâ
            const cylinder = createKilnCylinder('kiln-cylinder', 'Á™ëÁ≠í‰Ωì', 
                new THREE.Vector3(25, 3, 0));
            scene.add(cylinder);
        }

        // ÂàõÂª∫ÁîµÊú∫Â≠êÈÉ®‰ª∂
        function createMotor(id, name, position, color = 0x4444ff) {
            const motorGroup = new THREE.Group();
            motorGroup.userData = { id: id, name: name, type: 'component' };
            motorGroup.position.copy(position);

            const bodyGeometry = new THREE.CylinderGeometry(0.8, 0.8, 2, 12);
            const bodyMaterial = new THREE.MeshLambertMaterial({ color: color });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.castShadow = true;
            motorGroup.add(body);

            // Êé•Á∫øÁõí
            const boxGeometry = new THREE.BoxGeometry(0.5, 0.5, 0.3);
            const boxMaterial = new THREE.MeshLambertMaterial({ color: 0x333333 });
            const box = new THREE.Mesh(boxGeometry, boxMaterial);
            box.position.set(0.6, 0, 0);
            motorGroup.add(box);

            return motorGroup;
        }

        // ÂàõÂª∫ËΩ¥ÊâøÂ≠êÈÉ®‰ª∂
        function createBearing(id, name, position) {
            const bearingGroup = new THREE.Group();
            bearingGroup.userData = { id: id, name: name, type: 'component' };
            bearingGroup.position.copy(position);

            const bearingGeometry = new THREE.CylinderGeometry(0.5, 0.5, 0.8, 16);
            const bearingMaterial = new THREE.MeshLambertMaterial({ color: 0x888888 });
            const bearing = new THREE.Mesh(bearingGeometry, bearingMaterial);
            bearing.rotation.z = Math.PI / 2;
            bearingGroup.add(bearing);

            return bearingGroup;
        }

        // ÂàõÂª∫ÂáèÈÄüÂô®Â≠êÈÉ®‰ª∂
        function createGearbox(id, name, position) {
            const gearboxGroup = new THREE.Group();
            gearboxGroup.userData = { id: id, name: name, type: 'component' };
            gearboxGroup.position.copy(position);

            const bodyGeometry = new THREE.BoxGeometry(2, 1.5, 1.5);
            const bodyMaterial = new THREE.MeshLambertMaterial({ color: 0x555555 });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.castShadow = true;
            gearboxGroup.add(body);

            return gearboxGroup;
        }

        // ÂàõÂª∫ÁáÉÁÉßÂô®Â≠êÈÉ®‰ª∂
        function createBurner(id, name, position) {
            const burnerGroup = new THREE.Group();
            burnerGroup.userData = { id: id, name: name, type: 'component' };
            burnerGroup.position.copy(position);

            const nozzleGeometry = new THREE.CylinderGeometry(0.3, 0.5, 2, 8);
            const nozzleMaterial = new THREE.MeshLambertMaterial({ color: 0xff6600 });
            const nozzle = new THREE.Mesh(nozzleGeometry, nozzleMaterial);
            nozzle.rotation.z = Math.PI / 2;
            burnerGroup.add(nozzle);

            // ÁÅ´ÁÑ∞ÊïàÊûúÔºàÁî®Ê©ôËâ≤ÁêÉ‰ΩìÊ®°ÊãüÔºâ
            const flameGeometry = new THREE.SphereGeometry(0.8, 8, 6);
            const flameMaterial = new THREE.MeshLambertMaterial({ 
                color: 0xff3300, 
                transparent: true, 
                opacity: 0.7 
            });
            const flame = new THREE.Mesh(flameGeometry, flameMaterial);
            flame.position.x = 1.5;
            burnerGroup.add(flame);

            return burnerGroup;
        }

        // ÂàõÂª∫Á™ëÁ≠í‰ΩìÊ†áËØÜ
        function createKilnCylinder(id, name, position) {
            const cylinderGroup = new THREE.Group();
            cylinderGroup.userData = { id: id, name: name, type: 'component' };
            cylinderGroup.position.copy(position);

            // ÂàõÂª∫‰∏Ä‰∏™ÈÄèÊòéÁöÑÂúÜÁéØÊù•Ê†áËØÜÁ≠í‰Ωì
            const ringGeometry = new THREE.TorusGeometry(3, 0.2, 8, 16);
            const ringMaterial = new THREE.MeshLambertMaterial({ 
                color: 0x00ff00, 
                transparent: true, 
                opacity: 0.6 
            });
            const ring = new THREE.Mesh(ringGeometry, ringMaterial);
            ring.rotation.y = Math.PI / 2;
            cylinderGroup.add(ring);

            return cylinderGroup;
        }

        // ÂàõÂª∫Âü∫Á°ÄËÆæÊñΩÔºàÁÆ°ÈÅì„ÄÅËæìÈÄÅÂ∏¶Á≠âÔºâ
        function createInfrastructure() {
            // Â∑•ÊÆµÈó¥ËøûÊé•ÁÆ°ÈÅì
            createPipeline(new THREE.Vector3(-15, 2, -10), new THREE.Vector3(-5, 2, -10), 0x555555);
            createPipeline(new THREE.Vector3(5, 2, -10), new THREE.Vector3(15, 2, -10), 0x555555);
            createPipeline(new THREE.Vector3(15, 4, -5), new THREE.Vector3(25, 4, -2), 0x555555);
            
            // Áâ©ÊñôÊµÅÂêëÊåáÁ§∫ÁÆ≠Â§¥
            createFlowArrow(new THREE.Vector3(-10, 3, -10), new THREE.Vector3(1, 0, 0));
            createFlowArrow(new THREE.Vector3(10, 3, -10), new THREE.Vector3(1, 0, 0));
        }

        // ÂàõÂª∫ÁÆ°ÈÅì
        function createPipeline(start, end, color) {
            const direction = new THREE.Vector3().subVectors(end, start);
            const length = direction.length();
            const pipeGeometry = new THREE.CylinderGeometry(0.3, 0.3, length, 8);
            const pipeMaterial = new THREE.MeshLambertMaterial({ color: color });
            const pipe = new THREE.Mesh(pipeGeometry, pipeMaterial);
            
            pipe.position.copy(start).add(end).multiplyScalar(0.5);
            pipe.lookAt(end);
            pipe.rotateX(Math.PI / 2);
            pipe.userData = { name: 'ËæìÈÄÅÁÆ°ÈÅì', type: 'infrastructure', selectable: false };
            
            scene.add(pipe);
        }

        // ÂàõÂª∫Áâ©ÊñôÊµÅÂêëÁÆ≠Â§¥
        function createFlowArrow(position, direction) {
            const arrowGroup = new THREE.Group();
            arrowGroup.position.copy(position);
            arrowGroup.userData = { name: 'Áâ©ÊñôÊµÅÂêë', type: 'infrastructure', selectable: false };

            // ÁÆ≠Â§¥‰∏ª‰Ωì
            const arrowGeometry = new THREE.ConeGeometry(0.5, 2, 6);
            const arrowMaterial = new THREE.MeshLambertMaterial({ 
                color: 0x00ff00,
                transparent: true,
                opacity: 0.8 
            });
            const arrow = new THREE.Mesh(arrowGeometry, arrowMaterial);
            arrow.rotation.z = -Math.PI / 2; // Ê∞¥Âπ≥ÊåáÂêë
            
            // Ê†πÊçÆÊñπÂêëË∞ÉÊï¥ÁÆ≠Â§¥ÊúùÂêë
            if (direction.x < 0) arrow.rotation.z = Math.PI / 2;
            if (direction.z > 0) arrow.rotation.x = Math.PI / 2;
            if (direction.z < 0) arrow.rotation.x = -Math.PI / 2;
            
            arrowGroup.add(arrow);

            // Ê∑ªÂä†ÊµÅÂä®Âä®Áîª
            arrowGroup.userData.animate = (deltaTime) => {
                arrow.material.opacity = 0.5 + 0.3 * Math.sin(Date.now() * 0.005);
            };

            scene.add(arrowGroup);
        }

        // ‰øùÂ≠òÊâÄÊúâÊ®°ÂûãÁöÑÂéüÂßãÈ¢úËâ≤
        function saveOriginalColors() {
            scene.traverse((child) => {
                if (child instanceof THREE.Mesh && child.material && child.material.color) {
                    child.userData.originalColor = child.material.color.getHex();
                }
            });
        }

        // Â∫îÁî®ÂëäË≠¶ÊïàÊûúÂà∞3DÊ®°Âûã
        function apply3DAlarmEffects() {
            // Ëé∑ÂèñÊâÄÊúâÂëäË≠¶ËäÇÁÇπ
            const alarmNodes = document.querySelectorAll('.tree-node-content[class*="alarm"]');
            
            alarmNodes.forEach(node => {
                const nodeId = node.dataset.id;
                const alarmLevel = node.classList.contains('alarm-high') ? 'high' :
                                 node.classList.contains('alarm-medium') ? 'medium' : 'low';
                
                // Âú®3DÂú∫ÊôØ‰∏≠ÊâæÂà∞ÂØπÂ∫îÁöÑÂØπË±°
                const object3D = findObjectById(nodeId);
                if (object3D) {
                    applyAlarmMaterial(object3D, alarmLevel);
                }
            });
        }

        // Âú®Âú∫ÊôØ‰∏≠Êü•ÊâæÊåáÂÆöIDÁöÑÂØπË±°
        function findObjectById(id) {
            let foundObject = null;
            
            scene.traverse((child) => {
                if (child.userData && child.userData.id === id) {
                    foundObject = child;
                }
            });
            
            return foundObject;
        }

        // Â∫îÁî®ÂëäË≠¶ÊùêË¥®ÊïàÊûú
        function applyAlarmMaterial(object, alarmLevel) {
            const colors = {
                high: 0xff0000,    // Á∫¢Ëâ≤
                medium: 0xff8800,  // Ê©ôËâ≤  
                low: 0xffff00      // ÈªÑËâ≤
            };
            
            const color = colors[alarmLevel] || 0x666666;
            
            object.traverse((child) => {
                if (child instanceof THREE.Mesh) {
                    // Â≠òÂÇ®ÂéüÂßãÈ¢úËâ≤
                    if (!child.userData.originalColor) {
                        child.userData.originalColor = child.material.color.getHex();
                    }
                    
                    // ÂàõÂª∫Èó™ÁÉÅÊùêË¥®
                    const originalMaterial = child.material;
                    const alarmMaterial = new THREE.MeshLambertMaterial({
                        color: color,
                        transparent: true,
                        opacity: 0.8
                    });
                    
                    // Â≠òÂÇ®ÂéüÂßãÊùêË¥®
                    child.userData.originalMaterial = originalMaterial;
                    child.userData.alarmMaterial = alarmMaterial;
                    child.userData.isBlinking = true;
                    child.userData.blinkPhase = 0;
                }
            });
        }

        // Êõ¥Êñ∞Èó™ÁÉÅÂä®Áîª
        function updateBlinkingEffects() {
            scene.traverse((child) => {
                if (child instanceof THREE.Mesh && child.userData.isBlinking) {
                    child.userData.blinkPhase += 0.1;
                    const alpha = (Math.sin(child.userData.blinkPhase) + 1) * 0.5;
                    
                    if (alpha > 0.5) {
                        child.material = child.userData.alarmMaterial;
                    } else {
                        child.material = child.userData.originalMaterial;
                    }
                }
            });
        }

        // Ê∑ªÂä†ËÆæÂ§áËøêËΩ¨Âä®Áîª
        function addEquipmentAnimations() {
            // ÁêÉÁ£®Êú∫ÊóãËΩ¨Âä®Áîª
            const ballMill = findObjectById('ball-mill');
            if (ballMill) {
                ballMill.userData.animate = (deltaTime) => {
                    ballMill.children[0].rotation.x += deltaTime * 0.5; // ‰∏ªÁ≠í‰ΩìÊóãËΩ¨
                };
            }

            // ÂõûËΩ¨Á™ëÊóãËΩ¨Âä®Áîª
            const rotaryKiln = findObjectById('rotary-kiln');
            if (rotaryKiln) {
                rotaryKiln.userData.animate = (deltaTime) => {
                    rotaryKiln.children[0].rotation.x += deltaTime * 0.2; // Á™ë‰ΩìÁºìÊÖ¢ÊóãËΩ¨
                };
            }

            // ÁöÆÂ∏¶ËæìÈÄÅÊú∫Âä®Áîª
            const conveyor = findObjectById('conveyor-1');
            if (conveyor) {
                conveyor.userData.animate = (deltaTime) => {
                    // ÂèØ‰ª•Ê∑ªÂä†ÁöÆÂ∏¶ËøêÂä®ÊïàÊûú
                    const belt = conveyor.children[0];
                    if (belt.material.map) {
                        belt.material.map.offset.x += deltaTime * 0.5;
                    }
                };
            }

            // ÁáÉÁÉßÂô®ÁÅ´ÁÑ∞Âä®Áîª
            const burner = findObjectById('kiln-burner');
            if (burner) {
                burner.userData.animate = (deltaTime) => {
                    const flame = burner.children[1]; // ÁÅ´ÁÑ∞ÁêÉ‰Ωì
                    if (flame) {
                        flame.scale.setScalar(1 + Math.sin(Date.now() * 0.01) * 0.2);
                        flame.material.opacity = 0.5 + Math.sin(Date.now() * 0.02) * 0.2;
                    }
                };
            }
        }

        // Êõ¥Êñ∞ËÆæÂ§áÂä®Áîª
        function updateEquipmentAnimations(deltaTime) {
            scene.traverse((child) => {
                if (child.userData && typeof child.userData.animate === 'function') {
                    child.userData.animate(deltaTime);
                }
            });
        }

        // Ê†πÊçÆËøêË°åÊ®°ÂºèÊõ¥Êñ∞3DÊ®°ÂûãÊòæÁ§∫
        function update3DModelForMode(mode) {
            scene.traverse((child) => {
                if (child.userData && child.userData.type) {
                    const originalColor = child.userData.originalColor;
                    
                    if (child instanceof THREE.Mesh) {
                        switch(mode) {
                            case 'realtime':
                                // ÂÆûÊó∂Ê®°ÂºèÔºöÊÅ¢Â§çÊ≠£Â∏∏È¢úËâ≤ÔºåÂêØÁî®Âä®Áîª
                                if (originalColor) {
                                    child.material.color.setHex(originalColor);
                                }
                                child.userData.animationEnabled = true;
                                break;
                            case 'history':
                                // ÂéÜÂè≤Ê®°ÂºèÔºöÁ®çÂæÆÊöóÂåñÔºåÁ¶ÅÁî®Âä®Áîª
                                if (originalColor) {
                                    child.material.color.setHex(originalColor);
                                    child.material.color.multiplyScalar(0.7);
                                }
                                child.userData.animationEnabled = false;
                                break;
                            case 'simulation':
                                // Ê®°ÊãüÊ®°ÂºèÔºöËìùËâ≤Ë∞ÉÔºåÂêØÁî®È¢ÑÊµãÂä®Áîª
                                if (originalColor) {
                                    child.material.color.setHex(originalColor);
                                    child.material.color.lerp(new THREE.Color(0x0088ff), 0.3);
                                }
                                child.userData.animationEnabled = true;
                                break;
                        }
                    }
                }
            });
        }

        // ÈáçÊñ∞ÁîüÊàê3DÂ∑•ÂéÇÊ®°Âûã
        function regenerateFactoryModel() {
            // Ê∏ÖÈô§Áé∞ÊúâÊ®°Âûã
            const objectsToRemove = [];
            scene.children.forEach(child => {
                if (child instanceof THREE.Mesh || child instanceof THREE.Group) {
                    if (child.userData && child.userData.type !== 'light') {
                        objectsToRemove.push(child);
                    }
                }
            });
            objectsToRemove.forEach(obj => scene.remove(obj));

            // ÈáçÊñ∞ÂàõÂª∫Ê®°Âûã
            createFactoryModel();
            
            // ÈáçÊñ∞Â∫îÁî®ÊïàÊûú
            setTimeout(() => {
                saveOriginalColors();
                apply3DAlarmEffects();
                addEquipmentAnimations();
                update3DModelForMode(currentMode);
            }, 100);
        }

        // ÈáçÁΩÆÁõ∏Êú∫Âà∞ÊúÄ‰Ω≥ËßÇÁúãËßíÂ∫¶
        function resetCameraView() {
            if (camera && controls) {
                // Âπ≥ÊªëÂä®ÁîªÂà∞ÊúÄ‰Ω≥‰ΩçÁΩÆ
                animateCamera(
                    camera.position,
                    new THREE.Vector3(0, 25, 30),
                    new THREE.Vector3(0, 0, -10)
                );
            }
        }

        // ËµÑ‰∫ßÂ±ÇÁ∫ßÁªìÊûÑÂÆö‰πâ
        const assetHierarchy = {
            'cement-factory': {
                type: 'factory',
                name: 'Ê∞¥Ê≥•Â∑•ÂéÇ',
                children: ['crushing-workshop', 'grinding-workshop', 'burning-workshop']
            },
            'crushing-workshop': {
                type: 'workshop',
                name: 'Á†¥Á¢éÂ∑•ÊÆµ',
                parent: 'cement-factory',
                children: ['crusher-1', 'conveyor-1']
            },
            'grinding-workshop': {
                type: 'workshop',
                name: 'Á≤âÁ£®Â∑•ÊÆµ',
                parent: 'cement-factory',
                children: ['ball-mill', 'separator']
            },
            'burning-workshop': {
                type: 'workshop',
                name: 'ÁÖÖÁÉßÂ∑•ÊÆµ',
                parent: 'cement-factory',
                children: ['rotary-kiln']
            },
            'crusher-1': {
                type: 'equipment',
                name: 'È¢öÂºèÁ†¥Á¢éÊú∫',
                parent: 'crushing-workshop',
                children: ['crusher-motor', 'crusher-bearing']
            },
            'conveyor-1': {
                type: 'equipment',
                name: 'ÁöÆÂ∏¶ËæìÈÄÅÊú∫',
                parent: 'crushing-workshop',
                children: []
            },
            'ball-mill': {
                type: 'equipment',
                name: 'ÁêÉÁ£®Êú∫',
                parent: 'grinding-workshop',
                children: ['mill-motor', 'mill-gearbox']
            },
            'separator': {
                type: 'equipment',
                name: 'ÈÄâÁ≤âÊú∫',
                parent: 'grinding-workshop',
                children: []
            },
            'rotary-kiln': {
                type: 'equipment',
                name: 'ÂõûËΩ¨Á™ë',
                parent: 'burning-workshop',
                children: ['kiln-burner', 'kiln-cylinder']
            },
            'crusher-motor': {
                type: 'component',
                name: 'Á†¥Á¢éÊú∫ÁîµÊú∫',
                parent: 'crusher-1',
                children: []
            },
            'crusher-bearing': {
                type: 'component',
                name: 'Á†¥Á¢éÊú∫ËΩ¥Êâø',
                parent: 'crusher-1',
                children: []
            },
            'mill-motor': {
                type: 'component',
                name: 'ÁêÉÁ£®Êú∫‰∏ªÁîµÊú∫',
                parent: 'ball-mill',
                children: []
            },
            'mill-gearbox': {
                type: 'component',
                name: 'ÁêÉÁ£®Êú∫ÂáèÈÄüÂô®',
                parent: 'ball-mill',
                children: []
            },
            'kiln-burner': {
                type: 'component',
                name: 'ÂõûËΩ¨Á™ëÁáÉÁÉßÂô®',
                parent: 'rotary-kiln',
                children: []
            },
            'kiln-cylinder': {
                type: 'component',
                name: 'Á™ëÁ≠í‰Ωì',
                parent: 'rotary-kiln',
                children: []
            }
        };

        // 3DËßÜÂõæ‰∏ãÈíª
        function drillDown3D(nodeId) {
            if (!assetHierarchy[nodeId]) return;
            
            const node = assetHierarchy[nodeId];
            console.log('3D‰∏ãÈíªÂà∞:', node.name);
            
            // Êõ¥Êñ∞‰∏ãÈíªË∑ØÂæÑ
            if (drillPath.length === 0 || drillPath[drillPath.length - 1] !== nodeId) {
                // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÊõ¥‰∏äÁ∫ßËäÇÁÇπÔºåÂõûÈÄÄÂà∞ËØ•Â±ÇÁ∫ß
                const nodeIndex = drillPath.indexOf(nodeId);
                if (nodeIndex >= 0) {
                    drillPath = drillPath.slice(0, nodeIndex + 1);
                } else {
                    drillPath.push(nodeId);
                }
            }
            
            // Êõ¥Êñ∞ÈÄâ‰∏≠ËäÇÁÇπ
            selectedNode = { id: nodeId, name: node.name, type: node.type };
            currentDrillLevel = node.type;
            
            // Êõ¥Êñ∞Èù¢ÂåÖÂ±ë
            updateBreadcrumb();
            
            // Êõ¥Êñ∞ÊåáÊ†áÈù¢Êùø
            updateMetricsForNode(nodeId);
            
            // Êõ¥Êñ∞3DËßÜÂõæ
            update3DViewForDrillDown(nodeId);
            
            // Êõ¥Êñ∞Â∑¶‰æßÊ†ëÈÄâ‰∏≠Áä∂ÊÄÅ
            updateTreeSelection(nodeId);
            
            // Êõ¥Êñ∞‰∏ãÈíªÂ±ÇÁ∫ßÊåáÁ§∫Âô®
            updateDrillLevelIndicator(nodeId);
        }

        // 2DËßÜÂõæ‰∏ãÈíª
        function drillDown2D(nodeId) {
            if (!assetHierarchy[nodeId]) return;
            
            const node = assetHierarchy[nodeId];
            console.log('2D‰∏ãÈíªÂà∞:', node.name);
            
            // Êõ¥Êñ∞‰∏ãÈíªË∑ØÂæÑ
            if (drillPath.length === 0 || drillPath[drillPath.length - 1] !== nodeId) {
                // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÊõ¥‰∏äÁ∫ßËäÇÁÇπÔºåÂõûÈÄÄÂà∞ËØ•Â±ÇÁ∫ß
                const nodeIndex = drillPath.indexOf(nodeId);
                if (nodeIndex >= 0) {
                    drillPath = drillPath.slice(0, nodeIndex + 1);
                } else {
                    drillPath.push(nodeId);
                }
            }
            
            // Êõ¥Êñ∞ÈÄâ‰∏≠ËäÇÁÇπ
            selectedNode = { id: nodeId, name: node.name, type: node.type };
            currentDrillLevel = node.type;
            
            // Êõ¥Êñ∞Èù¢ÂåÖÂ±ë
            updateBreadcrumb();
            
            // Êõ¥Êñ∞ÊåáÊ†áÈù¢Êùø
            updateMetricsForNode(nodeId);
            
            // Êõ¥Êñ∞2DËßÜÂõæ
            update2DViewForDrillDown(nodeId);
            
            // Êõ¥Êñ∞Â∑¶‰æßÊ†ëÈÄâ‰∏≠Áä∂ÊÄÅ
            updateTreeSelection(nodeId);
            
            // Êõ¥Êñ∞‰∏ãÈíªÂ±ÇÁ∫ßÊåáÁ§∫Âô®
            updateDrillLevelIndicator(nodeId);
        }

        // Êõ¥Êñ∞3DËßÜÂõæ‰ª•ÈÄÇÂ∫î‰∏ãÈíª
        function update3DViewForDrillDown(nodeId) {
            const node = assetHierarchy[nodeId];
            
            // ÈöêËóèÂÖ∂‰ªñ‰∏çÁõ∏ÂÖ≥ÁöÑÂØπË±°
            scene.traverse((child) => {
                if (child.userData && child.userData.id) {
                    const childData = assetHierarchy[child.userData.id];
                    if (childData) {
                        // ÊòæÁ§∫ÈÄªËæëÔºöÊòæÁ§∫ÂΩìÂâçËäÇÁÇπÂèäÂÖ∂Â≠êËäÇÁÇπ
                        if (child.userData.id === nodeId || 
                            isChildOf(child.userData.id, nodeId) ||
                            isParentOf(child.userData.id, nodeId)) {
                            child.visible = true;
                        } else {
                            child.visible = false;
                        }
                    }
                }
            });
            
            // ËÅöÁÑ¶Âà∞ÁõÆÊ†áÂØπË±°
            focusOn3DNode(nodeId);
        }

        // Êõ¥Êñ∞2DËßÜÂõæ‰ª•ÈÄÇÂ∫î‰∏ãÈíª
        function update2DViewForDrillDown(nodeId) {
            const node = assetHierarchy[nodeId];
            
            if (node.type === 'factory') {
                // Â∑•ÂéÇÂ±ÇÁ∫ßÔºöÊòæÁ§∫ÊÄªËßà
                init2DView();
            } else if (node.type === 'workshop') {
                // Â∑•ÊÆµÂ±ÇÁ∫ßÔºöÁîüÊàêËØ¶ÁªÜÁöÑÂ∑•ÊÆµÂÜÖÈÉ®Â∏ÉÂ±Ä
                generate2DWorkshopDetail(nodeId);
            } else if (node.type === 'equipment') {
                // ËÆæÂ§áÂ±ÇÁ∫ßÔºöÁîüÊàêËÆæÂ§áËØ¶ÁªÜËßÜÂõæ
                generate2DEquipmentDetail(nodeId);
            } else if (node.type === 'component') {
                // ÈÉ®‰ª∂Â±ÇÁ∫ßÔºöÁîüÊàêÈÉ®‰ª∂ËØ¶ÁªÜËßÜÂõæ
                generate2DComponentDetail(nodeId);
            }
        }

        // Âà§Êñ≠ÊòØÂê¶‰∏∫Â≠êËäÇÁÇπ
        function isChildOf(childId, parentId) {
            const child = assetHierarchy[childId];
            if (!child) return false;
            
            let currentParent = child.parent;
            while (currentParent) {
                if (currentParent === parentId) return true;
                const parentNode = assetHierarchy[currentParent];
                currentParent = parentNode ? parentNode.parent : null;
            }
            return false;
        }

        // Âà§Êñ≠ÊòØÂê¶‰∏∫Áà∂ËäÇÁÇπ
        function isParentOf(parentId, childId) {
            return isChildOf(childId, parentId);
        }

        // Êõ¥Êñ∞Â∑¶‰æßÊ†ëÈÄâ‰∏≠Áä∂ÊÄÅ
        function updateTreeSelection(nodeId) {
            // ÁßªÈô§ÊâÄÊúâÈÄâ‰∏≠Áä∂ÊÄÅ
            document.querySelectorAll('.tree-node-content').forEach(node => {
                node.classList.remove('active');
            });
            
            // Ê∑ªÂä†ÂΩìÂâçÈÄâ‰∏≠Áä∂ÊÄÅ
            const treeNode = document.querySelector(`[data-id="${nodeId}"]`);
            if (treeNode) {
                treeNode.classList.add('active');
                
                // Â±ïÂºÄÂà∞ËØ•ËäÇÁÇπÁöÑË∑ØÂæÑ
                expandToNode(treeNode);
            }
        }
        
        // Â±ïÂºÄÂà∞ÊåáÂÆöËäÇÁÇπ
        function expandToNode(targetNode) {
            let parent = targetNode.parentElement;
            while (parent) {
                if (parent.classList && parent.classList.contains('tree-children')) {
                    parent.classList.add('expanded');
                    
                    // ÊâæÂà∞ÂØπÂ∫îÁöÑÂ±ïÂºÄÂõæÊ†áÂπ∂Ê†áËÆ∞‰∏∫Â±ïÂºÄ
                    const parentContent = parent.previousElementSibling;
                    if (parentContent) {
                        const expandIcon = parentContent.querySelector('.tree-expand-icon');
                        if (expandIcon && expandIcon.style.visibility !== 'hidden') {
                            expandIcon.classList.add('expanded');
                        }
                    }
                }
                parent = parent.parentElement;
            }
        }



         // Êõ¥Êñ∞‰∏ãÈíªÂ±ÇÁ∫ßÊåáÁ§∫Âô®
         function updateDrillLevelIndicator(nodeId) {
             const indicator = document.getElementById('drill-indicator');
             const node = assetHierarchy[nodeId];
             
             if (!indicator || !node) return;
             
             let levelText = '';
             switch (node.type) {
                 case 'factory':
                     levelText = 'Â∑•ÂéÇÊÄªËßà';
                     break;
                 case 'workshop':
                     levelText = `Â∑•ÊÆµËßÜÂõæÔºö${node.name}`;
                     break;
                 case 'equipment':
                     levelText = `ËÆæÂ§áËßÜÂõæÔºö${node.name}`;
                     break;
                 case 'component':
                     levelText = `ÈÉ®‰ª∂ËßÜÂõæÔºö${node.name}`;
                     break;
                 default:
                     levelText = 'Êú™Áü•Â±ÇÁ∫ß';
             }
             
             indicator.textContent = levelText;
         }

        // ÁîüÊàê2DÂ∑•ÊÆµËØ¶ÁªÜËßÜÂõæ
        function generate2DWorkshopDetail(workshopId) {
            const svg = document.getElementById('svg-canvas');
            const workshop = assetHierarchy[workshopId];
            
            let detailLayout = '';
            
            if (workshopId === 'crushing-workshop') {
                detailLayout = `
                    <defs>
                        <marker id="detail-arrow" markerWidth="8" markerHeight="6" 
                                refX="8" refY="3" orient="auto">
                            <polygon points="0 0, 8 3, 0 6" fill="#00ff88" />
                        </marker>
                    </defs>
                    <g transform="translate(50, 50)">
                        <rect x="0" y="0" width="800" height="600" fill="#554400" stroke="#ffaa00" stroke-width="3"/>
                        <text x="400" y="30" text-anchor="middle" fill="#fff" font-size="20">${workshop.name} - ËØ¶ÁªÜËßÜÂõæ</text>
                        
                        <!-- ÂéüÊñôÂÖ•Âè£ -->
                        <rect x="50" y="100" width="80" height="60" fill="#8b4513" stroke="#666" stroke-width="2"/>
                        <text x="90" y="135" text-anchor="middle" fill="#fff" font-size="12">ÂéüÊñô‰ªì</text>
                        
                        <!-- È¢öÂºèÁ†¥Á¢éÊú∫ËØ¶ÁªÜÁªìÊûÑ -->
                        <g class="equipment" data-id="crusher-1">
                            <rect x="200" y="80" width="120" height="100" fill="#666" stroke="#333" stroke-width="2"/>
                            <text x="260" y="100" text-anchor="middle" fill="#fff" font-size="14">È¢öÂºèÁ†¥Á¢éÊú∫</text>
                            
                            <!-- Á†¥Á¢éÊú∫ÈÉ®‰ª∂ -->
                            <circle cx="220" cy="140" r="15" fill="#ff4444" class="component" data-id="crusher-motor"/>
                            <text x="220" y="145" text-anchor="middle" fill="#fff" font-size="8">ÁîµÊú∫</text>
                            
                            <rect x="280" y="130" width="20" height="20" fill="#888" class="component" data-id="crusher-bearing"/>
                            <text x="290" y="155" text-anchor="middle" fill="#fff" font-size="8">ËΩ¥Êâø</text>
                        </g>
                        
                        <!-- ÁöÆÂ∏¶ËæìÈÄÅÊú∫ -->
                        <g class="equipment" data-id="conveyor-1">
                            <rect x="380" y="125" width="200" height="20" fill="#222" stroke="#444" stroke-width="1"/>
                            <text x="480" y="120" text-anchor="middle" fill="#ccc" font-size="12">ÁöÆÂ∏¶ËæìÈÄÅÊú∫</text>
                            
                            <!-- ÊîØÊíëÊû∂ -->
                            <rect x="390" y="145" width="5" height="30" fill="#555"/>
                            <rect x="430" y="145" width="5" height="30" fill="#555"/>
                            <rect x="470" y="145" width="5" height="30" fill="#555"/>
                            <rect x="510" y="145" width="5" height="30" fill="#555"/>
                            <rect x="550" y="145" width="5" height="30" fill="#555"/>
                        </g>
                        
                        <!-- Âá∫ÊñôÂè£ -->
                        <rect x="650" y="100" width="80" height="60" fill="#444" stroke="#666" stroke-width="2"/>
                        <text x="690" y="135" text-anchor="middle" fill="#fff" font-size="12">Âá∫ÊñôÂè£</text>
                        
                        <!-- Áâ©ÊñôÊµÅÂêë -->
                        <line x1="130" y1="130" x2="200" y2="130" stroke="#00ff88" stroke-width="3" marker-end="url(#detail-arrow)"/>
                        <line x1="320" y1="130" x2="380" y2="135" stroke="#00ff88" stroke-width="3" marker-end="url(#detail-arrow)"/>
                        <line x1="580" y1="135" x2="650" y2="130" stroke="#00ff88" stroke-width="3" marker-end="url(#detail-arrow)"/>
                        
                        <!-- ËøîÂõûÊåâÈíÆ -->
                        <g class="back-button" onclick="goBackLevel()" style="cursor: pointer;">
                            <rect x="20" y="20" width="60" height="25" fill="#0078d4" stroke="#005a9e" stroke-width="1" rx="3"/>
                            <text x="50" y="37" text-anchor="middle" fill="#fff" font-size="12">ËøîÂõû</text>
                        </g>
                    </g>
                `;
            } else if (workshopId === 'grinding-workshop') {
                detailLayout = `
                    <defs>
                        <marker id="detail-arrow" markerWidth="8" markerHeight="6" 
                                refX="8" refY="3" orient="auto">
                            <polygon points="0 0, 8 3, 0 6" fill="#00ff88" />
                        </marker>
                    </defs>
                    <g transform="translate(50, 50)">
                        <rect x="0" y="0" width="800" height="600" fill="#004455" stroke="#00aaff" stroke-width="3"/>
                        <text x="400" y="30" text-anchor="middle" fill="#fff" font-size="20">${workshop.name} - ËØ¶ÁªÜËßÜÂõæ</text>
                        
                        <!-- Êù•Êñô -->
                        <rect x="50" y="100" width="80" height="60" fill="#666" stroke="#888" stroke-width="2"/>
                        <text x="90" y="135" text-anchor="middle" fill="#fff" font-size="12">Á≤óÁ¢éÊñô</text>
                        
                        <!-- ÁêÉÁ£®Êú∫ËØ¶ÁªÜÁªìÊûÑ -->
                        <g class="equipment" data-id="ball-mill">
                            <ellipse cx="280" cy="140" rx="60" ry="30" fill="#ffdd44" stroke="#333" stroke-width="2"/>
                            <text x="280" y="115" text-anchor="middle" fill="#333" font-size="14">ÁêÉÁ£®Êú∫</text>
                            
                            <!-- ÁêÉÁ£®Êú∫ÈÉ®‰ª∂ -->
                            <circle cx="220" cy="140" r="12" fill="#4444ff" class="component" data-id="mill-motor"/>
                            <text x="220" y="165" text-anchor="middle" fill="#ccc" font-size="8">‰∏ªÁîµÊú∫</text>
                            
                            <rect x="330" y="130" width="20" height="20" fill="#555" class="component" data-id="mill-gearbox"/>
                            <text x="340" y="160" text-anchor="middle" fill="#ccc" font-size="8">ÂáèÈÄüÂô®</text>
                        </g>
                        
                        <!-- ÈÄâÁ≤âÊú∫ -->
                        <g class="equipment" data-id="separator">
                            <circle cx="500" cy="140" r="40" fill="#777" stroke="#333" stroke-width="2"/>
                            <text x="500" y="145" text-anchor="middle" fill="#fff" font-size="12">ÈÄâÁ≤âÊú∫</text>
                        </g>
                        
                        <!-- ÊàêÂìÅÂá∫Êñô -->
                        <rect x="620" y="100" width="80" height="60" fill="#444" stroke="#666" stroke-width="2"/>
                        <text x="660" y="135" text-anchor="middle" fill="#fff" font-size="12">ÁªÜÊñô</text>
                        
                        <!-- Áâ©ÊñôÊµÅÂêë -->
                        <line x1="130" y1="130" x2="220" y2="130" stroke="#00ff88" stroke-width="3" marker-end="url(#detail-arrow)"/>
                        <line x1="340" y1="140" x2="460" y2="140" stroke="#00ff88" stroke-width="3" marker-end="url(#detail-arrow)"/>
                        <line x1="540" y1="140" x2="620" y2="130" stroke="#00ff88" stroke-width="3" marker-end="url(#detail-arrow)"/>
                        
                        <!-- ËøîÊñôÊµÅ -->
                        <path d="M 480 180 Q 380 220, 260 180" stroke="#ffa500" stroke-width="2" 
                              fill="none" marker-end="url(#detail-arrow)" opacity="0.7"/>
                        <text x="380" y="230" text-anchor="middle" fill="#ffa500" font-size="10">ËøîÊñô</text>
                        
                        <!-- ËøîÂõûÊåâÈíÆ -->
                        <g class="back-button" onclick="goBackLevel()" style="cursor: pointer;">
                            <rect x="20" y="20" width="60" height="25" fill="#0078d4" stroke="#005a9e" stroke-width="1" rx="3"/>
                            <text x="50" y="37" text-anchor="middle" fill="#fff" font-size="12">ËøîÂõû</text>
                        </g>
                    </g>
                `;
            } else if (workshopId === 'burning-workshop') {
                detailLayout = `
                    <defs>
                        <marker id="detail-arrow" markerWidth="8" markerHeight="6" 
                                refX="8" refY="3" orient="auto">
                            <polygon points="0 0, 8 3, 0 6" fill="#00ff88" />
                        </marker>
                    </defs>
                    <g transform="translate(50, 50)">
                        <rect x="0" y="0" width="800" height="600" fill="#550022" stroke="#ff6600" stroke-width="3"/>
                        <text x="400" y="30" text-anchor="middle" fill="#fff" font-size="20">${workshop.name} - ËØ¶ÁªÜËßÜÂõæ</text>
                        
                        <!-- ÁîüÊñôÂÖ•Âè£ -->
                        <rect x="50" y="100" width="80" height="60" fill="#666" stroke="#888" stroke-width="2"/>
                        <text x="90" y="135" text-anchor="middle" fill="#fff" font-size="12">ÁîüÊñô</text>
                        
                        <!-- ÂõûËΩ¨Á™ëËØ¶ÁªÜÁªìÊûÑ -->
                        <g class="equipment" data-id="rotary-kiln">
                            <ellipse cx="400" cy="140" rx="150" ry="40" fill="#888" stroke="#333" stroke-width="2"/>
                            <text x="400" y="115" text-anchor="middle" fill="#fff" font-size="14">ÂõûËΩ¨Á™ë</text>
                            
                            <!-- ÁáÉÁÉßÂô® -->
                            <circle cx="520" cy="140" r="20" fill="#ff6600" class="component" data-id="kiln-burner">
                                <animate attributeName="fill" values="#ff6600;#ff3300;#ff6600" dur="1s" repeatCount="indefinite"/>
                            </circle>
                            <text x="520" y="170" text-anchor="middle" fill="#ccc" font-size="8">ÁáÉÁÉßÂô®</text>
                            
                            <!-- Á™ëÁ≠í‰ΩìÊ†áËØÜ -->
                            <rect x="300" y="125" width="200" height="30" fill="none" stroke="#00ff00" 
                                  stroke-width="2" stroke-dasharray="5,5" class="component" data-id="kiln-cylinder"/>
                            <text x="400" y="200" text-anchor="middle" fill="#00ff00" font-size="8">Á™ëÁ≠í‰Ωì</text>
                            
                            <!-- ÊîØÊíëËΩÆ -->
                            <circle cx="320" cy="180" r="8" fill="#333"/>
                            <circle cx="360" cy="180" r="8" fill="#333"/>
                            <circle cx="440" cy="180" r="8" fill="#333"/>
                            <circle cx="480" cy="180" r="8" fill="#333"/>
                        </g>
                        
                        <!-- ÁÜüÊñôÂá∫Âè£ -->
                        <rect x="620" y="100" width="80" height="60" fill="#444" stroke="#666" stroke-width="2"/>
                        <text x="660" y="135" text-anchor="middle" fill="#fff" font-size="12">ÁÜüÊñô</text>
                        
                        <!-- Áâ©ÊñôÊµÅÂêë -->
                        <line x1="130" y1="130" x2="250" y2="130" stroke="#00ff88" stroke-width="3" marker-end="url(#detail-arrow)"/>
                        <line x1="550" y1="140" x2="620" y2="130" stroke="#00ff88" stroke-width="3" marker-end="url(#detail-arrow)"/>
                        
                        <!-- ËøîÂõûÊåâÈíÆ -->
                        <g class="back-button" onclick="goBackLevel()" style="cursor: pointer;">
                            <rect x="20" y="20" width="60" height="25" fill="#0078d4" stroke="#005a9e" stroke-width="1" rx="3"/>
                            <text x="50" y="37" text-anchor="middle" fill="#fff" font-size="12">ËøîÂõû</text>
                        </g>
                    </g>
                `;
            }
            
            svg.innerHTML = detailLayout;
            
            // ÈáçÊñ∞ÁªëÂÆö‰∫ã‰ª∂
            bindDetailViewEvents();
        }

        // ÁîüÊàê2DËÆæÂ§áËØ¶ÁªÜËßÜÂõæ
        function generate2DEquipmentDetail(equipmentId) {
            const svg = document.getElementById('svg-canvas');
            const equipment = assetHierarchy[equipmentId];
            
            let detailLayout = '';
            
            if (equipmentId === 'crusher-1') {
                detailLayout = `
                    <g transform="translate(50, 50)">
                        <rect x="0" y="0" width="800" height="600" fill="#333" stroke="#666" stroke-width="2"/>
                        <text x="400" y="30" text-anchor="middle" fill="#fff" font-size="20">${equipment.name} - ÂÜÖÈÉ®ÁªìÊûÑ</text>
                        
                        <!-- Á†¥Á¢éÊú∫‰∏ª‰Ωì -->
                        <rect x="300" y="150" width="200" height="150" fill="#666" stroke="#333" stroke-width="3"/>
                        <text x="400" y="140" text-anchor="middle" fill="#fff" font-size="16">Á†¥Á¢éËÖî</text>
                        
                        <!-- ÂèØÂä®È¢öÊùø -->
                        <rect x="320" y="170" width="80" height="110" fill="#777" stroke="#555" stroke-width="2"/>
                        <text x="360" y="230" text-anchor="middle" fill="#fff" font-size="10">ÂèØÂä®È¢öÊùø</text>
                        
                        <!-- Âõ∫ÂÆöÈ¢öÊùø -->
                        <rect x="420" y="170" width="60" height="110" fill="#555" stroke="#333" stroke-width="2"/>
                        <text x="450" y="230" text-anchor="middle" fill="#fff" font-size="10">Âõ∫ÂÆöÈ¢öÊùø</text>
                        
                        <!-- ÁîµÊú∫ -->
                        <circle cx="200" cy="225" r="30" fill="#ff4444" stroke="#333" stroke-width="2" 
                                class="component" data-id="crusher-motor"/>
                        <text x="200" y="230" text-anchor="middle" fill="#fff" font-size="12">È©±Âä®ÁîµÊú∫</text>
                        
                        <!-- ËΩ¥Êâø -->
                        <circle cx="550" cy="200" r="20" fill="#888" stroke="#555" stroke-width="2" 
                                class="component" data-id="crusher-bearing"/>
                        <text x="550" y="235" text-anchor="middle" fill="#fff" font-size="10">‰∏ªËΩ¥Êâø</text>
                        
                        <!-- ‰º†Âä®Á≥ªÁªü -->
                        <line x1="230" y1="225" x2="300" y2="225" stroke="#666" stroke-width="8"/>
                        <text x="265" y="240" text-anchor="middle" fill="#ccc" font-size="8">‰º†Âä®ËΩ¥</text>
                        
                        <!-- ËøîÂõûÊåâÈíÆ -->
                        <g class="back-button" onclick="goBackLevel()" style="cursor: pointer;">
                            <rect x="20" y="20" width="60" height="25" fill="#0078d4" stroke="#005a9e" stroke-width="1" rx="3"/>
                            <text x="50" y="37" text-anchor="middle" fill="#fff" font-size="12">ËøîÂõû</text>
                        </g>
                    </g>
                `;
            }
            // ÂèØ‰ª•Ê∑ªÂä†ÂÖ∂‰ªñËÆæÂ§áÁöÑËØ¶ÁªÜËßÜÂõæ...
            
            svg.innerHTML = detailLayout;
            bindDetailViewEvents();
        }

        // ÁîüÊàê2DÈÉ®‰ª∂ËØ¶ÁªÜËßÜÂõæ
        function generate2DComponentDetail(componentId) {
            const svg = document.getElementById('svg-canvas');
            const component = assetHierarchy[componentId];
            
            let detailLayout = `
                <g transform="translate(50, 50)">
                    <rect x="0" y="0" width="800" height="600" fill="#333" stroke="#666" stroke-width="2"/>
                    <text x="400" y="30" text-anchor="middle" fill="#fff" font-size="20">${component.name} - ËØ¶ÁªÜ‰ø°ÊÅØ</text>
                    
                    <!-- ÈÉ®‰ª∂ËØ¶ÁªÜÂõæ -->
                    <rect x="250" y="150" width="300" height="200" fill="#444" stroke="#666" stroke-width="2"/>
                    <text x="400" y="180" text-anchor="middle" fill="#fff" font-size="16">${component.name}</text>
                    <text x="400" y="200" text-anchor="middle" fill="#ccc" font-size="12">ËØ¶ÁªÜÊäÄÊúØÂèÇÊï∞ÂíåÁä∂ÊÄÅ‰ø°ÊÅØ</text>
                    <text x="400" y="220" text-anchor="middle" fill="#ccc" font-size="12">Â∞ÜÂú®Ê≠§ÊòæÁ§∫</text>
                    
                    <!-- ËøîÂõûÊåâÈíÆ -->
                    <g class="back-button" onclick="goBackLevel()" style="cursor: pointer;">
                        <rect x="20" y="20" width="60" height="25" fill="#0078d4" stroke="#005a9e" stroke-width="1" rx="3"/>
                        <text x="50" y="37" text-anchor="middle" fill="#fff" font-size="12">ËøîÂõû</text>
                    </g>
                </g>
            `;
            
            svg.innerHTML = detailLayout;
            bindDetailViewEvents();
        }

        // ÁªëÂÆöËØ¶ÁªÜËßÜÂõæ‰∫ã‰ª∂
        function bindDetailViewEvents() {
            const svg = document.getElementById('svg-canvas');
            
            // ÈáçÊñ∞ÁªëÂÆöÈº†Ê†á‰∫ã‰ª∂
            svg.addEventListener('mousemove', function(event) {
                const target = event.target;
                if (target.classList.contains('equipment') || target.classList.contains('component')) {
                    // ‰∏∫Â∑•ÂÖ∑ÊèêÁ§∫Ê°ÜÂàõÂª∫Ê≠£Á°ÆÁöÑ‰∫ã‰ª∂ÂØπË±°
                    const tooltipEvent = {
                        clientX: event.clientX,
                        clientY: event.clientY,
                        pageX: event.clientX + window.pageXOffset,
                        pageY: event.clientY + window.pageYOffset
                    };
                    showTooltip(tooltipEvent, target.dataset);
                } else {
                    hideTooltip();
                }
            });
            
            svg.addEventListener('click', function(event) {
                const target = event.target;
                if (target.dataset && target.dataset.id && target.classList.contains('component')) {
                    // ‰ΩøÁî®Áªü‰∏ÄÁöÑËäÇÁÇπÂàáÊç¢ÂáΩÊï∞
                    switchToNode(target.dataset.id, '2d_component_click');
                }
            });
        }

                 // ÈÄöËøáÈù¢ÂåÖÂ±ëÂØºËà™Âà∞ÊåáÂÆöËäÇÁÇπ
         function navigateToBreadcrumbNode(nodeId) {
             // ‰ΩøÁî®Áªü‰∏ÄÁöÑËäÇÁÇπÂàáÊç¢ÂáΩÊï∞
             switchToNode(nodeId, 'breadcrumb_click');
         }

         // ËøîÂõû‰∏ä‰∏ÄÁ∫ß
         function goBackLevel() {
            // ÈªòËÆ§ÂõûÂà∞Â∑•ÂéÇÊÄªËßà
            const parentId = 'cement-factory';
            
            // ‰ΩøÁî®Áªü‰∏ÄÁöÑËäÇÁÇπÂàáÊç¢ÂáΩÊï∞
            switchToNode(parentId, 'back_level');
        }

                // ÂàùÂßãÂåñ‰∫ã‰ª∂ÁõëÂê¨Âô®
        function initEventListeners() {
            // ËøêË°åÊ®°ÂºèÂàáÊç¢
            document.querySelectorAll('[data-mode]').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('[data-mode]').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentMode = this.dataset.mode;
                    switchMode(currentMode);
                });
            });

            // ËßÜÂõæÊ®°ÂºèÂàáÊç¢
            document.querySelectorAll('[data-view]').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('[data-view]').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentView = this.dataset.view;
                    switchView();
                });
            });

            // ÁºñËæëÊ®°ÂºèÂàáÊç¢
            document.getElementById('edit-toggle').addEventListener('click', function(e) {
                e.stopPropagation();
                editMode = !editMode;
                this.classList.toggle('active');
                document.getElementById('edit-panel').classList.toggle('visible');
                // ÈöêËóèÊ®°ÂºèÊéßÂà∂Èù¢Êùø
                if (editMode) {
                    document.getElementById('mode-control-panel').classList.remove('visible');
                }
                // ÈöêËóèÂ∑•ÂÖ∑ÊèêÁ§∫
                const globalTooltip = document.getElementById('global-tooltip');
                if (globalTooltip) {
                    globalTooltip.classList.remove('show');
                }
            });
            
            // Èù¢ÂåÖÂ±ëÂØºËà™
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('breadcrumb-item')) {
                    const nodeId = e.target.dataset.id;
                    navigateToBreadcrumbNode(nodeId);
                }
            });
            
            // ÁºñËæëÊ®°ÂºèËÆæÁΩÆ
            document.querySelectorAll('#edit-panel input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    applyEditSettings();
                });
            });

            // ÂÖ®Â±èÂàáÊç¢ÂäüËÉΩ
            document.getElementById('expand-toggle').addEventListener('click', function() {
                toggleFullscreenView();
            });
            
            // ÂàùÂßãÂåñÂõæÊ†áÊåâÈíÆÂ∑•ÂÖ∑ÊèêÁ§∫
            initIconButtonTooltips();
            
            // ÂàùÂßãÂåñÂëäË≠¶Á≥ªÁªü
            initAlarmSystem();
            
            // ÈáçÁΩÆËßÜËßíÊåâÈíÆÊÇ¨ÂÅúÊïàÊûú
            const resetButton = document.getElementById('reset-view-btn');
            if (resetButton) {
                resetButton.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-1px) rotate(180deg)';
                });
                resetButton.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0) rotate(0deg)';
                });
            }

            // Ê®°ÊãüÂèÇÊï∞ÊªëÂùó‰∫ã‰ª∂
            initSimulationControls();
        }

        // ÂàùÂßãÂåñÊ®°ÊãüÊéßÂà∂
        function initSimulationControls() {
            // Áîü‰∫ßË¥üËç∑ÊªëÂùó
            const loadSlider = document.getElementById('load-slider');
            if (loadSlider) {
                loadSlider.addEventListener('input', function() {
                    document.getElementById('load-value').textContent = this.value + '%';
                    simulationParams.loadFactor = this.value / 100;
                });
            }

            // Ë¥®ÈáèÁ≥ªÊï∞ÊªëÂùó
            const qualitySlider = document.getElementById('quality-slider');
            if (qualitySlider) {
                qualitySlider.addEventListener('input', function() {
                    document.getElementById('quality-value').textContent = this.value;
                    simulationParams.qualityFactor = parseFloat(this.value);
                });
            }

            // ÊïàÁéáÁ≥ªÊï∞ÊªëÂùó
            const efficiencySlider = document.getElementById('efficiency-slider');
            if (efficiencySlider) {
                efficiencySlider.addEventListener('input', function() {
                    document.getElementById('efficiency-value').textContent = this.value + '%';
                    simulationParams.efficiencyFactor = this.value / 100;
                });
            }
        }

        // ÂàáÊç¢ËßÜÂõæ
        function switchView() {
            const threeCanvas = document.getElementById('three-canvas');
            const svgCanvas = document.getElementById('svg-canvas');
            const scadaCanvas = document.getElementById('scada-canvas');
            
            // ÈöêËóèÊâÄÊúâËßÜÂõæ
            threeCanvas.style.display = 'none';
            svgCanvas.style.display = 'none';
            scadaCanvas.style.display = 'none';
            
            // ÊòæÁ§∫ÈÄâ‰∏≠ÁöÑËßÜÂõæ
            switch(currentView) {
                case '3d':
                    threeCanvas.style.display = 'block';
                    break;
                case '2d':
                    svgCanvas.style.display = 'block';
                    break;
                case 'scada':
                    scadaCanvas.style.display = 'block';
                    initScadaView();
                    break;
            }
        }

        // ÊòæÁ§∫ÊèêÁ§∫Ê°Ü
        function showTooltip(event, data) {
            const tooltip = document.getElementById('tooltip');
            const content = tooltip.querySelector('.tooltip-content');
            
            if (data && data.id) {
                // Á°Æ‰øù‰∫ã‰ª∂ÂØπË±°ÂåÖÂê´pageXÂíåpageYÂ±ûÊÄß
                if (!event.pageX) {
                    event.pageX = event.clientX + window.pageXOffset;
                }
                if (!event.pageY) {
                    event.pageY = event.clientY + window.pageYOffset;
                }
                
                const deviceData = getEnhancedDeviceData(data.id);
                let htmlContent = `<div class="tooltip-header">${deviceData.name}</div>`;
                
                // Ê†πÊçÆÂΩìÂâçÊ®°ÂºèÊòæÁ§∫‰∏çÂêåÁöÑÊï∞ÊçÆ
                switch(currentMode) {
                    case 'realtime':
                        htmlContent += `
                            <div class="tooltip-section">
                                <div class="tooltip-label">ÂÆûÊó∂ÊåáÊ†á</div>
                                <div class="tooltip-metric">Ê∏©Â∫¶: <span class="metric-value">${deviceData.temperature}¬∞C</span></div>
                                <div class="tooltip-metric">ÂéãÂäõ: <span class="metric-value">${deviceData.pressure} MPa</span></div>
                                <div class="tooltip-metric">ËΩ¨ÈÄü: <span class="metric-value">${deviceData.speed} rpm</span></div>
                                <div class="tooltip-metric">ÊïàÁéá: <span class="metric-value">${deviceData.efficiency}%</span></div>
                                <div class="tooltip-metric">ÂäüÁéá: <span class="metric-value">${deviceData.power} kW</span></div>
                                <div class="tooltip-metric">ÊåØÂä®: <span class="metric-value">${deviceData.vibration} mm/s</span></div>
                            </div>
                            <div class="tooltip-status ${deviceData.status.toLowerCase()}">
                                Áä∂ÊÄÅ: ${deviceData.status}
                            </div>
                        `;
                        break;
                    case 'history':
                        htmlContent += `
                            <div class="tooltip-section">
                                <div class="tooltip-label">ÂéÜÂè≤Êï∞ÊçÆ (${getCurrentHistoryTime()})</div>
                                <div class="tooltip-metric">Ê∏©Â∫¶: <span class="metric-value">${(deviceData.temperature * 0.9).toFixed(1)}¬∞C</span></div>
                                <div class="tooltip-metric">ÂéãÂäõ: <span class="metric-value">${(deviceData.pressure * 0.9).toFixed(1)} MPa</span></div>
                                <div class="tooltip-metric">ËΩ¨ÈÄü: <span class="metric-value">${Math.round(deviceData.speed * 0.9)} rpm</span></div>
                                <div class="tooltip-metric">ÊïàÁéá: <span class="metric-value">${(deviceData.efficiency * 0.9).toFixed(1)}%</span></div>
                                <div class="tooltip-metric">ÂäüÁéá: <span class="metric-value">${Math.round(deviceData.power * 0.9)} kW</span></div>
                            </div>
                            <div class="tooltip-note">
                                üìä ÊòæÁ§∫ÂéÜÂè≤Êó∂ÊÆµÂπ≥ÂùáÂÄº
                            </div>
                        `;
                        break;
                    case 'simulation':
                        const simData = applySimulationParams(deviceData);
                        htmlContent += `
                            <div class="tooltip-section">
                                <div class="tooltip-label">È¢ÑÊµãÊï∞ÊçÆ</div>
                                <div class="tooltip-metric">Ê∏©Â∫¶: <span class="metric-value">${simData.temperature}¬∞C</span> 
                                    <span class="prediction-indicator">‚ÜóÔ∏è</span></div>
                                <div class="tooltip-metric">ÂéãÂäõ: <span class="metric-value">${simData.pressure} MPa</span> 
                                    <span class="prediction-indicator">‚ÜóÔ∏è</span></div>
                                <div class="tooltip-metric">ËΩ¨ÈÄü: <span class="metric-value">${simData.speed} rpm</span> 
                                    <span class="prediction-indicator">‚ÜóÔ∏è</span></div>
                                <div class="tooltip-metric">ÊïàÁéá: <span class="metric-value">${simData.efficiency}%</span> 
                                    <span class="prediction-indicator">‚ÜóÔ∏è</span></div>
                                <div class="tooltip-metric">ÂäüÁéá: <span class="metric-value">${simData.power} kW</span> 
                                    <span class="prediction-indicator">‚ÜóÔ∏è</span></div>
                            </div>
                            <div class="tooltip-note">
                                üîÆ Âü∫‰∫éÂΩìÂâçÂèÇÊï∞È¢ÑÊµã
                            </div>
                        `;
                        break;
                }
                
                // Ê∑ªÂä†Ë∂ãÂäø‰ø°ÊÅØ
                if (currentMode !== 'history') {
                    htmlContent += `
                        <div class="tooltip-trend">
                            <div class="tooltip-label">24Â∞èÊó∂Ë∂ãÂäø</div>
                            <div class="trend-indicators">
                                <span class="trend-up">Ê∏©Â∫¶ ‚ÜóÔ∏è</span>
                                <span class="trend-stable">ÂéãÂäõ ‚Üí</span>
                                <span class="trend-down">ÊåØÂä® ‚ÜòÔ∏è</span>
                            </div>
                        </div>
                    `;
                }
                
                content.innerHTML = htmlContent;
                tooltip.style.display = 'block';
                
                // ‰ΩøÁî®pageXÂíåpageYËé∑ÂèñÊõ¥ÂáÜÁ°ÆÁöÑ‰ΩçÁΩÆ
                let tooltipX = event.pageX + 12;
                let tooltipY = event.pageY + 12;
                
                // È¢ÑÂÖàËÆ°ÁÆóÂ∑•ÂÖ∑ÊèêÁ§∫Ê°ÜÁöÑÂ∞∫ÂØ∏
                tooltip.style.visibility = 'hidden';
                tooltip.style.left = '-9999px';
                tooltip.style.top = '-9999px';
                tooltip.style.display = 'block';
                
                const tooltipRect = tooltip.getBoundingClientRect();
                const tooltipWidth = tooltipRect.width;
                const tooltipHeight = tooltipRect.height;
                
                // ÈáçÁΩÆÂèØËßÅÊÄß
                tooltip.style.visibility = 'visible';
                
                // ËæπÁïåÊ£ÄÊµãÂíå‰ΩçÁΩÆË∞ÉÊï¥
                if (tooltipX + tooltipWidth > window.innerWidth) {
                    tooltipX = event.pageX - tooltipWidth - 12;
                }
                if (tooltipY + tooltipHeight > window.innerHeight) {
                    tooltipY = event.pageY - tooltipHeight - 12;
                }
                
                // Á°Æ‰øù‰∏ç‰ºöË∂ÖÂá∫Â∑¶ËæπÁïåÂíå‰∏äËæπÁïå
                if (tooltipX < 0) {
                    tooltipX = 8;
                }
                if (tooltipY < 0) {
                    tooltipY = 8;
                }
                
                tooltip.style.left = tooltipX + 'px';
                tooltip.style.top = tooltipY + 'px';
            }
        }

        // ÈöêËóèÊèêÁ§∫Ê°Ü
        function hideTooltip() {
            document.getElementById('tooltip').style.display = 'none';
        }

        // Ê£ÄÊµãÊåáÊ†áÊòØÂê¶ÂºÇÂ∏∏
        function isMetricAbnormal(metricName, value, nodeId) {
            // ÂÆö‰πâÂêÑËÆæÂ§áÂêÑÊåáÊ†áÁöÑÊ≠£Â∏∏ËåÉÂõ¥
            const normalRanges = {
                'crusher-1': {
                    temperature: { min: 60, max: 80 },
                    pressure: { min: 2.0, max: 3.5 },
                    speed: { min: 280, max: 380 },
                    efficiency: { min: 80, max: 100 },
                    power: { min: 380, max: 520 },
                    vibration: { min: 0, max: 16 }
                },
                'ball-mill': {
                    temperature: { min: 70, max: 95 },
                    pressure: { min: 1.5, max: 2.5 },
                    speed: { min: 15, max: 25 },
                    efficiency: { min: 75, max: 100 },
                    power: { min: 1000, max: 1500 },
                    vibration: { min: 0, max: 12 }
                },
                'rotary-kiln': {
                    temperature: { min: 800, max: 1000 },
                    pressure: { min: 0.6, max: 1.2 },
                    speed: { min: 3.0, max: 4.5 },
                    efficiency: { min: 80, max: 100 },
                    power: { min: 650, max: 1000 },
                    vibration: { min: 0, max: 8 }
                },
                'cement-mill': {
                    temperature: { min: 65, max: 85 },
                    pressure: { min: 1.8, max: 2.8 },
                    speed: { min: 12, max: 20 },
                    efficiency: { min: 80, max: 100 },
                    power: { min: 550, max: 800 },
                    vibration: { min: 0, max: 14 }
                },
                'conveyor-1': {
                    temperature: { min: 40, max: 55 },
                    pressure: { min: 0.4, max: 0.7 },
                    speed: { min: 100, max: 150 },
                    efficiency: { min: 85, max: 100 },
                    power: { min: 120, max: 200 },
                    vibration: { min: 0, max: 5 }
                },
                'cement-factory': {
                    temperature: { min: 20, max: 35 },
                    pressure: { min: 0.9, max: 1.2 },
                    efficiency: { min: 80, max: 100 },
                    power: { min: 2000, max: 3500 },
                    vibration: { min: 0, max: 4 }
                }
            };

            // Â∑•ÂéÇÁ∫ßÂà´ÊåáÊ†áÁöÑÊ≠£Â∏∏ËåÉÂõ¥
            const factoryRanges = {
                totalProduction: { min: 2000, max: 2600 },
                overallEfficiency: { min: 80, max: 100 },
                totalPower: { min: 2000, max: 3500 },
                onlineEquipment: { min: 22, max: 26 },
                alarmCount: { min: 0, max: 3 }
            };

            // Â∑•ÊÆµÁ∫ßÂà´ÊåáÊ†áÁöÑÊ≠£Â∏∏ËåÉÂõ¥
            const workshopRanges = {
                workshopEfficiency: { min: 75, max: 100 },
                workshopPower: { min: 500, max: 2000 },
                materialThroughput: { min: 120, max: 220 },
                avgVibration: { min: 0, max: 15 },
                avgTemperature: { min: 800, max: 1000 }
            };

            // ÁªÑ‰ª∂Á∫ßÂà´ÊåáÊ†áÁöÑÊ≠£Â∏∏ËåÉÂõ¥
            const componentRanges = {
                'crusher-motor': {
                    voltage: { min: 360, max: 420 },
                    current: { min: 50, max: 80 },
                    temperature: { min: 60, max: 85 },
                    power: { min: 250, max: 320 },
                    efficiency: { min: 88, max: 100 },
                    vibration: { min: 0, max: 12 }
                },
                'crusher-bearing': {
                    temperature: { min: 40, max: 60 },
                    lubrication: { min: 80, max: 100 },
                    vibration: { min: 0, max: 20 },
                    wear: { min: 0, max: 25 },
                    runningTime: { min: 2500, max: 3200 }
                },
                'mill-motor': {
                    voltage: { min: 5800, max: 6200 },
                    current: { min: 160, max: 220 },
                    temperature: { min: 65, max: 95 },
                    power: { min: 850, max: 1100 },
                    efficiency: { min: 90, max: 100 },
                    vibration: { min: 0, max: 8 }
                },
                'mill-gearbox': {
                    temperature: { min: 45, max: 65 },
                    oilPressure: { min: 0.2, max: 0.32 },
                    oilTemperature: { min: 40, max: 60 },
                    vibration: { min: 0, max: 6 },
                    efficiency: { min: 92, max: 100 }
                },
                'kiln-burner': {
                    flameTemperature: { min: 1100, max: 1500 },
                    fuelPressure: { min: 1.2, max: 2.0 },
                    airPressure: { min: 2.4, max: 3.5 },
                    fuelFlow: { min: 35, max: 60 },
                    efficiency: { min: 82, max: 100 }
                },
                'kiln-cylinder': {
                    shellTemperature: { min: 280, max: 380 },
                    thickness: { min: 36, max: 42 },
                    runoutValue: { min: 0, max: 3.5 },
                    vibration: { min: 0, max: 4 },
                    rotationSpeed: { min: 2.8, max: 3.8 }
                }
            };

            // Á≥ªÁªüÁ∫ßÂà´ÊåáÊ†áÁöÑÊ≠£Â∏∏ËåÉÂõ¥
            const systemRanges = {
                overallEfficiency: { min: 80, max: 100 },
                equipmentRuntime: { min: 85, max: 100 },
                avgEnergyConsumption: { min: 220, max: 280 },
                production: { min: 2000, max: 2800 },
                alarmCount: { min: 0, max: 3 },
                onlineDevices: { min: 22, max: 26 }
            };

            const numValue = parseFloat(value);
            
            // Ê£ÄÊü•ËÆæÂ§áÁ∫ßÂà´ÊåáÊ†á
            if (nodeId && normalRanges[nodeId] && normalRanges[nodeId][metricName]) {
                const range = normalRanges[nodeId][metricName];
                return numValue < range.min || numValue > range.max;
            }
            
            // Ê£ÄÊü•ÁªÑ‰ª∂Á∫ßÂà´ÊåáÊ†á
            if (nodeId && componentRanges[nodeId] && componentRanges[nodeId][metricName]) {
                const range = componentRanges[nodeId][metricName];
                return numValue < range.min || numValue > range.max;
            }
            
            // Ê£ÄÊü•Â∑•ÂéÇÁ∫ßÂà´ÊåáÊ†á
            if (factoryRanges[metricName]) {
                const range = factoryRanges[metricName];
                return numValue < range.min || numValue > range.max;
            }
            
            // Ê£ÄÊü•Â∑•ÊÆµÁ∫ßÂà´ÊåáÊ†á
            if (workshopRanges[metricName]) {
                const range = workshopRanges[metricName];
                return numValue < range.min || numValue > range.max;
            }
            
            // Ê£ÄÊü•Á≥ªÁªüÁ∫ßÂà´ÊåáÊ†á
            if (systemRanges[metricName]) {
                const range = systemRanges[metricName];
                return numValue < range.min || numValue > range.max;
            }

            return false; // ÈªòËÆ§‰∏çÂºÇÂ∏∏
        }

        // Ëé∑ÂèñÂ¢ûÂº∫ËÆæÂ§áÊï∞ÊçÆ
        function getEnhancedDeviceData(nodeId) {
            const baseData = {
                'cement-factory': {
                    name: 'Ê∞¥Ê≥•Â∑•ÂéÇ',
                    level: 'factory',
                    totalProduction: 2300 + Math.random() * 200,
                    overallEfficiency: 85 + Math.random() * 10,
                    totalPower: 2500 + Math.random() * 500,
                    onlineEquipment: 24 + Math.floor(Math.random() * 3),
                    totalEquipment: 26,
                    alarmCount: Math.floor(Math.random() * 5) + 1,
                    status: Math.random() > 0.05 ? 'Ê≠£Â∏∏' : 'ÂëäË≠¶'
                },
                'crushing-workshop': {
                    name: 'Á†¥Á¢éÂ∑•ÊÆµ',
                    level: 'workshop',
                    workshopEfficiency: 88 + Math.random() * 8,
                    workshopPower: 650 + Math.random() * 100,
                    materialThroughput: 180 + Math.random() * 20,
                    equipmentCount: 3,
                    runningCount: 3,
                    avgVibration: 10 + Math.random() * 3,
                    status: Math.random() > 0.1 ? 'Ê≠£Â∏∏' : 'ÂëäË≠¶'
                },
                'grinding-workshop': {
                    name: 'Á≤âÁ£®Â∑•ÊÆµ',
                    level: 'workshop',
                    workshopEfficiency: 82 + Math.random() * 10,
                    workshopPower: 1400 + Math.random() * 200,
                    materialThroughput: 160 + Math.random() * 15,
                    equipmentCount: 3,
                    runningCount: 3,
                    avgVibration: 8 + Math.random() * 2,
                    status: Math.random() > 0.15 ? 'Ê≠£Â∏∏' : 'ÂëäË≠¶'
                },
                'burning-workshop': {
                    name: 'ÁÖÖÁÉßÂ∑•ÊÆµ',
                    level: 'workshop',
                    workshopEfficiency: 90 + Math.random() * 6,
                    workshopPower: 800 + Math.random() * 150,
                    materialThroughput: 170 + Math.random() * 20,
                    equipmentCount: 1,
                    runningCount: 1,
                    avgTemperature: 850 + Math.random() * 100,
                    status: Math.random() > 0.08 ? 'Ê≠£Â∏∏' : 'ÂëäË≠¶'
                },
                'crusher-1': {
                    name: 'È¢öÂºèÁ†¥Á¢éÊú∫ #1',
                    level: 'equipment',
                    temperature: 65 + Math.random() * 10,
                    pressure: 2.5 + Math.random() * 0.5,
                    speed: 300 + Math.random() * 50,
                    efficiency: 85 + Math.random() * 10,
                    power: 450 + Math.random() * 50,
                    vibration: 12 + Math.random() * 3,
                    status: Math.random() > 0.1 ? 'Ê≠£Â∏∏' : 'ÂëäË≠¶'
                },
                'conveyor-1': {
                    name: 'ÁöÆÂ∏¶ËæìÈÄÅÊú∫',
                    level: 'equipment',
                    temperature: 45 + Math.random() * 8,
                    pressure: 0.5 + Math.random() * 0.1,
                    speed: 120 + Math.random() * 20,
                    efficiency: 92 + Math.random() * 5,
                    power: 150 + Math.random() * 30,
                    vibration: 3 + Math.random() * 1,
                    status: Math.random() > 0.05 ? 'Ê≠£Â∏∏' : 'ÂëäË≠¶'
                },
                'separator': {
                    name: 'ÈÄâÁ≤âÊú∫',
                    level: 'equipment',
                    temperature: 55 + Math.random() * 10,
                    pressure: 1.2 + Math.random() * 0.3,
                    speed: 450 + Math.random() * 50,
                    efficiency: 89 + Math.random() * 7,
                    power: 200 + Math.random() * 40,
                    vibration: 5 + Math.random() * 1,
                    status: Math.random() > 0.08 ? 'Ê≠£Â∏∏' : 'ÂëäË≠¶'
                },
                'ball-mill': {
                    name: 'ÁêÉÁ£®Êú∫',
                    level: 'equipment',
                    temperature: 78 + Math.random() * 15,
                    pressure: 1.8 + Math.random() * 0.4,
                    speed: 18 + Math.random() * 3,
                    efficiency: 82 + Math.random() * 8,
                    power: 1200 + Math.random() * 200,
                    vibration: 8 + Math.random() * 2,
                    status: Math.random() > 0.15 ? 'Ê≠£Â∏∏' : 'ÂëäË≠¶'
                },
                'rotary-kiln': {
                    name: 'ÂõûËΩ¨Á™ë',
                    level: 'equipment',
                    temperature: 850 + Math.random() * 100,
                    pressure: 0.8 + Math.random() * 0.2,
                    speed: 3.5 + Math.random() * 0.5,
                    efficiency: 88 + Math.random() * 7,
                    power: 800 + Math.random() * 150,
                    vibration: 5 + Math.random() * 1,
                    status: Math.random() > 0.08 ? 'Ê≠£Â∏∏' : 'ÂëäË≠¶'
                },
                // ÁªÑ‰ª∂Á∫ßÂà´Êï∞ÊçÆ
                'crusher-motor': {
                    name: 'Á†¥Á¢éÊú∫ÁîµÊú∫',
                    level: 'component',
                    temperature: 68 + Math.random() * 12,
                    voltage: 380 + Math.random() * 20,
                    current: 65 + Math.random() * 10,
                    power: 280 + Math.random() * 30,
                    efficiency: 92 + Math.random() * 5,
                    vibration: 8 + Math.random() * 2,
                    status: Math.random() > 0.2 ? 'Ê≠£Â∏∏' : 'ÂëäË≠¶'
                },
                'crusher-bearing': {
                    name: 'Á†¥Á¢éÊú∫ËΩ¥Êâø',
                    level: 'component',
                    temperature: 45 + Math.random() * 8,
                    lubrication: 85 + Math.random() * 10,
                    vibration: 15 + Math.random() * 3,
                    wear: 15 + Math.random() * 5,
                    runningTime: 2800 + Math.random() * 200,
                    status: Math.random() > 0.15 ? 'Ê≠£Â∏∏' : 'ÂëäË≠¶'
                },
                'mill-motor': {
                    name: 'ÁêÉÁ£®Êú∫‰∏ªÁîµÊú∫',
                    level: 'component',
                    temperature: 75 + Math.random() * 15,
                    voltage: 6000 + Math.random() * 200,
                    current: 180 + Math.random() * 20,
                    power: 950 + Math.random() * 100,
                    efficiency: 94 + Math.random() * 4,
                    vibration: 6 + Math.random() * 1,
                    status: Math.random() > 0.1 ? 'Ê≠£Â∏∏' : 'ÂëäË≠¶'
                },
                'mill-gearbox': {
                    name: 'ÁêÉÁ£®Êú∫ÂáèÈÄüÂô®',
                    level: 'component',
                    temperature: 52 + Math.random() * 8,
                    oilPressure: 0.25 + Math.random() * 0.05,
                    oilTemperature: 48 + Math.random() * 7,
                    vibration: 4 + Math.random() * 1,
                    efficiency: 96 + Math.random() * 3,
                    status: Math.random() > 0.08 ? 'Ê≠£Â∏∏' : 'ÂëäË≠¶'
                },
                'kiln-burner': {
                    name: 'ÂõûËΩ¨Á™ëÁáÉÁÉßÂô®',
                    level: 'component',
                    flameTemperature: 1200 + Math.random() * 200,
                    fuelPressure: 1.5 + Math.random() * 0.3,
                    airPressure: 2.8 + Math.random() * 0.4,
                    fuelFlow: 45 + Math.random() * 8,
                    efficiency: 88 + Math.random() * 6,
                    status: Math.random() > 0.12 ? 'Ê≠£Â∏∏' : 'ÂëäË≠¶'
                },
                'kiln-cylinder': {
                    name: 'ÂõûËΩ¨Á™ëÁ≠í‰Ωì',
                    level: 'component',
                    shellTemperature: 320 + Math.random() * 40,
                    thickness: 38 + Math.random() * 2,
                    runoutValue: 2.5 + Math.random() * 0.5,
                    vibration: 3 + Math.random() * 0.5,
                    rotationSpeed: 3.2 + Math.random() * 0.3,
                    status: Math.random() > 0.05 ? 'Ê≠£Â∏∏' : 'ÂëäË≠¶'
                }
            };
            
            const data = baseData[nodeId];
            if (data) {
                // ÂÆâÂÖ®Ê†ºÂºèÂåñÊï∞ÂÄº - Âè™Ê†ºÂºèÂåñÂ≠òÂú®ÁöÑÂ±ûÊÄß
                const formattedData = { ...data };
                
                // Ê†ºÂºèÂåñÊï∞ÂÄºÁ±ªÂûãÁöÑÂ±ûÊÄß
                if (typeof data.temperature === 'number') {
                    formattedData.temperature = data.temperature.toFixed(1);
                }
                if (typeof data.pressure === 'number') {
                    formattedData.pressure = data.pressure.toFixed(1);
                }
                if (typeof data.speed === 'number') {
                    formattedData.speed = Math.round(data.speed);
                }
                if (typeof data.efficiency === 'number') {
                    formattedData.efficiency = data.efficiency.toFixed(1);
                }
                if (typeof data.power === 'number') {
                    formattedData.power = Math.round(data.power);
                }
                if (typeof data.vibration === 'number') {
                    formattedData.vibration = data.vibration.toFixed(1);
                }
                
                // Â∑•ÂéÇÁ∫ßÂà´ÊåáÊ†áÊ†ºÂºèÂåñ
                if (typeof data.totalProduction === 'number') {
                    formattedData.totalProduction = data.totalProduction.toFixed(0);
                }
                if (typeof data.overallEfficiency === 'number') {
                    formattedData.overallEfficiency = data.overallEfficiency.toFixed(1);
                }
                if (typeof data.totalPower === 'number') {
                    formattedData.totalPower = data.totalPower.toFixed(0);
                }
                
                // Â∑•ÊÆµÁ∫ßÂà´ÊåáÊ†áÊ†ºÂºèÂåñ
                if (typeof data.workshopEfficiency === 'number') {
                    formattedData.workshopEfficiency = data.workshopEfficiency.toFixed(1);
                }
                if (typeof data.workshopPower === 'number') {
                    formattedData.workshopPower = data.workshopPower.toFixed(0);
                }
                if (typeof data.materialThroughput === 'number') {
                    formattedData.materialThroughput = data.materialThroughput.toFixed(1);
                }
                if (typeof data.avgVibration === 'number') {
                    formattedData.avgVibration = data.avgVibration.toFixed(1);
                }
                if (typeof data.avgTemperature === 'number') {
                    formattedData.avgTemperature = data.avgTemperature.toFixed(0);
                }
                
                // ÁªÑ‰ª∂Á∫ßÂà´ÁâπÊÆäÊåáÊ†áÊ†ºÂºèÂåñ
                if (typeof data.voltage === 'number') {
                    formattedData.voltage = data.voltage.toFixed(0);
                }
                if (typeof data.current === 'number') {
                    formattedData.current = data.current.toFixed(1);
                }
                if (typeof data.lubrication === 'number') {
                    formattedData.lubrication = data.lubrication.toFixed(1);
                }
                if (typeof data.wear === 'number') {
                    formattedData.wear = data.wear.toFixed(1);
                }
                if (typeof data.runningTime === 'number') {
                    formattedData.runningTime = data.runningTime.toFixed(0);
                }
                if (typeof data.oilPressure === 'number') {
                    formattedData.oilPressure = data.oilPressure.toFixed(2);
                }
                if (typeof data.oilTemperature === 'number') {
                    formattedData.oilTemperature = data.oilTemperature.toFixed(1);
                }
                if (typeof data.flameTemperature === 'number') {
                    formattedData.flameTemperature = data.flameTemperature.toFixed(0);
                }
                if (typeof data.fuelPressure === 'number') {
                    formattedData.fuelPressure = data.fuelPressure.toFixed(2);
                }
                if (typeof data.airPressure === 'number') {
                    formattedData.airPressure = data.airPressure.toFixed(1);
                }
                if (typeof data.fuelFlow === 'number') {
                    formattedData.fuelFlow = data.fuelFlow.toFixed(1);
                }
                if (typeof data.shellTemperature === 'number') {
                    formattedData.shellTemperature = data.shellTemperature.toFixed(0);
                }
                if (typeof data.thickness === 'number') {
                    formattedData.thickness = data.thickness.toFixed(1);
                }
                if (typeof data.runoutValue === 'number') {
                    formattedData.runoutValue = data.runoutValue.toFixed(1);
                }
                if (typeof data.rotationSpeed === 'number') {
                    formattedData.rotationSpeed = data.rotationSpeed.toFixed(1);
                }
                
                return formattedData;
            }
            
            return {
                name: 'Êú™Áü•ËÆæÂ§á',
                temperature: '25.0',
                pressure: '1.0',
                speed: 0,
                efficiency: '0.0',
                power: 0,
                vibration: '0.0',
                status: 'Êú™Áü•'
            };
        }

        // Â∫îÁî®Ê®°ÊãüÂèÇÊï∞
        function applySimulationParams(data) {
            const temp = parseFloat(data.temperature);
            const pressure = parseFloat(data.pressure);
            const speed = parseInt(data.speed);
            const efficiency = parseFloat(data.efficiency);
            const power = parseInt(data.power);
            const vibration = parseFloat(data.vibration);
            
            return {
                name: data.name,
                temperature: (temp * (1 + (simulationParams.loadFactor - 1) * 0.3)).toFixed(1),
                pressure: (pressure * simulationParams.loadFactor).toFixed(1),
                speed: Math.round(speed * simulationParams.loadFactor * simulationParams.efficiencyFactor),
                efficiency: (efficiency * simulationParams.efficiencyFactor * simulationParams.qualityFactor).toFixed(1),
                power: Math.round(power * simulationParams.loadFactor),
                vibration: (vibration * (2 - simulationParams.efficiencyFactor)).toFixed(1),
                status: data.status
            };
        }

        // Ëé∑ÂèñÂΩìÂâçÂéÜÂè≤Êó∂Èó¥
        function getCurrentHistoryTime() {
            const dateInput = document.getElementById('history-date');
            const startTimeInput = document.getElementById('history-time-start');
            const endTimeInput = document.getElementById('history-time-end');
            
            const date = dateInput ? dateInput.value : '2024-01-15';
            const startTime = startTimeInput ? startTimeInput.value : '08:00';
            const endTime = endTimeInput ? endTimeInput.value : '18:00';
            
            return `${date} ${startTime}-${endTime}`;
        }

        // ÂàùÂßãÂåñÂõæÊ†áÊåâÈíÆÂ∑•ÂÖ∑ÊèêÁ§∫
        function initIconButtonTooltips() {
            const globalTooltip = document.getElementById('global-tooltip');
            const iconButtons = document.querySelectorAll('.icon-button');
            
            iconButtons.forEach(button => {
                button.addEventListener('mouseenter', function(e) {
                    const tooltipText = this.getAttribute('data-tooltip');
                    if (tooltipText && globalTooltip) {
                        const rect = this.getBoundingClientRect();
                        const tooltipX = rect.left + rect.width / 2;
                        const tooltipY = rect.bottom + 8;
                        
                        globalTooltip.textContent = tooltipText;
                        globalTooltip.style.left = tooltipX + 'px';
                        globalTooltip.style.top = tooltipY + 'px';
                        globalTooltip.classList.add('show');
                    }
                });
                
                button.addEventListener('mouseleave', function() {
                    if (globalTooltip) {
                        globalTooltip.classList.remove('show');
                    }
                });
            });
            
            // Á™óÂè£Â§ßÂ∞èÊîπÂèòÊó∂ÈöêËóèÂ∑•ÂÖ∑ÊèêÁ§∫
            window.addEventListener('resize', function() {
                if (globalTooltip) {
                    globalTooltip.classList.remove('show');
                }
            });
            
            // È°µÈù¢ÊªöÂä®Êó∂ÈöêËóèÂ∑•ÂÖ∑ÊèêÁ§∫
            window.addEventListener('scroll', function() {
                if (globalTooltip) {
                    globalTooltip.classList.remove('show');
                }
            });
            
            // ÁÇπÂáªÈ°µÈù¢Êó∂ÈöêËóèÂ∑•ÂÖ∑ÊèêÁ§∫
            document.addEventListener('click', function(e) {
                if (globalTooltip && !e.target.closest('.icon-button')) {
                    globalTooltip.classList.remove('show');
                }
            });
        }

        // ÂàùÂßãÂåñÂëäË≠¶Á≥ªÁªü
        function initAlarmSystem() {
            const alarmModal = document.getElementById('alarm-modal');
            const alarmToggle = document.getElementById('alarm-toggle');
            const alarmClose = document.getElementById('alarm-close');
            
            // ÊâìÂºÄÂëäË≠¶ÂºπÊ°Ü
            alarmToggle.addEventListener('click', function(e) {
                e.stopPropagation();
                showAlarmModal();
            });
            
            // ÂÖ≥Èó≠ÂëäË≠¶ÂºπÊ°Ü
            alarmClose.addEventListener('click', function() {
                hideAlarmModal();
            });
            
            // ÁÇπÂáªËÉåÊôØÂÖ≥Èó≠
            alarmModal.addEventListener('click', function(e) {
                if (e.target === alarmModal) {
                    hideAlarmModal();
                }
            });
            
            // ESCÈîÆÂÖ≥Èó≠
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && alarmModal.classList.contains('show')) {
                    hideAlarmModal();
                }
            });
            
            // ÂëäË≠¶Á∫ßÂà´ËøáÊª§
            document.querySelectorAll('.alarm-stat').forEach(stat => {
                stat.addEventListener('click', function() {
                    const filterLevel = this.getAttribute('data-filter');
                    setAlarmFilter(filterLevel);
                });
            });
            
            // ÂàùÂßãÂåñÂëäË≠¶Êï∞ÊçÆÊòæÁ§∫
            updateAlarmDisplay();
        }

        // ÊòæÁ§∫ÂëäË≠¶ÂºπÊ°Ü
        function showAlarmModal() {
            const alarmModal = document.getElementById('alarm-modal');
            const globalTooltip = document.getElementById('global-tooltip');
            
            // ÈöêËóèÂ∑•ÂÖ∑ÊèêÁ§∫
            if (globalTooltip) {
                globalTooltip.classList.remove('show');
            }
            
            generateAlarmList();
            alarmModal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        // ÈöêËóèÂëäË≠¶ÂºπÊ°Ü
        function hideAlarmModal() {
            const alarmModal = document.getElementById('alarm-modal');
            alarmModal.classList.remove('show');
            document.body.style.overflow = '';
        }

        // Êõ¥Êñ∞ÂëäË≠¶ÊòæÁ§∫
        function updateAlarmDisplay() {
            const alarmStats = getAlarmStats();
            
            // Êõ¥Êñ∞ÂëäË≠¶ÊåâÈíÆÊï∞Èáè
            const alarmCount = document.getElementById('alarm-count');
            if (alarmCount) {
                alarmCount.textContent = alarmStats.total;
            }
            
            // Êõ¥Êñ∞ÁªüËÆ°Êï∞Èáè
            const highCount = document.getElementById('high-alarm-count');
            const mediumCount = document.getElementById('medium-alarm-count');
            const lowCount = document.getElementById('low-alarm-count');
            
            if (highCount) highCount.textContent = alarmStats.high;
            if (mediumCount) mediumCount.textContent = alarmStats.medium;
            if (lowCount) lowCount.textContent = alarmStats.low;
        }

        // Ëé∑ÂèñÂëäË≠¶ÁªüËÆ°
        function getAlarmStats() {
            const stats = { high: 0, medium: 0, low: 0, total: 0 };
            
            alarmData.forEach(alarm => {
                if (alarm.status === 'active') {
                    stats[alarm.level]++;
                    stats.total++;
                }
            });
            
            return stats;
        }

        // ÁîüÊàêÂëäË≠¶ÂàóË°®
        function generateAlarmList() {
            const alarmList = document.getElementById('alarm-list');
            if (!alarmList) return;
            
            // ËøáÊª§ÂëäË≠¶Êï∞ÊçÆ
            let filteredAlarms = alarmData.filter(alarm => alarm.status === 'active');
            if (currentAlarmFilter) {
                filteredAlarms = filteredAlarms.filter(alarm => alarm.level === currentAlarmFilter);
            }
            
            // ÊåâÊó∂Èó¥Êà≥ÂÄíÂ∫èÊéíÂàóÔºàÊúÄÊñ∞ÁöÑÂú®ÂâçÔºâ
            const sortedAlarms = filteredAlarms.sort((a, b) => b.timestamp - a.timestamp);
            
            if (sortedAlarms.length === 0) {
                alarmList.innerHTML = `
                    <div style="padding: 40px 20px; text-align: center; color: #888;">
                        ${currentAlarmFilter ? 'ËØ•Á∫ßÂà´ÊöÇÊó†ÂëäË≠¶' : 'ÊöÇÊó†ÂëäË≠¶'}
                    </div>
                `;
                return;
            }
            
            alarmList.innerHTML = sortedAlarms.map(alarm => `
                <div class="alarm-item" data-alarm-id="${alarm.id}">
                    <div class="alarm-item-level ${alarm.level}"></div>
                    <div class="alarm-item-content" onclick="navigateToAlarmDevice('${alarm.deviceId}')">
                        <div class="alarm-item-title">${alarm.title}</div>
                        <div class="alarm-item-desc">${alarm.deviceName} - ${alarm.description}</div>
                    </div>
                    <div class="alarm-item-time">${alarm.time}</div>
                    <div class="alarm-actions">
                        <button class="alarm-action-btn alarm-action-handle" onclick="handleAlarmAction('${alarm.id}', 'handle')">Â§ÑÁêÜ</button>
                        <button class="alarm-action-btn alarm-action-forward" onclick="handleAlarmAction('${alarm.id}', 'forward')">ËΩ¨Âèë</button>
                        <button class="alarm-action-btn alarm-action-ignore" onclick="handleAlarmAction('${alarm.id}', 'ignore')">ÂøΩÁï•</button>
                    </div>
                </div>
            `).join('');
        }

        // ÂØºËà™Âà∞ÂëäË≠¶ËÆæÂ§á
        function navigateToAlarmDevice(deviceId) {
            // ÂÖ≥Èó≠ÂëäË≠¶ÂºπÊ°Ü
            hideAlarmModal();
            
            // ‰ΩøÁî®Áªü‰∏ÄÁöÑËäÇÁÇπÂàáÊç¢ÂáΩÊï∞
            const success = switchToNode(deviceId, 'alarm_click');
            
            if (success) {
                // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
                showNotification(`Â∑≤ÂàáÊç¢Âà∞ÂëäË≠¶ËÆæÂ§áÔºö${getDeviceDisplayName(deviceId)}`, 'success');
            } else {
                showNotification('ËÆæÂ§áÊú™ÊâæÂà∞', 'error');
            }
        }

        // ËÆæÁΩÆÂëäË≠¶ËøáÊª§
        function setAlarmFilter(level) {
            const alarmStats = document.querySelectorAll('.alarm-stat');
            const filterTip = document.getElementById('alarm-filter-tip');
            const filterText = document.getElementById('filter-text');
            
            // Ê∏ÖÈô§ÊâÄÊúâÊøÄÊ¥ªÁä∂ÊÄÅ
            alarmStats.forEach(stat => stat.classList.remove('active'));
            
            if (currentAlarmFilter === level) {
                // Â¶ÇÊûúÁÇπÂáªÂΩìÂâçÊøÄÊ¥ªÁöÑËøáÊª§Âô®ÔºåÂàôÂèñÊ∂àËøáÊª§
                currentAlarmFilter = null;
                filterTip.classList.remove('show');
            } else {
                // ËÆæÁΩÆÊñ∞ÁöÑËøáÊª§Âô®
                currentAlarmFilter = level;
                const activeStat = document.querySelector(`[data-filter="${level}"]`);
                if (activeStat) {
                    activeStat.classList.add('active');
                }
                
                const levelNames = {
                    'high': 'È´òÁ∫ßÂëäË≠¶',
                    'medium': '‰∏≠Á∫ßÂëäË≠¶',
                    'low': '‰ΩéÁ∫ßÂëäË≠¶'
                };
                
                filterText.textContent = levelNames[level];
                filterTip.classList.add('show');
            }
            
            // ÈáçÊñ∞ÁîüÊàêÂëäË≠¶ÂàóË°®
            generateAlarmList();
        }

        // Ê∏ÖÈô§ÂëäË≠¶ËøáÊª§
        function clearAlarmFilter() {
            currentAlarmFilter = null;
            document.querySelectorAll('.alarm-stat').forEach(stat => stat.classList.remove('active'));
            document.getElementById('alarm-filter-tip').classList.remove('show');
            generateAlarmList();
        }

        // Â§ÑÁêÜÂëäË≠¶Êìç‰Ωú
        function handleAlarmAction(alarmId, action) {
            const alarm = alarmData.find(a => a.id === alarmId);
            if (!alarm) return;
            
            let actionText = '';
            let newStatus = 'active';
            
            switch (action) {
                case 'handle':
                    actionText = 'Â§ÑÁêÜ';
                    newStatus = 'handled';
                    break;
                case 'forward':
                    actionText = 'ËΩ¨Âèë';
                    // ËøôÈáåÂèØ‰ª•ÊâìÂºÄËΩ¨ÂèëÂØπËØùÊ°Ü
                    showNotification(`ÂëäË≠¶"${alarm.title}"Â∑≤ËΩ¨Âèë`, 'success');
                    return;
                case 'ignore':
                    actionText = 'ÂøΩÁï•';
                    newStatus = 'ignored';
                    break;
            }
            
            // Êõ¥Êñ∞ÂëäË≠¶Áä∂ÊÄÅ
            alarm.status = newStatus;
            
            // Êõ¥Êñ∞ÊòæÁ§∫
            updateAlarmDisplay();
            generateAlarmList();
            
            // ÊòæÁ§∫Êìç‰ΩúÁªìÊûú
            showNotification(`ÂëäË≠¶"${alarm.title}"Â∑≤${actionText}`, 'success');
        }

        // Ëé∑ÂèñËÆæÂ§áÊòæÁ§∫ÂêçÁß∞
        function getDeviceDisplayName(deviceId) {
            const deviceNames = {
                'crusher-motor': 'È¢öÂºèÁ†¥Á¢éÊú∫ÁîµÊú∫',
                'crusher-bearing': 'È¢öÂºèÁ†¥Á¢éÊú∫ËΩ¥Êâø',
                'crusher-1': 'È¢öÂºèÁ†¥Á¢éÊú∫',
                'ball-mill': 'ÁêÉÁ£®Êú∫',
                'mill-motor': 'ÁêÉÁ£®Êú∫‰∏ªÁîµÊú∫',
                'mill-gearbox': 'ÁêÉÁ£®Êú∫ÂáèÈÄüÂô®',
                'rotary-kiln': 'ÂõûËΩ¨Á™ë',
                'crushing-workshop': 'Á†¥Á¢éÂ∑•ÊÆµ',
                'grinding-workshop': 'Á≤âÁ£®Â∑•ÊÆµ',
                'burning-workshop': 'ÁÖÖÁÉßÂ∑•ÊÆµ'
            };
            return deviceNames[deviceId] || deviceId;
        }

        // ÂÖ®Â±èËßÜÂõæÂàáÊç¢
        let isFullscreenView = false;
        function toggleFullscreenView() {
            const leftPanel = document.getElementById('metrics-panel');
            const rightPanel = document.getElementById('right-metrics-panel');
            const expandButton = document.getElementById('expand-toggle');
            const globalTooltip = document.getElementById('global-tooltip');
            
            isFullscreenView = !isFullscreenView;
            
            // ÈöêËóèÂ∑•ÂÖ∑ÊèêÁ§∫
            if (globalTooltip) {
                globalTooltip.classList.remove('show');
            }
            
            if (isFullscreenView) {
                // ÈöêËóèÂ∑¶Âè≥Èù¢Êùø
                leftPanel.style.display = 'none';
                rightPanel.style.display = 'none';
                expandButton.textContent = '‚§°';
                expandButton.classList.add('active');
                expandButton.setAttribute('data-tooltip', 'ÈÄÄÂá∫ÂÖ®Â±è');
            } else {
                // ÊòæÁ§∫Â∑¶Âè≥Èù¢Êùø
                leftPanel.style.display = 'block';
                rightPanel.style.display = 'block';
                expandButton.textContent = '‚§¢';
                expandButton.classList.remove('active');
                expandButton.setAttribute('data-tooltip', 'ÂÖ®Â±èËßÜÂõæ');
            }
        }

        // Ëé∑ÂèñËäÇÁÇπÊåáÊ†áÊï∞ÊçÆ (‰øùÁïôÂÖºÂÆπÊÄß)
        function getNodeMetrics(nodeId) {
            const deviceData = getEnhancedDeviceData(nodeId);
            return [
                { label: 'Ê∏©Â∫¶', value: deviceData.temperature, unit: '¬∞C' },
                { label: 'ÂéãÂäõ', value: deviceData.pressure, unit: ' MPa' },
                { label: 'ÊïàÁéá', value: deviceData.efficiency, unit: '%' },
                { label: 'ÂäüÁéá', value: deviceData.power, unit: ' kW' }
            ];
        }

        // ÂÆâÂÖ®ÁöÑÊï∞ÂÄºÊ†ºÂºèÂåñÂáΩÊï∞
        function safeFormat(value, decimals = 1) {
            if (typeof value === 'number' && !isNaN(value)) {
                return decimals === 0 ? Math.round(value).toString() : value.toFixed(decimals);
            } else if (typeof value === 'string' && !isNaN(parseFloat(value))) {
                const num = parseFloat(value);
                return decimals === 0 ? Math.round(num).toString() : num.toFixed(decimals);
            }
            return value ? value.toString() : '0';
        }

        // Áªü‰∏ÄÁöÑËäÇÁÇπÂàáÊç¢ÂáΩÊï∞ - Â§ÑÁêÜÊâÄÊúâÂàáÊç¢Âú∫ÊôØ
        function switchToNode(nodeId, source = 'unknown') {
            try {
                console.log(`‰ªé${source}ÂàáÊç¢Âà∞ËäÇÁÇπ:`, nodeId);
                
                // Ê£ÄÊü•ËäÇÁÇπIDÊòØÂê¶ÊúâÊïà
                if (!nodeId || typeof nodeId !== 'string') {
                    console.warn('Êó†ÊïàÁöÑËäÇÁÇπID:', nodeId);
                    return false;
                }
                
                // Ëé∑ÂèñËäÇÁÇπÊï∞ÊçÆ
                const deviceData = getEnhancedDeviceData(nodeId);
                if (!deviceData || !deviceData.name) {
                    console.warn('Êú™ÊâæÂà∞ËäÇÁÇπÊï∞ÊçÆ:', nodeId);
                    // Â¶ÇÊûúÊâæ‰∏çÂà∞Êï∞ÊçÆÔºå‰ΩøÁî®ÈªòËÆ§ÁöÑÂ∑•ÂéÇÊï∞ÊçÆ
                    if (nodeId !== 'cement-factory') {
                        return switchToNode('cement-factory', 'fallback');
                    }
                    return false;
                }
                
                // Êõ¥Êñ∞ÂÖ®Â±ÄÈÄâ‰∏≠ËäÇÁÇπ
                selectedNode = {
                    id: nodeId,
                    level: deviceData.level || 'unknown',
                    name: deviceData.name || nodeId
                };
                
                // 1. Êõ¥Êñ∞Ê†ëÂΩ¢ÁªìÊûÑÈÄâ‰∏≠Áä∂ÊÄÅ
                try {
                    updateTreeSelection(nodeId);
                } catch (e) {
                    console.warn('Êõ¥Êñ∞Ê†ëÂΩ¢ÁªìÊûÑÂ§±Ë¥•:', e);
                }
                
                // 2. Êõ¥Êñ∞‰∏ãÊãâÊ°ÜÊòæÁ§∫
                try {
                    const selectedAssetSpan = document.getElementById('selected-asset');
                    if (selectedAssetSpan) {
                        selectedAssetSpan.textContent = deviceData.name;
                    }
                } catch (e) {
                    console.warn('Êõ¥Êñ∞‰∏ãÊãâÊ°ÜÊòæÁ§∫Â§±Ë¥•:', e);
                }
                
                // 3. Êõ¥Êñ∞Èù¢ÂåÖÂ±ëÂØºËà™
                try {
                    updateBreadcrumb();
                } catch (e) {
                    console.warn('Êõ¥Êñ∞Èù¢ÂåÖÂ±ëÂ§±Ë¥•:', e);
                }
                
                // 4. Êõ¥Êñ∞Â∑¶‰æßÊåáÊ†áÈù¢Êùø
                try {
                    updateMetricsForNode(nodeId);
                } catch (e) {
                    console.warn('Êõ¥Êñ∞Â∑¶‰æßÊåáÊ†áÈù¢ÊùøÂ§±Ë¥•:', e);
                }
                
                // 5. Êõ¥Êñ∞Âè≥‰æßÁ≥ªÁªüÊ¶ÇËßàÈù¢Êùø
                try {
                    updateRightMetricsPanel();
                } catch (e) {
                    console.warn('Êõ¥Êñ∞Âè≥‰æßÁ≥ªÁªüÊ¶ÇËßàÈù¢ÊùøÂ§±Ë¥•:', e);
                }
                
                // 6. Êõ¥Êñ∞3DËßÜÂõæ
                try {
                    if (scene && camera) {
                        update3DViewForNode(nodeId);
                    }
                } catch (e) {
                    console.warn('Êõ¥Êñ∞3DËßÜÂõæÂ§±Ë¥•:', e);
                }
                
                // 7. Êõ¥Êñ∞2DËßÜÂõæ
                try {
                    if (document.getElementById('svg-canvas')) {
                        update2DViewForNode(nodeId);
                    }
                } catch (e) {
                    console.warn('Êõ¥Êñ∞2DËßÜÂõæÂ§±Ë¥•:', e);
                }
                
                // 8. Â¶ÇÊûúÊòØÂëäË≠¶ËäÇÁÇπÔºåËá™Âä®ÊîæÂ§ß/ËÅöÁÑ¶
                try {
                    const treeNode = document.querySelector(`[data-id="${nodeId}"]`);
                    if (treeNode && (treeNode.classList.contains('alarm-low') || 
                        treeNode.classList.contains('alarm-medium') || 
                        treeNode.classList.contains('alarm-high'))) {
                        zoomToNode(selectedNode);
                    }
                } catch (e) {
                    console.warn('ÊîæÂ§ßÂëäË≠¶ËäÇÁÇπÂ§±Ë¥•:', e);
                }
                
                // 9. ÂÖ≥Èó≠‰∏ãÊãâÊ°ÜÔºàÂ¶ÇÊûúÊòØ‰ªé‰∏ãÊãâÊ°ÜÂàáÊç¢ÁöÑÔºâ
                try {
                    const dropdownContent = document.getElementById('tree-dropdown-content');
                    if (dropdownContent) {
                        dropdownContent.classList.remove('show');
                    }
                } catch (e) {
                    console.warn('ÂÖ≥Èó≠‰∏ãÊãâÊ°ÜÂ§±Ë¥•:', e);
                }
                
                console.log('ËäÇÁÇπÂàáÊç¢ÂÆåÊàê:', selectedNode);
                return true;
                
            } catch (error) {
                console.error('ËäÇÁÇπÂàáÊç¢ËøáÁ®ã‰∏≠ÂèëÁîüÈîôËØØ:', error);
                console.error('ÈîôËØØÂèëÁîüÂú®ËäÇÁÇπ:', nodeId, 'Êù•Ê∫ê:', source);
                
                // Â¶ÇÊûú‰∏çÊòØÂ∑•ÂéÇËäÇÁÇπÔºåÂ∞ùËØïÂõûÈÄÄÂà∞Â∑•ÂéÇËäÇÁÇπ
                if (nodeId !== 'cement-factory') {
                    console.log('Â∞ùËØïÂõûÈÄÄÂà∞Â∑•ÂéÇËäÇÁÇπ...');
                    return switchToNode('cement-factory', 'error_fallback');
                }
                
                return false;
            }
        }

        // Êõ¥Êñ∞3DËßÜÂõæ‰ª•ÊòæÁ§∫ÊåáÂÆöËäÇÁÇπ
        function update3DViewForNode(nodeId) {
            // ÈáçÁΩÆÊâÄÊúâÂØπË±°ÁöÑÂèØËßÅÊÄß
            scene.traverse((child) => {
                if (child.userData && child.userData.id) {
                    child.visible = true;
                }
            });
            
            // ËÅöÁÑ¶Âà∞ÁõÆÊ†áËäÇÁÇπ
            focusOn3DNode(nodeId);
        }

        // Êõ¥Êñ∞2DËßÜÂõæ‰ª•ÊòæÁ§∫ÊåáÂÆöËäÇÁÇπ
        function update2DViewForNode(nodeId) {
            const deviceData = getEnhancedDeviceData(nodeId);
            
            switch(deviceData.level) {
                case 'factory':
                    // ÊòæÁ§∫Â∑•ÂéÇÊÄªËßà
                    init2DView();
                    break;
                case 'workshop':
                    // ÊòæÁ§∫Â∑•ÊÆµËØ¶ÊÉÖ
                    generate2DWorkshopDetail(nodeId);
                    break;
                case 'equipment':
                    // ÊòæÁ§∫ËÆæÂ§áËØ¶ÊÉÖ
                    generate2DEquipmentDetail(nodeId);
                    break;
                case 'component':
                    // ÊòæÁ§∫ÁªÑ‰ª∂ËØ¶ÊÉÖ
                    generate2DComponentDetail(nodeId);
                    break;
                default:
                    // ÈªòËÆ§ÊòæÁ§∫Â∑•ÂéÇÊÄªËßà
                    init2DView();
                    break;
            }
        }

        // Êõ¥Êñ∞ËßÜÂõæ (‰øùÁïôÂÖºÂÆπÊÄß)
        function updateView() {
            if (selectedNode) {
                console.log('Êõ¥Êñ∞ËßÜÂõæ:', selectedNode);
                // Ë∞ÉÁî®Áªü‰∏ÄÁöÑÂàáÊç¢ÂáΩÊï∞
                switchToNode(selectedNode.id, 'view_update');
            }
        }

        // Êõ¥Êñ∞Èù¢ÂåÖÂ±ëÂØºËà™
        function updateBreadcrumb() {
            const breadcrumbContent = document.querySelector('.breadcrumb-content');
            if (selectedNode && breadcrumbContent) {
                // Ê†πÊçÆÂΩìÂâçÈÄâ‰∏≠ËäÇÁÇπÁîüÊàêÈù¢ÂåÖÂ±ëË∑ØÂæÑ
                const breadcrumbPath = generateBreadcrumbPath(selectedNode.id);
                breadcrumbContent.innerHTML = breadcrumbPath.map((item, index) => 
                    `<span class="breadcrumb-item" data-id="${item.id}">${item.name}</span>` +
                    (index < breadcrumbPath.length - 1 ? '<span class="breadcrumb-separator">></span>' : '')
                ).join('');
            }
        }

        // ÁîüÊàêÈù¢ÂåÖÂ±ëË∑ØÂæÑ
        function generateBreadcrumbPath(nodeId) {
            const path = [];
            
            // ÂßãÁªàÂåÖÂê´Â∑•ÂéÇÊ†πËäÇÁÇπ
            path.push({ id: 'cement-factory', name: 'Ê∞¥Ê≥•Â∑•ÂéÇ' });
            
            if (nodeId === 'cement-factory') {
                return path;
            }
            
            // Ê†πÊçÆnodeIdÁ°ÆÂÆöÂ±ÇÁ∫ßË∑ØÂæÑ
            const deviceData = getEnhancedDeviceData(nodeId);
            if (!deviceData) return path;
            
            // Ê†πÊçÆ‰∏çÂêåÂ±ÇÁ∫ßÊ∑ªÂä†Áà∂Á∫ßË∑ØÂæÑ
            switch(deviceData.level) {
                case 'workshop':
                    path.push({ id: nodeId, name: deviceData.name });
                    break;
                    
                case 'equipment':
                    // Ê∑ªÂä†ÊâÄÂ±ûÂ∑•ÊÆµ
                    if (nodeId.includes('crusher') || nodeId.includes('conveyor')) {
                        path.push({ id: 'crushing-workshop', name: 'Á†¥Á¢éÂ∑•ÊÆµ' });
                    } else if (nodeId.includes('ball-mill') || nodeId.includes('separator')) {
                        path.push({ id: 'grinding-workshop', name: 'Á≤âÁ£®Â∑•ÊÆµ' });
                    } else if (nodeId.includes('rotary-kiln')) {
                        path.push({ id: 'burning-workshop', name: 'ÁÖÖÁÉßÂ∑•ÊÆµ' });
                    }
                    path.push({ id: nodeId, name: deviceData.name });
                    break;
                    
                case 'component':
                    // Ê∑ªÂä†ÊâÄÂ±ûÂ∑•ÊÆµÂíåËÆæÂ§á
                    if (nodeId.includes('crusher')) {
                        path.push({ id: 'crushing-workshop', name: 'Á†¥Á¢éÂ∑•ÊÆµ' });
                        path.push({ id: 'crusher-1', name: 'È¢öÂºèÁ†¥Á¢éÊú∫' });
                    } else if (nodeId.includes('mill')) {
                        path.push({ id: 'grinding-workshop', name: 'Á≤âÁ£®Â∑•ÊÆµ' });
                        path.push({ id: 'ball-mill', name: 'ÁêÉÁ£®Êú∫' });
                    } else if (nodeId.includes('kiln')) {
                        path.push({ id: 'burning-workshop', name: 'ÁÖÖÁÉßÂ∑•ÊÆµ' });
                        path.push({ id: 'rotary-kiln', name: 'ÂõûËΩ¨Á™ë' });
                    }
                    path.push({ id: nodeId, name: deviceData.name });
                    break;
            }
            
            return path;
        }

        // Ê†πÊçÆ‰∏ãÈíªË∑ØÂæÑÁîüÊàêÈù¢ÂåÖÂ±ë
        function generateBreadcrumbFromDrillPath() {
            const breadcrumbPath = [];
            
            // ÊÄªÊòØ‰ªéÂ∑•ÂéÇÂºÄÂßã
            if (drillPath.length === 0 || drillPath[0] !== 'cement-factory') {
                breadcrumbPath.push({ id: 'cement-factory', name: 'Ê∞¥Ê≥•Â∑•ÂéÇ' });
            }
            
            // Ê∑ªÂä†‰∏ãÈíªË∑ØÂæÑ‰∏≠ÁöÑËäÇÁÇπ
            drillPath.forEach(nodeId => {
                const node = assetHierarchy[nodeId];
                if (node) {
                    breadcrumbPath.push({ id: nodeId, name: node.name });
                }
            });
            
            return breadcrumbPath;
        }

        // Ëé∑ÂèñÈù¢ÂåÖÂ±ëË∑ØÂæÑ
        function getBreadcrumbPath(node) {
            const paths = {
                'cement-factory': [{ id: 'cement-factory', name: 'Ê∞¥Ê≥•Â∑•ÂéÇ' }],
                'crushing-workshop': [
                    { id: 'cement-factory', name: 'Ê∞¥Ê≥•Â∑•ÂéÇ' },
                    { id: 'crushing-workshop', name: 'Á†¥Á¢éÂ∑•ÊÆµ' }
                ],
                'grinding-workshop': [
                    { id: 'cement-factory', name: 'Ê∞¥Ê≥•Â∑•ÂéÇ' },
                    { id: 'grinding-workshop', name: 'Á≤âÁ£®Â∑•ÊÆµ' }
                ],
                'calcining-workshop': [
                    { id: 'cement-factory', name: 'Ê∞¥Ê≥•Â∑•ÂéÇ' },
                    { id: 'calcining-workshop', name: 'ÁÖÖÁÉßÂ∑•ÊÆµ' }
                ],
                'crusher-1': [
                    { id: 'cement-factory', name: 'Ê∞¥Ê≥•Â∑•ÂéÇ' },
                    { id: 'crushing-workshop', name: 'Á†¥Á¢éÂ∑•ÊÆµ' },
                    { id: 'crusher-1', name: 'È¢öÂºèÁ†¥Á¢éÊú∫ #1' }
                ],
                'ball-mill': [
                    { id: 'cement-factory', name: 'Ê∞¥Ê≥•Â∑•ÂéÇ' },
                    { id: 'grinding-workshop', name: 'Á≤âÁ£®Â∑•ÊÆµ' },
                    { id: 'ball-mill', name: 'ÁêÉÁ£®Êú∫' }
                ],
                'rotary-kiln': [
                    { id: 'cement-factory', name: 'Ê∞¥Ê≥•Â∑•ÂéÇ' },
                    { id: 'calcining-workshop', name: 'ÁÖÖÁÉßÂ∑•ÊÆµ' },
                    { id: 'rotary-kiln', name: 'ÂõûËΩ¨Á™ë' }
                ],
                'cement-mill': [
                    { id: 'cement-factory', name: 'Ê∞¥Ê≥•Â∑•ÂéÇ' },
                    { id: 'grinding-workshop', name: 'Á≤âÁ£®Â∑•ÊÆµ' },
                    { id: 'cement-mill', name: 'Ê∞¥Ê≥•Á£®' }
                ],
                'crusher-motor': [
                    { id: 'cement-factory', name: 'Ê∞¥Ê≥•Â∑•ÂéÇ' },
                    { id: 'crushing-workshop', name: 'Á†¥Á¢éÂ∑•ÊÆµ' },
                    { id: 'crusher-1', name: 'È¢öÂºèÁ†¥Á¢éÊú∫ #1' },
                    { id: 'crusher-motor', name: 'È©±Âä®ÁîµÊú∫' }
                ],
                'crusher-bearing': [
                    { id: 'cement-factory', name: 'Ê∞¥Ê≥•Â∑•ÂéÇ' },
                    { id: 'crushing-workshop', name: 'Á†¥Á¢éÂ∑•ÊÆµ' },
                    { id: 'crusher-1', name: 'È¢öÂºèÁ†¥Á¢éÊú∫ #1' },
                    { id: 'crusher-bearing', name: 'ËΩ¥Êâø' }
                ],
                'ball-mill-motor': [
                    { id: 'cement-factory', name: 'Ê∞¥Ê≥•Â∑•ÂéÇ' },
                    { id: 'grinding-workshop', name: 'Á≤âÁ£®Â∑•ÊÆµ' },
                    { id: 'ball-mill', name: 'ÁêÉÁ£®Êú∫' },
                    { id: 'ball-mill-motor', name: '‰∏ªÁîµÊú∫' }
                ]
            };
            
            return paths[node.id] || [{ id: node.id, name: node.name || node.id }];
        }

        // ÂØºËà™Âà∞ÊåáÂÆöËäÇÁÇπ
        function navigateToNode(nodeId) {
            console.log('ÂØºËà™Âà∞ËäÇÁÇπ:', nodeId);
            
            // Êõ¥Êñ∞ÈÄâ‰∏≠ËäÇÁÇπ
            const treeNode = document.querySelector(`[data-id="${nodeId}"]`);
            if (treeNode) {
                // ÁßªÈô§ÊâÄÊúâÈÄâ‰∏≠Áä∂ÊÄÅ
                document.querySelectorAll('.tree-node').forEach(node => {
                    node.classList.remove('selected');
                });
                
                // Ê∑ªÂä†ÈÄâ‰∏≠Áä∂ÊÄÅ
                treeNode.classList.add('selected');
                
                // Â±ïÂºÄÁà∂ËäÇÁÇπ
                expandParentNodes(treeNode);
                
                // Êõ¥Êñ∞ÈÄâ‰∏≠ËäÇÁÇπ
                selectedNode = { id: nodeId, name: treeNode.textContent.trim() };
                
                // Êõ¥Êñ∞Èù¢ÂåÖÂ±ë
                updateBreadcrumb();
                
                // Êõ¥Êñ∞ËßÜÂõæ - Ëá™Âä®ËÅöÁÑ¶Âà∞ÈÄâ‰∏≠ËäÇÁÇπ
                focusOnNode(nodeId);
                
                // Êõ¥Êñ∞ÊåáÊ†áÈù¢Êùø
                updateMetricsForNode(nodeId);
            }
        }

        // Â±ïÂºÄÁà∂ËäÇÁÇπ
        function expandParentNodes(node) {
            let parent = node.parentElement;
            while (parent) {
                if (parent.classList && parent.classList.contains('tree-children')) {
                    parent.style.display = 'block';
                    // ÊâæÂà∞ÂØπÂ∫îÁöÑÁà∂ËäÇÁÇπÂπ∂Ê†áËÆ∞‰∏∫Â±ïÂºÄ
                    const parentNode = parent.previousElementSibling;
                    if (parentNode && parentNode.querySelector('.tree-toggle')) {
                        parentNode.querySelector('.tree-toggle').textContent = '‚àí';
                    }
                }
                parent = parent.parentElement;
            }
        }

        // ËÅöÁÑ¶Âà∞ÊåáÂÆöËäÇÁÇπ
        function focusOnNode(nodeId) {
            if (currentView === '3d') {
                focusOn3DNode(nodeId);
            } else {
                focusOn2DNode(nodeId);
            }
        }

        // 3DËßÜÂõæËÅöÁÑ¶
        function focusOn3DNode(nodeId) {
            // Â∞ùËØïÂ§öÁßçÊñπÂºèÊâæÂà∞ÂØπË±°
            let targetObject = scene.children.find(child => 
                child.userData && child.userData.id === nodeId
            );
            
            // Â¶ÇÊûúÁõ¥Êé•Êâæ‰∏çÂà∞ÔºåÂ∞ùËØïÈÄíÂΩíÊü•Êâæ
            if (!targetObject) {
                scene.traverse(child => {
                    if (child.userData && child.userData.id === nodeId && !targetObject) {
                        targetObject = child;
                    }
                });
            }
            
            if (targetObject && camera && controls) {
                // ËÆ°ÁÆóÁõÆÊ†á‰ΩçÁΩÆ
                const box = new THREE.Box3().setFromObject(targetObject);
                const center = box.getCenter(new THREE.Vector3());
                const size = box.getSize(new THREE.Vector3());
                
                // Ê†πÊçÆÂ±ÇÁ∫ßË∞ÉÊï¥Áõ∏Êú∫Ë∑ùÁ¶ª
                const node = assetHierarchy[nodeId];
                let distanceMultiplier = 2;
                
                if (node) {
                    switch (node.type) {
                        case 'factory':
                            distanceMultiplier = 3;
                            break;
                        case 'workshop':
                            distanceMultiplier = 2;
                            break;
                        case 'equipment':
                            distanceMultiplier = 1.5;
                            break;
                        case 'component':
                            distanceMultiplier = 1;
                            break;
                    }
                }
                
                // ËÆæÁΩÆÁõ∏Êú∫‰ΩçÁΩÆ
                const maxDim = Math.max(size.x, size.y, size.z);
                const fov = camera.fov * (Math.PI / 180);
                let cameraZ = Math.abs(maxDim / 2 / Math.tan(fov / 2));
                
                cameraZ *= distanceMultiplier; // Ê†πÊçÆÂ±ÇÁ∫ßË∞ÉÊï¥Ë∑ùÁ¶ª
                cameraZ = Math.max(cameraZ, 10); // ÊúÄÂ∞èË∑ùÁ¶ª
                
                // Âπ≥ÊªëÂä®ÁîªÂà∞ÁõÆÊ†á‰ΩçÁΩÆ
                animateCamera(
                    camera.position,
                    new THREE.Vector3(center.x, center.y, center.z + cameraZ),
                    center
                );
            } else {
                console.warn(`Êó†Ê≥ïÊâæÂà∞ËäÇÁÇπ ${nodeId} ÂØπÂ∫îÁöÑ3DÂØπË±°`);
            }
        }

        // 2DËßÜÂõæËÅöÁÑ¶
        function focusOn2DNode(nodeId) {
            const svgElement = document.querySelector(`#svg-container rect[id="${nodeId}"]`);
            if (svgElement) {
                const rect = svgElement.getBoundingClientRect();
                const container = document.getElementById('svg-container');
                
                // ÊªöÂä®Âà∞ÁõÆÊ†áÂÖÉÁ¥†
                container.scrollTo({
                    left: rect.left - container.offsetWidth / 2,
                    top: rect.top - container.offsetHeight / 2,
                    behavior: 'smooth'
                });
                
                // È´ò‰∫ÆÊòæÁ§∫
                svgElement.style.stroke = '#0078d4';
                svgElement.style.strokeWidth = '3';
                
                // 2ÁßíÂêéÊÅ¢Â§ç
                setTimeout(() => {
                    svgElement.style.stroke = '#333';
                    svgElement.style.strokeWidth = '1';
                }, 2000);
            }
        }

        // Áõ∏Êú∫Âä®Áîª
        function animateCamera(startPos, endPos, lookAt) {
            const duration = 1000; // 1Áßí
            const startTime = Date.now();
            
            function animate() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // ‰ΩøÁî®easeInOutCubicÁºìÂä®ÂáΩÊï∞
                const eased = progress < 0.5 
                    ? 4 * progress * progress * progress
                    : 1 - Math.pow(-2 * progress + 2, 3) / 2;
                
                // ÊèíÂÄºËÆ°ÁÆóÂΩìÂâç‰ΩçÁΩÆ
                camera.position.lerpVectors(startPos, endPos, eased);
                
                // Êõ¥Êñ∞ÊéßÂà∂Âô®ÁõÆÊ†á
                if (controls) {
                    controls.target.copy(lookAt);
                    controls.update();
                }
                
                if (progress < 1) {
                    requestAnimationFrame(animate);
                }
            }
            
            animate();
        }

        // Êõ¥Êñ∞ËäÇÁÇπÊåáÊ†á
        function updateMetricsForNode(nodeId) {
            const deviceData = getEnhancedDeviceData(nodeId);
            
            // Êõ¥Êñ∞Â∑¶‰æßÊåáÊ†áÈù¢Êùø
            const metricsPanel = document.getElementById('metrics-panel');
            if (metricsPanel) {
                const statusAbnormal = deviceData.status === 'ÂëäË≠¶' ? ' abnormal' : '';
                
                let metricsHTML = `
                    <div class="sidebar-header">
                        <h3>${deviceData.name}</h3>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">ËøêË°åÁä∂ÊÄÅ</div>
                        <div class="metric-value${statusAbnormal}">${deviceData.status}</div>
                    </div>
                `;

                // Ê†πÊçÆËÆæÂ§áÂ±ÇÁ∫ßÊòæÁ§∫‰∏çÂêåÊåáÊ†á
                switch(deviceData.level) {
                    case 'factory':
                        const prodAbnormal = isMetricAbnormal('totalProduction', deviceData.totalProduction, nodeId) ? ' abnormal' : '';
                        const overallEffAbnormal = isMetricAbnormal('overallEfficiency', deviceData.overallEfficiency, nodeId) ? ' abnormal' : '';
                        const totalPowerAbnormal = isMetricAbnormal('totalPower', deviceData.totalPower, nodeId) ? ' abnormal' : '';
                        const onlineEquipAbnormal = isMetricAbnormal('onlineEquipment', deviceData.onlineEquipment, nodeId) ? ' abnormal' : '';
                        const alarmCountAbnormal = isMetricAbnormal('alarmCount', deviceData.alarmCount, nodeId) ? ' abnormal' : '';

                        metricsHTML += `
                            <div class="metric-item">
                                <div class="metric-label">ÊÄª‰∫ßÈáè</div>
                                <div class="metric-value${prodAbnormal}">${safeFormat(deviceData.totalProduction, 0)}<span class="metric-unit">t</span></div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">Êï¥‰ΩìÊïàÁéá</div>
                                <div class="metric-value${overallEffAbnormal}">${safeFormat(deviceData.overallEfficiency, 1)}<span class="metric-unit">%</span></div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">ÊÄªÂäüÁéá</div>
                                <div class="metric-value${totalPowerAbnormal}">${safeFormat(deviceData.totalPower, 0)}<span class="metric-unit">kW</span></div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">Âú®Á∫øËÆæÂ§á</div>
                                <div class="metric-value${onlineEquipAbnormal}">${safeFormat(deviceData.onlineEquipment, 0)}/${safeFormat(deviceData.totalEquipment, 0)}<span class="metric-unit">Âè∞</span></div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">ÂëäË≠¶Êï∞Èáè</div>
                                <div class="metric-value${alarmCountAbnormal}">${safeFormat(deviceData.alarmCount, 0)}<span class="metric-unit">È°π</span></div>
                            </div>
                        `;
                        break;

                    case 'workshop':
                        const workshopEffAbnormal = isMetricAbnormal('workshopEfficiency', deviceData.workshopEfficiency, nodeId) ? ' abnormal' : '';
                        const workshopPowerAbnormal = isMetricAbnormal('workshopPower', deviceData.workshopPower, nodeId) ? ' abnormal' : '';
                        const throughputAbnormal = isMetricAbnormal('materialThroughput', deviceData.materialThroughput, nodeId) ? ' abnormal' : '';
                        const avgVibrationAbnormal = isMetricAbnormal('avgVibration', deviceData.avgVibration, nodeId) ? ' abnormal' : '';

                        metricsHTML += `
                            <div class="metric-item">
                                <div class="metric-label">Â∑•ÊÆµÊïàÁéá</div>
                                <div class="metric-value${workshopEffAbnormal}">${safeFormat(deviceData.workshopEfficiency, 1)}<span class="metric-unit">%</span></div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">Â∑•ÊÆµÂäüÁéá</div>
                                <div class="metric-value${workshopPowerAbnormal}">${safeFormat(deviceData.workshopPower, 0)}<span class="metric-unit">kW</span></div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">Áâ©ÊñôÂ§ÑÁêÜÈáè</div>
                                <div class="metric-value${throughputAbnormal}">${safeFormat(deviceData.materialThroughput, 1)}<span class="metric-unit">t/h</span></div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">ËÆæÂ§áÁä∂ÊÄÅ</div>
                                <div class="metric-value">${safeFormat(deviceData.runningCount, 0)}/${safeFormat(deviceData.equipmentCount, 0)}<span class="metric-unit">Âè∞ËøêË°å</span></div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">Âπ≥ÂùáÊåØÂä®</div>
                                <div class="metric-value${avgVibrationAbnormal}">${safeFormat(deviceData.avgVibration, 1)}<span class="metric-unit">mm/s</span></div>
                            </div>
                        `;

                        // ÁÖÖÁÉßÂ∑•ÊÆµÁâπÊÆäÊòæÁ§∫Âπ≥ÂùáÊ∏©Â∫¶
                        if (deviceData.avgTemperature) {
                            const avgTempAbnormal = isMetricAbnormal('avgTemperature', deviceData.avgTemperature, nodeId) ? ' abnormal' : '';
                            metricsHTML += `
                                <div class="metric-item">
                                    <div class="metric-label">Âπ≥ÂùáÊ∏©Â∫¶</div>
                                    <div class="metric-value${avgTempAbnormal}">${safeFormat(deviceData.avgTemperature, 0)}<span class="metric-unit">¬∞C</span></div>
                                </div>
                            `;
                        }
                        break;

                    case 'equipment':
                        const tempAbnormal = isMetricAbnormal('temperature', deviceData.temperature, nodeId) ? ' abnormal' : '';
                        const pressureAbnormal = isMetricAbnormal('pressure', deviceData.pressure, nodeId) ? ' abnormal' : '';
                        const speedAbnormal = isMetricAbnormal('speed', deviceData.speed, nodeId) ? ' abnormal' : '';
                        const efficiencyAbnormal = isMetricAbnormal('efficiency', deviceData.efficiency, nodeId) ? ' abnormal' : '';
                        const powerAbnormal = isMetricAbnormal('power', deviceData.power, nodeId) ? ' abnormal' : '';
                        const vibrationAbnormal = isMetricAbnormal('vibration', deviceData.vibration, nodeId) ? ' abnormal' : '';

                        metricsHTML += `
                            <div class="metric-item">
                                <div class="metric-label">Ê∏©Â∫¶</div>
                                <div class="metric-value${tempAbnormal}">${safeFormat(deviceData.temperature, 1)}<span class="metric-unit">¬∞C</span></div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">ÂéãÂäõ</div>
                                <div class="metric-value${pressureAbnormal}">${safeFormat(deviceData.pressure, 1)}<span class="metric-unit">MPa</span></div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">ËΩ¨ÈÄü</div>
                                <div class="metric-value${speedAbnormal}">${safeFormat(deviceData.speed, 0)}<span class="metric-unit">rpm</span></div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">ÊïàÁéá</div>
                                <div class="metric-value${efficiencyAbnormal}">${safeFormat(deviceData.efficiency, 1)}<span class="metric-unit">%</span></div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">ÂäüÁéá</div>
                                <div class="metric-value${powerAbnormal}">${safeFormat(deviceData.power, 0)}<span class="metric-unit">kW</span></div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">ÊåØÂä®</div>
                                <div class="metric-value${vibrationAbnormal}">${safeFormat(deviceData.vibration, 1)}<span class="metric-unit">mm/s</span></div>
                            </div>
                        `;
                        break;

                    case 'component':
                        // Ê†πÊçÆ‰∏çÂêåÁªÑ‰ª∂ÊòæÁ§∫ÁâπÂÆöÊåáÊ†á
                        if (nodeId.includes('motor')) {
                            const voltageAbnormal = isMetricAbnormal('voltage', deviceData.voltage, nodeId) ? ' abnormal' : '';
                            const currentAbnormal = isMetricAbnormal('current', deviceData.current, nodeId) ? ' abnormal' : '';
                            const tempAbnormal = isMetricAbnormal('temperature', deviceData.temperature, nodeId) ? ' abnormal' : '';
                            const powerAbnormal = isMetricAbnormal('power', deviceData.power, nodeId) ? ' abnormal' : '';
                            const efficiencyAbnormal = isMetricAbnormal('efficiency', deviceData.efficiency, nodeId) ? ' abnormal' : '';
                            const vibrationAbnormal = isMetricAbnormal('vibration', deviceData.vibration, nodeId) ? ' abnormal' : '';

                            metricsHTML += `
                                <div class="metric-item">
                                    <div class="metric-label">ÁîµÂéã</div>
                                    <div class="metric-value${voltageAbnormal}">${safeFormat(deviceData.voltage, 0)}<span class="metric-unit">V</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">ÁîµÊµÅ</div>
                                    <div class="metric-value${currentAbnormal}">${safeFormat(deviceData.current, 1)}<span class="metric-unit">A</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">Ê∏©Â∫¶</div>
                                    <div class="metric-value${tempAbnormal}">${safeFormat(deviceData.temperature, 1)}<span class="metric-unit">¬∞C</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">ÂäüÁéá</div>
                                    <div class="metric-value${powerAbnormal}">${safeFormat(deviceData.power, 0)}<span class="metric-unit">kW</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">ÊïàÁéá</div>
                                    <div class="metric-value${efficiencyAbnormal}">${safeFormat(deviceData.efficiency, 1)}<span class="metric-unit">%</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">ÊåØÂä®</div>
                                    <div class="metric-value${vibrationAbnormal}">${safeFormat(deviceData.vibration, 1)}<span class="metric-unit">mm/s</span></div>
                                </div>
                            `;
                        } else if (nodeId.includes('bearing')) {
                            const tempAbnormal = isMetricAbnormal('temperature', deviceData.temperature, nodeId) ? ' abnormal' : '';
                            const lubricationAbnormal = isMetricAbnormal('lubrication', deviceData.lubrication, nodeId) ? ' abnormal' : '';
                            const vibrationAbnormal = isMetricAbnormal('vibration', deviceData.vibration, nodeId) ? ' abnormal' : '';
                            const wearAbnormal = isMetricAbnormal('wear', deviceData.wear, nodeId) ? ' abnormal' : '';
                            const runningTimeAbnormal = isMetricAbnormal('runningTime', deviceData.runningTime, nodeId) ? ' abnormal' : '';

                            metricsHTML += `
                                <div class="metric-item">
                                    <div class="metric-label">Ê∏©Â∫¶</div>
                                    <div class="metric-value${tempAbnormal}">${safeFormat(deviceData.temperature, 1)}<span class="metric-unit">¬∞C</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">Ê∂¶ÊªëÁä∂ÊÄÅ</div>
                                    <div class="metric-value${lubricationAbnormal}">${safeFormat(deviceData.lubrication, 1)}<span class="metric-unit">%</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">ÊåØÂä®</div>
                                    <div class="metric-value${vibrationAbnormal}">${safeFormat(deviceData.vibration, 1)}<span class="metric-unit">mm/s</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">Á£®ÊçüÁ®ãÂ∫¶</div>
                                    <div class="metric-value${wearAbnormal}">${safeFormat(deviceData.wear, 1)}<span class="metric-unit">%</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">ËøêË°åÊó∂Èó¥</div>
                                    <div class="metric-value${runningTimeAbnormal}">${safeFormat(deviceData.runningTime, 0)}<span class="metric-unit">h</span></div>
                                </div>
                            `;
                        } else if (nodeId.includes('gearbox')) {
                            const tempAbnormal = isMetricAbnormal('temperature', deviceData.temperature, nodeId) ? ' abnormal' : '';
                            const oilPressureAbnormal = isMetricAbnormal('oilPressure', deviceData.oilPressure, nodeId) ? ' abnormal' : '';
                            const oilTempAbnormal = isMetricAbnormal('oilTemperature', deviceData.oilTemperature, nodeId) ? ' abnormal' : '';
                            const vibrationAbnormal = isMetricAbnormal('vibration', deviceData.vibration, nodeId) ? ' abnormal' : '';
                            const efficiencyAbnormal = isMetricAbnormal('efficiency', deviceData.efficiency, nodeId) ? ' abnormal' : '';

                            metricsHTML += `
                                <div class="metric-item">
                                    <div class="metric-label">ÁÆ±‰ΩìÊ∏©Â∫¶</div>
                                    <div class="metric-value${tempAbnormal}">${safeFormat(deviceData.temperature, 1)}<span class="metric-unit">¬∞C</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">Ê≤πÂéã</div>
                                    <div class="metric-value${oilPressureAbnormal}">${safeFormat(deviceData.oilPressure, 2)}<span class="metric-unit">MPa</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">Ê≤πÊ∏©</div>
                                    <div class="metric-value${oilTempAbnormal}">${safeFormat(deviceData.oilTemperature, 1)}<span class="metric-unit">¬∞C</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">ÊåØÂä®</div>
                                    <div class="metric-value${vibrationAbnormal}">${safeFormat(deviceData.vibration, 1)}<span class="metric-unit">mm/s</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">‰º†Âä®ÊïàÁéá</div>
                                    <div class="metric-value${efficiencyAbnormal}">${safeFormat(deviceData.efficiency, 1)}<span class="metric-unit">%</span></div>
                                </div>
                            `;
                        } else if (nodeId.includes('burner')) {
                            const flameTempAbnormal = isMetricAbnormal('flameTemperature', deviceData.flameTemperature, nodeId) ? ' abnormal' : '';
                            const fuelPressureAbnormal = isMetricAbnormal('fuelPressure', deviceData.fuelPressure, nodeId) ? ' abnormal' : '';
                            const airPressureAbnormal = isMetricAbnormal('airPressure', deviceData.airPressure, nodeId) ? ' abnormal' : '';
                            const fuelFlowAbnormal = isMetricAbnormal('fuelFlow', deviceData.fuelFlow, nodeId) ? ' abnormal' : '';
                            const efficiencyAbnormal = isMetricAbnormal('efficiency', deviceData.efficiency, nodeId) ? ' abnormal' : '';

                            metricsHTML += `
                                <div class="metric-item">
                                    <div class="metric-label">ÁÅ´ÁÑ∞Ê∏©Â∫¶</div>
                                    <div class="metric-value${flameTempAbnormal}">${safeFormat(deviceData.flameTemperature, 0)}<span class="metric-unit">¬∞C</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">ÁáÉÊñôÂéãÂäõ</div>
                                    <div class="metric-value${fuelPressureAbnormal}">${safeFormat(deviceData.fuelPressure, 2)}<span class="metric-unit">MPa</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">È£éÂéã</div>
                                    <div class="metric-value${airPressureAbnormal}">${safeFormat(deviceData.airPressure, 1)}<span class="metric-unit">MPa</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">ÁáÉÊñôÊµÅÈáè</div>
                                    <div class="metric-value${fuelFlowAbnormal}">${safeFormat(deviceData.fuelFlow, 1)}<span class="metric-unit">m¬≥/h</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">ÁáÉÁÉßÊïàÁéá</div>
                                    <div class="metric-value${efficiencyAbnormal}">${safeFormat(deviceData.efficiency, 1)}<span class="metric-unit">%</span></div>
                                </div>
                            `;
                        } else if (nodeId.includes('cylinder')) {
                            const shellTempAbnormal = isMetricAbnormal('shellTemperature', deviceData.shellTemperature, nodeId) ? ' abnormal' : '';
                            const thicknessAbnormal = isMetricAbnormal('thickness', deviceData.thickness, nodeId) ? ' abnormal' : '';
                            const runoutAbnormal = isMetricAbnormal('runoutValue', deviceData.runoutValue, nodeId) ? ' abnormal' : '';
                            const vibrationAbnormal = isMetricAbnormal('vibration', deviceData.vibration, nodeId) ? ' abnormal' : '';
                            const rotationSpeedAbnormal = isMetricAbnormal('rotationSpeed', deviceData.rotationSpeed, nodeId) ? ' abnormal' : '';

                            metricsHTML += `
                                <div class="metric-item">
                                    <div class="metric-label">Á≠í‰ΩìË°®Èù¢Ê∏©Â∫¶</div>
                                    <div class="metric-value${shellTempAbnormal}">${safeFormat(deviceData.shellTemperature, 0)}<span class="metric-unit">¬∞C</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">Â£ÅÂéö</div>
                                    <div class="metric-value${thicknessAbnormal}">${safeFormat(deviceData.thickness, 1)}<span class="metric-unit">mm</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">ÂæÑÂêëË∑≥Âä®</div>
                                    <div class="metric-value${runoutAbnormal}">${safeFormat(deviceData.runoutValue, 1)}<span class="metric-unit">mm</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">ÊåØÂä®</div>
                                    <div class="metric-value${vibrationAbnormal}">${safeFormat(deviceData.vibration, 1)}<span class="metric-unit">mm/s</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">ËΩ¨ÈÄü</div>
                                    <div class="metric-value${rotationSpeedAbnormal}">${safeFormat(deviceData.rotationSpeed, 1)}<span class="metric-unit">rpm</span></div>
                                </div>
                            `;
                        }
                        break;

                    default:
                        // ÈªòËÆ§ÊòæÁ§∫ÈÄöÁî®ÊåáÊ†á
                        metricsHTML += `
                            <div class="metric-item">
                                <div class="metric-label">Êó†ÂèØÁî®ÊåáÊ†á</div>
                                <div class="metric-value">-</div>
                            </div>
                        `;
                        break;
                }

                metricsPanel.innerHTML = metricsHTML;
            }
            
            // Êõ¥Êñ∞Âè≥‰æßÁ≥ªÁªüÊ¶ÇËßàÈù¢Êùø
            updateRightMetricsPanel();
        }

        // Êõ¥Êñ∞Âè≥‰æßÊåáÊ†áÈù¢Êùø
        function updateRightMetricsPanel() {
            const rightPanel = document.getElementById('right-metrics-panel');
            if (!rightPanel) return;
            
            // Ê†πÊçÆÂΩìÂâçÊ®°ÂºèÁîüÊàê‰∏çÂêåÁöÑÁ≥ªÁªüÊ¶ÇËßàÊï∞ÊçÆ
            let systemData;
            switch(currentMode) {
                case 'realtime':
                    systemData = generateRealtimeSystemData();
                    break;
                case 'history':
                    systemData = generateHistorySystemData();
                    break;
                case 'simulation':
                    systemData = generateSimulationSystemData();
                    break;
                default:
                    systemData = generateRealtimeSystemData();
            }
            
            // Ê£ÄÊµãÁ≥ªÁªüÁ∫ßÊåáÊ†áÊòØÂê¶ÂºÇÂ∏∏
            const efficiencyAbnormal = isMetricAbnormal('overallEfficiency', systemData.overallEfficiency) ? ' abnormal' : '';
            const runtimeAbnormal = isMetricAbnormal('equipmentRuntime', systemData.equipmentRuntime) ? ' abnormal' : '';
            const energyAbnormal = isMetricAbnormal('avgEnergyConsumption', systemData.avgEnergyConsumption) ? ' abnormal' : '';
            const productionAbnormal = isMetricAbnormal('production', systemData.production) ? ' abnormal' : '';
            const alarmAbnormal = isMetricAbnormal('alarmCount', systemData.alarmCount) ? ' abnormal' : '';
            const onlineAbnormal = isMetricAbnormal('onlineDevices', systemData.onlineDevices) ? ' abnormal' : '';

            rightPanel.innerHTML = `
                <div class="sidebar-header">
                    <h3>Á≥ªÁªüÊ¶ÇËßà - ${getModeDisplayName(currentMode)}</h3>
                </div>
                <div class="metric-item">
                    <div class="metric-label">Êï¥‰ΩìÁîü‰∫ßÊïàÁéá</div>
                    <div class="metric-value${efficiencyAbnormal}">${systemData.overallEfficiency}<span class="metric-unit">%</span></div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">ËÆæÂ§áÊÄªËøêË°åÁéá</div>
                    <div class="metric-value${runtimeAbnormal}">${systemData.equipmentRuntime}<span class="metric-unit">%</span></div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">Âπ≥ÂùáËÉΩËÄó</div>
                    <div class="metric-value${energyAbnormal}">${systemData.avgEnergyConsumption}<span class="metric-unit">kWh/t</span></div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">${systemData.productionLabel}</div>
                    <div class="metric-value${productionAbnormal}">${systemData.production}<span class="metric-unit">t</span></div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">ÂëäË≠¶Êï∞Èáè</div>
                    <div class="metric-value${alarmAbnormal}">${systemData.alarmCount}<span class="metric-unit">È°π</span></div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">Âú®Á∫øËÆæÂ§á</div>
                    <div class="metric-value${onlineAbnormal}">${systemData.onlineDevices}/${systemData.totalDevices}<span class="metric-unit">Âè∞</span></div>
                </div>
            `;
        }

        // Ëé∑ÂèñÊ®°ÂºèÊòæÁ§∫ÂêçÁß∞
        function getModeDisplayName(mode) {
            const modeNames = {
                'realtime': 'ÂÆûÊó∂ÁõëÊéß',
                'history': 'ÂéÜÂè≤ÂõûÁúã',
                'simulation': 'Ê®°ÊãüÊé®Êºî'
            };
            return modeNames[mode] || 'Êú™Áü•Ê®°Âºè';
        }

        // ÁîüÊàêÂÆûÊó∂Á≥ªÁªüÊï∞ÊçÆ
        function generateRealtimeSystemData() {
            return {
                overallEfficiency: (85 + Math.random() * 10).toFixed(1),
                equipmentRuntime: (90 + Math.random() * 8).toFixed(1),
                avgEnergyConsumption: (240 + Math.random() * 20).toFixed(1),
                productionLabel: '‰ªäÊó•‰∫ßÈáè',
                production: Math.round(2300 + Math.random() * 200),
                alarmCount: Math.floor(Math.random() * 5) + 1,
                onlineDevices: 24 + Math.floor(Math.random() * 3),
                totalDevices: 26
            };
        }

        // ÁîüÊàêÂéÜÂè≤Á≥ªÁªüÊï∞ÊçÆ
        function generateHistorySystemData() {
            return {
                overallEfficiency: (80 + Math.random() * 8).toFixed(1),
                equipmentRuntime: (88 + Math.random() * 6).toFixed(1),
                avgEnergyConsumption: (250 + Math.random() * 15).toFixed(1),
                productionLabel: 'ÂéÜÂè≤‰∫ßÈáè',
                production: Math.round(2100 + Math.random() * 150),
                alarmCount: Math.floor(Math.random() * 3) + 2,
                onlineDevices: 23 + Math.floor(Math.random() * 2),
                totalDevices: 26
            };
        }

        // ÁîüÊàêÊ®°ÊãüÁ≥ªÁªüÊï∞ÊçÆ
        function generateSimulationSystemData() {
            const baseEfficiency = 85;
            const baseRuntime = 92;
            const baseEnergy = 245;
            const baseProduction = 2300;
            
            // Ê†πÊçÆÊ®°ÊãüÂèÇÊï∞Ë∞ÉÊï¥Êï∞ÊçÆ
            const efficiency = (baseEfficiency * simulationParams.efficiencyFactor * simulationParams.qualityFactor).toFixed(1);
            const runtime = (baseRuntime * simulationParams.efficiencyFactor).toFixed(1);
            const energy = (baseEnergy / (simulationParams.efficiencyFactor * simulationParams.qualityFactor)).toFixed(1);
            const production = Math.round(baseProduction * simulationParams.loadFactor * simulationParams.qualityFactor);
            
            return {
                overallEfficiency: efficiency,
                equipmentRuntime: runtime,
                avgEnergyConsumption: energy,
                productionLabel: 'È¢ÑÊµã‰∫ßÈáè',
                production: production,
                alarmCount: Math.floor(Math.random() * 4) + 1,
                onlineDevices: 25,
                totalDevices: 26
            };
        }

        // Ê®°ÂºèÂàáÊç¢
        function switchMode(mode) {
            // Ê∏ÖÈô§Áé∞ÊúâÁöÑÂÆûÊó∂Êõ¥Êñ∞
            if (realTimeInterval) {
                clearInterval(realTimeInterval);
                realTimeInterval = null;
            }

            // ÈöêËóèÁºñËæëÈù¢Êùø
            document.getElementById('edit-panel').classList.remove('visible');
            
            // ÊòæÁ§∫ÂØπÂ∫îÁöÑÊéßÂà∂Èù¢Êùø
            const modePanel = document.getElementById('mode-control-panel');
            const panelTitle = document.getElementById('mode-panel-title');
            const historyControls = document.getElementById('history-controls');
            const simulationControls = document.getElementById('simulation-controls');

            // ÂÖàÈöêËóèÊâÄÊúâÊéßÂà∂Èù¢ÊùøÂÜÖÂÆπ
            historyControls.style.display = 'none';
            simulationControls.style.display = 'none';

            switch(mode) {
                case 'realtime':
                    panelTitle.textContent = 'ÂÆûÊó∂ÁõëÊéß';
                    // ÂÆåÂÖ®ÈöêËóèÊ®°ÂºèÊéßÂà∂Èù¢Êùø
                    modePanel.classList.remove('visible');
                    modePanel.style.display = 'none';
                    startRealTimeUpdates();
                    break;
                case 'history':
                    panelTitle.textContent = 'ÂéÜÂè≤ÂõûÁúã';
                    historyControls.style.display = 'block';
                    modePanel.style.display = 'block';
                    modePanel.classList.add('visible');
                    break;
                case 'simulation':
                    panelTitle.textContent = 'Ê®°ÊãüÊé®Êºî';
                    simulationControls.style.display = 'block';
                    modePanel.style.display = 'block';
                    modePanel.classList.add('visible');
                    break;
            }

            // Á°Æ‰øùÂ∑¶‰æßÊåáÊ†áÈù¢ÊùøÂßãÁªàÂèØËßÅ
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.style.display = 'block';
                sidebar.style.visibility = 'visible';
                sidebar.style.opacity = '1';
                sidebar.style.pointerEvents = 'auto';
            }
            
            // ÁâπÂà´Â§ÑÁêÜÂÆûÊó∂Ê®°ÂºèÔºåÁ°Æ‰øùÂ∑¶‰æßÊåáÊ†áÈù¢ÊùøÂÆåÂÖ®ÂèØËßÅ
            if (mode === 'realtime') {
                setTimeout(() => {
                    const sidebar = document.querySelector('.sidebar');
                    if (sidebar) {
                        sidebar.style.display = 'block';
                        sidebar.style.visibility = 'visible';
                        sidebar.style.zIndex = '1001';
                    }
                }, 100);
            }

            updateMetrics();
            
            // Êõ¥Êñ∞Âè≥‰æßÊåáÊ†áÈù¢Êùø
            updateRightMetricsPanel();
            
            // Êõ¥Êñ∞3DÊ®°ÂûãÊòæÁ§∫
            update3DModelForMode(mode);
        }

        // ÂêØÂä®ÂÆûÊó∂Êï∞ÊçÆÊõ¥Êñ∞
        function startRealTimeUpdates() {
            realTimeInterval = setInterval(() => {
                if (currentMode === 'realtime') {
                    // Â¶ÇÊûúÊúâÈÄâ‰∏≠ËäÇÁÇπÔºåÂà∑Êñ∞ÂÖ∂ÊåáÊ†áÊï∞ÊçÆ
                    if (selectedNode && selectedNode.id) {
                        // Âè™Êõ¥Êñ∞ÊåáÊ†áÈù¢ÊùøÔºå‰∏çËß¶ÂèëËßÜÂõæÂàáÊç¢
                        updateMetricsForNode(selectedNode.id);
                        updateRightMetricsPanel();
                    } else {
                        // ÈªòËÆ§Êõ¥Êñ∞Â∑•ÂéÇÁ∫ßÂà´ÊåáÊ†á
                        updateMetricsForNode('cement-factory');
                        updateRightMetricsPanel();
                    }
                    
                    // Ê®°ÊãüÂëäË≠¶Êï∞ÊçÆÂèòÂåñÔºàÂÅ∂Â∞îÔºâ
                    if (Math.random() < 0.1) { // 10%Ê¶ÇÁéáÊõ¥Êñ∞ÂëäË≠¶
                        simulateAlarmChanges();
                    }
                }
            }, 2000);
        }

        // Ëé∑ÂèñÂΩìÂâçÈÄâ‰∏≠ÁöÑËäÇÁÇπID
        function getCurrentSelectedNodeId() {
            const activeNode = document.querySelector('.tree-node-content.active');
            return activeNode ? activeNode.getAttribute('data-id') : null;
        }

        // Ê®°ÊãüÂëäË≠¶ÂèòÂåñ
        function simulateAlarmChanges() {
            // ÈöèÊú∫Êõ¥Êñ∞ÂëäË≠¶Êó∂Èó¥ÊàñÁä∂ÊÄÅ
            const randomIndex = Math.floor(Math.random() * alarmData.length);
            const now = new Date();
            alarmData[randomIndex].time = now.getHours().toString().padStart(2, '0') + ':' + 
                                         now.getMinutes().toString().padStart(2, '0');
            alarmData[randomIndex].timestamp = Date.now();
            
            // Êõ¥Êñ∞ÂëäË≠¶ÊòæÁ§∫
            updateAlarmDisplay();
        }

        // Êõ¥Êñ∞ÊåáÊ†á (‰øùÁïôÂÖºÂÆπÊÄß)
        function updateMetrics() {
            // Â¶ÇÊûúÊúâÈÄâ‰∏≠ËäÇÁÇπÔºå‰ΩøÁî®Áªü‰∏ÄÁöÑÂàáÊç¢ÂáΩÊï∞Êõ¥Êñ∞
            if (selectedNode && selectedNode.id) {
                switchToNode(selectedNode.id, 'metrics_update');
            } else {
                // ÈªòËÆ§Êõ¥Êñ∞Â∑•ÂéÇÁ∫ßÂà´ÊåáÊ†á
                switchToNode('cement-factory', 'metrics_default');
            }
        }

        // Âä†ËΩΩÂéÜÂè≤Êï∞ÊçÆ
        function loadHistoryData() {
            if (isDataLoading) return;
            isDataLoading = true;

            const date = document.getElementById('history-date').value;
            const startTime = document.getElementById('history-time-start').value;
            const endTime = document.getElementById('history-time-end').value;

            // Ê®°ÊãüÊï∞ÊçÆÂä†ËΩΩ
            setTimeout(() => {
                // Êõ¥Êñ∞ÂéÜÂè≤‰ø°ÊÅØÊòæÁ§∫
                document.getElementById('history-time-range').textContent = 
                    `${date} ${startTime} - ${endTime}`;
                document.getElementById('history-data-points').textContent = 
                    Math.floor(Math.random() * 500 + 100);

                // Ê®°ÊãüÂä†ËΩΩÂéÜÂè≤Êï∞ÊçÆÂà∞ÂÖ®Â±ÄÂèòÈáè
                historyData = generateHistoryData(date, startTime, endTime);
                
                // Â∫îÁî®ÂéÜÂè≤Êï∞ÊçÆÂà∞ÊåáÊ†áÊòæÁ§∫
                updateMetrics();
                
                isDataLoading = false;
                
                // ÊèêÁ§∫Âä†ËΩΩÂÆåÊàê
                showNotification('ÂéÜÂè≤Êï∞ÊçÆÂä†ËΩΩÂÆåÊàêÔºÅ', 'success');
            }, 1000);
        }

        // ÁîüÊàêÊ®°ÊãüÂéÜÂè≤Êï∞ÊçÆ
        function generateHistoryData(date, startTime, endTime) {
            const data = {};
            const nodes = ['cement-factory', 'crusher-1', 'ball-mill', 'rotary-kiln'];
            
            nodes.forEach(nodeId => {
                data[nodeId] = {
                    efficiency: Math.random() * 20 + 75, // 75-95%
                    temperature: Math.random() * 100 + 50, // 50-150¬∞C
                    pressure: Math.random() * 2 + 1.5, // 1.5-3.5 MPa
                    vibration: Math.random() * 5 + 10, // 10-15 mm/s
                    power: Math.random() * 100 + 400 // 400-500 kW
                };
            });
            
            return data;
        }

        // ËøêË°åÊ®°ÊãüÊé®Êºî
        function runSimulation() {
            if (isDataLoading) return;
            isDataLoading = true;

            const baseDate = document.getElementById('sim-base-date').value;
            const baseTime = document.getElementById('sim-base-time').value;
            const targetHours = document.getElementById('sim-target-time').value;

            // Ê®°ÊãüÊé®ÊºîËÆ°ÁÆó
            setTimeout(() => {
                const predictions = calculatePredictions();
                
                // Êõ¥Êñ∞È¢ÑÊµãÁªìÊûúÊòæÁ§∫
                document.getElementById('predicted-output').textContent = predictions.output;
                document.getElementById('predicted-energy').textContent = predictions.energy;
                document.getElementById('predicted-status').textContent = predictions.status;
                
                // Â∫îÁî®È¢ÑÊµãÊï∞ÊçÆÂà∞ÊåáÊ†áÊòæÁ§∫
                updateMetrics();
                
                isDataLoading = false;
                
                // ÊèêÁ§∫Êé®ÊºîÂÆåÊàê
                showNotification('Ê®°ÊãüÊé®ÊºîÂÆåÊàêÔºÅ', 'success');
            }, 1500);
        }

        // ËÆ°ÁÆóÈ¢ÑÊµãÁªìÊûú
        function calculatePredictions() {
            const baseOutput = 180; // Âü∫Á°Ä‰∫ßÈáè t/h
            const baseEnergy = 245; // Âü∫Á°ÄËÉΩËÄó kWh/t
            
            const outputPrediction = (baseOutput * simulationParams.loadFactor * 
                                    simulationParams.qualityFactor * 
                                    simulationParams.efficiencyFactor).toFixed(1);
            
            const energyPrediction = (baseEnergy / (simulationParams.efficiencyFactor * 
                                    simulationParams.qualityFactor)).toFixed(1);
            
            let status = 'Ê≠£Â∏∏';
            if (simulationParams.loadFactor > 1.2) status = 'È´òË¥üËç∑ËøêË°å';
            else if (simulationParams.efficiencyFactor < 0.9) status = 'ÊïàÁéáÂÅè‰Ωé';
            
            return {
                output: outputPrediction,
                energy: energyPrediction,
                status: status
            };
        }

        // ÊòæÁ§∫ÈÄöÁü•
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                background: ${type === 'success' ? '#1a4d3a' : '#4d1a1a'};
                color: white;
                border-radius: 4px;
                border-left: 4px solid ${type === 'success' ? '#00ff88' : '#ff4444'};
                z-index: 10000;
                font-size: 14px;
                opacity: 0;
                transform: translateX(100%);
                transition: all 0.3s ease;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // ÊòæÁ§∫Âä®Áîª
            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // Ëá™Âä®Ê∂àÂ§±
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Áº©ÊîæÂà∞ËäÇÁÇπ
        function zoomToNode(node) {
            if (currentView === '3d' && camera && controls) {
                // 3DËßÜÂõæ‰∏≠Áº©ÊîæÂà∞ÂØπÂ∫îËÆæÂ§á
                const targetPositions = {
                    'crusher-1': { x: -10, y: 2, z: -5 },
                    'ball-mill': { x: 0, y: 3, z: -5 },
                    'rotary-kiln': { x: 10, y: 2, z: 0 }
                };
                
                const target = targetPositions[node.id];
                if (target) {
                    // Âä®ÁîªÁº©ÊîæÂà∞ÁõÆÊ†á‰ΩçÁΩÆ
                    const duration = 1000;
                    const startPos = camera.position.clone();
                    const endPos = new THREE.Vector3(target.x + 10, target.y + 10, target.z + 10);
                    
                    const startTime = Date.now();
                    function animateZoom() {
                        const elapsed = Date.now() - startTime;
                        const progress = Math.min(elapsed / duration, 1);
                        
                        camera.position.lerpVectors(startPos, endPos, progress);
                        controls.target.set(target.x, target.y, target.z);
                        controls.update();
                        
                        if (progress < 1) {
                            requestAnimationFrame(animateZoom);
                        }
                    }
                    animateZoom();
                }
            }
        }

        // ÂØºËà™Âà∞ËäÇÁÇπ
        function navigateToNode(nodeId) {
            const nodeElement = document.querySelector(`[data-id="${nodeId}"]`);
            if (nodeElement) {
                nodeElement.click();
            }
        }

        // Â∫îÁî®ÁºñËæëËÆæÁΩÆ
        function applyEditSettings() {
            // ÊåáÊ†áÊòæÁ§∫/ÈöêËóè
            const metricItems = document.querySelectorAll('.metric-item');
            document.querySelectorAll('#edit-panel input[id^="metric-"]').forEach((checkbox, index) => {
                if (metricItems[index]) {
                    metricItems[index].style.display = checkbox.checked ? 'block' : 'none';
                }
            });
            
            // Â∏ÉÂ±ÄÁªÑ‰ª∂ÊòæÁ§∫/ÈöêËóè
            const sidebar = document.querySelector('.sidebar');
            const rightMetricsPanel = document.getElementById('right-metrics-panel');
            const breadcrumb = document.querySelector('.breadcrumb');
            
            if (document.getElementById('layout-sidebar').checked) {
                sidebar.style.display = 'block';
            } else {
                sidebar.style.display = 'none';
            }
            
            if (document.getElementById('layout-right-metrics').checked) {
                rightMetricsPanel.classList.remove('hidden');
                rightMetricsPanel.style.display = 'block';
            } else {
                rightMetricsPanel.classList.add('hidden');
                rightMetricsPanel.style.display = 'none';
            }
            
            if (document.getElementById('layout-breadcrumb').checked) {
                breadcrumb.style.display = 'block';
            } else {
                breadcrumb.style.display = 'none';
            }
        }

        // Âä†ËΩΩÂ∑•ÂéÇÊï∞ÊçÆ
        function loadFactoryData() {
            // Ê®°Êãü‰ªéÊúçÂä°Âô®Âä†ËΩΩÊï∞ÊçÆ
            factoryData = {
                factory: {
                    name: 'Ê∞¥Ê≥•Â∑•ÂéÇ',
                    status: 'running',
                    workshops: ['crushing', 'grinding', 'burning']
                }
            };
        }

        // Âº∫Âà∂ÊòæÁ§∫Â∑¶‰æßÊåáÊ†áÈù¢ÊùøÁöÑË∞ÉËØïÂáΩÊï∞
        function forceShowSidebar() {
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.style.cssText = `
                    width: 300px !important;
                    background: #2d2d2d !important;
                    border-right: 1px solid #444 !important;
                    overflow-y: auto !important;
                    position: relative !important;
                    z-index: 1001 !important;
                    display: block !important;
                    visibility: visible !important;
                    opacity: 1 !important;
                `;
                console.log('Âº∫Âà∂ÊòæÁ§∫Â∑¶‰æßÊåáÊ†áÈù¢Êùø');
            } else {
                console.error('Êâæ‰∏çÂà∞Â∑¶‰æßÊåáÊ†áÈù¢ÊùøÂÖÉÁ¥†');
            }
        }

        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            init();
            
            // Âª∂ËøüÁ°Æ‰øùÂ∑¶‰æßÊåáÊ†áÈù¢ÊùøÂèØËßÅ
            setTimeout(forceShowSidebar, 500);
            
            // Âª∂ËøüÂàùÂßãÂåñÂ∑•ÂÖ∑ÊèêÁ§∫ÔºåÁ°Æ‰øùDOMÂÆåÂÖ®Âä†ËΩΩ
            setTimeout(initIconButtonTooltips, 100);
            
            // ÂàùÂßãÂåñÁªÑÊÄÅËßÜÂõæÔºàÂ¶ÇÊûúÈúÄË¶ÅÔºâ
            setTimeout(() => {
                if (currentView === 'scada') {
                    initScadaView();
                }
            }, 200);
            
            // Ê∑ªÂä†Ë∞ÉËØï‰ø°ÊÅØ
            console.log('È°µÈù¢ÂàùÂßãÂåñÂÆåÊàêÔºåÂΩìÂâçÊ®°Âºè:', currentMode);
        });

        // ÁªÑÊÄÅËßÜÂõæÁõ∏ÂÖ≥ÂèòÈáèÂíåÂáΩÊï∞
        let scadaEditMode = false;
        let scadaComponents = [];
        let selectedScadaComponent = null;
        let isDragging = false;
        let dragOffset = { x: 0, y: 0 };

        // ÂàùÂßãÂåñÁªÑÊÄÅËßÜÂõæ
        function initScadaView() {
            if (document.getElementById('scada-canvas').style.display === 'none') {
                return;
            }
            
            // ÂàùÂßãÂåñÁªÑÊÄÅ‰∫ã‰ª∂ÁõëÂê¨Âô®
            initScadaEventListeners();
            
            // ÂêØÂä®ÂÆûÊó∂Êï∞ÊçÆÊõ¥Êñ∞
            startScadaDataUpdate();
            
            // ÂàùÂßãÂåñÁªÑÊÄÅÁªÑ‰ª∂
            initScadaComponents();
        }

        // ÂàùÂßãÂåñÁªÑÊÄÅ‰∫ã‰ª∂ÁõëÂê¨Âô®
        function initScadaEventListeners() {
            // ÁºñËæëÊ®°ÂºèÂàáÊç¢
            const editModeBtn = document.getElementById('scada-edit-mode');
            if (editModeBtn) {
                editModeBtn.addEventListener('click', function() {
                    scadaEditMode = !scadaEditMode;
                    this.classList.toggle('active');
                    const workspace = document.getElementById('scada-workspace');
                    if (scadaEditMode) {
                        workspace.classList.add('scada-edit-mode');
                    } else {
                        workspace.classList.remove('scada-edit-mode');
                    }
                });
            }

            // ‰øùÂ≠òÈÖçÁΩÆ
            const saveBtn = document.getElementById('scada-save');
            if (saveBtn) {
                saveBtn.addEventListener('click', saveScadaConfiguration);
            }

            // Âä†ËΩΩÈÖçÁΩÆ
            const loadBtn = document.getElementById('scada-load');
            if (loadBtn) {
                loadBtn.addEventListener('click', loadScadaConfiguration);
            }

            // ÂÖ®Â±èÊ®°Âºè
            const fullscreenBtn = document.getElementById('scada-fullscreen');
            if (fullscreenBtn) {
                fullscreenBtn.addEventListener('click', toggleScadaFullscreen);
            }

            // ‰∏∫ÁªÑÊÄÅÁªÑ‰ª∂Ê∑ªÂä†ÊãñÊãΩ‰∫ã‰ª∂
            addScadaDragEvents();
        }

        // ÂàùÂßãÂåñÁªÑÊÄÅÁªÑ‰ª∂
        function initScadaComponents() {
            const components = document.querySelectorAll('.scada-component');
            scadaComponents = Array.from(components).map(component => ({
                element: component,
                id: component.dataset.id,
                x: parseInt(component.style.left) || 0,
                y: parseInt(component.style.top) || 0
            }));
        }

        // Ê∑ªÂä†ÊãñÊãΩ‰∫ã‰ª∂
        function addScadaDragEvents() {
            const components = document.querySelectorAll('.scada-component');
            components.forEach(component => {
                component.addEventListener('mousedown', handleScadaMouseDown);
                component.addEventListener('click', handleScadaComponentClick);
            });

            // ÂÖ®Â±ÄÈº†Ê†á‰∫ã‰ª∂
            document.addEventListener('mousemove', handleScadaMouseMove);
            document.addEventListener('mouseup', handleScadaMouseUp);
        }

        // Èº†Ê†áÊåâ‰∏ã‰∫ã‰ª∂
        function handleScadaMouseDown(event) {
            if (!scadaEditMode) return;
            
            event.preventDefault();
            isDragging = true;
            selectedScadaComponent = event.currentTarget;
            
            const rect = selectedScadaComponent.getBoundingClientRect();
            dragOffset.x = event.clientX - rect.left;
            dragOffset.y = event.clientY - rect.top;
            
            selectedScadaComponent.classList.add('dragging');
            
            // Ê∏ÖÈô§ÂÖ∂‰ªñÈÄâ‰∏≠Áä∂ÊÄÅ
            document.querySelectorAll('.scada-component').forEach(comp => {
                comp.classList.remove('selected');
            });
            selectedScadaComponent.classList.add('selected');
        }

        // Èº†Ê†áÁßªÂä®‰∫ã‰ª∂
        function handleScadaMouseMove(event) {
            if (!isDragging || !selectedScadaComponent || !scadaEditMode) return;
            
            const workspace = document.getElementById('scada-workspace');
            const workspaceRect = workspace.getBoundingClientRect();
            
            const x = event.clientX - workspaceRect.left - dragOffset.x;
            const y = event.clientY - workspaceRect.top - dragOffset.y;
            
            // ÁΩëÊ†ºÂØπÈΩê
            const gridSize = 20;
            const snappedX = Math.round(x / gridSize) * gridSize;
            const snappedY = Math.round(y / gridSize) * gridSize;
            
            selectedScadaComponent.style.left = snappedX + 'px';
            selectedScadaComponent.style.top = snappedY + 'px';
        }

        // Èº†Ê†áÊä¨Ëµ∑‰∫ã‰ª∂
        function handleScadaMouseUp(event) {
            if (selectedScadaComponent) {
                selectedScadaComponent.classList.remove('dragging');
            }
            isDragging = false;
            selectedScadaComponent = null;
        }

        // ÁªÑ‰ª∂ÁÇπÂáª‰∫ã‰ª∂
        function handleScadaComponentClick(event) {
            if (scadaEditMode) return;
            
            const component = event.currentTarget;
            const deviceId = component.dataset.id;
            
            if (deviceId) {
                // ‰ΩøÁî®Áªü‰∏ÄÁöÑËäÇÁÇπÂàáÊç¢ÂáΩÊï∞
                switchToNode(deviceId, 'scada_click');
            }
        }

        // ÂêØÂä®ÁªÑÊÄÅÊï∞ÊçÆÊõ¥Êñ∞
        function startScadaDataUpdate() {
            // Êõ¥Êñ∞ËÆæÂ§áÁä∂ÊÄÅÂíåÊï∞ÊçÆ
            setInterval(() => {
                if (currentView === 'scada') {
                    updateScadaData();
                }
            }, 2000);
        }

        // Êõ¥Êñ∞ÁªÑÊÄÅÊï∞ÊçÆ
        function updateScadaData() {
            // Êõ¥Êñ∞Á†¥Á¢éÊú∫Êï∞ÊçÆ
            const crusherData = getEnhancedDeviceData('crusher-1');
            updateScadaComponentData('crusher', crusherData);
            
            // Êõ¥Êñ∞ÁêÉÁ£®Êú∫Êï∞ÊçÆ
            const millData = getEnhancedDeviceData('ball-mill');
            updateScadaComponentData('mill', millData);
            
            // Êõ¥Êñ∞ÂõûËΩ¨Á™ëÊï∞ÊçÆ
            const kilnData = getEnhancedDeviceData('rotary-kiln');
            updateScadaComponentData('kiln', kilnData);
            
            // Êõ¥Êñ∞ÊÄªËßàÊï∞ÊçÆ
            updateScadaDashboard();
        }

        // Êõ¥Êñ∞ÁªÑÊÄÅÁªÑ‰ª∂Êï∞ÊçÆ
        function updateScadaComponentData(prefix, data) {
            const tempElement = document.getElementById(`${prefix}-temp`);
            const powerElement = document.getElementById(`${prefix}-power`);
            const speedElement = document.getElementById(`${prefix}-speed`);
            const statusElement = document.getElementById(`${prefix}-status`);
            
            if (tempElement) {
                tempElement.textContent = data.temperature + '¬∞C';
                tempElement.className = isMetricAbnormal('temperature', data.temperature, data.id) ? 
                    'param-value abnormal' : 'param-value';
            }
            
            if (powerElement) {
                powerElement.textContent = data.power + 'kW';
                powerElement.className = isMetricAbnormal('power', data.power, data.id) ? 
                    'param-value abnormal' : 'param-value';
            }
            
            if (speedElement) {
                speedElement.textContent = data.speed + 'rpm';
                speedElement.className = isMetricAbnormal('speed', data.speed, data.id) ? 
                    'param-value abnormal' : 'param-value';
            }
            
            if (statusElement) {
                statusElement.className = data.status === 'ÂëäË≠¶' ? 
                    'status-indicator alarm' : 'status-indicator';
            }
        }

        // Êõ¥Êñ∞ÁªÑÊÄÅ‰ª™Ë°®Êùø
        function updateScadaDashboard() {
            const systemData = generateRealtimeSystemData();
            
            const outputElement = document.getElementById('total-output');
            const efficiencyElement = document.getElementById('overall-efficiency');
            const alarmsElement = document.getElementById('dashboard-alarms');
            
            if (outputElement) {
                outputElement.textContent = systemData.production + 't';
            }
            
            if (efficiencyElement) {
                efficiencyElement.textContent = systemData.overallEfficiency + '%';
                efficiencyElement.className = parseFloat(systemData.overallEfficiency) < 80 ? 
                    'metric-value abnormal' : 'metric-value';
            }
            
            if (alarmsElement) {
                alarmsElement.textContent = systemData.alarmCount + 'È°π';
            }
        }

        // ‰øùÂ≠òÁªÑÊÄÅÈÖçÁΩÆ
        function saveScadaConfiguration() {
            const config = {
                components: scadaComponents.map(comp => ({
                    id: comp.id,
                    x: parseInt(comp.element.style.left) || 0,
                    y: parseInt(comp.element.style.top) || 0,
                    type: comp.element.className
                })),
                timestamp: Date.now()
            };
            
            localStorage.setItem('scada_config', JSON.stringify(config));
            showNotification('ÁªÑÊÄÅÈÖçÁΩÆÂ∑≤‰øùÂ≠ò', 'success');
        }

        // Âä†ËΩΩÁªÑÊÄÅÈÖçÁΩÆ
        function loadScadaConfiguration() {
            const configStr = localStorage.getItem('scada_config');
            if (!configStr) {
                showNotification('Êú™ÊâæÂà∞‰øùÂ≠òÁöÑÈÖçÁΩÆ', 'error');
                return;
            }
            
            try {
                const config = JSON.parse(configStr);
                config.components.forEach(compConfig => {
                    const component = document.querySelector(`[data-id="${compConfig.id}"]`);
                    if (component) {
                        component.style.left = compConfig.x + 'px';
                        component.style.top = compConfig.y + 'px';
                    }
                });
                
                initScadaComponents();
                showNotification('ÁªÑÊÄÅÈÖçÁΩÆÂ∑≤Âä†ËΩΩ', 'success');
            } catch (error) {
                showNotification('ÈÖçÁΩÆÊñá‰ª∂Ê†ºÂºèÈîôËØØ', 'error');
            }
        }

        // ÂàáÊç¢ÁªÑÊÄÅÂÖ®Â±èÊ®°Âºè
        function toggleScadaFullscreen() {
            const scadaCanvas = document.getElementById('scada-canvas');
            if (!document.fullscreenElement) {
                scadaCanvas.requestFullscreen().catch(err => {
                    console.log('ÂÖ®Â±èÊ®°Âºè‰∏çÊîØÊåÅ:', err);
                });
            } else {
                document.exitFullscreen();
            }
        }

        // ÂÖ®Â±ÄÂáΩÊï∞Ôºå‰æõHTMLË∞ÉÁî®
        window.goBackLevel = goBackLevel;
        window.navigateToBreadcrumbNode = navigateToBreadcrumbNode;
        window.navigateToAlarmDevice = navigateToAlarmDevice;
        window.handleAlarmAction = handleAlarmAction;
        window.clearAlarmFilter = clearAlarmFilter;
    </script>
</body>
</html> 