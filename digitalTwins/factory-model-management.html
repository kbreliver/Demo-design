<!DOCTYPE html>

<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工厂模型管理 - 数字孪生平台</title>
    <link rel="stylesheet" href="assets/element-ui.css">
    <style>
        /* 全局样式 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f5f7fa;
            color: #303133;
        }

        /* 页面容器 */
        .factory-model-container {
            min-height: 100vh;
            background-color: #f5f7fa;
        }

        /* 粘性头部 */
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 1000;
            background-color: #fff;
            border-bottom: 1px solid #e4e7ed;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .page-title {
            font-size: 20px;
            font-weight: 600;
            color: #303133;
        }

        .page-description {
            font-size: 14px;
            color: #606266;
            margin-left: 16px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        /* 主要内容区域 */
        .main-content {
            /* max-width: 1400px; */
            margin: 0 auto;
            padding: 24px;
        }

        /* 基本信息卡片 */
        .info-card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 24px;
        }

        .card-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e4e7ed;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #fafafa;
            min-height: 60px;
        }

        .card-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        /* 确保折叠按钮可见 */
        .card-actions .el-button {
            display: inline-flex !important;
            visibility: visible !important;
            opacity: 1 !important;
            color: #409eff !important;
            font-size: 14px !important;
            padding: 8px 12px !important;
            border: 1px solid #409eff !important;
            background-color: #fff !important;
            border-radius: 4px !important;
        }
        
        /* 确保按钮图标可见 */
        .card-actions .el-button i {
            display: inline-block !important;
            visibility: visible !important;
            margin-right: 4px !important;
        }
        
        /* 确保卡片操作区域可见 */
        .card-actions {
            display: flex !important;
            gap: 8px !important;
            align-items: center !important;
            min-width: 80px !important;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: #303133;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .card-content {
            padding: 24px;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .card-content.collapsed {
            padding: 0;
            max-height: 0;
        }

        /* 基本信息网格布局 */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 24px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            font-size: 12px;
            color: #909399;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-value {
            font-size: 14px;
            color: #303133;
            font-weight: 500;
        }

        .info-description .info-value {
            background-color: #f8f9fa;
            padding: 12px;
            border-radius: 4px;
            line-height: 1.6;
        }

        /* 状态标签 */
        .status-tag {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-enabled {
            background-color: #f0f9ff;
            color: #0369a1;
        }

        /* 告警徽标样式 */
        .alarm-badge .el-badge__content {
            background-color: #F56C6C;
            color: white;
            font-size: 10px;
            height: 24px;
            line-height: 16px;
            padding: 0 4px;
            border-radius: 8px;
        }

        /* 页签中的徽标样式 */
        .el-tabs__item .el-badge {
            margin-left: 4px;
        }

        .el-tabs__item .el-badge .el-badge__content {
            transform: scale(0.8);
            transform-origin: center;
        }

        /* 状态操作按钮样式 */
        .status-display .el-button--mini {
            padding: 4px 8px;
            font-size: 11px;
            height: 24px;
            line-height: 16px;
            margin-left: 8px;
        }

        /* 页签验证样式 */
        .el-tabs__item {
            transition: color 0.3s ease;
        }

        .el-tabs__item.has-warning {
            color: #E6A23C !important;
        }

        .el-tabs__item.has-warning:hover {
            color: #E6A23C !important;
        }

        .el-tabs__item.has-warning.is-active {
            color: #E6A23C !important;
        }

        .status-disabled {
            background-color: #fef2f2;
            color: #dc2626;
        }

        /* 资产路径标题样式 */
        .asset-path-title {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .asset-path {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #606266;
            font-size: 14px;
        }

        .asset-path i {
            color: #909399;
            font-size: 16px;
        }

        .asset-operation-status {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            font-size: 16px;
            cursor: help;
            transition: all 0.3s ease;
        }

        .asset-operation-status:hover {
            transform: scale(1.1);
        }

        .asset-name {
            color: #303133;
            font-weight: 500;
        }

        /* 视频表格样式 */
        .video-table .el-table {
            margin-top: 16px;
        }

        .video-table .el-input {
            width: 100%;
        }

        .video-table .el-input__suffix {
            cursor: pointer;
        }

        .video-table .el-input__suffix:hover {
            color: #409EFF;
        }

        /* 状态图标样式 */
        .status-icon.status-connected {
            color: #67c23a;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 4px;
        }

        .status-icon.status-disconnected {
            color: #f56c6c;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 4px;
        }

        /* 运行状态实心圆样式 */
        .status-circle {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 4px;
        }

        .status-circle.status-running {
            background-color: #67c23a;
        }

        .status-circle.status-standby {
            background-color: #e6a23c;
        }

        .status-circle.status-fault {
            background-color: #f56c6c;
        }

        .status-circle.status-maintenance {
            background-color: #409eff;
        }

        .status-circle.status-dash {
            background-color: #909399;
        }

        .asset-operation-status.adding {
            background-color: #f0f9ff;
            color: #0369a1;
        }

        .asset-operation-status.viewing {
            background-color: #f0fdf4;
            color: #16a34a;
        }

                .asset-operation-status.editing {
            background-color: #fef3c7;
            color: #d97706;
        }

        .status-draft {
            background-color: #fef3c7;
            color: #d97706;
        }

        .status-level {
            background-color: #f3e8ff;
            color: #7c3aed;
        }

        /* 层级结构管理区域 */
        .structure-section {
            display: grid;
            grid-template-columns: 0.8fr 2.2fr;
            gap: 12px;
            max-width: 100%;
        }

        .tree-card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .tree-toolbar {
            padding: 16px 20px;
            border-bottom: 1px solid #e4e7ed;
            background-color: #fafafa;
            display: flex;
            gap: 12px;
            align-items: center;
            justify-content: space-between;
        }
        
        .toolbar-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .drag-tip {
            font-size: 12px;
            color: #909399;
            margin-left: auto;
        }

        .tree-container {
            padding: 20px;
            max-height: 600px;
            overflow-y: auto;
            min-width: 0;
            max-width: 100%;
        }

        /* 详情面板 */
        .details-card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            /* width: 86%; */
        }

        .details-content {
            padding: 12px;
            min-width: 0;
            max-width: 100%;
            overflow: visible;
            width: 100%;
            box-sizing: border-box;
        }

        /* 空状态 */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #909399;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 14px;
            margin-bottom: 16px;
        }

        /* 节点详情样式 */
        .node-details {
            padding: 0;
            overflow: visible;
        }

        .detail-section {
            /* margin-bottom: 12px; */
            overflow: visible;
        }

        .detail-section:last-child {
            margin-bottom: 0;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid #ebeef5;
            min-width: 0;
            gap: 16px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #303133;
            margin: 0;
            flex-shrink: 1;
            min-width: 0;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .section-actions {
            display: flex;
            gap: 8px;
            min-width: 80px;
            flex-shrink: 0;
            /* 确保按钮可见 */
            position: relative;
            z-index: 1;
            white-space: nowrap;
        }
        
        .section-actions .el-button {
            flex-shrink: 0;
        }

        .section-content {
            transition: all 0.3s ease;
            overflow: visible;
        }

        .section-content.collapsed {
            max-height: 0;
            opacity: 0;
            margin-bottom: 0;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 16px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-item.description-item {
            grid-column: 1 / -1;
        }

        .info-label {
            font-size: 12px;
            color: #909399;
            margin-bottom: 4px;
        }

        .info-value {
            font-size: 14px;
            color: #303133;
            font-weight: 500;
        }

        .node-type-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .node-type-tag.factory {
            background-color: #ecf5ff;
            color: #409eff;
        }

        .node-type-tag.workshop {
            background-color: #f0f9eb;
            color: #67c23a;
        }

        .node-type-tag.line {
            background-color: #fdf6ec;
            color: #e6a23c;
        }

        .node-type-tag.section {
            background-color: #fef0f0;
            color: #f56c6c;
        }

        .node-type-tag.equipment {
            background-color: #f4f4f5;
            color: #909399;
        }

        .node-type-tag.system {
            background-color: #f0f9ff;
            color: #06b6d4;
        }

        /* 统计网格 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .stat-item {
            text-align: center;
            padding: 16px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .stat-number {
            font-size: 24px;
            font-weight: 600;
            color: #409eff;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            color: #909399;
        }

        /* 资产列表搜索栏 */
        .asset-search-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding: 12px;
            background-color: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .search-input-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .search-result-info {
            font-size: 12px;
            color: #909399;
        }

        /* 资产表格容器 */
        .asset-table-container {
            border: 1px solid #e4e7ed;
            border-radius: 6px;
            width: 100%;
            max-width: 100%;
            overflow-x: auto;
            overflow-y: visible;
            min-width: 0;
            box-sizing: border-box;
        }
        
        /* 确保表格不会超出容器 */
        .asset-table-container .el-table {
            min-width: 0;
            max-width: 100%;
            width: 100%;
        }
        
        .asset-table-container .el-table__body-wrapper {
            overflow-x: auto;
            overflow-y: auto;
        }
        
        /* 确保表格内容可以横向滚动 */
        .asset-table-container .el-table__body {
            min-width: 100%;
        }
        
        /* 强制表格容器显示横向滚动条 */
        .asset-table-container {
            scrollbar-width: thin;
            scrollbar-color: #c0c4cc #f5f7fa;
        }
        
        .asset-table-container::-webkit-scrollbar {
            height: 8px;
        }
        
        .asset-table-container::-webkit-scrollbar-track {
            background: #f5f7fa;
            border-radius: 4px;
        }
        
        .asset-table-container::-webkit-scrollbar-thumb {
            background: #c0c4cc;
            border-radius: 4px;
        }
        
        .asset-table-container::-webkit-scrollbar-thumb:hover {
            background: #909399;
        }

        /* 资产名称单元格 */
        .asset-name-cell {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .asset-icon-small {
            font-size: 16px;
        }

        .asset-icon-small.el-icon-monitor {
            color: #409eff;
        }

        .asset-icon-small.el-icon-cpu {
            color: #67c23a;
        }

        .asset-icon-small.el-icon-odometer {
            color: #e6a23c;
        }

        .asset-icon-small.el-icon-setting {
            color: #f56c6c;
        }

        /* 资产列表（旧样式，保留用于兼容） */
        .asset-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .asset-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            transition: all 0.2s ease;
        }

        .asset-item:hover {
            background-color: #e9ecef;
            border-color: #409eff;
        }

        .asset-icon {
            margin-right: 12px;
            font-size: 20px;
        }

        .asset-icon .el-icon-monitor {
            color: #409eff;
        }

        .asset-icon .el-icon-cpu {
            color: #67c23a;
        }

        .asset-icon .el-icon-odometer {
            color: #e6a23c;
        }

        .asset-icon .el-icon-setting {
            color: #f56c6c;
        }

        .asset-info {
            flex-grow: 1;
        }

        .asset-name {
            font-size: 14px;
            font-weight: 500;
            color: #303133;
            /* margin-bottom: 4px; */
        }

        .asset-type {
            font-size: 12px;
            color: #909399;
        }

        .asset-actions {
            display: flex;
            gap: 4px;
        }

        /* 空资产状态 */
        .empty-assets {
            text-align: center;
            padding: 40px 20px;
            color: #909399;
        }

        .empty-assets-icon {
            font-size: 32px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .empty-assets-text {
            font-size: 14px;
            margin-bottom: 16px;
        }

        /* 子节点列表 */
        .child-nodes-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .child-node-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .child-node-item:hover {
            background-color: #e9ecef;
            border-color: #409eff;
        }

        .child-node-icon {
            margin-right: 12px;
            font-size: 18px;
        }

        .child-node-icon .el-icon-office-building {
            color: #409eff;
        }

        .child-node-icon .el-icon-house {
            color: #67c23a;
        }

        .child-node-icon .el-icon-connection {
            color: #e6a23c;
        }

        .child-node-icon .el-icon-s-grid {
            color: #f56c6c;
        }

        .child-node-icon .el-icon-cpu {
            color: #909399;
        }

        .child-node-icon .el-icon-monitor {
            color: #06b6d4;
        }

        .child-node-info {
            flex-grow: 1;
        }

        .child-node-name {
            font-size: 14px;
            font-weight: 500;
            color: #303133;
            margin-bottom: 4px;
        }

        .child-node-meta {
            display: flex;
            gap: 8px;
            font-size: 12px;
            color: #909399;
        }

        .child-node-type {
            background-color: #f0f9eb;
            color: #67c23a;
            padding: 2px 6px;
            border-radius: 10px;
        }

        .child-node-assets {
            color: #909399;
        }

        .child-node-actions {
            display: flex;
            gap: 4px;
        }

        /* 节点样式 */
        .node-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            margin-bottom: 4px;
            background-color: #f8f9fa;
            border-radius: 4px;
            cursor: grab;
            transition: background-color 0.2s ease;
        }

        .node-item:hover {
            background-color: #e9ecef;
        }

        .node-item.selected {
            background-color: #e1f3d8;
            border: 1px solid #67c23a;
            box-shadow: 0 2px 8px rgba(103, 194, 58, 0.2);
        }

        .node-item.dragging {
            opacity: 0.5;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .node-item.drag-over {
            background-color: #f0f9eb;
            border: 1px dashed #67c23a;
        }

        .drag-handle {
            cursor: move;
            color: #c0c4cc;
            margin-right: 8px;
            font-size: 14px;
        }

        .drag-handle:hover {
            color: #409eff;
        }

        .node-level-1 {
            padding-left: 20px;
        }

        .node-level-2 {
            padding-left: 40px;
        }

        .node-level-3 {
            padding-left: 60px;
        }

        .node-level-4 {
            padding-left: 80px;
        }

        .node-level-5 {
            padding-left: 100px;
        }

        .node-level-6 {
            padding-left: 120px;
        }

        .node-level-7 {
            padding-left: 140px;
        }

        .node-level-8 {
            padding-left: 160px;
        }

        .node-level-9 {
            padding-left: 180px;
        }

        .node-level-10 {
            padding-left: 200px;
        }

        .node-expand-icon {
            margin-right: 8px;
            cursor: pointer;
            font-size: 16px;
            color: #909399;
            transition: color 0.2s ease;
        }

        .node-expand-icon:hover {
            color: #409eff;
        }

        .node-expand-icon.expanded {
            color: #409eff;
        }

        .node-expand-icon.leaf {
            color: transparent;
            cursor: default;
        }

        .node-icon {
            margin-right: 8px;
            font-size: 16px;
            color: #909399;
        }

        .node-icon.factory {
            color: #409eff;
        }

        .node-icon.workshop {
            color: #67c23a;
        }

        .node-icon.line {
            color: #e6a23c;
        }

        .node-icon.section {
            color: #f56c6c;
        }

        .node-icon.equipment {
            color: #909399;
        }

        .node-icon.asset {
            color: #909399;
        }

        .node-content {
            flex-grow: 1;
            margin-right: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .node-name {
            font-size: 14px;
            font-weight: 500;
            color: #303133;
        }

        .node-type {
            font-size: 12px;
            color: #909399;
        }

        .node-description {
            font-size: 12px;
            color: #909399;
            display: block;
            margin-top: 4px;
        }

        .node-actions {
            display: flex;
            gap: 4px;
            align-items: center;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .node-item:hover .node-actions {
            opacity: 1;
        }

        .node-actions .el-button {
            padding: 0 2px;
            /* min-width: 24px; */
            height: 24px;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 16px;
                align-items: flex-start;
            }

            .header-actions {
                width: 100%;
                justify-content: flex-end;
            }

            .structure-section {
                grid-template-columns: 1fr;
            }

            .info-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 1200px) {
            .info-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 900px) {
            .info-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* 响应式布局 */
        @media (max-width: 1200px) {
            .structure-section {
                grid-template-columns: 0.6fr 2.4fr;
                gap: 16px;
            }
            
            .section-actions {
                min-width: 80px;
            }
            
            .asset-table-container {
                font-size: 12px;
            }
            
            /* 确保表格在小屏幕上也能正确显示横向滚动条 */
            .asset-table-container .el-table {
                min-width: 800px;
            }
        }

        @media (max-width: 992px) {
            .structure-section {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .tree-container {
                max-height: 400px;
            }
            
            .section-actions {
                min-width: 60px;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 16px;
            }
            
            .header-content {
                padding: 12px 16px;
            }
            
            .card-header {
                padding: 16px 20px;
            }
            
            .details-content {
                padding: 12px;
            }
            
            .asset-table-container {
                font-size: 11px;
            }
            
            .asset-table-container .el-table {
                font-size: 11px;
                min-width: 700px;
            }
            
            .asset-search-bar {
                flex-direction: column;
                gap: 8px;
            }
            
            .search-input-group {
                width: 100%;
            }
        }

        /* 导出对话框样式 */
        .export-dialog-content {
            padding: 20px 0;
        }

        .export-dialog-content p {
            margin-bottom: 20px;
            color: #606266;
            font-size: 14px;
        }

        .export-format-selection {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .export-format-selection label {
            font-weight: 500;
            color: #303133;
            min-width: 80px;
        }

        /* 添加资产表单样式 */
        .add-asset-form {
            background: #f8f9fa;
            border: 1px solid #e4e7ed;
            border-radius: 8px;
            padding: 12px 12px 16px 12px;
            margin-bottom: 24px;
        }
        .add-asset-top {
            margin-bottom: 20px;
        }
        .form-row {
            display: flex;
            gap: 24px;
            margin-bottom: 16px;
        }
        .form-group {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .form-group label {
            font-size: 13px;
            color: #606266;
            margin-bottom: 6px;
        }
        .add-asset-bottom {
            margin-top: 12px;
        }
        
        .tab-content {
            padding: 5px;
            min-height: 200px;
        }
        
        .static-properties-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
        }
        
        .static-properties-form .form-group {
            margin-bottom: 0;
        }
        
        /* 状态显示样式 */
        .status-display {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background-color: #f5f7fa;
            border: 1px solid #e4e7ed;
            border-radius: 4px;
            min-height: 32px;
            white-space: nowrap;
        }
        
        .status-icon {
            font-size: 20px;
            flex-shrink: 0;
        }
        
        .status-text {
            font-size: 14px;
            color: #606266;
            font-weight: 500;
        }
        
        .status-pending {
            color: #e6a23c;
        }
        
        .status-dash {
            color: #909399;
        }
        

        
        .dynamic-variables-table {
            margin-top: 16px;
            max-width: 100%;
            overflow-x: auto;
            border: 1px solid #e4e7ed;
            border-radius: 4px;
        }
        
        .dynamic-variables-table .el-table {
            min-width: 1200px; /* 设置最小宽度确保所有列都能显示 */
        }
        
        .business-properties-table {
            margin-top: 16px;
            max-width: 100%;
            overflow-x: auto;
            border: 1px solid #e4e7ed;
            border-radius: 4px;
        }
        
        .business-properties-table .el-table {
            min-width: 800px; /* 设置最小宽度确保所有列都能显示 */
        }
        
        /* 数据绑定配置样式 */
        .data-binding-config {
            height: 100%;
            overflow: hidden;
        }
        
        .data-binding-layout {
            height: 100%;
        }
        
        .left-panel {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .right-panel {
            height: 100%;
            display: flex;
            flex-direction: column;
            background-color: #fafafa;
            border-left: 1px solid #e4e7ed;
            padding-left: 20px;
        }
        
        .search-section {
            margin-bottom: 20px;
            /* padding-bottom: 20px; */
            border-bottom: 1px solid #e4e7ed;
        }
        
        .search-section h4 {
            margin-bottom: 16px;
            color: #303133;
            font-size: 16px;
            font-weight: 600;
        }
        
        .search-form {
            background-color: #fafafa;
            padding: 16px;
            border-radius: 4px;
        }
        
        .search-form .el-form-item {
            margin-bottom: 0;
        }
        
        .search-form .el-form-item__content {
            display: flex;
            align-items: flex-end;
        }
        
        .search-form .el-button {
            margin-left: 8px;
        }
        
        .data-points-section {
            flex: 1;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            min-height: 0; /* 允许flex子元素收缩 */
        }
        
        .data-points-section .el-table {
            flex: 1;
            overflow-y: auto;
            max-height: 400px; /* 设置最大高度 */
        }
        
        .data-points-section h4 {
            margin-bottom: 16px;
            color: #303133;
            font-size: 16px;
            font-weight: 600;
        }
        
        .selected-points-section {
            margin-bottom: 20px;
            padding: 16px;
            background-color: #f0f9ff;
            border: 1px solid #b3d8ff;
            border-radius: 4px;
        }
        
        .selected-points-section h4 {
            margin-bottom: 12px;
            color: #303133;
            font-size: 14px;
            font-weight: 600;
        }
        
        .selected-point-info p {
            margin-bottom: 8px;
            font-size: 14px;
            color: #606266;
        }
        
        .selected-point-info strong {
            color: #303133;
        }
        
        .selected-points-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .selected-point-item {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .selected-point-item:hover {
            background-color: #f0f9ff;
        }
        
        .selected-point-item .point-source {
            color: #909399;
            font-size: 12px;
            margin: 0 4px;
        }
        
        .selected-point-item {
            background-color: #f0f9ff;
            border: 1px solid #b3d8ff;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
        }
        
        .point-name {
            font-weight: 500;
            color: #303133;
        }
        
        .point-code {
            color: #909399;
            margin-left: 4px;
        }
        
        .remove-btn {
            margin-left: 4px;
            color: #f56c6c;
        }
        
        .formula-section {
            /* margin-top: 20px; */
            padding-top: 20px;
            border-top: 1px solid #e4e7ed;
        }
        
        .formula-section h4 {
            margin-bottom: 16px;
            color: #303133;
            font-size: 16px;
            font-weight: 600;
        }
        
        .formula-config {
            background-color: #fafafa;
            padding: 16px;
            border-radius: 4px;
        }
        
        .formula-input-section {
            margin-bottom: 16px;
        }
        
        .formula-input .el-textarea__inner {
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        .formula-tools {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .operators, .selected-points-for-formula {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .operator-group {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 4px;
            padding: 6px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #e4e7ed;
        }
        
        .operator-label {
            font-size: 11px;
            color: #606266;
            font-weight: 500;
            margin-right: 6px;
            min-width: 40px;
        }
        
        .operator-btn {
            min-width: 28px;
            height: 24px;
            font-size: 11px;
            font-weight: 500;
            margin: 1px;
            padding: 0 4px;
        }
        
        /* 算术运算符样式 */
        .operator-btn.arithmetic {
            background-color: #e1f3d8;
            border-color: #67c23a;
            color: #67c23a;
        }
        
        .operator-btn.arithmetic:hover {
            background-color: #67c23a;
            border-color: #67c23a;
            color: white;
        }
        
        /* 逻辑运算符样式 */
        .operator-btn.logical {
            background-color: #fdf6ec;
            border-color: #e6a23c;
            color: #e6a23c;
        }
        
        .operator-btn.logical:hover {
            background-color: #e6a23c;
            border-color: #e6a23c;
            color: white;
        }
        
        /* 条件运算符样式 */
        .operator-btn.conditional {
            background-color: #f0f9ff;
            border-color: #409eff;
            color: #409eff;
        }
        
        .operator-btn.conditional:hover {
            background-color: #409eff;
            border-color: #409eff;
            color: white;
        }
        
        /* 验证按钮样式 */
        .formula-validation {
            margin-top: 5px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }
        
        /* 输入模式切换样式 */
        .input-mode-tabs {
            margin-bottom: 0px;
        }
        
        .input-mode-tabs .el-tabs__header {
            margin-bottom: 0px;
        }
        
        .input-mode-tabs .el-tabs__nav-wrap {
            background-color: #f8f9fa;
            border-radius: 4px;
            padding: 4px;
        }
        
        .input-mode-tabs .el-tabs__item {
            font-size: 14px;
            padding: 8px 16px;
        }
        
        .input-mode-tabs .el-tabs__item.is-active {
            background-color: #409eff;
            color: white;
            border-radius: 4px;
        }
        
        /* 自然语言输入样式 */
        .natural-language-input {
            position: relative;
        }
        
        .ai-translation-actions {
            margin-top: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .ai-translation-status {
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .translating {
            color: #e6a23c;
        }
        
        .translated {
            color: #67c23a;
        }
        
        /* 可视化输入样式 */
        .visual-input {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .visual-formula-display {
            background-color: #f8f9fa;
            border: 1px solid #e4e7ed;
            border-radius: 4px;
            padding: 12px;
            min-height: 60px;
        }
        
        .formula-preview {
            display: flex;
            align-items: center;
            min-height: 36px;
        }
        
        .formula-blocks {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            align-items: center;
        }
        
        .formula-block {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            background-color: #f0f9ff;
            border: 1px solid #409eff;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #409eff;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .formula-block:hover {
            background-color: #e6f7ff;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(64, 158, 255, 0.2);
        }
        
        .formula-block.selected {
            background-color: #409eff;
            color: white;
            border-color: #409eff;
        }
        
        .block-content {
            margin-right: 4px;
        }
        
        .delete-btn {
            opacity: 0;
            transition: opacity 0.3s ease;
            color: #f56c6c;
            padding: 0;
            margin-left: 4px;
        }
        
        .formula-block:hover .delete-btn {
            opacity: 1;
        }
        
        .formula-block.selected .delete-btn {
            opacity: 1;
            color: white;
        }
        
        .insert-hint {
            color: #909399;
            font-style: italic;
            font-size: 12px;
        }
        
        .formula-text {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: #303133;
            line-height: 1.5;
        }
        
        .visual-input-tools {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .variable-section {
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }
        
        .section-title {
            font-size: 12px;
            color: #606266;
            font-weight: 500;
            min-width: 40px;
            margin-top: 4px;
        }
        
        .variable-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .variable-item {
            display: inline-block;
            padding: 4px 8px;
            background-color: #e1f3d8;
            border: 1px solid #67c23a;
            border-radius: 4px;
            font-size: 12px;
            color: #67c23a;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .variable-item:hover {
            background-color: #67c23a;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(103, 194, 58, 0.3);
        }
        
        .number-section {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .number-input {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        /* 表达式输入样式 */
        .expression-input {
            margin-bottom: 16px;
        }
        
        /* 公式工具样式调整 */
        .formula-tools {
            margin-top: 5px;
            /* margin-bottom: 16px; */
        }
        
        .point-btn {
            font-size: 12px;
            height: 28px;
            background-color: #e1f3d8;
            border-color: #67c23a;
            color: #67c23a;
        }
        
        .point-btn:hover {
            background-color: #67c23a;
            border-color: #67c23a;
            color: white;
        }
        
        /* 操作按钮样式 */
        .drawer-actions {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e4e7ed;
            text-align: center;
        }
        
        .drawer-actions .el-button {
            margin: 0 8px;
        }
        
        /* 空状态样式 */
        .empty-selection {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: #909399;
        }
        
        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        .empty-text {
            font-size: 14px;
            color: #909399;
        }
        
        /* 右侧面板内容样式调整 */
        .right-panel .selected-points-section {
            margin-bottom: 16px;
            background-color: white;
            border: 1px solid #e4e7ed;
        }
        
        .right-panel .formula-section {
            margin-top: 16px;
            background-color: white;
            border: 1px solid #e4e7ed;
        }
        
        .right-panel .formula-config {
            background-color: white;
        }
        
        @media (max-width: 900px) {
            .form-row {
                flex-direction: column;
                gap: 8px;
            }
        }
        
        /* 绑定数据按钮的橘黄色背景 */
        .binding-data-btn {
            background-color: #FFA500 !important;
            color: white !important;
            border-radius: 4px;
            padding: 2px 8px;
        }
        
        .binding-data-btn:hover {
            background-color: #FF8C00 !important;
        }
        
        /* ========== 指标管理样式 ========== */
        
        .metrics-section {
            padding: 20px 0;
        }
        
        .metrics-filter {
            margin-bottom: 20px;
            padding: 16px;
            background-color: #fafafa;
            border-radius: 4px;
            border: 1px solid #e4e7ed;
        }
        
        .metrics-table-container {
            margin-bottom: 20px;
        }
        
        .metrics-table-container .el-table {
            border: 1px solid #e4e7ed;
            border-radius: 4px;
        }
        
        .metrics-table-container .el-table th {
            background-color: #fafafa;
            color: #606266;
            font-weight: 600;
        }
        
        .metrics-table-container .el-table td {
            padding: 8px 0;
        }
        
        .metrics-table-container .el-link {
            font-weight: 500;
        }
        
        .metrics-table-container .el-tag {
            font-size: 11px;
            padding: 2px 6px;
        }
        
        .pagination-container {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            padding: 16px 0;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #909399;
        }
        
        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        .empty-text {
            font-size: 16px;
            margin-bottom: 20px;
        }
        
        .empty-actions {
            margin-top: 20px;
        }
        
        /* 指标编辑抽屉样式 */
        .indicator-drawer .el-drawer__body {
            padding: 20px;
        }
        
        .indicator-drawer .el-form-item {
            margin-bottom: 20px;
        }
        
        .indicator-drawer .el-form-item__label {
            font-weight: 500;
            color: #303133;
        }
        
        .indicator-drawer .el-input__inner,
        .indicator-drawer .el-textarea__inner {
            border-radius: 4px;
        }
        
        .indicator-drawer .el-select {
            width: 100%;
        }
        
        /* 指标分类标签样式 */
        .indicator-category-tag {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 3px;
        }

        /* 指标行内编辑样式 */
        .metrics-table-container .el-table .el-input--mini .el-input__inner {
            height: 28px;
            line-height: 28px;
            font-size: 12px;
        }

        .metrics-table-container .el-table .el-select--mini .el-input__inner {
            height: 28px;
            line-height: 28px;
            font-size: 12px;
        }

        .metrics-table-container .el-table .el-button--text {
            padding: 0;
            margin: 0 4px;
        }

        .metrics-table-container .el-table .el-button--text:hover {
            background-color: transparent;
        }

        .metrics-table-container .el-table .el-button--text i {
            font-size: 16px;
        }

        /* 编辑状态行样式 */
        .metrics-table-container .el-table .el-table__row.is-editing {
            background-color: #f0f9ff;
        }

        .metrics-table-container .el-table .el-table__row.is-editing:hover {
            background-color: #e6f3ff;
        }
        
        .indicator-category-tag.performance {
            background-color: #e1f3d8;
            color: #67c23a;
            border: 1px solid #67c23a;
        }
        
        .indicator-category-tag.economic {
            background-color: #f0f9ff;
            color: #409eff;
            border: 1px solid #409eff;
        }
        
        .indicator-category-tag.safety {
            background-color: #fdf6ec;
            color: #e6a23c;
            border: 1px solid #e6a23c;
        }
        
        .indicator-category-tag.environmental {
            background-color: #f0f9ff;
            color: #409eff;
            border: 1px solid #409eff;
        }
        
        /* 指标方向标签样式 */
        .indicator-direction-tag {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 3px;
        }
        
        .indicator-direction-tag.positive {
            background-color: #e1f3d8;
            color: #67c23a;
            border: 1px solid #67c23a;
        }
        
        .indicator-direction-tag.negative {
            background-color: #fef0f0;
            color: #f56c6c;
            border: 1px solid #f56c6c;
        }
        
        /* ========== 指标抽屉样式 ========== */
        
        /* 抽屉背景 */
        .drawer-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .drawer-backdrop.active {
            display: flex;
        }
        
        /* 抽屉主体 */
        .drawer {
            position: fixed;
            bottom: -100%;
            left: 0;
            right: 0;
            width: 100%;
            height: 85vh;
            background-color: #fff;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.15);
            transition: bottom 0.3s ease;
            display: flex;
            flex-direction: column;
            border-radius: 8px 8px 0 0;
            top: auto;
        }
        
        .drawer-backdrop.active .drawer {
            bottom: 0;
        }
        
        /* 抽屉头部 */
        .drawer-header {
            padding: 24px 48px;
            border-bottom: 1px solid #ebeef5;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #fafafa;
        }
        
        .drawer-title {
            font-size: 18px;
            font-weight: 600;
            color: #303133;
            margin: 0;
        }
        
        .drawer-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #909399;
            transition: color 0.2s;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }
        
        .drawer-close:hover {
            color: #f56c6c;
            background-color: #fef0f0;
        }
        
        /* 抽屉主体内容 */
        .drawer-body {
            flex: 1;
            overflow-y: auto;
            padding: 32px 48px;
        }
        
        /* 抽屉底部 */
        .drawer-footer {
            padding: 20px 48px;
            border-top: 1px solid #ebeef5;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            background-color: #fafafa;
        }
        
        /* 抽屉表单样式 */
        .drawer-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .drawer-form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .drawer-form-row.full-width {
            grid-template-columns: 1fr;
        }
        
        .drawer-form-group {
            display: flex;
            flex-direction: column;
        }
        
        .drawer-form-label {
            font-size: 14px;
            color: #606266;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .drawer-form-label.required::after {
            content: " *";
            color: #f56c6c;
            font-weight: 600;
        }
        
        .drawer-form-input, .drawer-form-textarea, .drawer-form-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #dcdfe6;
            border-radius: 4px;
            font-size: 14px;
            color: #303133;
            outline: none;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }
        
        .drawer-form-textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        .drawer-form-input:focus, .drawer-form-textarea:focus, .drawer-form-select:focus {
            border-color: #409eff;
        }
        
        .drawer-form-hint {
            font-size: 12px;
            color: #909399;
            margin-top: 4px;
        }
        
        /* 按钮样式 */
        .btn {
            padding: 8px 16px;
            border: 1px solid #dcdfe6;
            border-radius: 4px;
            background-color: #fff;
            color: #606266;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            outline: none;
        }
        
        .btn:hover {
            border-color: #c6e2ff;
            color: #409eff;
        }
        
        .btn-primary {
            background-color: #409eff;
            border-color: #409eff;
            color: #fff;
        }
        
        .btn-primary:hover {
            background-color: #66b1ff;
            border-color: #66b1ff;
        }
        
        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
        }
        
        /* 变量选择器样式 */
        .variable-selector {
            border: 1px solid #dcdfe6;
            border-radius: 4px;
            padding: 10px;
            background-color: #fafafa;
            min-height: 200px;
        }
        
        .variable-list {
            margin-bottom: 10px;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .variable-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            margin-bottom: 5px;
            background-color: #fff;
            border: 1px solid #e4e7ed;
            border-radius: 4px;
            cursor: grab;
            user-select: none;
        }
        
        .variable-item:last-child {
            margin-bottom: 0;
        }
        
        .variable-item:active {
            cursor: grabbing;
        }
        
        .variable-item.dragging {
            opacity: 0.5;
        }
        
        .variable-item-info {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            flex-wrap: wrap;
        }
        
        .variable-item-name {
            font-weight: 500;
            color: #303133;
            font-size: 13px;
            cursor: grab;
            user-select: none;
        }
        
        .variable-item-name:hover {
            color: #409eff;
            text-decoration: underline;
        }
        
        .variable-item-name:active {
            cursor: grabbing;
        }
        
        .variable-item-description {
            font-size: 12px;
            color: #909399;
            margin-left: 8px;
            font-style: italic;
            flex-basis: 100%;
            margin-top: 4px;
        }
        
        .variable-item-remove {
            color: #f56c6c;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
        }
        
        /* 公式编辑器样式 */
        .formula-input-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .formula-editor {
            border: 1px solid #dcdfe6;
            border-radius: 4px;
            background-color: #fff;
        }
        
        .formula-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            padding: 8px;
            border-bottom: 1px solid #ebeef5;
            background-color: #fafafa;
        }
        
        .formula-btn {
            padding: 4px 8px;
            border: 1px solid #dcdfe6;
            border-radius: 3px;
            background-color: #fff;
            color: #606266;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 24px;
            text-align: center;
        }
        
        .formula-btn:hover:not(:disabled) {
            background-color: #409eff;
            color: #fff;
            border-color: #409eff;
        }
        
        .formula-btn:active:not(:disabled) {
            transform: scale(0.95);
        }
        
        .formula-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .formula-input-wrapper {
            position: relative;
        }
        
        .formula-display {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: none;
            outline: none;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            background-color: #fff;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .formula-display:focus {
            background-color: #fafafa;
        }
        
        .formula-display:empty:before {
            content: attr(placeholder);
            color: #c0c4cc;
            pointer-events: none;
        }
        
        .formula-display.drag-over {
            background-color: #f0f8ff;
            border: 2px dashed #007bff;
        }
        
        .formula-display:disabled {
            background-color: #f5f7fa;
            cursor: not-allowed;
        }
        
        .formula-textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: none;
            outline: none;
            resize: vertical;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            background-color: #fff;
        }
        
        .formula-textarea:focus {
            background-color: #fafafa;
        }
        
        .formula-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        
        .formula-status {
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 10px;
            display: none;
        }
        
        .formula-status.valid {
            display: block;
            background-color: #f0f9ff;
            color: #0369a1;
            border: 1px solid #0ea5e9;
        }
        
        .formula-status.invalid {
            display: block;
            background-color: #fef2f2;
            color: #dc2626;
            border: 1px solid #f87171;
        }
        
        /* 变量选择器抽屉样式 */
        .variable-selector-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .variable-category h4 {
            margin: 0 0 12px 0;
            color: #303133;
            font-size: 16px;
            font-weight: 600;
        }
        
        /* 指标方向样式 */
        .direction-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            text-align: center;
            min-width: 40px;
        }
        
        .direction-positive {
            background-color: #f0f9ff;
            color: #0369a1;
            border: 1px solid #0ea5e9;
        }
        
        .direction-negative {
            background-color: #fef2f2;
            color: #dc2626;
            border: 1px solid #f87171;
        }
        
        /* 变量徽标样式 */
        .variable-badge {
            display: inline-block;
            background-color: #e1f3d8;
            color: #67c23a;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            margin: 0 2px;
            border: 1px solid #b3d8a4;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .variable-badge:hover {
            background-color: #f0f9ff;
            color: #409eff;
            border-color: #409eff;
        }
        
        /* ========== 指标配置抽屉样式 ========== */
        
        .indicator-config {
            height: 100%;
        }
        
        .indicator-config-layout {
            height: 100%;
        }
        
        .indicator-config .left-panel {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .indicator-config .right-panel {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .data-source-section {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .data-source-tabs {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .data-source-tabs .el-tabs {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .data-source-tabs .el-tabs__content {
            flex: 1;
            overflow: hidden;
        }
        
        .data-source-tabs .el-tab-pane {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .tab-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .search-form {
            padding: 16px;
            background-color: #fafafa;
            border-radius: 4px;
            margin-bottom: 16px;
        }
        
        .data-list {
            flex: 1;
            overflow: hidden;
        }
        
        .data-list .el-table {
            height: 100%;
        }
        
        .selected-data-section {
            margin-bottom: 20px;
        }
        
        .selected-data-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e4e7ed;
            border-radius: 4px;
            padding: 8px;
        }
        
        .selected-data-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            margin-bottom: 4px;
            background-color: #f5f7fa;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .selected-data-item:hover {
            background-color: #e1f3d8;
        }
        
        .selected-data-item:last-child {
            margin-bottom: 0;
        }
        
        .data-source {
            color: #909399;
            font-size: 12px;
        }
        
        .data-name {
            font-weight: 500;
            color: #303133;
            margin: 0 4px;
        }
        
        .data-code {
            color: #909399;
            font-size: 12px;
        }
        
        .remove-btn {
            color: #f56c6c;
            margin-left: 8px;
        }
        
        .formula-section {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .formula-config {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .input-mode-tabs {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .input-mode-tabs .el-tabs {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .input-mode-tabs .el-tabs__content {
            flex: 1;
            overflow: hidden;
        }
        
        .input-mode-tabs .el-tab-pane {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .natural-language-input {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .ai-translation-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
        }
        
        .ai-translation-status {
            font-size: 12px;
        }
        
        .translating {
            color: #409eff;
        }
        
        .translated {
            color: #67c23a;
        }
        
        .visual-input {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .visual-formula-display {
            flex: 1;
            border: 1px solid #dcdfe6;
            border-radius: 4px;
            padding: 12px;
            background-color: #fff;
            margin-bottom: 12px;
        }
        
        .formula-preview {
            min-height: 80px;
        }
        
        .formula-blocks {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }
        
        .formula-block {
            display: flex;
            align-items: center;
            padding: 4px 8px;
            background-color: #f0f9ff;
            border: 1px solid #409eff;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .formula-block:hover {
            background-color: #e1f3d8;
            border-color: #67c23a;
        }
        
        .formula-block.selected {
            background-color: #409eff;
            color: #fff;
        }
        
        .block-content {
            font-size: 12px;
            margin-right: 4px;
        }
        
        .delete-btn {
            color: #f56c6c;
            font-size: 12px;
        }
        
        .insert-hint {
            color: #909399;
            font-size: 12px;
            font-style: italic;
        }
        
        .formula-validation {
            margin-bottom: 12px;
        }
        
        .visual-input-tools {
            border-top: 1px solid #e4e7ed;
            padding-top: 12px;
        }
        
        .variable-section, .number-section {
            margin-bottom: 12px;
        }
        
        .section-title {
            font-size: 12px;
            color: #606266;
            margin-bottom: 8px;
            display: block;
        }
        
        .variable-list {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }
        
        .variable-item {
            padding: 2px 6px;
            background-color: #f5f7fa;
            border: 1px solid #dcdfe6;
            border-radius: 3px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .variable-item:hover {
            background-color: #409eff;
            color: #fff;
            border-color: #409eff;
        }
        
        .number-input {
            display: flex;
            align-items: center;
        }
        
        .expression-input {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .expression-input .el-textarea {
            flex: 1;
        }
        
        .drawer-actions {
            margin-top: 20px;
            text-align: right;
        }
        
        .empty-selection {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #909399;
        }
        
        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        .empty-text {
            font-size: 14px;
        }
        

    </style>
</head>
<body>
    <div id="app" class="factory-model-container">
        <!-- 粘性头部 -->
        <!-- <div class="sticky-header">
            <div class="header-content">
                <div class="header-left">
                    <h1 class="page-title">{{ pageTitle }}</h1>
                    <span class="page-description">{{ pageDescription }}</span>
                </div>
                <div class="header-actions">
                    <el-button @click="backToList" icon="el-icon-back">
                        返回列表
                    </el-button>
                </div>
            </div>
        </div> -->

        <!-- 主要内容 -->
        <div class="main-content">
        <!-- 主要内容 -->
        <div class="main-content">
            <!-- 基本信息管理 -->
            <div class="info-card">
                <div class="card-header">
                    <h2 class="card-title">
                        {{ modelInfo.name }}
                        <span class="status-tag" :class="getTemplateClass(modelInfo.templateName)">
                            {{ modelInfo.templateName }}
                        </span>
                        <span class="status-tag" :class="getStatusClass(modelInfo.status)">
                            {{ getStatusText(modelInfo.status) }}
                        </span>
                    </h2>
                    <div class="card-actions">
                        <el-button @click="saveModel" type="primary" icon="el-icon-check" size="small">
                            保存
                        </el-button>
                        <el-button @click="toggleModelStatus" :type="modelInfo.status === 'enabled' ? 'warning' : 'success'"
                            :icon="modelInfo.status === 'enabled' ? 'el-icon-close' : 'el-icon-check'" size="small">
                            {{ modelInfo.status === 'enabled' ? '禁用' : '启用' }}
                        </el-button>
                        <el-button type="default" size="small" icon="el-icon-download" @click="exportAssets">
                            导出资产
                        </el-button>
                        <el-button type="text" @click="toggleBasicInfo"
                            :icon="basicInfoExpanded ? 'el-icon-arrow-up' : 'el-icon-arrow-down'"
                            style="border: 1px solid #ddd; background: #f5f5f5;">
                            {{ basicInfoExpanded ? '收起' : '展开' }}
                        </el-button>
                    </div>
                </div>
                <div class="card-content" :class="{ 'collapsed': !basicInfoExpanded }">
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">工厂模型名称</div>
                            <div class="info-value">
                                <el-input v-if="isEditMode" v-model="modelInfo.name" placeholder="请输入工厂模型名称" size="small">
                                </el-input>
                                <span v-else>{{ modelInfo.name }}</span>
                            </div>
                        </div>
                        <!-- <div class="info-item">
                                    <div class="info-label">创建时间</div>
                                    <div class="info-value">{{ modelInfo.createTime }}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">创建人</div>
                                    <div class="info-value">{{ modelInfo.creator }}</div>
                                </div> -->
                    </div>
                    <div class="info-description" style="margin-top: 24px;">
                        <div class="info-label">工厂模型描述</div>
                        <div class="info-value">
                            <el-input v-if="isEditMode" type="textarea" v-model="modelInfo.description" placeholder="请输入工厂模型描述"
                                :rows="3" size="small">
                            </el-input>
                            <span v-else>{{ modelInfo.description }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 层级结构管理 -->
            <div class="structure-section">
                <!-- 左侧：树形结构 -->
                <div class="tree-card">
                    <div class="card-header">
                        <h2 class="card-title">层级结构</h2>
                        <!-- <el-button type="primary" @click="addRootNode" icon="el-icon-plus" size="small">
                            添加根节点
                        </el-button> -->
                    </div>
                    <div class="tree-toolbar">
                        <el-input 
                            v-model="searchKeyword" 
                            placeholder="搜索节点..." 
                            prefix-icon="el-icon-search"
                            clearable
                            size="small"
                            style="width: 280px;">
                        </el-input>
                        <!-- <el-radio-group v-model="viewMode" size="small">
                            <el-radio-button label="tree">树形</el-radio-button>
                            <el-radio-button label="list">列表</el-radio-button>
                        </el-radio-group> -->
                        <div class="toolbar-actions">
                            <el-button @click="expandAll" size="small" icon="el-icon-s-unfold" title="全部展开">
                            </el-button>
                            <el-button @click="collapseAll" size="small" icon="el-icon-s-fold" title="全部收起">
                            </el-button>
                        </div>
                        <!-- <span v-if="isEditMode" class="drag-tip">
                            <i class="el-icon-rank"></i> 拖拽节点：上方/下方调整顺序，中间作为子节点
                        </span> -->
                    </div>
                    <div class="tree-container"
                         @dragover="onTreeDragOver"
                         @drop="onTreeDrop"
                         @dragleave="onTreeDragLeave">
                        <!-- 树形结构将在这里实现 -->
                        <div v-if="!hasRootNode" class="empty-state">
                            <div class="empty-state-icon">🌳</div>
                            <div class="empty-state-text">暂无层级结构数据</div>
                            <el-button type="primary" size="small" @click="addRootNode">
                                添加根节点
                            </el-button>
                        </div>
                        
                        <div v-else>
                            <div 
                                v-for="(node, index) in visibleNodes" 
                                :key="node.id"
                                class="node-item"
                                :class="[
                                    'node-level-' + node.level, 
                                    { 
                                        selected: selectedNode === node,
                                        dragging: draggingNode === node,
                                        'drag-over': dragOverNode === node
                                    }
                                ]"
                                :data-node-id="node.id"
                                :draggable="isEditMode"
                                @click="selectNode(node)"
                                @dragstart="onDragStart($event, node)"
                                @dragend="onDragEnd"
                                @dragenter="onDragEnter($event, node)"
                                @dragleave="onDragLeave($event, node)"
                                @dragover="onDragOver($event, node)"
                                @drop="onDrop($event, node)">
                                
                                <i v-if="isEditMode" class="el-icon-rank drag-handle"></i>
                                
                                <i class="node-expand-icon"
                                   :class="[
                                       hasChildren(node) ? (isExpanded(node) ? 'el-icon-arrow-down expanded' : 'el-icon-arrow-right') : 'leaf'
                                   ]"
                                   @click.stop="toggleExpand(node)">
                                </i>
                                
                                <i class="node-icon" :class="getNodeIcon(node.type)"></i>
                                
                                <div class="node-content">
                                    <span class="node-name">{{ node.name }}</span>
                                    <span class="node-type">({{ node.type }})</span>
                                    <!-- <span class="node-description">{{ node.description }}</span> -->
                                </div>
                                
                                <div class="node-actions" v-if="isEditMode">
                                    <el-button 
                                        type="text" 
                                        size="mini" 
                                        icon="el-icon-plus"
                                        title="添加子节点"
                                        @click.stop="addChildNode(node)">
                                        
                                    </el-button>
                                    <el-button 
                                        type="text" 
                                        size="mini" 
                                        icon="el-icon-edit"
                                        title="编辑节点"
                                        @click.stop="editNode(node)">
                                        
                                    </el-button>
                                    <el-button 
                                        type="text" 
                                        size="mini" 
                                        icon="el-icon-document-copy"
                                        title="复制节点"
                                        @click.stop="copyNode(node)"
                                        style="color: #409eff;">
                                        
                                    </el-button>
                                    <el-button 
                                        type="text" 
                                        size="mini" 
                                        icon="el-icon-delete"   
                                        title="删除节点"
                                        @click.stop="deleteNode(node)"
                                        style="color: #f56c6c;">
                                        
                                    </el-button>
                                </div>
                                <div class="node-actions" v-if="!isEditMode">
                                    <el-button 
                                        type="text" 
                                        size="mini" 
                                        icon="el-icon-info"
                                        title="查看节点"
                                        @click.stop="viewNode(node)">
                                        
                                    </el-button>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>

                <!-- 右侧：详情面板 -->
                <div class="details-card">
                    <!-- <div class="card-header">
                        <h2 class="card-title">节点详情</h2>
                        <el-button v-if="isEditMode" type="success" @click="mountAsset" icon="el-icon-link" size="small">
                            挂载资产
                        </el-button>
                    </div> -->
                    <div class="details-content">
                        <!-- 空状态 -->
                        <div v-if="!selectedNode" class="empty-state">
                            <div class="empty-state-icon">📋</div>
                            <div class="empty-state-text">请选择一个节点查看详情</div>
                        </div>
                        
                        <!-- 节点详情 -->
                        <div v-else class="node-details">
                            <!-- 节点基本信息 -->
                            <div class="detail-section">
                                <div class="section-header">
                                    <h3 class="section-title">
                                        <!-- 资产表单模式下的标题 -->
                                        <template v-if="isAddingAsset || isViewingAsset || isEditingAsset">
                                            <div class="asset-path-title">
                                                <span class="asset-path">
                                                    <i class="el-icon-folder"></i>
                                                    {{ getAssetPath() }}
                                                    <span v-if="getAssetName()" class="asset-name">
                                                        / {{ getAssetName() }}
                                                    </span>
                                                </span>
                                                <span class="asset-operation-status" :class="getAssetOperationStatusClass()" :title="getAssetOperationText()">
                                                    <i :class="getAssetOperationIcon()"></i>
                                                </span>
                                            </div>
                                        </template>
                                        <!-- 正常模式下的标题 -->
                                        <template v-else>
                                        {{ selectedNode.name }}
                                        <span class="node-type-tag" :class="getNodeTypeClass(selectedNode.type)">
                                            {{ selectedNode.type }}
                                        </span>
                                        <span class="status-tag status-level">
                                            第{{ selectedNode.level }}级
                                        </span>
                                        </template>
                                    </h3>
                                    <div class="section-actions">
                                        <!-- 资产表单模式下的操作按钮 -->
                                        <template v-if="isAddingAsset || isViewingAsset || isEditingAsset">
                                            <el-button v-if="!isViewingAsset" type="primary" size="small" @click="saveAsset">
                                                {{ isAddingAsset ? '确认添加资产' : '确认修改资产' }}
                                            </el-button>
                                            <el-button @click="cancelAssetForm" size="small">
                                                返回资产列表
                                            </el-button>
                                           
                                        </template>
                                        <!-- 正常模式下的按钮 -->
                                        <template v-else>
                                            <el-button v-if="isEditMode" type="primary" size="small" icon="el-icon-plus" @click="addAsset">
                                                添加资产
                                            </el-button>
                                        </template>
                                        <!-- 隐藏基本信息展开/收起按钮 -->
                                        <!-- <el-button type="text" @click="toggleNodeDetailsBasicInfo" :icon="nodeDetailsBasicInfoExpanded ? 'el-icon-arrow-up' : 'el-icon-arrow-down'">
                                            {{ nodeDetailsBasicInfoExpanded ? '收起' : '展开' }}
                                        </el-button> -->
                                    </div>
                                </div>
                                <!-- 隐藏基本信息区域 -->
                                <!-- <div class="section-content" :class="{ 'collapsed': !nodeDetailsBasicInfoExpanded }">
                                    <div class="info-grid">
                                        <div class="info-item">
                                            <div class="info-label">节点编码</div>
                                            <div class="info-value">{{ selectedNode.code }}</div>
                                        </div>
                                        <div class="info-item">
                                            <div class="info-label">创建时间</div>
                                            <div class="info-value">{{ selectedNode.createTime }}</div>
                                        </div>
                                    </div>
                                    <div class="info-item description-item">
                                        <div class="info-label">描述</div>
                                        <div class="info-value">{{ selectedNode.description || '暂无描述' }}</div>
                                    </div>
                                </div> -->
                            </div>
                            
                            <!-- 子节点统计 -->
                            <!-- <div class="detail-section">
                                <h3 class="section-title">子节点统计</h3>
                                <div class="stats-grid">
                                    <div class="stat-item">
                                        <div class="stat-number">{{ getChildNodeCount(selectedNode) }}</div>
                                        <div class="stat-label">子节点数量</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-number">{{ getAssetCount(selectedNode) }}</div>
                                        <div class="stat-label">资产数量</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-number">{{ getTotalAssetCount(selectedNode) }}</div>
                                        <div class="stat-label">总资产数量</div>
                                    </div>
                                </div>
                            </div> -->
                            
                            <!-- 资产列表 -->
                            <div class="detail-section">

                                
                                <!-- 资产表单 -->
                                <div v-if="isAddingAsset || isViewingAsset || isEditingAsset" class="add-asset-form">
                                    <!-- 上方区域 -->
                                    <div class="add-asset-top">
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label>资产类型</label>
                                                <el-select v-model="assetForm.assetType" placeholder="请选择资产类型" filterable style="width: 100%;" :disabled="!isAddingAsset">
                                                    <el-option 
                                                        v-for="type in assetTypes" 
                                                        :key="type.value" 
                                                        :label="type.label" 
                                                        :value="type.value">
                                                    </el-option>
                                                </el-select>
                                            </div>
                                            <div class="form-group">
                                                <label>资产编号</label>
                                                <el-input v-model="assetForm.deviceCode" placeholder="请输入资产编号" :disabled="isViewingAsset"></el-input>
                                            </div>
                                            <div class="form-group">
                                                <label>资产名称</label>
                                                <el-input v-model="assetForm.deviceName" placeholder="请输入资产名称" :disabled="isViewingAsset"></el-input>
                                            </div>
                                        </div>
                                        <div class="form-row">
                                            <div class="form-group">
                                                <!-- <label>接入状态</label> -->
                                                <div class="status-display">
                                                    <span class="status-text">接入状态：</span>
                                                    <el-tooltip :content="assetForm.connectionStatus" placement="top">
                                                        <i :class="assetForm.connectionStatus === '已接入' ? 'el-icon-link status-icon status-connected' : 'el-icon-scissors status-icon status-disconnected'"></i>
                                                    </el-tooltip>
                                                    <el-button 
                                                        v-if="!isViewingAsset"
                                                        :type="assetForm.connectionStatus === '已接入' ? 'danger' : 'success'"
                                                        size="mini" 
                                                        :icon="assetForm.connectionStatus === '已接入' ? 'el-icon-close' : 'el-icon-link'"
                                                        @click="toggleAssetFormConnection">
                                                        {{ assetForm.connectionStatus === '已接入' ? '断开' : '接入' }}
                                                    </el-button>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <!-- <label>运行状态</label> -->
                                                <div class="status-display">
                                                    <span class="status-text">运行状态：</span>
                                                    <el-tooltip :content="assetForm.runningStatus" placement="top">
                                                        <span :class="getRunningStatusCircle()"></span>
                                                    </el-tooltip>
                                                    <el-button 
                                                        v-if="!isViewingAsset && assetForm.connectionStatus === '已接入'"
                                                        type="primary" 
                                                        size="mini" 
                                                        icon="el-icon-refresh"
                                                        @click="refreshAssetFormStatus">
                                                        刷新
                                                    </el-button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- 下方区域 - 页签 -->
                                    <div class="add-asset-bottom">
                                        <el-tabs v-model="activeTab" type="card">
                                                                                         <el-tab-pane :label="basicInfoTabLabel" name="basicInfo">
                                                 <div class="tab-content">
                                                     <div v-if="selectedAssetType">
                                                         <!-- <h4 style="margin-bottom: 16px; color: #303133;">静态属性配置</h4> -->
                                                         <div class="static-properties-form">
                                                             <div v-for="(property, index) in selectedAssetType.staticProperties" :key="index" class="form-group" v-if="property.name !== '设备名称'">
                                                                 <label>{{ property.name }} <span v-if="property.required" style="color: #f56c6c;">*</span></label>
                                                                 <el-input 
                                                                     v-model="property.defaultValue" 
                                                                     :placeholder="`请输入${property.name}`"
                                                                     :type="property.type === '日期' ? 'date' : 'text'"
                                                                     :disabled="isViewingAsset">
                                                                 </el-input>
                                                             </div>
                                                         </div>
                                                     </div>
                                                     <div v-else>
                                                         <p style="color: #909399; text-align: center; padding: 40px 0;">请先选择资产类型</p>
                                                     </div>
                                                 </div>
                                             </el-tab-pane>
                                             <el-tab-pane :label="collectionParamsTabLabel" name="collectionParams">
                                                 <div class="tab-content">
                                                     <div v-if="selectedAssetType && selectedAssetType.dynamicVariables">
                                                         <!-- 新增参数按钮 -->
                                                         <div style="margin-bottom: 16px; display: flex; justify-content: flex-end; gap: 8px;">
                                                             <el-button 
                                                                 v-if="!isViewingAsset"
                                                                 size="small" 
                                                                 type="primary" 
                                                                 icon="el-icon-plus"
                                                                 @click="addDynamicVariable">
                                                                 新增参数
                                                             </el-button>
                                                             <el-button 
                                                                 v-if="!isViewingAsset"
                                                                 size="small" 
                                                                 type="success" 
                                                                 icon="el-icon-document-copy"
                                                                 @click="showDataPointBatchAdd">
                                                                 用数据点位批量新增
                                                             </el-button>
                                                         </div>
                                                         <div class="dynamic-variables-table">
                                                             <el-table 
                                                                 :data="selectedAssetType.dynamicVariables" 
                                                                 size="small" 
                                                                 stripe 
                                                                 :row-class-name="getDynamicVariableRowClassName">
                                                                 <el-table-column prop="name" label="变量名称" min-width="120">
                                                                     <template slot-scope="scope">
                                                                         <span v-if="!scope.row.isEditing">{{ scope.row.name }}</span>
                                                                         <el-input v-else v-model="scope.row.name" size="mini"></el-input>
                                                                     </template>
                                                                 </el-table-column>
                                                                 <el-table-column prop="code" label="变量编码" min-width="120">
                                                                     <template slot-scope="scope">
                                                                         <span v-if="!scope.row.isEditing">{{ scope.row.code }}</span>
                                                                         <el-input v-else v-model="scope.row.code" size="mini"></el-input>
                                                                     </template>
                                                                 </el-table-column>
                                                                 <el-table-column prop="type" label="数据类型" min-width="80">
                                                                     <template slot-scope="scope">
                                                                         <span v-if="!scope.row.isEditing">{{ scope.row.type }}</span>
                                                                         <el-select v-else v-model="scope.row.type" size="mini" style="width: 100%">
                                                                             <el-option label="数值" value="数值"></el-option>
                                                                             <el-option label="字符串" value="字符串"></el-option>
                                                                             <el-option label="布尔值" value="布尔值"></el-option>
                                                                             <el-option label="枚举" value="枚举"></el-option>
                                                                             <el-option label="日期" value="日期"></el-option>
                                                                             <el-option label="日期时间" value="日期时间"></el-option>
                                                                         </el-select>
                                                                     </template>
                                                                 </el-table-column>
                                                                 <el-table-column prop="unit" label="单位" min-width="60">
                                                                     <template slot-scope="scope">
                                                                         <span v-if="!scope.row.isEditing">{{ scope.row.unit }}</span>
                                                                         <el-input v-else v-model="scope.row.unit" size="mini"></el-input>
                                                                     </template>
                                                                 </el-table-column>
                                                                 <el-table-column prop="precision" label="精度" min-width="60">
                                                                     <template slot-scope="scope">
                                                                         <span v-if="!scope.row.isEditing">{{ scope.row.precision }}</span>
                                                                         <el-input v-else v-model="scope.row.precision" size="mini"></el-input>
                                                                     </template>
                                                                 </el-table-column>
                                                                 <el-table-column prop="frequency" label="采集频率" min-width="80">
                                                                     <template slot-scope="scope">
                                                                         <span v-if="!scope.row.isEditing">{{ scope.row.frequency }}</span>
                                                                         <el-select v-else v-model="scope.row.frequency" size="mini" style="width: 100%">
                                                                             <el-option label="1秒" value="1秒"></el-option>
                                                                             <el-option label="5秒" value="5秒"></el-option>
                                                                             <el-option label="10秒" value="10秒"></el-option>
                                                                             <el-option label="30秒" value="30秒"></el-option>
                                                                             <el-option label="1分钟" value="1分钟"></el-option>
                                                                             <el-option label="5分钟" value="5分钟"></el-option>
                                                                             <el-option label="10分钟" value="10分钟"></el-option>
                                                                             <el-option label="1小时" value="1小时"></el-option>
                                                                             <el-option label="1天" value="1天"></el-option>
                                                                         </el-select>
                                                                     </template>
                                                                 </el-table-column>
                                                                 <el-table-column prop="valueCycle" label="取值周期" min-width="80">
                                                                     <template slot-scope="scope">
                                                                         <span v-if="!scope.row.isEditing">{{ scope.row.valueCycle }}</span>
                                                                         <el-select v-else v-model="scope.row.valueCycle" size="mini" style="width: 100%">
                                                                             <el-option label="1秒" value="1秒"></el-option>
                                                                             <el-option label="5秒" value="5秒"></el-option>
                                                                             <el-option label="10秒" value="10秒"></el-option>
                                                                             <el-option label="30秒" value="30秒"></el-option>
                                                                             <el-option label="1分钟" value="1分钟"></el-option>
                                                                             <el-option label="5分钟" value="5分钟"></el-option>
                                                                             <el-option label="10分钟" value="10分钟"></el-option>
                                                                             <el-option label="1小时" value="1小时"></el-option>
                                                                             <el-option label="1天" value="1天"></el-option>
                                                                         </el-select>
                                                                     </template>
                                                                 </el-table-column>
                                                                 <el-table-column prop="valueMethod" label="取值方式" min-width="80">
                                                                     <template slot-scope="scope">
                                                                         <span v-if="!scope.row.isEditing">{{ scope.row.valueMethod }}</span>
                                                                         <el-select v-else v-model="scope.row.valueMethod" size="mini" style="width: 100%">
                                                                             <el-option label="最小值" value="最小值"></el-option>
                                                                             <el-option label="最大值" value="最大值"></el-option>
                                                                             <el-option label="平均值" value="平均值"></el-option>
                                                                             <el-option label="瞬时值" value="瞬时值"></el-option>
                                                                             <el-option label="第一个值" value="第一个值"></el-option>
                                                                             <el-option label="最后一个值" value="最后一个值"></el-option>
                                                                             <el-option label="差值" value="差值"></el-option>
                                                                             <el-option label="标准方差" value="标准方差"></el-option>
                                                                         </el-select>
                                                                     </template>
                                                                 </el-table-column>
                                                                 <el-table-column prop="dataCategory" label="数据分类" min-width="80">
                                                                     <template slot-scope="scope">
                                                                         <span v-if="!scope.row.isEditing">{{ scope.row.dataCategory }}</span>
                                                                         <el-select v-else v-model="scope.row.dataCategory" size="mini" style="width: 100%">
                                                                             <el-option label="电流" value="电流"></el-option>
                                                                             <el-option label="压力" value="压力"></el-option>
                                                                             <el-option label="温度" value="温度"></el-option>
                                                                             <el-option label="振动" value="振动"></el-option>
                                                                             <el-option label="流量" value="流量"></el-option>
                                                                             <el-option label="运行" value="运行"></el-option>
                                                                             <el-option label="产量" value="产量"></el-option>
                                                                             <el-option label="电量" value="电量"></el-option>
                                                                         </el-select>
                                                                     </template>
                                                                 </el-table-column>
                                                                 <el-table-column prop="businessCategory" label="业务分类" min-width="80">
                                                                     <template slot-scope="scope">
                                                                         <span v-if="!scope.row.isEditing">{{ scope.row.businessCategory }}</span>
                                                                         <el-select v-else v-model="scope.row.businessCategory" size="mini" style="width: 100%">
                                                                             <el-option label="生产" value="生产"></el-option>
                                                                             <el-option label="质量" value="质量"></el-option>
                                                                             <el-option label="运维" value="运维"></el-option>
                                                                             <el-option label="物流" value="物流"></el-option>
                                                                             <el-option label="成本" value="成本"></el-option>
                                                                         </el-select>
                                                                     </template>
                                                                 </el-table-column>
                                                                 <el-table-column prop="enabled" label="启停" min-width="80" fixed="right">
                                                                     <template slot-scope="scope">
                                                                         <el-switch 
                                                                             v-model="scope.row.enabled"
                                                                             @change="toggleCollectionVariableStatus(scope.row)">
                                                                         </el-switch>
                                                                     </template>
                                                                 </el-table-column>
                                                                 <el-table-column label="数据绑定" min-width="80" fixed="right">
                                                                     <template slot-scope="scope">
                                                                         <el-button 
                                                                             type="text" 
                                                                             size="small" 
                                                                             @click="configureDataBinding(scope.row)"
                                                                             :class="getDataBindingDisplayText(scope.row) === '绑定数据' ? 'binding-data-btn' : ''"
                                                                             style="color: #409EFF; cursor: pointer;">
                                                                             {{ getDataBindingDisplayText(scope.row) }}
                                                                         </el-button>
                                                                     </template>
                                                                 </el-table-column>
                                                                 <!-- <el-table-column label="数据转换" min-width="80" fixed="right">
                                                                     <template slot-scope="scope">
                                                                         <el-button 
                                                                             v-if="!scope.row.dataTransform" 
                                                                             type="text" 
                                                                             size="small" 
                                                                             @click="configureDataTransform(scope.row)">
                                                                             配置
                                                                         </el-button>
                                                                         <span v-else>{{ scope.row.dataTransform }}</span>
                                                                     </template>
                                                                 </el-table-column> -->
                                                                  <el-table-column label="操作" min-width="120" fixed="right">
                                                                     <template slot-scope="scope">
                                                                         <div v-if="scope.row.isEditing">
                                                                             <el-button 
                                                                                 type="text" 
                                                                                 size="mini" 
                                                                                 @click="saveRowEdit(scope.row)"
                                                                                 style="padding: 0; margin-right: 8px;">
                                                                                 <i class="el-icon-check" style="color: #67C23A; font-size: 16px;"></i>
                                                                             </el-button>
                                                                             <el-button 
                                                                                 type="text" 
                                                                                 size="mini" 
                                                                                 @click="cancelRowEdit(scope.row)"
                                                                                 style="padding: 0; margin-right: 8px;">
                                                                                 <i class="el-icon-close" style="color: #F56C6C; font-size: 16px;"></i>
                                                                             </el-button>
                                                                         </div>
                                                                         <div v-else>
                                                                             <el-button 
                                                                                 type="text" 
                                                                                 size="mini" 
                                                                                 @click="enterDynamicVariableEditMode(scope.row)"
                                                                                 style="padding: 0; margin-right: 8px;">
                                                                                 <i class="el-icon-edit" style="color: #409EFF; font-size: 16px;"></i>
                                                                             </el-button>
                                                                         </div>
                                                                     </template>
                                                                 </el-table-column>
                                                             </el-table>
                                                         </div>
                                                     </div>
                                                     <div v-else>
                                                         <p style="color: #909399; text-align: center; padding: 40px 0;">请先选择资产类型</p>
                                                     </div>
                                                 </div>
                                                                                          </el-tab-pane>
                                             <el-tab-pane :label="businessPropertiesTabLabel" name="businessProperties">
                                                 <div class="tab-content">
                                                     <div v-if="selectedAssetType && selectedAssetType.businessProperties">
                                                         <div class="business-properties-table">
                                                              <el-table 
                                                                 :data="selectedAssetType.businessProperties" 
                                                                 size="small" 
                                                                 stripe
                                                                 :row-class-name="getBusinessPropertyRowClassName">
                                                                 <el-table-column prop="name" label="属性名称" min-width="120">
                                                                     <template slot-scope="scope">
                                                                         <div v-if="scope.row.isEditing">
                                                                             <el-input 
                                                                                 v-model="scope.row.name" 
                                                                                 size="mini" 
                                                                                 placeholder="请输入属性名称"
                                                                                 @blur="saveBusinessPropertyRow(scope.row)">
                                                                             </el-input>
                                                                         </div>
                                                                         <div v-else>
                                                                             {{ scope.row.name }}
                                                                         </div>
                                                                     </template>
                                                                 </el-table-column>
                                                                 <el-table-column prop="code" label="属性编码" min-width="120">
                                                                     <template slot-scope="scope">
                                                                         <div v-if="scope.row.isEditing">
                                                                             <el-input 
                                                                                 v-model="scope.row.code" 
                                                                                 size="mini" 
                                                                                 placeholder="请输入属性编码"
                                                                                 @blur="saveBusinessPropertyRow(scope.row)">
                                                                             </el-input>
                                                                         </div>
                                                                         <div v-else>
                                                                             {{ scope.row.code }}
                                                                         </div>
                                                                     </template>
                                                                 </el-table-column>
                                                                 <el-table-column prop="type" label="数据类型" min-width="80">
                                                                     <template slot-scope="scope">
                                                                         <div v-if="scope.row.isEditing">
                                                                             <el-select 
                                                                                 v-model="scope.row.type" 
                                                                                 size="mini" 
                                                                                 placeholder="请选择"
                                                                                 @change="saveBusinessPropertyRow(scope.row)"
                                                                                 style="width: 100%">
                                                                                 <el-option label="字符串" value="字符串"></el-option>
                                                                                 <el-option label="数值" value="数值"></el-option>
                                                                                 <el-option label="布尔值" value="布尔值"></el-option>
                                                                                 <el-option label="日期" value="日期"></el-option>
                                                                                 <el-option label="日期时间" value="日期时间"></el-option>
                                                                                 <el-option label="枚举" value="枚举"></el-option>
                                                                             </el-select>
                                                                         </div>
                                                                         <div v-else>
                                                                             {{ scope.row.type }}
                                                                         </div>
                                                                     </template>
                                                                 </el-table-column>
                                                                 <el-table-column prop="required" label="是否必填" min-width="80">
                                                                     <template slot-scope="scope">
                                                                         <div v-if="scope.row.isEditing">
                                                                             <el-select 
                                                                                 v-model="scope.row.required" 
                                                                                 size="mini" 
                                                                                 placeholder="请选择"
                                                                                 @change="saveBusinessPropertyRow(scope.row)"
                                                                                 style="width: 100%">
                                                                                 <el-option :label="true" :value="true">是</el-option>
                                                                                 <el-option :label="false" :value="false">否</el-option>
                                                                             </el-select>
                                                                         </div>
                                                                         <div v-else>
                                                                         <el-tag :type="scope.row.required ? 'danger' : 'info'" size="small">
                                                                             {{ scope.row.required ? '是' : '否' }}
                                                                         </el-tag>
                                                                         </div>
                                                                     </template>
                                                                 </el-table-column>
                                                                 <el-table-column prop="defaultValue" label="默认值" min-width="100">
                                                                     <template slot-scope="scope">
                                                                         <div v-if="scope.row.isEditing">
                                                                             <el-input 
                                                                                 v-model="scope.row.defaultValue" 
                                                                                 size="mini" 
                                                                                 placeholder="请输入默认值"
                                                                                 @blur="saveBusinessPropertyRow(scope.row)">
                                                                             </el-input>
                                                                         </div>
                                                                         <div v-else>
                                                                             {{ scope.row.defaultValue }}
                                                                         </div>
                                                                     </template>
                                                                 </el-table-column>
                                                                  <el-table-column prop="enabled" label="启停" min-width="80" fixed="right">
                                                                      <template slot-scope="scope">
                                                                          <el-switch 
                                                                              v-model="scope.row.enabled"
                                                                              @change="toggleBusinessPropertyStatus(scope.row)">
                                                                          </el-switch>
                                                                      </template>
                                                                  </el-table-column>
                                                                  <el-table-column label="绑定数据" min-width="80" fixed="right">
                                                                     <template slot-scope="scope">
                                                                         <el-button 
                                                                             type="text" 
                                                                             size="small" 
                                                                             @click="configureBusinessPropertyDataBinding(scope.row)"
                                                                             :class="getBusinessPropertyDataBindingDisplayText(scope.row) === '绑定数据' ? 'binding-data-btn' : ''"
                                                                             style="color: #409EFF; cursor: pointer;">
                                                                             {{ getBusinessPropertyDataBindingDisplayText(scope.row) }}
                                                                         </el-button>
                                                                     </template>
                                                                 </el-table-column>
                                                                  <el-table-column label="操作" min-width="120" fixed="right">
                                                                     <template slot-scope="scope">
                                                                         <div v-if="scope.row.isEditing">
                                                                             <el-button 
                                                                                 type="text" 
                                                                                 size="mini" 
                                                                                 @click="saveBusinessPropertyRow(scope.row)"
                                                                                 style="padding: 0; margin-right: 8px;">
                                                                                 <i class="el-icon-check" style="color: #67C23A; font-size: 16px;"></i>
                                                                             </el-button>
                                                                             <el-button 
                                                                                 type="text" 
                                                                                 size="mini" 
                                                                                 @click="cancelBusinessPropertyEdit(scope.row)"
                                                                                 style="padding: 0; margin-right: 8px;">
                                                                                 <i class="el-icon-close" style="color: #F56C6C; font-size: 16px;"></i>
                                                                             </el-button>
                                                                         </div>
                                                                         <div v-else>
                                                                             <el-button 
                                                                                 type="text" 
                                                                                 size="mini" 
                                                                                 @click="enterBusinessPropertyEditMode(scope.row)"
                                                                                 style="padding: 0; margin-right: 8px;">
                                                                                 <i class="el-icon-edit" style="color: #409EFF; font-size: 16px;"></i>
                                                                             </el-button>
                                                                         </div>
                                                                     </template>
                                                                 </el-table-column>
                                                             </el-table>
                                                         </div>
                                                     </div>
                                                     <div v-else>
                                                         <p style="color: #909399; text-align: center; padding: 40px 0;">请先选择资产类型</p>
                                                     </div>
                                                 </div>
                                             </el-tab-pane>
                                             <el-tab-pane :label="metricsTabLabel" name="metrics">
                                                <div class="tab-content">
                                                    <div class="metrics-section">
                                                        <!-- 指标筛选 -->
                                                        <div class="metrics-filter">
                                                            <el-row :gutter="16">
                                                                <el-col :span="4">
                                                                    <el-select v-model="indicatorFilter.category" placeholder="指标分类" clearable size="small" style="width: 100%">
                                                                        <el-option label="性能指标" value="性能指标"></el-option>
                                                                        <el-option label="经济指标" value="经济指标"></el-option>
                                                                        <el-option label="安全指标" value="安全指标"></el-option>
                                                                        <el-option label="环保指标" value="环保指标"></el-option>
                                                                    </el-select>
                                                                </el-col>
                                                                <el-col :span="4">
                                                                    <el-select v-model="indicatorFilter.direction" placeholder="指标方向" clearable size="small" style="width: 100%">
                                                                        <el-option label="正向" value="positive"></el-option>
                                                                        <el-option label="负向" value="negative"></el-option>
                                                                    </el-select>
                                                                </el-col>
                                                                <el-col :span="4">
                                                                    <el-input 
                                                                        v-model="indicatorFilter.keyword" 
                                                                        placeholder="搜索指标名称或编码" 
                                                                        size="small"
                                                                        clearable>
                                                                        <i slot="prefix" class="el-input__icon el-icon-search"></i>
                                                                    </el-input>
                                                                </el-col>
                                                                <el-col :span="4">
                                                                        <el-button size="small" @click="clearIndicatorFilter">清空筛选</el-button>
                                                                </el-col>
                                                                <el-col :span="8">
                                                                    <div style="display: flex; justify-content: flex-end; gap: 8px;">
                                                                            <el-button size="small" @click="addIndicator" type="primary">
                                                                                <i class="el-icon-plus"></i> 新增指标
                                                                            </el-button>
                                                                            <el-button size="small" @click="batchDeleteIndicators" :disabled="selectedIndicators.length === 0">
                                                                                <i class="el-icon-delete"></i> 批量删除
                                                                            </el-button>
                                                                    </div>
                                                                </el-col>
                                                            </el-row>
                                                        </div>
                                                        
                                                        <!-- 指标列表 -->
                                                        <div class="metrics-table-container">
                                                             <el-table 
                                                                :data="filteredIndicators" 
                                                                size="small"
                                                                stripe
                                                                :row-class-name="getIndicatorRowClassName"
                                                                @selection-change="handleIndicatorSelectionChange"
                                                                style="width: 100%">
                                                                <el-table-column type="selection" width="55"></el-table-column>
                                                                <el-table-column prop="name" label="指标名称" min-width="120">
                                                                    <template slot-scope="scope">
                                                                        <div v-if="scope.row.isEditing">
                                                                            <el-input 
                                                                                v-model="scope.row.name" 
                                                                                size="mini" 
                                                                                placeholder="请输入指标名称"
                                                                                @blur="saveIndicatorRow(scope.row)">
                                                                            </el-input>
                                                                        </div>
                                                                        <div v-else>
                                                                        <el-link type="primary" @click="viewIndicator(scope.row)">{{ scope.row.name }}</el-link>
                                                                        </div>
                                                                    </template>
                                                                </el-table-column>
                                                                <el-table-column prop="code" label="指标编码" min-width="120">
                                                                    <template slot-scope="scope">
                                                                        <div v-if="scope.row.isEditing">
                                                                            <el-input 
                                                                                v-model="scope.row.code" 
                                                                                size="mini" 
                                                                                placeholder="请输入指标编码"
                                                                                @blur="saveIndicatorRow(scope.row)">
                                                                            </el-input>
                                                                        </div>
                                                                        <div v-else>
                                                                            {{ scope.row.code }}
                                                                        </div>
                                                                    </template>
                                                                </el-table-column>
                                                                <el-table-column prop="category" label="指标分类" width="100">
                                                                    <template slot-scope="scope">
                                                                        <div v-if="scope.row.isEditing">
                                                                            <el-select 
                                                                                v-model="scope.row.category" 
                                                                                size="mini" 
                                                                                placeholder="请选择"
                                                                                @change="saveIndicatorRow(scope.row)"
                                                                                style="width: 100%">
                                                                                <el-option label="性能指标" value="性能指标"></el-option>
                                                                                <el-option label="经济指标" value="经济指标"></el-option>
                                                                                <el-option label="安全指标" value="安全指标"></el-option>
                                                                                <el-option label="环保指标" value="环保指标"></el-option>
                                                                            </el-select>
                                                                        </div>
                                                                        <div v-else>
                                                                        <el-tag size="mini" :type="getIndicatorCategoryType(scope.row.category)">{{ scope.row.category }}</el-tag>
                                                                        </div>
                                                                    </template>
                                                                </el-table-column>
                                                                <el-table-column prop="direction" label="指标方向" width="80">
                                                                    <template slot-scope="scope">
                                                                        <div v-if="scope.row.isEditing">
                                                                            <el-select 
                                                                                v-model="scope.row.direction" 
                                                                                size="mini" 
                                                                                placeholder="请选择"
                                                                                @change="saveIndicatorRow(scope.row)"
                                                                                style="width: 100%">
                                                                                <el-option label="正向" value="positive"></el-option>
                                                                                <el-option label="负向" value="negative"></el-option>
                                                                            </el-select>
                                                                        </div>
                                                                        <div v-else>
                                                                        <el-tag size="mini" :type="scope.row.direction === 'positive' ? 'success' : 'danger'">
                                                                            {{ scope.row.direction === 'positive' ? '正向' : '负向' }}
                                                                        </el-tag>
                                                                        </div>
                                                                    </template>
                                                                </el-table-column>
                                                                <el-table-column prop="unit" label="单位" width="80">
                                                                    <template slot-scope="scope">
                                                                        <div v-if="scope.row.isEditing">
                                                                            <el-input 
                                                                                v-model="scope.row.unit" 
                                                                                size="mini" 
                                                                                placeholder="请输入单位"
                                                                                @blur="saveIndicatorRow(scope.row)">
                                                                            </el-input>
                                                                        </div>
                                                                        <div v-else>
                                                                            {{ scope.row.unit }}
                                                                        </div>
                                                                    </template>
                                                                </el-table-column>
                                                                <el-table-column prop="calculationCycle" label="计算周期" width="80">
                                                                    <template slot-scope="scope">
                                                                        <div v-if="scope.row.isEditing">
                                                                            <el-select 
                                                                                v-model="scope.row.calculationCycle" 
                                                                                size="mini" 
                                                                                placeholder="请选择"
                                                                                @change="saveIndicatorRow(scope.row)"
                                                                                style="width: 100%">
                                                                                <el-option label="小时" value="hour"></el-option>
                                                                                <el-option label="天" value="day"></el-option>
                                                                                <el-option label="月" value="month"></el-option>
                                                                                <el-option label="年" value="year"></el-option>
                                                                            </el-select>
                                                                        </div>
                                                                        <div v-else>
                                                                            {{ scope.row.calculationCycle }}
                                                                        </div>
                                                                    </template>
                                                                </el-table-column>
                                                                <el-table-column prop="updateFrequency" label="更新频率" width="80">
                                                                    <template slot-scope="scope">
                                                                        <div v-if="scope.row.isEditing">
                                                                            <el-select 
                                                                                v-model="scope.row.updateFrequency" 
                                                                                size="mini" 
                                                                                placeholder="请选择"
                                                                                @change="saveIndicatorRow(scope.row)"
                                                                                style="width: 100%">
                                                                                <el-option label="1小时" value="1h"></el-option>
                                                                                <el-option label="1天" value="1d"></el-option>
                                                                                <el-option label="1月" value="1m"></el-option>
                                                                            </el-select>
                                                                        </div>
                                                                        <div v-else>
                                                                            {{ scope.row.updateFrequency }}
                                                                        </div>
                                                                    </template>
                                                                </el-table-column>
                                                                <el-table-column prop="participatingVariables" label="参与变量数" width="100">
                                                                    <template slot-scope="scope">
                                                                        {{ scope.row.participatingVariables ? scope.row.participatingVariables.length : 0 }} 个
                                                                    </template>
                                                                </el-table-column>
                                                                <el-table-column prop="description" label="描述" min-width="200" show-overflow-tooltip>
                                                                    <template slot-scope="scope">
                                                                        <div v-if="scope.row.isEditing">
                                                                            <el-input 
                                                                                v-model="scope.row.description" 
                                                                                size="mini" 
                                                                                placeholder="请输入描述"
                                                                                @blur="saveIndicatorRow(scope.row)">
                                                                            </el-input>
                                                                        </div>
                                                                        <div v-else>
                                                                            {{ scope.row.description }}
                                                                        </div>
                                                                    </template>
                                                                </el-table-column>
                                                                                                                                 <el-table-column label="操作" width="120" fixed="right">
                                                                     <template slot-scope="scope">
                                                                         <div v-if="scope.row.isEditing">
                                                                             <el-button 
                                                                                 type="text" 
                                                                                 size="mini" 
                                                                                 @click="saveIndicatorRow(scope.row)"
                                                                                 style="padding: 0; margin-right: 8px;">
                                                                                 <i class="el-icon-check" style="color: #67C23A; font-size: 16px;"></i>
                                                                             </el-button>
                                                                             <el-button 
                                                                                 type="text" 
                                                                                 size="mini" 
                                                                                 @click="cancelIndicatorEdit(scope.row)"
                                                                                 style="padding: 0; margin-right: 8px;">
                                                                                 <i class="el-icon-close" style="color: #F56C6C; font-size: 16px;"></i>
                                                                             </el-button>
                                                                         </div>
                                                                         <div v-else>
                                                                             <el-button 
                                                                                 type="text" 
                                                                                 size="mini" 
                                                                                 @click="enterIndicatorEditMode(scope.row)"
                                                                                 style="padding: 0; margin-right: 8px;">
                                                                                 <i class="el-icon-edit" style="color: #409EFF; font-size: 16px;"></i>
                                                                             </el-button>
                                                                             <el-button 
                                                                                 type="text" 
                                                                                 size="mini" 
                                                                                 @click="configureIndicator(scope.row)"
                                                                                 style="padding: 0; margin-right: 8px;">
                                                                                 <i class="el-icon-setting" style="color: #409EFF; font-size: 16px;"></i>
                                                                             </el-button>
                                                                         </div>
                                                                    </template>
                                                                </el-table-column>
                                                            </el-table>
                                                        </div>
                                                        
                                                        <!-- 分页 -->
                                                        <div class="pagination-container" v-if="filteredIndicators.length > 0">
                                                            <el-pagination
                                                                @size-change="handleIndicatorSizeChange"
                                                                @current-change="handleIndicatorCurrentChange"
                                                                :current-page="indicatorPagination.currentPage"
                                                                :page-sizes="[10, 20, 50, 100]"
                                                                :page-size="indicatorPagination.pageSize"
                                                                layout="total, sizes, prev, pager, next, jumper"
                                                                :total="filteredIndicators.length">
                                                            </el-pagination>
                                                        </div>
                                                        
                                                        <!-- 空状态 -->
                                                        <div class="empty-state" v-if="filteredIndicators.length === 0">
                                                            <div class="empty-icon">📊</div>
                                                            <div class="empty-text">暂无指标数据</div>
                                                            <div class="empty-actions">
                                                                <el-button type="primary" @click="addIndicator">新增指标</el-button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </el-tab-pane>
                                            <el-tab-pane :label="eventRulesTabLabel" name="eventRules">
                                                <div class="tab-content">
                                                    <div v-if="selectedAssetType && selectedAssetType.eventRules">
                                                        <!-- 事件规则操作按钮 -->
                                                        <div style="margin-bottom: 16px; display: flex; justify-content: flex-end; gap: 8px;">
                                                            <el-button 
                                                                v-if="!isViewingAsset"
                                                                size="small" 
                                                                type="primary" 
                                                                icon="el-icon-plus"
                                                                @click="addEventRule">
                                                                新增事件规则
                                                            </el-button>
                                                            <el-button 
                                                                v-if="!isViewingAsset"
                                                                size="small" 
                                                                type="danger" 
                                                                icon="el-icon-delete"
                                                                @click="batchDeleteEventRules"
                                                                :disabled="selectedEventRules.length === 0">
                                                                批量删除 ({{ selectedEventRules.length }})
                                                            </el-button>
                                                        </div>

                                                        <!-- 事件规则表格 -->
                                                        <div class="event-rules-table">
                                                            <el-table 
                                                                :data="selectedAssetType.eventRules" 
                                                                size="small" 
                                                                stripe
                                                                @selection-change="handleEventRuleSelectionChange"
                                                                :row-class-name="getEventRuleRowClassName"
                                                                style="width: 100%;">
                                                                <el-table-column type="selection" width="55"></el-table-column>
                                                                <el-table-column prop="name" label="规则名称" min-width="150">
                                                                    <template slot-scope="scope">
                                                                        <div v-if="!scope.row.isEditing">
                                                                            {{ scope.row.name }}
                                                                        </div>
                                                                        <el-input 
                                                                            v-else 
                                                                            v-model="scope.row.name" 
                                                                            size="small"
                                                                            placeholder="请输入规则名称">
                                                                        </el-input>
                                                                    </template>
                                                                </el-table-column>
                                                                <el-table-column prop="code" label="规则编码" min-width="120">
                                                                    <template slot-scope="scope">
                                                                        <div v-if="!scope.row.isEditing">
                                                                            {{ scope.row.code }}
                                                                        </div>
                                                                        <el-input 
                                                                            v-else 
                                                                            v-model="scope.row.code" 
                                                                            size="small"
                                                                            placeholder="请输入规则编码">
                                                                        </el-input>
                                                                    </template>
                                                                </el-table-column>
                                                                <el-table-column prop="category" label="分类" min-width="100">
                                                                    <template slot-scope="scope">
                                                                        <div v-if="!scope.row.isEditing">
                                                                            <el-tag size="small" :type="getEventRuleCategoryTagType(scope.row.category)">
                                                                                {{ scope.row.category }}
                                                                            </el-tag>
                                                                        </div>
                                                                        <el-select 
                                                                            v-else 
                                                                            v-model="scope.row.category" 
                                                                            size="small"
                                                                            placeholder="请选择分类"
                                                                            style="width: 100%;">
                                                                            <el-option label="安全告警" value="安全告警"></el-option>
                                                                            <el-option label="运行监控" value="运行监控"></el-option>
                                                                            <el-option label="状态监控" value="状态监控"></el-option>
                                                                            <el-option label="库存告警" value="库存告警"></el-option>
                                                                            <el-option label="安全监控" value="安全监控"></el-option>
                                                                            <el-option label="质量监控" value="质量监控"></el-option>
                                                                            <el-option label="能耗监控" value="能耗监控"></el-option>
                                                                        </el-select>
                                                                    </template>
                                                                </el-table-column>
                                                                <el-table-column prop="severity" label="严重程度" min-width="100">
                                                                    <template slot-scope="scope">
                                                                        <div v-if="!scope.row.isEditing">
                                                                            <el-tag size="small" :type="getEventRuleSeverityTagType(scope.row.severity)">
                                                                                {{ getEventRuleSeverityLabel(scope.row.severity) }}
                                                                            </el-tag>
                                                                        </div>
                                                                        <el-select 
                                                                            v-else 
                                                                            v-model="scope.row.severity" 
                                                                            size="small"
                                                                            placeholder="请选择严重程度"
                                                                            style="width: 100%;">
                                                                            <el-option label="高" value="high"></el-option>
                                                                            <el-option label="中" value="medium"></el-option>
                                                                            <el-option label="低" value="low"></el-option>
                                                                        </el-select>
                                                                    </template>
                                                                </el-table-column>
                                                                <el-table-column prop="enabled" label="启停" min-width="80" fixed="right">
                                                                    <template slot-scope="scope">
                                                                        <el-switch 
                                                                            v-model="scope.row.enabled"
                                                                           
                                                                            @change="toggleEventRuleStatus(scope.row)">
                                                                        </el-switch>
                                                                    </template>
                                                                </el-table-column>
                                                                <el-table-column prop="description" label="描述" min-width="200" show-overflow-tooltip>
                                                                    <template slot-scope="scope">
                                                                        <div v-if="!scope.row.isEditing">
                                                                            {{ scope.row.description }}
                                                                        </div>
                                                                        <el-input 
                                                                            v-else 
                                                                            v-model="scope.row.description" 
                                                                            size="small"
                                                                            type="textarea"
                                                                            :rows="2"
                                                                            placeholder="请输入规则描述">
                                                                        </el-input>
                                                                    </template>
                                                                </el-table-column>
                                                                <el-table-column prop="triggerCondition" label="触发条件" min-width="200" show-overflow-tooltip>
                                                                    <template slot-scope="scope">
                                                                        <div v-if="!scope.row.isEditing">
                                                                            {{ scope.row.triggerCondition }}
                                                                        </div>
                                                                        <el-input 
                                                                            v-else 
                                                                            v-model="scope.row.triggerCondition" 
                                                                            size="small"
                                                                            type="textarea"
                                                                            :rows="2"
                                                                            placeholder="请输入触发条件">
                                                                        </el-input>
                                                                    </template>
                                                                </el-table-column>
                                                                <el-table-column prop="actions" label="执行动作" min-width="150" show-overflow-tooltip>
                                                                    <template slot-scope="scope">
                                                                        <div v-if="!scope.row.isEditing">
                                                                            <el-tag 
                                                                                v-for="action in scope.row.actions" 
                                                                                :key="action"
                                                                                size="small" 
                                                                                style="margin-right: 4px; margin-bottom: 4px;">
                                                                                {{ action }}
                                                                            </el-tag>
                                                                        </div>
                                                                        <el-select 
                                                                            v-else 
                                                                            v-model="scope.row.actions" 
                                                                            size="small"
                                                                            multiple
                                                                            placeholder="请选择执行动作"
                                                                            style="width: 100%;">
                                                                            <el-option label="发送告警" value="发送告警"></el-option>
                                                                            <el-option label="发送通知" value="发送通知"></el-option>
                                                                            <el-option label="记录日志" value="记录日志"></el-option>
                                                                            <el-option label="更新状态" value="更新状态"></el-option>
                                                                            <el-option label="自动降温" value="自动降温"></el-option>
                                                                            <el-option label="停止设备" value="停止设备"></el-option>
                                                                            <el-option label="启动备用设备" value="启动备用设备"></el-option>
                                                                        </el-select>
                                                                    </template>
                                                                </el-table-column>
                                                                <el-table-column label="操作" width="240" fixed="right">
                                                                    <template slot-scope="scope">
                                                                        <div v-if="!scope.row.isEditing">
                                                                            <el-button 
                                                                                v-if="!isViewingAsset"
                                                                                type="text" 
                                                                                size="small" 
                                                                                icon="el-icon-edit"
                                                                                @click="enterEventRuleEditMode(scope.row)"
                                                                                title="编辑">
                                                                            </el-button>
                                                                            <el-button 
                                                                                v-if="!isViewingAsset"
                                                                                type="text" 
                                                                                size="small" 
                                                                                icon="el-icon-setting"
                                                                                @click="showEventRuleConfig(scope.row)"
                                                                                title="配置">
                                                                            </el-button>
                                                                            <el-button 
                                                                                v-if="!isViewingAsset"
                                                                                type="text" 
                                                                                size="small" 
                                                                                :icon="scope.row.enabled ? 'el-icon-close' : 'el-icon-check'"
                                                                                :style="{ color: scope.row.enabled ? '#F56C6C' : '#67C23A' }"
                                                                                @click="toggleEventRuleStatus(scope.row)"
                                                                                :title="scope.row.enabled ? '停用' : '启用'">
                                                                            </el-button>

                                                                        </div>
                                                                        <div v-else>
                                                                            <el-button 
                                                                                type="text" 
                                                                                size="small" 
                                                                                icon="el-icon-check"
                                                                                @click="saveEventRuleEdit(scope.row)"
                                                                                title="保存">
                                                                            </el-button>
                                                                            <el-button 
                                                                                type="text" 
                                                                                size="small" 
                                                                                icon="el-icon-close"
                                                                                @click="cancelEventRuleEdit(scope.row)"
                                                                                title="取消">
                                                                            </el-button>
                                                                        </div>
                                                                    </template>
                                                                </el-table-column>
                                                            </el-table>
                                                        </div>
                                                    </div>
                                                    <div v-else>
                                                        <el-empty description="请先选择资产类型"></el-empty>
                                                    </div>
                                                </div>
                                            </el-tab-pane>
                                            <el-tab-pane name="alarms">
                                                <template slot="label">
                                                    <span>告警</span>
                                                    <el-badge 
                                                        v-if="unhandledAlarmsCount > 0" 
                                                        :value="unhandledAlarmsCount" 
                                                        class="alarm-badge">
                                                    </el-badge>
                                                </template>
                                                <div class="tab-content">
                                                    <div v-if="selectedAssetType && selectedAssetType.alarms">
                                                        <!-- 告警检索区域 -->
                                                        <div style="margin-bottom: 16px;">
                                                            <el-form :inline="true" size="small">
                                                                <el-form-item label="关键词">
                                                                    <el-input 
                                                                        v-model="alarmSearchKeyword" 
                                                                        placeholder="请输入告警类型或描述关键词"
                                                                        style="width: 200px;">
                                                                        <i slot="prefix" class="el-input__icon el-icon-search"></i>
                                                                    </el-input>
                                                                </el-form-item>
                                                                <el-form-item label="告警级别">
                                                                    <el-select v-model="alarmSearchLevel" placeholder="全部" style="width: 120px;">
                                                                        <el-option label="全部" value=""></el-option>
                                                                        <el-option label="高" value="high"></el-option>
                                                                        <el-option label="中" value="medium"></el-option>
                                                                        <el-option label="低" value="low"></el-option>
                                                                    </el-select>
                                                                </el-form-item>
                                                                <el-form-item label="处理状态">
                                                                    <el-select v-model="alarmSearchStatus" placeholder="请选择" style="width: 120px;">
                                                                        <el-option label="未处理" value="unhandled"></el-option>
                                                                        <el-option label="已处理" value="handled"></el-option>
                                                                        <el-option label="全部" value="all"></el-option>
                                                                    </el-select>
                                                                </el-form-item>
                                                                <el-form-item label="时间范围">
                                                                    <el-select v-model="alarmSearchTimeRange" placeholder="请选择" style="width: 120px;">
                                                                        <el-option label="近1天" value="1day"></el-option>
                                                                        <el-option label="近3天" value="3days"></el-option>
                                                                        <el-option label="近7天" value="7days"></el-option>
                                                                        <el-option label="近30天" value="30days"></el-option>
                                                                        <el-option label="全部" value="all"></el-option>
                                                                    </el-select>
                                                                </el-form-item>
                                                                <el-form-item>
                                                                    <el-button type="primary" @click="searchAlarms" icon="el-icon-search">检索</el-button>
                                                                    <el-button @click="clearAlarmSearch" icon="el-icon-refresh">清空</el-button>
                                                                </el-form-item>
                                                            </el-form>
                                                        </div>

                                                        <!-- 告警操作按钮 -->
                                                        <!-- <div style="margin-bottom: 16px; display: flex; justify-content: flex-end;">
                                                            <el-button 
                                                                size="small" 
                                                                type="primary" 
                                                                icon="el-icon-refresh"
                                                                @click="refreshAlarms">
                                                                刷新告警
                                                            </el-button>
                                                        </div> -->

                                                        <!-- 告警表格 -->
                                                        <div class="alarms-table">
                                                            <el-table 
                                                                :data="filteredAlarms" 
                                                                size="small" 
                                                                stripe
                                                                style="width: 100%;">
                                                                <el-table-column prop="level" label="告警级别" width="100">
                                                                    <template slot-scope="scope">
                                                                        <el-tag size="small" :type="getAlarmLevelTagType(scope.row.level)">
                                                                            {{ getAlarmLevelLabel(scope.row.level) }}
                                                                        </el-tag>
                                                                    </template>
                                                                </el-table-column>
                                                                <el-table-column prop="type" label="告警类型" min-width="120"></el-table-column>
                                                                <el-table-column prop="description" label="告警描述" min-width="200" show-overflow-tooltip></el-table-column>
                                                                <el-table-column prop="alarmTime" label="告警时间" width="160"></el-table-column>
                                                                <el-table-column prop="triggerRule" label="触发规则" min-width="120"></el-table-column>
                                                                <el-table-column prop="isHandled" label="处理状态" width="100">
                                                                    <template slot-scope="scope">
                                                                        <el-tag size="small" :type="scope.row.isHandled ? 'success' : 'danger'">
                                                                            {{ scope.row.isHandled ? '已处理' : '未处理' }}
                                                                        </el-tag>
                                                                    </template>
                                                                </el-table-column>
                                                                <el-table-column prop="handler" label="处理人" width="100">
                                                                    <template slot-scope="scope">
                                                                        <span v-if="scope.row.handler">{{ scope.row.handler }}</span>
                                                                        <span v-else style="color: #909399;">-</span>
                                                                    </template>
                                                                </el-table-column>
                                                                <el-table-column label="操作" width="280" fixed="right">
                                                                    <template slot-scope="scope">
                                                                        <el-button 
                                                                            type="text" 
                                                                            size="small" 
                                                                            icon="el-icon-info"
                                                                            @click="viewAlarmDetail(scope.row)"
                                                                            title="查看详情">
                                                                        </el-button>
                                                                        <el-button 
                                                                            v-if="!scope.row.isHandled"
                                                                            type="text" 
                                                                            size="small" 
                                                                            icon="el-icon-check"
                                                                            @click="handleAlarm(scope.row)"
                                                                            title="处理">
                                                                        </el-button>
                                                                        <el-button 
                                                                            v-if="!scope.row.isHandled"
                                                                            type="text" 
                                                                            size="small" 
                                                                            icon="el-icon-close"
                                                                            @click="ignoreAlarm(scope.row)"
                                                                            title="忽略">
                                                                        </el-button>
                                                                        <el-button 
                                                                            v-if="!scope.row.isHandled"
                                                                            type="text" 
                                                                            size="small" 
                                                                            icon="el-icon-warning"
                                                                            @click="markAsFalseAlarm(scope.row)"
                                                                            title="标记为误报">
                                                                        </el-button>
                                                                        <span v-if="scope.row.isHandled" style="color: #909399; font-size: 12px;">
                                                                            已处理
                                                                        </span>
                                                                    </template>
                                                                </el-table-column>
                                                            </el-table>
                                                        </div>
                                                    </div>
                                                    <div v-else>
                                                        <el-empty description="请先选择资产类型"></el-empty>
                                                    </div>
                                                </div>
                                            </el-tab-pane>
                                            <el-tab-pane name="video">
                                                <template slot="label">
                                                    <span>视频</span>
                                                </template>
                                                <div class="tab-content">
                                                    <div v-if="selectedAssetType">
                                                        <!-- 视频操作按钮 -->
                                                        <div style="margin-bottom: 16px;">
                                                            <el-button type="primary" size="small" icon="el-icon-plus" @click="addVideo">新增</el-button>
                                                            <el-button type="danger" size="small" icon="el-icon-delete" @click="deleteVideo" :disabled="selectedVideos.length === 0">删除</el-button>
                                                        </div>

                                                        <!-- 视频表格 -->
                                                        <div class="video-table">
                                                            <el-table 
                                                                :data="currentAssetTypeVideos" 
                                                                size="small" 
                                                                stripe
                                                                @selection-change="handleVideoSelectionChange"
                                                                style="width: 100%;">
                                                                <el-table-column type="selection" width="55"></el-table-column>
                                                                <!-- <el-table-column type="index" label="序号" width="60">
                                                                    <template slot-scope="scope">
                                                                        <div style="display: flex; align-items: center; gap: 4px;">
                                                                            <i class="el-icon-rank" style="cursor: move; color: #909399;"></i>
                                                                            <span>{{ scope.$index + 1 }}</span>
                                                                        </div>
                                                                    </template>
                                                                </el-table-column> -->
                                                                <el-table-column prop="cameraAddress" label="摄像头地址" min-width="200">
                                                                    <template slot-scope="scope">
                                                                        <el-input 
                                                                            v-model="scope.row.cameraAddress" 
                                                                            placeholder="请输入摄像头地址"
                                                                            size="small">
                                                                        </el-input>
                                                                    </template>
                                                                </el-table-column>
                                                                <el-table-column prop="cameraNumber" label="摄像头编号" min-width="150">
                                                                    <template slot-scope="scope">
                                                                        <el-input 
                                                                            v-model="scope.row.cameraNumber" 
                                                                            placeholder="请输入摄像头编号"
                                                                            size="small">
                                                                            <i slot="suffix" class="el-input__icon el-icon-search" style="cursor: pointer;" @click="openCameraList(scope.row)"></i>
                                                                        </el-input>
                                                                    </template>
                                                                </el-table-column>
                                                                <el-table-column prop="cameraName" label="摄像头名称" min-width="150">
                                                                    <template slot-scope="scope">
                                                                        <el-input 
                                                                            v-model="scope.row.cameraName" 
                                                                            placeholder="请输入摄像头名称"
                                                                            size="small">
                                                                        </el-input>
                                                                    </template>
                                                                </el-table-column>
                                                                <el-table-column label="操作" width="120">
                                                                    <template slot-scope="scope">
                                                                        <el-button 
                                                                            type="text" 
                                                                            size="small" 
                                                                            @click="configureVideo(scope.row)">
                                                                            画面配置
                                                                        </el-button>
                                                                    </template>
                                                                </el-table-column>
                                                            </el-table>
                                                        </div>
                                                    </div>
                                                    <div v-else>
                                                        <el-empty description="请先选择资产类型"></el-empty>
                                                    </div>
                                                </div>
                                            </el-tab-pane>
                                            <el-tab-pane label="备件清单" name="spareParts">
                                                <div class="tab-content">
                                                    <p>参考设备管理相关设计</p>
                                                </div>
                                            </el-tab-pane>
                                            <el-tab-pane label="技术文档" name="technicalDocs">
                                                <div class="tab-content">
                                                    <p>参考设备管理相关设计</p>
                                                </div>
                                            </el-tab-pane>
                                            <el-tab-pane label="安全监测" name="safetyMonitoring">
                                                <div class="tab-content">
                                                    <p>参考设备管理相关设计</p>
                                                </div>
                                            </el-tab-pane>
                                            <el-tab-pane label="标准作业书" name="standardOperatingProcedures">
                                                <div class="tab-content">
                                                    <p>参考设备管理相关设计</p>
                                                </div>
                                            </el-tab-pane>
                                            <el-tab-pane label="维护信息" name="maintenanceInfo">
                                                <div class="tab-content">
                                                    <p>参考设备管理相关设计</p>
                                                </div>
                                            </el-tab-pane>
                                        </el-tabs>
                                    </div>
                                </div>
                                
                                <!-- 正常资产列表 -->
                                <div v-else>
                                                                    <div class="section-header">
                                                                        <h3 class="section-title">资产列表</h3>
                                                                        <div class="section-actions">
                                                                            <!-- 添加资产按钮已移动到基本信息标题处 -->
                                                                        </div>
                                                                    </div>
                                    <!-- 搜索栏 -->
                                    <div v-if="selectedNode.assets && selectedNode.assets.length > 0" class="asset-search-bar">
                                        <div class="search-input-group">
                                            <el-select v-model="assetSearchField" size="small" style="width: 120px;">
                                                <el-option label="名称" value="name"></el-option>
                                                <el-option label="型号" value="model"></el-option>
                                                <el-option label="类别" value="category"></el-option>
                                                <el-option label="供应商" value="supplier"></el-option>
                                                <el-option label="制造商" value="manufacturer"></el-option>
                                                <el-option label="是否接入" value="isConnected"></el-option>
                                            </el-select>
                                            <el-input 
                                                v-model="assetSearchKeyword" 
                                                placeholder="请输入搜索关键词" 
                                                size="small"
                                                @input="searchAssets"
                                                style="width: 200px;">
                                                <i slot="prefix" class="el-input__icon el-icon-search"></i>
                                            </el-input>
                                            <el-button size="small" icon="el-icon-refresh" @click="clearAssetSearch" title="清空搜索"></el-button>
                                        </div>
                                        <div class="search-result-info">
                                            共找到 {{ filteredAssets.length }} 个资产
                                        </div>
                                    </div>
                                    
                                    <!-- 资产表格 -->
                                    <div v-if="selectedNode.assets && selectedNode.assets.length > 0" class="asset-table-container">
                                        <el-table 
                                            :data="filteredAssets" 
                                            size="small"
                                            stripe
                                            style="width: 100%">
                                            <el-table-column prop="name" label="名称" min-width="120" max-width="150">
                                                <template slot-scope="scope">
                                                    <div class="asset-name-cell">
                                                        <i :class="getAssetIconClass(scope.row.type)" class="asset-icon-small"></i>
                                                        <span>{{ scope.row.name }}</span>
                                                    </div>
                                                </template>
                                            </el-table-column>
                                            <el-table-column prop="code" label="编码" min-width="80" max-width="100"></el-table-column>
                                            <el-table-column prop="nodeLevel" label="层级" min-width="60" max-width="80">
                                                <template slot-scope="scope">
                                                    <el-tooltip :content="`点击定位到: ${scope.row.nodePath}`" placement="top">
                                                        <div style="display: flex; align-items: center; gap: 4px; cursor: pointer;" @click="locateToAssetNode(scope.row)">
                                                            <span>L{{ scope.row.nodeLevel }}</span>
                                                            <i class="el-icon-location" style="font-size: 12px; color: #409EFF;"></i>
                                                        </div>
                                                    </el-tooltip>
                                                </template>
                                            </el-table-column>
                                            <el-table-column prop="type" label="类型" min-width="60" max-width="80">
                                                <template slot-scope="scope">
                                                    {{ getAssetTypeName(scope.row.type) }}
                                                </template>
                                            </el-table-column>
                                            <el-table-column prop="model" label="型号" min-width="100" max-width="120"></el-table-column>
                                            <el-table-column prop="category" label="类别" min-width="80" max-width="100"></el-table-column>
                                            <el-table-column prop="supplier" label="供应商" min-width="120" max-width="180" show-overflow-tooltip></el-table-column>
                                            <el-table-column prop="manufacturer" label="制造商" min-width="120" max-width="180" show-overflow-tooltip></el-table-column>
                                            <el-table-column prop="installDate" label="安装日期" min-width="90" max-width="110"></el-table-column>
                                            <el-table-column prop="status" label="运行状态" min-width="70" max-width="90">
                                                <template slot-scope="scope">
                                                    <span v-if="scope.row.isConnected">
                                                        <el-tag :type="scope.row.status === '运行中' ? 'success' : 'warning'" size="mini">
                                                            {{ scope.row.status }}
                                                        </el-tag>
                                                    </span>
                                                    <span v-else>-</span>
                                                </template>
                                            </el-table-column>
                                            <el-table-column prop="isConnected" label="接入状态" min-width="80" max-width="100">
                                                <template slot-scope="scope">
                                                    <el-tag :type="scope.row.isConnected ? 'success' : 'info'" size="mini">
                                                        {{ scope.row.isConnected ? '已接入' : '未接入' }}
                                                    </el-tag>
                                                </template>
                                            </el-table-column>
                                            <el-table-column label="操作" min-width="100" max-width="120">
                                                <template slot-scope="scope">
                                                    <el-button type="text" size="mini" icon="el-icon-info" title="查看详情" @click="viewAsset(scope.row)"></el-button>
                                                    <el-button v-if="isEditMode" type="text" size="mini" icon="el-icon-edit" title="编辑" @click="editAsset(scope.row)"></el-button>
                                                    <el-button v-if="isEditMode" type="text" size="mini" icon="el-icon-delete" title="删除" style="color: #f56c6c;" @click="deleteAsset(scope.row)"></el-button>
                                                </template>
                                            </el-table-column>
                                        </el-table>
                                    </div>
                                    
                                    <!-- 空状态 -->
                                    <div v-else class="empty-assets">
                                        <div class="empty-assets-icon">📦</div>
                                        <div class="empty-assets-text">该节点暂无资产</div>
                                        <!-- 添加资产按钮已移动到基本信息标题处 -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 子节点列表 -->
                            <!-- <div v-if="selectedNode.children && selectedNode.children.length > 0" class="detail-section">
                                <h3 class="section-title">子节点列表</h3>
                                <div class="child-nodes-list">
                                    <div v-for="child in selectedNode.children" :key="child.id" class="child-node-item">
                                        <div class="child-node-icon">
                                            <i :class="getNodeIconClass(child.type)"></i>
                                        </div>
                                        <div class="child-node-info">
                                            <div class="child-node-name">{{ child.name }}</div>
                                            <div class="child-node-meta">
                                                <span class="child-node-type">{{ child.type }}</span>
                                                <span class="child-node-assets">({{ child.assets ? child.assets.length : 0 }}个资产)</span>
                                            </div>
                                        </div>
                                        <div class="child-node-actions">
                                            <el-button type="text" size="mini" icon="el-icon-info" title="查看详情" @click="selectNode(child)"></el-button>
                                            <el-button v-if="isEditMode" type="text" size="mini" icon="el-icon-edit" title="编辑" @click="editNode(child)"></el-button>
                                        </div>
                                    </div>
                                </div>
                            </div> -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 节点编辑对话框 -->
        <el-dialog 
            :title="nodeDialogTitle" 
            :visible.sync="nodeDialogVisible" 
            width="500px"
            @close="resetNodeForm">
            <el-form :model="nodeForm" :rules="nodeDialogMode === 'view' ? {} : nodeFormRules" ref="nodeForm" label-width="120px">
                <el-form-item label="节点名称" prop="name">
                    <el-input v-model="nodeForm.name" placeholder="请输入节点名称" :disabled="nodeDialogMode === 'view'"></el-input>
                </el-form-item>
                <el-form-item label="节点编码" prop="code">
                    <el-input v-model="nodeForm.code" placeholder="请输入节点编码" :disabled="nodeDialogMode === 'view'"></el-input>
                </el-form-item>
                <el-form-item label="节点类型" prop="type">
                    <el-select v-model="nodeForm.type" placeholder="请选择节点类型" style="width: 100%" :disabled="nodeDialogMode === 'view'">
                        <el-option 
                            v-for="type in availableNodeTypes" 
                            :key="type.value" 
                            :label="type.label" 
                            :value="type.value">
                        </el-option>
                    </el-select>
                </el-form-item>
                <el-form-item label="资产类型">
                    <el-input v-model="currentAssetType" placeholder="无" disabled></el-input>
                </el-form-item>
                <el-form-item label="允许子节点类型">
                    <el-input v-model="currentAllowedChildTypes" placeholder="无" disabled></el-input>
                </el-form-item>
                <el-form-item label="描述">
                    <el-input 
                        type="textarea" 
                        v-model="nodeForm.description" 
                        placeholder="请输入节点描述"
                        :rows="3"
                        :disabled="nodeDialogMode === 'view'">
                    </el-input>
                </el-form-item>
            </el-form>
            <div slot="footer" class="dialog-footer">
                <el-button @click="nodeDialogVisible = false">{{ nodeDialogMode === 'view' ? '关闭' : '取消' }}</el-button>
                <el-button v-if="nodeDialogMode !== 'view'" type="primary" @click="saveNode">确定</el-button>
            </div>
        </el-dialog>

        <!-- 资产导出对话框 -->
        <el-dialog
            title="导出资产"
            :visible.sync="exportAssetsDialogVisible"
            width="400px"
            :close-on-click-modal="false">
            <div class="export-dialog-content">
                <p>确定要导出当前工厂模型下的所有资产吗？</p>
                <div class="export-format-selection">
                    <label>选择导出格式：</label>
                    <el-radio-group v-model="exportFormat">
                        <el-radio label="excel">Excel</el-radio>
                        <el-radio label="json">JSON</el-radio>
                    </el-radio-group>
                </div>
            </div>
            <div slot="footer" class="dialog-footer">
                <el-button @click="exportAssetsDialogVisible = false">取消</el-button>
                <el-button type="primary" @click="confirmExportAssets">确定导出</el-button>
            </div>
        </el-dialog>

        <!-- 告警详情抽屉 -->
        <el-drawer
            title="告警详情"
            :visible.sync="alarmDetailDrawerVisible"
            direction="btt"
            size="80%">
            <div style="padding: 20px;">
                <div class="alarm-detail" v-if="currentAlarm">
                    <!-- 基本信息 -->
                    <el-card style="margin-bottom: 20px;">
                        <div slot="header">
                            <span>基本信息</span>
                        </div>
                        <el-descriptions :column="2" border>
                            <el-descriptions-item label="告警级别">
                                <el-tag :type="getAlarmLevelTagType(currentAlarm.level)">
                                    {{ getAlarmLevelLabel(currentAlarm.level) }}
                                </el-tag>
                            </el-descriptions-item>
                            <el-descriptions-item label="告警类型">
                                {{ currentAlarm.type }}
                            </el-descriptions-item>
                            <el-descriptions-item label="告警时间">
                                {{ currentAlarm.alarmTime }}
                            </el-descriptions-item>
                            <el-descriptions-item label="处理状态">
                                <el-tag :type="currentAlarm.isHandled ? 'success' : 'danger'">
                                    {{ currentAlarm.isHandled ? '已处理' : '未处理' }}
                                </el-tag>
                            </el-descriptions-item>
                            <el-descriptions-item label="处理人">
                                {{ currentAlarm.handler || '-' }}
                            </el-descriptions-item>
                            <el-descriptions-item label="处理时间">
                                {{ currentAlarm.handleTime || '-' }}
                            </el-descriptions-item>
                            <el-descriptions-item label="处理备注" :span="2">
                                {{ currentAlarm.handleNote || '-' }}
                            </el-descriptions-item>
                            <el-descriptions-item label="告警描述" :span="2">
                                {{ currentAlarm.description }}
                            </el-descriptions-item>
                        </el-descriptions>
                    </el-card>

                    <!-- 触发规则信息 -->
                    <el-card style="margin-bottom: 20px;">
                        <div slot="header">
                            <span>触发规则信息</span>
                        </div>
                        <el-descriptions :column="1" border>
                            <el-descriptions-item label="规则名称">
                                {{ currentAlarm.triggerRuleName }}
                            </el-descriptions-item>
                            <el-descriptions-item label="触发表达式">
                                <el-tag type="info" style="font-family: 'Courier New', monospace;">
                                    {{ currentAlarm.triggerExpression }}
                                </el-tag>
                            </el-descriptions-item>
                        </el-descriptions>
                    </el-card>

                    <!-- 涉及数据项 -->
                    <el-card style="margin-bottom: 20px;">
                        <div slot="header">
                            <span>涉及数据项</span>
                        </div>
                        <el-table 
                            :data="currentAlarm.dataItems" 
                            size="small" 
                            border
                            style="width: 100%;">
                            <el-table-column prop="name" label="数据项名称" min-width="150"></el-table-column>
                            <el-table-column prop="value" label="当前值" min-width="120">
                                <template slot-scope="scope">
                                    <el-tag type="warning">{{ scope.row.value }}</el-tag>
                                </template>
                            </el-table-column>
                            <el-table-column prop="dataSource" label="数据源" min-width="200">
                                <template slot-scope="scope">
                                    <el-tag type="info" size="small">{{ scope.row.dataSource }}</el-tag>
                                </template>
                            </el-table-column>
                        </el-table>
                    </el-card>
                    
                    <!-- 操作按钮 -->
                    <el-card style="margin-bottom: 20px;">
                        <div slot="header">
                            <span>操作</span>
                        </div>
                        <div style="text-align: right;">
                            <el-button 
                                v-if="!currentAlarm.isHandled"
                                type="primary" 
                                icon="el-icon-check"
                                @click="handleAlarm(currentAlarm)">
                                处理
                            </el-button>
                            <el-button 
                                v-if="!currentAlarm.isHandled"
                                type="warning" 
                                icon="el-icon-close"
                                @click="ignoreAlarm(currentAlarm)">
                                忽略
                            </el-button>
                            <el-button 
                                v-if="!currentAlarm.isHandled"
                                type="danger" 
                                icon="el-icon-warning"
                                @click="markAsFalseAlarm(currentAlarm)">
                                标记为误报
                            </el-button>
                            <el-button @click="alarmDetailDrawerVisible = false">关闭</el-button>
                        </div>
                    </el-card>
                </div>
            </div>
        </el-drawer>

        <!-- 事件规则配置抽屉 -->
        <el-drawer
            title="事件规则配置"
            :visible.sync="eventRuleConfigDrawerVisible"
            direction="btt"
            size="80%">
            <div style="padding: 20px;">
                <div class="event-rule-config">
                    <div style="text-align: center; padding: 40px 0;">
                        <h3 style="color: #606266; margin-bottom: 20px;">复用资产类型中的规则定义中的编辑配置页面，所能选数据是当前资产及子节点资产中的采集参数、业务属性、指标</h3>
                        <!-- <p style="color: #909399; font-size: 14px;">这里将集成资产类型管理中的事件规则配置功能</p> -->
                        <div v-if="currentConfigEventRule" style="margin-top: 20px; padding: 16px; background-color: #f5f7fa; border-radius: 4px;">
                            <h4 style="color: #303133; margin-bottom: 10px;">当前配置规则：{{ currentConfigEventRule.name }}</h4>
                            <p style="color: #606266; margin: 5px 0;">编码：{{ currentConfigEventRule.code }}</p>
                            <p style="color: #606266; margin: 5px 0;">分类：{{ currentConfigEventRule.category }}</p>
                            <p style="color: #606266; margin: 5px 0;">描述：{{ currentConfigEventRule.description }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </el-drawer>

        <!-- 数据点位批量新增抽屉 -->
        <el-drawer
            title="数据点位批量新增"
            :visible.sync="dataPointBatchAddDrawerVisible"
            direction="btt"
            size="80%">
            <div style="padding: 20px;">
                <div class="data-point-batch-add">
                    <!-- 搜索区域 -->
                    <div class="search-section">
                        <!-- <h4>数据点位选择</h4> -->
                        <div class="search-form">
                            <el-form>
                                <el-row :gutter="16" align="bottom">
                                    <el-col :span="5">
                                        <el-form-item label="搜索关键词">
                                            <el-input 
                                                v-model="dataPointSearchKeyword" 
                                                placeholder="请输入数据点位名称或编码">
                                                <i slot="prefix" class="el-input__icon el-icon-search"></i>
                                            </el-input>
                                        </el-form-item>
                                    </el-col>
                                    <el-col :span="4">
                                        <el-form-item label="数据源">
                                            <el-select v-model="dataPointSearchDataSource" placeholder="全部" style="width: 100%;">
                                                <el-option label="全部" value=""></el-option>
                                                <el-option label="DCS系统" value="DCS"></el-option>
                                                <el-option label="SCADA系统" value="SCADA"></el-option>
                                                <el-option label="PLC系统" value="PLC"></el-option>
                                                <el-option label="RTU设备" value="RTU"></el-option>
                                                <el-option label="OPC服务器" value="OPC"></el-option>
                                                <el-option label="Modbus设备" value="MODBUS"></el-option>
                                            </el-select>
                                        </el-form-item>
                                    </el-col>
                                    <el-col :span="4">
                                        <el-form-item label="数据类型">
                                            <el-select v-model="dataPointSearchType" placeholder="全部" style="width: 100%;">
                                                <el-option label="全部" value=""></el-option>
                                                <el-option label="数值" value="Float"></el-option>
                                                <el-option label="整数" value="Int"></el-option>
                                                <el-option label="字符串" value="String"></el-option>
                                                <el-option label="布尔值" value="Boolean"></el-option>
                                                <el-option label="枚举" value="Enum"></el-option>
                                            </el-select>
                                        </el-form-item>
                                    </el-col>
                                    <el-col :span="4">
                                        <el-form-item>
                                            <el-button type="primary" @click="searchDataPoints" size="small" icon="el-icon-search">检索</el-button>
                                            <el-button @click="clearDataPointSearch" size="small">清空</el-button>
                                        </el-form-item>
                                    </el-col>
                                </el-row>
                            </el-form>
                        </div>
                    </div>

                    <!-- 数据点位列表 -->
                    <div class="data-point-list">
                        <div class="list-header">
                            <span>已选择 {{ selectedDataPoints.length }} 个数据点位</span>
                            <el-button 
                                v-if="selectedDataPoints.length > 0"
                                type="text" 
                                size="small" 
                                @click="clearSelectedDataPoints">
                                清空选择
                            </el-button>
                        </div>
                        <el-table 
                            ref="dataPointTable"
                            :data="filteredDataPoints" 
                            size="small" 
                            stripe
                            @selection-change="handleDataPointSelectionChange"
                            style="width: 100%;">
                            <el-table-column type="selection" width="55"></el-table-column>
                            <el-table-column prop="name" label="数据点位名称" min-width="150"></el-table-column>
                            <el-table-column prop="code" label="数据点位编码" min-width="150"></el-table-column>
                            <el-table-column prop="dataSource" label="数据源" min-width="120">
                                <template slot-scope="scope">
                                    <el-tag size="small" :type="getDataSourceTagType(scope.row.dataSource)">
                                        {{ getDataSourceLabel(scope.row.dataSource) }}
                                    </el-tag>
                                </template>
                            </el-table-column>
                            <el-table-column prop="dataType" label="数据类型" min-width="80">
                                <template slot-scope="scope">
                                    <el-tag size="small" :type="getDataTypeTagType(scope.row.dataType)">
                                        {{ getDataTypeLabel(scope.row.dataType) }}
                                    </el-tag>
                                </template>
                            </el-table-column>
                            <el-table-column prop="unit" label="单位" min-width="80"></el-table-column>
                            <el-table-column prop="description" label="描述" min-width="200" show-overflow-tooltip></el-table-column>
                        </el-table>
                    </div>

                    <!-- 操作按钮 -->
                    <div class="drawer-footer" style="margin-top: 20px; text-align: center;">
                        <el-button @click="dataPointBatchAddDrawerVisible = false">取消</el-button>
                        <el-button 
                            type="primary" 
                            @click="confirmBatchAddDataPoints"
                            :disabled="selectedDataPoints.length === 0">
                            确认批量新增 ({{ selectedDataPoints.length }})
                        </el-button>
                    </div>
                </div>
            </div>
        </el-drawer>

        <!-- 数据绑定配置抽屉 -->
    <el-drawer
        title="数据绑定配置"
        :visible.sync="dataBindingDrawerVisible"
        direction="btt"
        size="80%">
        <div style="padding: 20px;">
            <div class="data-binding-config">
                <!-- 左右并排布局 -->
                <el-row :gutter="20" class="data-binding-layout">
                    <!-- 左侧：搜索区域 + 数据点位列表 -->
                    <el-col :span="16" class="left-panel">
                        <!-- 搜索区域 -->
                        <div class="search-section">
                            <h4>数据点位选择</h4>
                            <div class="search-form">
                                <el-form>
                                    <el-row :gutter="16" align="bottom">
                                        <el-col :span="6">
                                            <el-form-item label="数据源">
                                                <el-select v-model="configType === 'businessPropertyBinding' ? businessPropertyDataBindingForm.dataSource : dataBindingForm.dataSource" placeholder="请选择数据源" style="width: 100%">
                                                    <el-option 
                                                        v-for="source in dataSources" 
                                                        :key="source.value" 
                                                        :label="source.label" 
                                                        :value="source.value">
                                                    </el-option>
                                                </el-select>
                                            </el-form-item>
                                        </el-col>
                                        <el-col :span="6">
                                            <el-form-item label="数据点位名称">
                                                <el-input 
                                                    v-model="configType === 'businessPropertyBinding' ? businessPropertyDataBindingForm.pointName : dataBindingForm.pointName" 
                                                    placeholder="请输入数据点位名称"
                                                    clearable>
                                                </el-input>
                                            </el-form-item>
                                        </el-col>
                                        <el-col :span="6">
                                            <el-form-item label="编码">
                                                <el-input 
                                                    v-model="configType === 'businessPropertyBinding' ? businessPropertyDataBindingForm.pointCode : dataBindingForm.pointCode" 
                                                    placeholder="请输入数据点位编码"
                                                    clearable>
                                                </el-input>
                                            </el-form-item>
                                        </el-col>
                                        <el-col :span="6">
                                            <el-form-item>
                                                <el-button type="primary" @click="searchDataPoints">搜索</el-button>
                                                <el-button @click="clearDataPointSearch">清空</el-button>
                                            </el-form-item>
                                        </el-col>
                                    </el-row>
                                </el-form>
                            </div>
                        </div>

                        <!-- 数据点位列表 -->
                        <div class="data-points-section">
                            <!-- <h4>可选数据点位</h4> -->
                            <el-table 
                                :data="filteredDataPoints || []" 
                                style="width: 100%"
                                @selection-change="handleSelectionChange"
                                @row-click="toggleDataPointSelection">
                                <el-table-column type="selection" width="55"></el-table-column>
                                <el-table-column prop="name" label="数据点位名称" min-width="120"></el-table-column>
                                <el-table-column prop="code" label="编码" min-width="100"></el-table-column>
                                <el-table-column prop="dataSource" label="数据源" min-width="100"></el-table-column>
                                <el-table-column prop="dataType" label="数据类型" min-width="80"></el-table-column>
                                <el-table-column prop="unit" label="单位" min-width="60"></el-table-column>
                                <el-table-column prop="description" label="描述" min-width="120"></el-table-column>
                            </el-table>
                        </div>
                    </el-col>

                    <!-- 右侧：已选择的数据点位 + 计算公式配置 -->
                    <el-col :span="8" class="right-panel">
                        <!-- 已选择的数据点位 -->
                        <div class="selected-points-section" v-if="(configType === 'businessPropertyBinding' ? businessPropertyDataBindingForm.selectedPoints.length : dataBindingForm.selectedPoints.length) > 0">
                            <h4>已选择的数据点位 ({{ configType === 'businessPropertyBinding' ? businessPropertyDataBindingForm.selectedPoints.length : dataBindingForm.selectedPoints.length }})</h4>
                            <div class="selected-points-list">
                                <div 
                                    v-for="(point, index) in (configType === 'businessPropertyBinding' ? businessPropertyDataBindingForm.selectedPoints : dataBindingForm.selectedPoints)" 
                                    :key="point.code"
                                    class="selected-point-item"
                                    @dblclick="insertDataPoint(point)">
                                    <span class="point-source">[{{ point.dataSource }}].</span>
                                    <span class="point-name">{{ point.name }}</span>
                                    
                                    <span class="point-code">({{ point.code }})</span>
                                    <el-button 
                                        type="text" 
                                        size="mini" 
                                        @click="removeSelectedPoint(index)"
                                        class="remove-btn">
                                        <i class="el-icon-close"></i>
                                    </el-button>
                                </div>
                            </div>
                        </div>

                        <!-- 计算公式配置 -->
                        <div class="formula-section" v-if="dataBindingForm.selectedPoints.length > 0">
                            <h4>计算公式配置</h4>
                            <div class="formula-config">
                                <!-- 输入模式切换 -->
                                <div class="input-mode-tabs">
                                    <el-tabs v-model="formulaInputMode" @tab-click="handleInputModeChange">
                                        <el-tab-pane label="自然语言" name="natural">
                                            <div class="natural-language-input">
                                                <el-input
                                                    v-model="naturalLanguageInput"
                                                    type="textarea"
                                                    :rows="3"
                                                    placeholder="请用自然语言描述计算公式，例如：温度传感器1的值加上温度传感器2的值除以2">
                                                </el-input>
                                                <div class="ai-translation-actions">
                                                    <div class="ai-translation-status">
                                                        <span v-if="isTranslating" class="translating">
                                                            <i class="el-icon-loading"></i> AI正在翻译...
                                                        </span>
                                                        <span v-else-if="translatedExpression" class="translated">
                                                            <i class="el-icon-success"></i> 已转换为表达式
                                                        </span>
                                                    </div>
                                                    <el-button 
                                                        type="primary" 
                                                        size="small"
                                                        @click="handleNaturalLanguageInput"
                                                        :loading="isTranslating"
                                                        :disabled="!naturalLanguageInput.trim()">
                                                        <i class="el-icon-magic-stick"></i> AI转换
                                                    </el-button>
                                                </div>
                                            </div>
                                        </el-tab-pane>
                                        
                                        <el-tab-pane label="可视化输入" name="visual">
                                            <div class="visual-input">
                                                <div class="visual-formula-display">
                                                    <div class="formula-preview">
                                                        <div class="formula-blocks">
                                                            <div 
                                                                v-for="(part, index) in visualFormulaParts" 
                                                                :key="index"
                                                                class="formula-block"
                                                                @click="selectBlock(index)"
                                                                :class="{ 'selected': selectedBlockIndex === index }">
                                                                <span class="block-content">
                                                                    <span v-if="part.type === 'variable'">[{{ part.dataSource }}].[{{ part.name }}]</span>
                                                                    <span v-else>{{ part.value }}</span>
                                                                </span>
                                                                <el-button 
                                                                    type="text" 
                                                                    size="mini" 
                                                                    class="delete-btn"
                                                                    @click.stop="deleteBlock(index)">
                                                                    <i class="el-icon-close"></i>
                                                                </el-button>
                                                            </div>
                                                            <div class="insert-hint" v-if="visualFormulaParts.length === 0">
                                                                请双击变量或点击运算符来构建公式
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="formula-validation">
                                                    <el-button size="small" @click="validateFormula" type="primary">验证公式</el-button>
                                                </div>
                                                <div class="visual-input-tools">
                                                    <div class="variable-section">
                                                        <span class="section-title">变量：</span>
                                                        <div class="variable-list">
                                                            <span 
                                                                v-for="point in (configType === 'businessPropertyBinding' ? businessPropertyDataBindingForm.selectedPoints : dataBindingForm.selectedPoints)" 
                                                                :key="point.code"
                                                                class="variable-item"
                                                                @dblclick="insertVariable(point)">
                                                                {{ point.name }}
                                                            </span>
                                                        </div>
                                                    </div>
                                                    <div class="number-section">
                                                        <span class="section-title">数字：</span>
                                                        <div class="number-input">
                                                            <el-input
                                                                v-model="numberInput"
                                                                size="mini"
                                                                placeholder="输入数字"
                                                                style="width: 80px; margin-right: 8px;">
                                                            </el-input>
                                                            <el-button 
                                                                size="mini" 
                                                                type="primary"
                                                                @click="insertNumber">
                                                                添加
                                                            </el-button>
                                                        </div>
                                                    </div>
                                                </div>
                                               
                                            </div>
                                        </el-tab-pane>
                                        
                                        <el-tab-pane label="表达式输入" name="expression">
                                            <div class="expression-input">
                                                <el-input
                                                    v-model="configType === 'businessPropertyBinding' ? businessPropertyDataBindingForm.formula : dataBindingForm.formula"
                                                    type="textarea"
                                                    :rows="3"
                                                    placeholder="请输入计算公式，可使用已选择的数据点位和运算符"
                                                    class="formula-input">
                                                </el-input>
                                                <div class="formula-validation">
                                                    <el-button size="small" @click="validateFormula" type="primary">验证公式</el-button>
                                                </div>
                                            </div>
                                        </el-tab-pane>
                                    </el-tabs>
                                </div>
                                
                                <!-- 运算符工具栏 - 只在可视化输入时显示 -->
                                <div class="formula-tools" v-if="formulaInputMode === 'visual'">
                                    <div class="operators">
                                        <div class="operator-group">
                                            <span class="operator-label">算术：</span>
                                            <el-button 
                                                v-for="op in arithmeticOperators" 
                                                :key="op"
                                                size="mini" 
                                                @click="insertOperator(op)"
                                                class="operator-btn arithmetic">
                                                {{ op }}
                                            </el-button>
                                        </div>
                                        <div class="operator-group">
                                            <span class="operator-label">逻辑：</span>
                                            <el-button 
                                                v-for="op in logicalOperators" 
                                                :key="op"
                                                size="mini" 
                                                @click="insertOperator(op)"
                                                class="operator-btn logical">
                                                {{ op }}
                                            </el-button>
                                        </div>
                                        <div class="operator-group">
                                            <span class="operator-label">条件：</span>
                                            <el-button 
                                                v-for="op in conditionalOperators" 
                                                :key="op"
                                                size="mini" 
                                                @click="insertOperator(op)"
                                                class="operator-btn conditional">
                                                {{ op }}
                                            </el-button>
                                        </div>
                                    </div>
                                </div>
                                

                                <!-- <div class="formula-tools">
                                    <div class="operators">
                                        <div class="operator-group">
                                            <span class="operator-label">算术运算符：</span>
                                            <el-button 
                                                v-for="op in arithmeticOperators" 
                                                :key="op"
                                                size="mini" 
                                                @click="insertOperator(op)"
                                                class="operator-btn arithmetic">
                                                {{ op }}
                                            </el-button>
                                        </div>
                                        <div class="operator-group">
                                            <span class="operator-label">逻辑运算符：</span>
                                            <el-button 
                                                v-for="op in logicalOperators" 
                                                :key="op"
                                                size="mini" 
                                                @click="insertOperator(op)"
                                                class="operator-btn logical">
                                                {{ op }}
                                            </el-button>
                                        </div>
                                        <div class="operator-group">
                                            <span class="operator-label">条件运算符：</span>
                                            <el-button 
                                                v-for="op in conditionalOperators" 
                                                :key="op"
                                                size="mini" 
                                                @click="insertOperator(op)"
                                                class="operator-btn conditional">
                                                {{ op }}
                                            </el-button>
                                        </div>
                                    </div>
                                </div> -->
                            </div>
                        </div>

                        <!-- 操作按钮 -->
                        <div class="drawer-actions" v-if="(configType === 'businessPropertyBinding' ? businessPropertyDataBindingForm.selectedPoints.length : dataBindingForm.selectedPoints.length) > 0">
                            <el-button @click="dataBindingDrawerVisible = false">取消</el-button>
                            <el-button type="primary" @click="configType === 'businessPropertyBinding' ? saveBusinessPropertyDataBindingConfig() : saveDataBindingConfig()">保存</el-button>
                        </div>

                        <!-- 空状态提示 -->
                        <div class="empty-selection" v-if="(configType === 'businessPropertyBinding' ? businessPropertyDataBindingForm.selectedPoints.length : dataBindingForm.selectedPoints.length) === 0">
                            <div class="empty-icon">📋</div>
                            <div class="empty-text">请从左侧选择数据点位</div>
                        </div>
                    </el-col>
                </el-row>
            </div>
        </div>
    </el-drawer>

    <!-- 数据转换配置抽屉 -->
    <el-drawer
        title="数据转换配置"
        :visible.sync="dataTransformDrawerVisible"
        direction="rtl"
        size="50%">
        <div style="padding: 20px;">
            <div style="margin-top: 20px;">
                <el-button @click="dataTransformDrawerVisible = false">取消</el-button>
                <el-button type="primary" @click="saveDataTransformConfig">保存</el-button>
            </div>
        </div>
    </el-drawer>

    <!-- 指标编辑抽屉 -->
    <div class="drawer-backdrop" id="indicator-drawer" :class="{ 'active': indicatorDrawerVisible }">
        <div class="drawer">
            <div class="drawer-header">
                <h3 class="drawer-title" id="indicator-drawer-title">{{ indicatorDrawerTitle }}</h3>
                <button class="drawer-close" @click="closeIndicatorDrawer">×</button>
            </div>
            <div class="drawer-body">
                <div class="drawer-form">
                    <div class="drawer-form-row">
                        <div class="drawer-form-group">
                            <label class="drawer-form-label required">指标名称</label>
                            <input type="text" class="drawer-form-input" v-model="indicatorForm.name" placeholder="请输入指标名称" :disabled="isIndicatorViewMode">
                        </div>
                        <div class="drawer-form-group">
                            <label class="drawer-form-label required">指标编码</label>
                            <input type="text" class="drawer-form-input" v-model="indicatorForm.code" placeholder="请输入指标编码" :disabled="isIndicatorViewMode">
                            <div class="drawer-form-hint">如果不填写，系统将自动生成</div>
                        </div>
                    </div>
                    <div class="drawer-form-row">
                        <div class="drawer-form-group">
                            <label class="drawer-form-label required">指标分类</label>
                            <select class="drawer-form-select" v-model="indicatorForm.category" :disabled="isIndicatorViewMode">
                                <option value="">请选择指标分类</option>
                                <option value="性能指标">性能指标</option>
                                <option value="经济指标">经济指标</option>
                                <option value="安全指标">安全指标</option>
                                <option value="环保指标">环保指标</option>
                            </select>
                        </div>
                        <div class="drawer-form-group">
                            <label class="drawer-form-label">指标单位</label>
                            <input type="text" class="drawer-form-input" v-model="indicatorForm.unit" placeholder="如：%、元/吨、次/月等" :disabled="isIndicatorViewMode">
                        </div>
                    </div>
                    <div class="drawer-form-row">
                        <div class="drawer-form-group">
                            <label class="drawer-form-label required">指标方向</label>
                            <select class="drawer-form-select" v-model="indicatorForm.direction" :disabled="isIndicatorViewMode">
                                <option value="">请选择指标方向</option>
                                <option value="positive">正向</option>
                                <option value="negative">负向</option>
                            </select>
                        </div>
                        <div class="drawer-form-group">
                            <label class="drawer-form-label">描述</label>
                            <input type="text" class="drawer-form-input" v-model="indicatorForm.description" placeholder="请输入指标描述" :disabled="isIndicatorViewMode">
                        </div>
                    </div>
                    <div class="drawer-form-row">
                        <div class="drawer-form-group">
                            <label class="drawer-form-label required">计算周期</label>
                            <select class="drawer-form-select" v-model="indicatorForm.calculationCycle" :disabled="isIndicatorViewMode">
                                <option value="">请选择计算周期</option>
                                <option value="minute">分钟</option>
                                <option value="hour">小时</option>
                                <option value="day">天</option>
                                <option value="week">周</option>
                                <option value="month">月</option>
                                <option value="quarter">季度</option>
                                <option value="year">年</option>
                            </select>
                        </div>
                        <div class="drawer-form-group">
                            <label class="drawer-form-label required">更新频率</label>
                            <select class="drawer-form-select" v-model="indicatorForm.updateFrequency" :disabled="isIndicatorViewMode">
                                <option value="">请选择更新频率</option>
                                <option value="1min">1分钟</option>
                                <option value="5min">5分钟</option>
                                <option value="10min">10分钟</option>
                                <option value="30min">30分钟</option>
                                <option value="1h">1小时</option>
                                <option value="6h">6小时</option>
                                <option value="1d">1天</option>
                                <option value="1w">1周</option>
                                <option value="1m">1月</option>
                            </select>
                        </div>
                    </div>
                    <div class="drawer-form-row">
                        <div class="drawer-form-group">
                            <label class="drawer-form-label">参与变量（提示：拖拽参与变量到公式中任意位置）</label>
                            <div class="variable-selector" id="drawer-participating-variables">
                                <div class="variable-list">
                                    <div v-for="variable in indicatorForm.participatingVariables" :key="variable" class="variable-item" draggable="true" @dragstart="onVariableDragStart($event, variable)">
                                        <div class="variable-item-info">
                                            <span class="variable-item-name">{{ variable }}</span>
                                            <span class="variable-item-description">{{ getVariableDescription(variable) }}</span>
                                        </div>
                                        <span class="variable-item-remove" @click="removeParticipatingVariable(variable)" v-if="!isIndicatorViewMode">×</span>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-sm" @click="showVariableSelector" v-if="!isIndicatorViewMode">添加变量</button>
                            </div>
                        </div>
                        <div class="drawer-form-group">
                            <label class="drawer-form-label">计算公式</label>
                            <div class="formula-input-container">
                                <div class="formula-editor">
                                    <div class="formula-toolbar">
                                        <button type="button" class="formula-btn" @click="insertOperator('+')" title="加法" :disabled="isIndicatorViewMode">+</button>
                                        <button type="button" class="formula-btn" @click="insertOperator('-')" title="减法" :disabled="isIndicatorViewMode">-</button>
                                        <button type="button" class="formula-btn" @click="insertOperator('*')" title="乘法" :disabled="isIndicatorViewMode">×</button>
                                        <button type="button" class="formula-btn" @click="insertOperator('/')" title="除法" :disabled="isIndicatorViewMode">÷</button>
                                        <button type="button" class="formula-btn" @click="insertOperator('(')" title="左括号" :disabled="isIndicatorViewMode">(</button>
                                        <button type="button" class="formula-btn" @click="insertOperator(')')" title="右括号" :disabled="isIndicatorViewMode">)</button>
                                        <button type="button" class="formula-btn" @click="insertOperator('=')" title="等于" :disabled="isIndicatorViewMode">=</button>
                                        <button type="button" class="formula-btn" @click="insertOperator('%')" title="百分比" :disabled="isIndicatorViewMode">%</button>
                                        <button type="button" class="formula-btn" @click="insertOperator('**')" title="幂运算" :disabled="isIndicatorViewMode">^</button>
                                        <button type="button" class="formula-btn" @click="insertOperator('sqrt(')" title="平方根" :disabled="isIndicatorViewMode">√</button>
                                        <button type="button" class="formula-btn" @click="insertOperator('abs(')" title="绝对值" :disabled="isIndicatorViewMode">|x|</button>
                                        <button type="button" class="formula-btn" @click="insertOperator('max(')" title="最大值" :disabled="isIndicatorViewMode">max</button>
                                        <button type="button" class="formula-btn" @click="insertOperator('min(')" title="最小值" :disabled="isIndicatorViewMode">min</button>
                                        <button type="button" class="formula-btn" @click="insertOperator('avg(')" title="平均值" :disabled="isIndicatorViewMode">avg</button>
                                        <button type="button" class="formula-btn" @click="insertOperator('sum(')" title="求和" :disabled="isIndicatorViewMode">sum</button>
                                        <button type="button" class="formula-btn" @click="insertOperator('count(')" title="计数" :disabled="isIndicatorViewMode">count</button>
                                        <button type="button" class="formula-btn" @click="insertOperator('if(')" title="条件判断" :disabled="isIndicatorViewMode">if</button>
                                        <button type="button" class="formula-btn" @click="insertOperator('round(')" title="四舍五入" :disabled="isIndicatorViewMode">round</button>
                                        <button type="button" class="formula-btn" @click="insertOperator('floor(')" title="向下取整" :disabled="isIndicatorViewMode">floor</button>
                                        <button type="button" class="formula-btn" @click="insertOperator('ceil(')" title="向上取整" :disabled="isIndicatorViewMode">ceil</button>
                                    </div>
                                    <div class="formula-input-wrapper">
                                        <div class="formula-display" 
                                             id="formula-display" 
                                             contenteditable="true" 
                                             placeholder="请输入计算公式，如：实际产量/理论产量*100%"
                                             v-html="formattedFormula"
                                             @input="onFormulaInput"
                                             @drop="onFormulaDrop"
                                             @dragover="onFormulaDragOver"
                                             @dragleave="onFormulaDragLeave"
                                             :class="{ 'drag-over': isFormulaDragOver }"
                                             :disabled="isIndicatorViewMode">
                                        </div>
                                        <textarea class="formula-textarea" 
                                                  v-model="indicatorForm.formula" 
                                                  style="display: none;">
                                        </textarea>
                                        <div class="formula-status" :class="formulaStatusClass" v-if="formulaStatus">{{ formulaStatus }}</div>
                                    </div>
                                </div>
                                <div class="formula-actions" v-if="!isIndicatorViewMode">
                                    <button type="button" class="btn btn-sm btn-primary" @click="validateFormula">校验</button>
                                    <button type="button" class="btn btn-sm" @click="formatFormula">格式化</button>
                                    <button type="button" class="btn btn-sm" @click="clearFormula">清空</button>
                                </div>
                            </div>
                        </div>
                    </div>


                </div>
            </div>
            <div class="drawer-footer">
                <button class="btn" @click="closeIndicatorDrawer">取消</button>
                <button class="btn btn-primary" @click="saveIndicatorFromDrawer">{{ indicatorSaveButtonText }}</button>
            </div>
        </div>
    </div>

    <!-- 指标配置抽屉 -->
    <el-drawer
        title="指标配置"
        :visible.sync="indicatorConfigDrawerVisible"
        direction="btt"
        size="80%">
        <div style="padding: 20px;">
            <div class="indicator-config">
                <!-- 左右并排布局 -->
                <el-row :gutter="20" class="indicator-config-layout">
                    <!-- 左侧：数据源选择 + 数据列表 -->
                    <el-col :span="16" class="left-panel">
                        <!-- 数据源选择 -->
                        <div class="data-source-section">
                            <h4>数据源选择</h4>
                            <div class="data-source-tabs">
                                <el-tabs v-model="indicatorConfigForm.activeTab" @tab-click="handleDataSourceTabChange">
                                    <el-tab-pane label="采集参数" name="collection">
                                        <div class="tab-content">
                                            <div class="search-form">
                                                <el-form>
                                                    <el-row :gutter="16" align="bottom">
                                                        <el-col :span="8">
                                                            <el-form-item label="参数名称">
                                                                <el-input 
                                                                    v-model="indicatorConfigForm.collectionVariableName" 
                                                                    placeholder="请输入参数名称"
                                                                    clearable>
                                                                </el-input>
                                                            </el-form-item>
                                                        </el-col>
                                                        <el-col :span="8">
                                                            <el-form-item label="编码">
                                                                <el-input 
                                                                    v-model="indicatorConfigForm.collectionVariableCode" 
                                                                    placeholder="请输入编码"
                                                                    clearable>
                                                                </el-input>
                                                            </el-form-item>
                                                        </el-col>
                                                        <el-col :span="8">
                                                            <el-form-item>
                                                                <el-button type="primary" @click="searchCollectionVariables">搜索</el-button>
                                                                <el-button @click="clearCollectionVariableSearch">清空</el-button>
                                                            </el-form-item>
                                                        </el-col>
                                                    </el-row>
                                                </el-form>
                                            </div>
                                            <div class="data-list">
                                                <el-table 
                                                    :data="filteredCollectionVariables" 
                                                    style="width: 100%"
                                                    @selection-change="handleCollectionVariableSelectionChange"
                                                    @row-click="toggleCollectionVariableSelection">
                                                    <el-table-column type="selection" width="55"></el-table-column>
                                                    <el-table-column prop="name" label="参数名称" min-width="120"></el-table-column>
                                                    <el-table-column prop="code" label="编码" min-width="100"></el-table-column>
                                                    <el-table-column prop="type" label="数据类型" min-width="80"></el-table-column>
                                                    <el-table-column prop="unit" label="单位" min-width="60"></el-table-column>
                                                    <el-table-column prop="frequency" label="采集频率" min-width="80"></el-table-column>
                                                    <el-table-column prop="valueMethod" label="取值方式" min-width="80"></el-table-column>
                                                    <el-table-column prop="description" label="描述" min-width="120"></el-table-column>
                                                </el-table>
                                            </div>
                                        </div>
                                    </el-tab-pane>
                                    
                                    <el-tab-pane label="业务属性" name="business">
                                        <div class="tab-content">
                                            <div class="search-form">
                                                <el-form>
                                                    <el-row :gutter="16" align="bottom">
                                                        <el-col :span="8">
                                                            <el-form-item label="属性名称">
                                                                <el-input 
                                                                    v-model="indicatorConfigForm.businessPropertyName" 
                                                                    placeholder="请输入属性名称"
                                                                    clearable>
                                                                </el-input>
                                                            </el-form-item>
                                                        </el-col>
                                                        <el-col :span="8">
                                                            <el-form-item label="编码">
                                                                <el-input 
                                                                    v-model="indicatorConfigForm.businessPropertyCode" 
                                                                    placeholder="请输入编码"
                                                                    clearable>
                                                                </el-input>
                                                            </el-form-item>
                                                        </el-col>
                                                        <el-col :span="8">
                                                            <el-form-item>
                                                                <el-button type="primary" @click="searchBusinessProperties">搜索</el-button>
                                                                <el-button @click="clearBusinessSearch">清空</el-button>
                                                            </el-form-item>
                                                        </el-col>
                                                    </el-row>
                                                </el-form>
                                            </div>
                                            <div class="data-list">
                                                <el-table 
                                                    :data="filteredBusinessProperties" 
                                                    style="width: 100%"
                                                    @selection-change="handleBusinessSelectionChange"
                                                    @row-click="toggleBusinessSelection">
                                                    <el-table-column type="selection" width="55"></el-table-column>
                                                    <el-table-column prop="name" label="属性名称" min-width="120"></el-table-column>
                                                    <el-table-column prop="code" label="编码" min-width="100"></el-table-column>
                                                    <el-table-column prop="dataType" label="数据类型" min-width="80"></el-table-column>
                                                    <el-table-column prop="unit" label="单位" min-width="60"></el-table-column>
                                                    <el-table-column prop="description" label="描述" min-width="120"></el-table-column>
                                                </el-table>
                                            </div>
                                        </div>
                                    </el-tab-pane>
                                    
                                    <el-tab-pane label="指标" name="indicators">
                                        <div class="tab-content">
                                            <div class="search-form">
                                                <el-form>
                                                    <el-row :gutter="16" align="bottom">
                                                        <el-col :span="8">
                                                            <el-form-item label="指标名称">
                                                                <el-input 
                                                                    v-model="indicatorConfigForm.indicatorName" 
                                                                    placeholder="请输入指标名称"
                                                                    clearable>
                                                                </el-input>
                                                            </el-form-item>
                                                        </el-col>
                                                        <el-col :span="8">
                                                            <el-form-item label="编码">
                                                                <el-input 
                                                                    v-model="indicatorConfigForm.indicatorCode" 
                                                                    placeholder="请输入编码"
                                                                    clearable>
                                                                </el-input>
                                                            </el-form-item>
                                                        </el-col>
                                                        <el-col :span="8">
                                                            <el-form-item>
                                                                <el-button type="primary" @click="searchIndicators">搜索</el-button>
                                                                <el-button @click="clearIndicatorSearch">清空</el-button>
                                                            </el-form-item>
                                                        </el-col>
                                                    </el-row>
                                                </el-form>
                                            </div>
                                            <div class="data-list">
                                                <el-table 
                                                    :data="filteredConfigIndicators" 
                                                    style="width: 100%"
                                                    @selection-change="handleConfigIndicatorSelectionChange"
                                                    @row-click="toggleConfigIndicatorSelection">
                                                    <el-table-column type="selection" width="55"></el-table-column>
                                                    <el-table-column prop="name" label="指标名称" min-width="120"></el-table-column>
                                                    <el-table-column prop="code" label="编码" min-width="100"></el-table-column>
                                                    <el-table-column prop="category" label="分类" min-width="80"></el-table-column>
                                                    <el-table-column prop="unit" label="单位" min-width="60"></el-table-column>
                                                    <el-table-column prop="description" label="描述" min-width="120"></el-table-column>
                                                    <el-table-column prop="enabled" label="启停" min-width="80" fixed="right">
                                                        <template slot-scope="scope">
                                                            <el-switch 
                                                                v-model="scope.row.enabled"
                                                                @change="toggleIndicatorStatus(scope.row)">
                                                            </el-switch>
                                                        </template>
                                                    </el-table-column>
                                                </el-table>
                                            </div>
                                        </div>
                                    </el-tab-pane>
                                </el-tabs>
                            </div>
                        </div>
                    </el-col>

                    <!-- 右侧：已选择的数据 + 计算公式配置 -->
                    <el-col :span="8" class="right-panel">
                        <!-- 已选择的数据 -->
                        <div class="selected-data-section" v-if="indicatorConfigForm.selectedData.length > 0">
                            <h4>已选择的数据 ({{ indicatorConfigForm.selectedData.length }})</h4>
                            <div class="selected-data-list">
                                <div 
                                    v-for="(item, index) in indicatorConfigForm.selectedData" 
                                    :key="item.id"
                                    class="selected-data-item"
                                    @dblclick="insertDataItem(item)">
                                    <span class="data-source">[{{ item.sourceType }}].</span>
                                    <span class="data-name">{{ item.name }}</span>
                                    <span class="data-code">({{ item.code }})</span>
                                    <el-button 
                                        type="text" 
                                        size="mini" 
                                        @click="removeSelectedData(index)"
                                        class="remove-btn">
                                        <i class="el-icon-close"></i>
                                    </el-button>
                                </div>
                            </div>
                        </div>

                        <!-- 计算公式配置 -->
                        <div class="formula-section" v-if="indicatorConfigForm.selectedData.length > 0">
                            <h4>计算公式配置</h4>
                            <div class="formula-config">
                                <!-- 输入模式切换 -->
                                <div class="input-mode-tabs">
                                    <el-tabs v-model="indicatorConfigFormulaInputMode" @tab-click="handleIndicatorConfigInputModeChange">
                                        <el-tab-pane label="自然语言" name="natural">
                                            <div class="natural-language-input">
                                                <el-input
                                                    v-model="indicatorConfigNaturalLanguageInput"
                                                    type="textarea"
                                                    :rows="3"
                                                    placeholder="请用自然语言描述计算公式，例如：温度传感器1的值加上温度传感器2的值除以2">
                                                </el-input>
                                                <div class="ai-translation-actions">
                                                    <div class="ai-translation-status">
                                                        <span v-if="indicatorConfigIsTranslating" class="translating">
                                                            <i class="el-icon-loading"></i> AI正在翻译...
                                                        </span>
                                                        <span v-else-if="indicatorConfigTranslatedExpression" class="translated">
                                                            <i class="el-icon-success"></i> 已转换为表达式
                                                        </span>
                                                    </div>
                                                    <el-button 
                                                        type="primary" 
                                                        size="small"
                                                        @click="handleIndicatorConfigNaturalLanguageInput"
                                                        :loading="indicatorConfigIsTranslating"
                                                        :disabled="!indicatorConfigNaturalLanguageInput.trim()">
                                                        <i class="el-icon-magic-stick"></i> AI转换
                                                    </el-button>
                                                </div>
                                            </div>
                                        </el-tab-pane>
                                        
                                        <el-tab-pane label="可视化输入" name="visual">
                                            <div class="visual-input">
                                                <div class="visual-formula-display">
                                                    <div class="formula-preview">
                                                        <div class="formula-blocks">
                                                            <div 
                                                                v-for="(part, index) in indicatorConfigVisualFormulaParts" 
                                                                :key="index"
                                                                class="formula-block"
                                                                @click="selectIndicatorConfigBlock(index)"
                                                                :class="{ 'selected': indicatorConfigSelectedBlockIndex === index }">
                                                                <span class="block-content">
                                                                    <span v-if="part.type === 'variable'">[{{ part.sourceType }}].[{{ part.name }}]</span>
                                                                    <span v-else>{{ part.value }}</span>
                                                                </span>
                                                                <el-button 
                                                                    type="text" 
                                                                    size="mini" 
                                                                    class="delete-btn"
                                                                    @click.stop="deleteIndicatorConfigBlock(index)">
                                                                    <i class="el-icon-close"></i>
                                                                </el-button>
                                                            </div>
                                                            <div class="insert-hint" v-if="indicatorConfigVisualFormulaParts.length === 0">
                                                                请双击变量或点击运算符来构建公式
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="formula-validation">
                                                    <el-button size="small" @click="validateIndicatorConfigFormula" type="primary">验证公式</el-button>
                                                </div>
                                                <div class="visual-input-tools">
                                                    <div class="variable-section">
                                                        <span class="section-title">变量：</span>
                                                        <div class="variable-list">
                                                            <span 
                                                                v-for="item in indicatorConfigForm.selectedData" 
                                                                :key="item.id"
                                                                class="variable-item"
                                                                @dblclick="insertIndicatorConfigVariable(item)">
                                                                {{ item.name }}
                                                            </span>
                                                        </div>
                                                    </div>
                                                    <div class="number-section">
                                                        <span class="section-title">数字：</span>
                                                        <div class="number-input">
                                                            <el-input
                                                                v-model="indicatorConfigNumberInput"
                                                                size="mini"
                                                                placeholder="输入数字"
                                                                style="width: 80px; margin-right: 8px;">
                                                            </el-input>
                                                            <el-button 
                                                                size="mini" 
                                                                type="primary"
                                                                @click="insertIndicatorConfigNumber">
                                                                添加
                                                            </el-button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </el-tab-pane>
                                        
                                        <el-tab-pane label="表达式输入" name="expression">
                                            <div class="expression-input">
                                                <el-input
                                                    v-model="indicatorConfigForm.formula"
                                                    type="textarea"
                                                    :rows="4"
                                                    placeholder="请输入计算公式，可使用变量和运算符">
                                                </el-input>
                                                <div class="formula-validation">
                                                    <el-button size="small" @click="validateIndicatorConfigFormula" type="primary">验证公式</el-button>
                                                </div>
                                            </div>
                                        </el-tab-pane>
                                    </el-tabs>
                                </div>
                            </div>
                        </div>

                        <!-- 操作按钮 -->
                        <div class="drawer-actions" v-if="indicatorConfigForm.selectedData.length > 0">
                            <el-button @click="indicatorConfigDrawerVisible = false">取消</el-button>
                            <el-button type="primary" @click="saveIndicatorConfig">保存</el-button>
                        </div>

                        <!-- 空状态提示 -->
                        <div class="empty-selection" v-if="indicatorConfigForm.selectedData.length === 0">
                            <div class="empty-icon">📋</div>
                            <div class="empty-text">请从左侧选择数据</div>
                        </div>
                    </el-col>
                </el-row>
            </div>
        </div>
    </el-drawer>



    <!-- 变量选择器抽屉 -->
    <div class="drawer-backdrop" id="variable-selector-drawer" :class="{ 'active': variableSelectorVisible }">
        <div class="drawer">
            <div class="drawer-header">
                <h3 class="drawer-title">选择参与变量</h3>
                <button class="drawer-close" @click="closeVariableSelector">×</button>
            </div>
            <div class="drawer-body">
                <div class="variable-selector-content">
                    <div class="variable-category">
                        <h4>动态变量</h4>
                        <div class="variable-list">
                            <div v-for="variable in availableVariables.filter(v => v.type === 'dynamic')" 
                                 :key="variable.name" 
                                 class="variable-item" 
                                 draggable="true"
                                 @dragstart="onVariableDragStart($event, variable.name)"
                                 @click="addParticipatingVariable(variable.name)">
                                <div class="variable-item-info">
                                    <span class="variable-item-name">{{ variable.name }}</span>
                                    <span class="variable-item-description">{{ variable.unit }} - {{ variable.code }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="variable-category">
                        <h4>静态属性</h4>
                        <div class="variable-list">
                            <div v-for="variable in availableVariables.filter(v => v.type === 'static')" 
                                 :key="variable.name" 
                                 class="variable-item" 
                                 draggable="true"
                                 @dragstart="onVariableDragStart($event, variable.name)"
                                 @click="addParticipatingVariable(variable.name)">
                                <div class="variable-item-info">
                                    <span class="variable-item-name">{{ variable.name }}</span>
                                    <span class="variable-item-description">{{ variable.code }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="variable-category">
                        <h4>业务属性</h4>
                        <div class="variable-list">
                            <div v-for="variable in availableVariables.filter(v => v.type === 'business')" 
                                 :key="variable.name" 
                                 class="variable-item" 
                                 draggable="true"
                                 @dragstart="onVariableDragStart($event, variable.name)"
                                 @click="addParticipatingVariable(variable.name)">
                                <div class="variable-item-info">
                                    <span class="variable-item-name">{{ variable.name }}</span>
                                    <span class="variable-item-description">{{ variable.code }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="drawer-footer">
                <button class="btn" @click="closeVariableSelector">关闭</button>
            </div>
        </div>
    </div>
    </div><!-- 结束 #app -->

    <!-- 引入Vue和Element UI -->
    <script src="assets/vue.js"></script>
    <script src="assets/element-ui.js"></script>
    
    <script>
        new Vue({
            el: '#app',
            data: {
                // 页面信息
                pageTitle: '华东水泥生产基地',
                pageDescription: '基于"标准水泥工厂模板"创建的工厂模型实例',
                
                // 模型基本信息
                modelInfo: {
                    name: '华东水泥生产基地',
                    description: '华东地区主要水泥生产基地，年产水泥500万吨，包含完整的熟料生产线、粉磨系统和包装系统。',
                    templateName: '标准水泥工厂模板',
                    createTime: '2024-01-15 10:30:00',
                    creator: '张工程师',
                    status: 'enabled'
                },
                
                // 层级结构管理相关数据
                searchKeyword: '',
                viewMode: 'tree',
                selectedNode: null,
                
                // 树形结构数据
                treeData: [
                    {
                        id: 'factory-1',
                        name: '华东水泥生产基地',
                        code: 'CEMENT_FACTORY_001',
                        type: '工厂',
                        description: '华东地区主要水泥生产基地，年产水泥500万吨',
                        createTime: '2024-01-15 10:30:00',
                        level: 1,
                        assets: [
                            { 
                                id: 'asset-1', 
                                name: '水泥厂DCS系统', 
                                type: 'cement_mill_001',
                                model: 'DCS-5000',
                                category: '控制类',
                                supplier: '霍尼韦尔国际公司',
                                manufacturer: '霍尼韦尔国际公司',
                                installDate: '2024-01-10',
                                status: '运行中',
                                code: 'DCS-001',
                                description: '水泥厂分布式控制系统，负责全厂自动化控制',
                                isConnected: true
                            },
                            { 
                                id: 'asset-2', 
                                name: '生产数据采集系统', 
                                type: 'cement_mill_001',
                                model: 'SCADA-3000',
                                category: '采集类',
                                supplier: '西门子股份公司',
                                manufacturer: '西门子股份公司',
                                installDate: '2024-01-12',
                                status: '运行中',
                                code: 'SCADA-001',
                                description: '实时采集生产数据，监控设备运行状态',
                                isConnected: true
                            },
                            { 
                                id: 'asset-3', 
                                name: '环境监测系统', 
                                type: 'cement_mill_001',
                                model: 'EMS-2000',
                                category: '监控类',
                                supplier: '艾默生电气公司',
                                manufacturer: '艾默生电气公司',
                                installDate: '2024-01-08',
                                status: '运行中',
                                code: 'EMS-001',
                                description: '环境参数监测系统，包括粉尘、噪音、废气等',
                                isConnected: false
                            },
                            { 
                                id: 'asset-4', 
                                name: '安全监控系统', 
                                type: 'cement_mill_001',
                                model: 'SEC-1000',
                                category: '安全类',
                                supplier: '海康威视数字技术股份有限公司',
                                manufacturer: '海康威视数字技术股份有限公司',
                                installDate: '2024-01-15',
                                status: '运行中',
                                code: 'SEC-001',
                                description: '安全监控系统，包括摄像头和报警装置',
                                isConnected: true
                            }
                        ],
                        children: [
                            {
                                id: 'workshop-1',
                                name: '原料车间',
                                code: 'RAW_MATERIAL_001',
                                type: '车间',
                                description: '原料车间负责石灰石、粘土等原料的破碎和预均化',
                                createTime: '2024-01-15 11:00:00',
                                level: 2,
                                assets: [
                                    { 
                                        id: 'asset-5', 
                                        name: '石灰石破碎机', 
                                        type: 'cement_mill_001',
                                        model: 'CRUSHER-2000',
                                        category: '破碎类',
                                        supplier: '山特维克集团',
                                        manufacturer: '山特维克集团',
                                        installDate: '2024-01-14',
                                        status: '运行中',
                                        code: 'CRUSHER-001',
                                        description: '石灰石初级破碎设备，处理能力2000吨/小时',
                                        isConnected: true
                                    },
                                    { 
                                        id: 'asset-6', 
                                        name: '原料预均化堆场', 
                                        type: 'raw_material_bin_001',
                                        model: 'BLENDING-1500',
                                        category: '均化类',
                                        supplier: '伯利休斯公司',
                                        manufacturer: '伯利休斯公司',
                                        installDate: '2024-01-13',
                                        status: '运行中',
                                        code: 'BLENDING-001',
                                        description: '原料预均化设备，确保原料成分稳定',
                                        isConnected: false
                                    }
                                ],
                                children: [
                                    {
                                        id: 'line-1',
                                        name: '石灰石破碎线',
                                        code: 'LIMESTONE_LINE_001',
                                        type: '产线',
                                        description: '石灰石破碎生产线',
                                        createTime: '2024-01-15 11:30:00',
                                        level: 3,
                                        assets: [
                                            { 
                                                id: 'asset-7', 
                                                name: '颚式破碎机', 
                                                type: 'cement_mill_001',
                                                model: 'JAW_CRUSHER-800',
                                                category: '破碎类',
                                                supplier: '美卓矿机公司',
                                                manufacturer: '美卓矿机公司',
                                                installDate: '2024-01-16',
                                                status: '运行中',
                                                code: 'JAW-001',
                                                description: '石灰石粗碎设备，处理能力800吨/小时',
                                                isConnected: true
                                            },
                                            { 
                                                id: 'asset-8', 
                                                name: '圆锥破碎机', 
                                                type: 'cement_mill_001',
                                                model: 'CONE_CRUSHER-600',
                                                category: '破碎类',
                                                supplier: '山特维克集团',
                                                manufacturer: '山特维克集团',
                                                installDate: '2024-01-17',
                                                status: '运行中',
                                                code: 'CONE-001',
                                                description: '石灰石中碎设备，处理能力600吨/小时',
                                                isConnected: true
                                            }
                                        ],
                                        children: [
                                            {
                                                id: 'section-1',
                                                name: '破碎工段',
                                                code: 'CRUSHING_SECTION_001',
                                                type: '工段',
                                                description: '石灰石破碎工段',
                                                createTime: '2024-01-15 12:00:00',
                                                level: 4,
                                                assets: [
                                                    { 
                                                        id: 'asset-9', 
                                                        name: '振动筛分机', 
                                                        type: 'cement_mill_001',
                                                        model: 'VIBRATING_SCREEN-400',
                                                        category: '筛分类',
                                                        supplier: '德瑞克公司',
                                                        manufacturer: '德瑞克公司',
                                                        installDate: '2024-01-18',
                                                        status: '运行中',
                                                        code: 'SCREEN-001',
                                                        description: '石灰石筛分设备，分离不同粒径的物料',
                                                        isConnected: false
                                                    }
                                                ],
                                                children: [
                                                    {
                                                        id: 'equipment-1',
                                                        name: '破碎机控制系统',
                                                        code: 'CRUSHER_CTRL_001',
                                                        type: '设备',
                                                        description: '破碎机自动化控制系统',
                                                        createTime: '2024-01-15 12:30:00',
                                                        level: 5,
                                                        assets: [
                                                            { 
                                                                id: 'asset-10', 
                                                                name: 'PLC控制器', 
                                                                type: 'cement_mill_001',
                                                                model: 'PLC-300',
                                                                category: '控制类',
                                                                supplier: '罗克韦尔自动化公司',
                                                                manufacturer: '罗克韦尔自动化公司',
                                                                installDate: '2024-01-19',
                                                                status: '运行中',
                                                                code: 'PLC-001',
                                                                description: '破碎机PLC控制系统，负责设备运行控制',
                                                                isConnected: true
                                                            },
                                                            { 
                                                                id: 'asset-11', 
                                                                name: '压力传感器', 
                                                                type: 'cement_mill_001',
                                                                model: 'PRESSURE_SENSOR-100',
                                                                category: '传感器类',
                                                                supplier: '施耐德电气公司',
                                                                manufacturer: '施耐德电气公司',
                                                                installDate: '2024-01-20',
                                                                status: '运行中',
                                                                code: 'SENSOR-001',
                                                                description: '破碎机压力监测传感器，实时监测设备压力',
                                                                isConnected: true
                                                            }
                                                        ]
                                                    }
                                                ]
                                            }
                                        ]
                                    }
                                ]
                            },
                            {
                                id: 'workshop-2',
                                name: '烧成车间',
                                code: 'KILN_001',
                                type: '车间',
                                description: '烧成车间负责生料煅烧成熟料',
                                createTime: '2024-01-15 13:00:00',
                                level: 2,
                                assets: [
                                    { 
                                        id: 'asset-12', 
                                        name: '回转窑', 
                                        type: 'rotary_kiln_001',
                                        model: 'ROTARY_KILN-5000',
                                        category: '烧成类',
                                        supplier: '伯利休斯公司',
                                        manufacturer: '伯利休斯公司',
                                        installDate: '2024-01-21',
                                        status: '运行中',
                                        code: 'KILN-001',
                                        description: '水泥熟料煅烧回转窑，直径5米，长度80米',
                                        isConnected: true
                                    },
                                    { 
                                        id: 'asset-13', 
                                        name: '预热器', 
                                        type: 'rotary_kiln_001',
                                        model: 'PREHEATER-5000',
                                        category: '预热类',
                                        supplier: '伯利休斯公司',
                                        manufacturer: '伯利休斯公司',
                                        installDate: '2024-01-22',
                                        status: '运行中',
                                        code: 'PREHEATER-001',
                                        description: '五级旋风预热器，提高热效率',
                                        isConnected: true
                                    }
                                ],
                                children: [
                                    {
                                        id: 'line-2',
                                        name: '烧成线',
                                        code: 'KILN_LINE_001',
                                        type: '产线',
                                        description: '熟料烧成生产线',
                                        createTime: '2024-01-15 13:30:00',
                                        level: 3,
                                        assets: [
                                            { 
                                                id: 'asset-14', 
                                                name: '篦冷机', 
                                                type: 'grate_cooler_001',
                                                model: 'COOLER-5000',
                                                category: '冷却类',
                                                supplier: '伯利休斯公司',
                                                manufacturer: '伯利休斯公司',
                                                installDate: '2024-01-23',
                                                status: '运行中',
                                                code: 'COOLER-001',
                                                description: '熟料冷却设备，回收热量用于发电',
                                                isConnected: false
                                            }
                                        ]
                                    }
                                ]
                            },
                            {
                                id: 'workshop-3',
                                name: '粉磨车间',
                                code: 'GRINDING_001',
                                type: '车间',
                                description: '粉磨车间负责熟料和混合材的粉磨',
                                createTime: '2024-01-15 14:00:00',
                                level: 2,
                                assets: [
                                    { 
                                        id: 'asset-15', 
                                        name: '水泥磨', 
                                        type: 'cement_mill_001',
                                        model: 'CEMENT_MILL-4000',
                                        category: '粉磨类',
                                        supplier: '伯利休斯公司',
                                        manufacturer: '伯利休斯公司',
                                        installDate: '2024-01-24',
                                        status: '运行中',
                                        code: 'MILL-001',
                                        description: '水泥粉磨设备，生产能力4000吨/天',
                                        isConnected: true
                                    },
                                    { 
                                        id: 'asset-16', 
                                        name: '选粉机', 
                                        type: 'cement_mill_001',
                                        model: 'SEPARATOR-4000',
                                        category: '选粉类',
                                        supplier: '伯利休斯公司',
                                        manufacturer: '伯利休斯公司',
                                        installDate: '2024-01-25',
                                        status: '运行中',
                                        code: 'SEPARATOR-001',
                                        description: '水泥选粉设备，控制产品细度',
                                        isConnected: false
                                    }
                                ]
                            }
                        ]
                    }
                ],
                
                // 树形配置
                treeProps: {
                    children: 'children',
                    label: 'name'
                },

                // 拖拽相关数据
                draggingNode: null,
                dragOverNode: null,
                isDragging: false,
                isDragOver: false,

                // 展开/收起状态
                expandedNodes: {},

                // 搜索过滤后的节点
                filteredNodes: [],
                hasRootNode: true, // 判断是否有根节点

                // 节点编辑对话框相关数据
                nodeDialogVisible: false,
                nodeDialogMode: 'add', // 弹框模式：add, edit, view
                nodeDialogTitle: '',
                nodeForm: {
                    name: '',
                    code: '',
                    type: '',
                    description: ''
                },
                nodeFormRules: {
                    name: [{ required: true, message: '请输入节点名称', trigger: 'blur' }],
                    code: [{ required: true, message: '请输入节点编码', trigger: 'blur' }],
                    type: [{ required: true, message: '请选择节点类型', trigger: 'change' }]
                },
                nodeTypes: [
                    { 
                        label: '工厂', 
                        value: '工厂',
                        assetType: '水泥工厂',
                        allowedChildTypes: ['车间', '系统']
                    },
                    { 
                        label: '车间', 
                        value: '车间',
                        assetType: '生产车间',
                        allowedChildTypes: ['产线', '设备']
                    },
                    { 
                        label: '产线', 
                        value: '产线',
                        assetType: '生产线',
                        allowedChildTypes: ['工段', '设备']
                    },
                    { 
                        label: '工段', 
                        value: '工段',
                        assetType: '工艺段',
                        allowedChildTypes: ['设备']
                    },
                    { 
                        label: '设备', 
                        value: '设备',
                        assetType: '生产设备',
                        allowedChildTypes: []
                    },
                    { 
                        label: '系统', 
                        value: '系统',
                        assetType: '控制系统',
                        allowedChildTypes: ['设备']
                    }
                ],
                currentParentNode: null, // 用于保存当前正在添加子节点的父节点
                
                // 基本信息展开状态
                basicInfoExpanded: false,
                
                // 节点详情基本信息展开状态
                nodeDetailsBasicInfoExpanded: false,
                
                // 资产列表搜索和过滤
                assetSearchKeyword: '',
                assetSearchField: 'name', // 搜索字段：name, model, category, supplier, manufacturer
                filteredAssets: [],
                
                // 资产导出相关
                exportAssetsDialogVisible: false,
                exportFormat: 'excel',
                
                // 添加资产相关
                isAddingAsset: false,
                isViewingAsset: false,
                isEditingAsset: false,
                currentEditingAsset: null,
                assetForm: {
                    assetType: '',
                    deviceCode: '',
                    deviceName: '',
                    connectionStatus: '待接入',
                    runningStatus: '-'
                },
                assetTypes: [
                    { value: 'cement_mill_001', label: '水泥磨机', staticProperties: [
                        { name: '设备名称', code: 'device_name', type: '字符串', required: true, defaultValue: '' },
                        { name: '型号', code: 'model', type: '字符串', required: true, defaultValue: '' },
                        { name: '规格', code: 'specification', type: '字符串', required: true, defaultValue: '' },
                        { name: '供应商', code: 'supplier', type: '字符串', required: true, defaultValue: '' },
                        { name: '制造商', code: 'manufacturer', type: '字符串', required: false, defaultValue: '' },
                        { name: '安装日期', code: 'install_date', type: '日期', required: false, defaultValue: '' }
                    ], dynamicVariables: [
                        { name: '设备温度', code: 'device_temp', type: '数值', unit: '℃', precision: '0.1', frequency: '1秒', dataCategory: '温度', businessCategory: '生产', valueCycle: '1秒', valueMethod: '瞬时值', dataBinding: '', dataTransform: '', isEditing: false },
                        { name: '运行压力', code: 'operating_pressure', type: '数值', unit: 'MPa', precision: '0.01', frequency: '5秒', dataCategory: '压力', businessCategory: '生产', valueCycle: '5秒', valueMethod: '瞬时值', dataBinding: '', dataTransform: '', isEditing: false },
                        { name: '累计运行时间', code: 'total_runtime', type: '数值', unit: '小时', precision: '1', frequency: '1分钟', dataCategory: '台时', businessCategory: '生产', valueCycle: '1分钟', valueMethod: '最后一个值', dataBinding: '', dataTransform: '', isEditing: false },
                        { name: '设备状态', code: 'device_status', type: '枚举', unit: '', precision: '', frequency: '1秒', dataCategory: '运行', businessCategory: '生产', valueCycle: '1秒', valueMethod: '瞬时值', dataBinding: '', dataTransform: '', isEditing: false }
                    ], businessProperties: [
                        { name: '生产计划', code: 'production_plan', type: '字符串', required: false, defaultValue: '', dataSource: '' },
                        { name: '质量标准', code: 'quality_standard', type: '字符串', required: false, defaultValue: '', dataSource: '' },
                        { name: '维护计划', code: 'maintenance_plan', type: '字符串', required: false, defaultValue: '', dataSource: '' },
                        { name: '设备负责人', code: 'device_manager', type: '字符串', required: false, defaultValue: '', dataSource: '' },
                        { name: '采购成本', code: 'purchase_cost', type: '数值', required: false, defaultValue: '', dataSource: '' },
                        { name: '运营成本', code: 'operation_cost', type: '数值', required: false, defaultValue: '', dataSource: '' }
                    ], indicators: [
                        { id: 1, name: '设备效率', code: 'device_efficiency', category: '性能指标', direction: 'positive', unit: '%', calculationCycle: 'hour', updateFrequency: '1h', description: '设备运行效率，基于实际产量与理论产量的比值', formula: '[实际产量] / [理论产量] * 100', participatingVariables: ['实际产量', '理论产量'] },
                        { id: 2, name: '单位能耗', code: 'unit_energy_consumption', category: '环保指标', direction: 'negative', unit: 'kWh/吨', calculationCycle: 'day', updateFrequency: '1d', description: '单位产品的能源消耗量', formula: '[总能耗] / [总产量]', participatingVariables: ['总能耗', '总产量'] },
                        { id: 3, name: '故障率', code: 'failure_rate', category: '安全指标', direction: 'negative', unit: '次/月', calculationCycle: 'month', updateFrequency: '1d', description: '设备故障次数与运行时间的比值', formula: '[故障次数] / [运行时间] * 100', participatingVariables: ['故障次数'] }
                    ], eventRules: [
                        { id: 1, name: '温度超限告警', code: 'temp_over_limit', category: '安全告警', description: '设备温度超过设定阈值时触发告警', triggerCondition: '设备温度 > 80', severity: 'high', enabled: true, actions: ['发送告警', '记录日志'], isEditing: false },
                        { id: 2, name: '压力异常检测', code: 'pressure_abnormal', category: '运行监控', description: '运行压力超出正常范围时触发事件', triggerCondition: '运行压力 < 0.5 OR 运行压力 > 2.0', severity: 'medium', enabled: true, actions: ['发送通知', '记录日志'], isEditing: false },
                        { id: 3, name: '设备停机检测', code: 'device_shutdown', category: '状态监控', description: '检测设备停机状态并记录', triggerCondition: '设备状态 = 停机', severity: 'low', enabled: true, actions: ['记录日志', '更新状态'], isEditing: false }
                    ], alarms: [
                        { id: 1, level: 'high', type: '温度超限', description: '水泥磨机温度达到85℃，超过安全阈值', alarmTime: '2024-01-18 14:30:25', triggerRule: '温度超限告警', triggerRuleName: '温度超限告警', triggerExpression: '设备温度 > 80', dataItems: [{ name: '设备温度', value: '85℃', dataSource: 'DCS.TEMP_001' }], isHandled: false, handler: '', status: 'active' },
                        { id: 2, level: 'medium', type: '压力异常', description: '运行压力为2.5MPa，超出正常范围', alarmTime: '2024-01-17 13:45:12', triggerRule: '压力异常检测', triggerRuleName: '压力异常检测', triggerExpression: '运行压力 < 0.5 OR 运行压力 > 2.0', dataItems: [{ name: '运行压力', value: '2.5MPa', dataSource: 'DCS.PRESS_001' }], isHandled: true, handler: '张工程师', status: 'handled' },
                        { id: 3, level: 'low', type: '设备停机', description: '设备运行状态异常，已停机', alarmTime: '2024-01-18 12:20:08', triggerRule: '设备停机检测', triggerRuleName: '设备停机检测', triggerExpression: '设备状态 = 停机', dataItems: [{ name: '设备状态', value: '停机', dataSource: 'DCS.STATUS_001' }], isHandled: false, handler: '', status: 'active' },
                        { id: 4, level: 'medium', type: '振动异常', description: '设备振动值达到12mm/s，超过正常范围', alarmTime: '2024-01-18 10:15:30', triggerRule: '振动异常检测', triggerRuleName: '振动异常检测', triggerExpression: '振动值 > 10', dataItems: [{ name: '振动值', value: '12mm/s', dataSource: 'DCS.VIB_001' }], isHandled: false, handler: '', status: 'active' },
                        { id: 5, level: 'high', type: '电流超限', description: '主电机电流达到120A，超过安全阈值', alarmTime: '2024-01-17 16:45:20', triggerRule: '电流超限告警', triggerRuleName: '电流超限告警', triggerExpression: '主电机电流 > 100', dataItems: [{ name: '主电机电流', value: '120A', dataSource: 'DCS.CURRENT_001' }], isHandled: false, handler: '', status: 'active' }
                    ], videos: [
                        { id: 1, cameraAddress: 'rtsp://192.168.1.200:554/stream1', cameraNumber: 'CAM101', cameraName: '磨机入口监控' },
                        { id: 2, cameraAddress: 'rtsp://192.168.1.201:554/stream1', cameraNumber: 'CAM102', cameraName: '磨机出口监控' },
                        { id: 3, cameraAddress: 'rtsp://192.168.1.202:554/stream1', cameraNumber: 'CAM103', cameraName: '磨机运行监控' }
                    ]},
                    { value: 'rotary_kiln_001', label: '回转窑', staticProperties: [
                        { name: '设备名称', code: 'device_name', type: '字符串', required: true, defaultValue: '' },
                        { name: '型号', code: 'model', type: '字符串', required: true, defaultValue: '' },
                        { name: '规格', code: 'specification', type: '字符串', required: true, defaultValue: '' },
                        { name: '供应商', code: 'supplier', type: '字符串', required: true, defaultValue: '' },
                        { name: '制造商', code: 'manufacturer', type: '字符串', required: false, defaultValue: '' },
                        { name: '安装日期', code: 'install_date', type: '日期', required: false, defaultValue: '' },
                        { name: '窑体长度', code: 'kiln_length', type: '数值', required: false, defaultValue: '' },
                        { name: '窑体直径', code: 'kiln_diameter', type: '数值', required: false, defaultValue: '' }
                    ], dynamicVariables: [
                        { name: '窑体温度', code: 'kiln_temperature', type: '数值', unit: '℃', precision: '1', frequency: '1秒', dataCategory: '温度', businessCategory: '生产', valueCycle: '1秒', valueMethod: '瞬时值', dataBinding: '', dataTransform: '', isEditing: false },
                        { name: '转速', code: 'rotation_speed', type: '数值', unit: 'rpm', precision: '0.1', frequency: '1秒', dataCategory: '运行', businessCategory: '生产', valueCycle: '1秒', valueMethod: '瞬时值', dataBinding: '', dataTransform: '', isEditing: false },
                        { name: '燃料消耗', code: 'fuel_consumption', type: '数值', unit: 'kg/h', precision: '0.1', frequency: '1分钟', dataCategory: '能耗', businessCategory: '生产', valueCycle: '1分钟', valueMethod: '平均值', dataBinding: '', dataTransform: '', isEditing: false },
                        { name: '运行状态', code: 'operation_status', type: '枚举', unit: '', precision: '', frequency: '1秒', dataCategory: '运行', businessCategory: '生产', valueCycle: '1秒', valueMethod: '瞬时值', dataBinding: '', dataTransform: '', isEditing: false }
                    ], businessProperties: [
                        { name: '生产计划', code: 'production_plan', type: '字符串', required: false, defaultValue: '', dataSource: '' },
                        { name: '质量标准', code: 'quality_standard', type: '字符串', required: false, defaultValue: '', dataSource: '' },
                        { name: '维护计划', code: 'maintenance_plan', type: '字符串', required: false, defaultValue: '', dataSource: '' },
                        { name: '设备负责人', code: 'device_manager', type: '字符串', required: false, defaultValue: '', dataSource: '' },
                        { name: '采购成本', code: 'purchase_cost', type: '数值', required: false, defaultValue: '', dataSource: '' },
                        { name: '运营成本', code: 'operation_cost', type: '数值', required: false, defaultValue: '', dataSource: '' }
                    ], indicators: [
                        { id: 1, name: '窑体效率', code: 'kiln_efficiency', category: '性能指标', direction: 'positive', unit: '%', calculationCycle: 'hour', updateFrequency: '1h', description: '回转窑运行效率，基于实际产量与设计产能的比值', formula: '[实际产量] / [设计产能] * 100', participatingVariables: ['实际产量', '设计产能'] },
                        { id: 2, name: '热效率', code: 'thermal_efficiency', category: '环保指标', direction: 'positive', unit: '%', calculationCycle: 'hour', updateFrequency: '1h', description: '回转窑热效率，反映能源利用效率', formula: '[有效热量] / [总热量] * 100', participatingVariables: ['有效热量', '总热量'] },
                        { id: 3, name: '燃料消耗率', code: 'fuel_consumption_rate', category: '环保指标', direction: 'negative', unit: 'kg/吨', calculationCycle: 'day', updateFrequency: '1d', description: '单位产品的燃料消耗量', formula: '[燃料消耗] / [产量]', participatingVariables: ['燃料消耗', '产量'] }
                    ], eventRules: [
                        { id: 1, name: '窑体温度超限', code: 'kiln_temp_over_limit', category: '安全告警', description: '窑体温度超过安全阈值时触发告警', triggerCondition: '窑体温度 > 1200', severity: 'high', enabled: true, actions: ['发送告警', '记录日志', '自动降温'], isEditing: false },
                        { id: 2, name: '转速异常检测', code: 'speed_abnormal', category: '运行监控', description: '窑体转速超出正常范围时触发事件', triggerCondition: '转速 < 0.5 OR 转速 > 3.0', severity: 'medium', enabled: true, actions: ['发送通知', '记录日志'], isEditing: false },
                        { id: 3, name: '燃料消耗异常', code: 'fuel_consumption_abnormal', category: '能耗监控', description: '燃料消耗异常时触发事件', triggerCondition: '燃料消耗 > 1000', severity: 'medium', enabled: true, actions: ['发送通知', '记录日志'], isEditing: false }
                    ], alarms: [
                        { id: 1, level: 'high', type: '窑体温度超限', description: '回转窑温度达到1250℃，超过安全阈值', alarmTime: '2024-01-18 15:20:30', triggerRule: '窑体温度超限', triggerRuleName: '窑体温度超限', triggerExpression: '窑体温度 > 1200', dataItems: [{ name: '窑体温度', value: '1250℃', dataSource: 'DCS.KILN_TEMP_001' }], isHandled: false, handler: '', status: 'active' },
                        { id: 2, level: 'medium', type: '转速异常', description: '窑体转速为3.5rpm，超出正常范围', alarmTime: '2024-01-17 14:15:45', triggerRule: '转速异常检测', triggerRuleName: '转速异常检测', triggerExpression: '转速 < 0.5 OR 转速 > 3.0', dataItems: [{ name: '转速', value: '3.5rpm', dataSource: 'DCS.SPEED_001' }], isHandled: true, handler: '李工程师', status: 'handled' },
                        { id: 3, level: 'medium', type: '燃料消耗异常', description: '燃料消耗达到1200kg/h，超出正常范围', alarmTime: '2024-01-18 13:30:20', triggerRule: '燃料消耗异常', triggerRuleName: '燃料消耗异常', triggerExpression: '燃料消耗 > 1000', dataItems: [{ name: '燃料消耗', value: '1200kg/h', dataSource: 'DCS.FUEL_001' }], isHandled: false, handler: '', status: 'active' },
                        { id: 4, level: 'low', type: '窑压异常', description: '窑内压力为-50Pa，低于正常范围', alarmTime: '2024-01-18 11:25:15', triggerRule: '窑压异常检测', triggerRuleName: '窑压异常检测', triggerExpression: '窑内压力 < -30', dataItems: [{ name: '窑内压力', value: '-50Pa', dataSource: 'DCS.KILN_PRESS_001' }], isHandled: false, handler: '', status: 'active' },
                        { id: 5, level: 'high', type: '氧气浓度异常', description: '窑尾氧气浓度达到8%，超过安全阈值', alarmTime: '2024-01-17 09:45:30', triggerRule: '氧气浓度告警', triggerRuleName: '氧气浓度告警', triggerExpression: '氧气浓度 > 5', dataItems: [{ name: '氧气浓度', value: '8%', dataSource: 'DCS.O2_001' }], isHandled: false, handler: '', status: 'active' }
                    ], videos: [
                        { id: 1, cameraAddress: 'rtsp://192.168.1.300:554/stream1', cameraNumber: 'CAM201', cameraName: '窑头监控' },
                        { id: 2, cameraAddress: 'rtsp://192.168.1.301:554/stream1', cameraNumber: 'CAM202', cameraName: '窑尾监控' },
                        { id: 3, cameraAddress: 'rtsp://192.168.1.302:554/stream1', cameraNumber: 'CAM203', cameraName: '窑体运行监控' }
                    ]},
                    { value: 'raw_material_bin_001', label: '原料仓', staticProperties: [
                        { name: '设备名称', code: 'device_name', type: '字符串', required: true, defaultValue: '' },
                        { name: '型号', code: 'model', type: '字符串', required: true, defaultValue: '' },
                        { name: '规格', code: 'specification', type: '字符串', required: true, defaultValue: '' },
                        { name: '供应商', code: 'supplier', type: '字符串', required: true, defaultValue: '' },
                        { name: '容量', code: 'capacity', type: '数值', required: false, defaultValue: '' },
                        { name: '材质', code: 'material', type: '字符串', required: false, defaultValue: '' }
                    ], dynamicVariables: [
                        { name: '料位高度', code: 'material_level', type: '数值', unit: 'm', precision: '0.01', frequency: '5秒', dataCategory: '产量', businessCategory: '生产', valueCycle: '5秒', valueMethod: '瞬时值', dataBinding: '', dataTransform: '', isEditing: false },
                        { name: '料仓温度', code: 'bin_temperature', type: '数值', unit: '℃', precision: '0.1', frequency: '10秒', dataCategory: '温度', businessCategory: '生产', valueCycle: '10秒', valueMethod: '瞬时值', dataBinding: '', dataTransform: '', isEditing: false },
                        { name: '湿度', code: 'humidity', type: '数值', unit: '%', precision: '0.1', frequency: '30秒', dataCategory: '运行', businessCategory: '生产', valueCycle: '30秒', valueMethod: '瞬时值', dataBinding: '', dataTransform: '', isEditing: false }
                    ], businessProperties: [
                        { name: '生产计划', code: 'production_plan', type: '字符串', required: false, defaultValue: '', dataSource: '' },
                        { name: '质量标准', code: 'quality_standard', type: '字符串', required: false, defaultValue: '', dataSource: '' },
                        { name: '维护计划', code: 'maintenance_plan', type: '字符串', required: false, defaultValue: '', dataSource: '' },
                        { name: '设备负责人', code: 'device_manager', type: '字符串', required: false, defaultValue: '', dataSource: '' },
                        { name: '采购成本', code: 'purchase_cost', type: '数值', required: false, defaultValue: '', dataSource: '' },
                        { name: '运营成本', code: 'operation_cost', type: '数值', required: false, defaultValue: '', dataSource: '' }
                    ], indicators: [
                        { id: 1, name: '料位利用率', code: 'material_level_utilization', category: '性能指标', direction: 'positive', unit: '%', calculationCycle: 'hour', updateFrequency: '1h', description: '料仓料位利用率，反映存储效率', formula: '[当前料位] / [最大料位] * 100', participatingVariables: ['当前料位', '最大料位'] },
                        { id: 2, name: '存储周转率', code: 'storage_turnover_rate', category: '经济指标', direction: 'positive', unit: '次/天', calculationCycle: 'day', updateFrequency: '1d', description: '原料存储周转率，反映库存管理效率', formula: '[出料量] / [平均库存]', participatingVariables: ['出料量', '平均库存'] }
                    ], eventRules: [
                        { id: 1, name: '料位低告警', code: 'material_level_low', category: '库存告警', description: '料位低于安全库存时触发告警', triggerCondition: '料位高度 < 1.0', severity: 'medium', enabled: true, actions: ['发送告警', '记录日志'], isEditing: false },
                        { id: 2, name: '料位高告警', code: 'material_level_high', category: '库存告警', description: '料位接近满仓时触发告警', triggerCondition: '料位高度 > 9.0', severity: 'medium', enabled: true, actions: ['发送告警', '记录日志'], isEditing: false },
                        { id: 3, name: '温度异常检测', code: 'temperature_abnormal', category: '安全监控', description: '料仓温度异常时触发事件', triggerCondition: '料仓温度 > 60', severity: 'high', enabled: true, actions: ['发送告警', '记录日志'], isEditing: false }
                    ], alarms: [
                        { id: 1, level: 'medium', type: '料位低告警', description: '原料仓料位高度为0.8m，低于安全库存', alarmTime: '2024-01-18 16:10:15', triggerRule: '料位低告警', triggerRuleName: '料位低告警', triggerExpression: '料位高度 < 1.0', dataItems: [{ name: '料位高度', value: '0.8m', dataSource: 'SCADA.LEVEL_001' }], isHandled: false, handler: '', status: 'active' },
                        { id: 2, level: 'high', type: '温度异常', description: '料仓温度达到65℃，超过安全阈值', alarmTime: '2024-01-17 15:45:30', triggerRule: '温度异常检测', triggerRuleName: '温度异常检测', triggerExpression: '料仓温度 > 60', dataItems: [{ name: '料仓温度', value: '65℃', dataSource: 'SCADA.TEMP_001' }], isHandled: true, handler: '王工程师', status: 'handled' },
                        { id: 3, level: 'low', type: '湿度异常', description: '料仓湿度达到85%，超过正常范围', alarmTime: '2024-01-18 14:20:45', triggerRule: '湿度异常检测', triggerRuleName: '湿度异常检测', triggerExpression: '湿度 > 80', dataItems: [{ name: '湿度', value: '85%', dataSource: 'SCADA.HUMIDITY_001' }], isHandled: false, handler: '', status: 'active' },
                        { id: 4, level: 'medium', type: '料位高告警', description: '原料仓料位高度为9.2m，接近满仓', alarmTime: '2024-01-17 10:30:20', triggerRule: '料位高告警', triggerRuleName: '料位高告警', triggerExpression: '料位高度 > 9.0', dataItems: [{ name: '料位高度', value: '9.2m', dataSource: 'SCADA.LEVEL_001' }], isHandled: false, handler: '', status: 'active' }
                    ], videos: [
                        { id: 1, cameraAddress: 'rtsp://192.168.1.400:554/stream1', cameraNumber: 'CAM301', cameraName: '原料仓入口监控' },
                        { id: 2, cameraAddress: 'rtsp://192.168.1.401:554/stream1', cameraNumber: 'CAM302', cameraName: '原料仓出口监控' },
                        { id: 3, cameraAddress: 'rtsp://192.168.1.402:554/stream1', cameraNumber: 'CAM303', cameraName: '原料仓顶部监控' }
                    ]},
                    { value: 'grate_cooler_001', label: '篦冷机', staticProperties: [
                        { name: '设备名称', code: 'device_name', type: '字符串', required: true, defaultValue: '' },
                        { name: '型号', code: 'model', type: '字符串', required: true, defaultValue: '' },
                        { name: '规格', code: 'specification', type: '字符串', required: true, defaultValue: '' },
                        { name: '供应商', code: 'supplier', type: '字符串', required: true, defaultValue: '' },
                        { name: '冷却能力', code: 'cooling_capacity', type: '数值', required: false, defaultValue: '' },
                        { name: '篦板数量', code: 'grate_plate_count', type: '数值', required: false, defaultValue: '' }
                    ], dynamicVariables: [
                        { name: '冷却水温度', code: 'cooling_water_temp', type: '数值', unit: '℃', precision: '0.1', frequency: '1秒', dataCategory: '温度', businessCategory: '生产', valueCycle: '1秒', valueMethod: '瞬时值', dataBinding: '', dataTransform: '', isEditing: false },
                        { name: '出料温度', code: 'discharge_temp', type: '数值', unit: '℃', precision: '0.1', frequency: '1秒', dataCategory: '温度', businessCategory: '生产', valueCycle: '1秒', valueMethod: '瞬时值', dataBinding: '', dataTransform: '', isEditing: false },
                        { name: '篦板速度', code: 'grate_speed', type: '数值', unit: 'm/min', precision: '0.01', frequency: '5秒', dataCategory: '运行', businessCategory: '生产', valueCycle: '5秒', valueMethod: '瞬时值', dataBinding: '', dataTransform: '', isEditing: false },
                        { name: '冷却效率', code: 'cooling_efficiency', type: '数值', unit: '%', precision: '0.1', frequency: '1分钟', dataCategory: '运转率', businessCategory: '生产', valueCycle: '1分钟', valueMethod: '平均值', dataBinding: '', dataTransform: '', isEditing: false }
                    ], businessProperties: [
                        { name: '生产计划', code: 'production_plan', type: '字符串', required: false, defaultValue: '', dataSource: '' },
                        { name: '质量标准', code: 'quality_standard', type: '字符串', required: false, defaultValue: '', dataSource: '' },
                        { name: '维护计划', code: 'maintenance_plan', type: '字符串', required: false, defaultValue: '', dataSource: '' },
                        { name: '设备负责人', code: 'device_manager', type: '字符串', required: false, defaultValue: '', dataSource: '' },
                        { name: '采购成本', code: 'purchase_cost', type: '数值', required: false, defaultValue: '', dataSource: '' },
                        { name: '运营成本', code: 'operation_cost', type: '数值', required: false, defaultValue: '', dataSource: '' }
                    ], indicators: [
                        { id: 1, name: '冷却效率', code: 'cooling_efficiency', category: '性能指标', direction: 'positive', unit: '%', calculationCycle: 'hour', updateFrequency: '1h', description: '篦冷机冷却效率，反映冷却效果', formula: '([进料温度] - [出料温度]) / [进料温度] * 100', participatingVariables: ['进料温度', '出料温度'] },
                        { id: 2, name: '冷却水利用率', code: 'cooling_water_utilization', category: '环保指标', direction: 'positive', unit: '%', calculationCycle: 'hour', updateFrequency: '1h', description: '冷却水利用效率', formula: '[有效冷却量] / [总冷却量] * 100', participatingVariables: ['有效冷却量', '总冷却量'] }
                    ], eventRules: [
                        { id: 1, name: '冷却水温度异常', code: 'cooling_water_temp_abnormal', category: '安全告警', description: '冷却水温度异常时触发告警', triggerCondition: '冷却水温度 > 50', severity: 'high', enabled: true, actions: ['发送告警', '记录日志'], isEditing: false },
                        { id: 2, name: '出料温度异常', code: 'discharge_temp_abnormal', category: '质量监控', description: '出料温度超出正常范围时触发事件', triggerCondition: '出料温度 > 100', severity: 'medium', enabled: true, actions: ['发送通知', '记录日志'], isEditing: false },
                        { id: 3, name: '篦板速度异常', code: 'grate_speed_abnormal', category: '运行监控', description: '篦板速度异常时触发事件', triggerCondition: '篦板速度 < 0.5 OR 篦板速度 > 5.0', severity: 'medium', enabled: true, actions: ['发送通知', '记录日志'], isEditing: false }
                    ], alarms: [
                        { id: 1, level: 'high', type: '冷却水温度异常', description: '冷却水温度达到55℃，超过安全阈值', alarmTime: '2024-01-18 17:05:20', triggerRule: '冷却水温度异常', triggerRuleName: '冷却水温度异常', triggerExpression: '冷却水温度 > 50', dataItems: [{ name: '冷却水温度', value: '55℃', dataSource: 'PLC.WATER_TEMP_001' }], isHandled: false, handler: '', status: 'active' },
                        { id: 2, level: 'medium', type: '出料温度异常', description: '出料温度为110℃，超出正常范围', alarmTime: '2024-01-17 16:30:45', triggerRule: '出料温度异常', triggerRuleName: '出料温度异常', triggerExpression: '出料温度 > 100', dataItems: [{ name: '出料温度', value: '110℃', dataSource: 'PLC.DISCHARGE_TEMP_001' }], isHandled: true, handler: '赵工程师', status: 'handled' },
                        { id: 3, level: 'low', type: '篦板速度异常', description: '篦板速度为5.5m/min，超出正常范围', alarmTime: '2024-01-18 13:15:30', triggerRule: '篦板速度异常', triggerRuleName: '篦板速度异常', triggerExpression: '篦板速度 > 5.0', dataItems: [{ name: '篦板速度', value: '5.5m/min', dataSource: 'PLC.GRATE_SPEED_001' }], isHandled: false, handler: '', status: 'active' },
                        { id: 4, level: 'medium', type: '冷却效率异常', description: '冷却效率为65%，低于正常范围', alarmTime: '2024-01-17 12:45:15', triggerRule: '冷却效率异常', triggerRuleName: '冷却效率异常', triggerExpression: '冷却效率 < 70', dataItems: [{ name: '冷却效率', value: '65%', dataSource: 'PLC.COOLING_EFF_001' }], isHandled: false, handler: '', status: 'active' }
                    ], videos: [
                        { id: 1, cameraAddress: 'rtsp://192.168.1.500:554/stream1', cameraNumber: 'CAM401', cameraName: '篦冷机入口监控' },
                        { id: 2, cameraAddress: 'rtsp://192.168.1.501:554/stream1', cameraNumber: 'CAM402', cameraName: '篦冷机出口监控' },
                        { id: 3, cameraAddress: 'rtsp://192.168.1.502:554/stream1', cameraNumber: 'CAM403', cameraName: '篦冷机运行监控' }
                    ]},
                    { value: 'cement_bin_001', label: '水泥仓', staticProperties: [
                        { name: '设备名称', code: 'device_name', type: '字符串', required: true, defaultValue: '' },
                        { name: '型号', code: 'model', type: '字符串', required: true, defaultValue: '' },
                        { name: '规格', code: 'specification', type: '字符串', required: true, defaultValue: '' },
                        { name: '供应商', code: 'supplier', type: '字符串', required: true, defaultValue: '' },
                        { name: '容量', code: 'capacity', type: '数值', required: false, defaultValue: '' },
                        { name: '材质', code: 'material', type: '字符串', required: false, defaultValue: '' }
                    ], dynamicVariables: [
                        { name: '料位高度', code: 'material_level', type: '数值', unit: 'm', precision: '0.01', frequency: '5秒', dataCategory: '产量', businessCategory: '生产', valueCycle: '5秒', valueMethod: '瞬时值', dataBinding: '', dataTransform: '', isEditing: false },
                        { name: '仓内温度', code: 'bin_temperature', type: '数值', unit: '℃', precision: '0.1', frequency: '10秒', dataCategory: '温度', businessCategory: '生产', valueCycle: '10秒', valueMethod: '瞬时值', dataBinding: '', dataTransform: '', isEditing: false },
                        { name: '湿度', code: 'humidity', type: '数值', unit: '%', precision: '0.1', frequency: '30秒', dataCategory: '运行', businessCategory: '生产', valueCycle: '30秒', valueMethod: '瞬时值', dataBinding: '', dataTransform: '', isEditing: false }
                    ], businessProperties: [
                        { name: '生产计划', code: 'production_plan', type: '字符串', required: false, defaultValue: '', dataSource: '' },
                        { name: '质量标准', code: 'quality_standard', type: '字符串', required: false, defaultValue: '', dataSource: '' },
                        { name: '维护计划', code: 'maintenance_plan', type: '字符串', required: false, defaultValue: '', dataSource: '' },
                        { name: '设备负责人', code: 'device_manager', type: '字符串', required: false, defaultValue: '', dataSource: '' },
                        { name: '采购成本', code: 'purchase_cost', type: '数值', required: false, defaultValue: '', dataSource: '' },
                        { name: '运营成本', code: 'operation_cost', type: '数值', required: false, defaultValue: '', dataSource: '' }
                    ], indicators: [
                        { id: 1, name: '库存周转率', code: 'inventory_turnover_rate', category: '经济指标', direction: 'positive', unit: '次/天', calculationCycle: 'day', updateFrequency: '1d', description: '水泥库存周转率，反映销售效率', formula: '[出库量] / [平均库存]', participatingVariables: ['出库量', '平均库存'] },
                        { id: 2, name: '存储效率', code: 'storage_efficiency', category: '性能指标', direction: 'positive', unit: '%', calculationCycle: 'hour', updateFrequency: '1h', description: '水泥仓存储效率', formula: '[当前库存] / [最大容量] * 100', participatingVariables: ['当前库存', '最大容量'] }
                    ], eventRules: [
                        { id: 1, name: '库存低告警', code: 'inventory_low', category: '库存告警', description: '水泥库存低于安全库存时触发告警', triggerCondition: '料位高度 < 1.0', severity: 'medium', enabled: true, actions: ['发送告警', '记录日志'], isEditing: false },
                        { id: 2, name: '库存满告警', code: 'inventory_full', category: '库存告警', description: '水泥库存接近满仓时触发告警', triggerCondition: '料位高度 > 9.0', severity: 'medium', enabled: true, actions: ['发送告警', '记录日志'], isEditing: false },
                        { id: 3, name: '湿度异常检测', code: 'humidity_abnormal', category: '质量监控', description: '水泥仓湿度异常时触发事件', triggerCondition: '湿度 > 80', severity: 'high', enabled: true, actions: ['发送告警', '记录日志'], isEditing: false }
                    ], alarms: [
                        { id: 1, level: 'medium', type: '库存低告警', description: '水泥仓料位高度为0.9m，低于安全库存', alarmTime: '2024-01-18 18:20:10', triggerRule: '库存低告警', triggerRuleName: '库存低告警', triggerExpression: '料位高度 < 1.0', dataItems: [{ name: '料位高度', value: '0.9m', dataSource: 'SCADA.LEVEL_002' }], isHandled: false, handler: '', status: 'active' },
                        { id: 2, level: 'high', type: '湿度异常', description: '水泥仓湿度达到85%，超过安全阈值', alarmTime: '2024-01-17 17:55:30', triggerRule: '湿度异常检测', triggerRuleName: '湿度异常检测', triggerExpression: '湿度 > 80', dataItems: [{ name: '湿度', value: '85%', dataSource: 'SCADA.HUMIDITY_001' }], isHandled: true, handler: '陈工程师', status: 'handled' },
                        { id: 3, level: 'low', type: '温度异常', description: '水泥仓温度达到45℃，超过正常范围', alarmTime: '2024-01-18 15:30:25', triggerRule: '温度异常检测', triggerRuleName: '温度异常检测', triggerExpression: '温度 > 40', dataItems: [{ name: '温度', value: '45℃', dataSource: 'SCADA.TEMP_002' }], isHandled: false, handler: '', status: 'active' },
                        { id: 4, level: 'medium', type: '库存满告警', description: '水泥仓料位高度为9.1m，接近满仓', alarmTime: '2024-01-17 14:15:40', triggerRule: '库存满告警', triggerRuleName: '库存满告警', triggerExpression: '料位高度 > 9.0', dataItems: [{ name: '料位高度', value: '9.1m', dataSource: 'SCADA.LEVEL_002' }], isHandled: false, handler: '', status: 'active' }
                    ], videos: [
                        { id: 1, cameraAddress: 'rtsp://192.168.1.100:554/stream1', cameraNumber: 'CAM001', cameraName: '水泥仓入口监控' },
                        { id: 2, cameraAddress: 'rtsp://192.168.1.101:554/stream1', cameraNumber: 'CAM002', cameraName: '水泥仓出口监控' },
                        { id: 3, cameraAddress: 'rtsp://192.168.1.102:554/stream1', cameraNumber: 'CAM003', cameraName: '水泥仓顶部监控' }
                    ]}
                ],
                activeTab: 'basicInfo',
                
                // 指标管理相关数据
                indicatorDrawerVisible: false,
                variableSelectorVisible: false,
                indicatorConfigDrawerVisible: false,
                indicatorForm: {
                    id: null,
                    name: '',
                    code: '',
                    category: '',
                    direction: '',
                    unit: '',
                    calculationCycle: '',
                    updateFrequency: '',
                    participatingVariables: [],
                    formula: '',
                    description: ''
                },
                indicatorRules: {
                    name: [{ required: true, message: '请输入指标名称', trigger: 'blur' }],
                    code: [{ required: true, message: '请输入指标编码', trigger: 'blur' }],
                    category: [{ required: true, message: '请选择指标分类', trigger: 'change' }],
                    direction: [{ required: true, message: '请选择指标方向', trigger: 'change' }],
                    calculationCycle: [{ required: true, message: '请选择计算周期', trigger: 'change' }],
                    updateFrequency: [{ required: true, message: '请选择更新频率', trigger: 'change' }],
                    formula: [{ required: true, message: '请输入计算公式', trigger: 'blur' }]
                },
                indicatorFilter: {
                    category: '',
                    direction: '',
                    keyword: ''
                },
                selectedIndicators: [],
                indicatorPagination: {
                    currentPage: 1,
                    pageSize: 10
                },
                isIndicatorEditMode: false,
                isIndicatorViewMode: false,
                isFormulaDragOver: false,
                formulaStatus: '',
                formulaStatusClass: '',
                
                // 指标配置相关数据
                indicatorConfigForm: {
                    activeTab: 'collection',
                    selectedData: [],
                    formula: '',
                    // 采集参数搜索条件
                    collectionVariableName: '',
                    collectionVariableCode: '',
                    // 业务属性搜索条件
                    businessPropertyName: '',
                    businessPropertyCode: '',
                    // 指标搜索条件
                    indicatorName: '',
                    indicatorCode: ''
                },
                
                // 指标配置公式输入相关
                indicatorConfigFormulaInputMode: 'expression',
                indicatorConfigNaturalLanguageInput: '',
                indicatorConfigIsTranslating: false,
                indicatorConfigTranslatedExpression: '',
                indicatorConfigVisualFormulaParts: [],
                indicatorConfigSelectedBlockIndex: -1,
                indicatorConfigNumberInput: '',
                
                // 当前配置的指标
                currentConfigIndicator: null,
                

                
                // 编辑模式相关
                isEditMode: false,
                isReadOnly: true,

                // 数据绑定和数据转换配置相关
                currentConfigVariable: null,
                configType: '',
                dataBindingDrawerVisible: false,
                dataTransformDrawerVisible: false,
                
                // 数据绑定表单
                dataBindingForm: {
                    dataSource: '',
                    pointName: '',
                    pointCode: '',
                    selectedPoints: [],
                    formula: ''
                },

                // 业务属性数据绑定表单
                businessPropertyDataBindingForm: {
                    dataSource: 'REST_API',
                    pointName: '',
                    pointCode: '',
                    selectedPoints: [],
                    formula: ''
                },
                
                // 数据源列表
                dataSources: [
                    { value: 'DCS', label: 'DCS系统' },
                    { value: 'SCADA', label: 'SCADA系统' },
                    { value: 'PLC', label: 'PLC系统' },
                    { value: 'RTU', label: 'RTU设备' },
                    { value: 'OPC', label: 'OPC服务器' },
                    { value: 'MODBUS', label: 'Modbus设备' },
                    { value: 'REST_API', label: 'REST API' }
                ],
                
                // 视频管理相关数据
                selectedVideos: [],
                videoList: [],
                
                // 数据点位列表
                dataPoints: [
                    { name: '温度传感器1', code: 'TEMP_001', dataSource: 'DCS', dataType: 'Float', unit: '°C', description: '窑头温度传感器' },
                    { name: '压力传感器1', code: 'PRESS_001', dataSource: 'DCS', dataType: 'Float', unit: 'MPa', description: '窑头压力传感器' },
                    { name: '流量计1', code: 'FLOW_001', dataSource: 'SCADA', dataType: 'Float', unit: 'm³/h', description: '原料流量计' },
                    { name: '振动传感器1', code: 'VIB_001', dataSource: 'PLC', dataType: 'Float', unit: 'mm/s', description: '电机振动传感器' },
                    { name: '电流传感器1', code: 'CURRENT_001', dataSource: 'RTU', dataType: 'Float', unit: 'A', description: '主电机电流' },
                    { name: '电压传感器1', code: 'VOLTAGE_001', dataSource: 'RTU', dataType: 'Float', unit: 'V', description: '主电机电压' },
                    { name: '转速传感器1', code: 'SPEED_001', dataSource: 'OPC', dataType: 'Int', unit: 'rpm', description: '风机转速' },
                    { name: '液位传感器1', code: 'LEVEL_001', dataSource: 'MODBUS', dataType: 'Float', unit: 'm', description: '水箱液位' },
                    { name: '湿度传感器1', code: 'HUMIDITY_001', dataSource: 'DCS', dataType: 'Float', unit: '%', description: '环境湿度传感器' },
                    { name: '粉尘传感器1', code: 'DUST_001', dataSource: 'SCADA', dataType: 'Float', unit: 'mg/m³', description: '粉尘浓度传感器' }
                ],
                
                // 过滤后的数据点位
                filteredDataPoints: [],

                // 数据点位批量新增相关
                dataPointBatchAddDrawerVisible: false,
                dataPointSearchKeyword: '',
                dataPointSearchDataSource: '',
                dataPointSearchType: '',
                selectedDataPoints: [],
                selectedEventRules: [],

                // 事件规则配置相关
                eventRuleConfigDrawerVisible: false,
                currentConfigEventRule: null,

                // 告警相关
                alarmDetailDrawerVisible: false,
                currentAlarm: null,
                alarmSearchKeyword: '',
                alarmSearchLevel: '',
                alarmSearchStatus: 'unhandled',
                alarmSearchTimeRange: 'all',
                
                // 运算符列表
                operators: [
                    // 算术运算符
                    '+', '-', '*', '/', '(', ')', '=', '%', '**',
                    // 逻辑运算符
                    'and', 'or', '!', '==', '!=', '>', '<', '>=', '<=',
                    // 条件运算符
                    'if', 'then', 'else'
                ],
                
                // 分组运算符
                arithmeticOperators: ['+', '-', '*', '/', '(', ')', '=', '%', '**'],
                logicalOperators: ['and', 'or', '!', '==', '!=', '>', '<', '>=', '<='],
                conditionalOperators: ['if', 'then', 'else'],
                
                // 公式输入模式相关
                formulaInputMode: 'visual', // 默认使用可视化输入
                naturalLanguageInput: '',
                isTranslating: false,
                translatedExpression: '',
                visualFormulaParts: [], // 可视化输入的公式部分
                numberInput: '', // 数字输入
                selectedBlockIndex: -1 // 选中的公式块索引
            },
            
            computed: {
                // 获取选中的资产类型
                selectedAssetType() {
                    if (!this.assetForm.assetType) {
                        return null;
                    }
                    return this.assetTypes.find(type => type.value === this.assetForm.assetType);
                },
                // 计算属性：过滤后的节点
                visibleNodes() {
                    if (this.searchKeyword) {
                        return this.filterNodes();
                    }
                    return this.getVisibleNodes(this.treeData);
                },
                
                // 可视化公式显示
                visualFormulaDisplay() {
                    if (this.visualFormulaParts.length === 0) {
                        return '请双击变量或点击运算符来构建公式';
                    }
                    return this.visualFormulaParts.map(part => {
                        if (part.type === 'variable') {
                            return `[${part.dataSource}].[${part.name}]`;
                        } else if (part.type === 'operator') {
                            return part.value;
                        } else if (part.type === 'number') {
                            return part.value;
                        }
                        return part.value;
                    }).join(' ');
                },

                // 已处理告警数量
                handledAlarmsCount() {
                    if (!this.selectedAssetType || !this.selectedAssetType.alarms) {
                        return 0;
                    }
                    return this.selectedAssetType.alarms.filter(alarm => alarm.isHandled).length;
                },

                // 待处理告警数量
                unhandledAlarmsCount() {
                    if (!this.selectedAssetType || !this.selectedAssetType.alarms) {
                        return 0;
                    }
                    const count = this.selectedAssetType.alarms.filter(alarm => !alarm.isHandled).length;
                    return count > 99 ? '99+' : count.toString();
                },



                // 基础信息页签标签
                basicInfoTabLabel() {
                    let label = '基础信息';
                    if (!this.assetForm.assetType || !this.assetForm.deviceCode || !this.assetForm.deviceName) {
                        label = `${label} ⚠️`;
                    }
                    return label;
                },

                // 采集参数页签标签
                collectionParamsTabLabel() {
                    return '采集参数';
                },

                // 业务属性页签标签
                businessPropertiesTabLabel() {
                    return '业务属性';
                },

                // 指标页签标签
                metricsTabLabel() {
                    return '指标';
                },

                // 事件规则页签标签
                eventRulesTabLabel() {
                    return '事件规则';
                },

                // 告警页签标签
                alarmsTabLabel() {
                    return '告警';
                },

                // 视频页签标签
                videoTabLabel() {
                    return '视频';
                },

                // 当前资产类型
                currentAssetType() {
                    if (!this.nodeForm.type) return '';
                    const nodeTypeConfig = this.nodeTypes.find(type => type.value === this.nodeForm.type);
                    return nodeTypeConfig ? nodeTypeConfig.assetType : '';
                },

                // 当前允许子节点类型
                currentAllowedChildTypes() {
                    if (!this.nodeForm.type) return '';
                    const nodeTypeConfig = this.nodeTypes.find(type => type.value === this.nodeForm.type);
                    if (!nodeTypeConfig || !nodeTypeConfig.allowedChildTypes || nodeTypeConfig.allowedChildTypes.length === 0) {
                        return '无';
                    }
                    return nodeTypeConfig.allowedChildTypes.join('、');
                },

                // 可用的节点类型
                availableNodeTypes() {
                    if (this.nodeDialogMode === 'add') {
                        // 添加子节点时，根据父节点类型确定可选的子节点类型
                        if (this.currentParentNode) {
                            const parentTypeConfig = this.nodeTypes.find(type => type.value === this.currentParentNode.type);
                            if (parentTypeConfig && parentTypeConfig.allowedChildTypes && parentTypeConfig.allowedChildTypes.length > 0) {
                                return this.nodeTypes.filter(type => 
                                    parentTypeConfig.allowedChildTypes.includes(type.value)
                                );
                            }
                            return [];
                        }
                        // 添加根节点时，返回所有类型
                        return this.nodeTypes;
                    } else if (this.nodeDialogMode === 'edit') {
                        // 编辑节点时，根据上级节点类型确定可选的节点类型
                        const parentNode = this.findParentNodeInComputed(this.selectedNode);
                        if (parentNode) {
                            const parentTypeConfig = this.nodeTypes.find(type => type.value === parentNode.type);
                            if (parentTypeConfig && parentTypeConfig.allowedChildTypes && parentTypeConfig.allowedChildTypes.length > 0) {
                                return this.nodeTypes.filter(type => 
                                    parentTypeConfig.allowedChildTypes.includes(type.value)
                                );
                            }
                            return [];
                        }
                        // 如果是根节点，返回所有类型
                        return this.nodeTypes;
                    } else {
                        // 查看模式，返回所有类型
                        return this.nodeTypes;
                    }
                },



                // 获取当前资产类型的视频列表
                currentAssetTypeVideos() {
                    if (!this.selectedAssetType || !this.selectedAssetType.videos) {
                        return [];
                    }
                    return this.selectedAssetType.videos;
                },

                // 过滤后的告警列表
                filteredAlarms() {
                    if (!this.selectedAssetType || !this.selectedAssetType.alarms) {
                        return [];
                    }

                    let alarms = [...this.selectedAssetType.alarms];

                    // 关键词过滤
                    if (this.alarmSearchKeyword) {
                        const keyword = this.alarmSearchKeyword.toLowerCase();
                        alarms = alarms.filter(alarm => 
                            alarm.type.toLowerCase().includes(keyword) ||
                            alarm.description.toLowerCase().includes(keyword) ||
                            alarm.triggerRule.toLowerCase().includes(keyword)
                        );
                    }

                    // 告警级别过滤
                    if (this.alarmSearchLevel) {
                        alarms = alarms.filter(alarm => alarm.level === this.alarmSearchLevel);
                    }

                    // 处理状态过滤
                    if (this.alarmSearchStatus === 'unhandled') {
                        alarms = alarms.filter(alarm => !alarm.isHandled);
                    } else if (this.alarmSearchStatus === 'handled') {
                        alarms = alarms.filter(alarm => alarm.isHandled);
                    }

                    // 时间范围过滤
                    if (this.alarmSearchTimeRange !== 'all') {
                        const now = new Date();
                        const days = parseInt(this.alarmSearchTimeRange.replace('days', '').replace('day', ''));
                        const timeLimit = new Date(now.getTime() - days * 24 * 60 * 60 * 1000);
                        
                        alarms = alarms.filter(alarm => {
                            const alarmTime = new Date(alarm.alarmTime);
                            return alarmTime >= timeLimit;
                        });
                    }

                    return alarms;
                },
                
                // 获取当前资产类型的指标列表
                currentAssetTypeIndicators() {
                    if (!this.selectedAssetType || !this.selectedAssetType.indicators) {
                        return [];
                    }
                    return this.selectedAssetType.indicators;
                },
                
                // 过滤后的指标列表
                filteredIndicators() {
                    let indicators = this.currentAssetTypeIndicators;
                    
                    // 按分类过滤
                    if (this.indicatorFilter.category) {
                        indicators = indicators.filter(indicator => 
                            indicator.category === this.indicatorFilter.category
                        );
                    }
                    
                    // 按方向过滤
                    if (this.indicatorFilter.direction) {
                        indicators = indicators.filter(indicator => 
                            indicator.direction === this.indicatorFilter.direction
                        );
                    }
                    
                    // 按关键词过滤
                    if (this.indicatorFilter.keyword) {
                        const keyword = this.indicatorFilter.keyword.toLowerCase();
                        indicators = indicators.filter(indicator => 
                            indicator.name.toLowerCase().includes(keyword) ||
                            indicator.code.toLowerCase().includes(keyword)
                        );
                    }
                    
                    return indicators;
                },
                
                // 获取可用变量列表（用于指标公式编辑）
                availableVariables() {
                    if (!this.selectedAssetType) {
                        return [];
                    }
                    
                    const variables = [];
                    
                    // 添加动态变量
                    if (this.selectedAssetType.dynamicVariables) {
                        this.selectedAssetType.dynamicVariables.forEach(variable => {
                            variables.push({
                                name: variable.name,
                                code: variable.code,
                                type: 'dynamic',
                                unit: variable.unit
                            });
                        });
                    }
                    
                    // 添加静态属性
                    if (this.selectedAssetType.staticProperties) {
                        this.selectedAssetType.staticProperties.forEach(property => {
                            variables.push({
                                name: property.name,
                                code: property.code,
                                type: 'static',
                                unit: ''
                            });
                        });
                    }
                    
                    // 添加业务属性
                    if (this.selectedAssetType.businessProperties) {
                        this.selectedAssetType.businessProperties.forEach(property => {
                            variables.push({
                                name: property.name,
                                code: property.code,
                                type: 'business',
                                unit: ''
                            });
                        });
                    }
                    
                    return variables;
                },
                
                // 指标抽屉标题
                indicatorDrawerTitle() {
                    if (this.isIndicatorViewMode) {
                        return '查看指标';
                    } else if (this.isIndicatorEditMode) {
                        return '编辑指标';
                    } else {
                        return '新增指标';
                    }
                },
                
                // 指标保存按钮文本
                indicatorSaveButtonText() {
                    if (this.isIndicatorViewMode) {
                        return '关闭';
                    } else {
                        return '保存';
                    }
                },
                
                // 格式化的公式显示
                formattedFormula() {
                    if (!this.indicatorForm.formula) {
                        return '';
                    }
                    
                    let formula = this.indicatorForm.formula;
                    
                    // 为变量添加高亮样式
                    this.indicatorForm.participatingVariables.forEach(variable => {
                        const regex = new RegExp(`\\[${variable}\\]`, 'g');
                        formula = formula.replace(regex, `<span class="variable-badge">[${variable}]</span>`);
                    });
                    
                    return formula;
                },
                
                // 指标配置相关计算属性
                filteredCollectionVariables() {
                    if (!this.selectedAssetType || !this.selectedAssetType.dynamicVariables) {
                        return [];
                    }
                    
                    let variables = this.selectedAssetType.dynamicVariables;
                    
                    if (this.indicatorConfigForm.collectionVariableName) {
                        variables = variables.filter(variable => 
                            variable.name.toLowerCase().includes(this.indicatorConfigForm.collectionVariableName.toLowerCase())
                        );
                    }
                    
                    if (this.indicatorConfigForm.collectionVariableCode) {
                        variables = variables.filter(variable => 
                            variable.code.toLowerCase().includes(this.indicatorConfigForm.collectionVariableCode.toLowerCase())
                        );
                    }
                    
                    return variables;
                },
                
                filteredBusinessProperties() {
                    if (!this.selectedAssetType || !this.selectedAssetType.businessProperties) {
                        return [];
                    }
                    
                    let properties = this.selectedAssetType.businessProperties;
                    
                    if (this.indicatorConfigForm.businessPropertyName) {
                        properties = properties.filter(prop => 
                            prop.name.toLowerCase().includes(this.indicatorConfigForm.businessPropertyName.toLowerCase())
                        );
                    }
                    
                    if (this.indicatorConfigForm.businessPropertyCode) {
                        properties = properties.filter(prop => 
                            prop.code.toLowerCase().includes(this.indicatorConfigForm.businessPropertyCode.toLowerCase())
                        );
                    }
                    
                    return properties;
                },
                
                filteredConfigIndicators() {
                    if (!this.selectedAssetType || !this.selectedAssetType.indicators) {
                        return [];
                    }
                    
                    let indicators = this.selectedAssetType.indicators;
                    
                    if (this.indicatorConfigForm.indicatorName) {
                        indicators = indicators.filter(indicator => 
                            indicator.name.toLowerCase().includes(this.indicatorConfigForm.indicatorName.toLowerCase())
                        );
                    }
                    
                    if (this.indicatorConfigForm.indicatorCode) {
                        indicators = indicators.filter(indicator => 
                            indicator.code.toLowerCase().includes(this.indicatorConfigForm.indicatorCode.toLowerCase())
                        );
                    }
                    
                    return indicators;
                },
                

            },
            mounted() {
                // 初始化过滤后的数据点位列表
                this.filteredDataPoints = [...this.dataPoints];
                
                // 设置默认资产类型（如果还没有选择的话）
                if (!this.assetForm.assetType && this.assetTypes.length > 0) {
                    this.assetForm.assetType = this.assetTypes[0].value;
                }
                
                // 初始化告警检索条件
                this.alarmSearchStatus = 'unhandled';
                this.alarmSearchTimeRange = 'all';

                // 初始化页签样式
                this.$nextTick(() => {
                    if (this.updateTabStyles) {
                        this.updateTabStyles();
                    }
                });
            },
            watch: {
                // 监听搜索关键词变化
                searchKeyword(val) {
                    this.filterNodes();
                },
                
                // 监听资产类型变化，重置静态属性值
                'assetForm.assetType'(newType) {
                    if (newType && this.selectedAssetType && this.selectedAssetType.staticProperties) {
                        // 重置静态属性的默认值
                        this.selectedAssetType.staticProperties.forEach(property => {
                            property.defaultValue = '';
                        });
                    }
                    this.$nextTick(() => {
                        if (this.updateTabStyles) {
                            this.updateTabStyles();
                        }
                    });
                },

                // 监听表单数据变化，更新页签样式
                'assetForm.deviceCode'() {
                    this.$nextTick(() => {
                        if (this.updateTabStyles) {
                            this.updateTabStyles();
                        }
                    });
                },
                'assetForm.deviceName'() {
                    this.$nextTick(() => {
                        if (this.updateTabStyles) {
                            this.updateTabStyles();
                        }
                    });
                },
                'selectedAssetType.staticProperties': {
                    handler() {
                        this.$nextTick(() => {
                            if (this.updateTabStyles) {
                                this.updateTabStyles();
                            }
                        });
                    },
                    deep: true
                },

                // 监听资产类型变化，更新视频列表
                'assetForm.assetType'(newType) {
                    if (newType && this.selectedAssetType && this.selectedAssetType.videos) {
                        this.videoList = [...this.selectedAssetType.videos];
                    } else {
                        this.videoList = [];
                    }
                },
                

            },
            methods: {
                // 在computed中查找父节点的辅助方法
                findParentNodeInComputed(node) {
                    if (!node) return null;
                    
                    const findParent = (nodes, targetNode) => {
                        for (let n of nodes) {
                            if (n.children) {
                                for (let child of n.children) {
                                    if (child.id === targetNode.id) {
                                        return n;
                                    }
                                }
                                const found = findParent(n.children, targetNode);
                                if (found) return found;
                            }
                        }
                        return null;
                    };
                    
                    return findParent(this.treeData, node);
                },

                // 保存模型
                saveModel() {
                    this.$message.success('模型保存成功');
                },
                
                // 导出模型
                exportModel() {
                    this.$message.info('导出功能开发中...');
                },
                
                // 切换模型状态
                toggleModelStatus() {
                    if (this.modelInfo.status === 'enabled') {
                        this.modelInfo.status = 'disabled';
                        this.$message.success('模型已禁用');
                    } else if (this.modelInfo.status === 'disabled') {
                        this.modelInfo.status = 'enabled';
                        this.$message.success('模型已启用');
                    } else if (this.modelInfo.status === 'draft') {
                        this.modelInfo.status = 'enabled';
                        this.$message.success('草稿模型已启用');
                    }
                },
                
                // 返回列表
                backToList() {
                    // 跳转到工厂模型列表页面
                    window.location.href = 'factory-model-list.html';
                },

                // 更新页签样式
                updateTabStyles() {
                    this.$nextTick(() => {
                        const tabItems = document.querySelectorAll('.el-tabs__item');
                        tabItems.forEach((item, index) => {
                            // 移除之前的警告样式
                            item.classList.remove('has-warning');
                            
                            // 检查是否是基础信息页签且有验证错误
                            if (index === 0 && (!this.assetForm.assetType || !this.assetForm.deviceCode || !this.assetForm.deviceName)) {
                                item.classList.add('has-warning');
                            }
                        });
                    });
                },
                

                
                // 切换基本信息展开状态
                toggleBasicInfo() {
                    console.log('切换基本信息展开状态，当前状态:', this.basicInfoExpanded);
                    this.basicInfoExpanded = !this.basicInfoExpanded;
                    console.log('切换后状态:', this.basicInfoExpanded);
                },
                
                    // 切换节点详情基本信息展开状态
    toggleNodeDetailsBasicInfo() {
        this.nodeDetailsBasicInfoExpanded = !this.nodeDetailsBasicInfoExpanded;
    },
    
    // 资产搜索和过滤相关方法
    searchAssets() {
        if (!this.selectedNode) {
            this.filteredAssets = [];
            return;
        }
        
        // 获取当前节点及下级所有节点的资产
        const allAssets = this.getAllAssetsFromNode(this.selectedNode);
        
        const keyword = this.assetSearchKeyword.toLowerCase().trim();
        if (!keyword) {
            this.filteredAssets = allAssets;
            return;
        }
        
        this.filteredAssets = allAssets.filter(asset => {
            if (this.assetSearchField === 'isConnected') {
                // 处理是否接入字段的搜索
                const isConnected = asset.isConnected;
                const searchText = isConnected ? '已接入' : '未接入';
                return searchText.includes(keyword);
            } else {
                const searchValue = asset[this.assetSearchField] || '';
                return searchValue.toLowerCase().includes(keyword);
            }
        });
    },

    // 获取节点及下级所有节点的资产
    getAllAssetsFromNode(node) {
        let assets = [];
        
        // 添加当前节点的资产
        if (node.assets && node.assets.length > 0) {
            assets = assets.concat(node.assets.map(asset => ({
                ...asset,
                nodeLevel: node.level,
                nodeName: node.name,
                nodePath: this.getNodePath(node)
            })));
        }
        
        // 递归添加子节点的资产
        if (node.children && node.children.length > 0) {
            node.children.forEach(child => {
                assets = assets.concat(this.getAllAssetsFromNode(child));
            });
        }
        
        return assets;
    },

    // 获取节点路径
    getNodePath(node) {
        const path = [];
        let currentNode = node;
        
        while (currentNode) {
            path.unshift(currentNode.name);
            currentNode = this.findParentNode(currentNode);
        }
        
        return path.join(' / ');
    },
    
    // 切换搜索字段
    changeSearchField(field) {
        this.assetSearchField = field;
        this.searchAssets();
    },
    
    // 清空搜索
    clearAssetSearch() {
        this.assetSearchKeyword = '';
        this.assetSearchField = 'name';
        this.searchAssets();
    },
                
                // 添加根节点
                addRootNode() {
                    this.openNodeDialog('add', null);
                },

                // 挂载资产
                mountAsset() {
                    if (!this.selectedNode) {
                        this.$message.warning('请先选择一个节点');
                        return;
                    }
                    this.$message.info('挂载资产功能开发中...');
                },

                // 检查是否有未保存的数据
                hasUnsavedData() {
                    // 检查是否在添加或编辑资产状态（查看模式不需要检查）
                    if (this.isAddingAsset || this.isEditingAsset) {
                        // 如果是添加模式，检查是否有填写的数据
                        if (this.isAddingAsset) {
                            return this.assetForm.assetType || 
                                   this.assetForm.deviceCode || 
                                   this.assetForm.deviceName ||
                                   this.assetForm.connectionStatus !== '待接入' ||
                                   this.assetForm.runningStatus !== '-';
                        }
                        // 如果是编辑模式，检查数据是否有变化
                        if (this.isEditingAsset && this.currentEditingAsset) {
                            return this.assetForm.assetType !== this.currentEditingAsset.type ||
                                   this.assetForm.deviceCode !== this.currentEditingAsset.code ||
                                   this.assetForm.deviceName !== this.currentEditingAsset.name ||
                                   this.assetForm.connectionStatus !== (this.currentEditingAsset.isConnected ? '已接入' : '待接入') ||
                                   this.assetForm.runningStatus !== this.currentEditingAsset.status;
                        }
                    }

                    // 检查静态属性、动态变量、业务属性、指标是否有正在编辑的行
                    if (this.selectedAssetType) {
                        // 检查静态属性
                        if (this.selectedAssetType.staticProperties) {
                            for (let prop of this.selectedAssetType.staticProperties) {
                                if (prop.isEditing) return true;
                            }
                        }
                        
                        // 检查动态变量
                        if (this.selectedAssetType.dynamicVariables) {
                            for (let variable of this.selectedAssetType.dynamicVariables) {
                                if (variable.isEditing) return true;
                            }
                        }
                        
                        // 检查业务属性
                        if (this.selectedAssetType.businessProperties) {
                            for (let prop of this.selectedAssetType.businessProperties) {
                                if (prop.isEditing) return true;
                            }
                        }
                        
                        // 检查指标
                        if (this.selectedAssetType.indicators) {
                            for (let indicator of this.selectedAssetType.indicators) {
                                if (indicator.isEditing) return true;
                            }
                        }

                        // 检查事件规则
                        if (this.selectedAssetType.eventRules) {
                            for (let rule of this.selectedAssetType.eventRules) {
                                if (rule.isEditing) return true;
                            }
                        }
                    }
                    
                    return false;
                },

                // 获取未保存数据的提示信息
                getUnsavedDataMessage() {
                    if (this.isAddingAsset) {
                        return '当前正在添加资产，切换节点将丢失已填写的数据。确定要切换吗？';
                    } else if (this.isEditingAsset) {
                        return '当前正在编辑资产，切换节点将丢失未保存的修改。确定要切换吗？';
                    } else {
                        return '当前有未保存的数据，切换节点将丢失这些数据。确定要切换吗？';
                    }
                },

                // 节点点击处理
                selectNode(node) {
                    // 直接执行节点选择（包含未保存数据检查）
                    this.performNodeSelection(node);
                },

                // 执行节点选择
                performNodeSelection(node) {
                    // 在显示资产列表之前，再次检查是否有未保存的数据
                    if (this.hasUnsavedData()) {
                        this.$confirm(this.getUnsavedDataMessage(), '提示', {
                            confirmButtonText: '确定切换',
                            cancelButtonText: '取消',
                            type: 'warning'
                        }).then(() => {
                            // 用户确认切换，清除所有编辑状态并显示资产列表
                    this.selectedNode = node;
                            this.clearAllEditingStates();
                    this.assetSearchKeyword = '';
                    this.assetSearchField = 'name';
                    this.searchAssets();
                        }).catch(() => {
                            // 用户取消切换，不做任何操作
                            this.$message.info('已取消切换节点');
                        });
                    } else {
                        // 没有未保存的数据，直接切换并显示资产列表
                        this.selectedNode = node;
                        this.clearAllEditingStates();
                        this.assetSearchKeyword = '';
                        this.assetSearchField = 'name';
                        this.searchAssets();
                    }
                },

                // 展开/收起节点
                toggleExpand(node) {
                    console.log('toggleExpand 方法被调用，节点:', node.name);
                    if (this.hasChildren(node)) {
                        if (this.expandedNodes[node.id]) {
                            this.$delete(this.expandedNodes, node.id);
                            console.log('收起节点:', node.name);
                        } else {
                            this.$set(this.expandedNodes, node.id, true);
                            console.log('展开节点:', node.name);
                        }
                    }
                },

                // 判断节点是否有子节点
                hasChildren(node) {
                    return node.children && node.children.length > 0;
                },

                // 判断节点是否展开
                isExpanded(node) {
                    return !!this.expandedNodes[node.id];
                },

                // 获取节点图标
                getNodeIcon(type) {
                    switch (type) {
                        case '工厂': return 'factory';
                        case '车间': return 'workshop';
                        case '产线': return 'line';
                        case '工段': return 'section';
                        case '设备': return 'equipment';
                        case '系统': return 'asset';
                        default: return 'asset';
                    }
                },

                // 添加子节点
                addChildNode(parentNode) {
                    this.openNodeDialog('add', parentNode);
                },

                // 编辑节点
                editNode(node) {
                    this.openNodeDialog('edit', node);
                },

                // 查看节点
                viewNode(node) {
                    this.openNodeDialog('view', node);
                },


                // 复制节点
                copyNode(node) {
                    this.$confirm(`确定要复制节点"${node.name}"及其所有子节点吗？`, '确认复制', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'info'
                    }).then(() => {
                        this.copyNodeAndChildren(node);
                        this.$message.success('复制成功');
                    }).catch(() => {
                        this.$message.info('已取消复制');
                    });
                },

                // 删除节点
                deleteNode(node) {
                    this.$confirm(`确定要删除节点"${node.name}"吗？删除后将同时删除其所有子节点。`, '警告', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        this.deleteNodeAndChildren(node.id);
                        this.$message.success('删除成功');
                    }).catch(() => {
                        this.$message.info('已取消删除');
                    });
                },

                // 拖拽开始
                onDragStart(event, node) {
                    this.draggingNode = node;
                    this.isDragging = true;
                    this.isDragOver = false;
                    event.dataTransfer.setData('text/plain', node.id);
                },

                // 拖拽结束
                onDragEnd(event) {
                    this.draggingNode = null;
                    this.isDragging = false;
                    this.isDragOver = false;
                },

                // 拖拽进入
                onDragEnter(event, node) {
                    if (this.draggingNode && this.draggingNode.id !== node.id) {
                        this.dragOverNode = node;
                        this.isDragOver = true;
                    }
                },

                // 拖拽离开
                onDragLeave(event, node) {
                    if (this.draggingNode && this.draggingNode.id !== node.id) {
                        this.dragOverNode = null;
                        this.isDragOver = false;
                    }
                },

                // 拖拽悬停
                onDragOver(event, node) {
                    event.preventDefault();
                    if (this.draggingNode && this.draggingNode.id !== node.id) {
                        this.dragOverNode = node;
                        this.isDragOver = true;
                    }
                },

                // 拖拽放置
                onDrop(event, node) {
                    event.preventDefault();
                    const draggedNodeId = event.dataTransfer.getData('text/plain');
                    const draggedNode = this.findNodeById(this.treeData, draggedNodeId);
                    const targetNode = node;

                    if (draggedNode && targetNode) {
                        this.reorderNode(draggedNode, targetNode);
                    }

                    this.dragOverNode = null;
                    this.isDragOver = false;
                },

                // 重新排序节点
                reorderNode(draggedNode, targetNode) {
                    // 防止拖拽到自己或自己的子节点
                    if (this.isDescendant(draggedNode, targetNode)) {
                        this.$message.warning('不能将节点拖拽到其子节点下');
                        return;
                    }

                    // 如果拖拽到同一父节点下，只改变顺序
                    if (this.hasSameParent(draggedNode, targetNode)) {
                        this.reorderSiblings(draggedNode, targetNode);
                    } else {
                        // 如果拖拽到不同父节点，改变层级关系
                        this.moveNodeToNewParent(draggedNode, targetNode);
                    }
                },

                // 检查是否为子节点
                isDescendant(parent, child) {
                    if (!parent.children) return false;
                    for (let node of parent.children) {
                        if (node.id === child.id) return true;
                        if (this.isDescendant(node, child)) return true;
                    }
                    return false;
                },

                // 检查是否有相同父节点
                hasSameParent(node1, node2) {
                    const parent1 = this.findParentNode(this.treeData, node1.id);
                    const parent2 = this.findParentNode(this.treeData, node2.id);
                    return parent1 && parent2 && parent1.id === parent2.id;
                },

                // 查找父节点
                findParentNode(nodes, childId, parent = null) {
                    for (let node of nodes) {
                        if (node.children) {
                            for (let child of node.children) {
                                if (child.id === childId) {
                                    return parent;
                                }
                            }
                            const found = this.findParentNode(node.children, childId, node);
                            if (found) return found;
                        }
                    }
                    return null;
                },

                // 重新排序兄弟节点
                reorderSiblings(draggedNode, targetNode) {
                    const parent = this.findParentNode(this.treeData, draggedNode.id);
                    if (parent) {
                        const children = parent.children;
                        const draggedIndex = children.findIndex(child => child.id === draggedNode.id);
                        const targetIndex = children.findIndex(child => child.id === targetNode.id);
                        
                        if (draggedIndex !== -1 && targetIndex !== -1) {
                            // 移除拖拽的节点
                            children.splice(draggedIndex, 1);
                            // 插入到目标位置
                            children.splice(targetIndex, 0, draggedNode);
                            this.$message.success('节点顺序已调整');
                        }
                    } else {
                        // 根节点的情况
                        const draggedIndex = this.treeData.findIndex(node => node.id === draggedNode.id);
                        const targetIndex = this.treeData.findIndex(node => node.id === targetNode.id);
                        
                        if (draggedIndex !== -1 && targetIndex !== -1) {
                            this.treeData.splice(draggedIndex, 1);
                            this.treeData.splice(targetIndex, 0, draggedNode);
                            this.$message.success('节点顺序已调整');
                        }
                    }
                },

                // 移动节点到新的父节点
                moveNodeToNewParent(draggedNode, targetNode) {
                    // 从原位置移除节点
                    this.removeNodeFromTree(this.treeData, draggedNode.id);
                    
                    // 更新节点的层级
                    const newLevel = targetNode.level + 1;
                    this.updateNodeLevel(draggedNode, newLevel);
                    
                    // 添加到新父节点
                    if (!targetNode.children) {
                        targetNode.children = [];
                    }
                    targetNode.children.push(draggedNode);
                    
                    // 确保目标节点展开
                    this.$set(this.expandedNodes, targetNode.id, true);
                    
                    this.$message.success('节点已移动到新位置');
                },

                // 更新节点及其子节点的层级
                updateNodeLevel(node, newLevel) {
                    node.level = newLevel;
                    if (node.children) {
                        node.children.forEach(child => {
                            this.updateNodeLevel(child, newLevel + 1);
                        });
                    }
                },

                // 过滤节点
                filterNodes() {
                    const keyword = this.searchKeyword.toLowerCase();
                    const allNodes = this.flattenTree(this.treeData);
                    return allNodes.filter(node => {
                        const matchesKeyword = node.name.toLowerCase().includes(keyword);
                        const matchesType = keyword && node.type && node.type.toLowerCase().includes(keyword);
                        const matchesDescription = keyword && node.description && node.description.toLowerCase().includes(keyword);
                        return matchesKeyword || matchesType || matchesDescription;
                    });
                },

                // 扁平化树形结构
                flattenTree(nodes, result = []) {
                    nodes.forEach(node => {
                        result.push(node);
                        if (node.children && node.children.length > 0) {
                            this.flattenTree(node.children, result);
                        }
                    });
                    return result;
                },

                // 根据ID查找节点
                findNodeById(nodes, id) {
                    for (let node of nodes) {
                        if (node.id === id) {
                            return node;
                        }
                        if (node.children && node.children.length > 0) {
                            const found = this.findNodeById(node.children, id);
                            if (found) return found;
                        }
                    }
                    return null;
                },

                // 获取可见节点（根据展开状态）
                getVisibleNodes(nodes, result = []) {
                    nodes.forEach(node => {
                        result.push(node);
                        // 如果节点有子节点且处于展开状态，则显示子节点
                        if (node.children && node.children.length > 0 && this.isExpanded(node)) {
                            this.getVisibleNodes(node.children, result);
                        }
                    });
                    return result;
                },

                // 树形容器拖拽悬停
                onTreeDragOver(event) {
                    event.preventDefault();
                    if (this.draggingNode) {
                        this.isDragOver = true;
                    }
                },

                // 树形容器拖拽离开
                onTreeDragLeave(event) {
                    if (this.draggingNode) {
                        this.isDragOver = false;
                    }
                },

                // 树形容器拖拽放置
                onTreeDrop(event) {
                    event.preventDefault();
                    const draggedNodeId = event.dataTransfer.getData('text/plain');
                    const draggedNode = this.findNodeById(this.treeData, draggedNodeId);
                    const targetElement = event.target.closest('.node-item');
                     
                    if (targetElement) {
                        const targetNode = this.findNodeById(this.treeData, targetElement.dataset.nodeId);
                        if (draggedNode && targetNode) {
                            this.reorderNode(draggedNode, targetNode);
                        }
                    }

                    this.dragOverNode = null;
                    this.isDragOver = false;
                },

                // 全部展开
                expandAll() {
                    console.log('expandAll 方法被调用');
                    this.expandAllNodes(this.treeData);
                    this.$message.success('已展开所有节点');
                },

                // 递归展开所有节点
                expandAllNodes(nodes) {
                    nodes.forEach(node => {
                        if (node.children && node.children.length > 0) {
                            this.$set(this.expandedNodes, node.id, true);
                            this.expandAllNodes(node.children);
                        }
                    });
                },

                // 全部收起
                collapseAll() {
                    console.log('collapseAll 方法被调用');
                    this.expandedNodes = {};
                    this.$message.success('已收起所有节点');
                },

                // 打开节点编辑对话框
                openNodeDialog(mode, parentNode) {
                    this.nodeDialogVisible = true;
                    this.nodeDialogMode = mode;
                    this.nodeDialogTitle = mode === 'add' ? '添加节点' : mode === 'view' ? '查看节点' : '编辑节点';
                    
                    if (mode === 'add') {
                        // 保存父节点信息，用于后续添加子节点
                        this.currentParentNode = parentNode;
                        
                        // 添加新节点
                        this.nodeForm = {
                            name: '',
                            code: this.generateNodeCode(parentNode),
                            type: '',
                            description: ''
                        };
                    } else {
                        // 编辑或查看现有节点
                        this.currentParentNode = null;
                        this.nodeForm = {
                            name: this.selectedNode.name,
                            code: this.selectedNode.code,
                            type: this.selectedNode.type,
                            description: this.selectedNode.description
                        };
                    }
                    
                    this.$nextTick(() => {
                        if (this.$refs.nodeForm) {
                            this.$refs.nodeForm.clearValidate();
                        }
                    });
                },

                // 生成节点编码
                generateNodeCode(parentNode) {
                    if (parentNode) {
                        const parentCode = parentNode.code;
                        const childCount = parentNode.children ? parentNode.children.length : 0;
                        return `${parentCode}_CHILD_${childCount + 1}`;
                    }
                    return `NODE_${this.treeData.length + 1}`;
                },

                // 保存节点 (新增)
                saveNode() {
                    this.$refs.nodeForm.validate(valid => {
                        if (valid) {
                            if (this.nodeDialogTitle === '添加节点') {
                                // 添加新节点
                                const newNode = {
                                    id: 'node_' + Date.now(),
                                    name: this.nodeForm.name,
                                    code: this.nodeForm.code,
                                    type: this.nodeForm.type,
                                    description: this.nodeForm.description,
                                    createTime: new Date().toLocaleString(),
                                    level: this.currentParentNode ? this.currentParentNode.level + 1 : 1,
                                    assets: [],
                                    children: []
                                };
                                
                                if (this.currentParentNode) {
                                    // 添加子节点
                                    if (!this.currentParentNode.children) {
                                        this.currentParentNode.children = [];
                                    }
                                    this.currentParentNode.children.push(newNode);
                                    // 确保父节点展开
                                    this.$set(this.expandedNodes, this.currentParentNode.id, true);
                                } else {
                                    // 添加根节点
                                    this.treeData.push(newNode);
                                }
                                
                                this.hasRootNode = true;
                                this.$message.success('节点添加成功');
                            } else {
                                // 编辑现有节点
                                if (this.selectedNode) {
                                    this.selectedNode.name = this.nodeForm.name;
                                    this.selectedNode.code = this.nodeForm.code;
                                    this.selectedNode.type = this.nodeForm.type;
                                    this.selectedNode.description = this.nodeForm.description;
                                    this.$message.success('节点编辑成功');
                                }
                            }
                            this.nodeDialogVisible = false;
                        } else {
                            this.$message.error('请检查输入信息');
                        }
                    });
                },

                // 重置节点表单
                resetNodeForm() {
                    this.nodeForm = {
                        name: '',
                        code: '',
                        type: '',
                        description: ''
                    };
                    this.nodeDialogMode = 'add';
                },

                // 根据节点类型获取资产类型
                getAssetTypeByNodeType(nodeType) {
                    if (!nodeType) return '';
                    const nodeTypeConfig = this.nodeTypes.find(type => type.value === nodeType);
                    return nodeTypeConfig ? nodeTypeConfig.assetType : '';
                },

                // 根据节点类型获取允许的子节点类型
                getAllowedChildNodeTypes(nodeType) {
                    if (!nodeType) return '';
                    const nodeTypeConfig = this.nodeTypes.find(type => type.value === nodeType);
                    if (!nodeTypeConfig || !nodeTypeConfig.allowedChildTypes || nodeTypeConfig.allowedChildTypes.length === 0) {
                        return '无';
                    }
                    return nodeTypeConfig.allowedChildTypes.join('、');
                },

                // 获取可用的节点类型（根据当前操作模式）
                getAvailableNodeTypes() {
                    if (this.nodeDialogMode === 'add') {
                        // 添加子节点时，根据父节点类型确定可选的子节点类型
                        if (this.currentParentNode) {
                            const parentTypeConfig = this.nodeTypes.find(type => type.value === this.currentParentNode.type);
                            if (parentTypeConfig && parentTypeConfig.allowedChildTypes && parentTypeConfig.allowedChildTypes.length > 0) {
                                return this.nodeTypes.filter(type => 
                                    parentTypeConfig.allowedChildTypes.includes(type.value)
                                );
                            }
                            return [];
                        }
                        // 添加根节点时，返回所有类型
                        return this.nodeTypes;
                    } else if (this.nodeDialogMode === 'edit') {
                        // 编辑节点时，根据上级节点类型确定可选的节点类型
                        const parentNode = this.getParentNode(this.selectedNode);
                        if (parentNode) {
                            const parentTypeConfig = this.nodeTypes.find(type => type.value === parentNode.type);
                            if (parentTypeConfig && parentTypeConfig.allowedChildTypes && parentTypeConfig.allowedChildTypes.length > 0) {
                                return this.nodeTypes.filter(type => 
                                    parentTypeConfig.allowedChildTypes.includes(type.value)
                                );
                            }
                            return [];
                        }
                        // 如果是根节点，返回所有类型
                        return this.nodeTypes;
                    } else {
                        // 查看模式，返回所有类型
                        return this.nodeTypes;
                    }
                },

                // 获取节点的父节点
                getParentNode(node) {
                    if (!node) return null;
                    
                    const findParent = (nodes, targetNode) => {
                        for (let n of nodes) {
                            if (n.children) {
                                for (let child of n.children) {
                                    if (child.id === targetNode.id) {
                                        return n;
                                    }
                                }
                                const found = findParent(n.children, targetNode);
                                if (found) return found;
                            }
                        }
                        return null;
                    };
                    
                    return findParent(this.treeData, node);
                },



                // 复制节点及其子节点
                copyNodeAndChildren(sourceNode) {
                    // 生成新的根节点ID
                    const newRootId = 'node_' + Date.now();
                    
                    // 复制根节点
                    const newNode = {
                        ...sourceNode,
                        id: newRootId,
                        name: sourceNode.name + '_副本',
                        code: sourceNode.code + '_COPY',
                        children: []
                    };
                    
                    // 添加到层级结构中
                    this.treeData.push(newNode);
                    
                    // 递归复制所有子节点
                    this.copyChildrenRecursively(sourceNode.id, newRootId);
                },
                
                // 递归复制子节点
                copyChildrenRecursively(oldParentId, newParentId) {
                    const parentNode = this.findNodeById(this.treeData, oldParentId);
                    if (!parentNode || !parentNode.children) return;
                    
                    parentNode.children.forEach(child => {
                        const newChildId = 'node_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                        
                        const newChild = {
                            ...child,
                            id: newChildId,
                            name: child.name + '_副本',
                            code: child.code + '_COPY',
                            children: []
                        };
                        
                        // 找到新父节点并添加子节点
                        const newParent = this.findNodeById(this.treeData, newParentId);
                        if (newParent) {
                            if (!newParent.children) {
                                newParent.children = [];
                            }
                            newParent.children.push(newChild);
                        }
                        
                        // 递归复制子节点的子节点
                        this.copyChildrenRecursively(child.id, newChildId);
                    });
                },
                
                // 删除节点及其子节点
                deleteNodeAndChildren(nodeId) {
                    // 从树形数据中删除节点
                    this.removeNodeFromTree(this.treeData, nodeId);
                    
                    // 如果删除的是当前选中的节点，清空选中状态
                    if (this.selectedNode && this.selectedNode.id === nodeId) {
                        this.selectedNode = null;
                    }
                },
                
                // 从树中删除节点
                removeNodeFromTree(nodes, nodeId) {
                    for (let i = 0; i < nodes.length; i++) {
                        if (nodes[i].id === nodeId) {
                            nodes.splice(i, 1);
                            return true;
                        }
                        if (nodes[i].children && this.removeNodeFromTree(nodes[i].children, nodeId)) {
                            return true;
                        }
                    }
                    return false;
                },
                
                // 加载模型数据
                loadModelData() {
                    const urlParams = new URLSearchParams(window.location.search);
                    const modelId = urlParams.get('id') || 'model-1';
                    const mode = urlParams.get('mode') || 'view';
                    
                    this.isEditMode = mode === 'edit';
                    this.isReadOnly = mode === 'view';
                    
                    const modelData = this.getModelDataById(modelId);
                    if (modelData) {
                        this.modelInfo = { ...modelData };
                        
                        // 根据模型ID设置页面标题和描述
                        if (modelId === 'model-1') {
                            this.pageTitle = '华东水泥生产基地';
                            this.pageDescription = '基于"标准水泥工厂模板"创建的工厂模型实例';
                        } else if (modelId === 'model-2') {
                            this.pageTitle = '华南智能水泥厂';
                            this.pageDescription = '基于"智能水泥工厂模板"创建的工厂模型实例';
                        } else if (modelId === 'model-3') {
                            this.pageTitle = '华北绿色水泥厂';
                            this.pageDescription = '基于"绿色水泥工厂模板"创建的工厂模型实例';
                        } else {
                            this.pageTitle = modelData.name;
                            this.pageDescription = '基于"' + modelData.templateName + '"创建的工厂模型实例';
                        }
                    }
                },
                
                // 根据ID获取模型数据（模拟数据）
                getModelDataById(modelId) {
                    // 模拟模型数据存储
                    const modelDatabase = {
                        'model-1': {
                            id: 'model-1',
                            name: '华东水泥生产基地',
                            description: '华东地区主要水泥生产基地，年产水泥500万吨，包含完整的熟料生产线、粉磨系统和包装系统。',
                            templateName: '标准水泥工厂模板',
                            createTime: '2024-01-15 10:30:00',
                            creator: '张工程师',
                            status: 'enabled'
                        },
                        'model-2': {
                            id: 'model-2',
                            name: '华南智能水泥厂',
                            description: '华南地区智能化水泥工厂，采用先进的DCS控制系统和自动化设备，年产水泥300万吨。',
                            templateName: '智能水泥工厂模板',
                            createTime: '2024-01-20 14:15:00',
                            creator: '李技术员',
                            status: 'enabled'
                        },
                        'model-3': {
                            id: 'model-3',
                            name: '华北绿色水泥厂',
                            description: '华北地区环保型水泥工厂，注重节能减排和可持续发展，采用余热发电和脱硝技术。',
                            templateName: '绿色水泥工厂模板',
                            createTime: '2024-01-25 09:45:00',
                            creator: '王环保师',
                            status: 'disabled'
                        }
                    };
                    
                    // 检查是否是复制的模型（ID包含时间戳）
                    if (modelId.includes('model-') && modelId !== 'model-1' && modelId !== 'model-2' && modelId !== 'model-3') {
                        // 这是一个复制的模型，返回基于原模型的复制数据
                        const originalModel = modelDatabase['model-1']; // 假设基于第一个模型复制
                        return {
                            ...originalModel,
                            id: modelId,
                            name: originalModel.name + '_副本',
                            status: 'draft',
                            createTime: new Date().toLocaleString(),
                            creator: '当前用户'
                        };
                    }
                    
                    return modelDatabase[modelId];
                },
                
                // 获取状态样式类
                getStatusClass(status) {
                    switch (status) {
                        case 'enabled': return 'status-enabled';
                        case 'disabled': return 'status-disabled';
                        case 'draft': return 'status-draft';
                        default: return 'status-draft';
                    }
                },

                // 获取模板名称样式类
                getTemplateClass(templateName) {
                    if (templateName.includes('标准水泥')) return 'status-enabled';
                    if (templateName.includes('智能水泥')) return 'status-level';
                    if (templateName.includes('绿色水泥')) return 'status-draft';
                    if (templateName.includes('新型干法')) return 'status-enabled';
                    if (templateName.includes('重工业水泥')) return 'status-level';
                    return 'status-enabled';
                },
                
                // 获取状态文本
                getStatusText(status) {
                    switch (status) {
                        case 'enabled': return '已启用';
                        case 'disabled': return '已禁用';
                        case 'draft': return '草稿';
                        default: return '草稿';
                    }
                },

                // 获取节点类型样式类
                getNodeTypeClass(type) {
                    switch (type) {
                        case '工厂': return 'factory';
                        case '车间': return 'workshop';
                        case '产线': return 'line';
                        case '工段': return 'section';
                        case '设备': return 'equipment';
                        case '系统': return 'system';
                        default: return 'equipment';
                    }
                },

                // 获取节点图标样式类
                getNodeIconClass(type) {
                    switch (type) {
                        case '工厂': return 'el-icon-office-building';
                        case '车间': return 'el-icon-house';
                        case '产线': return 'el-icon-connection';
                        case '工段': return 'el-icon-s-grid';
                        case '设备': return 'el-icon-cpu';
                        case '系统': return 'el-icon-monitor';
                        default: return 'el-icon-cpu';
                    }
                },

                // 获取子节点数量
                getChildNodeCount(node) {
                    return node.children ? node.children.length : 0;
                },

                // 获取当前节点资产数量
                getAssetCount(node) {
                    return node.assets ? node.assets.length : 0;
                },

                // 获取总资产数量（包括子节点）
                getTotalAssetCount(node) {
                    let total = this.getAssetCount(node);
                    if (node.children) {
                        node.children.forEach(child => {
                            total += this.getTotalAssetCount(child);
                        });
                    }
                    return total;
                },

                // 获取资产层级路径
                getAssetPath() {
                    if (!this.selectedNode) {
                        return '';
                    }
                    
                    const path = [];
                    let currentNode = this.selectedNode;
                    
                    // 从当前节点向上遍历到根节点
                    while (currentNode) {
                        path.unshift(currentNode.name);
                        currentNode = this.findParentNode(currentNode);
                    }
                    
                    return path.join(' / ');
                },

                // 查找父节点
                findParentNode(node) {
                    return this.findNodeParent(this.treeData, node);
                },

                // 递归查找父节点
                findNodeParent(nodes, targetNode) {
                    for (let node of nodes) {
                        if (node.children) {
                            for (let child of node.children) {
                                if (child.id === targetNode.id) {
                                    return node;
                                }
                                const parent = this.findNodeParent([child], targetNode);
                                if (parent) {
                                    return parent;
                                }
                            }
                        }
                    }
                    return null;
                },

                // 获取资产操作图标
                getAssetOperationIcon() {
                    if (this.isAddingAsset) {
                        return 'el-icon-plus';
                    } else if (this.isViewingAsset) {
                        return 'el-icon-info';
                    } else if (this.isEditingAsset) {
                        return 'el-icon-edit';
                    }
                    return 'el-icon-document';
                },

                // 获取资产操作文本
                getAssetOperationText() {
                    if (this.isAddingAsset) {
                        return '新增资产';
                    } else if (this.isViewingAsset) {
                        return '查看资产';
                    } else if (this.isEditingAsset) {
                        return '编辑资产';
                    }
                    return '资产操作';
                },

                // 获取资产操作状态样式类
                getAssetOperationStatusClass() {
                    if (this.isAddingAsset) {
                        return 'adding';
                    } else if (this.isViewingAsset) {
                        return 'viewing';
                    } else if (this.isEditingAsset) {
                        return 'editing';
                    }
                    return '';
                },

                // 获取资产名称
                getAssetName() {
                    if (this.isAddingAsset) {
                        return '';
                    } else if (this.isViewingAsset || this.isEditingAsset) {
                        return this.assetForm.deviceName || '';
                    }
                    return '';
                },

                // 根据资产类型编码获取资产类型名称
                getAssetTypeName(typeCode) {
                    const assetType = this.assetTypes.find(type => type.value === typeCode);
                    return assetType ? assetType.label : typeCode;
                },

                // 切换资产连接状态
                toggleAssetConnection(asset) {
                    const action = asset.isConnected ? '断开' : '接入';
                    this.$confirm(`确定要${action}资产"${asset.name}"吗？`, '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'info'
                    }).then(() => {
                        asset.isConnected = !asset.isConnected;
                        if (!asset.isConnected) {
                            asset.status = '-';
                        } else {
                            asset.status = '运行中';
                        }
                        this.$message.success(`资产${action}成功`);
                    }).catch(() => {
                        this.$message.info('已取消操作');
                    });
                },

                // 刷新资产状态
                refreshAssetStatus(asset) {
                    if (!asset.isConnected) {
                        this.$message.warning('设备未接入，无法刷新状态');
                        return;
                    }
                    
                    // 模拟刷新状态
                    this.$message.info('正在刷新设备状态...');
                    setTimeout(() => {
                        const statuses = ['运行中', '待机中', '故障中', '维护中'];
                        asset.status = statuses[Math.floor(Math.random() * statuses.length)];
                        this.$message.success('状态刷新成功');
                    }, 1000);
                },

                // 定位到资产所在节点
                locateToAssetNode(asset) {
                    const targetNode = this.findNodeByName(this.treeData, asset.nodeName);
                    if (targetNode) {
                        this.selectNode(targetNode);
                        this.$message.success(`已定位到节点: ${asset.nodePath}`);
                    } else {
                        this.$message.warning('无法找到对应的节点');
                    }
                },

                // 根据节点名称查找节点
                findNodeByName(nodes, nodeName) {
                    for (let node of nodes) {
                        if (node.name === nodeName) {
                            return node;
                        }
                        if (node.children && node.children.length > 0) {
                            const found = this.findNodeByName(node.children, nodeName);
                            if (found) return found;
                        }
                    }
                    return null;
                },

                // 切换资产表单连接状态
                toggleAssetFormConnection() {
                    const action = this.assetForm.connectionStatus === '已接入' ? '断开' : '接入';
                    this.$confirm(`确定要${action}设备吗？`, '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'info'
                    }).then(() => {
                        this.assetForm.connectionStatus = this.assetForm.connectionStatus === '已接入' ? '待接入' : '已接入';
                        if (this.assetForm.connectionStatus === '待接入') {
                            this.assetForm.runningStatus = '-';
                        } else {
                            this.assetForm.runningStatus = '运行中';
                        }
                        this.$message.success(`设备${action}成功`);
                    }).catch(() => {
                        this.$message.info('已取消操作');
                    });
                },

                // 刷新资产表单状态
                refreshAssetFormStatus() {
                    if (this.assetForm.connectionStatus !== '已接入') {
                        this.$message.warning('设备未接入，无法刷新状态');
                        return;
                    }
                    
                    // 模拟刷新状态
                    this.$message.info('正在刷新设备状态...');
                    setTimeout(() => {
                        const statuses = ['运行中', '待机中', '故障中', '维护中'];
                        this.assetForm.runningStatus = statuses[Math.floor(Math.random() * statuses.length)];
                        this.$message.success('状态刷新成功');
                    }, 1000);
                },

                // 获取运行状态标签类型
                getRunningStatusType() {
                    switch (this.assetForm.runningStatus) {
                        case '运行中': return 'success';
                        case '待机中': return 'warning';
                        case '故障中': return 'danger';
                        case '维护中': return 'info';
                        default: return 'info';
                    }
                },

                // 获取运行状态实心圆
                getRunningStatusCircle() {
                    switch (this.assetForm.runningStatus) {
                        case '运行中': return 'status-circle status-running';
                        case '待机中': return 'status-circle status-standby';
                        case '故障中': return 'status-circle status-fault';
                        case '维护中': return 'status-circle status-maintenance';
                        default: return 'status-circle status-dash';
                    }
                },

                // 新增动态变量参数
                addDynamicVariable() {
                    if (!this.selectedAssetType || !this.selectedAssetType.dynamicVariables) {
                        this.$message.warning('请先选择资产类型');
                        return;
                    }

                    const newVariable = {
                        name: '',
                        code: '',
                        type: '数值',
                        unit: '',
                        precision: '0.1',
                        frequency: '1秒',
                        dataCategory: '生产',
                        businessCategory: '生产',
                        valueCycle: '1秒',
                        valueMethod: '瞬时值',
                        dataBinding: '',
                        dataTransform: '',
                        isEditing: true,
                        isNew: true
                    };

                    this.selectedAssetType.dynamicVariables.unshift(newVariable);
                    this.$message.success('新增参数成功，请填写参数信息');
                },

                // 显示数据点位批量新增抽屉
                showDataPointBatchAdd() {
                    if (!this.selectedAssetType || !this.selectedAssetType.dynamicVariables) {
                        this.$message.warning('请先选择资产类型');
                        return;
                    }
                    
                    this.dataPointBatchAddDrawerVisible = true;
                    this.dataPointSearchKeyword = '';
                    this.dataPointSearchDataSource = '';
                    this.dataPointSearchType = '';
                    this.selectedDataPoints = [];
                    this.filteredDataPoints = [...this.dataPoints];
                },

                // 搜索数据点位
                searchDataPoints() {
                    const keyword = this.dataPointSearchKeyword.toLowerCase();
                    const dataSource = this.dataPointSearchDataSource;
                    const type = this.dataPointSearchType;
                    
                    this.filteredDataPoints = this.dataPoints.filter(point => {
                        const nameMatch = !keyword || point.name.toLowerCase().includes(keyword);
                        const codeMatch = !keyword || point.code.toLowerCase().includes(keyword);
                        const dataSourceMatch = !dataSource || point.dataSource === dataSource;
                        const typeMatch = !type || point.dataType === type;
                        
                        return (nameMatch || codeMatch) && dataSourceMatch && typeMatch;
                    });
                },

                // 清空数据点位搜索
                clearDataPointSearch() {
                    this.dataPointSearchKeyword = '';
                    this.dataPointSearchDataSource = '';
                    this.dataPointSearchType = '';
                    this.filteredDataPoints = [...this.dataPoints];
                },

                // 处理数据点位选择变化
                handleDataPointSelectionChange(selection) {
                    this.selectedDataPoints = selection;
                },

                // 清空选中的数据点位
                clearSelectedDataPoints() {
                    this.selectedDataPoints = [];
                    // 清空表格选择
                    this.$nextTick(() => {
                        this.$refs.dataPointTable && this.$refs.dataPointTable.clearSelection();
                    });
                },

                // 确认批量新增数据点位
                confirmBatchAddDataPoints() {
                    if (this.selectedDataPoints.length === 0) {
                        this.$message.warning('请选择要新增的数据点位');
                        return;
                    }

                    // 批量新增动态变量
                    this.selectedDataPoints.forEach(dataPoint => {
                        const newVariable = {
                            name: dataPoint.name,
                            code: dataPoint.code,
                            type: this.convertDataType(dataPoint.dataType),
                            unit: dataPoint.unit || '',
                            precision: '0.1',
                            frequency: '1秒',
                            dataCategory: '生产',
                            businessCategory: '生产',
                            valueCycle: '1秒',
                            valueMethod: '瞬时值',
                            dataBinding: `${dataPoint.dataSource}.${dataPoint.code}`,
                            dataTransform: '',
                            isEditing: false,
                            isNew: false
                        };

                        this.selectedAssetType.dynamicVariables.push(newVariable);
                    });

                    this.$message.success(`成功批量新增 ${this.selectedDataPoints.length} 个参数`);
                    this.dataPointBatchAddDrawerVisible = false;
                },

                // 转换数据类型
                convertDataType(dataType) {
                    const typeMap = {
                        'Float': '数值',
                        'Int': '数值',
                        'String': '字符串',
                        'Boolean': '布尔值',
                        'Enum': '枚举'
                    };
                    return typeMap[dataType] || '数值';
                },

                // 获取数据源标签类型
                getDataSourceTagType(dataSource) {
                    const typeMap = {
                        'DCS': 'primary',
                        'SCADA': 'success',
                        'PLC': 'warning',
                        'RTU': 'info',
                        'OPC': 'danger',
                        'MODBUS': ''
                    };
                    return typeMap[dataSource] || '';
                },

                // 获取数据源显示标签
                getDataSourceLabel(dataSource) {
                    const labelMap = {
                        'DCS': 'DCS系统',
                        'SCADA': 'SCADA系统',
                        'PLC': 'PLC系统',
                        'RTU': 'RTU设备',
                        'OPC': 'OPC服务器',
                        'MODBUS': 'Modbus设备'
                    };
                    return labelMap[dataSource] || dataSource;
                },

                // 获取数据类型标签类型
                getDataTypeTagType(dataType) {
                    const typeMap = {
                        'Float': 'primary',
                        'Int': 'success',
                        'String': 'warning',
                        'Boolean': 'info',
                        'Enum': 'danger'
                    };
                    return typeMap[dataType] || '';
                },

                // 获取数据类型显示标签
                getDataTypeLabel(dataType) {
                    const labelMap = {
                        'Float': '数值',
                        'Int': '整数',
                        'String': '字符串',
                        'Boolean': '布尔值',
                        'Enum': '枚举'
                    };
                    return labelMap[dataType] || dataType;
                },

                // 事件规则相关方法
                // 处理事件规则选择变化
                handleEventRuleSelectionChange(selection) {
                    this.selectedEventRules = selection;
                },

                // 获取事件规则行样式
                getEventRuleRowClassName({ row }) {
                    if (row.isEditing) {
                        return 'is-editing';
                    }
                    return '';
                },

                // 新增事件规则
                addEventRule() {
                    if (!this.selectedAssetType || !this.selectedAssetType.eventRules) {
                        this.$message.warning('请先选择资产类型');
                        return;
                    }

                    const newRule = {
                        id: Date.now(),
                        name: '',
                        code: '',
                        category: '安全告警',
                        description: '',
                        triggerCondition: '',
                        severity: 'medium',
                        enabled: true,
                        actions: ['发送告警', '记录日志'],
                        isEditing: true,
                        isNew: true
                    };

                    this.selectedAssetType.eventRules.unshift(newRule);
                    this.$message.success('新增事件规则成功，请填写规则信息');
                },

                // 进入事件规则编辑模式
                enterEventRuleEditMode(rule) {
                    if (!this.selectedAssetType) {
                        this.$message.warning('请先选择资产类型');
                        return;
                    }

                    // 保存原始数据
                    rule._originalData = { ...rule };
                    rule.isEditing = true;
                    this.$forceUpdate();
                },

                // 保存事件规则编辑
                saveEventRuleEdit(rule) {
                    // 验证必填字段
                    if (!rule.name || !rule.code || !rule.category || !rule.triggerCondition) {
                        this.$message.warning('请填写必填字段：规则名称、编码、分类、触发条件');
                        return;
                    }

                    rule.isEditing = false;
                    delete rule._originalData;

                    // 如果是新增的规则，移除isNew标记
                    if (rule.isNew) {
                        delete rule.isNew;
                    }

                    this.$message.success('保存成功');
                },

                // 取消事件规则编辑
                cancelEventRuleEdit(rule) {
                    if (rule.isNew) {
                        // 如果是新增的规则，直接删除
                        const index = this.selectedAssetType.eventRules.indexOf(rule);
                        if (index > -1) {
                            this.selectedAssetType.eventRules.splice(index, 1);
                        }
                        this.$message.info('已取消新增');
                    } else if (rule._originalData) {
                        // 恢复原始数据
                        Object.assign(rule, rule._originalData);
                        delete rule._originalData;
                        this.$message.info('已取消编辑');
                    }
                    rule.isEditing = false;
                },

                // 删除事件规则
                deleteEventRule(rule) {
                    this.$confirm('确定要删除该事件规则吗？', '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        const index = this.selectedAssetType.eventRules.indexOf(rule);
                        if (index > -1) {
                            this.selectedAssetType.eventRules.splice(index, 1);
                            this.$message.success('删除成功');
                        }
                    }).catch(() => {
                        // 用户取消删除
                    });
                },

                // 批量删除事件规则
                batchDeleteEventRules() {
                    if (this.selectedEventRules.length === 0) {
                        this.$message.warning('请选择要删除的事件规则');
                        return;
                    }

                    this.$confirm(`确定要删除选中的 ${this.selectedEventRules.length} 个事件规则吗？`, '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        this.selectedEventRules.forEach(rule => {
                            const index = this.selectedAssetType.eventRules.indexOf(rule);
                            if (index > -1) {
                                this.selectedAssetType.eventRules.splice(index, 1);
                            }
                        });
                        this.selectedEventRules = [];
                        this.$message.success(`成功删除 ${this.selectedEventRules.length} 个事件规则`);
                    }).catch(() => {
                        // 用户取消删除
                    });
                },

                // 获取事件规则分类标签类型
                getEventRuleCategoryTagType(category) {
                    const typeMap = {
                        '安全告警': 'danger',
                        '运行监控': 'warning',
                        '状态监控': 'info',
                        '库存告警': 'warning',
                        '安全监控': 'danger',
                        '质量监控': 'success',
                        '能耗监控': 'primary'
                    };
                    return typeMap[category] || '';
                },

                // 获取事件规则严重程度标签类型
                getEventRuleSeverityTagType(severity) {
                    const typeMap = {
                        'high': 'danger',
                        'medium': 'warning',
                        'low': 'info'
                    };
                    return typeMap[severity] || '';
                },

                // 获取事件规则严重程度显示标签
                getEventRuleSeverityLabel(severity) {
                    const labelMap = {
                        'high': '高',
                        'medium': '中',
                        'low': '低'
                    };
                    return labelMap[severity] || severity;
                },

                // 显示事件规则配置抽屉
                showEventRuleConfig(rule) {
                    if (!this.selectedAssetType) {
                        this.$message.warning('请先选择资产类型');
                        return;
                    }
                    
                    // 可以在这里保存当前选中的规则，供配置页面使用
                    this.currentConfigEventRule = rule;
                    this.eventRuleConfigDrawerVisible = true;
                },

                // 切换事件规则状态
                toggleEventRuleStatus(rule) {
                    const action = rule.enabled ? '停用' : '启用';
                    const ruleName = rule.name;
                    
                    this.$confirm(`确定要${action}事件规则"${ruleName}"吗？`, '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        rule.enabled = !rule.enabled;
                        this.$message.success(`已${action}事件规则"${ruleName}"`);
                    }).catch(() => {
                        // 用户取消操作
                    });
                },

                // 切换采集参数状态
                toggleCollectionVariableStatus(variable) {
                    const action = variable.enabled ? '停用' : '启用';
                    const variableName = variable.name;
                    
                    this.$confirm(`确定要${action}采集参数"${variableName}"吗？`, '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        variable.enabled = !variable.enabled;
                        this.$message.success(`已${action}采集参数"${variableName}"`);
                    }).catch(() => {
                        // 用户取消操作，恢复开关状态
                        variable.enabled = !variable.enabled;
                    });
                },

                // 切换业务属性状态
                toggleBusinessPropertyStatus(property) {
                    const action = property.enabled ? '停用' : '启用';
                    const propertyName = property.name;
                    
                    this.$confirm(`确定要${action}业务属性"${propertyName}"吗？`, '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        property.enabled = !property.enabled;
                        this.$message.success(`已${action}业务属性"${propertyName}"`);
                    }).catch(() => {
                        // 用户取消操作，恢复开关状态
                        property.enabled = !property.enabled;
                    });
                },

                // 切换指标状态
                toggleIndicatorStatus(indicator) {
                    const action = indicator.enabled ? '停用' : '启用';
                    const indicatorName = indicator.name;
                    
                    this.$confirm(`确定要${action}指标"${indicatorName}"吗？`, '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        indicator.enabled = !indicator.enabled;
                        this.$message.success(`已${action}指标"${indicatorName}"`);
                    }).catch(() => {
                        // 用户取消操作，恢复开关状态
                        indicator.enabled = !indicator.enabled;
                    });
                },

                // 告警相关方法
                // 刷新告警
                refreshAlarms() {
                    this.$message.success('告警数据已刷新');
                },

                // 检索告警
                searchAlarms() {
                    // 这里可以添加实际的检索逻辑
                    this.$message.success('告警检索完成');
                },

                // 清空告警检索条件
                clearAlarmSearch() {
                    this.alarmSearchKeyword = '';
                    this.alarmSearchLevel = '';
                    this.alarmSearchStatus = 'unhandled';
                    this.alarmSearchTimeRange = 'all';
                },

                // 查看告警详情
                viewAlarmDetail(alarm) {
                    this.currentAlarm = alarm;
                    this.alarmDetailDrawerVisible = true;
                },

                // 处理告警
                handleAlarm(alarm) {
                    this.$prompt('请输入处理备注', '处理告警', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        inputPlaceholder: '请输入处理备注...'
                    }).then(({ value }) => {
                        alarm.isHandled = true;
                        alarm.handler = '当前用户';
                        alarm.status = 'handled';
                        alarm.handleTime = new Date().toLocaleString();
                        alarm.handleNote = value || '';
                        this.$message.success('告警已处理');
                        
                        // 如果在详情页面，关闭抽屉
                        if (this.alarmDetailDrawerVisible) {
                            this.alarmDetailDrawerVisible = false;
                        }
                    }).catch(() => {
                        // 用户取消操作
                    });
                },

                // 忽略告警
                ignoreAlarm(alarm) {
                    this.$confirm('确定要忽略该告警吗？', '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        alarm.isHandled = true;
                        alarm.handler = '当前用户';
                        alarm.status = 'ignored';
                        alarm.handleTime = new Date().toLocaleString();
                        alarm.handleNote = '忽略，不做处理';
                        this.$message.success('告警已忽略');
                        
                        // 如果在详情页面，关闭抽屉
                        if (this.alarmDetailDrawerVisible) {
                            this.alarmDetailDrawerVisible = false;
                        }
                    }).catch(() => {
                        // 用户取消操作
                    });
                },

                // 标记为误报
                markAsFalseAlarm(alarm) {
                    this.$confirm('确定要将该告警标记为误报吗？', '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        alarm.isHandled = true;
                        alarm.handler = '当前用户';
                        alarm.status = 'false_alarm';
                        alarm.handleTime = new Date().toLocaleString();
                        alarm.handleNote = '误报';
                        this.$message.success('告警已标记为误报');
                        
                        // 如果在详情页面，关闭抽屉
                        if (this.alarmDetailDrawerVisible) {
                            this.alarmDetailDrawerVisible = false;
                        }
                    }).catch(() => {
                        // 用户取消操作
                    });
                },

                // 获取告警级别标签类型
                getAlarmLevelTagType(level) {
                    const typeMap = {
                        'high': 'danger',
                        'medium': 'warning',
                        'low': 'info'
                    };
                    return typeMap[level] || '';
                },

                // 视频管理相关方法
                // 新增视频
                addVideo() {
                    const newVideo = {
                        id: Date.now(),
                        cameraAddress: '',
                        cameraNumber: '',
                        cameraName: ''
                    };
                    this.selectedAssetType.videos.push(newVideo);
                    this.$message.success('新增视频成功');
                },

                // 删除视频
                deleteVideo() {
                    if (this.selectedVideos.length === 0) {
                        this.$message.warning('请选择要删除的视频');
                        return;
                    }

                    this.$confirm(`确定要删除选中的 ${this.selectedVideos.length} 个视频吗？`, '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        const selectedIds = this.selectedVideos.map(video => video.id);
                        this.selectedAssetType.videos = this.selectedAssetType.videos.filter(
                            video => !selectedIds.includes(video.id)
                        );
                        this.selectedVideos = [];
                        this.$message.success('删除视频成功');
                    }).catch(() => {
                        // 用户取消操作
                    });
                },

                // 处理视频选择变化
                handleVideoSelectionChange(selection) {
                    this.selectedVideos = selection;
                },

                // 配置视频画面
                configureVideo(video) {
                    this.$message.info(`需调用摄像头管理的视频配置画面：${video.cameraName || video.cameraNumber}`);
                    // 这里可以打开视频配置抽屉或弹窗
                },

                // 打开摄像头列表
                openCameraList(video) {
                    this.$message.info('需调用视频控制平台的摄像头列表页面');
                    // 这里可以打开摄像头选择弹窗或跳转到摄像头列表页面
                },

                // 获取告警级别显示标签
                getAlarmLevelLabel(level) {
                    const labelMap = {
                        'high': '高',
                        'medium': '中',
                        'low': '低'
                    };
                    return labelMap[level] || level;
                },

                // 添加资产
                addAsset() {
                    if (!this.selectedNode) {
                        this.$message.warning('请先选择一个节点');
                        return;
                    }
                    this.isAddingAsset = true;
                    // 重置表单
                    this.assetForm = {
                        assetType: '',
                        deviceCode: '',
                        deviceName: '',
                        connectionStatus: '待接入',
                        runningStatus: '-'
                    };
                    this.activeTab = 'basicInfo';
                },
                
                // 取消资产表单
                cancelAssetForm() {
                    this.isAddingAsset = false;
                    this.isViewingAsset = false;
                    this.isEditingAsset = false;
                    this.assetForm = {
                        assetType: '',
                        deviceCode: '',
                        deviceName: '',
                        connectionStatus: '待接入',
                        runningStatus: '-'
                    };
                },

                // 清除所有编辑状态
                clearAllEditingStates() {
                    // 清除资产表单状态
                    this.cancelAssetForm();
                    
                    // 清除静态属性、动态变量、业务属性、指标的编辑状态
                    if (this.selectedAssetType) {
                        // 清除静态属性编辑状态
                        if (this.selectedAssetType.staticProperties) {
                            this.selectedAssetType.staticProperties.forEach(prop => {
                                prop.isEditing = false;
                            });
                        }
                        
                        // 清除动态变量编辑状态
                        if (this.selectedAssetType.dynamicVariables) {
                            this.selectedAssetType.dynamicVariables.forEach(variable => {
                                variable.isEditing = false;
                            });
                        }
                        
                        // 清除业务属性编辑状态
                        if (this.selectedAssetType.businessProperties) {
                            this.selectedAssetType.businessProperties.forEach(prop => {
                                prop.isEditing = false;
                            });
                        }
                        
                        // 清除指标编辑状态
                        if (this.selectedAssetType.indicators) {
                            this.selectedAssetType.indicators.forEach(indicator => {
                                indicator.isEditing = false;
                            });
                        }

                        // 清除事件规则编辑状态
                        if (this.selectedAssetType.eventRules) {
                            this.selectedAssetType.eventRules.forEach(rule => {
                                rule.isEditing = false;
                            });
                        }
                    }
                },

                // 查看资产
                viewAsset(asset) {
                    // 自动选中资产所在节点
                    if (asset.nodeName && asset.nodeName !== this.selectedNode.name) {
                        const targetNode = this.findNodeByName(this.treeData, asset.nodeName);
                        if (targetNode) {
                            this.selectNode(targetNode);
                        }
                    }
                    
                    this.isAddingAsset = false;
                    this.isViewingAsset = true;
                    this.isEditingAsset = false;
                    
                    // 填充表单数据
                    this.assetForm = {
                        assetType: asset.type || '',
                        deviceCode: asset.code || '',
                        deviceName: asset.name || '',
                        connectionStatus: asset.isConnected ? '已接入' : '待接入',
                        runningStatus: asset.status || '-'
                    };
                    
                    this.activeTab = 'basicInfo';
                },

                // 编辑资产
                editAsset(asset) {
                    // 自动选中资产所在节点
                    if (asset.nodeName && asset.nodeName !== this.selectedNode.name) {
                        const targetNode = this.findNodeByName(this.treeData, asset.nodeName);
                        if (targetNode) {
                            this.selectNode(targetNode);
                        }
                    }
                    
                    this.isAddingAsset = false;
                    this.isViewingAsset = false;
                    this.isEditingAsset = true;
                    
                    // 保存当前编辑的资产对象
                    this.currentEditingAsset = asset;
                    
                    // 填充表单数据
                    this.assetForm = {
                        assetType: asset.type || '',
                        deviceCode: asset.code || '',
                        deviceName: asset.name || '',
                        connectionStatus: asset.isConnected ? '已接入' : '待接入',
                        runningStatus: asset.status || '-'
                    };
                    
                    this.activeTab = 'basicInfo';
                },

                // 删除资产
                deleteAsset(asset) {
                    this.$confirm(`确定要删除资产"${asset.name}"吗？`, '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        if (this.selectedNode && this.selectedNode.assets) {
                            const index = this.selectedNode.assets.findIndex(item => item.id === asset.id);
                            if (index > -1) {
                                this.selectedNode.assets.splice(index, 1);
                                this.searchAssets();
                                this.$message.success('资产删除成功');
                            }
                        }
                    }).catch(() => {
                        this.$message.info('已取消删除');
                    });
                },
                
                // 保存资产
                saveAsset() {
                    // 检查基本信息必填字段
                    if (!this.assetForm.assetType || !this.assetForm.deviceCode || !this.assetForm.deviceName) {
                        this.$message.error('请完善基础信息中的必填字段');
                        this.activeTab = 'basicInfo'; // 切换到基础信息页签
                        return;
                    }
                    
                    // 检查静态属性必填字段
                    if (this.selectedAssetType && this.selectedAssetType.staticProperties) {
                        for (let prop of this.selectedAssetType.staticProperties) {
                            if (prop.required && !prop.defaultValue) {
                                this.$message.error('请完善静态属性中的必填字段');
                                this.activeTab = 'basicInfo'; // 切换到基础信息页签
                                return;
                            }
                        }
                    }
                    
                    if (this.isAddingAsset) {
                    // 创建新资产对象
                    const newAsset = {
                        id: Date.now().toString(),
                        name: this.assetForm.deviceName,
                        code: this.assetForm.deviceCode,
                        type: this.assetForm.assetType,
                        isConnected: false,
                        status: '-',
                        model: '',
                        category: '',
                        supplier: '',
                        manufacturer: '',
                        installDate: new Date().toLocaleDateString()
                    };
                    
                    // 添加到选中节点的资产列表
                    if (!this.selectedNode.assets) {
                        this.selectedNode.assets = [];
                    }
                    this.selectedNode.assets.push(newAsset);
                        
                        this.$message.success('资产添加成功');
                    } else if (this.isEditingAsset && this.currentEditingAsset) {
                        // 更新现有资产
                        this.currentEditingAsset.name = this.assetForm.deviceName;
                        this.currentEditingAsset.code = this.assetForm.deviceCode;
                        this.currentEditingAsset.type = this.assetForm.assetType;
                        this.currentEditingAsset.isConnected = this.assetForm.connectionStatus === '已接入';
                        this.currentEditingAsset.status = this.assetForm.runningStatus;
                        
                        this.$message.success('资产修改成功');
                    }
                    
                    // 更新过滤后的资产列表
                    this.searchAssets();
                    
                    // 退出所有模式
                    this.isAddingAsset = false;
                    this.isViewingAsset = false;
                    this.isEditingAsset = false;
                    this.currentEditingAsset = null;
                },

                // 获取资产图标样式类
                getAssetIconClass(type) {
                    switch (type) {
                        case '系统': return 'el-icon-monitor';
                        case '设备': return 'el-icon-cpu';
                        case '传感器': return 'el-icon-odometer';
                        case '控制器': return 'el-icon-setting';
                        default: return 'el-icon-cpu';
                    }
                },

                // 导出资产
                exportAssets() {
                    this.exportAssetsDialogVisible = true;
                },

                // 确认导出资产
                confirmExportAssets() {
                    // 收集所有资产数据
                    const allAssets = this.collectAllAssets(this.treeData);
                    
                    if (allAssets.length === 0) {
                        this.$message.warning('当前工厂模型下没有资产数据');
                        this.exportAssetsDialogVisible = false;
                        return;
                    }

                    // 根据选择的格式导出
                    if (this.exportFormat === 'excel') {
                        this.exportToExcel(allAssets);
                    } else if (this.exportFormat === 'json') {
                        this.exportToJson(allAssets);
                    }

                    this.exportAssetsDialogVisible = false;
                    this.$message.success(`资产数据已导出为${this.exportFormat.toUpperCase()}格式`);
                },

                // 收集所有资产数据
                collectAllAssets(nodes) {
                    let assets = [];
                    nodes.forEach(node => {
                        if (node.assets && node.assets.length > 0) {
                            // 为每个资产添加所属节点信息
                            const nodeAssets = node.assets.map(asset => ({
                                ...asset,
                                nodeName: node.name,
                                nodeType: node.type,
                                nodeLevel: node.level
                            }));
                            assets = assets.concat(nodeAssets);
                        }
                        if (node.children && node.children.length > 0) {
                            assets = assets.concat(this.collectAllAssets(node.children));
                        }
                    });
                    return assets;
                },

                // 导出为Excel格式
                exportToExcel(assets) {
                    // 创建CSV格式的数据（简化版Excel导出）
                    const headers = ['节点名称', '节点类型', '节点层级', '资产名称', '资产编码', '资产类型', '型号', '类别', '供应商', '制造商', '安装日期', '状态', '是否接入', '设备编码', 'ABC类别', '报修年限', '使用年限', '保管人', '描述'];
                    const csvContent = [
                        headers.join(','),
                        ...assets.map(asset => [
                            asset.nodeName || '',
                            asset.nodeType || '',
                            asset.nodeLevel || '',
                            asset.name || '',
                            asset.code || '',
                            asset.type || '',
                            asset.model || '',
                            asset.category || '',
                            asset.supplier || '',
                            asset.manufacturer || '',
                            asset.installDate || '',
                            asset.status || '',
                            asset.isConnected ? '已接入' : '未接入',
                            asset.deviceCode || '',
                            asset.abcCategory || '',
                            asset.repairYears || '',
                            asset.serviceYears || '',
                            asset.custodian || '',
                            asset.description || ''
                        ].join(','))
                    ].join('\n');

                    // 创建下载链接
                    const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `${this.modelInfo.name}_资产列表_${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                },

                // 导出为JSON格式
                exportToJson(assets) {
                    const exportData = {
                        modelName: this.modelInfo.name,
                        exportTime: new Date().toISOString(),
                        totalAssets: assets.length,
                        assets: assets
                    };

                    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `${this.modelInfo.name}_资产列表_${new Date().toISOString().split('T')[0]}.json`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                },

                // 获取数据绑定显示文本
                getDataBindingDisplayText(row) {
                    if (!row.dataBinding) {
                        return '绑定数据';
                    }
                    
                    // 检查是否包含公式（通过检查是否包含"公式:"关键字）
                    if (row.dataBinding.includes('公式:')) {
                        return '已配公式';
                    }
                    
                    // 检查是否为单一数据点位（不包含逗号分隔的多个点位）
                    if (!row.dataBinding.includes(',')) {
                        return row.dataBinding;
                    }
                    
                    // 多个数据点位但没有公式，也显示"已配公式"
                    return '已配公式';
                },

                // 配置数据绑定
                configureDataBinding(row) {
                    this.currentConfigVariable = row;
                    this.configType = 'binding';
                    this.dataBindingDrawerVisible = true;
                    
                    // 初始化数据绑定表单
                    this.dataBindingForm = {
                        dataSource: '',
                        pointName: '',
                        pointCode: '',
                        selectedPoints: [],
                        formula: ''
                    };
                    
                    // 如果已有配置，尝试解析并加载
                    if (row.dataBinding) {
                        // 检查是否包含公式
                        if (row.dataBinding.includes('公式:')) {
                            // 提取公式部分
                            const formulaMatch = row.dataBinding.match(/公式: (.+)$/);
                            if (formulaMatch) {
                                this.dataBindingForm.formula = formulaMatch[1];
                            }
                            
                            // 提取数据点位名称（去掉公式部分）
                            const pointNamesPart = row.dataBinding.replace(/ \(公式: .+\)$/, '');
                            const pointNames = pointNamesPart.split(', ');
                            
                            // 根据名称找到对应的数据点位对象
                            this.dataBindingForm.selectedPoints = this.dataPoints.filter(point => 
                                pointNames.includes(point.name)
                            );
                        } else {
                            // 单一数据点位，根据名称查找
                            const point = this.dataPoints.find(p => p.name === row.dataBinding);
                            if (point) {
                                this.dataBindingForm.selectedPoints = [point];
                            }
                        }
                    }
                    
                    // 初始化过滤后的数据点位列表
                    this.filteredDataPoints = [...this.dataPoints];
                },

                // 配置数据转换
                configureDataTransform(row) {
                    this.currentConfigVariable = row;
                    this.configType = 'transform';
                    this.dataTransformDrawerVisible = true;
                },

                // 保存数据绑定配置
                saveDataBindingConfig() {
                    if (this.currentConfigVariable && this.dataBindingForm.selectedPoints.length > 0) {
                        const selectedPointNames = this.dataBindingForm.selectedPoints.map(point => point.name);
                        
                        // 如果只有一个数据点位且没有公式，只保存数据点位名称
                        if (selectedPointNames.length === 1 && !this.dataBindingForm.formula) {
                            this.currentConfigVariable.dataBinding = selectedPointNames[0];
                        } else {
                            // 多个数据点位或有公式，保存完整信息
                            this.currentConfigVariable.dataBinding = selectedPointNames.join(', ');
                            if (this.dataBindingForm.formula) {
                                this.currentConfigVariable.dataBinding += ` (公式: ${this.dataBindingForm.formula})`;
                            }
                        }
                        
                        this.dataBindingDrawerVisible = false;
                        this.$message.success('数据绑定配置已保存');
                    }
                },

                // 业务属性数据绑定相关方法
                // 获取业务属性数据绑定显示文本
                getBusinessPropertyDataBindingDisplayText(row) {
                    if (!row.dataSource) {
                        return '绑定数据';
                    }
                    
                    // 检查是否包含公式（通过检查是否包含"公式:"关键字）
                    if (row.dataSource.includes('公式:')) {
                        return '已配公式';
                    }
                    
                    // 检查是否为单一数据点位（不包含逗号分隔的多个点位）
                    if (!row.dataSource.includes(',')) {
                        return row.dataSource;
                    }
                    
                    // 多个数据点位但没有公式，也显示"已配公式"
                    return '已配公式';
                },

                // 配置业务属性数据绑定
                configureBusinessPropertyDataBinding(row) {
                    this.currentConfigVariable = row;
                    this.configType = 'businessPropertyBinding';
                    this.dataBindingDrawerVisible = true;
                    
                    // 初始化业务属性数据绑定表单，默认数据源为REST_API
                    this.businessPropertyDataBindingForm = {
                        dataSource: 'REST_API',
                        pointName: '',
                        pointCode: '',
                        selectedPoints: [],
                        formula: ''
                    };
                    
                    // 如果已有配置，尝试解析并加载
                    if (row.dataSource) {
                        // 检查是否包含公式
                        if (row.dataSource.includes('公式:')) {
                            // 提取公式部分
                            const formulaMatch = row.dataSource.match(/公式: (.+)$/);
                            if (formulaMatch) {
                                this.businessPropertyDataBindingForm.formula = formulaMatch[1];
                            }
                            
                            // 提取数据点位名称（去掉公式部分）
                            const pointNamesPart = row.dataSource.replace(/ \(公式: .+\)$/, '');
                            const pointNames = pointNamesPart.split(', ');
                            
                            // 根据名称找到对应的数据点位对象
                            this.businessPropertyDataBindingForm.selectedPoints = this.dataPoints.filter(point => 
                                pointNames.includes(point.name)
                            );
                        } else {
                            // 单一数据点位，根据名称查找
                            const point = this.dataPoints.find(p => p.name === row.dataSource);
                            if (point) {
                                this.businessPropertyDataBindingForm.selectedPoints = [point];
                            }
                        }
                    }
                    
                    // 初始化过滤后的数据点位列表
                    this.filteredDataPoints = [...this.dataPoints];
                },

                // 保存业务属性数据绑定配置
                saveBusinessPropertyDataBindingConfig() {
                    if (this.currentConfigVariable && this.businessPropertyDataBindingForm.selectedPoints.length > 0) {
                        const selectedPointNames = this.businessPropertyDataBindingForm.selectedPoints.map(point => point.name);
                        
                        // 如果只有一个数据点位且没有公式，只保存数据点位名称
                        if (selectedPointNames.length === 1 && !this.businessPropertyDataBindingForm.formula) {
                            this.currentConfigVariable.dataSource = selectedPointNames[0];
                        } else {
                            // 多个数据点位或有公式，保存完整信息
                            this.currentConfigVariable.dataSource = selectedPointNames.join(', ');
                            if (this.businessPropertyDataBindingForm.formula) {
                                this.currentConfigVariable.dataSource += ` (公式: ${this.businessPropertyDataBindingForm.formula})`;
                            }
                        }
                        
                        this.dataBindingDrawerVisible = false;
                        this.$message.success('业务属性数据绑定配置已保存');
                    }
                },

                // 搜索数据点位
                searchDataPoints() {
                    const form = this.configType === 'businessPropertyBinding' ? this.businessPropertyDataBindingForm : this.dataBindingForm;
                    const { dataSource, pointName, pointCode } = form;
                    
                    this.filteredDataPoints = this.dataPoints.filter(point => {
                        let match = true;
                        
                        if (dataSource && point.dataSource !== dataSource) {
                            match = false;
                        }
                        
                        if (pointName && !point.name.toLowerCase().includes(pointName.toLowerCase())) {
                            match = false;
                        }
                        
                        if (pointCode && !point.code.toLowerCase().includes(pointCode.toLowerCase())) {
                            match = false;
                        }
                        
                        return match;
                    });
                },

                // 清空数据点位搜索
                clearDataPointSearch() {
                    const form = this.configType === 'businessPropertyBinding' ? this.businessPropertyDataBindingForm : this.dataBindingForm;
                    form.dataSource = this.configType === 'businessPropertyBinding' ? 'REST_API' : '';
                    form.pointName = '';
                    form.pointCode = '';
                    this.filteredDataPoints = [...this.dataPoints];
                },

                // 处理表格选择变化
                handleSelectionChange(selection) {
                    const form = this.configType === 'businessPropertyBinding' ? this.businessPropertyDataBindingForm : this.dataBindingForm;
                    form.selectedPoints = selection;
                },

                // 切换数据点位选择状态
                toggleDataPointSelection(row) {
                    const form = this.configType === 'businessPropertyBinding' ? this.businessPropertyDataBindingForm : this.dataBindingForm;
                    const index = form.selectedPoints.findIndex(point => point.code === row.code);
                    if (index > -1) {
                        form.selectedPoints.splice(index, 1);
                    } else {
                        form.selectedPoints.push(row);
                    }
                },

                // 移除已选择的数据点位
                removeSelectedPoint(index) {
                    const form = this.configType === 'businessPropertyBinding' ? this.businessPropertyDataBindingForm : this.dataBindingForm;
                    form.selectedPoints.splice(index, 1);
                },

                // 插入运算符到公式
                insertOperator(operator) {
                    const form = this.configType === 'businessPropertyBinding' ? this.businessPropertyDataBindingForm : this.dataBindingForm;
                    // 根据当前输入模式处理
                    if (this.formulaInputMode === 'visual') {
                        // 可视化模式：添加到可视化部分
                        this.insertBlockAtPosition({
                            type: 'operator',
                            value: operator
                        });
                        this.syncVisualToExpression();
                    } else {
                        // 表达式模式：直接添加到公式
                        if (this.logicalOperators.includes(operator) || this.conditionalOperators.includes(operator)) {
                            if (form.formula && !form.formula.endsWith(' ')) {
                                form.formula += ' ';
                            }
                            form.formula += operator + ' ';
                        } else {
                            form.formula += operator;
                        }
                    }
                },

                // 插入数据点位到公式
                insertDataPoint(point) {
                    const form = this.configType === 'businessPropertyBinding' ? this.businessPropertyDataBindingForm : this.dataBindingForm;
                    // 根据当前输入模式处理
                    if (this.formulaInputMode === 'visual') {
                        // 可视化模式：添加到可视化部分
                        this.insertVariable(point);
                    } else {
                        // 表达式模式：直接添加到公式
                        if (form.formula && !form.formula.endsWith(' ')) {
                            form.formula += ' ';
                        }
                        form.formula += `[${point.dataSource}].[${point.name}]`;
                    }
                },
                

                
                // 验证公式语法
                validateFormula() {
                    const form = this.configType === 'businessPropertyBinding' ? this.businessPropertyDataBindingForm : this.dataBindingForm;
                    const formula = form.formula.trim();
                    
                    if (!formula) {
                        this.$message.warning('请先输入公式');
                        return;
                    }
                    
                    // 基本语法检查
                    let isValid = true;
                    let errors = [];
                    
                    // 检查括号匹配
                    const leftBrackets = (formula.match(/\[/g) || []).length;
                    const rightBrackets = (formula.match(/\]/g) || []).length;
                    if (leftBrackets !== rightBrackets) {
                        isValid = false;
                        errors.push('方括号不匹配');
                    }
                    
                    // 检查圆括号匹配
                    const leftParens = (formula.match(/\(/g) || []).length;
                    const rightParens = (formula.match(/\)/g) || []).length;
                    if (leftParens !== rightParens) {
                        isValid = false;
                        errors.push('圆括号不匹配');
                    }
                    
                    // 检查if-then-else结构
                    if (formula.includes('if') && !formula.includes('then')) {
                        isValid = false;
                        errors.push('if语句缺少then');
                    }
                    
                    if (formula.includes('then') && !formula.includes('if')) {
                        isValid = false;
                        errors.push('then语句缺少if');
                    }
                    
                    if (isValid) {
                        this.$message.success('公式语法正确');
                    } else {
                        this.$message.error('公式语法错误：' + errors.join('，'));
                    }
                },
                
                // 处理输入模式切换
                handleInputModeChange(tab) {
                    const form = this.configType === 'businessPropertyBinding' ? this.businessPropertyDataBindingForm : this.dataBindingForm;
                    // 当切换到可视化输入时，同步表达式到可视化显示
                    if (tab.name === 'visual' && form.formula) {
                        this.syncExpressionToVisual();
                    }
                    // 当切换到表达式输入时，同步可视化到表达式
                    else if (tab.name === 'expression' && this.visualFormulaParts.length > 0) {
                        this.syncVisualToExpression();
                    }
                },
                
                // 处理自然语言输入
                handleNaturalLanguageInput() {
                    if (!this.naturalLanguageInput.trim()) {
                        this.translatedExpression = '';
                        return;
                    }
                    
                    this.isTranslating = true;
                    
                    // 模拟AI翻译过程
                    setTimeout(() => {
                        const translated = this.translateNaturalLanguage(this.naturalLanguageInput);
                        this.translatedExpression = translated;
                        const form = this.configType === 'businessPropertyBinding' ? this.businessPropertyDataBindingForm : this.dataBindingForm;
                        form.formula = translated;
                        this.isTranslating = false;
                        this.$message.success('自然语言已转换为表达式');
                        // AI转换成功后自动跳转到表达式输入模式
                        this.formulaInputMode = 'expression';
                    }, 1000);
                },
                
                // 自然语言翻译（模拟AI功能）
                translateNaturalLanguage(text) {
                    const lowerText = text.toLowerCase();
                    let result = '';
                    
                    // 简单的自然语言翻译规则
                    if (lowerText.includes('温度传感器1') || lowerText.includes('温度1')) {
                        result += '[RTU].[温度传感器1]';
                    }
                    if (lowerText.includes('温度传感器2') || lowerText.includes('温度2')) {
                        if (result) result += ' ';
                        result += '[RTU].[温度传感器2]';
                    }
                    if (lowerText.includes('压力传感器1') || lowerText.includes('压力1')) {
                        if (result) result += ' ';
                        result += '[RTU].[压力传感器1]';
                    }
                    if (lowerText.includes('电流传感器1') || lowerText.includes('电流1')) {
                        if (result) result += ' ';
                        result += '[RTU].[电流传感器1]';
                    }
                    
                    // 运算符翻译
                    if (lowerText.includes('加上') || lowerText.includes('加') || lowerText.includes('+')) {
                        result += ' + ';
                    }
                    if (lowerText.includes('减去') || lowerText.includes('减') || lowerText.includes('-')) {
                        result += ' - ';
                    }
                    if (lowerText.includes('乘以') || lowerText.includes('乘') || lowerText.includes('*')) {
                        result += ' * ';
                    }
                    if (lowerText.includes('除以') || lowerText.includes('除') || lowerText.includes('/')) {
                        result += ' / ';
                    }
                    if (lowerText.includes('大于') || lowerText.includes('>')) {
                        result += ' > ';
                    }
                    if (lowerText.includes('小于') || lowerText.includes('<')) {
                        result += ' < ';
                    }
                    if (lowerText.includes('等于') || lowerText.includes('=')) {
                        result += ' = ';
                    }
                    if (lowerText.includes('并且') || lowerText.includes('且') || lowerText.includes('and')) {
                        result += ' and ';
                    }
                    if (lowerText.includes('或者') || lowerText.includes('或') || lowerText.includes('or')) {
                        result += ' or ';
                    }
                    
                    // 数字提取
                    const numbers = text.match(/\d+/g);
                    if (numbers && numbers.length > 0) {
                        result += ' ' + numbers[0];
                    }
                    
                    return result.trim();
                },
                
                // 插入变量到可视化输入
                insertVariable(point) {
                    this.insertBlockAtPosition({
                        type: 'variable',
                        dataSource: point.dataSource,
                        name: point.name,
                        code: point.code
                    });
                    this.syncVisualToExpression();
                },
                
                // 同步可视化到表达式
                syncVisualToExpression() {
                    const form = this.configType === 'businessPropertyBinding' ? this.businessPropertyDataBindingForm : this.dataBindingForm;
                    form.formula = this.visualFormulaDisplay;
                },
                
                // 同步表达式到可视化
                syncExpressionToVisual() {
                    const form = this.configType === 'businessPropertyBinding' ? this.businessPropertyDataBindingForm : this.dataBindingForm;
                    // 简单的表达式解析，将表达式转换为可视化部分
                    const formula = form.formula;
                    this.visualFormulaParts = [];
                    this.selectedBlockIndex = -1;
                    
                    // 这里可以实现更复杂的表达式解析
                    // 目前简单地将整个表达式作为一个部分
                    if (formula) {
                        this.visualFormulaParts.push({
                            type: 'expression',
                            value: formula
                        });
                    }
                },
                
                // 插入数字到可视化输入
                insertNumber() {
                    if (!this.numberInput.trim()) {
                        this.$message.warning('请输入数字');
                        return;
                    }
                    
                    const num = parseFloat(this.numberInput);
                    if (isNaN(num)) {
                        this.$message.error('请输入有效的数字');
                        return;
                    }
                    
                    this.insertBlockAtPosition({
                        type: 'number',
                        value: this.numberInput
                    });
                    
                    this.numberInput = '';
                    this.syncVisualToExpression();
                    this.$message.success('数字已添加');
                },
                
                // 选择公式块
                selectBlock(index) {
                    this.selectedBlockIndex = index;
                },
                
                // 删除公式块
                deleteBlock(index) {
                    this.visualFormulaParts.splice(index, 1);
                    this.selectedBlockIndex = -1;
                    this.syncVisualToExpression();
                    this.$message.success('已删除公式块');
                },
                
                // 在指定位置插入块
                insertBlockAtPosition(block) {
                    if (this.selectedBlockIndex >= 0) {
                        // 在选中块之后插入
                        this.visualFormulaParts.splice(this.selectedBlockIndex + 1, 0, block);
                    } else {
                        // 在末尾插入
                        this.visualFormulaParts.push(block);
                    }
                },

                // 保存数据转换配置
                saveDataTransformConfig() {
                    if (this.currentConfigVariable) {
                        this.currentConfigVariable.dataTransform = '已配置';
                        this.dataTransformDrawerVisible = false;
                        this.$message.success('数据转换配置已保存');
                    }
                },

                // 双击行进入编辑模式
                handleRowDblClick(row) {
                    if (!this.selectedAssetType || !this.selectedAssetType.dynamicVariables) {
                        return;
                    }
                    
                    // 先退出其他行的编辑模式
                    this.selectedAssetType.dynamicVariables.forEach(item => {
                        if (item !== row) {
                            item.isEditing = false;
                        }
                    });
                    
                    // 进入当前行编辑模式
                    row.isEditing = true;
                    // 保存原始数据用于取消编辑
                    row._originalData = { ...row };
                },

                // 保存行编辑
                saveRowEdit(row) {
                    // 验证必填字段
                    if (!row.name || !row.code || !row.type) {
                        this.$message.warning('请填写必填字段：变量名称、编码、数据类型');
                        return;
                    }
                    
                    row.isEditing = false;
                    delete row._originalData;
                    
                    // 如果是新增的参数，移除isNew标记
                    if (row.isNew) {
                        delete row.isNew;
                    }
                    
                    this.$message.success('保存成功');
                },

                // 取消行编辑
                cancelRowEdit(row) {
                    if (row.isNew) {
                        // 如果是新增的参数，直接删除
                        const index = this.selectedAssetType.dynamicVariables.indexOf(row);
                        if (index > -1) {
                            this.selectedAssetType.dynamicVariables.splice(index, 1);
                        }
                        this.$message.info('已取消新增');
                    } else if (row._originalData) {
                        // 恢复原始数据
                        Object.assign(row, row._originalData);
                        delete row._originalData;
                        this.$message.info('已取消编辑');
                    }
                    row.isEditing = false;
                },

                // 双击行进入动态变量编辑模式
                enterDynamicVariableEditMode(row) {
                    if (!this.assetForm.assetType) {
                        this.$message.warning('请先选择资产类型');
                        return;
                    }
                    if (!this.selectedAssetType || !this.selectedAssetType.dynamicVariables) {
                        this.$message.warning('资产类型数据加载失败，请重新选择资产类型');
                        return;
                    }
                    
                    // 先退出其他行的编辑模式
                    this.selectedAssetType.dynamicVariables.forEach(item => {
                        if (item !== row) {
                            item.isEditing = false;
                            delete item._originalData;
                        }
                    });
                    
                    // 进入当前行编辑模式
                    row.isEditing = true;
                    // 保存原始数据用于取消编辑
                    row._originalData = { ...row };
                    
                    // 强制更新视图
                    this.$forceUpdate();
                },

                // 双击行进入业务属性编辑模式
                enterBusinessPropertyEditMode(row) {
                    console.log('进入业务属性编辑模式:', row);
                    if (!this.assetForm.assetType) {
                        this.$message.warning('请先选择资产类型');
                        return;
                    }
                    if (!this.selectedAssetType || !this.selectedAssetType.businessProperties) {
                        console.log('selectedAssetType 或 businessProperties 不存在');
                        this.$message.warning('资产类型数据加载失败，请重新选择资产类型');
                        return;
                    }
                    
                    // 先退出其他行的编辑模式
                    this.selectedAssetType.businessProperties.forEach(item => {
                        if (item !== row) {
                            item.isEditing = false;
                            delete item._originalData;
                        }
                    });
                    
                    // 进入当前行编辑模式
                    row.isEditing = true;
                    // 保存原始数据用于取消编辑
                    row._originalData = { ...row };
                    
                    // 强制更新视图
                    this.$forceUpdate();
                    console.log('业务属性编辑模式已设置:', row.isEditing);
                },

                // 保存业务属性行编辑
                saveBusinessPropertyRow(row) {
                    // 验证必填字段
                    if (!row.name || !row.code || !row.type) {
                        this.$message.warning('请填写必填字段：属性名称、编码、数据类型');
                        return;
                    }
                    
                    row.isEditing = false;
                    delete row._originalData;
                    
                    this.$message.success('保存成功');
                },

                // 取消业务属性行编辑
                cancelBusinessPropertyEdit(row) {
                    if (row._originalData) {
                        // 恢复原始数据
                        Object.assign(row, row._originalData);
                        delete row._originalData;
                    }
                    row.isEditing = false;
                    this.$message.info('已取消编辑');
                },

                // 删除业务属性
                deleteBusinessProperty(row) {
                    this.$confirm(`确定要删除业务属性"${row.name}"吗？`, '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        if (this.selectedAssetType && this.selectedAssetType.businessProperties) {
                            const index = this.selectedAssetType.businessProperties.indexOf(row);
                            if (index > -1) {
                                this.selectedAssetType.businessProperties.splice(index, 1);
                                this.$message.success('业务属性删除成功');
                            }
                        }
                    }).catch(() => {
                        this.$message.info('已取消删除');
                    });
                },

                // 获取动态变量表格行样式类名
                getDynamicVariableRowClassName({ row }) {
                    if (row.isEditing) {
                        return 'is-editing';
                    }
                    return '';
                },

                // 获取业务属性表格行样式类名
                getBusinessPropertyRowClassName({ row }) {
                    if (row.isEditing) {
                        return 'is-editing';
                    }
                    return '';
                },

                // 删除行
                deleteRow(row) {
                    this.$confirm('确定要删除这条记录吗？', '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        if (this.selectedAssetType && this.selectedAssetType.dynamicVariables) {
                            const index = this.selectedAssetType.dynamicVariables.indexOf(row);
                            if (index > -1) {
                                this.selectedAssetType.dynamicVariables.splice(index, 1);
                                this.$message.success('删除成功');
                            }
                        }
                    }).catch(() => {
                        this.$message.info('已取消删除');
                    });
                },

                // ========== 指标管理方法 ==========
                
                // 获取指标分类对应的标签类型
                getIndicatorCategoryType(category) {
                    const typeMap = {
                        '性能指标': 'primary',
                        '经济指标': 'success',
                        '安全指标': 'warning',
                        '环保指标': 'info'
                    };
                    return typeMap[category] || 'default';
                },

                // 新增指标
                addIndicator() {
                    // 生成新的ID
                    const newId = this.selectedAssetType && this.selectedAssetType.indicators 
                        ? Math.max(...this.selectedAssetType.indicators.map(item => item.id)) + 1 
                        : 1;
                    
                    // 创建新的指标对象
                    const newIndicator = {
                        id: newId,
                        name: '',
                        code: '',
                        category: '',
                        direction: '',
                        unit: '',
                        calculationCycle: '',
                        updateFrequency: '',
                        participatingVariables: [],
                        formula: '',
                        description: '',
                        isEditing: true, // 标记为编辑模式
                        isNew: true // 标记为新行
                    };
                    
                    // 添加到指标列表
                    if (this.selectedAssetType && this.selectedAssetType.indicators) {
                        this.selectedAssetType.indicators.unshift(newIndicator);
                    } else if (this.selectedAssetType) {
                        this.selectedAssetType.indicators = [newIndicator];
                    }
                },

                // 双击行进入指标编辑模式
                enterIndicatorEditMode(row) {
                    console.log('进入指标编辑模式:', row);
                    if (!this.assetForm.assetType) {
                        this.$message.warning('请先选择资产类型');
                        return;
                    }
                    if (!this.selectedAssetType || !this.selectedAssetType.indicators) {
                        console.log('selectedAssetType 或 indicators 不存在');
                        this.$message.warning('资产类型数据加载失败，请重新选择资产类型');
                        return;
                    }
                    
                    // 先退出其他行的编辑模式
                    this.selectedAssetType.indicators.forEach(item => {
                        if (item !== row) {
                            item.isEditing = false;
                            delete item._originalData;
                        }
                    });
                    
                    // 进入当前行编辑模式
                    row.isEditing = true;
                    // 保存原始数据用于取消编辑
                    row._originalData = { ...row };
                    
                    // 强制更新视图
                    this.$forceUpdate();
                    console.log('指标编辑模式已设置:', row.isEditing);
                },

                // 保存指标行编辑
                saveIndicatorRow(row) {
                    // 验证必填字段
                    if (!row.name || !row.code || !row.category || !row.direction) {
                        this.$message.warning('请填写必填字段：指标名称、编码、分类、方向');
                        return;
                    }
                    
                    row.isEditing = false;
                    delete row._originalData;
                    delete row.isNew;
                    
                    this.$message.success('保存成功');
                },

                // 取消指标行编辑
                cancelIndicatorEdit(row) {
                    if (row.isNew) {
                        // 如果是新行，直接删除
                        if (this.selectedAssetType && this.selectedAssetType.indicators) {
                            const index = this.selectedAssetType.indicators.indexOf(row);
                            if (index > -1) {
                                this.selectedAssetType.indicators.splice(index, 1);
                            }
                        }
                    } else if (row._originalData) {
                        // 恢复原始数据
                        Object.assign(row, row._originalData);
                        delete row._originalData;
                    }
                    row.isEditing = false;
                    this.$message.info('已取消编辑');
                },

                // 获取指标表格行样式类名
                getIndicatorRowClassName({ row }) {
                    if (row.isEditing) {
                        return 'is-editing';
                    }
                    return '';
                },

                // 编辑指标
                editIndicator(indicator) {
                    this.isIndicatorEditMode = true;
                    this.isIndicatorViewMode = false;
                    this.indicatorForm = { ...indicator };
                    this.indicatorDrawerVisible = true;
                },

                // 查看指标
                viewIndicator(indicator) {
                    this.isIndicatorEditMode = false;
                    this.isIndicatorViewMode = true;
                    this.indicatorForm = { ...indicator };
                    this.indicatorDrawerVisible = true;
                },

                // 删除指标
                deleteIndicator(indicator) {
                    this.$confirm(`确定要删除指标"${indicator.name}"吗？`, '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        if (this.selectedAssetType && this.selectedAssetType.indicators) {
                            const index = this.selectedAssetType.indicators.findIndex(item => item.id === indicator.id);
                            if (index > -1) {
                                this.selectedAssetType.indicators.splice(index, 1);
                                this.$message.success('指标删除成功');
                            }
                        }
                    }).catch(() => {
                        this.$message.info('已取消删除');
                    });
                },

                // 批量删除指标
                batchDeleteIndicators() {
                    if (this.selectedIndicators.length === 0) {
                        this.$message.warning('请选择要删除的指标');
                        return;
                    }

                    this.$confirm(`确定要删除选中的 ${this.selectedIndicators.length} 个指标吗？`, '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        if (this.selectedAssetType && this.selectedAssetType.indicators) {
                            const idsToDelete = this.selectedIndicators.map(item => item.id);
                            this.selectedAssetType.indicators = this.selectedAssetType.indicators.filter(
                                indicator => !idsToDelete.includes(indicator.id)
                            );
                            this.selectedIndicators = [];
                            this.$message.success('批量删除成功');
                        }
                    }).catch(() => {
                        this.$message.info('已取消删除');
                    });
                },

                // 关闭指标抽屉
                closeIndicatorDrawer() {
                    this.indicatorDrawerVisible = false;
                    this.isIndicatorEditMode = false;
                    this.isIndicatorViewMode = false;
                },

                // 保存指标
                saveIndicatorFromDrawer() {
                    // 如果是查看模式，直接关闭抽屉
                    if (this.isIndicatorViewMode) {
                        this.closeIndicatorDrawer();
                        return;
                    }
                    
                    const { name, code, category, direction, calculationCycle, updateFrequency } = this.indicatorForm;
                    
                    if (!name.trim() || !code.trim() || !category || !direction || !calculationCycle || !updateFrequency) {
                        this.$message.error('请填写必填字段');
                        return;
                    }
                    
                    if (this.isIndicatorEditMode) {
                        // 编辑模式：更新现有指标
                        if (this.selectedAssetType && this.selectedAssetType.indicators) {
                            const index = this.selectedAssetType.indicators.findIndex(
                                item => item.id === this.indicatorForm.id
                            );
                            if (index > -1) {
                                this.selectedAssetType.indicators[index] = { ...this.indicatorForm };
                                this.$message.success('指标更新成功');
                            }
                        }
                    } else {
                        // 新增模式：添加新指标
                        if (this.selectedAssetType) {
                            if (!this.selectedAssetType.indicators) {
                                this.selectedAssetType.indicators = [];
                            }
                            
                            // 生成新的ID
                            const maxId = Math.max(...this.selectedAssetType.indicators.map(item => item.id || 0), 0);
                            this.indicatorForm.id = maxId + 1;
                            
                            this.selectedAssetType.indicators.push({ ...this.indicatorForm });
                            this.$message.success('指标添加成功');
                        }
                    }
                    
                    this.closeIndicatorDrawer();
                },

                // 指标选择变化处理
                handleIndicatorSelectionChange(selection) {
                    this.selectedIndicators = selection;
                },

                // 清空指标筛选
                clearIndicatorFilter() {
                    this.indicatorFilter = {
                        category: '',
                        direction: '',
                        keyword: ''
                    };
                },

                // 指标分页大小变化
                handleIndicatorSizeChange(size) {
                    this.indicatorPagination.pageSize = size;
                    this.indicatorPagination.currentPage = 1;
                },

                // 指标当前页变化
                handleIndicatorCurrentChange(page) {
                    this.indicatorPagination.currentPage = page;
                },

                // ========== 变量管理方法 ==========
                
                // 显示变量选择器
                showVariableSelector() {
                    this.variableSelectorVisible = true;
                },

                // 关闭变量选择器
                closeVariableSelector() {
                    this.variableSelectorVisible = false;
                },

                // 添加参与变量
                addParticipatingVariable(variableName) {
                    if (!this.indicatorForm.participatingVariables.includes(variableName)) {
                        this.indicatorForm.participatingVariables.push(variableName);
                    }
                    this.closeVariableSelector();
                },

                // 移除参与变量
                removeParticipatingVariable(variableName) {
                    const index = this.indicatorForm.participatingVariables.indexOf(variableName);
                    if (index > -1) {
                        this.indicatorForm.participatingVariables.splice(index, 1);
                    }
                },

                // 获取变量描述
                getVariableDescription(variableName) {
                    const variable = this.availableVariables.find(v => v.name === variableName);
                    if (variable) {
                        if (variable.type === 'dynamic') {
                            return `${variable.unit} - ${variable.code}`;
                        } else {
                            return variable.code;
                        }
                    }
                    return '';
                },

                // 变量拖拽开始
                onVariableDragStart(event, variableName) {
                    event.dataTransfer.setData('text/plain', variableName);
                    event.dataTransfer.effectAllowed = 'copy';
                },

                // ========== 公式编辑器方法 ==========
                
                // 插入运算符
                insertOperator(operator) {
                    if (this.isIndicatorViewMode) return;
                    
                    if (this.logicalOperators.includes(operator) || this.conditionalOperators.includes(operator)) {
                        if (this.indicatorForm.formula && !this.indicatorForm.formula.endsWith(' ')) {
                            this.indicatorForm.formula += ' ';
                        }
                        this.indicatorForm.formula += operator + ' ';
                    } else {
                        this.indicatorForm.formula += operator;
                    }
                },

                // 公式输入处理
                onFormulaInput(event) {
                    if (this.isIndicatorViewMode) return;
                    
                    this.indicatorForm.formula = event.target.innerText;
                },

                // 公式拖拽悬停
                onFormulaDragOver(event) {
                    if (this.isIndicatorViewMode) return;
                    
                    event.preventDefault();
                    this.isFormulaDragOver = true;
                },

                // 公式拖拽离开
                onFormulaDragLeave(event) {
                    if (this.isIndicatorViewMode) return;
                    
                    this.isFormulaDragOver = false;
                },

                // 公式拖拽放置
                onFormulaDrop(event) {
                    if (this.isIndicatorViewMode) return;
                    
                    event.preventDefault();
                    this.isFormulaDragOver = false;
                    
                    const variableName = event.dataTransfer.getData('text/plain');
                    if (variableName) {
                        this.indicatorForm.formula += `[${variableName}]`;
                    }
                },

                // 验证公式
                validateFormula() {
                    const formula = this.indicatorForm.formula.trim();
                    
                    if (!formula) {
                        this.formulaStatus = '请先输入公式';
                        this.formulaStatusClass = 'invalid';
                        return;
                    }
                    
                    let isValid = true;
                    let errors = [];
                    
                    // 检查括号匹配
                    const leftBrackets = (formula.match(/\[/g) || []).length;
                    const rightBrackets = (formula.match(/\]/g) || []).length;
                    if (leftBrackets !== rightBrackets) {
                        isValid = false;
                        errors.push('方括号不匹配');
                    }
                    
                    const leftParens = (formula.match(/\(/g) || []).length;
                    const rightParens = (formula.match(/\)/g) || []).length;
                    if (leftParens !== rightParens) {
                        isValid = false;
                        errors.push('圆括号不匹配');
                    }
                    
                    if (formula.includes('if') && !formula.includes('then')) {
                        isValid = false;
                        errors.push('if语句缺少then');
                    }
                    
                    if (formula.includes('then') && !formula.includes('if')) {
                        isValid = false;
                        errors.push('then语句缺少if');
                    }
                    
                    if (isValid) {
                        this.formulaStatus = '公式语法正确';
                        this.formulaStatusClass = 'valid';
                    } else {
                        this.formulaStatus = '公式语法错误：' + errors.join('，');
                        this.formulaStatusClass = 'invalid';
                    }
                },

                // 格式化公式
                formatFormula() {
                    if (this.isIndicatorViewMode) return;
                    
                    let formula = this.indicatorForm.formula.trim();
                    
                    // 简单的格式化：在运算符前后添加空格
                    formula = formula.replace(/([+\-*/=()])/g, ' $1 ');
                    formula = formula.replace(/\s+/g, ' ').trim();
                    
                    this.indicatorForm.formula = formula;
                },

                // 清空公式
                clearFormula() {
                    if (this.isIndicatorViewMode) return;
                    
                    this.indicatorForm.formula = '';
                    this.formulaStatus = '';
                    this.formulaStatusClass = '';
                },

                // ========== 指标配置方法 ==========
                
                // 配置指标
                configureIndicator(indicator) {
                    this.currentConfigIndicator = indicator;
                    this.indicatorConfigDrawerVisible = true;
                    
                    // 初始化配置表单
                    this.indicatorConfigForm = {
                        activeTab: 'collection',
                        selectedData: [],
                        formula: indicator.formula || '',
                        collectionDataSource: '',
                        collectionPointName: '',
                        collectionPointCode: '',
                        businessPropertyName: '',
                        businessPropertyCode: '',
                        indicatorName: '',
                        indicatorCode: ''
                    };
                    
                    // 初始化公式输入相关
                    this.indicatorConfigFormulaInputMode = 'expression';
                    this.indicatorConfigNaturalLanguageInput = '';
                    this.indicatorConfigIsTranslating = false;
                    this.indicatorConfigTranslatedExpression = '';
                    this.indicatorConfigVisualFormulaParts = [];
                    this.indicatorConfigSelectedBlockIndex = -1;
                    this.indicatorConfigNumberInput = '';
                    
                    // 如果已有参与变量，加载到已选择数据中
                    if (indicator.participatingVariables && indicator.participatingVariables.length > 0) {
                        // 这里需要根据变量名称找到对应的数据项
                        // 暂时使用简单的映射
                        indicator.participatingVariables.forEach(variableName => {
                            // 尝试从不同数据源中找到匹配的变量
                            let found = false;
                            
                            // 从采集参数中查找
                            const collectionPoint = this.dataPoints.find(point => point.name === variableName);
                            if (collectionPoint) {
                                this.indicatorConfigForm.selectedData.push({
                                    id: `collection_${collectionPoint.code}`,
                                    name: collectionPoint.name,
                                    code: collectionPoint.code,
                                    sourceType: '采集参数',
                                    data: collectionPoint
                                });
                                found = true;
                            }
                            
                            // 从业务属性中查找
                            if (!found && this.selectedAssetType && this.selectedAssetType.businessProperties) {
                                const businessProperty = this.selectedAssetType.businessProperties.find(prop => prop.name === variableName);
                                if (businessProperty) {
                                    this.indicatorConfigForm.selectedData.push({
                                        id: `business_${businessProperty.code}`,
                                        name: businessProperty.name,
                                        code: businessProperty.code,
                                        sourceType: '业务属性',
                                        data: businessProperty
                                    });
                                    found = true;
                                }
                            }
                            
                            // 从指标中查找
                            if (!found && this.selectedAssetType && this.selectedAssetType.indicators) {
                                const indicatorItem = this.selectedAssetType.indicators.find(ind => ind.name === variableName);
                                if (indicatorItem) {
                                    this.indicatorConfigForm.selectedData.push({
                                        id: `indicator_${indicatorItem.code}`,
                                        name: indicatorItem.name,
                                        code: indicatorItem.code,
                                        sourceType: '指标',
                                        data: indicatorItem
                                    });
                                }
                            }
                        });
                    }
                },

                // 数据源标签页切换
                handleDataSourceTabChange(tab) {
                    this.indicatorConfigForm.activeTab = tab.name;
                },

                // 指标配置输入模式切换
                handleIndicatorConfigInputModeChange(tab) {
                    this.indicatorConfigFormulaInputMode = tab.name;
                },

                // 搜索采集变量
                searchCollectionVariables() {
                    // 搜索逻辑已在计算属性中实现
                },

                // 清空采集变量搜索
                clearCollectionVariableSearch() {
                    this.indicatorConfigForm.collectionVariableName = '';
                    this.indicatorConfigForm.collectionVariableCode = '';
                },

                // 处理采集变量选择变化
                handleCollectionVariableSelectionChange(selection) {
                    // 将选中的采集变量添加到已选择数据中
                    selection.forEach(variable => {
                        const existingIndex = this.indicatorConfigForm.selectedData.findIndex(item => 
                            item.id === `collection_${variable.code}`
                        );
                        
                        if (existingIndex === -1) {
                            this.indicatorConfigForm.selectedData.push({
                                id: `collection_${variable.code}`,
                                name: variable.name,
                                code: variable.code,
                                sourceType: '采集参数',
                                data: variable
                            });
                        }
                    });
                },

                // 切换采集变量选择
                toggleCollectionVariableSelection(variable) {
                    const existingIndex = this.indicatorConfigForm.selectedData.findIndex(item => 
                        item.id === `collection_${variable.code}`
                    );
                    
                    if (existingIndex > -1) {
                        // 如果已存在，则移除
                        this.indicatorConfigForm.selectedData.splice(existingIndex, 1);
                    } else {
                        // 如果不存在，则添加
                        this.indicatorConfigForm.selectedData.push({
                            id: `collection_${variable.code}`,
                            name: variable.name,
                            code: variable.code,
                            sourceType: '采集参数',
                            data: variable
                        });
                    }
                },

                // 搜索业务属性
                searchBusinessProperties() {
                    // 搜索逻辑已在计算属性中实现
                },

                // 清空业务属性搜索
                clearBusinessSearch() {
                    this.indicatorConfigForm.businessPropertyName = '';
                    this.indicatorConfigForm.businessPropertyCode = '';
                },

                // 搜索指标
                searchIndicators() {
                    // 搜索逻辑已在计算属性中实现
                },

                // 清空指标搜索
                clearIndicatorSearch() {
                    this.indicatorConfigForm.indicatorName = '';
                    this.indicatorConfigForm.indicatorCode = '';
                },

                // 处理采集参数选择变化
                handleCollectionSelectionChange(selection) {
                    // 将选中的采集参数添加到已选择数据中
                    selection.forEach(point => {
                        const existingIndex = this.indicatorConfigForm.selectedData.findIndex(item => 
                            item.id === `collection_${point.code}`
                        );
                        
                        if (existingIndex === -1) {
                            this.indicatorConfigForm.selectedData.push({
                                id: `collection_${point.code}`,
                                name: point.name,
                                code: point.code,
                                sourceType: '采集参数',
                                data: point
                            });
                        }
                    });
                },

                // 切换采集参数选择
                toggleCollectionSelection(row) {
                    const existingIndex = this.indicatorConfigForm.selectedData.findIndex(item => 
                        item.id === `collection_${row.code}`
                    );
                    
                    if (existingIndex > -1) {
                        this.indicatorConfigForm.selectedData.splice(existingIndex, 1);
                    } else {
                        this.indicatorConfigForm.selectedData.push({
                            id: `collection_${row.code}`,
                            name: row.name,
                            code: row.code,
                            sourceType: '采集参数',
                            data: row
                        });
                    }
                },

                // 处理业务属性选择变化
                handleBusinessSelectionChange(selection) {
                    // 将选中的业务属性添加到已选择数据中
                    selection.forEach(property => {
                        const existingIndex = this.indicatorConfigForm.selectedData.findIndex(item => 
                            item.id === `business_${property.code}`
                        );
                        
                        if (existingIndex === -1) {
                            this.indicatorConfigForm.selectedData.push({
                                id: `business_${property.code}`,
                                name: property.name,
                                code: property.code,
                                sourceType: '业务属性',
                                data: property
                            });
                        }
                    });
                },

                // 切换业务属性选择
                toggleBusinessSelection(row) {
                    const existingIndex = this.indicatorConfigForm.selectedData.findIndex(item => 
                        item.id === `business_${row.code}`
                    );
                    
                    if (existingIndex > -1) {
                        this.indicatorConfigForm.selectedData.splice(existingIndex, 1);
                    } else {
                        this.indicatorConfigForm.selectedData.push({
                            id: `business_${row.code}`,
                            name: row.name,
                            code: row.code,
                            sourceType: '业务属性',
                            data: row
                        });
                    }
                },

                // 处理指标选择变化
                handleConfigIndicatorSelectionChange(selection) {
                    // 将选中的指标添加到已选择数据中
                    selection.forEach(indicator => {
                        const existingIndex = this.indicatorConfigForm.selectedData.findIndex(item => 
                            item.id === `indicator_${indicator.code}`
                        );
                        
                        if (existingIndex === -1) {
                            this.indicatorConfigForm.selectedData.push({
                                id: `indicator_${indicator.code}`,
                                name: indicator.name,
                                code: indicator.code,
                                sourceType: '指标',
                                data: indicator
                            });
                        }
                    });
                },

                // 切换指标选择
                toggleConfigIndicatorSelection(row) {
                    const existingIndex = this.indicatorConfigForm.selectedData.findIndex(item => 
                        item.id === `indicator_${row.code}`
                    );
                    
                    if (existingIndex > -1) {
                        this.indicatorConfigForm.selectedData.splice(existingIndex, 1);
                    } else {
                        this.indicatorConfigForm.selectedData.push({
                            id: `indicator_${row.code}`,
                            name: row.name,
                            code: row.code,
                            sourceType: '指标',
                            data: row
                        });
                    }
                },

                // 移除已选择的数据
                removeSelectedData(index) {
                    this.indicatorConfigForm.selectedData.splice(index, 1);
                },

                // 插入数据项到公式
                insertDataItem(item) {
                    if (this.indicatorConfigFormulaInputMode === 'visual') {
                        this.insertIndicatorConfigVariable(item);
                    } else {
                        this.indicatorConfigForm.formula += `[${item.name}]`;
                    }
                },

                // 插入变量到可视化公式
                insertIndicatorConfigVariable(item) {
                    this.indicatorConfigVisualFormulaParts.push({
                        type: 'variable',
                        sourceType: item.sourceType,
                        name: item.name,
                        data: item
                    });
                },

                // 插入数字到可视化公式
                insertIndicatorConfigNumber() {
                    if (this.indicatorConfigNumberInput.trim()) {
                        this.indicatorConfigVisualFormulaParts.push({
                            type: 'number',
                            value: this.indicatorConfigNumberInput.trim()
                        });
                        this.indicatorConfigNumberInput = '';
                    }
                },

                // 选择可视化公式块
                selectIndicatorConfigBlock(index) {
                    this.indicatorConfigSelectedBlockIndex = index;
                },

                // 删除可视化公式块
                deleteIndicatorConfigBlock(index) {
                    this.indicatorConfigVisualFormulaParts.splice(index, 1);
                    this.indicatorConfigSelectedBlockIndex = -1;
                },

                // 处理指标配置自然语言输入
                handleIndicatorConfigNaturalLanguageInput() {
                    this.indicatorConfigIsTranslating = true;
                    
                    // 模拟AI翻译过程
                    setTimeout(() => {
                        const input = this.indicatorConfigNaturalLanguageInput;
                        let translated = '';
                        
                        // 简单的翻译逻辑
                        if (input.includes('加上') || input.includes('加')) {
                            translated = input.replace(/加上|加/g, '+');
                        } else if (input.includes('减去') || input.includes('减')) {
                            translated = input.replace(/减去|减/g, '-');
                        } else if (input.includes('乘以') || input.includes('乘')) {
                            translated = input.replace(/乘以|乘/g, '*');
                        } else if (input.includes('除以') || input.includes('除')) {
                            translated = input.replace(/除以|除/g, '/');
                        } else {
                            translated = input;
                        }
                        
                        // 替换变量名称
                        this.indicatorConfigForm.selectedData.forEach(item => {
                            translated = translated.replace(new RegExp(item.name, 'g'), `[${item.name}]`);
                        });
                        
                        this.indicatorConfigForm.formula = translated;
                        this.indicatorConfigTranslatedExpression = translated;
                        this.indicatorConfigIsTranslating = false;
                        this.indicatorConfigFormulaInputMode = 'expression';
                        
                        this.$message.success('AI转换完成');
                    }, 1000);
                },

                // 验证指标配置公式
                validateIndicatorConfigFormula() {
                    const formula = this.indicatorConfigForm.formula.trim();
                    
                    if (!formula) {
                        this.$message.warning('请先输入公式');
                        return;
                    }
                    
                    let isValid = true;
                    let errors = [];
                    
                    // 检查括号匹配
                    const leftBrackets = (formula.match(/\[/g) || []).length;
                    const rightBrackets = (formula.match(/\]/g) || []).length;
                    if (leftBrackets !== rightBrackets) {
                        isValid = false;
                        errors.push('方括号不匹配');
                    }
                    
                    const leftParens = (formula.match(/\(/g) || []).length;
                    const rightParens = (formula.match(/\)/g) || []).length;
                    if (leftParens !== rightParens) {
                        isValid = false;
                        errors.push('圆括号不匹配');
                    }
                    
                    if (formula.includes('if') && !formula.includes('then')) {
                        isValid = false;
                        errors.push('if语句缺少then');
                    }
                    
                    if (formula.includes('then') && !formula.includes('if')) {
                        isValid = false;
                        errors.push('then语句缺少if');
                    }
                    
                    if (isValid) {
                        this.$message.success('公式语法正确');
                    } else {
                        this.$message.error('公式语法错误：' + errors.join('，'));
                    }
                },

                // 保存指标配置
                saveIndicatorConfig() {
                    if (!this.currentConfigIndicator) {
                        this.$message.error('未找到要配置的指标');
                        return;
                    }
                    
                    // 更新指标的参与变量和公式
                    this.currentConfigIndicator.participatingVariables = this.indicatorConfigForm.selectedData.map(item => item.name);
                    this.currentConfigIndicator.formula = this.indicatorConfigForm.formula;
                    
                    this.indicatorConfigDrawerVisible = false;
                    this.$message.success('指标配置已保存');
                },


            },
            mounted() {
                // 检查URL参数，确定是否进入编辑模式
                const urlParams = new URLSearchParams(window.location.search);
                const mode = urlParams.get('mode');
                const modelId = urlParams.get('id');
                
                if (mode === 'edit') {
                    this.isEditMode = true;
                    this.isReadOnly = false;
                    this.pageTitle = '编辑工厂模型';
                    this.pageDescription = '编辑工厂数字孪生模型信息';
                } else {
                    this.isEditMode = false;
                    this.isReadOnly = true;
                    this.pageTitle = '查看工厂模型';
                    this.pageDescription = '查看工厂数字孪生模型信息';
                }
                
                // 如果有模型ID，加载对应的模型数据
                if (modelId) {
                    console.log('加载模型ID:', modelId);
                    this.loadModelData(modelId);
                }
                
                this.filterNodes(); // 初始化过滤
                // 初始化展开状态，让所有节点默认展开
                this.expandAllNodes(this.treeData);
                // 初始化资产列表
                this.filteredAssets = [];
                console.log('工厂模型管理页面已加载，编辑模式:', this.isEditMode);
                console.log('基本信息展开状态:', this.basicInfoExpanded);
            }
        });
    </script>
</body>
</html> 