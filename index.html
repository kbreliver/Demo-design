<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ°´æ³¥å·¥å‚æ•°å­—å­ªç”Ÿç³»ç»Ÿ</title>
    <script src="https://unpkg.com/three@0.128.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <!--
    <script src="https://cdn.bootcdn.net/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/three.js/r128/controls/OrbitControls.js"></script>
    -->
    
    <!-- å¤‡ç”¨CDNé“¾æ¥ï¼Œå¦‚æœä¸Šé¢çš„å¤±è´¥å¯ä»¥å°è¯•ä¸‹é¢çš„ -->
    <!--
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    
    æˆ–è€…ä½¿ç”¨UNPKG:
    <script src="https://unpkg.com/three@0.128.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: #1a1a1a;
            color: #fff;
            overflow: hidden;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .content-wrapper {
            display: flex;
            flex: 1;
        }

        /* å·¦ä¾§æŒ‡æ ‡é¢æ¿ */
        .sidebar {
            width: 300px;
            background: #2d2d2d;
            border-right: 1px solid #444;
            overflow-y: auto;
            position: relative;
            z-index: 1001;
            padding: 20px;
        }

        .sidebar-header {
            padding: 0 0 20px 0;
            background: transparent;
            border-bottom: 1px solid #444;
            display: none;
        }

        /* æ ‘å½¢ä¸‹æ‹‰æ¡†æ ·å¼ */
        .tree-dropdown {
            position: relative;
            display: inline-block;
        }

        .tree-dropdown-button {
            padding: 8px 16px;
            background: #404040;
            border: 1px solid #666;
            color: #fff;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 200px;
            justify-content: space-between;
        }

        .tree-dropdown-button:hover {
            background: #505050;
        }

        .tree-dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: #2d2d2d;
            border: 1px solid #666;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            min-width: 280px;
            max-height: 400px;
            overflow-y: auto;
        }

        .tree-dropdown-content.show {
            display: block;
        }

        .tree-container {
            padding: 10px;
        }

        .tree-node {
            margin: 5px 0;
            cursor: pointer;
            user-select: none;
        }

        .tree-node-content {
            padding: 8px 12px;
            border-radius: 4px;
            transition: background 0.3s;
            position: relative;
        }

        .tree-node-content:hover {
            background: #404040;
        }

        .tree-node-content.active {
            background: #0078d4;
        }

        .tree-node-content.alarm-low {
            animation: blinkYellow 1s infinite;
        }

        .tree-node-content.alarm-medium {
            animation: blinkOrange 1s infinite;
        }

        .tree-node-content.alarm-high {
            animation: blinkRed 1s infinite;
        }

        .tree-node-icon {
            display: inline-block;
            width: 16px;
            margin-right: 8px;
        }

        /* å±•å¼€/æŠ˜å å›¾æ ‡ */
        .tree-expand-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            margin-right: 4px;
            cursor: pointer;
            text-align: center;
            font-size: 12px;
            line-height: 16px;
            color: #999;
            transition: transform 0.2s, color 0.2s;
            user-select: none;
        }

        .tree-expand-icon:hover {
            color: #0078d4;
        }

        .tree-expand-icon.expanded {
            transform: rotate(90deg);
        }

        .tree-node-label {
            cursor: pointer;
            flex: 1;
        }

        .tree-node-content {
            display: flex;
            align-items: center;
        }

        .tree-children {
            margin-left: 20px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .tree-children.expanded {
            max-height: 1000px;
        }

        /* ä¸»æ˜¾ç¤ºåŒºåŸŸ */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* é¡¶éƒ¨å·¥å…·æ  */
        .toolbar {
            height: 60px;
            background: #333;
            border-bottom: 1px solid #444;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            gap: 20px;
            width: 100%;
            box-sizing: border-box;
        }

        .toolbar-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toolbar-center {
            display: flex;
            align-items: center;
            gap: 20px;
            flex: 1;
            justify-content: center;
        }

        .toolbar-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mode-selector, .view-selector {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            padding: 8px 16px;
            background: #404040;
            border: 1px solid #666;
            color: #fff;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #505050;
        }

        .btn.active {
            background: #0078d4;
        }

        /* 3D/2Dæ˜¾ç¤ºåŒºåŸŸ */
        .display-area {
            flex: 1;
            position: relative;
            background: #1a1a1a;
            min-height: 0;
        }

        #canvas-container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        #three-canvas {
            position: absolute;
            top: 0;
            left: 0;
        }

        #svg-canvas {
            position: absolute;
            top: 0;
            left: 0;
            display: none;
        }

        /* ä¿¡æ¯æ‚¬æµ®æ¡† */
        .info-tooltip {
            position: absolute;
            background: rgba(45, 45, 45, 0.98);
            color: white;
            padding: 0;
            border-radius: 8px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            border: 1px solid #666;
            max-width: 280px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px);
            display: none;
        }

        .tooltip-header {
            background: #0078d4;
            color: white;
            padding: 8px 12px;
            border-radius: 8px 8px 0 0;
            font-weight: bold;
            font-size: 13px;
        }

        .tooltip-section {
            padding: 8px 12px;
            border-bottom: 1px solid #555;
        }

        .tooltip-section:last-child {
            border-bottom: none;
        }

        .tooltip-label {
            font-weight: bold;
            color: #ccc;
            margin-bottom: 4px;
            font-size: 11px;
            text-transform: uppercase;
        }

        .tooltip-metric {
            margin: 2px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tooltip-metric .metric-value {
            color: #0078d4;
            font-weight: bold;
        }

        .tooltip-status {
            padding: 6px 12px;
            font-weight: bold;
            text-align: center;
            border-radius: 0 0 8px 8px;
        }

        .tooltip-status.æ­£å¸¸ {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }

        .tooltip-status.å‘Šè­¦ {
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
        }

        .tooltip-note {
            padding: 6px 12px;
            background: rgba(0, 120, 212, 0.1);
            color: #87ceeb;
            font-size: 11px;
            border-radius: 0 0 8px 8px;
        }

        .tooltip-trend {
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0 0 8px 8px;
        }

        .trend-indicators {
            display: flex;
            gap: 8px;
            margin-top: 4px;
        }

        .trend-up {
            color: #ff6b6b;
        }

        .trend-stable {
            color: #ffd93d;
        }

        .trend-down {
            color: #6bcf7f;
        }

        .prediction-indicator {
            font-size: 10px;
            margin-left: 4px;
        }

        /* å³ä¾§æŒ‡æ ‡é¢æ¿ */
        .right-metrics-panel {
            width: 300px;
            background: #2d2d2d;
            border-left: 1px solid #444;
            padding: 20px;
            overflow-y: auto;
            position: relative;
            z-index: 1001;
        }

        .right-metrics-panel.hidden {
            display: none;
        }

        /* æŒ‡æ ‡é¡¹æ ·å¼ */
        .metric-item {
            margin-bottom: 15px;
            padding: 10px;
            background: #3d3d3d;
            border-radius: 4px;
        }

        .metric-label {
            font-size: 12px;
            color: #ccc;
            margin-bottom: 5px;
        }

        .metric-value {
            font-size: 18px;
            font-weight: bold;
            color: #0078d4;
        }

        /* å¼‚å¸¸æŒ‡æ ‡æ ·å¼ */
        .metric-value.abnormal {
            color: #ff4444 !important;
            animation: metricBlink 1.5s infinite;
        }

        @keyframes metricBlink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.6; }
        }

        .metric-unit {
            font-size: 12px;
            color: #999;
            margin-left: 5px;
        }

        /* ç¼–è¾‘æ¨¡å¼é¢æ¿ */
        .edit-panel {
            position: fixed;
            top: 60px;
            right: 0;
            width: 350px;
            height: calc(100vh - 60px);
            background: #2d2d2d;
            border-left: 1px solid #444;
            padding: 20px;
            overflow-y: auto;
            transform: translateX(100%);
            transition: transform 0.3s;
            z-index: 1001;
        }

        .edit-panel.visible {
            transform: translateX(0);
        }

        /* æ¨¡å¼æ§åˆ¶é¢æ¿ */
        .mode-control-panel {
            position: fixed;
            top: 60px;
            left: 300px;
            width: 350px;
            height: calc(100vh - 60px);
            background: #2d2d2d;
            border-right: 1px solid #444;
            padding: 20px;
            overflow-y: auto;
            transform: translateX(-100%);
            transition: transform 0.3s;
            z-index: 999;
            display: none;
        }

        .mode-control-panel.visible {
            transform: translateX(0);
            display: block;
        }

        .time-selector {
            margin-bottom: 20px;
        }

        .time-selector label {
            display: block;
            margin-bottom: 5px;
            color: #ccc;
        }

        .time-selector input, .time-selector select {
            width: 100%;
            padding: 8px;
            background: #404040;
            border: 1px solid #666;
            color: #fff;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .simulation-controls {
            margin-top: 20px;
        }

        .parameter-control {
            margin-bottom: 15px;
        }

        .parameter-control label {
            display: block;
            margin-bottom: 5px;
            color: #ccc;
            font-size: 12px;
        }

        .parameter-slider {
            width: 100%;
            margin-bottom: 5px;
        }

        .parameter-value {
            color: #0078d4;
            font-weight: bold;
        }

        .prediction-info {
            background: #1a4d3a;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            border-left: 4px solid #00ff88;
        }

        .history-info {
            background: #3d2a1a;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            border-left: 4px solid #ff8800;
        }

        .checkbox-group {
            margin-bottom: 20px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .checkbox-item input {
            margin-right: 10px;
        }

        /* å‘Šè­¦åŠ¨ç”» */
        @keyframes blinkYellow {
            0%, 50% { background-color: rgba(255, 255, 0, 0.3); }
            51%, 100% { background-color: transparent; }
        }

        @keyframes blinkOrange {
            0%, 50% { background-color: rgba(255, 165, 0, 0.3); }
            51%, 100% { background-color: transparent; }
        }

        @keyframes blinkRed {
            0%, 50% { background-color: rgba(255, 0, 0, 0.3); }
            51%, 100% { background-color: transparent; }
        }

        /* é¢åŒ…å±‘å¯¼èˆª */
        .breadcrumb {
            padding: 0px 20px;
            background: #3d3d3d;
            border-bottom: 1px solid #444;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .breadcrumb-content {
            display: flex;
            align-items: center;
        }

        .breadcrumb-item {
            color: #0078d4;
            cursor: pointer;
        }

        .breadcrumb-item:hover {
            text-decoration: underline;
        }

        .breadcrumb-separator {
            margin: 0 8px;
            color: #666;
        }

        /* æ§åˆ¶æŒ‰é’®ç»„ */
        .control-buttons {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-left: 10px;
        }

        /* æ‰å¹³åŒ–å›¾æ ‡æŒ‰é’® */
        .icon-button {
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 18px;
            padding: 8px;
            border-radius: 4px;
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 36px;
            min-height: 36px;
        }

        /* é‡ç½®æŒ‰é’®ç‰¹æ®Šæ ·å¼ */
        #reset-view-btn {
            transition: all 0.3s ease, transform 0.5s ease;
        }

        .icon-button:hover {
            background: #404040;
            color: #0078d4;
            transform: translateY(-1px);
        }

        .icon-button.active {
            color: #ff6600;
            background: rgba(255, 102, 0, 0.1);
        }

        /* å…¨å±€å·¥å…·æç¤º */
        .global-tooltip {
            position: fixed;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            z-index: 10000;
            pointer-events: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transform: translateX(-50%);
        }

        .global-tooltip.show {
            opacity: 1;
            visibility: visible;
        }

        /* ä¼˜åŒ–å›¾æ ‡æ˜¾ç¤º */
        #reset-view-btn {
            font-weight: bold;
        }

        #expand-toggle {
            font-size: 16px;
        }

        #edit-toggle {
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #edit-toggle.active {
            background: rgba(255, 102, 0, 0.2);
        }

        /* æ‰å¹³åŒ–ç¼–è¾‘å›¾æ ‡ */
        .flat-edit-icon {
            width: 16px;
            height: 16px;
            position: relative;
            transform: rotate(0deg);
            transition: transform 0.3s ease;
        }

        .edit-icon-inner {
            width: 16px;
            height: 16px;
            border: 2px solid #888;
            border-radius: 50%;
            position: relative;
            box-sizing: border-box;
        }

        .edit-icon-inner::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 2px;
            height: 8px;
            background: #888;
            transform: translate(-50%, -50%);
        }

        .edit-icon-inner::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 8px;
            height: 2px;
            background: #888;
            transform: translate(-50%, -50%);
        }

        #edit-toggle:hover .flat-edit-icon {
            transform: rotate(90deg);
        }

        #edit-toggle.active .flat-edit-icon {
            transform: rotate(180deg);
        }

        #edit-toggle:hover .edit-icon-inner,
        #edit-toggle:hover .edit-icon-inner::before,
        #edit-toggle:hover .edit-icon-inner::after {
            border-color: #0078d4;
            background: #0078d4;
        }

        #edit-toggle.active .edit-icon-inner,
        #edit-toggle.active .edit-icon-inner::before,
        #edit-toggle.active .edit-icon-inner::after {
            border-color: #ff6600;
            background: #ff6600;
        }

        /* å‘Šè­¦æŒ‰é’®æ ·å¼ */
        #alarm-toggle {
            position: relative;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #alarm-toggle:hover .flat-alarm-icon {
            border-bottom-color: #ff8833;
        }

        #alarm-toggle:hover .flat-alarm-icon::after {
            color: #fff;
        }

        /* æ‰å¹³åŒ–å‘Šè­¦å›¾æ ‡ */
        .flat-alarm-icon {
            width: 0;
            height: 0;
            border-left: 9px solid transparent;
            border-right: 9px solid transparent;
            border-bottom: 16px solid #ff6600;
            position: relative;
            animation: pulse 2s infinite;
            transition: all 0.3s ease;
        }

        .flat-alarm-icon::after {
            content: '!';
            position: absolute;
            top: 4px;
            left: -3.5px;
            color: #fff;
            font-size: 11px;
            font-weight: bold;
            text-align: center;
            width: 7px;
        }

        .alarm-count {
            position: absolute;
            top: -6px;
            right: -6px;
            background: #ff4444;
            color: white;
            border-radius: 10px;
            width: 18px;
            height: 18px;
            font-size: 10px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 18px;
            border: 2px solid #333;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            z-index: 1;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* å‘Šè­¦å¼¹æ¡† */
        .alarm-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10001;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(2px);
        }

        .alarm-modal.show {
            display: flex;
        }

        .alarm-content {
            background: #2d2d2d;
            border-radius: 8px;
            width: 500px;
            max-height: 600px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .alarm-header {
            background: #333;
            padding: 15px 20px;
            border-bottom: 1px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .alarm-header h3 {
            color: #fff;
            margin: 0;
            font-size: 16px;
        }

        .alarm-close {
            background: none;
            border: none;
            color: #888;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 3px;
            transition: all 0.3s;
        }

        .alarm-close:hover {
            background: #404040;
            color: #fff;
        }

        .alarm-stats {
            padding: 15px 20px;
            background: #353535;
            display: flex;
            gap: 15px;
        }

        .alarm-stat {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .alarm-stat:hover {
            background: #404040;
            transform: translateY(-1px);
        }

        .alarm-stat.active {
            background: #505050;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .alarm-stat-icon {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .alarm-stat-high .alarm-stat-icon {
            background: #ff4444;
        }

        .alarm-stat-medium .alarm-stat-icon {
            background: #ff8800;
        }

        .alarm-stat-low .alarm-stat-icon {
            background: #ffdd00;
        }

        .alarm-stat-text {
            color: #ccc;
            margin-right: 8px;
        }

        .alarm-stat-badge {
            background: #666;
            color: white;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 12px;
            font-weight: bold;
            min-width: 20px;
            text-align: center;
        }

        .alarm-stat-high .alarm-stat-badge {
            background: #ff4444;
        }

        .alarm-stat-medium .alarm-stat-badge {
            background: #ff8800;
        }

        .alarm-stat-low .alarm-stat-badge {
            background: #ffdd00;
            color: #333;
        }

        .alarm-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .alarm-item {
            padding: 15px 20px;
            border-bottom: 1px solid #444;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .alarm-item:hover {
            background: #353535;
        }

        .alarm-item:last-child {
            border-bottom: none;
        }

        .alarm-item-level {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .alarm-item-level.high {
            background: #ff4444;
        }

        .alarm-item-level.medium {
            background: #ff8800;
        }

        .alarm-item-level.low {
            background: #ffdd00;
        }

        .alarm-item-content {
            flex: 1;
            cursor: pointer;
        }

        .alarm-item-title {
            color: #fff;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 2px;
        }

        .alarm-item-desc {
            color: #ccc;
            font-size: 12px;
        }

        .alarm-item-time {
            color: #888;
            font-size: 11px;
            flex-shrink: 0;
            margin-right: 12px;
        }

        /* å‘Šè­¦æ“ä½œæŒ‰é’® */
        .alarm-actions {
            display: flex;
            gap: 6px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .alarm-item:hover .alarm-actions {
            opacity: 1;
        }

        .alarm-action-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            font-weight: 500;
        }

        .alarm-action-handle {
            background: #28a745;
        }

        .alarm-action-handle:hover {
            background: #218838;
        }

        .alarm-action-forward {
            background: #007bff;
        }

        .alarm-action-forward:hover {
            background: #0056b3;
        }

        .alarm-action-ignore {
            background: #6c757d;
        }

        .alarm-action-ignore:hover {
            background: #545b62;
        }

        /* è¿‡æ»¤æç¤º */
        .alarm-filter-tip {
            padding: 8px 20px;
            background: #404040;
            color: #ccc;
            font-size: 12px;
            border-bottom: 1px solid #444;
            display: none;
        }

        .alarm-filter-tip.show {
            display: block;
        }

        .alarm-filter-clear {
            color: #0078d4;
            cursor: pointer;
            text-decoration: underline;
            margin-left: 8px;
        }

        .alarm-filter-clear:hover {
            color: #40a0e6;
        }

        /* å¯ç‚¹å‡»å…ƒç´ æ ·å¼ */
        .equipment, .component, .workshop-area {
            cursor: pointer;
            transition: opacity 0.3s, transform 0.2s;
        }

        .equipment:hover, .component:hover, .workshop-area:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }

        .back-button {
            cursor: pointer;
            transition: transform 0.2s;
        }

        .back-button:hover {
            transform: scale(1.1);
        }

        /* 3Dåœºæ™¯ä¸­å¯ç‚¹å‡»æç¤º */
        #canvas-container {
            cursor: pointer;
        }

        /* ä¸‹é’»å±‚çº§æŒ‡ç¤º */
        .drill-level-indicator {
            position: absolute;
            top: 10px;
            right: 20px;
            background: rgba(0, 120, 212, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            z-index: 1000;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é¡¶éƒ¨å·¥å…·æ  - å æ»¡æµè§ˆå™¨å®½åº¦ -->
        <div class="toolbar">
            <!-- å·¦ä¾§ï¼šèµ„äº§å±‚çº§ä¸‹æ‹‰é€‰æ‹©å™¨ -->
            <div class="toolbar-left">
                <div class="tree-dropdown">
                    <div class="tree-dropdown-button" id="tree-dropdown-btn">
                        <span id="selected-asset">æ°´æ³¥å·¥å‚</span>
                        <span>â–¼</span>
                    </div>
                    <div class="tree-dropdown-content" id="tree-dropdown-content">
                        <div class="tree-container">
                            <div class="tree-node">
                                <div class="tree-node-content" data-level="factory" data-id="cement-factory">
                                    <span class="tree-expand-icon expanded">â–¶</span>
                                    <span class="tree-node-icon">ğŸ­</span>
                                    <span class="tree-node-label">æ°´æ³¥å·¥å‚</span>
                                </div>
                                <div class="tree-children expanded">
                                    <div class="tree-node">
                                        <div class="tree-node-content alarm-medium" data-level="workshop" data-id="crushing-workshop">
                                            <span class="tree-expand-icon expanded">â–¶</span>
                                            <span class="tree-node-icon">ğŸ”¨</span>
                                            <span class="tree-node-label">ç ´ç¢å·¥æ®µ</span>
                                        </div>
                                        <div class="tree-children expanded">
                                            <div class="tree-node">
                                                <div class="tree-node-content" data-level="equipment" data-id="crusher-1">
                                                    <span class="tree-expand-icon expanded">â–¶</span>
                                                    <span class="tree-node-icon">âš™ï¸</span>
                                                    <span class="tree-node-label">é¢šå¼ç ´ç¢æœº</span>
                                                </div>
                                                <div class="tree-children expanded">
                                                    <div class="tree-node">
                                                        <div class="tree-node-content alarm-high" data-level="component" data-id="crusher-motor">
                                                            <span class="tree-expand-icon" style="visibility: hidden;">â–¶</span>
                                                            <span class="tree-node-icon">ğŸ”§</span>
                                                            <span class="tree-node-label">ç”µæœº</span>
                                                        </div>
                                                    </div>
                                                    <div class="tree-node">
                                                        <div class="tree-node-content" data-level="component" data-id="crusher-bearing">
                                                            <span class="tree-expand-icon" style="visibility: hidden;">â–¶</span>
                                                            <span class="tree-node-icon">ğŸ”§</span>
                                                            <span class="tree-node-label">è½´æ‰¿</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="tree-node">
                                                <div class="tree-node-content" data-level="equipment" data-id="conveyor-1">
                                                    <span class="tree-expand-icon" style="visibility: hidden;">â–¶</span>
                                                    <span class="tree-node-icon">âš™ï¸</span>
                                                    <span class="tree-node-label">çš®å¸¦è¾“é€æœº</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="tree-node">
                                        <div class="tree-node-content" data-level="workshop" data-id="grinding-workshop">
                                            <span class="tree-expand-icon expanded">â–¶</span>
                                            <span class="tree-node-icon">ğŸŒªï¸</span>
                                            <span class="tree-node-label">ç²‰ç£¨å·¥æ®µ</span>
                                        </div>
                                        <div class="tree-children expanded">
                                            <div class="tree-node">
                                                <div class="tree-node-content alarm-low" data-level="equipment" data-id="ball-mill">
                                                    <span class="tree-expand-icon expanded">â–¶</span>
                                                    <span class="tree-node-icon">âš™ï¸</span>
                                                    <span class="tree-node-label">çƒç£¨æœº</span>
                                                </div>
                                                <div class="tree-children expanded">
                                                    <div class="tree-node">
                                                        <div class="tree-node-content" data-level="component" data-id="mill-motor">
                                                            <span class="tree-expand-icon" style="visibility: hidden;">â–¶</span>
                                                            <span class="tree-node-icon">ğŸ”§</span>
                                                            <span class="tree-node-label">ä¸»ç”µæœº</span>
                                                        </div>
                                                    </div>
                                                    <div class="tree-node">
                                                        <div class="tree-node-content" data-level="component" data-id="mill-gearbox">
                                                            <span class="tree-expand-icon" style="visibility: hidden;">â–¶</span>
                                                            <span class="tree-node-icon">ğŸ”§</span>
                                                            <span class="tree-node-label">å‡é€Ÿå™¨</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="tree-node">
                                                <div class="tree-node-content" data-level="equipment" data-id="separator">
                                                    <span class="tree-expand-icon" style="visibility: hidden;">â–¶</span>
                                                    <span class="tree-node-icon">âš™ï¸</span>
                                                    <span class="tree-node-label">é€‰ç²‰æœº</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="tree-node">
                                        <div class="tree-node-content" data-level="workshop" data-id="burning-workshop">
                                            <span class="tree-expand-icon expanded">â–¶</span>
                                            <span class="tree-node-icon">ğŸ”¥</span>
                                            <span class="tree-node-label">ç……çƒ§å·¥æ®µ</span>
                                        </div>
                                        <div class="tree-children expanded">
                                            <div class="tree-node">
                                                <div class="tree-node-content" data-level="equipment" data-id="rotary-kiln">
                                                    <span class="tree-expand-icon expanded">â–¶</span>
                                                    <span class="tree-node-icon">âš™ï¸</span>
                                                    <span class="tree-node-label">å›è½¬çª‘</span>
                                                </div>
                                                <div class="tree-children expanded">
                                                    <div class="tree-node">
                                                        <div class="tree-node-content" data-level="component" data-id="kiln-burner">
                                                            <span class="tree-expand-icon" style="visibility: hidden;">â–¶</span>
                                                            <span class="tree-node-icon">ğŸ”§</span>
                                                            <span class="tree-node-label">ç‡ƒçƒ§å™¨</span>
                                                        </div>
                                                    </div>
                                                    <div class="tree-node">
                                                        <div class="tree-node-content" data-level="component" data-id="kiln-cylinder">
                                                            <span class="tree-expand-icon" style="visibility: hidden;">â–¶</span>
                                                            <span class="tree-node-icon">ğŸ”§</span>
                                                            <span class="tree-node-label">çª‘ç­’ä½“</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ä¸­é—´ï¼šæ¨¡å¼å’Œè§†å›¾é€‰æ‹©å™¨ -->
            <div class="toolbar-center">
                <div class="mode-selector">
                    <label>è¿è¡Œæ¨¡å¼ï¼š</label>
                    <button class="btn active" data-mode="realtime">å®æ—¶ç›‘æ§</button>
                    <button class="btn" data-mode="history">å†å²å›çœ‹</button>
                    <button class="btn" data-mode="simulation">æ¨¡æ‹Ÿæ¨æ¼”</button>
                </div>
                
                <div class="view-selector">
                    <label>è§†å›¾æ¨¡å¼ï¼š</label>
                    <button class="btn active" data-view="3d">ä¸‰ç»´è§†å›¾</button>
                    <button class="btn" data-view="2d">å¹³é¢è§†å›¾</button>
                </div>
            </div>
            
            <!-- å³ä¾§ï¼šå‘Šè­¦å’Œç¼–è¾‘æ¨¡å¼ -->
            <div class="toolbar-right">
                <button class="icon-button" id="alarm-toggle" data-tooltip="å‘Šè­¦åˆ—è¡¨">
                    <div class="flat-alarm-icon"></div>
                    <span class="alarm-count" id="alarm-count">3</span>
                </button>
                <button class="icon-button" id="edit-toggle" data-tooltip="è§†å›¾ç¼–è¾‘">
                    <div class="flat-edit-icon">
                        <div class="edit-icon-inner"></div>
                    </div>
                </button>
            </div>
        </div>

        <!-- å†…å®¹åŒºåŸŸåŒ…è£…å™¨ -->
        <div class="content-wrapper">
            <!-- å·¦ä¾§æŒ‡æ ‡é¢æ¿ -->
            <div class="sidebar" id="metrics-panel">
                <div class="sidebar-header">
                    <h3>å®æ—¶æŒ‡æ ‡</h3>
                </div>
                <div class="metric-item">
                    <div class="metric-label">ç”Ÿäº§æ•ˆç‡</div>
                    <div class="metric-value">85.6<span class="metric-unit">%</span></div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">è®¾å¤‡è¿è¡Œç‡</div>
                    <div class="metric-value">92.3<span class="metric-unit">%</span></div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">èƒ½è€—æŒ‡æ ‡</div>
                    <div class="metric-value">245.8<span class="metric-unit">kWh/t</span></div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">æ¸©åº¦</div>
                    <div class="metric-value">1450<span class="metric-unit">â„ƒ</span></div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">å‹åŠ›</div>
                    <div class="metric-value">2.5<span class="metric-unit">MPa</span></div>
                </div>
            </div>

            <!-- ä¸»å†…å®¹åŒºåŸŸ -->
            <div class="main-content">

            <!-- é¢åŒ…å±‘å¯¼èˆª -->
            <div class="breadcrumb">
                <div class="breadcrumb-content">
                    <span class="breadcrumb-item" data-id="cement-factory">æ°´æ³¥å·¥å‚</span>
                </div>
                <div class="control-buttons">
                    <button class="icon-button" id="reset-view-btn" data-tooltip="é‡ç½®è§†è§’" onclick="resetCameraView()">
                        â†»
                    </button>
                    <button class="icon-button" id="expand-toggle" data-tooltip="å…¨å±è§†å›¾">
                        â¤¢
                    </button>
                </div>
            </div>

            <!-- ä¸‹é’»å±‚çº§æŒ‡ç¤ºå™¨ -->
            <div class="drill-level-indicator" id="drill-indicator">
                å·¥å‚æ€»è§ˆ
            </div>

            <!-- æ˜¾ç¤ºåŒºåŸŸ -->
            <div class="display-area">
                <div id="canvas-container">
                    <canvas id="three-canvas"></canvas>
                    <svg id="svg-canvas" width="100%" height="100%"></svg>
                </div>
                
                <!-- ä¿¡æ¯æ‚¬æµ®æ¡† -->
                <div class="info-tooltip" id="tooltip">
                    <div class="tooltip-content"></div>
                </div>
                
                <!-- å…¨å±€å·¥å…·æç¤º -->
                <div class="global-tooltip" id="global-tooltip"></div>
            </div>
                </div>

        <!-- å‘Šè­¦å¼¹æ¡† -->
        <div class="alarm-modal" id="alarm-modal">
            <div class="alarm-content">
                <div class="alarm-header">
                    <h3>ç³»ç»Ÿå‘Šè­¦</h3>
                    <button class="alarm-close" id="alarm-close">Ã—</button>
                </div>
                <div class="alarm-stats">
                    <div class="alarm-stat alarm-stat-high" data-filter="high">
                        <div class="alarm-stat-icon"></div>
                        <span class="alarm-stat-text">é«˜çº§å‘Šè­¦</span>
                        <span class="alarm-stat-badge" id="high-alarm-count">1</span>
                    </div>
                    <div class="alarm-stat alarm-stat-medium" data-filter="medium">
                        <div class="alarm-stat-icon"></div>
                        <span class="alarm-stat-text">ä¸­çº§å‘Šè­¦</span>
                        <span class="alarm-stat-badge" id="medium-alarm-count">1</span>
                    </div>
                    <div class="alarm-stat alarm-stat-low" data-filter="low">
                        <div class="alarm-stat-icon"></div>
                        <span class="alarm-stat-text">ä½çº§å‘Šè­¦</span>
                        <span class="alarm-stat-badge" id="low-alarm-count">1</span>
                    </div>
                </div>
                <div class="alarm-filter-tip" id="alarm-filter-tip">
                    æ­£åœ¨æ˜¾ç¤ºï¼š<span id="filter-text">æ‰€æœ‰å‘Šè­¦</span>
                    <span class="alarm-filter-clear" onclick="clearAlarmFilter()">æ˜¾ç¤ºå…¨éƒ¨</span>
                </div>
                <div class="alarm-list" id="alarm-list">
                    <!-- å‘Šè­¦é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>

            <!-- å³ä¾§æŒ‡æ ‡é¢æ¿ -->
            <div class="right-metrics-panel" id="right-metrics-panel">
                <div class="sidebar-header">
                    <h3>ç³»ç»Ÿæ¦‚è§ˆ</h3>
                </div>
                <div class="metric-item">
                    <div class="metric-label">æ•´ä½“ç”Ÿäº§æ•ˆç‡</div>
                    <div class="metric-value">85.6<span class="metric-unit">%</span></div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">è®¾å¤‡æ€»è¿è¡Œç‡</div>
                    <div class="metric-value">92.3<span class="metric-unit">%</span></div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">å¹³å‡èƒ½è€—</div>
                    <div class="metric-value">245.8<span class="metric-unit">kWh/t</span></div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">ä»Šæ—¥äº§é‡</div>
                    <div class="metric-value">2,340<span class="metric-unit">t</span></div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">å‘Šè­¦æ•°é‡</div>
                    <div class="metric-value">3<span class="metric-unit">é¡¹</span></div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">åœ¨çº¿è®¾å¤‡</div>
                    <div class="metric-value">24/26<span class="metric-unit">å°</span></div>
                </div>
            </div>
        </div>

                <!-- æ¨¡å¼æ§åˆ¶é¢æ¿ -->
        <div class="mode-control-panel" id="mode-control-panel">
            <h3 id="mode-panel-title">å®æ—¶ç›‘æ§</h3>
            
            <!-- å†å²å›çœ‹æ§åˆ¶ -->
            <div id="history-controls" style="display: none;">
                <div class="time-selector">
                    <label for="history-date">é€‰æ‹©æ—¥æœŸ:</label>
                    <input type="date" id="history-date" value="2024-01-15">
                    
                    <label for="history-time-start">å¼€å§‹æ—¶é—´:</label>
                    <input type="time" id="history-time-start" value="08:00">
                    
                    <label for="history-time-end">ç»“æŸæ—¶é—´:</label>
                    <input type="time" id="history-time-end" value="18:00">
                    
                    <button class="btn" onclick="loadHistoryData()">åŠ è½½å†å²æ•°æ®</button>
                </div>
                
                <div class="history-info">
                    <h4>å†å²æ•°æ®ä¿¡æ¯</h4>
                    <p>æ˜¾ç¤ºæ—¶é—´æ®µ: <span id="history-time-range">--</span></p>
                    <p>æ•°æ®ç‚¹æ•°é‡: <span id="history-data-points">--</span></p>
                </div>
            </div>
            
            <!-- æ¨¡æ‹Ÿæ¨æ¼”æ§åˆ¶ -->
            <div id="simulation-controls" style="display: none;">
                <div class="time-selector">
                    <label for="sim-base-date">åŸºç¡€æ•°æ®æ—¶é—´:</label>
                    <input type="date" id="sim-base-date" value="2024-01-15">
                    <input type="time" id="sim-base-time" value="14:00">
                    
                    <label for="sim-target-time">é¢„æµ‹åˆ°æ—¶é—´:</label>
                    <select id="sim-target-time">
                        <option value="1">1å°æ—¶å</option>
                        <option value="4">4å°æ—¶å</option>
                        <option value="8">8å°æ—¶å</option>
                        <option value="24">24å°æ—¶å</option>
                    </select>
                </div>
                
                <div class="simulation-controls">
                    <h4>è°ƒæ•´å‚æ•°</h4>
                    
                    <div class="parameter-control">
                        <label>ç”Ÿäº§è´Ÿè·è°ƒæ•´: <span class="parameter-value" id="load-value">100%</span></label>
                        <input type="range" class="parameter-slider" id="load-slider" min="50" max="150" value="100">
                    </div>
                    
                    <div class="parameter-control">
                        <label>åŸæ–™è´¨é‡ç³»æ•°: <span class="parameter-value" id="quality-value">1.0</span></label>
                        <input type="range" class="parameter-slider" id="quality-slider" min="0.8" max="1.2" step="0.1" value="1.0">
                    </div>
                    
                    <div class="parameter-control">
                        <label>è®¾å¤‡æ•ˆç‡ç³»æ•°: <span class="parameter-value" id="efficiency-value">100%</span></label>
                        <input type="range" class="parameter-slider" id="efficiency-slider" min="80" max="120" value="100">
                    </div>
                    
                    <button class="btn" onclick="runSimulation()">å¼€å§‹æ¨¡æ‹Ÿæ¨æ¼”</button>
                </div>
                
                <div class="prediction-info">
                    <h4>é¢„æµ‹ç»“æœ</h4>
                    <p>é¢„æµ‹äº§é‡: <span id="predicted-output">--</span> t/h</p>
                    <p>èƒ½è€—é¢„æµ‹: <span id="predicted-energy">--</span> kWh/t</p>
                    <p>è®¾å¤‡çŠ¶æ€: <span id="predicted-status">--</span></p>
                </div>
            </div>
        </div>

        <!-- ç¼–è¾‘æ¨¡å¼é¢æ¿ -->
        <div class="edit-panel" id="edit-panel">
            <h3>ç¼–è¾‘è®¾ç½®</h3>
            
            <div class="checkbox-group">
                <h4>æ˜¾ç¤ºæŒ‡æ ‡</h4>
                <div class="checkbox-item">
                    <input type="checkbox" id="metric-efficiency" checked>
                    <label for="metric-efficiency">ç”Ÿäº§æ•ˆç‡</label>
                        </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="metric-runtime" checked>
                    <label for="metric-runtime">è®¾å¤‡è¿è¡Œç‡</label>
                        </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="metric-energy" checked>
                    <label for="metric-energy">èƒ½è€—æŒ‡æ ‡</label>
                        </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="metric-temperature" checked>
                    <label for="metric-temperature">æ¸©åº¦</label>
                    </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="metric-pressure" checked>
                    <label for="metric-pressure">å‹åŠ›</label>
                </div>
            </div>

            <div class="checkbox-group">
                <h4>é¡µé¢å¸ƒå±€</h4>
                <div class="checkbox-item">
                    <input type="checkbox" id="layout-sidebar" checked>
                    <label for="layout-sidebar">å·¦ä¾§æŒ‡æ ‡é¢æ¿</label>
                    </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="layout-right-metrics" checked>
                    <label for="layout-right-metrics">å³ä¾§æŒ‡æ ‡é¢æ¿</label>
                    </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="layout-breadcrumb" checked>
                    <label for="layout-breadcrumb">é¢åŒ…å±‘å¯¼èˆª</label>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let scene, camera, renderer, controls;
        let currentView = '3d';
        let currentMode = 'realtime';
        let editMode = false;
        let selectedNode = null;
        let factoryData = {};
        let historyData = {};
        let simulationParams = {
            loadFactor: 1.0,
            qualityFactor: 1.0,
            efficiencyFactor: 1.0
        };
        let realTimeInterval = null;
        let isDataLoading = false;
        let currentDrillLevel = 'factory'; // å½“å‰ä¸‹é’»å±‚çº§
        let drillPath = []; // ä¸‹é’»è·¯å¾„

        // å‘Šè­¦æ•°æ®
        let alarmData = [
            {
                id: 'alarm-001',
                level: 'high',
                deviceId: 'crusher-motor',
                deviceName: 'é¢šå¼ç ´ç¢æœºç”µæœº',
                title: 'ç”µæœºæ¸©åº¦è¿‡é«˜',
                description: 'ç”µæœºæ¸©åº¦è¾¾åˆ°95â„ƒï¼Œè¶…è¿‡å®‰å…¨é˜ˆå€¼',
                time: '10:25',
                timestamp: Date.now() - 1000 * 60 * 35,
                status: 'active'
            },
            {
                id: 'alarm-002', 
                level: 'medium',
                deviceId: 'crushing-workshop',
                deviceName: 'ç ´ç¢å·¥æ®µ',
                title: 'æŒ¯åŠ¨å¼‚å¸¸',
                description: 'æ£€æµ‹åˆ°å¼‚å¸¸æŒ¯åŠ¨æ¨¡å¼ï¼Œå»ºè®®æ£€æŸ¥è®¾å¤‡',
                time: '09:45',
                timestamp: Date.now() - 1000 * 60 * 75,
                status: 'active'
            },
            {
                id: 'alarm-003',
                level: 'low',
                deviceId: 'ball-mill',
                deviceName: 'çƒç£¨æœº',
                title: 'æ•ˆç‡ä¸‹é™',
                description: 'ç”Ÿäº§æ•ˆç‡è¾ƒæ˜¨æ—¥ä¸‹é™5%ï¼Œè¯·å…³æ³¨',
                time: '09:12',
                timestamp: Date.now() - 1000 * 60 * 108,
                status: 'active'
            }
        ];

        // å‘Šè­¦è¿‡æ»¤çŠ¶æ€
        let currentAlarmFilter = null;

        // åˆå§‹åŒ–åº”ç”¨
        function init() {
            initTreeDropdown();
            init3DView();
            init2DView();
            initEventListeners();
            loadFactoryData();
            
            // ç¡®ä¿å·¦ä¾§æŒ‡æ ‡é¢æ¿å§‹ç»ˆå¯è§
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.style.display = 'block';
                sidebar.style.visibility = 'visible';
            }
            
            // ç¡®ä¿ä¾§è¾¹æ å¤é€‰æ¡†é€‰ä¸­
            const sidebarCheckbox = document.getElementById('layout-sidebar');
            if (sidebarCheckbox) {
                sidebarCheckbox.checked = true;
            }
            
            // å¯åŠ¨å®æ—¶æ¨¡å¼
            switchMode('realtime');
            
            // è®¾ç½®é»˜è®¤é€‰ä¸­èŠ‚ç‚¹
            selectedNode = { 
                id: 'cement-factory', 
                level: 'factory', 
                name: 'æ°´æ³¥å·¥å‚' 
            };
            
            // è®¾ç½®é»˜è®¤activeçŠ¶æ€
            const defaultNode = document.querySelector('[data-id="cement-factory"]');
            if (defaultNode) {
                defaultNode.classList.add('active');
            }
            
            updateBreadcrumb();
            updateMetricsForNode('cement-factory');
            
            // åˆå§‹åŒ–å³ä¾§æŒ‡æ ‡é¢æ¿
            updateRightMetricsPanel();
            
            // åˆå§‹åŒ–æ§åˆ¶æŒ‰é’®çŠ¶æ€
            const expandButton = document.getElementById('expand-toggle');
            if (expandButton) {
                expandButton.textContent = 'â¤¢';
                expandButton.setAttribute('data-tooltip', 'å…¨å±è§†å›¾');
            }
            
            // åˆå§‹åŒ–å‘Šè­¦æ˜¾ç¤º
            updateAlarmDisplay();
            
            // é¡µé¢åˆå§‹åŒ–æ—¶ä½¿ç”¨é‡ç½®è§†è§’
            setTimeout(() => {
                if (camera && controls) {
                    // è°ƒç”¨é‡ç½®è§†è§’åŠŸèƒ½ï¼Œè®¾ç½®åˆ°æœ€ä½³è§‚çœ‹è§’åº¦
                    resetCameraView();
                }
            }, 500);
        }

        // åˆå§‹åŒ–æ ‘å½¢ä¸‹æ‹‰æ¡†
        function initTreeDropdown() {
            const dropdownBtn = document.getElementById('tree-dropdown-btn');
            const dropdownContent = document.getElementById('tree-dropdown-content');
            const selectedAssetSpan = document.getElementById('selected-asset');
            
            // ä¸‹æ‹‰æ¡†å¼€å…³äº‹ä»¶
            dropdownBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                dropdownContent.classList.toggle('show');
            });
            
            // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰æ¡†
            document.addEventListener('click', function() {
                dropdownContent.classList.remove('show');
            });
            
            // é˜»æ­¢ä¸‹æ‹‰æ¡†å†…éƒ¨ç‚¹å‡»å…³é—­
            dropdownContent.addEventListener('click', function(e) {
                e.stopPropagation();
            });
            
            // åˆå§‹åŒ–æ ‘å½¢ç»“æ„
            initTreeView();
        }

        // åˆå§‹åŒ–æ ‘å½¢è§†å›¾
        function initTreeView() {
            const treeNodes = document.querySelectorAll('.tree-node-content');
            
            treeNodes.forEach(node => {
                // å±•å¼€/æŠ˜å å›¾æ ‡ç‚¹å‡»äº‹ä»¶
                const expandIcon = node.querySelector('.tree-expand-icon');
                if (expandIcon && expandIcon.style.visibility !== 'hidden') {
                    expandIcon.addEventListener('click', function(e) {
                        e.stopPropagation();
                        
                        // åˆ‡æ¢å±•å¼€çŠ¶æ€
                        const parent = node.parentElement;
                        const children = parent.querySelector('.tree-children');
                        if (children) {
                            children.classList.toggle('expanded');
                            this.classList.toggle('expanded');
                        }
                    });
                }
                
                // èŠ‚ç‚¹åç§°ç‚¹å‡»äº‹ä»¶
                const nodeLabel = node.querySelector('.tree-node-label');
                if (nodeLabel) {
                    nodeLabel.addEventListener('click', function(e) {
                        e.stopPropagation();
                        
                        // ä½¿ç”¨ç»Ÿä¸€çš„èŠ‚ç‚¹åˆ‡æ¢å‡½æ•°
                        switchToNode(node.dataset.id, 'tree_click');
                    });
                }
            });
        }

        // åˆå§‹åŒ–3Dè§†å›¾
        function init3DView() {
            const container = document.getElementById('canvas-container');
            const canvas = document.getElementById('three-canvas');
            
            // åˆ›å»ºåœºæ™¯
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a1a);
            
            // åˆ›å»ºç›¸æœº
            camera = new THREE.PerspectiveCamera(75, container.offsetWidth / container.offsetHeight, 0.1, 1000);
            camera.position.set(0, 25, 30); // è°ƒæ•´åˆ°æ›´å¥½çš„ä¿¯è§†è§’åº¦
            
            // åˆ›å»ºæ¸²æŸ“å™¨
            renderer = new THREE.WebGLRenderer({ canvas: canvas });
            renderer.setSize(container.offsetWidth, container.offsetHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            
            // åˆ›å»ºæ§åˆ¶å™¨
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.1;
            controls.target.set(0, 0, -10); // èšç„¦åœ¨å·¥æ®µåŒºåŸŸä¸­å¿ƒ
            controls.maxPolarAngle = Math.PI * 0.8; // é™åˆ¶å‚ç›´æ—‹è½¬è§’åº¦
            controls.minDistance = 10; // æœ€å°ç¼©æ”¾è·ç¦»
            controls.maxDistance = 100; // æœ€å¤§ç¼©æ”¾è·ç¦»
            
            // æ·»åŠ å…‰æº
            const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(50, 50, 50);
            directionalLight.castShadow = true;
            scene.add(directionalLight);
            
            // åˆ›å»ºå·¥å‚æ¨¡å‹
            createFactoryModel();
            
            // åº”ç”¨å‘Šè­¦æ•ˆæœ
            setTimeout(() => {
                saveOriginalColors();
                apply3DAlarmEffects();
                addEquipmentAnimations();
            }, 100);
            
            // é¼ æ ‡äº‹ä»¶
            const raycaster = new THREE.Raycaster();
            const mouse = new THREE.Vector2();
            
            // é¼ æ ‡ç§»åŠ¨äº‹ä»¶ï¼ˆå·¥å…·æç¤ºï¼‰
            canvas.addEventListener('mousemove', function(event) {
                const rect = canvas.getBoundingClientRect();
                mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
                mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
                
                raycaster.setFromCamera(mouse, camera);
                const intersects = raycaster.intersectObjects(scene.children, true);
                
                if (intersects.length > 0) {
                    const object = intersects[0].object;
                    showTooltip(event, object.userData);
                } else {
                    hideTooltip();
                }
            });

            // é¼ æ ‡ç‚¹å‡»äº‹ä»¶ï¼ˆä¸‹é’»ï¼‰
            canvas.addEventListener('click', function(event) {
                const rect = canvas.getBoundingClientRect();
                mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
                mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
                
                raycaster.setFromCamera(mouse, camera);
                const intersects = raycaster.intersectObjects(scene.children, true);
                
                if (intersects.length > 0) {
                    const object = intersects[0].object;
                    if (object.userData && object.userData.id) {
                        // ä½¿ç”¨ç»Ÿä¸€çš„èŠ‚ç‚¹åˆ‡æ¢å‡½æ•°
                        switchToNode(object.userData.id, '3d_click');
                    }
                }
            });
            
            // æ¸²æŸ“å¾ªç¯
            let lastTime = 0;
            function animate(currentTime) {
                requestAnimationFrame(animate);
                
                const deltaTime = (currentTime - lastTime) * 0.001; // è½¬æ¢ä¸ºç§’
                lastTime = currentTime;
                
                // æ›´æ–°æ§åˆ¶å™¨
                controls.update();
                
                // æ›´æ–°å‘Šè­¦é—ªçƒæ•ˆæœ
                updateBlinkingEffects();
                
                // æ›´æ–°è®¾å¤‡åŠ¨ç”»
                updateEquipmentAnimations(deltaTime);
                
                // æ¸²æŸ“åœºæ™¯
                renderer.render(scene, camera);
            }
            animate();
            
            // çª—å£å¤§å°è°ƒæ•´
            window.addEventListener('resize', function() {
                const width = container.offsetWidth;
                const height = container.offsetHeight;
                
                camera.aspect = width / height;
                camera.updateProjectionMatrix();
                renderer.setSize(width, height);
            });
        }

        // åˆå§‹åŒ–2Dè§†å›¾
        function init2DView() {
            const svg = document.getElementById('svg-canvas');
            
            // åˆ›å»º2Då·¥å‚å¸ƒå±€
            const factoryLayout = `
                <defs>
                    <!-- ç®­å¤´æ ‡è®°å®šä¹‰ -->
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                            refX="9" refY="3.5" orient="auto" markerUnits="strokeWidth">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#00ff88" />
                    </marker>
                    
                    <!-- æµåŠ¨åŠ¨ç”»å®šä¹‰ -->
                    <marker id="flow-dot" markerWidth="8" markerHeight="8" 
                            refX="4" refY="4" markerUnits="strokeWidth">
                        <circle cx="4" cy="4" r="3" fill="#00ff88" opacity="0.8">
                            <animate attributeName="opacity" values="0.3;1;0.3" dur="2s" repeatCount="indefinite"/>
                        </circle>
                    </marker>
                </defs>
                
                <g transform="translate(50, 50)">
                    <rect x="0" y="0" width="800" height="600" fill="#333" stroke="#666" stroke-width="2"/>
                    <text x="400" y="30" text-anchor="middle" fill="#fff" font-size="20">æ°´æ³¥å·¥å‚å¹³é¢å›¾</text>
                    
                    <!-- åŸæ–™åŒºåŸŸ -->
                    <g class="material-area">
                        <rect x="20" y="280" width="80" height="120" fill="#555" stroke="#888" stroke-width="1" stroke-dasharray="5,5"/>
                        <text x="60" y="330" text-anchor="middle" fill="#ccc" font-size="12">åŸæ–™åŒº</text>
                        <circle cx="60" cy="350" r="8" fill="#8b4513"/>
                        <text x="60" y="365" text-anchor="middle" fill="#ccc" font-size="8">çŸ³ç°çŸ³</text>
                    </g>
                    
                    <!-- ç ´ç¢å·¥æ®µ -->
                    <g class="workshop-area" data-id="crushing-workshop">
                        <rect x="130" y="80" width="180" height="150" fill="#554400" stroke="#ffaa00" stroke-width="3"/>
                        <text x="220" y="105" text-anchor="middle" fill="#fff" font-weight="bold">ç ´ç¢å·¥æ®µ</text>
                        
                        <!-- é¢šå¼ç ´ç¢æœº -->
                        <rect x="160" y="130" width="40" height="30" fill="#666" stroke="#333" stroke-width="1" class="equipment" data-id="crusher-1"/>
                        <circle cx="180" cy="145" r="15" fill="#ff0000" class="alarm-high equipment" data-id="crusher-1" opacity="0.7"/>
                        <text x="180" y="150" text-anchor="middle" fill="#fff" font-size="9">ç ´ç¢æœº</text>
                        
                        <!-- çš®å¸¦è¾“é€æœº -->
                        <rect x="220" y="140" width="60" height="10" fill="#222" class="equipment" data-id="conveyor-1"/>
                        <text x="250" y="165" text-anchor="middle" fill="#ccc" font-size="8">è¾“é€æœº</text>
                    </g>
                    
                    <!-- ç²‰ç£¨å·¥æ®µ -->
                    <g class="workshop-area" data-id="grinding-workshop">
                        <rect x="340" y="80" width="180" height="150" fill="#004455" stroke="#00aaff" stroke-width="3"/>
                        <text x="430" y="105" text-anchor="middle" fill="#fff" font-weight="bold">ç²‰ç£¨å·¥æ®µ</text>
                        
                        <!-- çƒç£¨æœº -->
                        <ellipse cx="380" cy="145" rx="25" ry="12" fill="#ffdd44" class="equipment" data-id="ball-mill"/>
                        <circle cx="380" cy="145" r="18" fill="#ffff00" class="alarm-low equipment" data-id="ball-mill" opacity="0.6"/>
                        <text x="380" y="150" text-anchor="middle" fill="#333" font-size="9">çƒç£¨æœº</text>
                        
                        <!-- é€‰ç²‰æœº -->
                        <circle cx="460" cy="145" r="15" fill="#777" class="equipment" data-id="separator"/>
                        <text x="460" y="150" text-anchor="middle" fill="#fff" font-size="8">é€‰ç²‰æœº</text>
                    </g>
                    
                    <!-- ç……çƒ§å·¥æ®µ -->
                    <g class="workshop-area" data-id="burning-workshop">
                        <rect x="550" y="80" width="180" height="150" fill="#550022" stroke="#ff6600" stroke-width="3"/>
                        <text x="640" y="105" text-anchor="middle" fill="#fff" font-weight="bold">ç……çƒ§å·¥æ®µ</text>
                        
                        <!-- å›è½¬çª‘ -->
                        <ellipse cx="640" cy="145" rx="45" ry="18" fill="#888" class="equipment" data-id="rotary-kiln"/>
                        <text x="640" y="150" text-anchor="middle" fill="#fff" font-size="10">å›è½¬çª‘</text>
                        
                        <!-- ç‡ƒçƒ§å™¨ -->
                        <circle cx="680" cy="145" r="8" fill="#ff6600">
                            <animate attributeName="fill" values="#ff6600;#ff3300;#ff6600" dur="1s" repeatCount="indefinite"/>
                        </circle>
                        <text x="680" y="165" text-anchor="middle" fill="#ccc" font-size="7">ç‡ƒçƒ§å™¨</text>
                    </g>
                    
                    <!-- æˆå“åŒºåŸŸ -->
                    <g class="material-area">
                        <rect x="760" y="280" width="80" height="120" fill="#555" stroke="#888" stroke-width="1" stroke-dasharray="5,5"/>
                        <text x="800" y="330" text-anchor="middle" fill="#ccc" font-size="12">æˆå“åŒº</text>
                        <circle cx="800" cy="350" r="8" fill="#666"/>
                        <text x="800" y="365" text-anchor="middle" fill="#ccc" font-size="8">æ°´æ³¥</text>
                    </g>
                    
                    <!-- ä¸»è¦ç‰©æ–™æµå‘çº¿ -->
                    <g class="flow-lines">
                        <!-- åŸæ–™åˆ°ç ´ç¢ -->
                        <line x1="100" y1="340" x2="160" y2="145" stroke="#00ff88" stroke-width="4" 
                              marker-end="url(#arrowhead)" opacity="0.8"/>
                        <text x="125" y="235" text-anchor="middle" fill="#00ff88" font-size="10">åŸæ–™æŠ•å…¥</text>
                        
                        <!-- ç ´ç¢åˆ°ç²‰ç£¨ -->
                        <line x1="310" y1="145" x2="340" y2="145" stroke="#00ff88" stroke-width="4" 
                              marker-end="url(#arrowhead)" opacity="0.8"/>
                        <text x="325" y="135" text-anchor="middle" fill="#00ff88" font-size="9">ç²—ç¢æ–™</text>
                        
                        <!-- ç²‰ç£¨åˆ°ç……çƒ§ -->
                        <line x1="520" y1="145" x2="550" y2="145" stroke="#00ff88" stroke-width="4" 
                              marker-end="url(#arrowhead)" opacity="0.8"/>
                        <text x="535" y="135" text-anchor="middle" fill="#00ff88" font-size="9">ç”Ÿæ–™</text>
                        
                        <!-- ç……çƒ§åˆ°æˆå“ -->
                        <line x1="730" y1="145" x2="760" y2="340" stroke="#00ff88" stroke-width="4" 
                              marker-end="url(#arrowhead)" opacity="0.8"/>
                        <text x="750" y="235" text-anchor="middle" fill="#00ff88" font-size="10">ç†Ÿæ–™/æ°´æ³¥</text>
                    </g>
                    
                    <!-- è¾…åŠ©æµå‘ -->
                    <g class="auxiliary-flows">
                        <!-- å¾ªç¯ç‰©æ–™æµ -->
                        <path d="M 445 160 Q 430 180, 415 160" stroke="#ffa500" stroke-width="2" 
                              fill="none" marker-end="url(#arrowhead)" opacity="0.6"/>
                        <text x="430" y="185" text-anchor="middle" fill="#ffa500" font-size="8">è¿”æ–™</text>
                        
                        <!-- å·¥è‰ºæµå‘ç‚¹ -->
                        <circle cx="275" cy="145" r="3" fill="#00ff88" opacity="0.8">
                            <animate attributeName="r" values="2;5;2" dur="1.5s" repeatCount="indefinite"/>
                        </circle>
                        
                        <circle cx="535" cy="145" r="3" fill="#00ff88" opacity="0.8">
                            <animate attributeName="r" values="2;5;2" dur="1.5s" repeatCount="indefinite" begin="0.5s"/>
                        </circle>
                    </g>
                    
                    <!-- æµå‘è¯´æ˜ -->
                    <g class="flow-legend">
                        <rect x="20" y="500" width="200" height="80" fill="#222" stroke="#555" stroke-width="1"/>
                        <text x="30" y="520" fill="#fff" font-size="12" font-weight="bold">ç‰©æ–™æµå‘è¯´æ˜</text>
                        
                        <line x1="30" y1="535" x2="60" y2="535" stroke="#00ff88" stroke-width="3" marker-end="url(#arrowhead)"/>
                        <text x="70" y="540" fill="#ccc" font-size="10">ä¸»è¦ç‰©æ–™æµ</text>
                        
                        <line x1="30" y1="550" x2="60" y2="550" stroke="#ffa500" stroke-width="2" marker-end="url(#arrowhead)"/>
                        <text x="70" y="555" fill="#ccc" font-size="10">å¾ªç¯/è¿”æ–™æµ</text>
                        
                        <circle cx="45" cy="565" r="3" fill="#00ff88"/>
                        <text x="55" y="570" fill="#ccc" font-size="10">æµå‘ç›‘æµ‹ç‚¹</text>
                    </g>
                </g>
            `;
            
            svg.innerHTML = factoryLayout;
            
            // æ·»åŠ 2Dé¼ æ ‡äº‹ä»¶
            svg.addEventListener('mousemove', function(event) {
                const target = event.target;
                if (target.classList.contains('equipment') || target.classList.contains('workshop-area')) {
                    showTooltip(event, target.dataset);
                } else {
                    hideTooltip();
                }
            });

            // æ·»åŠ 2Dç‚¹å‡»äº‹ä»¶ï¼ˆä¸‹é’»ï¼‰
            svg.addEventListener('click', function(event) {
                const target = event.target;
                if (target.dataset && target.dataset.id) {
                    // ä½¿ç”¨ç»Ÿä¸€çš„èŠ‚ç‚¹åˆ‡æ¢å‡½æ•°
                    switchToNode(target.dataset.id, '2d_click');
                }
            });
            
            // æ·»åŠ æµå‘åŠ¨ç”»æ•ˆæœ
            animate2DFlows();
        }

        // 2Dæµå‘åŠ¨ç”»
        function animate2DFlows() {
            // ä¸ºæµå‘çº¿æ·»åŠ è™šçº¿åŠ¨ç”»æ•ˆæœ
            const flowLines = document.querySelectorAll('.flow-lines line');
            flowLines.forEach((line, index) => {
                // åˆ›å»ºåŠ¨ç”»è™šçº¿æ•ˆæœ
                line.style.strokeDasharray = '10,5';
                line.style.animation = `flow-animation 2s linear infinite`;
                line.style.animationDelay = `${index * 0.3}s`;
            });
            
            // æ·»åŠ CSSåŠ¨ç”»æ ·å¼
            if (!document.getElementById('flow-animation-style')) {
                const style = document.createElement('style');
                style.id = 'flow-animation-style';
                style.textContent = `
                    @keyframes flow-animation {
                        0% { stroke-dashoffset: 0; }
                        100% { stroke-dashoffset: 15; }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        // åˆ›å»º3Då·¥å‚æ¨¡å‹
        function createFactoryModel() {
            // æ¸…ç©ºç°æœ‰åœºæ™¯ä¸­çš„ç½‘æ ¼
            const objectsToRemove = [];
            scene.children.forEach(child => {
                if (child instanceof THREE.Mesh) {
                    objectsToRemove.push(child);
                }
            });
            objectsToRemove.forEach(obj => scene.remove(obj));

            // åˆ›å»ºåœ°é¢
            createGround();
            
            // åˆ›å»ºå·¥å‚ä¸»ä½“å»ºç­‘
            createMainBuilding();
            
            // åˆ›å»ºå„å·¥æ®µåŒºåŸŸ
            createWorkshopAreas();
            
            // åˆ›å»ºè®¾å¤‡
            createEquipment();
            
            // åˆ›å»ºå­éƒ¨ä»¶
            createComponents();
            
            // åˆ›å»ºè¿æ¥ç®¡é“å’Œè¾“é€å¸¦
            createInfrastructure();
        }

        // åˆ›å»ºåœ°é¢
        function createGround() {
            const groundGeometry = new THREE.PlaneGeometry(120, 80);
            const groundMaterial = new THREE.MeshLambertMaterial({ 
                color: 0x2a2a2a,
                transparent: true,
                opacity: 0.8 
            });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            ground.userData = { id: 'factory-ground', name: 'å·¥å‚åœ°é¢', selectable: false };
            scene.add(ground);

            // æ·»åŠ ç½‘æ ¼çº¿
            const gridHelper = new THREE.GridHelper(120, 50, 0x444444, 0x333333);
            gridHelper.userData = { selectable: false };
            scene.add(gridHelper);
        }

        // åˆ›å»ºå·¥å‚æ ‡è¯†ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼Œåªä¿ç•™å¿…è¦çš„æ ‡è¯†ï¼‰
        function createMainBuilding() {
            const factoryGroup = new THREE.Group();
            factoryGroup.userData = { id: 'cement-factory', name: 'æ°´æ³¥å·¥å‚', type: 'factory' };

            // å·¥å‚æ ‡è¯†ç‰Œï¼ˆæ›¿ä»£å¤§å‹å»ºç­‘ï¼‰
            const signGeometry = new THREE.BoxGeometry(8, 3, 0.2);
            const signMaterial = new THREE.MeshLambertMaterial({ color: 0x0078d4 });
            const sign = new THREE.Mesh(signGeometry, signMaterial);
            sign.position.set(0, 8, -25);
            factoryGroup.add(sign);

            // æ·»åŠ æ–‡å­—çº¹ç†ï¼ˆæ¨¡æ‹Ÿå·¥å‚æ ‡è¯†ï¼‰
            const canvas = document.createElement('canvas');
            canvas.width = 512;
            canvas.height = 128;
            const context = canvas.getContext('2d');
            context.fillStyle = '#ffffff';
            context.font = 'bold 48px Arial';
            context.textAlign = 'center';
            context.fillText('æ°´æ³¥å·¥å‚æ•°å­—å­ªç”Ÿ', 256, 80);
            
            const texture = new THREE.CanvasTexture(canvas);
            const textMaterial = new THREE.MeshLambertMaterial({ map: texture });
            const textSign = new THREE.Mesh(signGeometry, textMaterial);
            textSign.position.set(0, 8, -24.9);
            factoryGroup.add(textSign);

            scene.add(factoryGroup);
        }

        // åˆ›å»ºå·¥æ®µåŒºåŸŸ
        function createWorkshopAreas() {
            // ç ´ç¢å·¥æ®µåŒºåŸŸ
            const crushingArea = createWorkshopArea('crushing-workshop', 'ç ´ç¢å·¥æ®µ', 
                new THREE.Vector3(-25, 0, -15), new THREE.Vector3(18, 15), 0xffaa00);
            
            // ç²‰ç£¨å·¥æ®µåŒºåŸŸ  
            const grindingArea = createWorkshopArea('grinding-workshop', 'ç²‰ç£¨å·¥æ®µ',
                new THREE.Vector3(0, 0, -15), new THREE.Vector3(20, 15), 0x00aaff);
            
            // ç……çƒ§å·¥æ®µåŒºåŸŸ
            const burningArea = createWorkshopArea('burning-workshop', 'ç……çƒ§å·¥æ®µ',
                new THREE.Vector3(25, 0, -5), new THREE.Vector3(18, 20), 0xff6600);

            scene.add(crushingArea, grindingArea, burningArea);
        }

        // åˆ›å»ºå·¥æ®µåŒºåŸŸè¾…åŠ©å‡½æ•°
        function createWorkshopArea(id, name, position, size, color) {
            const workshopGroup = new THREE.Group();
            workshopGroup.userData = { id: id, name: name, type: 'workshop' };
            workshopGroup.position.copy(position);

            // åœ°é¢åŒºåŸŸæ ‡è¯†
            const floorGeometry = new THREE.BoxGeometry(size.x, 0.2, size.z);
            const floorMaterial = new THREE.MeshLambertMaterial({ 
                color: color, 
                transparent: true, 
                opacity: 0.4 
            });
            const floor = new THREE.Mesh(floorGeometry, floorMaterial);
            floor.position.y = 0.1;
            workshopGroup.add(floor);

            // è¾¹ç•Œå›´æ 
            const fenceHeight = 3;
            const fenceMaterial = new THREE.MeshLambertMaterial({ 
                color: color, 
                transparent: true, 
                opacity: 0.6 
            });

            // å››é¢å›´æ 
            const fences = [
                { pos: [0, fenceHeight/2, size.z/2], size: [size.x, fenceHeight, 0.1] }, // å‰
                { pos: [0, fenceHeight/2, -size.z/2], size: [size.x, fenceHeight, 0.1] }, // å
                { pos: [size.x/2, fenceHeight/2, 0], size: [0.1, fenceHeight, size.z] }, // å³
                { pos: [-size.x/2, fenceHeight/2, 0], size: [0.1, fenceHeight, size.z] }, // å·¦
            ];

            fences.forEach(fence => {
                const fenceGeometry = new THREE.BoxGeometry(...fence.size);
                const fenceMesh = new THREE.Mesh(fenceGeometry, fenceMaterial);
                fenceMesh.position.set(...fence.pos);
                workshopGroup.add(fenceMesh);
            });

            // å·¥æ®µæ ‡è¯†ç‰Œ
            const signGeometry = new THREE.BoxGeometry(6, 2, 0.1);
            const signMaterial = new THREE.MeshLambertMaterial({ color: 0xffffff });
            const sign = new THREE.Mesh(signGeometry, signMaterial);
            sign.position.set(0, fenceHeight + 1, -size.z/2 - 0.5);

            // æ·»åŠ å·¥æ®µåç§°æ–‡å­—
            const canvas = document.createElement('canvas');
            canvas.width = 256;
            canvas.height = 64;
            const context = canvas.getContext('2d');
            context.fillStyle = color === 0xffaa00 ? '#ff8800' : 
                               color === 0x00aaff ? '#0088ff' : '#ff4400';
            context.font = 'bold 32px Arial';
            context.textAlign = 'center';
            context.fillText(name, 128, 42);
            
            const texture = new THREE.CanvasTexture(canvas);
            const textMaterial = new THREE.MeshLambertMaterial({ map: texture });
            const textSign = new THREE.Mesh(signGeometry, textMaterial);
            textSign.position.set(0, fenceHeight + 1, -size.z/2 - 0.4);
            
            workshopGroup.add(sign, textSign);

            return workshopGroup;
        }

        // åˆ›å»ºè®¾å¤‡
        function createEquipment() {
            // é¢šå¼ç ´ç¢æœº
            const crusher = createCrusher();
            scene.add(crusher);

            // çš®å¸¦è¾“é€æœº
            const conveyor = createConveyor();
            scene.add(conveyor);

            // çƒç£¨æœº
            const ballMill = createBallMill();
            scene.add(ballMill);

            // é€‰ç²‰æœº
            const separator = createSeparator();
            scene.add(separator);

            // å›è½¬çª‘
            const rotaryKiln = createRotaryKiln();
            scene.add(rotaryKiln);
        }

        // åˆ›å»ºé¢šå¼ç ´ç¢æœº
        function createCrusher() {
            const crusherGroup = new THREE.Group();
            crusherGroup.userData = { id: 'crusher-1', name: 'é¢šå¼ç ´ç¢æœº', type: 'equipment' };
            crusherGroup.position.set(-25, 0, -10);

            // ä¸»ä½“
            const bodyGeometry = new THREE.BoxGeometry(6, 4, 4);
            const bodyMaterial = new THREE.MeshLambertMaterial({ color: 0x666666 });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.position.set(0, 2, 0);
            body.castShadow = true;
            crusherGroup.add(body);

            // è¿›æ–™å£
            const inletGeometry = new THREE.ConeGeometry(2, 3, 8);
            const inletMaterial = new THREE.MeshLambertMaterial({ color: 0x555555 });
            const inlet = new THREE.Mesh(inletGeometry, inletMaterial);
            inlet.position.set(0, 5.5, 0);
            crusherGroup.add(inlet);

            // åŸºç¡€
            const baseGeometry = new THREE.BoxGeometry(8, 1, 6);
            const baseMaterial = new THREE.MeshLambertMaterial({ color: 0x444444 });
            const base = new THREE.Mesh(baseGeometry, baseMaterial);
            base.position.set(0, 0.5, 0);
            crusherGroup.add(base);

            return crusherGroup;
        }

        // åˆ›å»ºçš®å¸¦è¾“é€æœº
        function createConveyor() {
            const conveyorGroup = new THREE.Group();
            conveyorGroup.userData = { id: 'conveyor-1', name: 'çš®å¸¦è¾“é€æœº', type: 'equipment' };
            conveyorGroup.position.set(-15, 0, -10);

            // çš®å¸¦
            const beltGeometry = new THREE.BoxGeometry(12, 0.3, 1.2);
            const beltMaterial = new THREE.MeshLambertMaterial({ color: 0x222222 });
            const belt = new THREE.Mesh(beltGeometry, beltMaterial);
            belt.position.set(0, 1.5, 0);
            conveyorGroup.add(belt);

            // æ”¯æ’‘æ¶
            for (let i = -5; i <= 5; i += 2.5) {
                const supportGeometry = new THREE.BoxGeometry(0.2, 3, 0.2);
                const supportMaterial = new THREE.MeshLambertMaterial({ color: 0x555555 });
                const support = new THREE.Mesh(supportGeometry, supportMaterial);
                support.position.set(i, 1.5, 0.7);
                conveyorGroup.add(support);
                
                const support2 = support.clone();
                support2.position.z = -0.7;
                conveyorGroup.add(support2);
            }

            return conveyorGroup;
        }

        // åˆ›å»ºçƒç£¨æœº
        function createBallMill() {
            const millGroup = new THREE.Group();
            millGroup.userData = { id: 'ball-mill', name: 'çƒç£¨æœº', type: 'equipment' };
            millGroup.position.set(0, 0, -10);

            // ä¸»ç­’ä½“
            const cylinderGeometry = new THREE.CylinderGeometry(3.5, 3.5, 10, 20);
            const cylinderMaterial = new THREE.MeshLambertMaterial({ color: 0xffdd44 });
            const cylinder = new THREE.Mesh(cylinderGeometry, cylinderMaterial);
            cylinder.rotation.z = Math.PI / 2;
            cylinder.position.set(0, 3.5, 0);
            cylinder.castShadow = true;
            millGroup.add(cylinder);

            // æ”¯æ’‘åº§
            const support1Geometry = new THREE.BoxGeometry(2, 7, 3);
            const supportMaterial = new THREE.MeshLambertMaterial({ color: 0x555555 });
            const support1 = new THREE.Mesh(support1Geometry, supportMaterial);
            support1.position.set(-4, 3.5, 0);
            millGroup.add(support1);

            const support2 = support1.clone();
            support2.position.x = 4;
            millGroup.add(support2);

            // ç«¯ç›–
            const endCapGeometry = new THREE.CylinderGeometry(3.5, 3.5, 0.5, 20);
            const endCapMaterial = new THREE.MeshLambertMaterial({ color: 0x444444 });
            const endCap1 = new THREE.Mesh(endCapGeometry, endCapMaterial);
            endCap1.rotation.z = Math.PI / 2;
            endCap1.position.set(-5.25, 3.5, 0);
            millGroup.add(endCap1);

            const endCap2 = endCap1.clone();
            endCap2.position.x = 5.25;
            millGroup.add(endCap2);

            return millGroup;
        }

        // åˆ›å»ºé€‰ç²‰æœº
        function createSeparator() {
            const separatorGroup = new THREE.Group();
            separatorGroup.userData = { id: 'separator', name: 'é€‰ç²‰æœº', type: 'equipment' };
            separatorGroup.position.set(10, 0, -10);

            // ä¸»ä½“åœ†æŸ±
            const bodyGeometry = new THREE.CylinderGeometry(2, 2.5, 6, 12);
            const bodyMaterial = new THREE.MeshLambertMaterial({ color: 0x777777 });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.position.set(0, 3, 0);
            body.castShadow = true;
            separatorGroup.add(body);

            // é¡¶éƒ¨é”¥ä½“
            const topGeometry = new THREE.ConeGeometry(2, 2, 12);
            const topMaterial = new THREE.MeshLambertMaterial({ color: 0x666666 });
            const top = new THREE.Mesh(topGeometry, topMaterial);
            top.position.set(0, 7, 0);
            separatorGroup.add(top);

            // è¿›æ–™ç®¡
            const pipeGeometry = new THREE.CylinderGeometry(0.5, 0.5, 3, 8);
            const pipeMaterial = new THREE.MeshLambertMaterial({ color: 0x555555 });
            const pipe = new THREE.Mesh(pipeGeometry, pipeMaterial);
            pipe.position.set(0, 8.5, 0);
            separatorGroup.add(pipe);

            return separatorGroup;
        }

        // åˆ›å»ºå›è½¬çª‘
        function createRotaryKiln() {
            const kilnGroup = new THREE.Group();
            kilnGroup.userData = { id: 'rotary-kiln', name: 'å›è½¬çª‘', type: 'equipment' };
            kilnGroup.position.set(25, 0, 0);

            // ä¸»ç­’ä½“
            const kilnGeometry = new THREE.CylinderGeometry(2.5, 3, 15, 20);
            const kilnMaterial = new THREE.MeshLambertMaterial({ color: 0x888888 });
            const kiln = new THREE.Mesh(kilnGeometry, kilnMaterial);
            kiln.rotation.z = Math.PI / 2;
            kiln.rotation.x = 0.1; // ç¨å¾®å€¾æ–œ
            kiln.position.set(0, 3, 0);
            kiln.castShadow = true;
            kilnGroup.add(kiln);

            // æ”¯æ’‘è½®
            for (let i = 0; i < 4; i++) {
                const wheelGeometry = new THREE.CylinderGeometry(0.8, 0.8, 0.5, 12);
                const wheelMaterial = new THREE.MeshLambertMaterial({ color: 0x333333 });
                const wheel = new THREE.Mesh(wheelGeometry, wheelMaterial);
                wheel.position.set(-6 + i * 4, 0.8, 0);
                kilnGroup.add(wheel);
            }

            // çª‘å¤´ç½©
            const hoodGeometry = new THREE.CylinderGeometry(3.5, 3, 4, 12);
            const hoodMaterial = new THREE.MeshLambertMaterial({ color: 0x666666 });
            const hood = new THREE.Mesh(hoodGeometry, hoodMaterial);
            hood.rotation.z = Math.PI / 2;
            hood.position.set(9, 3, 0);
            kilnGroup.add(hood);

            return kilnGroup;
        }

        // åˆ›å»ºå­éƒ¨ä»¶
        function createComponents() {
            // ç ´ç¢æœºç”µæœº
            const crusherMotor = createMotor('crusher-motor', 'ç ´ç¢æœºç”µæœº', 
                new THREE.Vector3(-28, 2, -8), 0xff4444);
            scene.add(crusherMotor);

            // ç ´ç¢æœºè½´æ‰¿
            const crusherBearing = createBearing('crusher-bearing', 'ç ´ç¢æœºè½´æ‰¿', 
                new THREE.Vector3(-22, 3, -10));
            scene.add(crusherBearing);

            // çƒç£¨æœºä¸»ç”µæœº
            const millMotor = createMotor('mill-motor', 'çƒç£¨æœºä¸»ç”µæœº', 
                new THREE.Vector3(-6, 1, -8), 0x4444ff);
            scene.add(millMotor);

            // çƒç£¨æœºå‡é€Ÿå™¨
            const gearbox = createGearbox('mill-gearbox', 'çƒç£¨æœºå‡é€Ÿå™¨', 
                new THREE.Vector3(-3, 2, -10));
            scene.add(gearbox);

            // å›è½¬çª‘ç‡ƒçƒ§å™¨
            const burner = createBurner('kiln-burner', 'å›è½¬çª‘ç‡ƒçƒ§å™¨', 
                new THREE.Vector3(32, 3, 0));
            scene.add(burner);

            // å›è½¬çª‘ç­’ä½“ï¼ˆä½œä¸ºå­éƒ¨ä»¶æ ‡è¯†ï¼‰
            const cylinder = createKilnCylinder('kiln-cylinder', 'çª‘ç­’ä½“', 
                new THREE.Vector3(25, 3, 0));
            scene.add(cylinder);
        }

        // åˆ›å»ºç”µæœºå­éƒ¨ä»¶
        function createMotor(id, name, position, color = 0x4444ff) {
            const motorGroup = new THREE.Group();
            motorGroup.userData = { id: id, name: name, type: 'component' };
            motorGroup.position.copy(position);

            const bodyGeometry = new THREE.CylinderGeometry(0.8, 0.8, 2, 12);
            const bodyMaterial = new THREE.MeshLambertMaterial({ color: color });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.castShadow = true;
            motorGroup.add(body);

            // æ¥çº¿ç›’
            const boxGeometry = new THREE.BoxGeometry(0.5, 0.5, 0.3);
            const boxMaterial = new THREE.MeshLambertMaterial({ color: 0x333333 });
            const box = new THREE.Mesh(boxGeometry, boxMaterial);
            box.position.set(0.6, 0, 0);
            motorGroup.add(box);

            return motorGroup;
        }

        // åˆ›å»ºè½´æ‰¿å­éƒ¨ä»¶
        function createBearing(id, name, position) {
            const bearingGroup = new THREE.Group();
            bearingGroup.userData = { id: id, name: name, type: 'component' };
            bearingGroup.position.copy(position);

            const bearingGeometry = new THREE.CylinderGeometry(0.5, 0.5, 0.8, 16);
            const bearingMaterial = new THREE.MeshLambertMaterial({ color: 0x888888 });
            const bearing = new THREE.Mesh(bearingGeometry, bearingMaterial);
            bearing.rotation.z = Math.PI / 2;
            bearingGroup.add(bearing);

            return bearingGroup;
        }

        // åˆ›å»ºå‡é€Ÿå™¨å­éƒ¨ä»¶
        function createGearbox(id, name, position) {
            const gearboxGroup = new THREE.Group();
            gearboxGroup.userData = { id: id, name: name, type: 'component' };
            gearboxGroup.position.copy(position);

            const bodyGeometry = new THREE.BoxGeometry(2, 1.5, 1.5);
            const bodyMaterial = new THREE.MeshLambertMaterial({ color: 0x555555 });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.castShadow = true;
            gearboxGroup.add(body);

            return gearboxGroup;
        }

        // åˆ›å»ºç‡ƒçƒ§å™¨å­éƒ¨ä»¶
        function createBurner(id, name, position) {
            const burnerGroup = new THREE.Group();
            burnerGroup.userData = { id: id, name: name, type: 'component' };
            burnerGroup.position.copy(position);

            const nozzleGeometry = new THREE.CylinderGeometry(0.3, 0.5, 2, 8);
            const nozzleMaterial = new THREE.MeshLambertMaterial({ color: 0xff6600 });
            const nozzle = new THREE.Mesh(nozzleGeometry, nozzleMaterial);
            nozzle.rotation.z = Math.PI / 2;
            burnerGroup.add(nozzle);

            // ç«ç„°æ•ˆæœï¼ˆç”¨æ©™è‰²çƒä½“æ¨¡æ‹Ÿï¼‰
            const flameGeometry = new THREE.SphereGeometry(0.8, 8, 6);
            const flameMaterial = new THREE.MeshLambertMaterial({ 
                color: 0xff3300, 
                transparent: true, 
                opacity: 0.7 
            });
            const flame = new THREE.Mesh(flameGeometry, flameMaterial);
            flame.position.x = 1.5;
            burnerGroup.add(flame);

            return burnerGroup;
        }

        // åˆ›å»ºçª‘ç­’ä½“æ ‡è¯†
        function createKilnCylinder(id, name, position) {
            const cylinderGroup = new THREE.Group();
            cylinderGroup.userData = { id: id, name: name, type: 'component' };
            cylinderGroup.position.copy(position);

            // åˆ›å»ºä¸€ä¸ªé€æ˜çš„åœ†ç¯æ¥æ ‡è¯†ç­’ä½“
            const ringGeometry = new THREE.TorusGeometry(3, 0.2, 8, 16);
            const ringMaterial = new THREE.MeshLambertMaterial({ 
                color: 0x00ff00, 
                transparent: true, 
                opacity: 0.6 
            });
            const ring = new THREE.Mesh(ringGeometry, ringMaterial);
            ring.rotation.y = Math.PI / 2;
            cylinderGroup.add(ring);

            return cylinderGroup;
        }

        // åˆ›å»ºåŸºç¡€è®¾æ–½ï¼ˆç®¡é“ã€è¾“é€å¸¦ç­‰ï¼‰
        function createInfrastructure() {
            // å·¥æ®µé—´è¿æ¥ç®¡é“
            createPipeline(new THREE.Vector3(-15, 2, -10), new THREE.Vector3(-5, 2, -10), 0x555555);
            createPipeline(new THREE.Vector3(5, 2, -10), new THREE.Vector3(15, 2, -10), 0x555555);
            createPipeline(new THREE.Vector3(15, 4, -5), new THREE.Vector3(25, 4, -2), 0x555555);
            
            // ç‰©æ–™æµå‘æŒ‡ç¤ºç®­å¤´
            createFlowArrow(new THREE.Vector3(-10, 3, -10), new THREE.Vector3(1, 0, 0));
            createFlowArrow(new THREE.Vector3(10, 3, -10), new THREE.Vector3(1, 0, 0));
        }

        // åˆ›å»ºç®¡é“
        function createPipeline(start, end, color) {
            const direction = new THREE.Vector3().subVectors(end, start);
            const length = direction.length();
            const pipeGeometry = new THREE.CylinderGeometry(0.3, 0.3, length, 8);
            const pipeMaterial = new THREE.MeshLambertMaterial({ color: color });
            const pipe = new THREE.Mesh(pipeGeometry, pipeMaterial);
            
            pipe.position.copy(start).add(end).multiplyScalar(0.5);
            pipe.lookAt(end);
            pipe.rotateX(Math.PI / 2);
            pipe.userData = { name: 'è¾“é€ç®¡é“', type: 'infrastructure', selectable: false };
            
            scene.add(pipe);
        }

        // åˆ›å»ºç‰©æ–™æµå‘ç®­å¤´
        function createFlowArrow(position, direction) {
            const arrowGroup = new THREE.Group();
            arrowGroup.position.copy(position);
            arrowGroup.userData = { name: 'ç‰©æ–™æµå‘', type: 'infrastructure', selectable: false };

            // ç®­å¤´ä¸»ä½“
            const arrowGeometry = new THREE.ConeGeometry(0.5, 2, 6);
            const arrowMaterial = new THREE.MeshLambertMaterial({ 
                color: 0x00ff00,
                transparent: true,
                opacity: 0.8 
            });
            const arrow = new THREE.Mesh(arrowGeometry, arrowMaterial);
            arrow.rotation.z = -Math.PI / 2; // æ°´å¹³æŒ‡å‘
            
            // æ ¹æ®æ–¹å‘è°ƒæ•´ç®­å¤´æœå‘
            if (direction.x < 0) arrow.rotation.z = Math.PI / 2;
            if (direction.z > 0) arrow.rotation.x = Math.PI / 2;
            if (direction.z < 0) arrow.rotation.x = -Math.PI / 2;
            
            arrowGroup.add(arrow);

            // æ·»åŠ æµåŠ¨åŠ¨ç”»
            arrowGroup.userData.animate = (deltaTime) => {
                arrow.material.opacity = 0.5 + 0.3 * Math.sin(Date.now() * 0.005);
            };

            scene.add(arrowGroup);
        }

        // ä¿å­˜æ‰€æœ‰æ¨¡å‹çš„åŸå§‹é¢œè‰²
        function saveOriginalColors() {
            scene.traverse((child) => {
                if (child instanceof THREE.Mesh && child.material && child.material.color) {
                    child.userData.originalColor = child.material.color.getHex();
                }
            });
        }

        // åº”ç”¨å‘Šè­¦æ•ˆæœåˆ°3Dæ¨¡å‹
        function apply3DAlarmEffects() {
            // è·å–æ‰€æœ‰å‘Šè­¦èŠ‚ç‚¹
            const alarmNodes = document.querySelectorAll('.tree-node-content[class*="alarm"]');
            
            alarmNodes.forEach(node => {
                const nodeId = node.dataset.id;
                const alarmLevel = node.classList.contains('alarm-high') ? 'high' :
                                 node.classList.contains('alarm-medium') ? 'medium' : 'low';
                
                // åœ¨3Dåœºæ™¯ä¸­æ‰¾åˆ°å¯¹åº”çš„å¯¹è±¡
                const object3D = findObjectById(nodeId);
                if (object3D) {
                    applyAlarmMaterial(object3D, alarmLevel);
                }
            });
        }

        // åœ¨åœºæ™¯ä¸­æŸ¥æ‰¾æŒ‡å®šIDçš„å¯¹è±¡
        function findObjectById(id) {
            let foundObject = null;
            
            scene.traverse((child) => {
                if (child.userData && child.userData.id === id) {
                    foundObject = child;
                }
            });
            
            return foundObject;
        }

        // åº”ç”¨å‘Šè­¦æè´¨æ•ˆæœ
        function applyAlarmMaterial(object, alarmLevel) {
            const colors = {
                high: 0xff0000,    // çº¢è‰²
                medium: 0xff8800,  // æ©™è‰²  
                low: 0xffff00      // é»„è‰²
            };
            
            const color = colors[alarmLevel] || 0x666666;
            
            object.traverse((child) => {
                if (child instanceof THREE.Mesh) {
                    // å­˜å‚¨åŸå§‹é¢œè‰²
                    if (!child.userData.originalColor) {
                        child.userData.originalColor = child.material.color.getHex();
                    }
                    
                    // åˆ›å»ºé—ªçƒæè´¨
                    const originalMaterial = child.material;
                    const alarmMaterial = new THREE.MeshLambertMaterial({
                        color: color,
                        transparent: true,
                        opacity: 0.8
                    });
                    
                    // å­˜å‚¨åŸå§‹æè´¨
                    child.userData.originalMaterial = originalMaterial;
                    child.userData.alarmMaterial = alarmMaterial;
                    child.userData.isBlinking = true;
                    child.userData.blinkPhase = 0;
                }
            });
        }

        // æ›´æ–°é—ªçƒåŠ¨ç”»
        function updateBlinkingEffects() {
            scene.traverse((child) => {
                if (child instanceof THREE.Mesh && child.userData.isBlinking) {
                    child.userData.blinkPhase += 0.1;
                    const alpha = (Math.sin(child.userData.blinkPhase) + 1) * 0.5;
                    
                    if (alpha > 0.5) {
                        child.material = child.userData.alarmMaterial;
                    } else {
                        child.material = child.userData.originalMaterial;
                    }
                }
            });
        }

        // æ·»åŠ è®¾å¤‡è¿è½¬åŠ¨ç”»
        function addEquipmentAnimations() {
            // çƒç£¨æœºæ—‹è½¬åŠ¨ç”»
            const ballMill = findObjectById('ball-mill');
            if (ballMill) {
                ballMill.userData.animate = (deltaTime) => {
                    ballMill.children[0].rotation.x += deltaTime * 0.5; // ä¸»ç­’ä½“æ—‹è½¬
                };
            }

            // å›è½¬çª‘æ—‹è½¬åŠ¨ç”»
            const rotaryKiln = findObjectById('rotary-kiln');
            if (rotaryKiln) {
                rotaryKiln.userData.animate = (deltaTime) => {
                    rotaryKiln.children[0].rotation.x += deltaTime * 0.2; // çª‘ä½“ç¼“æ…¢æ—‹è½¬
                };
            }

            // çš®å¸¦è¾“é€æœºåŠ¨ç”»
            const conveyor = findObjectById('conveyor-1');
            if (conveyor) {
                conveyor.userData.animate = (deltaTime) => {
                    // å¯ä»¥æ·»åŠ çš®å¸¦è¿åŠ¨æ•ˆæœ
                    const belt = conveyor.children[0];
                    if (belt.material.map) {
                        belt.material.map.offset.x += deltaTime * 0.5;
                    }
                };
            }

            // ç‡ƒçƒ§å™¨ç«ç„°åŠ¨ç”»
            const burner = findObjectById('kiln-burner');
            if (burner) {
                burner.userData.animate = (deltaTime) => {
                    const flame = burner.children[1]; // ç«ç„°çƒä½“
                    if (flame) {
                        flame.scale.setScalar(1 + Math.sin(Date.now() * 0.01) * 0.2);
                        flame.material.opacity = 0.5 + Math.sin(Date.now() * 0.02) * 0.2;
                    }
                };
            }
        }

        // æ›´æ–°è®¾å¤‡åŠ¨ç”»
        function updateEquipmentAnimations(deltaTime) {
            scene.traverse((child) => {
                if (child.userData && typeof child.userData.animate === 'function') {
                    child.userData.animate(deltaTime);
                }
            });
        }

        // æ ¹æ®è¿è¡Œæ¨¡å¼æ›´æ–°3Dæ¨¡å‹æ˜¾ç¤º
        function update3DModelForMode(mode) {
            scene.traverse((child) => {
                if (child.userData && child.userData.type) {
                    const originalColor = child.userData.originalColor;
                    
                    if (child instanceof THREE.Mesh) {
                        switch(mode) {
                            case 'realtime':
                                // å®æ—¶æ¨¡å¼ï¼šæ¢å¤æ­£å¸¸é¢œè‰²ï¼Œå¯ç”¨åŠ¨ç”»
                                if (originalColor) {
                                    child.material.color.setHex(originalColor);
                                }
                                child.userData.animationEnabled = true;
                                break;
                            case 'history':
                                // å†å²æ¨¡å¼ï¼šç¨å¾®æš—åŒ–ï¼Œç¦ç”¨åŠ¨ç”»
                                if (originalColor) {
                                    child.material.color.setHex(originalColor);
                                    child.material.color.multiplyScalar(0.7);
                                }
                                child.userData.animationEnabled = false;
                                break;
                            case 'simulation':
                                // æ¨¡æ‹Ÿæ¨¡å¼ï¼šè“è‰²è°ƒï¼Œå¯ç”¨é¢„æµ‹åŠ¨ç”»
                                if (originalColor) {
                                    child.material.color.setHex(originalColor);
                                    child.material.color.lerp(new THREE.Color(0x0088ff), 0.3);
                                }
                                child.userData.animationEnabled = true;
                                break;
                        }
                    }
                }
            });
        }

        // é‡æ–°ç”Ÿæˆ3Då·¥å‚æ¨¡å‹
        function regenerateFactoryModel() {
            // æ¸…é™¤ç°æœ‰æ¨¡å‹
            const objectsToRemove = [];
            scene.children.forEach(child => {
                if (child instanceof THREE.Mesh || child instanceof THREE.Group) {
                    if (child.userData && child.userData.type !== 'light') {
                        objectsToRemove.push(child);
                    }
                }
            });
            objectsToRemove.forEach(obj => scene.remove(obj));

            // é‡æ–°åˆ›å»ºæ¨¡å‹
            createFactoryModel();
            
            // é‡æ–°åº”ç”¨æ•ˆæœ
            setTimeout(() => {
                saveOriginalColors();
                apply3DAlarmEffects();
                addEquipmentAnimations();
                update3DModelForMode(currentMode);
            }, 100);
        }

        // é‡ç½®ç›¸æœºåˆ°æœ€ä½³è§‚çœ‹è§’åº¦
        function resetCameraView() {
            if (camera && controls) {
                // å¹³æ»‘åŠ¨ç”»åˆ°æœ€ä½³ä½ç½®
                animateCamera(
                    camera.position,
                    new THREE.Vector3(0, 25, 30),
                    new THREE.Vector3(0, 0, -10)
                );
            }
        }

        // èµ„äº§å±‚çº§ç»“æ„å®šä¹‰
        const assetHierarchy = {
            'cement-factory': {
                type: 'factory',
                name: 'æ°´æ³¥å·¥å‚',
                children: ['crushing-workshop', 'grinding-workshop', 'burning-workshop']
            },
            'crushing-workshop': {
                type: 'workshop',
                name: 'ç ´ç¢å·¥æ®µ',
                parent: 'cement-factory',
                children: ['crusher-1', 'conveyor-1']
            },
            'grinding-workshop': {
                type: 'workshop',
                name: 'ç²‰ç£¨å·¥æ®µ',
                parent: 'cement-factory',
                children: ['ball-mill', 'separator']
            },
            'burning-workshop': {
                type: 'workshop',
                name: 'ç……çƒ§å·¥æ®µ',
                parent: 'cement-factory',
                children: ['rotary-kiln']
            },
            'crusher-1': {
                type: 'equipment',
                name: 'é¢šå¼ç ´ç¢æœº',
                parent: 'crushing-workshop',
                children: ['crusher-motor', 'crusher-bearing']
            },
            'conveyor-1': {
                type: 'equipment',
                name: 'çš®å¸¦è¾“é€æœº',
                parent: 'crushing-workshop',
                children: []
            },
            'ball-mill': {
                type: 'equipment',
                name: 'çƒç£¨æœº',
                parent: 'grinding-workshop',
                children: ['mill-motor', 'mill-gearbox']
            },
            'separator': {
                type: 'equipment',
                name: 'é€‰ç²‰æœº',
                parent: 'grinding-workshop',
                children: []
            },
            'rotary-kiln': {
                type: 'equipment',
                name: 'å›è½¬çª‘',
                parent: 'burning-workshop',
                children: ['kiln-burner', 'kiln-cylinder']
            },
            'crusher-motor': {
                type: 'component',
                name: 'ç ´ç¢æœºç”µæœº',
                parent: 'crusher-1',
                children: []
            },
            'crusher-bearing': {
                type: 'component',
                name: 'ç ´ç¢æœºè½´æ‰¿',
                parent: 'crusher-1',
                children: []
            },
            'mill-motor': {
                type: 'component',
                name: 'çƒç£¨æœºä¸»ç”µæœº',
                parent: 'ball-mill',
                children: []
            },
            'mill-gearbox': {
                type: 'component',
                name: 'çƒç£¨æœºå‡é€Ÿå™¨',
                parent: 'ball-mill',
                children: []
            },
            'kiln-burner': {
                type: 'component',
                name: 'å›è½¬çª‘ç‡ƒçƒ§å™¨',
                parent: 'rotary-kiln',
                children: []
            },
            'kiln-cylinder': {
                type: 'component',
                name: 'çª‘ç­’ä½“',
                parent: 'rotary-kiln',
                children: []
            }
        };

        // 3Dè§†å›¾ä¸‹é’»
        function drillDown3D(nodeId) {
            if (!assetHierarchy[nodeId]) return;
            
            const node = assetHierarchy[nodeId];
            console.log('3Dä¸‹é’»åˆ°:', node.name);
            
            // æ›´æ–°ä¸‹é’»è·¯å¾„
            if (drillPath.length === 0 || drillPath[drillPath.length - 1] !== nodeId) {
                // å¦‚æœç‚¹å‡»çš„æ˜¯æ›´ä¸Šçº§èŠ‚ç‚¹ï¼Œå›é€€åˆ°è¯¥å±‚çº§
                const nodeIndex = drillPath.indexOf(nodeId);
                if (nodeIndex >= 0) {
                    drillPath = drillPath.slice(0, nodeIndex + 1);
                } else {
                    drillPath.push(nodeId);
                }
            }
            
            // æ›´æ–°é€‰ä¸­èŠ‚ç‚¹
            selectedNode = { id: nodeId, name: node.name, type: node.type };
            currentDrillLevel = node.type;
            
            // æ›´æ–°é¢åŒ…å±‘
            updateBreadcrumb();
            
            // æ›´æ–°æŒ‡æ ‡é¢æ¿
            updateMetricsForNode(nodeId);
            
            // æ›´æ–°3Dè§†å›¾
            update3DViewForDrillDown(nodeId);
            
            // æ›´æ–°å·¦ä¾§æ ‘é€‰ä¸­çŠ¶æ€
            updateTreeSelection(nodeId);
            
            // æ›´æ–°ä¸‹é’»å±‚çº§æŒ‡ç¤ºå™¨
            updateDrillLevelIndicator(nodeId);
        }

        // 2Dè§†å›¾ä¸‹é’»
        function drillDown2D(nodeId) {
            if (!assetHierarchy[nodeId]) return;
            
            const node = assetHierarchy[nodeId];
            console.log('2Dä¸‹é’»åˆ°:', node.name);
            
            // æ›´æ–°ä¸‹é’»è·¯å¾„
            if (drillPath.length === 0 || drillPath[drillPath.length - 1] !== nodeId) {
                // å¦‚æœç‚¹å‡»çš„æ˜¯æ›´ä¸Šçº§èŠ‚ç‚¹ï¼Œå›é€€åˆ°è¯¥å±‚çº§
                const nodeIndex = drillPath.indexOf(nodeId);
                if (nodeIndex >= 0) {
                    drillPath = drillPath.slice(0, nodeIndex + 1);
                } else {
                    drillPath.push(nodeId);
                }
            }
            
            // æ›´æ–°é€‰ä¸­èŠ‚ç‚¹
            selectedNode = { id: nodeId, name: node.name, type: node.type };
            currentDrillLevel = node.type;
            
            // æ›´æ–°é¢åŒ…å±‘
            updateBreadcrumb();
            
            // æ›´æ–°æŒ‡æ ‡é¢æ¿
            updateMetricsForNode(nodeId);
            
            // æ›´æ–°2Dè§†å›¾
            update2DViewForDrillDown(nodeId);
            
            // æ›´æ–°å·¦ä¾§æ ‘é€‰ä¸­çŠ¶æ€
            updateTreeSelection(nodeId);
            
            // æ›´æ–°ä¸‹é’»å±‚çº§æŒ‡ç¤ºå™¨
            updateDrillLevelIndicator(nodeId);
        }

        // æ›´æ–°3Dè§†å›¾ä»¥é€‚åº”ä¸‹é’»
        function update3DViewForDrillDown(nodeId) {
            const node = assetHierarchy[nodeId];
            
            // éšè—å…¶ä»–ä¸ç›¸å…³çš„å¯¹è±¡
            scene.traverse((child) => {
                if (child.userData && child.userData.id) {
                    const childData = assetHierarchy[child.userData.id];
                    if (childData) {
                        // æ˜¾ç¤ºé€»è¾‘ï¼šæ˜¾ç¤ºå½“å‰èŠ‚ç‚¹åŠå…¶å­èŠ‚ç‚¹
                        if (child.userData.id === nodeId || 
                            isChildOf(child.userData.id, nodeId) ||
                            isParentOf(child.userData.id, nodeId)) {
                            child.visible = true;
                        } else {
                            child.visible = false;
                        }
                    }
                }
            });
            
            // èšç„¦åˆ°ç›®æ ‡å¯¹è±¡
            focusOn3DNode(nodeId);
        }

        // æ›´æ–°2Dè§†å›¾ä»¥é€‚åº”ä¸‹é’»
        function update2DViewForDrillDown(nodeId) {
            const node = assetHierarchy[nodeId];
            
            if (node.type === 'factory') {
                // å·¥å‚å±‚çº§ï¼šæ˜¾ç¤ºæ€»è§ˆ
                init2DView();
            } else if (node.type === 'workshop') {
                // å·¥æ®µå±‚çº§ï¼šç”Ÿæˆè¯¦ç»†çš„å·¥æ®µå†…éƒ¨å¸ƒå±€
                generate2DWorkshopDetail(nodeId);
            } else if (node.type === 'equipment') {
                // è®¾å¤‡å±‚çº§ï¼šç”Ÿæˆè®¾å¤‡è¯¦ç»†è§†å›¾
                generate2DEquipmentDetail(nodeId);
            } else if (node.type === 'component') {
                // éƒ¨ä»¶å±‚çº§ï¼šç”Ÿæˆéƒ¨ä»¶è¯¦ç»†è§†å›¾
                generate2DComponentDetail(nodeId);
            }
        }

        // åˆ¤æ–­æ˜¯å¦ä¸ºå­èŠ‚ç‚¹
        function isChildOf(childId, parentId) {
            const child = assetHierarchy[childId];
            if (!child) return false;
            
            let currentParent = child.parent;
            while (currentParent) {
                if (currentParent === parentId) return true;
                const parentNode = assetHierarchy[currentParent];
                currentParent = parentNode ? parentNode.parent : null;
            }
            return false;
        }

        // åˆ¤æ–­æ˜¯å¦ä¸ºçˆ¶èŠ‚ç‚¹
        function isParentOf(parentId, childId) {
            return isChildOf(childId, parentId);
        }

        // æ›´æ–°å·¦ä¾§æ ‘é€‰ä¸­çŠ¶æ€
        function updateTreeSelection(nodeId) {
            // ç§»é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.tree-node-content').forEach(node => {
                node.classList.remove('active');
            });
            
            // æ·»åŠ å½“å‰é€‰ä¸­çŠ¶æ€
            const treeNode = document.querySelector(`[data-id="${nodeId}"]`);
            if (treeNode) {
                treeNode.classList.add('active');
                
                // å±•å¼€åˆ°è¯¥èŠ‚ç‚¹çš„è·¯å¾„
                expandToNode(treeNode);
            }
        }
        
        // å±•å¼€åˆ°æŒ‡å®šèŠ‚ç‚¹
        function expandToNode(targetNode) {
            let parent = targetNode.parentElement;
            while (parent) {
                if (parent.classList && parent.classList.contains('tree-children')) {
                    parent.classList.add('expanded');
                    
                    // æ‰¾åˆ°å¯¹åº”çš„å±•å¼€å›¾æ ‡å¹¶æ ‡è®°ä¸ºå±•å¼€
                    const parentContent = parent.previousElementSibling;
                    if (parentContent) {
                        const expandIcon = parentContent.querySelector('.tree-expand-icon');
                        if (expandIcon && expandIcon.style.visibility !== 'hidden') {
                            expandIcon.classList.add('expanded');
                        }
                    }
                }
                parent = parent.parentElement;
            }
        }



         // æ›´æ–°ä¸‹é’»å±‚çº§æŒ‡ç¤ºå™¨
         function updateDrillLevelIndicator(nodeId) {
             const indicator = document.getElementById('drill-indicator');
             const node = assetHierarchy[nodeId];
             
             if (!indicator || !node) return;
             
             let levelText = '';
             switch (node.type) {
                 case 'factory':
                     levelText = 'å·¥å‚æ€»è§ˆ';
                     break;
                 case 'workshop':
                     levelText = `å·¥æ®µè§†å›¾ï¼š${node.name}`;
                     break;
                 case 'equipment':
                     levelText = `è®¾å¤‡è§†å›¾ï¼š${node.name}`;
                     break;
                 case 'component':
                     levelText = `éƒ¨ä»¶è§†å›¾ï¼š${node.name}`;
                     break;
                 default:
                     levelText = 'æœªçŸ¥å±‚çº§';
             }
             
             indicator.textContent = levelText;
         }

        // ç”Ÿæˆ2Då·¥æ®µè¯¦ç»†è§†å›¾
        function generate2DWorkshopDetail(workshopId) {
            const svg = document.getElementById('svg-canvas');
            const workshop = assetHierarchy[workshopId];
            
            let detailLayout = '';
            
            if (workshopId === 'crushing-workshop') {
                detailLayout = `
                    <defs>
                        <marker id="detail-arrow" markerWidth="8" markerHeight="6" 
                                refX="8" refY="3" orient="auto">
                            <polygon points="0 0, 8 3, 0 6" fill="#00ff88" />
                        </marker>
                    </defs>
                    <g transform="translate(50, 50)">
                        <rect x="0" y="0" width="800" height="600" fill="#554400" stroke="#ffaa00" stroke-width="3"/>
                        <text x="400" y="30" text-anchor="middle" fill="#fff" font-size="20">${workshop.name} - è¯¦ç»†è§†å›¾</text>
                        
                        <!-- åŸæ–™å…¥å£ -->
                        <rect x="50" y="100" width="80" height="60" fill="#8b4513" stroke="#666" stroke-width="2"/>
                        <text x="90" y="135" text-anchor="middle" fill="#fff" font-size="12">åŸæ–™ä»“</text>
                        
                        <!-- é¢šå¼ç ´ç¢æœºè¯¦ç»†ç»“æ„ -->
                        <g class="equipment" data-id="crusher-1">
                            <rect x="200" y="80" width="120" height="100" fill="#666" stroke="#333" stroke-width="2"/>
                            <text x="260" y="100" text-anchor="middle" fill="#fff" font-size="14">é¢šå¼ç ´ç¢æœº</text>
                            
                            <!-- ç ´ç¢æœºéƒ¨ä»¶ -->
                            <circle cx="220" cy="140" r="15" fill="#ff4444" class="component" data-id="crusher-motor"/>
                            <text x="220" y="145" text-anchor="middle" fill="#fff" font-size="8">ç”µæœº</text>
                            
                            <rect x="280" y="130" width="20" height="20" fill="#888" class="component" data-id="crusher-bearing"/>
                            <text x="290" y="155" text-anchor="middle" fill="#fff" font-size="8">è½´æ‰¿</text>
                        </g>
                        
                        <!-- çš®å¸¦è¾“é€æœº -->
                        <g class="equipment" data-id="conveyor-1">
                            <rect x="380" y="125" width="200" height="20" fill="#222" stroke="#444" stroke-width="1"/>
                            <text x="480" y="120" text-anchor="middle" fill="#ccc" font-size="12">çš®å¸¦è¾“é€æœº</text>
                            
                            <!-- æ”¯æ’‘æ¶ -->
                            <rect x="390" y="145" width="5" height="30" fill="#555"/>
                            <rect x="430" y="145" width="5" height="30" fill="#555"/>
                            <rect x="470" y="145" width="5" height="30" fill="#555"/>
                            <rect x="510" y="145" width="5" height="30" fill="#555"/>
                            <rect x="550" y="145" width="5" height="30" fill="#555"/>
                        </g>
                        
                        <!-- å‡ºæ–™å£ -->
                        <rect x="650" y="100" width="80" height="60" fill="#444" stroke="#666" stroke-width="2"/>
                        <text x="690" y="135" text-anchor="middle" fill="#fff" font-size="12">å‡ºæ–™å£</text>
                        
                        <!-- ç‰©æ–™æµå‘ -->
                        <line x1="130" y1="130" x2="200" y2="130" stroke="#00ff88" stroke-width="3" marker-end="url(#detail-arrow)"/>
                        <line x1="320" y1="130" x2="380" y2="135" stroke="#00ff88" stroke-width="3" marker-end="url(#detail-arrow)"/>
                        <line x1="580" y1="135" x2="650" y2="130" stroke="#00ff88" stroke-width="3" marker-end="url(#detail-arrow)"/>
                        
                        <!-- è¿”å›æŒ‰é’® -->
                        <g class="back-button" onclick="goBackLevel()" style="cursor: pointer;">
                            <rect x="20" y="20" width="60" height="25" fill="#0078d4" stroke="#005a9e" stroke-width="1" rx="3"/>
                            <text x="50" y="37" text-anchor="middle" fill="#fff" font-size="12">è¿”å›</text>
                        </g>
                    </g>
                `;
            } else if (workshopId === 'grinding-workshop') {
                detailLayout = `
                    <defs>
                        <marker id="detail-arrow" markerWidth="8" markerHeight="6" 
                                refX="8" refY="3" orient="auto">
                            <polygon points="0 0, 8 3, 0 6" fill="#00ff88" />
                        </marker>
                    </defs>
                    <g transform="translate(50, 50)">
                        <rect x="0" y="0" width="800" height="600" fill="#004455" stroke="#00aaff" stroke-width="3"/>
                        <text x="400" y="30" text-anchor="middle" fill="#fff" font-size="20">${workshop.name} - è¯¦ç»†è§†å›¾</text>
                        
                        <!-- æ¥æ–™ -->
                        <rect x="50" y="100" width="80" height="60" fill="#666" stroke="#888" stroke-width="2"/>
                        <text x="90" y="135" text-anchor="middle" fill="#fff" font-size="12">ç²—ç¢æ–™</text>
                        
                        <!-- çƒç£¨æœºè¯¦ç»†ç»“æ„ -->
                        <g class="equipment" data-id="ball-mill">
                            <ellipse cx="280" cy="140" rx="60" ry="30" fill="#ffdd44" stroke="#333" stroke-width="2"/>
                            <text x="280" y="115" text-anchor="middle" fill="#333" font-size="14">çƒç£¨æœº</text>
                            
                            <!-- çƒç£¨æœºéƒ¨ä»¶ -->
                            <circle cx="220" cy="140" r="12" fill="#4444ff" class="component" data-id="mill-motor"/>
                            <text x="220" y="165" text-anchor="middle" fill="#ccc" font-size="8">ä¸»ç”µæœº</text>
                            
                            <rect x="330" y="130" width="20" height="20" fill="#555" class="component" data-id="mill-gearbox"/>
                            <text x="340" y="160" text-anchor="middle" fill="#ccc" font-size="8">å‡é€Ÿå™¨</text>
                        </g>
                        
                        <!-- é€‰ç²‰æœº -->
                        <g class="equipment" data-id="separator">
                            <circle cx="500" cy="140" r="40" fill="#777" stroke="#333" stroke-width="2"/>
                            <text x="500" y="145" text-anchor="middle" fill="#fff" font-size="12">é€‰ç²‰æœº</text>
                        </g>
                        
                        <!-- æˆå“å‡ºæ–™ -->
                        <rect x="620" y="100" width="80" height="60" fill="#444" stroke="#666" stroke-width="2"/>
                        <text x="660" y="135" text-anchor="middle" fill="#fff" font-size="12">ç»†æ–™</text>
                        
                        <!-- ç‰©æ–™æµå‘ -->
                        <line x1="130" y1="130" x2="220" y2="130" stroke="#00ff88" stroke-width="3" marker-end="url(#detail-arrow)"/>
                        <line x1="340" y1="140" x2="460" y2="140" stroke="#00ff88" stroke-width="3" marker-end="url(#detail-arrow)"/>
                        <line x1="540" y1="140" x2="620" y2="130" stroke="#00ff88" stroke-width="3" marker-end="url(#detail-arrow)"/>
                        
                        <!-- è¿”æ–™æµ -->
                        <path d="M 480 180 Q 380 220, 260 180" stroke="#ffa500" stroke-width="2" 
                              fill="none" marker-end="url(#detail-arrow)" opacity="0.7"/>
                        <text x="380" y="230" text-anchor="middle" fill="#ffa500" font-size="10">è¿”æ–™</text>
                        
                        <!-- è¿”å›æŒ‰é’® -->
                        <g class="back-button" onclick="goBackLevel()" style="cursor: pointer;">
                            <rect x="20" y="20" width="60" height="25" fill="#0078d4" stroke="#005a9e" stroke-width="1" rx="3"/>
                            <text x="50" y="37" text-anchor="middle" fill="#fff" font-size="12">è¿”å›</text>
                        </g>
                    </g>
                `;
            } else if (workshopId === 'burning-workshop') {
                detailLayout = `
                    <defs>
                        <marker id="detail-arrow" markerWidth="8" markerHeight="6" 
                                refX="8" refY="3" orient="auto">
                            <polygon points="0 0, 8 3, 0 6" fill="#00ff88" />
                        </marker>
                    </defs>
                    <g transform="translate(50, 50)">
                        <rect x="0" y="0" width="800" height="600" fill="#550022" stroke="#ff6600" stroke-width="3"/>
                        <text x="400" y="30" text-anchor="middle" fill="#fff" font-size="20">${workshop.name} - è¯¦ç»†è§†å›¾</text>
                        
                        <!-- ç”Ÿæ–™å…¥å£ -->
                        <rect x="50" y="100" width="80" height="60" fill="#666" stroke="#888" stroke-width="2"/>
                        <text x="90" y="135" text-anchor="middle" fill="#fff" font-size="12">ç”Ÿæ–™</text>
                        
                        <!-- å›è½¬çª‘è¯¦ç»†ç»“æ„ -->
                        <g class="equipment" data-id="rotary-kiln">
                            <ellipse cx="400" cy="140" rx="150" ry="40" fill="#888" stroke="#333" stroke-width="2"/>
                            <text x="400" y="115" text-anchor="middle" fill="#fff" font-size="14">å›è½¬çª‘</text>
                            
                            <!-- ç‡ƒçƒ§å™¨ -->
                            <circle cx="520" cy="140" r="20" fill="#ff6600" class="component" data-id="kiln-burner">
                                <animate attributeName="fill" values="#ff6600;#ff3300;#ff6600" dur="1s" repeatCount="indefinite"/>
                            </circle>
                            <text x="520" y="170" text-anchor="middle" fill="#ccc" font-size="8">ç‡ƒçƒ§å™¨</text>
                            
                            <!-- çª‘ç­’ä½“æ ‡è¯† -->
                            <rect x="300" y="125" width="200" height="30" fill="none" stroke="#00ff00" 
                                  stroke-width="2" stroke-dasharray="5,5" class="component" data-id="kiln-cylinder"/>
                            <text x="400" y="200" text-anchor="middle" fill="#00ff00" font-size="8">çª‘ç­’ä½“</text>
                            
                            <!-- æ”¯æ’‘è½® -->
                            <circle cx="320" cy="180" r="8" fill="#333"/>
                            <circle cx="360" cy="180" r="8" fill="#333"/>
                            <circle cx="440" cy="180" r="8" fill="#333"/>
                            <circle cx="480" cy="180" r="8" fill="#333"/>
                        </g>
                        
                        <!-- ç†Ÿæ–™å‡ºå£ -->
                        <rect x="620" y="100" width="80" height="60" fill="#444" stroke="#666" stroke-width="2"/>
                        <text x="660" y="135" text-anchor="middle" fill="#fff" font-size="12">ç†Ÿæ–™</text>
                        
                        <!-- ç‰©æ–™æµå‘ -->
                        <line x1="130" y1="130" x2="250" y2="130" stroke="#00ff88" stroke-width="3" marker-end="url(#detail-arrow)"/>
                        <line x1="550" y1="140" x2="620" y2="130" stroke="#00ff88" stroke-width="3" marker-end="url(#detail-arrow)"/>
                        
                        <!-- è¿”å›æŒ‰é’® -->
                        <g class="back-button" onclick="goBackLevel()" style="cursor: pointer;">
                            <rect x="20" y="20" width="60" height="25" fill="#0078d4" stroke="#005a9e" stroke-width="1" rx="3"/>
                            <text x="50" y="37" text-anchor="middle" fill="#fff" font-size="12">è¿”å›</text>
                        </g>
                    </g>
                `;
            }
            
            svg.innerHTML = detailLayout;
            
            // é‡æ–°ç»‘å®šäº‹ä»¶
            bindDetailViewEvents();
        }

        // ç”Ÿæˆ2Dè®¾å¤‡è¯¦ç»†è§†å›¾
        function generate2DEquipmentDetail(equipmentId) {
            const svg = document.getElementById('svg-canvas');
            const equipment = assetHierarchy[equipmentId];
            
            let detailLayout = '';
            
            if (equipmentId === 'crusher-1') {
                detailLayout = `
                    <g transform="translate(50, 50)">
                        <rect x="0" y="0" width="800" height="600" fill="#333" stroke="#666" stroke-width="2"/>
                        <text x="400" y="30" text-anchor="middle" fill="#fff" font-size="20">${equipment.name} - å†…éƒ¨ç»“æ„</text>
                        
                        <!-- ç ´ç¢æœºä¸»ä½“ -->
                        <rect x="300" y="150" width="200" height="150" fill="#666" stroke="#333" stroke-width="3"/>
                        <text x="400" y="140" text-anchor="middle" fill="#fff" font-size="16">ç ´ç¢è…”</text>
                        
                        <!-- å¯åŠ¨é¢šæ¿ -->
                        <rect x="320" y="170" width="80" height="110" fill="#777" stroke="#555" stroke-width="2"/>
                        <text x="360" y="230" text-anchor="middle" fill="#fff" font-size="10">å¯åŠ¨é¢šæ¿</text>
                        
                        <!-- å›ºå®šé¢šæ¿ -->
                        <rect x="420" y="170" width="60" height="110" fill="#555" stroke="#333" stroke-width="2"/>
                        <text x="450" y="230" text-anchor="middle" fill="#fff" font-size="10">å›ºå®šé¢šæ¿</text>
                        
                        <!-- ç”µæœº -->
                        <circle cx="200" cy="225" r="30" fill="#ff4444" stroke="#333" stroke-width="2" 
                                class="component" data-id="crusher-motor"/>
                        <text x="200" y="230" text-anchor="middle" fill="#fff" font-size="12">é©±åŠ¨ç”µæœº</text>
                        
                        <!-- è½´æ‰¿ -->
                        <circle cx="550" cy="200" r="20" fill="#888" stroke="#555" stroke-width="2" 
                                class="component" data-id="crusher-bearing"/>
                        <text x="550" y="235" text-anchor="middle" fill="#fff" font-size="10">ä¸»è½´æ‰¿</text>
                        
                        <!-- ä¼ åŠ¨ç³»ç»Ÿ -->
                        <line x1="230" y1="225" x2="300" y2="225" stroke="#666" stroke-width="8"/>
                        <text x="265" y="240" text-anchor="middle" fill="#ccc" font-size="8">ä¼ åŠ¨è½´</text>
                        
                        <!-- è¿”å›æŒ‰é’® -->
                        <g class="back-button" onclick="goBackLevel()" style="cursor: pointer;">
                            <rect x="20" y="20" width="60" height="25" fill="#0078d4" stroke="#005a9e" stroke-width="1" rx="3"/>
                            <text x="50" y="37" text-anchor="middle" fill="#fff" font-size="12">è¿”å›</text>
                        </g>
                    </g>
                `;
            }
            // å¯ä»¥æ·»åŠ å…¶ä»–è®¾å¤‡çš„è¯¦ç»†è§†å›¾...
            
            svg.innerHTML = detailLayout;
            bindDetailViewEvents();
        }

        // ç”Ÿæˆ2Déƒ¨ä»¶è¯¦ç»†è§†å›¾
        function generate2DComponentDetail(componentId) {
            const svg = document.getElementById('svg-canvas');
            const component = assetHierarchy[componentId];
            
            let detailLayout = `
                <g transform="translate(50, 50)">
                    <rect x="0" y="0" width="800" height="600" fill="#333" stroke="#666" stroke-width="2"/>
                    <text x="400" y="30" text-anchor="middle" fill="#fff" font-size="20">${component.name} - è¯¦ç»†ä¿¡æ¯</text>
                    
                    <!-- éƒ¨ä»¶è¯¦ç»†å›¾ -->
                    <rect x="250" y="150" width="300" height="200" fill="#444" stroke="#666" stroke-width="2"/>
                    <text x="400" y="180" text-anchor="middle" fill="#fff" font-size="16">${component.name}</text>
                    <text x="400" y="200" text-anchor="middle" fill="#ccc" font-size="12">è¯¦ç»†æŠ€æœ¯å‚æ•°å’ŒçŠ¶æ€ä¿¡æ¯</text>
                    <text x="400" y="220" text-anchor="middle" fill="#ccc" font-size="12">å°†åœ¨æ­¤æ˜¾ç¤º</text>
                    
                    <!-- è¿”å›æŒ‰é’® -->
                    <g class="back-button" onclick="goBackLevel()" style="cursor: pointer;">
                        <rect x="20" y="20" width="60" height="25" fill="#0078d4" stroke="#005a9e" stroke-width="1" rx="3"/>
                        <text x="50" y="37" text-anchor="middle" fill="#fff" font-size="12">è¿”å›</text>
                    </g>
                </g>
            `;
            
            svg.innerHTML = detailLayout;
            bindDetailViewEvents();
        }

        // ç»‘å®šè¯¦ç»†è§†å›¾äº‹ä»¶
        function bindDetailViewEvents() {
            const svg = document.getElementById('svg-canvas');
            
            // é‡æ–°ç»‘å®šé¼ æ ‡äº‹ä»¶
            svg.addEventListener('mousemove', function(event) {
                const target = event.target;
                if (target.classList.contains('equipment') || target.classList.contains('component')) {
                    showTooltip(event, target.dataset);
                } else {
                    hideTooltip();
                }
            });
            
            svg.addEventListener('click', function(event) {
                const target = event.target;
                if (target.dataset && target.dataset.id && target.classList.contains('component')) {
                    // ä½¿ç”¨ç»Ÿä¸€çš„èŠ‚ç‚¹åˆ‡æ¢å‡½æ•°
                    switchToNode(target.dataset.id, '2d_component_click');
                }
            });
        }

                 // é€šè¿‡é¢åŒ…å±‘å¯¼èˆªåˆ°æŒ‡å®šèŠ‚ç‚¹
         function navigateToBreadcrumbNode(nodeId) {
             // ä½¿ç”¨ç»Ÿä¸€çš„èŠ‚ç‚¹åˆ‡æ¢å‡½æ•°
             switchToNode(nodeId, 'breadcrumb_click');
         }

         // è¿”å›ä¸Šä¸€çº§
         function goBackLevel() {
            // é»˜è®¤å›åˆ°å·¥å‚æ€»è§ˆ
            const parentId = 'cement-factory';
            
            // ä½¿ç”¨ç»Ÿä¸€çš„èŠ‚ç‚¹åˆ‡æ¢å‡½æ•°
            switchToNode(parentId, 'back_level');
        }

                // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
        function initEventListeners() {
            // è¿è¡Œæ¨¡å¼åˆ‡æ¢
            document.querySelectorAll('[data-mode]').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('[data-mode]').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentMode = this.dataset.mode;
                    switchMode(currentMode);
                });
            });

            // è§†å›¾æ¨¡å¼åˆ‡æ¢
            document.querySelectorAll('[data-view]').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('[data-view]').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentView = this.dataset.view;
                    switchView();
                });
            });

            // ç¼–è¾‘æ¨¡å¼åˆ‡æ¢
            document.getElementById('edit-toggle').addEventListener('click', function(e) {
                e.stopPropagation();
                editMode = !editMode;
                this.classList.toggle('active');
                document.getElementById('edit-panel').classList.toggle('visible');
                // éšè—æ¨¡å¼æ§åˆ¶é¢æ¿
                if (editMode) {
                    document.getElementById('mode-control-panel').classList.remove('visible');
                }
                // éšè—å·¥å…·æç¤º
                const globalTooltip = document.getElementById('global-tooltip');
                if (globalTooltip) {
                    globalTooltip.classList.remove('show');
                }
            });
            
            // é¢åŒ…å±‘å¯¼èˆª
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('breadcrumb-item')) {
                    const nodeId = e.target.dataset.id;
                    navigateToBreadcrumbNode(nodeId);
                }
            });
            
            // ç¼–è¾‘æ¨¡å¼è®¾ç½®
            document.querySelectorAll('#edit-panel input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    applyEditSettings();
                });
            });

            // å…¨å±åˆ‡æ¢åŠŸèƒ½
            document.getElementById('expand-toggle').addEventListener('click', function() {
                toggleFullscreenView();
            });
            
            // åˆå§‹åŒ–å›¾æ ‡æŒ‰é’®å·¥å…·æç¤º
            initIconButtonTooltips();
            
            // åˆå§‹åŒ–å‘Šè­¦ç³»ç»Ÿ
            initAlarmSystem();
            
            // é‡ç½®è§†è§’æŒ‰é’®æ‚¬åœæ•ˆæœ
            const resetButton = document.getElementById('reset-view-btn');
            if (resetButton) {
                resetButton.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-1px) rotate(180deg)';
                });
                resetButton.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0) rotate(0deg)';
                });
            }

            // æ¨¡æ‹Ÿå‚æ•°æ»‘å—äº‹ä»¶
            initSimulationControls();
        }

        // åˆå§‹åŒ–æ¨¡æ‹Ÿæ§åˆ¶
        function initSimulationControls() {
            // ç”Ÿäº§è´Ÿè·æ»‘å—
            const loadSlider = document.getElementById('load-slider');
            if (loadSlider) {
                loadSlider.addEventListener('input', function() {
                    document.getElementById('load-value').textContent = this.value + '%';
                    simulationParams.loadFactor = this.value / 100;
                });
            }

            // è´¨é‡ç³»æ•°æ»‘å—
            const qualitySlider = document.getElementById('quality-slider');
            if (qualitySlider) {
                qualitySlider.addEventListener('input', function() {
                    document.getElementById('quality-value').textContent = this.value;
                    simulationParams.qualityFactor = parseFloat(this.value);
                });
            }

            // æ•ˆç‡ç³»æ•°æ»‘å—
            const efficiencySlider = document.getElementById('efficiency-slider');
            if (efficiencySlider) {
                efficiencySlider.addEventListener('input', function() {
                    document.getElementById('efficiency-value').textContent = this.value + '%';
                    simulationParams.efficiencyFactor = this.value / 100;
                });
            }
        }

        // åˆ‡æ¢è§†å›¾
        function switchView() {
            const threeCanvas = document.getElementById('three-canvas');
            const svgCanvas = document.getElementById('svg-canvas');
            
            if (currentView === '3d') {
                threeCanvas.style.display = 'block';
                svgCanvas.style.display = 'none';
            } else {
                threeCanvas.style.display = 'none';
                svgCanvas.style.display = 'block';
            }
        }

        // æ˜¾ç¤ºæç¤ºæ¡†
        function showTooltip(event, data) {
            const tooltip = document.getElementById('tooltip');
            const content = tooltip.querySelector('.tooltip-content');
            
            if (data && data.id) {
                const deviceData = getEnhancedDeviceData(data.id);
                let htmlContent = `<div class="tooltip-header">${deviceData.name}</div>`;
                
                // æ ¹æ®å½“å‰æ¨¡å¼æ˜¾ç¤ºä¸åŒçš„æ•°æ®
                switch(currentMode) {
                    case 'realtime':
                        htmlContent += `
                            <div class="tooltip-section">
                                <div class="tooltip-label">å®æ—¶æŒ‡æ ‡</div>
                                <div class="tooltip-metric">æ¸©åº¦: <span class="metric-value">${deviceData.temperature}Â°C</span></div>
                                <div class="tooltip-metric">å‹åŠ›: <span class="metric-value">${deviceData.pressure} MPa</span></div>
                                <div class="tooltip-metric">è½¬é€Ÿ: <span class="metric-value">${deviceData.speed} rpm</span></div>
                                <div class="tooltip-metric">æ•ˆç‡: <span class="metric-value">${deviceData.efficiency}%</span></div>
                                <div class="tooltip-metric">åŠŸç‡: <span class="metric-value">${deviceData.power} kW</span></div>
                                <div class="tooltip-metric">æŒ¯åŠ¨: <span class="metric-value">${deviceData.vibration} mm/s</span></div>
                            </div>
                            <div class="tooltip-status ${deviceData.status.toLowerCase()}">
                                çŠ¶æ€: ${deviceData.status}
                            </div>
                        `;
                        break;
                    case 'history':
                        htmlContent += `
                            <div class="tooltip-section">
                                <div class="tooltip-label">å†å²æ•°æ® (${getCurrentHistoryTime()})</div>
                                <div class="tooltip-metric">æ¸©åº¦: <span class="metric-value">${(deviceData.temperature * 0.9).toFixed(1)}Â°C</span></div>
                                <div class="tooltip-metric">å‹åŠ›: <span class="metric-value">${(deviceData.pressure * 0.9).toFixed(1)} MPa</span></div>
                                <div class="tooltip-metric">è½¬é€Ÿ: <span class="metric-value">${Math.round(deviceData.speed * 0.9)} rpm</span></div>
                                <div class="tooltip-metric">æ•ˆç‡: <span class="metric-value">${(deviceData.efficiency * 0.9).toFixed(1)}%</span></div>
                                <div class="tooltip-metric">åŠŸç‡: <span class="metric-value">${Math.round(deviceData.power * 0.9)} kW</span></div>
                            </div>
                            <div class="tooltip-note">
                                ğŸ“Š æ˜¾ç¤ºå†å²æ—¶æ®µå¹³å‡å€¼
                            </div>
                        `;
                        break;
                    case 'simulation':
                        const simData = applySimulationParams(deviceData);
                        htmlContent += `
                            <div class="tooltip-section">
                                <div class="tooltip-label">é¢„æµ‹æ•°æ®</div>
                                <div class="tooltip-metric">æ¸©åº¦: <span class="metric-value">${simData.temperature}Â°C</span> 
                                    <span class="prediction-indicator">â†—ï¸</span></div>
                                <div class="tooltip-metric">å‹åŠ›: <span class="metric-value">${simData.pressure} MPa</span> 
                                    <span class="prediction-indicator">â†—ï¸</span></div>
                                <div class="tooltip-metric">è½¬é€Ÿ: <span class="metric-value">${simData.speed} rpm</span> 
                                    <span class="prediction-indicator">â†—ï¸</span></div>
                                <div class="tooltip-metric">æ•ˆç‡: <span class="metric-value">${simData.efficiency}%</span> 
                                    <span class="prediction-indicator">â†—ï¸</span></div>
                                <div class="tooltip-metric">åŠŸç‡: <span class="metric-value">${simData.power} kW</span> 
                                    <span class="prediction-indicator">â†—ï¸</span></div>
                            </div>
                            <div class="tooltip-note">
                                ğŸ”® åŸºäºå½“å‰å‚æ•°é¢„æµ‹
                            </div>
                        `;
                        break;
                }
                
                // æ·»åŠ è¶‹åŠ¿ä¿¡æ¯
                if (currentMode !== 'history') {
                    htmlContent += `
                        <div class="tooltip-trend">
                            <div class="tooltip-label">24å°æ—¶è¶‹åŠ¿</div>
                            <div class="trend-indicators">
                                <span class="trend-up">æ¸©åº¦ â†—ï¸</span>
                                <span class="trend-stable">å‹åŠ› â†’</span>
                                <span class="trend-down">æŒ¯åŠ¨ â†˜ï¸</span>
                            </div>
                        </div>
                    `;
                }
                
                content.innerHTML = htmlContent;
                tooltip.style.display = 'block';
                tooltip.style.left = event.clientX + 8 + 'px';
                tooltip.style.top = event.clientY + 8 + 'px';
                
                // ç¡®ä¿å·¥å…·æç¤ºä¸ä¼šè¶…å‡ºå±å¹•è¾¹ç•Œ
                setTimeout(() => {
                    const rect = tooltip.getBoundingClientRect();
                    if (rect.right > window.innerWidth) {
                        tooltip.style.left = event.clientX - rect.width - 8 + 'px';
                    }
                    if (rect.bottom > window.innerHeight) {
                        tooltip.style.top = event.clientY - rect.height - 8 + 'px';
                    }
                }, 0);
            }
        }

        // éšè—æç¤ºæ¡†
        function hideTooltip() {
            document.getElementById('tooltip').style.display = 'none';
        }

        // æ£€æµ‹æŒ‡æ ‡æ˜¯å¦å¼‚å¸¸
        function isMetricAbnormal(metricName, value, nodeId) {
            // å®šä¹‰å„è®¾å¤‡å„æŒ‡æ ‡çš„æ­£å¸¸èŒƒå›´
            const normalRanges = {
                'crusher-1': {
                    temperature: { min: 60, max: 80 },
                    pressure: { min: 2.0, max: 3.5 },
                    speed: { min: 280, max: 380 },
                    efficiency: { min: 80, max: 100 },
                    power: { min: 380, max: 520 },
                    vibration: { min: 0, max: 16 }
                },
                'ball-mill': {
                    temperature: { min: 70, max: 95 },
                    pressure: { min: 1.5, max: 2.5 },
                    speed: { min: 15, max: 25 },
                    efficiency: { min: 75, max: 100 },
                    power: { min: 1000, max: 1500 },
                    vibration: { min: 0, max: 12 }
                },
                'rotary-kiln': {
                    temperature: { min: 800, max: 1000 },
                    pressure: { min: 0.6, max: 1.2 },
                    speed: { min: 3.0, max: 4.5 },
                    efficiency: { min: 80, max: 100 },
                    power: { min: 650, max: 1000 },
                    vibration: { min: 0, max: 8 }
                },
                'cement-mill': {
                    temperature: { min: 65, max: 85 },
                    pressure: { min: 1.8, max: 2.8 },
                    speed: { min: 12, max: 20 },
                    efficiency: { min: 80, max: 100 },
                    power: { min: 550, max: 800 },
                    vibration: { min: 0, max: 14 }
                },
                'conveyor-1': {
                    temperature: { min: 40, max: 55 },
                    pressure: { min: 0.4, max: 0.7 },
                    speed: { min: 100, max: 150 },
                    efficiency: { min: 85, max: 100 },
                    power: { min: 120, max: 200 },
                    vibration: { min: 0, max: 5 }
                },
                'cement-factory': {
                    temperature: { min: 20, max: 35 },
                    pressure: { min: 0.9, max: 1.2 },
                    efficiency: { min: 80, max: 100 },
                    power: { min: 2000, max: 3500 },
                    vibration: { min: 0, max: 4 }
                }
            };

            // å·¥å‚çº§åˆ«æŒ‡æ ‡çš„æ­£å¸¸èŒƒå›´
            const factoryRanges = {
                totalProduction: { min: 2000, max: 2600 },
                overallEfficiency: { min: 80, max: 100 },
                totalPower: { min: 2000, max: 3500 },
                onlineEquipment: { min: 22, max: 26 },
                alarmCount: { min: 0, max: 3 }
            };

            // å·¥æ®µçº§åˆ«æŒ‡æ ‡çš„æ­£å¸¸èŒƒå›´
            const workshopRanges = {
                workshopEfficiency: { min: 75, max: 100 },
                workshopPower: { min: 500, max: 2000 },
                materialThroughput: { min: 120, max: 220 },
                avgVibration: { min: 0, max: 15 },
                avgTemperature: { min: 800, max: 1000 }
            };

            // ç»„ä»¶çº§åˆ«æŒ‡æ ‡çš„æ­£å¸¸èŒƒå›´
            const componentRanges = {
                'crusher-motor': {
                    voltage: { min: 360, max: 420 },
                    current: { min: 50, max: 80 },
                    temperature: { min: 60, max: 85 },
                    power: { min: 250, max: 320 },
                    efficiency: { min: 88, max: 100 },
                    vibration: { min: 0, max: 12 }
                },
                'crusher-bearing': {
                    temperature: { min: 40, max: 60 },
                    lubrication: { min: 80, max: 100 },
                    vibration: { min: 0, max: 20 },
                    wear: { min: 0, max: 25 },
                    runningTime: { min: 2500, max: 3200 }
                },
                'mill-motor': {
                    voltage: { min: 5800, max: 6200 },
                    current: { min: 160, max: 220 },
                    temperature: { min: 65, max: 95 },
                    power: { min: 850, max: 1100 },
                    efficiency: { min: 90, max: 100 },
                    vibration: { min: 0, max: 8 }
                },
                'mill-gearbox': {
                    temperature: { min: 45, max: 65 },
                    oilPressure: { min: 0.2, max: 0.32 },
                    oilTemperature: { min: 40, max: 60 },
                    vibration: { min: 0, max: 6 },
                    efficiency: { min: 92, max: 100 }
                },
                'kiln-burner': {
                    flameTemperature: { min: 1100, max: 1500 },
                    fuelPressure: { min: 1.2, max: 2.0 },
                    airPressure: { min: 2.4, max: 3.5 },
                    fuelFlow: { min: 35, max: 60 },
                    efficiency: { min: 82, max: 100 }
                },
                'kiln-cylinder': {
                    shellTemperature: { min: 280, max: 380 },
                    thickness: { min: 36, max: 42 },
                    runoutValue: { min: 0, max: 3.5 },
                    vibration: { min: 0, max: 4 },
                    rotationSpeed: { min: 2.8, max: 3.8 }
                }
            };

            // ç³»ç»Ÿçº§åˆ«æŒ‡æ ‡çš„æ­£å¸¸èŒƒå›´
            const systemRanges = {
                overallEfficiency: { min: 80, max: 100 },
                equipmentRuntime: { min: 85, max: 100 },
                avgEnergyConsumption: { min: 220, max: 280 },
                production: { min: 2000, max: 2800 },
                alarmCount: { min: 0, max: 3 },
                onlineDevices: { min: 22, max: 26 }
            };

            const numValue = parseFloat(value);
            
            // æ£€æŸ¥è®¾å¤‡çº§åˆ«æŒ‡æ ‡
            if (nodeId && normalRanges[nodeId] && normalRanges[nodeId][metricName]) {
                const range = normalRanges[nodeId][metricName];
                return numValue < range.min || numValue > range.max;
            }
            
            // æ£€æŸ¥ç»„ä»¶çº§åˆ«æŒ‡æ ‡
            if (nodeId && componentRanges[nodeId] && componentRanges[nodeId][metricName]) {
                const range = componentRanges[nodeId][metricName];
                return numValue < range.min || numValue > range.max;
            }
            
            // æ£€æŸ¥å·¥å‚çº§åˆ«æŒ‡æ ‡
            if (factoryRanges[metricName]) {
                const range = factoryRanges[metricName];
                return numValue < range.min || numValue > range.max;
            }
            
            // æ£€æŸ¥å·¥æ®µçº§åˆ«æŒ‡æ ‡
            if (workshopRanges[metricName]) {
                const range = workshopRanges[metricName];
                return numValue < range.min || numValue > range.max;
            }
            
            // æ£€æŸ¥ç³»ç»Ÿçº§åˆ«æŒ‡æ ‡
            if (systemRanges[metricName]) {
                const range = systemRanges[metricName];
                return numValue < range.min || numValue > range.max;
            }

            return false; // é»˜è®¤ä¸å¼‚å¸¸
        }

        // è·å–å¢å¼ºè®¾å¤‡æ•°æ®
        function getEnhancedDeviceData(nodeId) {
            const baseData = {
                'cement-factory': {
                    name: 'æ°´æ³¥å·¥å‚',
                    level: 'factory',
                    totalProduction: 2300 + Math.random() * 200,
                    overallEfficiency: 85 + Math.random() * 10,
                    totalPower: 2500 + Math.random() * 500,
                    onlineEquipment: 24 + Math.floor(Math.random() * 3),
                    totalEquipment: 26,
                    alarmCount: Math.floor(Math.random() * 5) + 1,
                    status: Math.random() > 0.05 ? 'æ­£å¸¸' : 'å‘Šè­¦'
                },
                'crushing-workshop': {
                    name: 'ç ´ç¢å·¥æ®µ',
                    level: 'workshop',
                    workshopEfficiency: 88 + Math.random() * 8,
                    workshopPower: 650 + Math.random() * 100,
                    materialThroughput: 180 + Math.random() * 20,
                    equipmentCount: 3,
                    runningCount: 3,
                    avgVibration: 10 + Math.random() * 3,
                    status: Math.random() > 0.1 ? 'æ­£å¸¸' : 'å‘Šè­¦'
                },
                'grinding-workshop': {
                    name: 'ç²‰ç£¨å·¥æ®µ',
                    level: 'workshop',
                    workshopEfficiency: 82 + Math.random() * 10,
                    workshopPower: 1400 + Math.random() * 200,
                    materialThroughput: 160 + Math.random() * 15,
                    equipmentCount: 3,
                    runningCount: 3,
                    avgVibration: 8 + Math.random() * 2,
                    status: Math.random() > 0.15 ? 'æ­£å¸¸' : 'å‘Šè­¦'
                },
                'burning-workshop': {
                    name: 'ç……çƒ§å·¥æ®µ',
                    level: 'workshop',
                    workshopEfficiency: 90 + Math.random() * 6,
                    workshopPower: 800 + Math.random() * 150,
                    materialThroughput: 170 + Math.random() * 20,
                    equipmentCount: 1,
                    runningCount: 1,
                    avgTemperature: 850 + Math.random() * 100,
                    status: Math.random() > 0.08 ? 'æ­£å¸¸' : 'å‘Šè­¦'
                },
                'crusher-1': {
                    name: 'é¢šå¼ç ´ç¢æœº #1',
                    level: 'equipment',
                    temperature: 65 + Math.random() * 10,
                    pressure: 2.5 + Math.random() * 0.5,
                    speed: 300 + Math.random() * 50,
                    efficiency: 85 + Math.random() * 10,
                    power: 450 + Math.random() * 50,
                    vibration: 12 + Math.random() * 3,
                    status: Math.random() > 0.1 ? 'æ­£å¸¸' : 'å‘Šè­¦'
                },
                'conveyor-1': {
                    name: 'çš®å¸¦è¾“é€æœº',
                    level: 'equipment',
                    temperature: 45 + Math.random() * 8,
                    pressure: 0.5 + Math.random() * 0.1,
                    speed: 120 + Math.random() * 20,
                    efficiency: 92 + Math.random() * 5,
                    power: 150 + Math.random() * 30,
                    vibration: 3 + Math.random() * 1,
                    status: Math.random() > 0.05 ? 'æ­£å¸¸' : 'å‘Šè­¦'
                },
                'separator': {
                    name: 'é€‰ç²‰æœº',
                    level: 'equipment',
                    temperature: 55 + Math.random() * 10,
                    pressure: 1.2 + Math.random() * 0.3,
                    speed: 450 + Math.random() * 50,
                    efficiency: 89 + Math.random() * 7,
                    power: 200 + Math.random() * 40,
                    vibration: 5 + Math.random() * 1,
                    status: Math.random() > 0.08 ? 'æ­£å¸¸' : 'å‘Šè­¦'
                },
                'ball-mill': {
                    name: 'çƒç£¨æœº',
                    level: 'equipment',
                    temperature: 78 + Math.random() * 15,
                    pressure: 1.8 + Math.random() * 0.4,
                    speed: 18 + Math.random() * 3,
                    efficiency: 82 + Math.random() * 8,
                    power: 1200 + Math.random() * 200,
                    vibration: 8 + Math.random() * 2,
                    status: Math.random() > 0.15 ? 'æ­£å¸¸' : 'å‘Šè­¦'
                },
                'rotary-kiln': {
                    name: 'å›è½¬çª‘',
                    level: 'equipment',
                    temperature: 850 + Math.random() * 100,
                    pressure: 0.8 + Math.random() * 0.2,
                    speed: 3.5 + Math.random() * 0.5,
                    efficiency: 88 + Math.random() * 7,
                    power: 800 + Math.random() * 150,
                    vibration: 5 + Math.random() * 1,
                    status: Math.random() > 0.08 ? 'æ­£å¸¸' : 'å‘Šè­¦'
                },
                // ç»„ä»¶çº§åˆ«æ•°æ®
                'crusher-motor': {
                    name: 'ç ´ç¢æœºç”µæœº',
                    level: 'component',
                    temperature: 68 + Math.random() * 12,
                    voltage: 380 + Math.random() * 20,
                    current: 65 + Math.random() * 10,
                    power: 280 + Math.random() * 30,
                    efficiency: 92 + Math.random() * 5,
                    vibration: 8 + Math.random() * 2,
                    status: Math.random() > 0.2 ? 'æ­£å¸¸' : 'å‘Šè­¦'
                },
                'crusher-bearing': {
                    name: 'ç ´ç¢æœºè½´æ‰¿',
                    level: 'component',
                    temperature: 45 + Math.random() * 8,
                    lubrication: 85 + Math.random() * 10,
                    vibration: 15 + Math.random() * 3,
                    wear: 15 + Math.random() * 5,
                    runningTime: 2800 + Math.random() * 200,
                    status: Math.random() > 0.15 ? 'æ­£å¸¸' : 'å‘Šè­¦'
                },
                'mill-motor': {
                    name: 'çƒç£¨æœºä¸»ç”µæœº',
                    level: 'component',
                    temperature: 75 + Math.random() * 15,
                    voltage: 6000 + Math.random() * 200,
                    current: 180 + Math.random() * 20,
                    power: 950 + Math.random() * 100,
                    efficiency: 94 + Math.random() * 4,
                    vibration: 6 + Math.random() * 1,
                    status: Math.random() > 0.1 ? 'æ­£å¸¸' : 'å‘Šè­¦'
                },
                'mill-gearbox': {
                    name: 'çƒç£¨æœºå‡é€Ÿå™¨',
                    level: 'component',
                    temperature: 52 + Math.random() * 8,
                    oilPressure: 0.25 + Math.random() * 0.05,
                    oilTemperature: 48 + Math.random() * 7,
                    vibration: 4 + Math.random() * 1,
                    efficiency: 96 + Math.random() * 3,
                    status: Math.random() > 0.08 ? 'æ­£å¸¸' : 'å‘Šè­¦'
                },
                'kiln-burner': {
                    name: 'å›è½¬çª‘ç‡ƒçƒ§å™¨',
                    level: 'component',
                    flameTemperature: 1200 + Math.random() * 200,
                    fuelPressure: 1.5 + Math.random() * 0.3,
                    airPressure: 2.8 + Math.random() * 0.4,
                    fuelFlow: 45 + Math.random() * 8,
                    efficiency: 88 + Math.random() * 6,
                    status: Math.random() > 0.12 ? 'æ­£å¸¸' : 'å‘Šè­¦'
                },
                'kiln-cylinder': {
                    name: 'å›è½¬çª‘ç­’ä½“',
                    level: 'component',
                    shellTemperature: 320 + Math.random() * 40,
                    thickness: 38 + Math.random() * 2,
                    runoutValue: 2.5 + Math.random() * 0.5,
                    vibration: 3 + Math.random() * 0.5,
                    rotationSpeed: 3.2 + Math.random() * 0.3,
                    status: Math.random() > 0.05 ? 'æ­£å¸¸' : 'å‘Šè­¦'
                }
            };
            
            const data = baseData[nodeId];
            if (data) {
                // å®‰å…¨æ ¼å¼åŒ–æ•°å€¼ - åªæ ¼å¼åŒ–å­˜åœ¨çš„å±æ€§
                const formattedData = { ...data };
                
                // æ ¼å¼åŒ–æ•°å€¼ç±»å‹çš„å±æ€§
                if (typeof data.temperature === 'number') {
                    formattedData.temperature = data.temperature.toFixed(1);
                }
                if (typeof data.pressure === 'number') {
                    formattedData.pressure = data.pressure.toFixed(1);
                }
                if (typeof data.speed === 'number') {
                    formattedData.speed = Math.round(data.speed);
                }
                if (typeof data.efficiency === 'number') {
                    formattedData.efficiency = data.efficiency.toFixed(1);
                }
                if (typeof data.power === 'number') {
                    formattedData.power = Math.round(data.power);
                }
                if (typeof data.vibration === 'number') {
                    formattedData.vibration = data.vibration.toFixed(1);
                }
                
                // å·¥å‚çº§åˆ«æŒ‡æ ‡æ ¼å¼åŒ–
                if (typeof data.totalProduction === 'number') {
                    formattedData.totalProduction = data.totalProduction.toFixed(0);
                }
                if (typeof data.overallEfficiency === 'number') {
                    formattedData.overallEfficiency = data.overallEfficiency.toFixed(1);
                }
                if (typeof data.totalPower === 'number') {
                    formattedData.totalPower = data.totalPower.toFixed(0);
                }
                
                // å·¥æ®µçº§åˆ«æŒ‡æ ‡æ ¼å¼åŒ–
                if (typeof data.workshopEfficiency === 'number') {
                    formattedData.workshopEfficiency = data.workshopEfficiency.toFixed(1);
                }
                if (typeof data.workshopPower === 'number') {
                    formattedData.workshopPower = data.workshopPower.toFixed(0);
                }
                if (typeof data.materialThroughput === 'number') {
                    formattedData.materialThroughput = data.materialThroughput.toFixed(1);
                }
                if (typeof data.avgVibration === 'number') {
                    formattedData.avgVibration = data.avgVibration.toFixed(1);
                }
                if (typeof data.avgTemperature === 'number') {
                    formattedData.avgTemperature = data.avgTemperature.toFixed(0);
                }
                
                // ç»„ä»¶çº§åˆ«ç‰¹æ®ŠæŒ‡æ ‡æ ¼å¼åŒ–
                if (typeof data.voltage === 'number') {
                    formattedData.voltage = data.voltage.toFixed(0);
                }
                if (typeof data.current === 'number') {
                    formattedData.current = data.current.toFixed(1);
                }
                if (typeof data.lubrication === 'number') {
                    formattedData.lubrication = data.lubrication.toFixed(1);
                }
                if (typeof data.wear === 'number') {
                    formattedData.wear = data.wear.toFixed(1);
                }
                if (typeof data.runningTime === 'number') {
                    formattedData.runningTime = data.runningTime.toFixed(0);
                }
                if (typeof data.oilPressure === 'number') {
                    formattedData.oilPressure = data.oilPressure.toFixed(2);
                }
                if (typeof data.oilTemperature === 'number') {
                    formattedData.oilTemperature = data.oilTemperature.toFixed(1);
                }
                if (typeof data.flameTemperature === 'number') {
                    formattedData.flameTemperature = data.flameTemperature.toFixed(0);
                }
                if (typeof data.fuelPressure === 'number') {
                    formattedData.fuelPressure = data.fuelPressure.toFixed(2);
                }
                if (typeof data.airPressure === 'number') {
                    formattedData.airPressure = data.airPressure.toFixed(1);
                }
                if (typeof data.fuelFlow === 'number') {
                    formattedData.fuelFlow = data.fuelFlow.toFixed(1);
                }
                if (typeof data.shellTemperature === 'number') {
                    formattedData.shellTemperature = data.shellTemperature.toFixed(0);
                }
                if (typeof data.thickness === 'number') {
                    formattedData.thickness = data.thickness.toFixed(1);
                }
                if (typeof data.runoutValue === 'number') {
                    formattedData.runoutValue = data.runoutValue.toFixed(1);
                }
                if (typeof data.rotationSpeed === 'number') {
                    formattedData.rotationSpeed = data.rotationSpeed.toFixed(1);
                }
                
                return formattedData;
            }
            
            return {
                name: 'æœªçŸ¥è®¾å¤‡',
                temperature: '25.0',
                pressure: '1.0',
                speed: 0,
                efficiency: '0.0',
                power: 0,
                vibration: '0.0',
                status: 'æœªçŸ¥'
            };
        }

        // åº”ç”¨æ¨¡æ‹Ÿå‚æ•°
        function applySimulationParams(data) {
            const temp = parseFloat(data.temperature);
            const pressure = parseFloat(data.pressure);
            const speed = parseInt(data.speed);
            const efficiency = parseFloat(data.efficiency);
            const power = parseInt(data.power);
            const vibration = parseFloat(data.vibration);
            
            return {
                name: data.name,
                temperature: (temp * (1 + (simulationParams.loadFactor - 1) * 0.3)).toFixed(1),
                pressure: (pressure * simulationParams.loadFactor).toFixed(1),
                speed: Math.round(speed * simulationParams.loadFactor * simulationParams.efficiencyFactor),
                efficiency: (efficiency * simulationParams.efficiencyFactor * simulationParams.qualityFactor).toFixed(1),
                power: Math.round(power * simulationParams.loadFactor),
                vibration: (vibration * (2 - simulationParams.efficiencyFactor)).toFixed(1),
                status: data.status
            };
        }

        // è·å–å½“å‰å†å²æ—¶é—´
        function getCurrentHistoryTime() {
            const dateInput = document.getElementById('history-date');
            const startTimeInput = document.getElementById('history-time-start');
            const endTimeInput = document.getElementById('history-time-end');
            
            const date = dateInput ? dateInput.value : '2024-01-15';
            const startTime = startTimeInput ? startTimeInput.value : '08:00';
            const endTime = endTimeInput ? endTimeInput.value : '18:00';
            
            return `${date} ${startTime}-${endTime}`;
        }

        // åˆå§‹åŒ–å›¾æ ‡æŒ‰é’®å·¥å…·æç¤º
        function initIconButtonTooltips() {
            const globalTooltip = document.getElementById('global-tooltip');
            const iconButtons = document.querySelectorAll('.icon-button');
            
            iconButtons.forEach(button => {
                button.addEventListener('mouseenter', function(e) {
                    const tooltipText = this.getAttribute('data-tooltip');
                    if (tooltipText && globalTooltip) {
                        const rect = this.getBoundingClientRect();
                        const tooltipX = rect.left + rect.width / 2;
                        const tooltipY = rect.bottom + 8;
                        
                        globalTooltip.textContent = tooltipText;
                        globalTooltip.style.left = tooltipX + 'px';
                        globalTooltip.style.top = tooltipY + 'px';
                        globalTooltip.classList.add('show');
                    }
                });
                
                button.addEventListener('mouseleave', function() {
                    if (globalTooltip) {
                        globalTooltip.classList.remove('show');
                    }
                });
            });
            
            // çª—å£å¤§å°æ”¹å˜æ—¶éšè—å·¥å…·æç¤º
            window.addEventListener('resize', function() {
                if (globalTooltip) {
                    globalTooltip.classList.remove('show');
                }
            });
            
            // é¡µé¢æ»šåŠ¨æ—¶éšè—å·¥å…·æç¤º
            window.addEventListener('scroll', function() {
                if (globalTooltip) {
                    globalTooltip.classList.remove('show');
                }
            });
            
            // ç‚¹å‡»é¡µé¢æ—¶éšè—å·¥å…·æç¤º
            document.addEventListener('click', function(e) {
                if (globalTooltip && !e.target.closest('.icon-button')) {
                    globalTooltip.classList.remove('show');
                }
            });
        }

        // åˆå§‹åŒ–å‘Šè­¦ç³»ç»Ÿ
        function initAlarmSystem() {
            const alarmModal = document.getElementById('alarm-modal');
            const alarmToggle = document.getElementById('alarm-toggle');
            const alarmClose = document.getElementById('alarm-close');
            
            // æ‰“å¼€å‘Šè­¦å¼¹æ¡†
            alarmToggle.addEventListener('click', function(e) {
                e.stopPropagation();
                showAlarmModal();
            });
            
            // å…³é—­å‘Šè­¦å¼¹æ¡†
            alarmClose.addEventListener('click', function() {
                hideAlarmModal();
            });
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            alarmModal.addEventListener('click', function(e) {
                if (e.target === alarmModal) {
                    hideAlarmModal();
                }
            });
            
            // ESCé”®å…³é—­
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && alarmModal.classList.contains('show')) {
                    hideAlarmModal();
                }
            });
            
            // å‘Šè­¦çº§åˆ«è¿‡æ»¤
            document.querySelectorAll('.alarm-stat').forEach(stat => {
                stat.addEventListener('click', function() {
                    const filterLevel = this.getAttribute('data-filter');
                    setAlarmFilter(filterLevel);
                });
            });
            
            // åˆå§‹åŒ–å‘Šè­¦æ•°æ®æ˜¾ç¤º
            updateAlarmDisplay();
        }

        // æ˜¾ç¤ºå‘Šè­¦å¼¹æ¡†
        function showAlarmModal() {
            const alarmModal = document.getElementById('alarm-modal');
            const globalTooltip = document.getElementById('global-tooltip');
            
            // éšè—å·¥å…·æç¤º
            if (globalTooltip) {
                globalTooltip.classList.remove('show');
            }
            
            generateAlarmList();
            alarmModal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        // éšè—å‘Šè­¦å¼¹æ¡†
        function hideAlarmModal() {
            const alarmModal = document.getElementById('alarm-modal');
            alarmModal.classList.remove('show');
            document.body.style.overflow = '';
        }

        // æ›´æ–°å‘Šè­¦æ˜¾ç¤º
        function updateAlarmDisplay() {
            const alarmStats = getAlarmStats();
            
            // æ›´æ–°å‘Šè­¦æŒ‰é’®æ•°é‡
            const alarmCount = document.getElementById('alarm-count');
            if (alarmCount) {
                alarmCount.textContent = alarmStats.total;
            }
            
            // æ›´æ–°ç»Ÿè®¡æ•°é‡
            const highCount = document.getElementById('high-alarm-count');
            const mediumCount = document.getElementById('medium-alarm-count');
            const lowCount = document.getElementById('low-alarm-count');
            
            if (highCount) highCount.textContent = alarmStats.high;
            if (mediumCount) mediumCount.textContent = alarmStats.medium;
            if (lowCount) lowCount.textContent = alarmStats.low;
        }

        // è·å–å‘Šè­¦ç»Ÿè®¡
        function getAlarmStats() {
            const stats = { high: 0, medium: 0, low: 0, total: 0 };
            
            alarmData.forEach(alarm => {
                if (alarm.status === 'active') {
                    stats[alarm.level]++;
                    stats.total++;
                }
            });
            
            return stats;
        }

        // ç”Ÿæˆå‘Šè­¦åˆ—è¡¨
        function generateAlarmList() {
            const alarmList = document.getElementById('alarm-list');
            if (!alarmList) return;
            
            // è¿‡æ»¤å‘Šè­¦æ•°æ®
            let filteredAlarms = alarmData.filter(alarm => alarm.status === 'active');
            if (currentAlarmFilter) {
                filteredAlarms = filteredAlarms.filter(alarm => alarm.level === currentAlarmFilter);
            }
            
            // æŒ‰æ—¶é—´æˆ³å€’åºæ’åˆ—ï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
            const sortedAlarms = filteredAlarms.sort((a, b) => b.timestamp - a.timestamp);
            
            if (sortedAlarms.length === 0) {
                alarmList.innerHTML = `
                    <div style="padding: 40px 20px; text-align: center; color: #888;">
                        ${currentAlarmFilter ? 'è¯¥çº§åˆ«æš‚æ— å‘Šè­¦' : 'æš‚æ— å‘Šè­¦'}
                    </div>
                `;
                return;
            }
            
            alarmList.innerHTML = sortedAlarms.map(alarm => `
                <div class="alarm-item" data-alarm-id="${alarm.id}">
                    <div class="alarm-item-level ${alarm.level}"></div>
                    <div class="alarm-item-content" onclick="navigateToAlarmDevice('${alarm.deviceId}')">
                        <div class="alarm-item-title">${alarm.title}</div>
                        <div class="alarm-item-desc">${alarm.deviceName} - ${alarm.description}</div>
                    </div>
                    <div class="alarm-item-time">${alarm.time}</div>
                    <div class="alarm-actions">
                        <button class="alarm-action-btn alarm-action-handle" onclick="handleAlarmAction('${alarm.id}', 'handle')">å¤„ç†</button>
                        <button class="alarm-action-btn alarm-action-forward" onclick="handleAlarmAction('${alarm.id}', 'forward')">è½¬å‘</button>
                        <button class="alarm-action-btn alarm-action-ignore" onclick="handleAlarmAction('${alarm.id}', 'ignore')">å¿½ç•¥</button>
                    </div>
                </div>
            `).join('');
        }

        // å¯¼èˆªåˆ°å‘Šè­¦è®¾å¤‡
        function navigateToAlarmDevice(deviceId) {
            // å…³é—­å‘Šè­¦å¼¹æ¡†
            hideAlarmModal();
            
            // ä½¿ç”¨ç»Ÿä¸€çš„èŠ‚ç‚¹åˆ‡æ¢å‡½æ•°
            const success = switchToNode(deviceId, 'alarm_click');
            
            if (success) {
                // æ˜¾ç¤ºæˆåŠŸæç¤º
                showNotification(`å·²åˆ‡æ¢åˆ°å‘Šè­¦è®¾å¤‡ï¼š${getDeviceDisplayName(deviceId)}`, 'success');
            } else {
                showNotification('è®¾å¤‡æœªæ‰¾åˆ°', 'error');
            }
        }

        // è®¾ç½®å‘Šè­¦è¿‡æ»¤
        function setAlarmFilter(level) {
            const alarmStats = document.querySelectorAll('.alarm-stat');
            const filterTip = document.getElementById('alarm-filter-tip');
            const filterText = document.getElementById('filter-text');
            
            // æ¸…é™¤æ‰€æœ‰æ¿€æ´»çŠ¶æ€
            alarmStats.forEach(stat => stat.classList.remove('active'));
            
            if (currentAlarmFilter === level) {
                // å¦‚æœç‚¹å‡»å½“å‰æ¿€æ´»çš„è¿‡æ»¤å™¨ï¼Œåˆ™å–æ¶ˆè¿‡æ»¤
                currentAlarmFilter = null;
                filterTip.classList.remove('show');
            } else {
                // è®¾ç½®æ–°çš„è¿‡æ»¤å™¨
                currentAlarmFilter = level;
                const activeStat = document.querySelector(`[data-filter="${level}"]`);
                if (activeStat) {
                    activeStat.classList.add('active');
                }
                
                const levelNames = {
                    'high': 'é«˜çº§å‘Šè­¦',
                    'medium': 'ä¸­çº§å‘Šè­¦',
                    'low': 'ä½çº§å‘Šè­¦'
                };
                
                filterText.textContent = levelNames[level];
                filterTip.classList.add('show');
            }
            
            // é‡æ–°ç”Ÿæˆå‘Šè­¦åˆ—è¡¨
            generateAlarmList();
        }

        // æ¸…é™¤å‘Šè­¦è¿‡æ»¤
        function clearAlarmFilter() {
            currentAlarmFilter = null;
            document.querySelectorAll('.alarm-stat').forEach(stat => stat.classList.remove('active'));
            document.getElementById('alarm-filter-tip').classList.remove('show');
            generateAlarmList();
        }

        // å¤„ç†å‘Šè­¦æ“ä½œ
        function handleAlarmAction(alarmId, action) {
            const alarm = alarmData.find(a => a.id === alarmId);
            if (!alarm) return;
            
            let actionText = '';
            let newStatus = 'active';
            
            switch (action) {
                case 'handle':
                    actionText = 'å¤„ç†';
                    newStatus = 'handled';
                    break;
                case 'forward':
                    actionText = 'è½¬å‘';
                    // è¿™é‡Œå¯ä»¥æ‰“å¼€è½¬å‘å¯¹è¯æ¡†
                    showNotification(`å‘Šè­¦"${alarm.title}"å·²è½¬å‘`, 'success');
                    return;
                case 'ignore':
                    actionText = 'å¿½ç•¥';
                    newStatus = 'ignored';
                    break;
            }
            
            // æ›´æ–°å‘Šè­¦çŠ¶æ€
            alarm.status = newStatus;
            
            // æ›´æ–°æ˜¾ç¤º
            updateAlarmDisplay();
            generateAlarmList();
            
            // æ˜¾ç¤ºæ“ä½œç»“æœ
            showNotification(`å‘Šè­¦"${alarm.title}"å·²${actionText}`, 'success');
        }

        // è·å–è®¾å¤‡æ˜¾ç¤ºåç§°
        function getDeviceDisplayName(deviceId) {
            const deviceNames = {
                'crusher-motor': 'é¢šå¼ç ´ç¢æœºç”µæœº',
                'crusher-bearing': 'é¢šå¼ç ´ç¢æœºè½´æ‰¿',
                'crusher-1': 'é¢šå¼ç ´ç¢æœº',
                'ball-mill': 'çƒç£¨æœº',
                'mill-motor': 'çƒç£¨æœºä¸»ç”µæœº',
                'mill-gearbox': 'çƒç£¨æœºå‡é€Ÿå™¨',
                'rotary-kiln': 'å›è½¬çª‘',
                'crushing-workshop': 'ç ´ç¢å·¥æ®µ',
                'grinding-workshop': 'ç²‰ç£¨å·¥æ®µ',
                'burning-workshop': 'ç……çƒ§å·¥æ®µ'
            };
            return deviceNames[deviceId] || deviceId;
        }

        // å…¨å±è§†å›¾åˆ‡æ¢
        let isFullscreenView = false;
        function toggleFullscreenView() {
            const leftPanel = document.getElementById('metrics-panel');
            const rightPanel = document.getElementById('right-metrics-panel');
            const expandButton = document.getElementById('expand-toggle');
            const globalTooltip = document.getElementById('global-tooltip');
            
            isFullscreenView = !isFullscreenView;
            
            // éšè—å·¥å…·æç¤º
            if (globalTooltip) {
                globalTooltip.classList.remove('show');
            }
            
            if (isFullscreenView) {
                // éšè—å·¦å³é¢æ¿
                leftPanel.style.display = 'none';
                rightPanel.style.display = 'none';
                expandButton.textContent = 'â¤¡';
                expandButton.classList.add('active');
                expandButton.setAttribute('data-tooltip', 'é€€å‡ºå…¨å±');
            } else {
                // æ˜¾ç¤ºå·¦å³é¢æ¿
                leftPanel.style.display = 'block';
                rightPanel.style.display = 'block';
                expandButton.textContent = 'â¤¢';
                expandButton.classList.remove('active');
                expandButton.setAttribute('data-tooltip', 'å…¨å±è§†å›¾');
            }
        }

        // è·å–èŠ‚ç‚¹æŒ‡æ ‡æ•°æ® (ä¿ç•™å…¼å®¹æ€§)
        function getNodeMetrics(nodeId) {
            const deviceData = getEnhancedDeviceData(nodeId);
            return [
                { label: 'æ¸©åº¦', value: deviceData.temperature, unit: 'Â°C' },
                { label: 'å‹åŠ›', value: deviceData.pressure, unit: ' MPa' },
                { label: 'æ•ˆç‡', value: deviceData.efficiency, unit: '%' },
                { label: 'åŠŸç‡', value: deviceData.power, unit: ' kW' }
            ];
        }

        // å®‰å…¨çš„æ•°å€¼æ ¼å¼åŒ–å‡½æ•°
        function safeFormat(value, decimals = 1) {
            if (typeof value === 'number' && !isNaN(value)) {
                return decimals === 0 ? Math.round(value).toString() : value.toFixed(decimals);
            } else if (typeof value === 'string' && !isNaN(parseFloat(value))) {
                const num = parseFloat(value);
                return decimals === 0 ? Math.round(num).toString() : num.toFixed(decimals);
            }
            return value ? value.toString() : '0';
        }

        // ç»Ÿä¸€çš„èŠ‚ç‚¹åˆ‡æ¢å‡½æ•° - å¤„ç†æ‰€æœ‰åˆ‡æ¢åœºæ™¯
        function switchToNode(nodeId, source = 'unknown') {
            try {
                console.log(`ä»${source}åˆ‡æ¢åˆ°èŠ‚ç‚¹:`, nodeId);
                
                // æ£€æŸ¥èŠ‚ç‚¹IDæ˜¯å¦æœ‰æ•ˆ
                if (!nodeId || typeof nodeId !== 'string') {
                    console.warn('æ— æ•ˆçš„èŠ‚ç‚¹ID:', nodeId);
                    return false;
                }
                
                // è·å–èŠ‚ç‚¹æ•°æ®
                const deviceData = getEnhancedDeviceData(nodeId);
                if (!deviceData || !deviceData.name) {
                    console.warn('æœªæ‰¾åˆ°èŠ‚ç‚¹æ•°æ®:', nodeId);
                    // å¦‚æœæ‰¾ä¸åˆ°æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤çš„å·¥å‚æ•°æ®
                    if (nodeId !== 'cement-factory') {
                        return switchToNode('cement-factory', 'fallback');
                    }
                    return false;
                }
                
                // æ›´æ–°å…¨å±€é€‰ä¸­èŠ‚ç‚¹
                selectedNode = {
                    id: nodeId,
                    level: deviceData.level || 'unknown',
                    name: deviceData.name || nodeId
                };
                
                // 1. æ›´æ–°æ ‘å½¢ç»“æ„é€‰ä¸­çŠ¶æ€
                try {
                    updateTreeSelection(nodeId);
                } catch (e) {
                    console.warn('æ›´æ–°æ ‘å½¢ç»“æ„å¤±è´¥:', e);
                }
                
                // 2. æ›´æ–°ä¸‹æ‹‰æ¡†æ˜¾ç¤º
                try {
                    const selectedAssetSpan = document.getElementById('selected-asset');
                    if (selectedAssetSpan) {
                        selectedAssetSpan.textContent = deviceData.name;
                    }
                } catch (e) {
                    console.warn('æ›´æ–°ä¸‹æ‹‰æ¡†æ˜¾ç¤ºå¤±è´¥:', e);
                }
                
                // 3. æ›´æ–°é¢åŒ…å±‘å¯¼èˆª
                try {
                    updateBreadcrumb();
                } catch (e) {
                    console.warn('æ›´æ–°é¢åŒ…å±‘å¤±è´¥:', e);
                }
                
                // 4. æ›´æ–°å·¦ä¾§æŒ‡æ ‡é¢æ¿
                try {
                    updateMetricsForNode(nodeId);
                } catch (e) {
                    console.warn('æ›´æ–°å·¦ä¾§æŒ‡æ ‡é¢æ¿å¤±è´¥:', e);
                }
                
                // 5. æ›´æ–°å³ä¾§ç³»ç»Ÿæ¦‚è§ˆé¢æ¿
                try {
                    updateRightMetricsPanel();
                } catch (e) {
                    console.warn('æ›´æ–°å³ä¾§ç³»ç»Ÿæ¦‚è§ˆé¢æ¿å¤±è´¥:', e);
                }
                
                // 6. æ›´æ–°3Dè§†å›¾
                try {
                    if (scene && camera) {
                        update3DViewForNode(nodeId);
                    }
                } catch (e) {
                    console.warn('æ›´æ–°3Dè§†å›¾å¤±è´¥:', e);
                }
                
                // 7. æ›´æ–°2Dè§†å›¾
                try {
                    if (document.getElementById('svg-canvas')) {
                        update2DViewForNode(nodeId);
                    }
                } catch (e) {
                    console.warn('æ›´æ–°2Dè§†å›¾å¤±è´¥:', e);
                }
                
                // 8. å¦‚æœæ˜¯å‘Šè­¦èŠ‚ç‚¹ï¼Œè‡ªåŠ¨æ”¾å¤§/èšç„¦
                try {
                    const treeNode = document.querySelector(`[data-id="${nodeId}"]`);
                    if (treeNode && (treeNode.classList.contains('alarm-low') || 
                        treeNode.classList.contains('alarm-medium') || 
                        treeNode.classList.contains('alarm-high'))) {
                        zoomToNode(selectedNode);
                    }
                } catch (e) {
                    console.warn('æ”¾å¤§å‘Šè­¦èŠ‚ç‚¹å¤±è´¥:', e);
                }
                
                // 9. å…³é—­ä¸‹æ‹‰æ¡†ï¼ˆå¦‚æœæ˜¯ä»ä¸‹æ‹‰æ¡†åˆ‡æ¢çš„ï¼‰
                try {
                    const dropdownContent = document.getElementById('tree-dropdown-content');
                    if (dropdownContent) {
                        dropdownContent.classList.remove('show');
                    }
                } catch (e) {
                    console.warn('å…³é—­ä¸‹æ‹‰æ¡†å¤±è´¥:', e);
                }
                
                console.log('èŠ‚ç‚¹åˆ‡æ¢å®Œæˆ:', selectedNode);
                return true;
                
            } catch (error) {
                console.error('èŠ‚ç‚¹åˆ‡æ¢è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
                console.error('é”™è¯¯å‘ç”Ÿåœ¨èŠ‚ç‚¹:', nodeId, 'æ¥æº:', source);
                
                // å¦‚æœä¸æ˜¯å·¥å‚èŠ‚ç‚¹ï¼Œå°è¯•å›é€€åˆ°å·¥å‚èŠ‚ç‚¹
                if (nodeId !== 'cement-factory') {
                    console.log('å°è¯•å›é€€åˆ°å·¥å‚èŠ‚ç‚¹...');
                    return switchToNode('cement-factory', 'error_fallback');
                }
                
                return false;
            }
        }

        // æ›´æ–°3Dè§†å›¾ä»¥æ˜¾ç¤ºæŒ‡å®šèŠ‚ç‚¹
        function update3DViewForNode(nodeId) {
            // é‡ç½®æ‰€æœ‰å¯¹è±¡çš„å¯è§æ€§
            scene.traverse((child) => {
                if (child.userData && child.userData.id) {
                    child.visible = true;
                }
            });
            
            // èšç„¦åˆ°ç›®æ ‡èŠ‚ç‚¹
            focusOn3DNode(nodeId);
        }

        // æ›´æ–°2Dè§†å›¾ä»¥æ˜¾ç¤ºæŒ‡å®šèŠ‚ç‚¹
        function update2DViewForNode(nodeId) {
            const deviceData = getEnhancedDeviceData(nodeId);
            
            switch(deviceData.level) {
                case 'factory':
                    // æ˜¾ç¤ºå·¥å‚æ€»è§ˆ
                    init2DView();
                    break;
                case 'workshop':
                    // æ˜¾ç¤ºå·¥æ®µè¯¦æƒ…
                    generate2DWorkshopDetail(nodeId);
                    break;
                case 'equipment':
                    // æ˜¾ç¤ºè®¾å¤‡è¯¦æƒ…
                    generate2DEquipmentDetail(nodeId);
                    break;
                case 'component':
                    // æ˜¾ç¤ºç»„ä»¶è¯¦æƒ…
                    generate2DComponentDetail(nodeId);
                    break;
                default:
                    // é»˜è®¤æ˜¾ç¤ºå·¥å‚æ€»è§ˆ
                    init2DView();
                    break;
            }
        }

        // æ›´æ–°è§†å›¾ (ä¿ç•™å…¼å®¹æ€§)
        function updateView() {
            if (selectedNode) {
                console.log('æ›´æ–°è§†å›¾:', selectedNode);
                // è°ƒç”¨ç»Ÿä¸€çš„åˆ‡æ¢å‡½æ•°
                switchToNode(selectedNode.id, 'view_update');
            }
        }

        // æ›´æ–°é¢åŒ…å±‘å¯¼èˆª
        function updateBreadcrumb() {
            const breadcrumbContent = document.querySelector('.breadcrumb-content');
            if (selectedNode && breadcrumbContent) {
                // æ ¹æ®å½“å‰é€‰ä¸­èŠ‚ç‚¹ç”Ÿæˆé¢åŒ…å±‘è·¯å¾„
                const breadcrumbPath = generateBreadcrumbPath(selectedNode.id);
                breadcrumbContent.innerHTML = breadcrumbPath.map((item, index) => 
                    `<span class="breadcrumb-item" data-id="${item.id}">${item.name}</span>` +
                    (index < breadcrumbPath.length - 1 ? '<span class="breadcrumb-separator">></span>' : '')
                ).join('');
            }
        }

        // ç”Ÿæˆé¢åŒ…å±‘è·¯å¾„
        function generateBreadcrumbPath(nodeId) {
            const path = [];
            
            // å§‹ç»ˆåŒ…å«å·¥å‚æ ¹èŠ‚ç‚¹
            path.push({ id: 'cement-factory', name: 'æ°´æ³¥å·¥å‚' });
            
            if (nodeId === 'cement-factory') {
                return path;
            }
            
            // æ ¹æ®nodeIdç¡®å®šå±‚çº§è·¯å¾„
            const deviceData = getEnhancedDeviceData(nodeId);
            if (!deviceData) return path;
            
            // æ ¹æ®ä¸åŒå±‚çº§æ·»åŠ çˆ¶çº§è·¯å¾„
            switch(deviceData.level) {
                case 'workshop':
                    path.push({ id: nodeId, name: deviceData.name });
                    break;
                    
                case 'equipment':
                    // æ·»åŠ æ‰€å±å·¥æ®µ
                    if (nodeId.includes('crusher') || nodeId.includes('conveyor')) {
                        path.push({ id: 'crushing-workshop', name: 'ç ´ç¢å·¥æ®µ' });
                    } else if (nodeId.includes('ball-mill') || nodeId.includes('separator')) {
                        path.push({ id: 'grinding-workshop', name: 'ç²‰ç£¨å·¥æ®µ' });
                    } else if (nodeId.includes('rotary-kiln')) {
                        path.push({ id: 'burning-workshop', name: 'ç……çƒ§å·¥æ®µ' });
                    }
                    path.push({ id: nodeId, name: deviceData.name });
                    break;
                    
                case 'component':
                    // æ·»åŠ æ‰€å±å·¥æ®µå’Œè®¾å¤‡
                    if (nodeId.includes('crusher')) {
                        path.push({ id: 'crushing-workshop', name: 'ç ´ç¢å·¥æ®µ' });
                        path.push({ id: 'crusher-1', name: 'é¢šå¼ç ´ç¢æœº' });
                    } else if (nodeId.includes('mill')) {
                        path.push({ id: 'grinding-workshop', name: 'ç²‰ç£¨å·¥æ®µ' });
                        path.push({ id: 'ball-mill', name: 'çƒç£¨æœº' });
                    } else if (nodeId.includes('kiln')) {
                        path.push({ id: 'burning-workshop', name: 'ç……çƒ§å·¥æ®µ' });
                        path.push({ id: 'rotary-kiln', name: 'å›è½¬çª‘' });
                    }
                    path.push({ id: nodeId, name: deviceData.name });
                    break;
            }
            
            return path;
        }

        // æ ¹æ®ä¸‹é’»è·¯å¾„ç”Ÿæˆé¢åŒ…å±‘
        function generateBreadcrumbFromDrillPath() {
            const breadcrumbPath = [];
            
            // æ€»æ˜¯ä»å·¥å‚å¼€å§‹
            if (drillPath.length === 0 || drillPath[0] !== 'cement-factory') {
                breadcrumbPath.push({ id: 'cement-factory', name: 'æ°´æ³¥å·¥å‚' });
            }
            
            // æ·»åŠ ä¸‹é’»è·¯å¾„ä¸­çš„èŠ‚ç‚¹
            drillPath.forEach(nodeId => {
                const node = assetHierarchy[nodeId];
                if (node) {
                    breadcrumbPath.push({ id: nodeId, name: node.name });
                }
            });
            
            return breadcrumbPath;
        }

        // è·å–é¢åŒ…å±‘è·¯å¾„
        function getBreadcrumbPath(node) {
            const paths = {
                'cement-factory': [{ id: 'cement-factory', name: 'æ°´æ³¥å·¥å‚' }],
                'crushing-workshop': [
                    { id: 'cement-factory', name: 'æ°´æ³¥å·¥å‚' },
                    { id: 'crushing-workshop', name: 'ç ´ç¢å·¥æ®µ' }
                ],
                'grinding-workshop': [
                    { id: 'cement-factory', name: 'æ°´æ³¥å·¥å‚' },
                    { id: 'grinding-workshop', name: 'ç²‰ç£¨å·¥æ®µ' }
                ],
                'calcining-workshop': [
                    { id: 'cement-factory', name: 'æ°´æ³¥å·¥å‚' },
                    { id: 'calcining-workshop', name: 'ç……çƒ§å·¥æ®µ' }
                ],
                'crusher-1': [
                    { id: 'cement-factory', name: 'æ°´æ³¥å·¥å‚' },
                    { id: 'crushing-workshop', name: 'ç ´ç¢å·¥æ®µ' },
                    { id: 'crusher-1', name: 'é¢šå¼ç ´ç¢æœº #1' }
                ],
                'ball-mill': [
                    { id: 'cement-factory', name: 'æ°´æ³¥å·¥å‚' },
                    { id: 'grinding-workshop', name: 'ç²‰ç£¨å·¥æ®µ' },
                    { id: 'ball-mill', name: 'çƒç£¨æœº' }
                ],
                'rotary-kiln': [
                    { id: 'cement-factory', name: 'æ°´æ³¥å·¥å‚' },
                    { id: 'calcining-workshop', name: 'ç……çƒ§å·¥æ®µ' },
                    { id: 'rotary-kiln', name: 'å›è½¬çª‘' }
                ],
                'cement-mill': [
                    { id: 'cement-factory', name: 'æ°´æ³¥å·¥å‚' },
                    { id: 'grinding-workshop', name: 'ç²‰ç£¨å·¥æ®µ' },
                    { id: 'cement-mill', name: 'æ°´æ³¥ç£¨' }
                ],
                'crusher-motor': [
                    { id: 'cement-factory', name: 'æ°´æ³¥å·¥å‚' },
                    { id: 'crushing-workshop', name: 'ç ´ç¢å·¥æ®µ' },
                    { id: 'crusher-1', name: 'é¢šå¼ç ´ç¢æœº #1' },
                    { id: 'crusher-motor', name: 'é©±åŠ¨ç”µæœº' }
                ],
                'crusher-bearing': [
                    { id: 'cement-factory', name: 'æ°´æ³¥å·¥å‚' },
                    { id: 'crushing-workshop', name: 'ç ´ç¢å·¥æ®µ' },
                    { id: 'crusher-1', name: 'é¢šå¼ç ´ç¢æœº #1' },
                    { id: 'crusher-bearing', name: 'è½´æ‰¿' }
                ],
                'ball-mill-motor': [
                    { id: 'cement-factory', name: 'æ°´æ³¥å·¥å‚' },
                    { id: 'grinding-workshop', name: 'ç²‰ç£¨å·¥æ®µ' },
                    { id: 'ball-mill', name: 'çƒç£¨æœº' },
                    { id: 'ball-mill-motor', name: 'ä¸»ç”µæœº' }
                ]
            };
            
            return paths[node.id] || [{ id: node.id, name: node.name || node.id }];
        }

        // å¯¼èˆªåˆ°æŒ‡å®šèŠ‚ç‚¹
        function navigateToNode(nodeId) {
            console.log('å¯¼èˆªåˆ°èŠ‚ç‚¹:', nodeId);
            
            // æ›´æ–°é€‰ä¸­èŠ‚ç‚¹
            const treeNode = document.querySelector(`[data-id="${nodeId}"]`);
            if (treeNode) {
                // ç§»é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
                document.querySelectorAll('.tree-node').forEach(node => {
                    node.classList.remove('selected');
                });
                
                // æ·»åŠ é€‰ä¸­çŠ¶æ€
                treeNode.classList.add('selected');
                
                // å±•å¼€çˆ¶èŠ‚ç‚¹
                expandParentNodes(treeNode);
                
                // æ›´æ–°é€‰ä¸­èŠ‚ç‚¹
                selectedNode = { id: nodeId, name: treeNode.textContent.trim() };
                
                // æ›´æ–°é¢åŒ…å±‘
                updateBreadcrumb();
                
                // æ›´æ–°è§†å›¾ - è‡ªåŠ¨èšç„¦åˆ°é€‰ä¸­èŠ‚ç‚¹
                focusOnNode(nodeId);
                
                // æ›´æ–°æŒ‡æ ‡é¢æ¿
                updateMetricsForNode(nodeId);
            }
        }

        // å±•å¼€çˆ¶èŠ‚ç‚¹
        function expandParentNodes(node) {
            let parent = node.parentElement;
            while (parent) {
                if (parent.classList && parent.classList.contains('tree-children')) {
                    parent.style.display = 'block';
                    // æ‰¾åˆ°å¯¹åº”çš„çˆ¶èŠ‚ç‚¹å¹¶æ ‡è®°ä¸ºå±•å¼€
                    const parentNode = parent.previousElementSibling;
                    if (parentNode && parentNode.querySelector('.tree-toggle')) {
                        parentNode.querySelector('.tree-toggle').textContent = 'âˆ’';
                    }
                }
                parent = parent.parentElement;
            }
        }

        // èšç„¦åˆ°æŒ‡å®šèŠ‚ç‚¹
        function focusOnNode(nodeId) {
            if (currentView === '3d') {
                focusOn3DNode(nodeId);
            } else {
                focusOn2DNode(nodeId);
            }
        }

        // 3Dè§†å›¾èšç„¦
        function focusOn3DNode(nodeId) {
            // å°è¯•å¤šç§æ–¹å¼æ‰¾åˆ°å¯¹è±¡
            let targetObject = scene.children.find(child => 
                child.userData && child.userData.id === nodeId
            );
            
            // å¦‚æœç›´æ¥æ‰¾ä¸åˆ°ï¼Œå°è¯•é€’å½’æŸ¥æ‰¾
            if (!targetObject) {
                scene.traverse(child => {
                    if (child.userData && child.userData.id === nodeId && !targetObject) {
                        targetObject = child;
                    }
                });
            }
            
            if (targetObject && camera && controls) {
                // è®¡ç®—ç›®æ ‡ä½ç½®
                const box = new THREE.Box3().setFromObject(targetObject);
                const center = box.getCenter(new THREE.Vector3());
                const size = box.getSize(new THREE.Vector3());
                
                // æ ¹æ®å±‚çº§è°ƒæ•´ç›¸æœºè·ç¦»
                const node = assetHierarchy[nodeId];
                let distanceMultiplier = 2;
                
                if (node) {
                    switch (node.type) {
                        case 'factory':
                            distanceMultiplier = 3;
                            break;
                        case 'workshop':
                            distanceMultiplier = 2;
                            break;
                        case 'equipment':
                            distanceMultiplier = 1.5;
                            break;
                        case 'component':
                            distanceMultiplier = 1;
                            break;
                    }
                }
                
                // è®¾ç½®ç›¸æœºä½ç½®
                const maxDim = Math.max(size.x, size.y, size.z);
                const fov = camera.fov * (Math.PI / 180);
                let cameraZ = Math.abs(maxDim / 2 / Math.tan(fov / 2));
                
                cameraZ *= distanceMultiplier; // æ ¹æ®å±‚çº§è°ƒæ•´è·ç¦»
                cameraZ = Math.max(cameraZ, 10); // æœ€å°è·ç¦»
                
                // å¹³æ»‘åŠ¨ç”»åˆ°ç›®æ ‡ä½ç½®
                animateCamera(
                    camera.position,
                    new THREE.Vector3(center.x, center.y, center.z + cameraZ),
                    center
                );
            } else {
                console.warn(`æ— æ³•æ‰¾åˆ°èŠ‚ç‚¹ ${nodeId} å¯¹åº”çš„3Då¯¹è±¡`);
            }
        }

        // 2Dè§†å›¾èšç„¦
        function focusOn2DNode(nodeId) {
            const svgElement = document.querySelector(`#svg-container rect[id="${nodeId}"]`);
            if (svgElement) {
                const rect = svgElement.getBoundingClientRect();
                const container = document.getElementById('svg-container');
                
                // æ»šåŠ¨åˆ°ç›®æ ‡å…ƒç´ 
                container.scrollTo({
                    left: rect.left - container.offsetWidth / 2,
                    top: rect.top - container.offsetHeight / 2,
                    behavior: 'smooth'
                });
                
                // é«˜äº®æ˜¾ç¤º
                svgElement.style.stroke = '#0078d4';
                svgElement.style.strokeWidth = '3';
                
                // 2ç§’åæ¢å¤
                setTimeout(() => {
                    svgElement.style.stroke = '#333';
                    svgElement.style.strokeWidth = '1';
                }, 2000);
            }
        }

        // ç›¸æœºåŠ¨ç”»
        function animateCamera(startPos, endPos, lookAt) {
            const duration = 1000; // 1ç§’
            const startTime = Date.now();
            
            function animate() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // ä½¿ç”¨easeInOutCubicç¼“åŠ¨å‡½æ•°
                const eased = progress < 0.5 
                    ? 4 * progress * progress * progress
                    : 1 - Math.pow(-2 * progress + 2, 3) / 2;
                
                // æ’å€¼è®¡ç®—å½“å‰ä½ç½®
                camera.position.lerpVectors(startPos, endPos, eased);
                
                // æ›´æ–°æ§åˆ¶å™¨ç›®æ ‡
                if (controls) {
                    controls.target.copy(lookAt);
                    controls.update();
                }
                
                if (progress < 1) {
                    requestAnimationFrame(animate);
                }
            }
            
            animate();
        }

        // æ›´æ–°èŠ‚ç‚¹æŒ‡æ ‡
        function updateMetricsForNode(nodeId) {
            const deviceData = getEnhancedDeviceData(nodeId);
            
            // æ›´æ–°å·¦ä¾§æŒ‡æ ‡é¢æ¿
            const metricsPanel = document.getElementById('metrics-panel');
            if (metricsPanel) {
                const statusAbnormal = deviceData.status === 'å‘Šè­¦' ? ' abnormal' : '';
                
                let metricsHTML = `
                    <div class="sidebar-header">
                        <h3>${deviceData.name}</h3>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">è¿è¡ŒçŠ¶æ€</div>
                        <div class="metric-value${statusAbnormal}">${deviceData.status}</div>
                    </div>
                `;

                // æ ¹æ®è®¾å¤‡å±‚çº§æ˜¾ç¤ºä¸åŒæŒ‡æ ‡
                switch(deviceData.level) {
                    case 'factory':
                        const prodAbnormal = isMetricAbnormal('totalProduction', deviceData.totalProduction, nodeId) ? ' abnormal' : '';
                        const overallEffAbnormal = isMetricAbnormal('overallEfficiency', deviceData.overallEfficiency, nodeId) ? ' abnormal' : '';
                        const totalPowerAbnormal = isMetricAbnormal('totalPower', deviceData.totalPower, nodeId) ? ' abnormal' : '';
                        const onlineEquipAbnormal = isMetricAbnormal('onlineEquipment', deviceData.onlineEquipment, nodeId) ? ' abnormal' : '';
                        const alarmCountAbnormal = isMetricAbnormal('alarmCount', deviceData.alarmCount, nodeId) ? ' abnormal' : '';

                        metricsHTML += `
                            <div class="metric-item">
                                <div class="metric-label">æ€»äº§é‡</div>
                                <div class="metric-value${prodAbnormal}">${safeFormat(deviceData.totalProduction, 0)}<span class="metric-unit">t</span></div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">æ•´ä½“æ•ˆç‡</div>
                                <div class="metric-value${overallEffAbnormal}">${safeFormat(deviceData.overallEfficiency, 1)}<span class="metric-unit">%</span></div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">æ€»åŠŸç‡</div>
                                <div class="metric-value${totalPowerAbnormal}">${safeFormat(deviceData.totalPower, 0)}<span class="metric-unit">kW</span></div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">åœ¨çº¿è®¾å¤‡</div>
                                <div class="metric-value${onlineEquipAbnormal}">${safeFormat(deviceData.onlineEquipment, 0)}/${safeFormat(deviceData.totalEquipment, 0)}<span class="metric-unit">å°</span></div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">å‘Šè­¦æ•°é‡</div>
                                <div class="metric-value${alarmCountAbnormal}">${safeFormat(deviceData.alarmCount, 0)}<span class="metric-unit">é¡¹</span></div>
                            </div>
                        `;
                        break;

                    case 'workshop':
                        const workshopEffAbnormal = isMetricAbnormal('workshopEfficiency', deviceData.workshopEfficiency, nodeId) ? ' abnormal' : '';
                        const workshopPowerAbnormal = isMetricAbnormal('workshopPower', deviceData.workshopPower, nodeId) ? ' abnormal' : '';
                        const throughputAbnormal = isMetricAbnormal('materialThroughput', deviceData.materialThroughput, nodeId) ? ' abnormal' : '';
                        const avgVibrationAbnormal = isMetricAbnormal('avgVibration', deviceData.avgVibration, nodeId) ? ' abnormal' : '';

                        metricsHTML += `
                            <div class="metric-item">
                                <div class="metric-label">å·¥æ®µæ•ˆç‡</div>
                                <div class="metric-value${workshopEffAbnormal}">${safeFormat(deviceData.workshopEfficiency, 1)}<span class="metric-unit">%</span></div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">å·¥æ®µåŠŸç‡</div>
                                <div class="metric-value${workshopPowerAbnormal}">${safeFormat(deviceData.workshopPower, 0)}<span class="metric-unit">kW</span></div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">ç‰©æ–™å¤„ç†é‡</div>
                                <div class="metric-value${throughputAbnormal}">${safeFormat(deviceData.materialThroughput, 1)}<span class="metric-unit">t/h</span></div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">è®¾å¤‡çŠ¶æ€</div>
                                <div class="metric-value">${safeFormat(deviceData.runningCount, 0)}/${safeFormat(deviceData.equipmentCount, 0)}<span class="metric-unit">å°è¿è¡Œ</span></div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">å¹³å‡æŒ¯åŠ¨</div>
                                <div class="metric-value${avgVibrationAbnormal}">${safeFormat(deviceData.avgVibration, 1)}<span class="metric-unit">mm/s</span></div>
                            </div>
                        `;

                        // ç……çƒ§å·¥æ®µç‰¹æ®Šæ˜¾ç¤ºå¹³å‡æ¸©åº¦
                        if (deviceData.avgTemperature) {
                            const avgTempAbnormal = isMetricAbnormal('avgTemperature', deviceData.avgTemperature, nodeId) ? ' abnormal' : '';
                            metricsHTML += `
                                <div class="metric-item">
                                    <div class="metric-label">å¹³å‡æ¸©åº¦</div>
                                    <div class="metric-value${avgTempAbnormal}">${safeFormat(deviceData.avgTemperature, 0)}<span class="metric-unit">Â°C</span></div>
                                </div>
                            `;
                        }
                        break;

                    case 'equipment':
                        const tempAbnormal = isMetricAbnormal('temperature', deviceData.temperature, nodeId) ? ' abnormal' : '';
                        const pressureAbnormal = isMetricAbnormal('pressure', deviceData.pressure, nodeId) ? ' abnormal' : '';
                        const speedAbnormal = isMetricAbnormal('speed', deviceData.speed, nodeId) ? ' abnormal' : '';
                        const efficiencyAbnormal = isMetricAbnormal('efficiency', deviceData.efficiency, nodeId) ? ' abnormal' : '';
                        const powerAbnormal = isMetricAbnormal('power', deviceData.power, nodeId) ? ' abnormal' : '';
                        const vibrationAbnormal = isMetricAbnormal('vibration', deviceData.vibration, nodeId) ? ' abnormal' : '';

                        metricsHTML += `
                            <div class="metric-item">
                                <div class="metric-label">æ¸©åº¦</div>
                                <div class="metric-value${tempAbnormal}">${safeFormat(deviceData.temperature, 1)}<span class="metric-unit">Â°C</span></div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">å‹åŠ›</div>
                                <div class="metric-value${pressureAbnormal}">${safeFormat(deviceData.pressure, 1)}<span class="metric-unit">MPa</span></div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">è½¬é€Ÿ</div>
                                <div class="metric-value${speedAbnormal}">${safeFormat(deviceData.speed, 0)}<span class="metric-unit">rpm</span></div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">æ•ˆç‡</div>
                                <div class="metric-value${efficiencyAbnormal}">${safeFormat(deviceData.efficiency, 1)}<span class="metric-unit">%</span></div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">åŠŸç‡</div>
                                <div class="metric-value${powerAbnormal}">${safeFormat(deviceData.power, 0)}<span class="metric-unit">kW</span></div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">æŒ¯åŠ¨</div>
                                <div class="metric-value${vibrationAbnormal}">${safeFormat(deviceData.vibration, 1)}<span class="metric-unit">mm/s</span></div>
                            </div>
                        `;
                        break;

                    case 'component':
                        // æ ¹æ®ä¸åŒç»„ä»¶æ˜¾ç¤ºç‰¹å®šæŒ‡æ ‡
                        if (nodeId.includes('motor')) {
                            const voltageAbnormal = isMetricAbnormal('voltage', deviceData.voltage, nodeId) ? ' abnormal' : '';
                            const currentAbnormal = isMetricAbnormal('current', deviceData.current, nodeId) ? ' abnormal' : '';
                            const tempAbnormal = isMetricAbnormal('temperature', deviceData.temperature, nodeId) ? ' abnormal' : '';
                            const powerAbnormal = isMetricAbnormal('power', deviceData.power, nodeId) ? ' abnormal' : '';
                            const efficiencyAbnormal = isMetricAbnormal('efficiency', deviceData.efficiency, nodeId) ? ' abnormal' : '';
                            const vibrationAbnormal = isMetricAbnormal('vibration', deviceData.vibration, nodeId) ? ' abnormal' : '';

                            metricsHTML += `
                                <div class="metric-item">
                                    <div class="metric-label">ç”µå‹</div>
                                    <div class="metric-value${voltageAbnormal}">${safeFormat(deviceData.voltage, 0)}<span class="metric-unit">V</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">ç”µæµ</div>
                                    <div class="metric-value${currentAbnormal}">${safeFormat(deviceData.current, 1)}<span class="metric-unit">A</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">æ¸©åº¦</div>
                                    <div class="metric-value${tempAbnormal}">${safeFormat(deviceData.temperature, 1)}<span class="metric-unit">Â°C</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">åŠŸç‡</div>
                                    <div class="metric-value${powerAbnormal}">${safeFormat(deviceData.power, 0)}<span class="metric-unit">kW</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">æ•ˆç‡</div>
                                    <div class="metric-value${efficiencyAbnormal}">${safeFormat(deviceData.efficiency, 1)}<span class="metric-unit">%</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">æŒ¯åŠ¨</div>
                                    <div class="metric-value${vibrationAbnormal}">${safeFormat(deviceData.vibration, 1)}<span class="metric-unit">mm/s</span></div>
                                </div>
                            `;
                        } else if (nodeId.includes('bearing')) {
                            const tempAbnormal = isMetricAbnormal('temperature', deviceData.temperature, nodeId) ? ' abnormal' : '';
                            const lubricationAbnormal = isMetricAbnormal('lubrication', deviceData.lubrication, nodeId) ? ' abnormal' : '';
                            const vibrationAbnormal = isMetricAbnormal('vibration', deviceData.vibration, nodeId) ? ' abnormal' : '';
                            const wearAbnormal = isMetricAbnormal('wear', deviceData.wear, nodeId) ? ' abnormal' : '';
                            const runningTimeAbnormal = isMetricAbnormal('runningTime', deviceData.runningTime, nodeId) ? ' abnormal' : '';

                            metricsHTML += `
                                <div class="metric-item">
                                    <div class="metric-label">æ¸©åº¦</div>
                                    <div class="metric-value${tempAbnormal}">${safeFormat(deviceData.temperature, 1)}<span class="metric-unit">Â°C</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">æ¶¦æ»‘çŠ¶æ€</div>
                                    <div class="metric-value${lubricationAbnormal}">${safeFormat(deviceData.lubrication, 1)}<span class="metric-unit">%</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">æŒ¯åŠ¨</div>
                                    <div class="metric-value${vibrationAbnormal}">${safeFormat(deviceData.vibration, 1)}<span class="metric-unit">mm/s</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">ç£¨æŸç¨‹åº¦</div>
                                    <div class="metric-value${wearAbnormal}">${safeFormat(deviceData.wear, 1)}<span class="metric-unit">%</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">è¿è¡Œæ—¶é—´</div>
                                    <div class="metric-value${runningTimeAbnormal}">${safeFormat(deviceData.runningTime, 0)}<span class="metric-unit">h</span></div>
                                </div>
                            `;
                        } else if (nodeId.includes('gearbox')) {
                            const tempAbnormal = isMetricAbnormal('temperature', deviceData.temperature, nodeId) ? ' abnormal' : '';
                            const oilPressureAbnormal = isMetricAbnormal('oilPressure', deviceData.oilPressure, nodeId) ? ' abnormal' : '';
                            const oilTempAbnormal = isMetricAbnormal('oilTemperature', deviceData.oilTemperature, nodeId) ? ' abnormal' : '';
                            const vibrationAbnormal = isMetricAbnormal('vibration', deviceData.vibration, nodeId) ? ' abnormal' : '';
                            const efficiencyAbnormal = isMetricAbnormal('efficiency', deviceData.efficiency, nodeId) ? ' abnormal' : '';

                            metricsHTML += `
                                <div class="metric-item">
                                    <div class="metric-label">ç®±ä½“æ¸©åº¦</div>
                                    <div class="metric-value${tempAbnormal}">${safeFormat(deviceData.temperature, 1)}<span class="metric-unit">Â°C</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">æ²¹å‹</div>
                                    <div class="metric-value${oilPressureAbnormal}">${safeFormat(deviceData.oilPressure, 2)}<span class="metric-unit">MPa</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">æ²¹æ¸©</div>
                                    <div class="metric-value${oilTempAbnormal}">${safeFormat(deviceData.oilTemperature, 1)}<span class="metric-unit">Â°C</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">æŒ¯åŠ¨</div>
                                    <div class="metric-value${vibrationAbnormal}">${safeFormat(deviceData.vibration, 1)}<span class="metric-unit">mm/s</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">ä¼ åŠ¨æ•ˆç‡</div>
                                    <div class="metric-value${efficiencyAbnormal}">${safeFormat(deviceData.efficiency, 1)}<span class="metric-unit">%</span></div>
                                </div>
                            `;
                        } else if (nodeId.includes('burner')) {
                            const flameTempAbnormal = isMetricAbnormal('flameTemperature', deviceData.flameTemperature, nodeId) ? ' abnormal' : '';
                            const fuelPressureAbnormal = isMetricAbnormal('fuelPressure', deviceData.fuelPressure, nodeId) ? ' abnormal' : '';
                            const airPressureAbnormal = isMetricAbnormal('airPressure', deviceData.airPressure, nodeId) ? ' abnormal' : '';
                            const fuelFlowAbnormal = isMetricAbnormal('fuelFlow', deviceData.fuelFlow, nodeId) ? ' abnormal' : '';
                            const efficiencyAbnormal = isMetricAbnormal('efficiency', deviceData.efficiency, nodeId) ? ' abnormal' : '';

                            metricsHTML += `
                                <div class="metric-item">
                                    <div class="metric-label">ç«ç„°æ¸©åº¦</div>
                                    <div class="metric-value${flameTempAbnormal}">${safeFormat(deviceData.flameTemperature, 0)}<span class="metric-unit">Â°C</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">ç‡ƒæ–™å‹åŠ›</div>
                                    <div class="metric-value${fuelPressureAbnormal}">${safeFormat(deviceData.fuelPressure, 2)}<span class="metric-unit">MPa</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">é£å‹</div>
                                    <div class="metric-value${airPressureAbnormal}">${safeFormat(deviceData.airPressure, 1)}<span class="metric-unit">MPa</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">ç‡ƒæ–™æµé‡</div>
                                    <div class="metric-value${fuelFlowAbnormal}">${safeFormat(deviceData.fuelFlow, 1)}<span class="metric-unit">mÂ³/h</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">ç‡ƒçƒ§æ•ˆç‡</div>
                                    <div class="metric-value${efficiencyAbnormal}">${safeFormat(deviceData.efficiency, 1)}<span class="metric-unit">%</span></div>
                                </div>
                            `;
                        } else if (nodeId.includes('cylinder')) {
                            const shellTempAbnormal = isMetricAbnormal('shellTemperature', deviceData.shellTemperature, nodeId) ? ' abnormal' : '';
                            const thicknessAbnormal = isMetricAbnormal('thickness', deviceData.thickness, nodeId) ? ' abnormal' : '';
                            const runoutAbnormal = isMetricAbnormal('runoutValue', deviceData.runoutValue, nodeId) ? ' abnormal' : '';
                            const vibrationAbnormal = isMetricAbnormal('vibration', deviceData.vibration, nodeId) ? ' abnormal' : '';
                            const rotationSpeedAbnormal = isMetricAbnormal('rotationSpeed', deviceData.rotationSpeed, nodeId) ? ' abnormal' : '';

                            metricsHTML += `
                                <div class="metric-item">
                                    <div class="metric-label">ç­’ä½“è¡¨é¢æ¸©åº¦</div>
                                    <div class="metric-value${shellTempAbnormal}">${safeFormat(deviceData.shellTemperature, 0)}<span class="metric-unit">Â°C</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">å£åš</div>
                                    <div class="metric-value${thicknessAbnormal}">${safeFormat(deviceData.thickness, 1)}<span class="metric-unit">mm</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">å¾„å‘è·³åŠ¨</div>
                                    <div class="metric-value${runoutAbnormal}">${safeFormat(deviceData.runoutValue, 1)}<span class="metric-unit">mm</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">æŒ¯åŠ¨</div>
                                    <div class="metric-value${vibrationAbnormal}">${safeFormat(deviceData.vibration, 1)}<span class="metric-unit">mm/s</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">è½¬é€Ÿ</div>
                                    <div class="metric-value${rotationSpeedAbnormal}">${safeFormat(deviceData.rotationSpeed, 1)}<span class="metric-unit">rpm</span></div>
                                </div>
                            `;
                        }
                        break;

                    default:
                        // é»˜è®¤æ˜¾ç¤ºé€šç”¨æŒ‡æ ‡
                        metricsHTML += `
                            <div class="metric-item">
                                <div class="metric-label">æ— å¯ç”¨æŒ‡æ ‡</div>
                                <div class="metric-value">-</div>
                            </div>
                        `;
                        break;
                }

                metricsPanel.innerHTML = metricsHTML;
            }
            
            // æ›´æ–°å³ä¾§ç³»ç»Ÿæ¦‚è§ˆé¢æ¿
            updateRightMetricsPanel();
        }

        // æ›´æ–°å³ä¾§æŒ‡æ ‡é¢æ¿
        function updateRightMetricsPanel() {
            const rightPanel = document.getElementById('right-metrics-panel');
            if (!rightPanel) return;
            
            // æ ¹æ®å½“å‰æ¨¡å¼ç”Ÿæˆä¸åŒçš„ç³»ç»Ÿæ¦‚è§ˆæ•°æ®
            let systemData;
            switch(currentMode) {
                case 'realtime':
                    systemData = generateRealtimeSystemData();
                    break;
                case 'history':
                    systemData = generateHistorySystemData();
                    break;
                case 'simulation':
                    systemData = generateSimulationSystemData();
                    break;
                default:
                    systemData = generateRealtimeSystemData();
            }
            
            // æ£€æµ‹ç³»ç»Ÿçº§æŒ‡æ ‡æ˜¯å¦å¼‚å¸¸
            const efficiencyAbnormal = isMetricAbnormal('overallEfficiency', systemData.overallEfficiency) ? ' abnormal' : '';
            const runtimeAbnormal = isMetricAbnormal('equipmentRuntime', systemData.equipmentRuntime) ? ' abnormal' : '';
            const energyAbnormal = isMetricAbnormal('avgEnergyConsumption', systemData.avgEnergyConsumption) ? ' abnormal' : '';
            const productionAbnormal = isMetricAbnormal('production', systemData.production) ? ' abnormal' : '';
            const alarmAbnormal = isMetricAbnormal('alarmCount', systemData.alarmCount) ? ' abnormal' : '';
            const onlineAbnormal = isMetricAbnormal('onlineDevices', systemData.onlineDevices) ? ' abnormal' : '';

            rightPanel.innerHTML = `
                <div class="sidebar-header">
                    <h3>ç³»ç»Ÿæ¦‚è§ˆ - ${getModeDisplayName(currentMode)}</h3>
                </div>
                <div class="metric-item">
                    <div class="metric-label">æ•´ä½“ç”Ÿäº§æ•ˆç‡</div>
                    <div class="metric-value${efficiencyAbnormal}">${systemData.overallEfficiency}<span class="metric-unit">%</span></div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">è®¾å¤‡æ€»è¿è¡Œç‡</div>
                    <div class="metric-value${runtimeAbnormal}">${systemData.equipmentRuntime}<span class="metric-unit">%</span></div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">å¹³å‡èƒ½è€—</div>
                    <div class="metric-value${energyAbnormal}">${systemData.avgEnergyConsumption}<span class="metric-unit">kWh/t</span></div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">${systemData.productionLabel}</div>
                    <div class="metric-value${productionAbnormal}">${systemData.production}<span class="metric-unit">t</span></div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">å‘Šè­¦æ•°é‡</div>
                    <div class="metric-value${alarmAbnormal}">${systemData.alarmCount}<span class="metric-unit">é¡¹</span></div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">åœ¨çº¿è®¾å¤‡</div>
                    <div class="metric-value${onlineAbnormal}">${systemData.onlineDevices}/${systemData.totalDevices}<span class="metric-unit">å°</span></div>
                </div>
            `;
        }

        // è·å–æ¨¡å¼æ˜¾ç¤ºåç§°
        function getModeDisplayName(mode) {
            const modeNames = {
                'realtime': 'å®æ—¶ç›‘æ§',
                'history': 'å†å²å›çœ‹',
                'simulation': 'æ¨¡æ‹Ÿæ¨æ¼”'
            };
            return modeNames[mode] || 'æœªçŸ¥æ¨¡å¼';
        }

        // ç”Ÿæˆå®æ—¶ç³»ç»Ÿæ•°æ®
        function generateRealtimeSystemData() {
            return {
                overallEfficiency: (85 + Math.random() * 10).toFixed(1),
                equipmentRuntime: (90 + Math.random() * 8).toFixed(1),
                avgEnergyConsumption: (240 + Math.random() * 20).toFixed(1),
                productionLabel: 'ä»Šæ—¥äº§é‡',
                production: Math.round(2300 + Math.random() * 200),
                alarmCount: Math.floor(Math.random() * 5) + 1,
                onlineDevices: 24 + Math.floor(Math.random() * 3),
                totalDevices: 26
            };
        }

        // ç”Ÿæˆå†å²ç³»ç»Ÿæ•°æ®
        function generateHistorySystemData() {
            return {
                overallEfficiency: (80 + Math.random() * 8).toFixed(1),
                equipmentRuntime: (88 + Math.random() * 6).toFixed(1),
                avgEnergyConsumption: (250 + Math.random() * 15).toFixed(1),
                productionLabel: 'å†å²äº§é‡',
                production: Math.round(2100 + Math.random() * 150),
                alarmCount: Math.floor(Math.random() * 3) + 2,
                onlineDevices: 23 + Math.floor(Math.random() * 2),
                totalDevices: 26
            };
        }

        // ç”Ÿæˆæ¨¡æ‹Ÿç³»ç»Ÿæ•°æ®
        function generateSimulationSystemData() {
            const baseEfficiency = 85;
            const baseRuntime = 92;
            const baseEnergy = 245;
            const baseProduction = 2300;
            
            // æ ¹æ®æ¨¡æ‹Ÿå‚æ•°è°ƒæ•´æ•°æ®
            const efficiency = (baseEfficiency * simulationParams.efficiencyFactor * simulationParams.qualityFactor).toFixed(1);
            const runtime = (baseRuntime * simulationParams.efficiencyFactor).toFixed(1);
            const energy = (baseEnergy / (simulationParams.efficiencyFactor * simulationParams.qualityFactor)).toFixed(1);
            const production = Math.round(baseProduction * simulationParams.loadFactor * simulationParams.qualityFactor);
            
            return {
                overallEfficiency: efficiency,
                equipmentRuntime: runtime,
                avgEnergyConsumption: energy,
                productionLabel: 'é¢„æµ‹äº§é‡',
                production: production,
                alarmCount: Math.floor(Math.random() * 4) + 1,
                onlineDevices: 25,
                totalDevices: 26
            };
        }

        // æ¨¡å¼åˆ‡æ¢
        function switchMode(mode) {
            // æ¸…é™¤ç°æœ‰çš„å®æ—¶æ›´æ–°
            if (realTimeInterval) {
                clearInterval(realTimeInterval);
                realTimeInterval = null;
            }

            // éšè—ç¼–è¾‘é¢æ¿
            document.getElementById('edit-panel').classList.remove('visible');
            
            // æ˜¾ç¤ºå¯¹åº”çš„æ§åˆ¶é¢æ¿
            const modePanel = document.getElementById('mode-control-panel');
            const panelTitle = document.getElementById('mode-panel-title');
            const historyControls = document.getElementById('history-controls');
            const simulationControls = document.getElementById('simulation-controls');

            // å…ˆéšè—æ‰€æœ‰æ§åˆ¶é¢æ¿å†…å®¹
            historyControls.style.display = 'none';
            simulationControls.style.display = 'none';

            switch(mode) {
                case 'realtime':
                    panelTitle.textContent = 'å®æ—¶ç›‘æ§';
                    // å®Œå…¨éšè—æ¨¡å¼æ§åˆ¶é¢æ¿
                    modePanel.classList.remove('visible');
                    modePanel.style.display = 'none';
                    startRealTimeUpdates();
                    break;
                case 'history':
                    panelTitle.textContent = 'å†å²å›çœ‹';
                    historyControls.style.display = 'block';
                    modePanel.style.display = 'block';
                    modePanel.classList.add('visible');
                    break;
                case 'simulation':
                    panelTitle.textContent = 'æ¨¡æ‹Ÿæ¨æ¼”';
                    simulationControls.style.display = 'block';
                    modePanel.style.display = 'block';
                    modePanel.classList.add('visible');
                    break;
            }

            // ç¡®ä¿å·¦ä¾§æŒ‡æ ‡é¢æ¿å§‹ç»ˆå¯è§
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.style.display = 'block';
                sidebar.style.visibility = 'visible';
                sidebar.style.opacity = '1';
                sidebar.style.pointerEvents = 'auto';
            }
            
            // ç‰¹åˆ«å¤„ç†å®æ—¶æ¨¡å¼ï¼Œç¡®ä¿å·¦ä¾§æŒ‡æ ‡é¢æ¿å®Œå…¨å¯è§
            if (mode === 'realtime') {
                setTimeout(() => {
                    const sidebar = document.querySelector('.sidebar');
                    if (sidebar) {
                        sidebar.style.display = 'block';
                        sidebar.style.visibility = 'visible';
                        sidebar.style.zIndex = '1001';
                    }
                }, 100);
            }

            updateMetrics();
            
            // æ›´æ–°å³ä¾§æŒ‡æ ‡é¢æ¿
            updateRightMetricsPanel();
            
            // æ›´æ–°3Dæ¨¡å‹æ˜¾ç¤º
            update3DModelForMode(mode);
        }

        // å¯åŠ¨å®æ—¶æ•°æ®æ›´æ–°
        function startRealTimeUpdates() {
            realTimeInterval = setInterval(() => {
                if (currentMode === 'realtime') {
                    // å¦‚æœæœ‰é€‰ä¸­èŠ‚ç‚¹ï¼Œåˆ·æ–°å…¶æŒ‡æ ‡æ•°æ®
                    if (selectedNode && selectedNode.id) {
                        // åªæ›´æ–°æŒ‡æ ‡é¢æ¿ï¼Œä¸è§¦å‘è§†å›¾åˆ‡æ¢
                        updateMetricsForNode(selectedNode.id);
                        updateRightMetricsPanel();
                    } else {
                        // é»˜è®¤æ›´æ–°å·¥å‚çº§åˆ«æŒ‡æ ‡
                        updateMetricsForNode('cement-factory');
                        updateRightMetricsPanel();
                    }
                    
                    // æ¨¡æ‹Ÿå‘Šè­¦æ•°æ®å˜åŒ–ï¼ˆå¶å°”ï¼‰
                    if (Math.random() < 0.1) { // 10%æ¦‚ç‡æ›´æ–°å‘Šè­¦
                        simulateAlarmChanges();
                    }
                }
            }, 2000);
        }

        // è·å–å½“å‰é€‰ä¸­çš„èŠ‚ç‚¹ID
        function getCurrentSelectedNodeId() {
            const activeNode = document.querySelector('.tree-node-content.active');
            return activeNode ? activeNode.getAttribute('data-id') : null;
        }

        // æ¨¡æ‹Ÿå‘Šè­¦å˜åŒ–
        function simulateAlarmChanges() {
            // éšæœºæ›´æ–°å‘Šè­¦æ—¶é—´æˆ–çŠ¶æ€
            const randomIndex = Math.floor(Math.random() * alarmData.length);
            const now = new Date();
            alarmData[randomIndex].time = now.getHours().toString().padStart(2, '0') + ':' + 
                                         now.getMinutes().toString().padStart(2, '0');
            alarmData[randomIndex].timestamp = Date.now();
            
            // æ›´æ–°å‘Šè­¦æ˜¾ç¤º
            updateAlarmDisplay();
        }

        // æ›´æ–°æŒ‡æ ‡ (ä¿ç•™å…¼å®¹æ€§)
        function updateMetrics() {
            // å¦‚æœæœ‰é€‰ä¸­èŠ‚ç‚¹ï¼Œä½¿ç”¨ç»Ÿä¸€çš„åˆ‡æ¢å‡½æ•°æ›´æ–°
            if (selectedNode && selectedNode.id) {
                switchToNode(selectedNode.id, 'metrics_update');
            } else {
                // é»˜è®¤æ›´æ–°å·¥å‚çº§åˆ«æŒ‡æ ‡
                switchToNode('cement-factory', 'metrics_default');
            }
        }

        // åŠ è½½å†å²æ•°æ®
        function loadHistoryData() {
            if (isDataLoading) return;
            isDataLoading = true;

            const date = document.getElementById('history-date').value;
            const startTime = document.getElementById('history-time-start').value;
            const endTime = document.getElementById('history-time-end').value;

            // æ¨¡æ‹Ÿæ•°æ®åŠ è½½
            setTimeout(() => {
                // æ›´æ–°å†å²ä¿¡æ¯æ˜¾ç¤º
                document.getElementById('history-time-range').textContent = 
                    `${date} ${startTime} - ${endTime}`;
                document.getElementById('history-data-points').textContent = 
                    Math.floor(Math.random() * 500 + 100);

                // æ¨¡æ‹ŸåŠ è½½å†å²æ•°æ®åˆ°å…¨å±€å˜é‡
                historyData = generateHistoryData(date, startTime, endTime);
                
                // åº”ç”¨å†å²æ•°æ®åˆ°æŒ‡æ ‡æ˜¾ç¤º
                updateMetrics();
                
                isDataLoading = false;
                
                // æç¤ºåŠ è½½å®Œæˆ
                showNotification('å†å²æ•°æ®åŠ è½½å®Œæˆï¼', 'success');
            }, 1000);
        }

        // ç”Ÿæˆæ¨¡æ‹Ÿå†å²æ•°æ®
        function generateHistoryData(date, startTime, endTime) {
            const data = {};
            const nodes = ['cement-factory', 'crusher-1', 'ball-mill', 'rotary-kiln'];
            
            nodes.forEach(nodeId => {
                data[nodeId] = {
                    efficiency: Math.random() * 20 + 75, // 75-95%
                    temperature: Math.random() * 100 + 50, // 50-150Â°C
                    pressure: Math.random() * 2 + 1.5, // 1.5-3.5 MPa
                    vibration: Math.random() * 5 + 10, // 10-15 mm/s
                    power: Math.random() * 100 + 400 // 400-500 kW
                };
            });
            
            return data;
        }

        // è¿è¡Œæ¨¡æ‹Ÿæ¨æ¼”
        function runSimulation() {
            if (isDataLoading) return;
            isDataLoading = true;

            const baseDate = document.getElementById('sim-base-date').value;
            const baseTime = document.getElementById('sim-base-time').value;
            const targetHours = document.getElementById('sim-target-time').value;

            // æ¨¡æ‹Ÿæ¨æ¼”è®¡ç®—
            setTimeout(() => {
                const predictions = calculatePredictions();
                
                // æ›´æ–°é¢„æµ‹ç»“æœæ˜¾ç¤º
                document.getElementById('predicted-output').textContent = predictions.output;
                document.getElementById('predicted-energy').textContent = predictions.energy;
                document.getElementById('predicted-status').textContent = predictions.status;
                
                // åº”ç”¨é¢„æµ‹æ•°æ®åˆ°æŒ‡æ ‡æ˜¾ç¤º
                updateMetrics();
                
                isDataLoading = false;
                
                // æç¤ºæ¨æ¼”å®Œæˆ
                showNotification('æ¨¡æ‹Ÿæ¨æ¼”å®Œæˆï¼', 'success');
            }, 1500);
        }

        // è®¡ç®—é¢„æµ‹ç»“æœ
        function calculatePredictions() {
            const baseOutput = 180; // åŸºç¡€äº§é‡ t/h
            const baseEnergy = 245; // åŸºç¡€èƒ½è€— kWh/t
            
            const outputPrediction = (baseOutput * simulationParams.loadFactor * 
                                    simulationParams.qualityFactor * 
                                    simulationParams.efficiencyFactor).toFixed(1);
            
            const energyPrediction = (baseEnergy / (simulationParams.efficiencyFactor * 
                                    simulationParams.qualityFactor)).toFixed(1);
            
            let status = 'æ­£å¸¸';
            if (simulationParams.loadFactor > 1.2) status = 'é«˜è´Ÿè·è¿è¡Œ';
            else if (simulationParams.efficiencyFactor < 0.9) status = 'æ•ˆç‡åä½';
            
            return {
                output: outputPrediction,
                energy: energyPrediction,
                status: status
            };
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                background: ${type === 'success' ? '#1a4d3a' : '#4d1a1a'};
                color: white;
                border-radius: 4px;
                border-left: 4px solid ${type === 'success' ? '#00ff88' : '#ff4444'};
                z-index: 10000;
                font-size: 14px;
                opacity: 0;
                transform: translateX(100%);
                transition: all 0.3s ease;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // æ˜¾ç¤ºåŠ¨ç”»
            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // è‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // ç¼©æ”¾åˆ°èŠ‚ç‚¹
        function zoomToNode(node) {
            if (currentView === '3d' && camera && controls) {
                // 3Dè§†å›¾ä¸­ç¼©æ”¾åˆ°å¯¹åº”è®¾å¤‡
                const targetPositions = {
                    'crusher-1': { x: -10, y: 2, z: -5 },
                    'ball-mill': { x: 0, y: 3, z: -5 },
                    'rotary-kiln': { x: 10, y: 2, z: 0 }
                };
                
                const target = targetPositions[node.id];
                if (target) {
                    // åŠ¨ç”»ç¼©æ”¾åˆ°ç›®æ ‡ä½ç½®
                    const duration = 1000;
                    const startPos = camera.position.clone();
                    const endPos = new THREE.Vector3(target.x + 10, target.y + 10, target.z + 10);
                    
                    const startTime = Date.now();
                    function animateZoom() {
                        const elapsed = Date.now() - startTime;
                        const progress = Math.min(elapsed / duration, 1);
                        
                        camera.position.lerpVectors(startPos, endPos, progress);
                        controls.target.set(target.x, target.y, target.z);
                        controls.update();
                        
                        if (progress < 1) {
                            requestAnimationFrame(animateZoom);
                        }
                    }
                    animateZoom();
                }
            }
        }

        // å¯¼èˆªåˆ°èŠ‚ç‚¹
        function navigateToNode(nodeId) {
            const nodeElement = document.querySelector(`[data-id="${nodeId}"]`);
            if (nodeElement) {
                nodeElement.click();
            }
        }

        // åº”ç”¨ç¼–è¾‘è®¾ç½®
        function applyEditSettings() {
            // æŒ‡æ ‡æ˜¾ç¤º/éšè—
            const metricItems = document.querySelectorAll('.metric-item');
            document.querySelectorAll('#edit-panel input[id^="metric-"]').forEach((checkbox, index) => {
                if (metricItems[index]) {
                    metricItems[index].style.display = checkbox.checked ? 'block' : 'none';
                }
            });
            
            // å¸ƒå±€ç»„ä»¶æ˜¾ç¤º/éšè—
            const sidebar = document.querySelector('.sidebar');
            const rightMetricsPanel = document.getElementById('right-metrics-panel');
            const breadcrumb = document.querySelector('.breadcrumb');
            
            if (document.getElementById('layout-sidebar').checked) {
                sidebar.style.display = 'block';
            } else {
                sidebar.style.display = 'none';
            }
            
            if (document.getElementById('layout-right-metrics').checked) {
                rightMetricsPanel.classList.remove('hidden');
                rightMetricsPanel.style.display = 'block';
            } else {
                rightMetricsPanel.classList.add('hidden');
                rightMetricsPanel.style.display = 'none';
            }
            
            if (document.getElementById('layout-breadcrumb').checked) {
                breadcrumb.style.display = 'block';
            } else {
                breadcrumb.style.display = 'none';
            }
        }

        // åŠ è½½å·¥å‚æ•°æ®
        function loadFactoryData() {
            // æ¨¡æ‹Ÿä»æœåŠ¡å™¨åŠ è½½æ•°æ®
            factoryData = {
                factory: {
                    name: 'æ°´æ³¥å·¥å‚',
                    status: 'running',
                    workshops: ['crushing', 'grinding', 'burning']
                }
            };
        }

        // å¼ºåˆ¶æ˜¾ç¤ºå·¦ä¾§æŒ‡æ ‡é¢æ¿çš„è°ƒè¯•å‡½æ•°
        function forceShowSidebar() {
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.style.cssText = `
                    width: 300px !important;
                    background: #2d2d2d !important;
                    border-right: 1px solid #444 !important;
                    overflow-y: auto !important;
                    position: relative !important;
                    z-index: 1001 !important;
                    display: block !important;
                    visibility: visible !important;
                    opacity: 1 !important;
                `;
                console.log('å¼ºåˆ¶æ˜¾ç¤ºå·¦ä¾§æŒ‡æ ‡é¢æ¿');
            } else {
                console.error('æ‰¾ä¸åˆ°å·¦ä¾§æŒ‡æ ‡é¢æ¿å…ƒç´ ');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            init();
            
            // å»¶è¿Ÿç¡®ä¿å·¦ä¾§æŒ‡æ ‡é¢æ¿å¯è§
            setTimeout(forceShowSidebar, 500);
            
            // å»¶è¿Ÿåˆå§‹åŒ–å·¥å…·æç¤ºï¼Œç¡®ä¿DOMå®Œå…¨åŠ è½½
            setTimeout(initIconButtonTooltips, 100);
            
            // æ·»åŠ è°ƒè¯•ä¿¡æ¯
            console.log('é¡µé¢åˆå§‹åŒ–å®Œæˆï¼Œå½“å‰æ¨¡å¼:', currentMode);
        });

        // å…¨å±€å‡½æ•°ï¼Œä¾›HTMLè°ƒç”¨
        window.goBackLevel = goBackLevel;
        window.navigateToBreadcrumbNode = navigateToBreadcrumbNode;
        window.navigateToAlarmDevice = navigateToAlarmDevice;
        window.handleAlarmAction = handleAlarmAction;
        window.clearAlarmFilter = clearAlarmFilter;
    </script>
</body>
</html> 