<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>水泥工厂数字孪生系统</title>
    <script src="https://unpkg.com/three@0.128.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <!--
    <script src="https://cdn.bootcdn.net/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/three.js/r128/controls/OrbitControls.js"></script>
    -->
    
    <!-- 备用CDN链接，如果上面的失败可以尝试下面的 -->
    <!--
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    
    或者使用UNPKG:
    <script src="https://unpkg.com/three@0.128.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: #1a1a1a;
            color: #fff;
            overflow: hidden;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .content-wrapper {
            display: flex;
            flex: 1;
        }

        /* 左侧指标面板 */
        .sidebar {
            width: 300px;
            background: #2d2d2d;
            border-right: 1px solid #444;
            overflow-y: auto;
            position: relative;
            z-index: 1001;
            padding: 20px;
        }

        .sidebar-header {
            padding: 0 0 20px 0;
            background: transparent;
            border-bottom: 1px solid #444;
            display: none;
        }

        /* 树形下拉框样式 */
        .tree-dropdown {
            position: relative;
            display: inline-block;
        }

        .tree-dropdown-button {
            padding: 8px 16px;
            background: #404040;
            border: 1px solid #666;
            color: #fff;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 200px;
            justify-content: space-between;
        }

        .tree-dropdown-button:hover {
            background: #505050;
        }

        .tree-dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: #2d2d2d;
            border: 1px solid #666;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            min-width: 280px;
            max-height: 400px;
            overflow-y: auto;
        }

        .tree-dropdown-content.show {
            display: block;
        }

        .tree-container {
            padding: 10px;
        }

        .tree-node {
            margin: 5px 0;
            cursor: pointer;
            user-select: none;
        }

        .tree-node-content {
            padding: 8px 12px;
            border-radius: 4px;
            transition: background 0.3s;
            position: relative;
        }

        .tree-node-content:hover {
            background: #404040;
        }

        .tree-node-content.active {
            background: #0078d4;
        }

        .tree-node-content.alarm-low {
            animation: blinkYellow 1s infinite;
        }

        .tree-node-content.alarm-medium {
            animation: blinkOrange 1s infinite;
        }

        .tree-node-content.alarm-high {
            animation: blinkRed 1s infinite;
        }

        .tree-node-icon {
            display: inline-block;
            width: 16px;
            margin-right: 8px;
        }

        /* 展开/折叠图标 */
        .tree-expand-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            margin-right: 4px;
            cursor: pointer;
            text-align: center;
            font-size: 12px;
            line-height: 16px;
            color: #999;
            transition: transform 0.2s, color 0.2s;
            user-select: none;
        }

        .tree-expand-icon:hover {
            color: #0078d4;
        }

        .tree-expand-icon.expanded {
            transform: rotate(90deg);
        }

        .tree-node-label {
            cursor: pointer;
            flex: 1;
        }

        .tree-node-content {
            display: flex;
            align-items: center;
        }

        .tree-children {
            margin-left: 20px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .tree-children.expanded {
            max-height: 1000px;
        }

        /* 主显示区域 */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* 顶部工具栏 */
        .toolbar {
            height: 60px;
            background: #333;
            border-bottom: 1px solid #444;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            gap: 20px;
            width: 100%;
            box-sizing: border-box;
        }

        .toolbar-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toolbar-center {
            display: flex;
            align-items: center;
            gap: 20px;
            flex: 1;
            justify-content: center;
        }

        .toolbar-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mode-selector, .view-selector {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            padding: 8px 16px;
            background: #404040;
            border: 1px solid #666;
            color: #fff;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #505050;
        }

        .btn.active {
            background: #0078d4;
        }

        /* 3D/2D显示区域 */
        .display-area {
            flex: 1;
            position: relative;
            background: #1a1a1a;
            min-height: 0;
        }

        #canvas-container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        #three-canvas {
            position: absolute;
            top: 0;
            left: 0;
        }

        #svg-canvas {
            position: absolute;
            top: 0;
            left: 0;
            display: none;
        }

        /* 信息悬浮框 */
        .info-tooltip {
            position: absolute;
            background: rgba(45, 45, 45, 0.98);
            color: white;
            padding: 0;
            border-radius: 8px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            border: 1px solid #666;
            max-width: 280px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px);
            display: none;
        }

        .tooltip-header {
            background: #0078d4;
            color: white;
            padding: 8px 12px;
            border-radius: 8px 8px 0 0;
            font-weight: bold;
            font-size: 13px;
        }

        .tooltip-section {
            padding: 8px 12px;
            border-bottom: 1px solid #555;
        }

        .tooltip-section:last-child {
            border-bottom: none;
        }

        .tooltip-label {
            font-weight: bold;
            color: #ccc;
            margin-bottom: 4px;
            font-size: 11px;
            text-transform: uppercase;
        }

        .tooltip-metric {
            margin: 2px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tooltip-metric .metric-value {
            color: #0078d4;
            font-weight: bold;
        }

        .tooltip-status {
            padding: 6px 12px;
            font-weight: bold;
            text-align: center;
            border-radius: 0 0 8px 8px;
        }

        .tooltip-status.正常 {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }

        .tooltip-status.告警 {
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
        }

        .tooltip-note {
            padding: 6px 12px;
            background: rgba(0, 120, 212, 0.1);
            color: #87ceeb;
            font-size: 11px;
            border-radius: 0 0 8px 8px;
        }

        .tooltip-trend {
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0 0 8px 8px;
        }

        .trend-indicators {
            display: flex;
            gap: 8px;
            margin-top: 4px;
        }

        .trend-up {
            color: #ff6b6b;
        }

        .trend-stable {
            color: #ffd93d;
        }

        .trend-down {
            color: #6bcf7f;
        }

        .prediction-indicator {
            font-size: 10px;
            margin-left: 4px;
        }

        /* 右侧指标面板 */
        .right-metrics-panel {
            width: 300px;
            background: #2d2d2d;
            border-left: 1px solid #444;
            padding: 20px;
            overflow-y: auto;
            position: relative;
            z-index: 1001;
        }

        .right-metrics-panel.hidden {
            display: none;
        }

        /* 指标项样式 */
        .metric-item {
            margin-bottom: 15px;
            padding: 10px;
            background: #3d3d3d;
            border-radius: 4px;
        }

        .metric-label {
            font-size: 12px;
            color: #ccc;
            margin-bottom: 5px;
        }

        .metric-value {
            font-size: 18px;
            font-weight: bold;
            color: #0078d4;
        }

        /* 异常指标样式 */
        .metric-value.abnormal {
            color: #ff4444 !important;
            animation: metricBlink 1.5s infinite;
        }

        @keyframes metricBlink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.6; }
        }

        .metric-unit {
            font-size: 12px;
            color: #999;
            margin-left: 5px;
        }

        /* 编辑模式面板 */
        .edit-panel {
            position: fixed;
            top: 60px;
            right: 0;
            width: 350px;
            height: calc(100vh - 60px);
            background: #2d2d2d;
            border-left: 1px solid #444;
            padding: 20px;
            overflow-y: auto;
            transform: translateX(100%);
            transition: transform 0.3s;
            z-index: 1001;
        }

        .edit-panel.visible {
            transform: translateX(0);
        }

        /* 模式控制面板 */
        .mode-control-panel {
            position: fixed;
            top: 60px;
            left: 300px;
            width: 350px;
            height: calc(100vh - 60px);
            background: #2d2d2d;
            border-right: 1px solid #444;
            padding: 20px;
            overflow-y: auto;
            transform: translateX(-100%);
            transition: transform 0.3s;
            z-index: 999;
            display: none;
        }

        .mode-control-panel.visible {
            transform: translateX(0);
            display: block;
        }

        .time-selector {
            margin-bottom: 20px;
        }

        .time-selector label {
            display: block;
            margin-bottom: 5px;
            color: #ccc;
        }

        .time-selector input, .time-selector select {
            width: 100%;
            padding: 8px;
            background: #404040;
            border: 1px solid #666;
            color: #fff;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .simulation-controls {
            margin-top: 20px;
        }

        .parameter-control {
            margin-bottom: 15px;
        }

        .parameter-control label {
            display: block;
            margin-bottom: 5px;
            color: #ccc;
            font-size: 12px;
        }

        .parameter-slider {
            width: 100%;
            margin-bottom: 5px;
        }

        .parameter-value {
            color: #0078d4;
            font-weight: bold;
        }

        .prediction-info {
            background: #1a4d3a;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            border-left: 4px solid #00ff88;
        }

        .history-info {
            background: #3d2a1a;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            border-left: 4px solid #ff8800;
        }

        .checkbox-group {
            margin-bottom: 20px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .checkbox-item input {
            margin-right: 10px;
        }

        /* 告警动画 */
        @keyframes blinkYellow {
            0%, 50% { background-color: rgba(255, 255, 0, 0.3); }
            51%, 100% { background-color: transparent; }
        }

        @keyframes blinkOrange {
            0%, 50% { background-color: rgba(255, 165, 0, 0.3); }
            51%, 100% { background-color: transparent; }
        }

        @keyframes blinkRed {
            0%, 50% { background-color: rgba(255, 0, 0, 0.3); }
            51%, 100% { background-color: transparent; }
        }

        /* 面包屑导航 */
        .breadcrumb {
            padding: 0px 20px;
            background: #3d3d3d;
            border-bottom: 1px solid #444;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .breadcrumb-content {
            display: flex;
            align-items: center;
        }

        .breadcrumb-item {
            color: #0078d4;
            cursor: pointer;
        }

        .breadcrumb-item:hover {
            text-decoration: underline;
        }

        .breadcrumb-separator {
            margin: 0 8px;
            color: #666;
        }

        /* 控制按钮组 */
        .control-buttons {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-left: 10px;
        }

        /* 扁平化图标按钮 */
        .icon-button {
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 18px;
            padding: 8px;
            border-radius: 4px;
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 36px;
            min-height: 36px;
        }

        /* 重置按钮特殊样式 */
        #reset-view-btn {
            transition: all 0.3s ease, transform 0.5s ease;
        }

        .icon-button:hover {
            background: #404040;
            color: #0078d4;
            transform: translateY(-1px);
        }

        .icon-button.active {
            color: #ff6600;
            background: rgba(255, 102, 0, 0.1);
        }

        /* 全局工具提示 */
        .global-tooltip {
            position: fixed;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            z-index: 10000;
            pointer-events: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transform: translateX(-50%);
        }

        .global-tooltip.show {
            opacity: 1;
            visibility: visible;
        }

        /* 优化图标显示 */
        #reset-view-btn {
            font-weight: bold;
        }

        #expand-toggle {
            font-size: 16px;
        }

        #edit-toggle {
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #edit-toggle.active {
            background: rgba(255, 102, 0, 0.2);
        }

        /* 扁平化编辑图标 */
        .flat-edit-icon {
            width: 16px;
            height: 16px;
            position: relative;
            transform: rotate(0deg);
            transition: transform 0.3s ease;
        }

        .edit-icon-inner {
            width: 16px;
            height: 16px;
            border: 2px solid #888;
            border-radius: 50%;
            position: relative;
            box-sizing: border-box;
        }

        .edit-icon-inner::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 2px;
            height: 8px;
            background: #888;
            transform: translate(-50%, -50%);
        }

        .edit-icon-inner::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 8px;
            height: 2px;
            background: #888;
            transform: translate(-50%, -50%);
        }

        #edit-toggle:hover .flat-edit-icon {
            transform: rotate(90deg);
        }

        #edit-toggle.active .flat-edit-icon {
            transform: rotate(180deg);
        }

        #edit-toggle:hover .edit-icon-inner,
        #edit-toggle:hover .edit-icon-inner::before,
        #edit-toggle:hover .edit-icon-inner::after {
            border-color: #0078d4;
            background: #0078d4;
        }

        #edit-toggle.active .edit-icon-inner,
        #edit-toggle.active .edit-icon-inner::before,
        #edit-toggle.active .edit-icon-inner::after {
            border-color: #ff6600;
            background: #ff6600;
        }

        /* 告警按钮样式 */
        #alarm-toggle {
            position: relative;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #alarm-toggle:hover .flat-alarm-icon {
            border-bottom-color: #ff8833;
        }

        #alarm-toggle:hover .flat-alarm-icon::after {
            color: #fff;
        }

        /* 扁平化告警图标 */
        .flat-alarm-icon {
            width: 0;
            height: 0;
            border-left: 9px solid transparent;
            border-right: 9px solid transparent;
            border-bottom: 16px solid #ff6600;
            position: relative;
            animation: pulse 2s infinite;
            transition: all 0.3s ease;
        }

        .flat-alarm-icon::after {
            content: '!';
            position: absolute;
            top: 4px;
            left: -3.5px;
            color: #fff;
            font-size: 11px;
            font-weight: bold;
            text-align: center;
            width: 7px;
        }

        .alarm-count {
            position: absolute;
            top: -6px;
            right: -6px;
            background: #ff4444;
            color: white;
            border-radius: 10px;
            width: 18px;
            height: 18px;
            font-size: 10px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 18px;
            border: 2px solid #333;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            z-index: 1;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* 告警弹框 */
        .alarm-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10001;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(2px);
        }

        .alarm-modal.show {
            display: flex;
        }

        .alarm-content {
            background: #2d2d2d;
            border-radius: 8px;
            width: 500px;
            max-height: 600px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .alarm-header {
            background: #333;
            padding: 15px 20px;
            border-bottom: 1px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .alarm-header h3 {
            color: #fff;
            margin: 0;
            font-size: 16px;
        }

        .alarm-close {
            background: none;
            border: none;
            color: #888;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 3px;
            transition: all 0.3s;
        }

        .alarm-close:hover {
            background: #404040;
            color: #fff;
        }

        .alarm-stats {
            padding: 15px 20px;
            background: #353535;
            display: flex;
            gap: 15px;
        }

        .alarm-stat {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .alarm-stat:hover {
            background: #404040;
            transform: translateY(-1px);
        }

        .alarm-stat.active {
            background: #505050;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .alarm-stat-icon {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .alarm-stat-high .alarm-stat-icon {
            background: #ff4444;
        }

        .alarm-stat-medium .alarm-stat-icon {
            background: #ff8800;
        }

        .alarm-stat-low .alarm-stat-icon {
            background: #ffdd00;
        }

        .alarm-stat-text {
            color: #ccc;
            margin-right: 8px;
        }

        .alarm-stat-badge {
            background: #666;
            color: white;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 12px;
            font-weight: bold;
            min-width: 20px;
            text-align: center;
        }

        .alarm-stat-high .alarm-stat-badge {
            background: #ff4444;
        }

        .alarm-stat-medium .alarm-stat-badge {
            background: #ff8800;
        }

        .alarm-stat-low .alarm-stat-badge {
            background: #ffdd00;
            color: #333;
        }

        .alarm-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .alarm-item {
            padding: 15px 20px;
            border-bottom: 1px solid #444;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .alarm-item:hover {
            background: #353535;
        }

        .alarm-item:last-child {
            border-bottom: none;
        }

        .alarm-item-level {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .alarm-item-level.high {
            background: #ff4444;
        }

        .alarm-item-level.medium {
            background: #ff8800;
        }

        .alarm-item-level.low {
            background: #ffdd00;
        }

        .alarm-item-content {
            flex: 1;
            cursor: pointer;
        }

        .alarm-item-title {
            color: #fff;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 2px;
        }

        .alarm-item-desc {
            color: #ccc;
            font-size: 12px;
        }

        .alarm-item-time {
            color: #888;
            font-size: 11px;
            flex-shrink: 0;
            margin-right: 12px;
        }

        /* 告警操作按钮 */
        .alarm-actions {
            display: flex;
            gap: 6px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .alarm-item:hover .alarm-actions {
            opacity: 1;
        }

        .alarm-action-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            font-weight: 500;
        }

        .alarm-action-handle {
            background: #28a745;
        }

        .alarm-action-handle:hover {
            background: #218838;
        }

        .alarm-action-forward {
            background: #007bff;
        }

        .alarm-action-forward:hover {
            background: #0056b3;
        }

        .alarm-action-ignore {
            background: #6c757d;
        }

        .alarm-action-ignore:hover {
            background: #545b62;
        }

        /* 过滤提示 */
        .alarm-filter-tip {
            padding: 8px 20px;
            background: #404040;
            color: #ccc;
            font-size: 12px;
            border-bottom: 1px solid #444;
            display: none;
        }

        .alarm-filter-tip.show {
            display: block;
        }

        .alarm-filter-clear {
            color: #0078d4;
            cursor: pointer;
            text-decoration: underline;
            margin-left: 8px;
        }

        .alarm-filter-clear:hover {
            color: #40a0e6;
        }

        /* 可点击元素样式 */
        .equipment, .component, .workshop-area {
            cursor: pointer;
            transition: opacity 0.3s, transform 0.2s;
        }

        .equipment:hover, .component:hover, .workshop-area:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }

        .back-button {
            cursor: pointer;
            transition: transform 0.2s;
        }

        .back-button:hover {
            transform: scale(1.1);
        }

        /* 3D场景中可点击提示 */
        #canvas-container {
            cursor: pointer;
        }

        /* 下钻层级指示 */
        .drill-level-indicator {
            position: absolute;
            top: 10px;
            right: 20px;
            background: rgba(0, 120, 212, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            z-index: 1000;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 顶部工具栏 - 占满浏览器宽度 -->
        <div class="toolbar">
            <!-- 左侧：资产层级下拉选择器 -->
            <div class="toolbar-left">
                <div class="tree-dropdown">
                    <div class="tree-dropdown-button" id="tree-dropdown-btn">
                        <span id="selected-asset">水泥工厂</span>
                        <span>▼</span>
                    </div>
                    <div class="tree-dropdown-content" id="tree-dropdown-content">
                        <div class="tree-container">
                            <div class="tree-node">
                                <div class="tree-node-content" data-level="factory" data-id="cement-factory">
                                    <span class="tree-expand-icon expanded">▶</span>
                                    <span class="tree-node-icon">🏭</span>
                                    <span class="tree-node-label">水泥工厂</span>
                                </div>
                                <div class="tree-children expanded">
                                    <div class="tree-node">
                                        <div class="tree-node-content alarm-medium" data-level="workshop" data-id="crushing-workshop">
                                            <span class="tree-expand-icon expanded">▶</span>
                                            <span class="tree-node-icon">🔨</span>
                                            <span class="tree-node-label">破碎工段</span>
                                        </div>
                                        <div class="tree-children expanded">
                                            <div class="tree-node">
                                                <div class="tree-node-content" data-level="equipment" data-id="crusher-1">
                                                    <span class="tree-expand-icon expanded">▶</span>
                                                    <span class="tree-node-icon">⚙️</span>
                                                    <span class="tree-node-label">颚式破碎机</span>
                                                </div>
                                                <div class="tree-children expanded">
                                                    <div class="tree-node">
                                                        <div class="tree-node-content alarm-high" data-level="component" data-id="crusher-motor">
                                                            <span class="tree-expand-icon" style="visibility: hidden;">▶</span>
                                                            <span class="tree-node-icon">🔧</span>
                                                            <span class="tree-node-label">电机</span>
                                                        </div>
                                                    </div>
                                                    <div class="tree-node">
                                                        <div class="tree-node-content" data-level="component" data-id="crusher-bearing">
                                                            <span class="tree-expand-icon" style="visibility: hidden;">▶</span>
                                                            <span class="tree-node-icon">🔧</span>
                                                            <span class="tree-node-label">轴承</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="tree-node">
                                                <div class="tree-node-content" data-level="equipment" data-id="conveyor-1">
                                                    <span class="tree-expand-icon" style="visibility: hidden;">▶</span>
                                                    <span class="tree-node-icon">⚙️</span>
                                                    <span class="tree-node-label">皮带输送机</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="tree-node">
                                        <div class="tree-node-content" data-level="workshop" data-id="grinding-workshop">
                                            <span class="tree-expand-icon expanded">▶</span>
                                            <span class="tree-node-icon">🌪️</span>
                                            <span class="tree-node-label">粉磨工段</span>
                                        </div>
                                        <div class="tree-children expanded">
                                            <div class="tree-node">
                                                <div class="tree-node-content alarm-low" data-level="equipment" data-id="ball-mill">
                                                    <span class="tree-expand-icon expanded">▶</span>
                                                    <span class="tree-node-icon">⚙️</span>
                                                    <span class="tree-node-label">球磨机</span>
                                                </div>
                                                <div class="tree-children expanded">
                                                    <div class="tree-node">
                                                        <div class="tree-node-content" data-level="component" data-id="mill-motor">
                                                            <span class="tree-expand-icon" style="visibility: hidden;">▶</span>
                                                            <span class="tree-node-icon">🔧</span>
                                                            <span class="tree-node-label">主电机</span>
                                                        </div>
                                                    </div>
                                                    <div class="tree-node">
                                                        <div class="tree-node-content" data-level="component" data-id="mill-gearbox">
                                                            <span class="tree-expand-icon" style="visibility: hidden;">▶</span>
                                                            <span class="tree-node-icon">🔧</span>
                                                            <span class="tree-node-label">减速器</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="tree-node">
                                                <div class="tree-node-content" data-level="equipment" data-id="separator">
                                                    <span class="tree-expand-icon" style="visibility: hidden;">▶</span>
                                                    <span class="tree-node-icon">⚙️</span>
                                                    <span class="tree-node-label">选粉机</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="tree-node">
                                        <div class="tree-node-content" data-level="workshop" data-id="burning-workshop">
                                            <span class="tree-expand-icon expanded">▶</span>
                                            <span class="tree-node-icon">🔥</span>
                                            <span class="tree-node-label">煅烧工段</span>
                                        </div>
                                        <div class="tree-children expanded">
                                            <div class="tree-node">
                                                <div class="tree-node-content" data-level="equipment" data-id="rotary-kiln">
                                                    <span class="tree-expand-icon expanded">▶</span>
                                                    <span class="tree-node-icon">⚙️</span>
                                                    <span class="tree-node-label">回转窑</span>
                                                </div>
                                                <div class="tree-children expanded">
                                                    <div class="tree-node">
                                                        <div class="tree-node-content" data-level="component" data-id="kiln-burner">
                                                            <span class="tree-expand-icon" style="visibility: hidden;">▶</span>
                                                            <span class="tree-node-icon">🔧</span>
                                                            <span class="tree-node-label">燃烧器</span>
                                                        </div>
                                                    </div>
                                                    <div class="tree-node">
                                                        <div class="tree-node-content" data-level="component" data-id="kiln-cylinder">
                                                            <span class="tree-expand-icon" style="visibility: hidden;">▶</span>
                                                            <span class="tree-node-icon">🔧</span>
                                                            <span class="tree-node-label">窑筒体</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 中间：模式和视图选择器 -->
            <div class="toolbar-center">
                <div class="mode-selector">
                    <label>运行模式：</label>
                    <button class="btn active" data-mode="realtime">实时监控</button>
                    <button class="btn" data-mode="history">历史回看</button>
                    <button class="btn" data-mode="simulation">模拟推演</button>
                </div>
                
                <div class="view-selector">
                    <label>视图模式：</label>
                    <button class="btn active" data-view="3d">三维视图</button>
                    <button class="btn" data-view="2d">平面视图</button>
                </div>
            </div>
            
            <!-- 右侧：告警和编辑模式 -->
            <div class="toolbar-right">
                <button class="icon-button" id="alarm-toggle" data-tooltip="告警列表">
                    <div class="flat-alarm-icon"></div>
                    <span class="alarm-count" id="alarm-count">3</span>
                </button>
                <button class="icon-button" id="edit-toggle" data-tooltip="视图编辑">
                    <div class="flat-edit-icon">
                        <div class="edit-icon-inner"></div>
                    </div>
                </button>
            </div>
        </div>

        <!-- 内容区域包装器 -->
        <div class="content-wrapper">
            <!-- 左侧指标面板 -->
            <div class="sidebar" id="metrics-panel">
                <div class="sidebar-header">
                    <h3>实时指标</h3>
                </div>
                <div class="metric-item">
                    <div class="metric-label">生产效率</div>
                    <div class="metric-value">85.6<span class="metric-unit">%</span></div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">设备运行率</div>
                    <div class="metric-value">92.3<span class="metric-unit">%</span></div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">能耗指标</div>
                    <div class="metric-value">245.8<span class="metric-unit">kWh/t</span></div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">温度</div>
                    <div class="metric-value">1450<span class="metric-unit">℃</span></div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">压力</div>
                    <div class="metric-value">2.5<span class="metric-unit">MPa</span></div>
                </div>
            </div>

            <!-- 主内容区域 -->
            <div class="main-content">

            <!-- 面包屑导航 -->
            <div class="breadcrumb">
                <div class="breadcrumb-content">
                    <span class="breadcrumb-item" data-id="cement-factory">水泥工厂</span>
                </div>
                <div class="control-buttons">
                    <button class="icon-button" id="reset-view-btn" data-tooltip="重置视角" onclick="resetCameraView()">
                        ↻
                    </button>
                    <button class="icon-button" id="expand-toggle" data-tooltip="全屏视图">
                        ⤢
                    </button>
                </div>
            </div>

            <!-- 下钻层级指示器 -->
            <div class="drill-level-indicator" id="drill-indicator">
                工厂总览
            </div>

            <!-- 显示区域 -->
            <div class="display-area">
                <div id="canvas-container">
                    <canvas id="three-canvas"></canvas>
                    <svg id="svg-canvas" width="100%" height="100%"></svg>
                </div>
                
                <!-- 信息悬浮框 -->
                <div class="info-tooltip" id="tooltip">
                    <div class="tooltip-content"></div>
                </div>
                
                <!-- 全局工具提示 -->
                <div class="global-tooltip" id="global-tooltip"></div>
            </div>
                </div>

        <!-- 告警弹框 -->
        <div class="alarm-modal" id="alarm-modal">
            <div class="alarm-content">
                <div class="alarm-header">
                    <h3>系统告警</h3>
                    <button class="alarm-close" id="alarm-close">×</button>
                </div>
                <div class="alarm-stats">
                    <div class="alarm-stat alarm-stat-high" data-filter="high">
                        <div class="alarm-stat-icon"></div>
                        <span class="alarm-stat-text">高级告警</span>
                        <span class="alarm-stat-badge" id="high-alarm-count">1</span>
                    </div>
                    <div class="alarm-stat alarm-stat-medium" data-filter="medium">
                        <div class="alarm-stat-icon"></div>
                        <span class="alarm-stat-text">中级告警</span>
                        <span class="alarm-stat-badge" id="medium-alarm-count">1</span>
                    </div>
                    <div class="alarm-stat alarm-stat-low" data-filter="low">
                        <div class="alarm-stat-icon"></div>
                        <span class="alarm-stat-text">低级告警</span>
                        <span class="alarm-stat-badge" id="low-alarm-count">1</span>
                    </div>
                </div>
                <div class="alarm-filter-tip" id="alarm-filter-tip">
                    正在显示：<span id="filter-text">所有告警</span>
                    <span class="alarm-filter-clear" onclick="clearAlarmFilter()">显示全部</span>
                </div>
                <div class="alarm-list" id="alarm-list">
                    <!-- 告警项将通过JavaScript动态生成 -->
                </div>
            </div>
        </div>

            <!-- 右侧指标面板 -->
            <div class="right-metrics-panel" id="right-metrics-panel">
                <div class="sidebar-header">
                    <h3>系统概览</h3>
                </div>
                <div class="metric-item">
                    <div class="metric-label">整体生产效率</div>
                    <div class="metric-value">85.6<span class="metric-unit">%</span></div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">设备总运行率</div>
                    <div class="metric-value">92.3<span class="metric-unit">%</span></div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">平均能耗</div>
                    <div class="metric-value">245.8<span class="metric-unit">kWh/t</span></div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">今日产量</div>
                    <div class="metric-value">2,340<span class="metric-unit">t</span></div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">告警数量</div>
                    <div class="metric-value">3<span class="metric-unit">项</span></div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">在线设备</div>
                    <div class="metric-value">24/26<span class="metric-unit">台</span></div>
                </div>
            </div>
        </div>

                <!-- 模式控制面板 -->
        <div class="mode-control-panel" id="mode-control-panel">
            <h3 id="mode-panel-title">实时监控</h3>
            
            <!-- 历史回看控制 -->
            <div id="history-controls" style="display: none;">
                <div class="time-selector">
                    <label for="history-date">选择日期:</label>
                    <input type="date" id="history-date" value="2024-01-15">
                    
                    <label for="history-time-start">开始时间:</label>
                    <input type="time" id="history-time-start" value="08:00">
                    
                    <label for="history-time-end">结束时间:</label>
                    <input type="time" id="history-time-end" value="18:00">
                    
                    <button class="btn" onclick="loadHistoryData()">加载历史数据</button>
                </div>
                
                <div class="history-info">
                    <h4>历史数据信息</h4>
                    <p>显示时间段: <span id="history-time-range">--</span></p>
                    <p>数据点数量: <span id="history-data-points">--</span></p>
                </div>
            </div>
            
            <!-- 模拟推演控制 -->
            <div id="simulation-controls" style="display: none;">
                <div class="time-selector">
                    <label for="sim-base-date">基础数据时间:</label>
                    <input type="date" id="sim-base-date" value="2024-01-15">
                    <input type="time" id="sim-base-time" value="14:00">
                    
                    <label for="sim-target-time">预测到时间:</label>
                    <select id="sim-target-time">
                        <option value="1">1小时后</option>
                        <option value="4">4小时后</option>
                        <option value="8">8小时后</option>
                        <option value="24">24小时后</option>
                    </select>
                </div>
                
                <div class="simulation-controls">
                    <h4>调整参数</h4>
                    
                    <div class="parameter-control">
                        <label>生产负荷调整: <span class="parameter-value" id="load-value">100%</span></label>
                        <input type="range" class="parameter-slider" id="load-slider" min="50" max="150" value="100">
                    </div>
                    
                    <div class="parameter-control">
                        <label>原料质量系数: <span class="parameter-value" id="quality-value">1.0</span></label>
                        <input type="range" class="parameter-slider" id="quality-slider" min="0.8" max="1.2" step="0.1" value="1.0">
                    </div>
                    
                    <div class="parameter-control">
                        <label>设备效率系数: <span class="parameter-value" id="efficiency-value">100%</span></label>
                        <input type="range" class="parameter-slider" id="efficiency-slider" min="80" max="120" value="100">
                    </div>
                    
                    <button class="btn" onclick="runSimulation()">开始模拟推演</button>
                </div>
                
                <div class="prediction-info">
                    <h4>预测结果</h4>
                    <p>预测产量: <span id="predicted-output">--</span> t/h</p>
                    <p>能耗预测: <span id="predicted-energy">--</span> kWh/t</p>
                    <p>设备状态: <span id="predicted-status">--</span></p>
                </div>
            </div>
        </div>

        <!-- 编辑模式面板 -->
        <div class="edit-panel" id="edit-panel">
            <h3>编辑设置</h3>
            
            <div class="checkbox-group">
                <h4>显示指标</h4>
                <div class="checkbox-item">
                    <input type="checkbox" id="metric-efficiency" checked>
                    <label for="metric-efficiency">生产效率</label>
                        </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="metric-runtime" checked>
                    <label for="metric-runtime">设备运行率</label>
                        </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="metric-energy" checked>
                    <label for="metric-energy">能耗指标</label>
                        </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="metric-temperature" checked>
                    <label for="metric-temperature">温度</label>
                    </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="metric-pressure" checked>
                    <label for="metric-pressure">压力</label>
                </div>
            </div>

            <div class="checkbox-group">
                <h4>页面布局</h4>
                <div class="checkbox-item">
                    <input type="checkbox" id="layout-sidebar" checked>
                    <label for="layout-sidebar">左侧指标面板</label>
                    </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="layout-right-metrics" checked>
                    <label for="layout-right-metrics">右侧指标面板</label>
                    </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="layout-breadcrumb" checked>
                    <label for="layout-breadcrumb">面包屑导航</label>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let scene, camera, renderer, controls;
        let currentView = '3d';
        let currentMode = 'realtime';
        let editMode = false;
        let selectedNode = null;
        let factoryData = {};
        let historyData = {};
        let simulationParams = {
            loadFactor: 1.0,
            qualityFactor: 1.0,
            efficiencyFactor: 1.0
        };
        let realTimeInterval = null;
        let isDataLoading = false;
        let currentDrillLevel = 'factory'; // 当前下钻层级
        let drillPath = []; // 下钻路径

        // 告警数据
        let alarmData = [
            {
                id: 'alarm-001',
                level: 'high',
                deviceId: 'crusher-motor',
                deviceName: '颚式破碎机电机',
                title: '电机温度过高',
                description: '电机温度达到95℃，超过安全阈值',
                time: '10:25',
                timestamp: Date.now() - 1000 * 60 * 35,
                status: 'active'
            },
            {
                id: 'alarm-002', 
                level: 'medium',
                deviceId: 'crushing-workshop',
                deviceName: '破碎工段',
                title: '振动异常',
                description: '检测到异常振动模式，建议检查设备',
                time: '09:45',
                timestamp: Date.now() - 1000 * 60 * 75,
                status: 'active'
            },
            {
                id: 'alarm-003',
                level: 'low',
                deviceId: 'ball-mill',
                deviceName: '球磨机',
                title: '效率下降',
                description: '生产效率较昨日下降5%，请关注',
                time: '09:12',
                timestamp: Date.now() - 1000 * 60 * 108,
                status: 'active'
            }
        ];

        // 告警过滤状态
        let currentAlarmFilter = null;

        // 初始化应用
        function init() {
            initTreeDropdown();
            init3DView();
            init2DView();
            initEventListeners();
            loadFactoryData();
            
            // 确保左侧指标面板始终可见
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.style.display = 'block';
                sidebar.style.visibility = 'visible';
            }
            
            // 确保侧边栏复选框选中
            const sidebarCheckbox = document.getElementById('layout-sidebar');
            if (sidebarCheckbox) {
                sidebarCheckbox.checked = true;
            }
            
            // 启动实时模式
            switchMode('realtime');
            
            // 设置默认选中节点
            selectedNode = { 
                id: 'cement-factory', 
                level: 'factory', 
                name: '水泥工厂' 
            };
            
            // 设置默认active状态
            const defaultNode = document.querySelector('[data-id="cement-factory"]');
            if (defaultNode) {
                defaultNode.classList.add('active');
            }
            
            updateBreadcrumb();
            updateMetricsForNode('cement-factory');
            
            // 初始化右侧指标面板
            updateRightMetricsPanel();
            
            // 初始化控制按钮状态
            const expandButton = document.getElementById('expand-toggle');
            if (expandButton) {
                expandButton.textContent = '⤢';
                expandButton.setAttribute('data-tooltip', '全屏视图');
            }
            
            // 初始化告警显示
            updateAlarmDisplay();
            
            // 页面初始化时使用重置视角
            setTimeout(() => {
                if (camera && controls) {
                    // 调用重置视角功能，设置到最佳观看角度
                    resetCameraView();
                }
            }, 500);
        }

        // 初始化树形下拉框
        function initTreeDropdown() {
            const dropdownBtn = document.getElementById('tree-dropdown-btn');
            const dropdownContent = document.getElementById('tree-dropdown-content');
            const selectedAssetSpan = document.getElementById('selected-asset');
            
            // 下拉框开关事件
            dropdownBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                dropdownContent.classList.toggle('show');
            });
            
            // 点击外部关闭下拉框
            document.addEventListener('click', function() {
                dropdownContent.classList.remove('show');
            });
            
            // 阻止下拉框内部点击关闭
            dropdownContent.addEventListener('click', function(e) {
                e.stopPropagation();
            });
            
            // 初始化树形结构
            initTreeView();
        }

        // 初始化树形视图
        function initTreeView() {
            const treeNodes = document.querySelectorAll('.tree-node-content');
            
            treeNodes.forEach(node => {
                // 展开/折叠图标点击事件
                const expandIcon = node.querySelector('.tree-expand-icon');
                if (expandIcon && expandIcon.style.visibility !== 'hidden') {
                    expandIcon.addEventListener('click', function(e) {
                        e.stopPropagation();
                        
                        // 切换展开状态
                        const parent = node.parentElement;
                        const children = parent.querySelector('.tree-children');
                        if (children) {
                            children.classList.toggle('expanded');
                            this.classList.toggle('expanded');
                        }
                    });
                }
                
                // 节点名称点击事件
                const nodeLabel = node.querySelector('.tree-node-label');
                if (nodeLabel) {
                    nodeLabel.addEventListener('click', function(e) {
                        e.stopPropagation();
                        
                        // 使用统一的节点切换函数
                        switchToNode(node.dataset.id, 'tree_click');
                    });
                }
            });
        }

        // 初始化3D视图
        function init3DView() {
            const container = document.getElementById('canvas-container');
            const canvas = document.getElementById('three-canvas');
            
            // 创建场景
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a1a);
            
            // 创建相机
            camera = new THREE.PerspectiveCamera(75, container.offsetWidth / container.offsetHeight, 0.1, 1000);
            camera.position.set(0, 25, 30); // 调整到更好的俯视角度
            
            // 创建渲染器
            renderer = new THREE.WebGLRenderer({ canvas: canvas });
            renderer.setSize(container.offsetWidth, container.offsetHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            
            // 创建控制器
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.1;
            controls.target.set(0, 0, -10); // 聚焦在工段区域中心
            controls.maxPolarAngle = Math.PI * 0.8; // 限制垂直旋转角度
            controls.minDistance = 10; // 最小缩放距离
            controls.maxDistance = 100; // 最大缩放距离
            
            // 添加光源
            const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(50, 50, 50);
            directionalLight.castShadow = true;
            scene.add(directionalLight);
            
            // 创建工厂模型
            createFactoryModel();
            
            // 应用告警效果
            setTimeout(() => {
                saveOriginalColors();
                apply3DAlarmEffects();
                addEquipmentAnimations();
            }, 100);
            
            // 鼠标事件
            const raycaster = new THREE.Raycaster();
            const mouse = new THREE.Vector2();
            
            // 鼠标移动事件（工具提示）
            canvas.addEventListener('mousemove', function(event) {
                const rect = canvas.getBoundingClientRect();
                mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
                mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
                
                raycaster.setFromCamera(mouse, camera);
                const intersects = raycaster.intersectObjects(scene.children, true);
                
                if (intersects.length > 0) {
                    const object = intersects[0].object;
                    showTooltip(event, object.userData);
                } else {
                    hideTooltip();
                }
            });

            // 鼠标点击事件（下钻）
            canvas.addEventListener('click', function(event) {
                const rect = canvas.getBoundingClientRect();
                mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
                mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
                
                raycaster.setFromCamera(mouse, camera);
                const intersects = raycaster.intersectObjects(scene.children, true);
                
                if (intersects.length > 0) {
                    const object = intersects[0].object;
                    if (object.userData && object.userData.id) {
                        // 使用统一的节点切换函数
                        switchToNode(object.userData.id, '3d_click');
                    }
                }
            });
            
            // 渲染循环
            let lastTime = 0;
            function animate(currentTime) {
                requestAnimationFrame(animate);
                
                const deltaTime = (currentTime - lastTime) * 0.001; // 转换为秒
                lastTime = currentTime;
                
                // 更新控制器
                controls.update();
                
                // 更新告警闪烁效果
                updateBlinkingEffects();
                
                // 更新设备动画
                updateEquipmentAnimations(deltaTime);
                
                // 渲染场景
                renderer.render(scene, camera);
            }
            animate();
            
            // 窗口大小调整
            window.addEventListener('resize', function() {
                const width = container.offsetWidth;
                const height = container.offsetHeight;
                
                camera.aspect = width / height;
                camera.updateProjectionMatrix();
                renderer.setSize(width, height);
            });
        }

        // 初始化2D视图
        function init2DView() {
            const svg = document.getElementById('svg-canvas');
            
            // 创建2D工厂布局
            const factoryLayout = `
                <defs>
                    <!-- 箭头标记定义 -->
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                            refX="9" refY="3.5" orient="auto" markerUnits="strokeWidth">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#00ff88" />
                    </marker>
                    
                    <!-- 流动动画定义 -->
                    <marker id="flow-dot" markerWidth="8" markerHeight="8" 
                            refX="4" refY="4" markerUnits="strokeWidth">
                        <circle cx="4" cy="4" r="3" fill="#00ff88" opacity="0.8">
                            <animate attributeName="opacity" values="0.3;1;0.3" dur="2s" repeatCount="indefinite"/>
                        </circle>
                    </marker>
                </defs>
                
                <g transform="translate(50, 50)">
                    <rect x="0" y="0" width="800" height="600" fill="#333" stroke="#666" stroke-width="2"/>
                    <text x="400" y="30" text-anchor="middle" fill="#fff" font-size="20">水泥工厂平面图</text>
                    
                    <!-- 原料区域 -->
                    <g class="material-area">
                        <rect x="20" y="280" width="80" height="120" fill="#555" stroke="#888" stroke-width="1" stroke-dasharray="5,5"/>
                        <text x="60" y="330" text-anchor="middle" fill="#ccc" font-size="12">原料区</text>
                        <circle cx="60" cy="350" r="8" fill="#8b4513"/>
                        <text x="60" y="365" text-anchor="middle" fill="#ccc" font-size="8">石灰石</text>
                    </g>
                    
                    <!-- 破碎工段 -->
                    <g class="workshop-area" data-id="crushing-workshop">
                        <rect x="130" y="80" width="180" height="150" fill="#554400" stroke="#ffaa00" stroke-width="3"/>
                        <text x="220" y="105" text-anchor="middle" fill="#fff" font-weight="bold">破碎工段</text>
                        
                        <!-- 颚式破碎机 -->
                        <rect x="160" y="130" width="40" height="30" fill="#666" stroke="#333" stroke-width="1" class="equipment" data-id="crusher-1"/>
                        <circle cx="180" cy="145" r="15" fill="#ff0000" class="alarm-high equipment" data-id="crusher-1" opacity="0.7"/>
                        <text x="180" y="150" text-anchor="middle" fill="#fff" font-size="9">破碎机</text>
                        
                        <!-- 皮带输送机 -->
                        <rect x="220" y="140" width="60" height="10" fill="#222" class="equipment" data-id="conveyor-1"/>
                        <text x="250" y="165" text-anchor="middle" fill="#ccc" font-size="8">输送机</text>
                    </g>
                    
                    <!-- 粉磨工段 -->
                    <g class="workshop-area" data-id="grinding-workshop">
                        <rect x="340" y="80" width="180" height="150" fill="#004455" stroke="#00aaff" stroke-width="3"/>
                        <text x="430" y="105" text-anchor="middle" fill="#fff" font-weight="bold">粉磨工段</text>
                        
                        <!-- 球磨机 -->
                        <ellipse cx="380" cy="145" rx="25" ry="12" fill="#ffdd44" class="equipment" data-id="ball-mill"/>
                        <circle cx="380" cy="145" r="18" fill="#ffff00" class="alarm-low equipment" data-id="ball-mill" opacity="0.6"/>
                        <text x="380" y="150" text-anchor="middle" fill="#333" font-size="9">球磨机</text>
                        
                        <!-- 选粉机 -->
                        <circle cx="460" cy="145" r="15" fill="#777" class="equipment" data-id="separator"/>
                        <text x="460" y="150" text-anchor="middle" fill="#fff" font-size="8">选粉机</text>
                    </g>
                    
                    <!-- 煅烧工段 -->
                    <g class="workshop-area" data-id="burning-workshop">
                        <rect x="550" y="80" width="180" height="150" fill="#550022" stroke="#ff6600" stroke-width="3"/>
                        <text x="640" y="105" text-anchor="middle" fill="#fff" font-weight="bold">煅烧工段</text>
                        
                        <!-- 回转窑 -->
                        <ellipse cx="640" cy="145" rx="45" ry="18" fill="#888" class="equipment" data-id="rotary-kiln"/>
                        <text x="640" y="150" text-anchor="middle" fill="#fff" font-size="10">回转窑</text>
                        
                        <!-- 燃烧器 -->
                        <circle cx="680" cy="145" r="8" fill="#ff6600">
                            <animate attributeName="fill" values="#ff6600;#ff3300;#ff6600" dur="1s" repeatCount="indefinite"/>
                        </circle>
                        <text x="680" y="165" text-anchor="middle" fill="#ccc" font-size="7">燃烧器</text>
                    </g>
                    
                    <!-- 成品区域 -->
                    <g class="material-area">
                        <rect x="760" y="280" width="80" height="120" fill="#555" stroke="#888" stroke-width="1" stroke-dasharray="5,5"/>
                        <text x="800" y="330" text-anchor="middle" fill="#ccc" font-size="12">成品区</text>
                        <circle cx="800" cy="350" r="8" fill="#666"/>
                        <text x="800" y="365" text-anchor="middle" fill="#ccc" font-size="8">水泥</text>
                    </g>
                    
                    <!-- 主要物料流向线 -->
                    <g class="flow-lines">
                        <!-- 原料到破碎 -->
                        <line x1="100" y1="340" x2="160" y2="145" stroke="#00ff88" stroke-width="4" 
                              marker-end="url(#arrowhead)" opacity="0.8"/>
                        <text x="125" y="235" text-anchor="middle" fill="#00ff88" font-size="10">原料投入</text>
                        
                        <!-- 破碎到粉磨 -->
                        <line x1="310" y1="145" x2="340" y2="145" stroke="#00ff88" stroke-width="4" 
                              marker-end="url(#arrowhead)" opacity="0.8"/>
                        <text x="325" y="135" text-anchor="middle" fill="#00ff88" font-size="9">粗碎料</text>
                        
                        <!-- 粉磨到煅烧 -->
                        <line x1="520" y1="145" x2="550" y2="145" stroke="#00ff88" stroke-width="4" 
                              marker-end="url(#arrowhead)" opacity="0.8"/>
                        <text x="535" y="135" text-anchor="middle" fill="#00ff88" font-size="9">生料</text>
                        
                        <!-- 煅烧到成品 -->
                        <line x1="730" y1="145" x2="760" y2="340" stroke="#00ff88" stroke-width="4" 
                              marker-end="url(#arrowhead)" opacity="0.8"/>
                        <text x="750" y="235" text-anchor="middle" fill="#00ff88" font-size="10">熟料/水泥</text>
                    </g>
                    
                    <!-- 辅助流向 -->
                    <g class="auxiliary-flows">
                        <!-- 循环物料流 -->
                        <path d="M 445 160 Q 430 180, 415 160" stroke="#ffa500" stroke-width="2" 
                              fill="none" marker-end="url(#arrowhead)" opacity="0.6"/>
                        <text x="430" y="185" text-anchor="middle" fill="#ffa500" font-size="8">返料</text>
                        
                        <!-- 工艺流向点 -->
                        <circle cx="275" cy="145" r="3" fill="#00ff88" opacity="0.8">
                            <animate attributeName="r" values="2;5;2" dur="1.5s" repeatCount="indefinite"/>
                        </circle>
                        
                        <circle cx="535" cy="145" r="3" fill="#00ff88" opacity="0.8">
                            <animate attributeName="r" values="2;5;2" dur="1.5s" repeatCount="indefinite" begin="0.5s"/>
                        </circle>
                    </g>
                    
                    <!-- 流向说明 -->
                    <g class="flow-legend">
                        <rect x="20" y="500" width="200" height="80" fill="#222" stroke="#555" stroke-width="1"/>
                        <text x="30" y="520" fill="#fff" font-size="12" font-weight="bold">物料流向说明</text>
                        
                        <line x1="30" y1="535" x2="60" y2="535" stroke="#00ff88" stroke-width="3" marker-end="url(#arrowhead)"/>
                        <text x="70" y="540" fill="#ccc" font-size="10">主要物料流</text>
                        
                        <line x1="30" y1="550" x2="60" y2="550" stroke="#ffa500" stroke-width="2" marker-end="url(#arrowhead)"/>
                        <text x="70" y="555" fill="#ccc" font-size="10">循环/返料流</text>
                        
                        <circle cx="45" cy="565" r="3" fill="#00ff88"/>
                        <text x="55" y="570" fill="#ccc" font-size="10">流向监测点</text>
                    </g>
                </g>
            `;
            
            svg.innerHTML = factoryLayout;
            
            // 添加2D鼠标事件
            svg.addEventListener('mousemove', function(event) {
                const target = event.target;
                if (target.classList.contains('equipment') || target.classList.contains('workshop-area')) {
                    showTooltip(event, target.dataset);
                } else {
                    hideTooltip();
                }
            });

            // 添加2D点击事件（下钻）
            svg.addEventListener('click', function(event) {
                const target = event.target;
                if (target.dataset && target.dataset.id) {
                    // 使用统一的节点切换函数
                    switchToNode(target.dataset.id, '2d_click');
                }
            });
            
            // 添加流向动画效果
            animate2DFlows();
        }

        // 2D流向动画
        function animate2DFlows() {
            // 为流向线添加虚线动画效果
            const flowLines = document.querySelectorAll('.flow-lines line');
            flowLines.forEach((line, index) => {
                // 创建动画虚线效果
                line.style.strokeDasharray = '10,5';
                line.style.animation = `flow-animation 2s linear infinite`;
                line.style.animationDelay = `${index * 0.3}s`;
            });
            
            // 添加CSS动画样式
            if (!document.getElementById('flow-animation-style')) {
                const style = document.createElement('style');
                style.id = 'flow-animation-style';
                style.textContent = `
                    @keyframes flow-animation {
                        0% { stroke-dashoffset: 0; }
                        100% { stroke-dashoffset: 15; }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        // 创建3D工厂模型
        function createFactoryModel() {
            // 清空现有场景中的网格
            const objectsToRemove = [];
            scene.children.forEach(child => {
                if (child instanceof THREE.Mesh) {
                    objectsToRemove.push(child);
                }
            });
            objectsToRemove.forEach(obj => scene.remove(obj));

            // 创建地面
            createGround();
            
            // 创建工厂主体建筑
            createMainBuilding();
            
            // 创建各工段区域
            createWorkshopAreas();
            
            // 创建设备
            createEquipment();
            
            // 创建子部件
            createComponents();
            
            // 创建连接管道和输送带
            createInfrastructure();
        }

        // 创建地面
        function createGround() {
            const groundGeometry = new THREE.PlaneGeometry(120, 80);
            const groundMaterial = new THREE.MeshLambertMaterial({ 
                color: 0x2a2a2a,
                transparent: true,
                opacity: 0.8 
            });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            ground.userData = { id: 'factory-ground', name: '工厂地面', selectable: false };
            scene.add(ground);

            // 添加网格线
            const gridHelper = new THREE.GridHelper(120, 50, 0x444444, 0x333333);
            gridHelper.userData = { selectable: false };
            scene.add(gridHelper);
        }

        // 创建工厂标识（简化版本，只保留必要的标识）
        function createMainBuilding() {
            const factoryGroup = new THREE.Group();
            factoryGroup.userData = { id: 'cement-factory', name: '水泥工厂', type: 'factory' };

            // 工厂标识牌（替代大型建筑）
            const signGeometry = new THREE.BoxGeometry(8, 3, 0.2);
            const signMaterial = new THREE.MeshLambertMaterial({ color: 0x0078d4 });
            const sign = new THREE.Mesh(signGeometry, signMaterial);
            sign.position.set(0, 8, -25);
            factoryGroup.add(sign);

            // 添加文字纹理（模拟工厂标识）
            const canvas = document.createElement('canvas');
            canvas.width = 512;
            canvas.height = 128;
            const context = canvas.getContext('2d');
            context.fillStyle = '#ffffff';
            context.font = 'bold 48px Arial';
            context.textAlign = 'center';
            context.fillText('水泥工厂数字孪生', 256, 80);
            
            const texture = new THREE.CanvasTexture(canvas);
            const textMaterial = new THREE.MeshLambertMaterial({ map: texture });
            const textSign = new THREE.Mesh(signGeometry, textMaterial);
            textSign.position.set(0, 8, -24.9);
            factoryGroup.add(textSign);

            scene.add(factoryGroup);
        }

        // 创建工段区域
        function createWorkshopAreas() {
            // 破碎工段区域
            const crushingArea = createWorkshopArea('crushing-workshop', '破碎工段', 
                new THREE.Vector3(-25, 0, -15), new THREE.Vector3(18, 15), 0xffaa00);
            
            // 粉磨工段区域  
            const grindingArea = createWorkshopArea('grinding-workshop', '粉磨工段',
                new THREE.Vector3(0, 0, -15), new THREE.Vector3(20, 15), 0x00aaff);
            
            // 煅烧工段区域
            const burningArea = createWorkshopArea('burning-workshop', '煅烧工段',
                new THREE.Vector3(25, 0, -5), new THREE.Vector3(18, 20), 0xff6600);

            scene.add(crushingArea, grindingArea, burningArea);
        }

        // 创建工段区域辅助函数
        function createWorkshopArea(id, name, position, size, color) {
            const workshopGroup = new THREE.Group();
            workshopGroup.userData = { id: id, name: name, type: 'workshop' };
            workshopGroup.position.copy(position);

            // 地面区域标识
            const floorGeometry = new THREE.BoxGeometry(size.x, 0.2, size.z);
            const floorMaterial = new THREE.MeshLambertMaterial({ 
                color: color, 
                transparent: true, 
                opacity: 0.4 
            });
            const floor = new THREE.Mesh(floorGeometry, floorMaterial);
            floor.position.y = 0.1;
            workshopGroup.add(floor);

            // 边界围栏
            const fenceHeight = 3;
            const fenceMaterial = new THREE.MeshLambertMaterial({ 
                color: color, 
                transparent: true, 
                opacity: 0.6 
            });

            // 四面围栏
            const fences = [
                { pos: [0, fenceHeight/2, size.z/2], size: [size.x, fenceHeight, 0.1] }, // 前
                { pos: [0, fenceHeight/2, -size.z/2], size: [size.x, fenceHeight, 0.1] }, // 后
                { pos: [size.x/2, fenceHeight/2, 0], size: [0.1, fenceHeight, size.z] }, // 右
                { pos: [-size.x/2, fenceHeight/2, 0], size: [0.1, fenceHeight, size.z] }, // 左
            ];

            fences.forEach(fence => {
                const fenceGeometry = new THREE.BoxGeometry(...fence.size);
                const fenceMesh = new THREE.Mesh(fenceGeometry, fenceMaterial);
                fenceMesh.position.set(...fence.pos);
                workshopGroup.add(fenceMesh);
            });

            // 工段标识牌
            const signGeometry = new THREE.BoxGeometry(6, 2, 0.1);
            const signMaterial = new THREE.MeshLambertMaterial({ color: 0xffffff });
            const sign = new THREE.Mesh(signGeometry, signMaterial);
            sign.position.set(0, fenceHeight + 1, -size.z/2 - 0.5);

            // 添加工段名称文字
            const canvas = document.createElement('canvas');
            canvas.width = 256;
            canvas.height = 64;
            const context = canvas.getContext('2d');
            context.fillStyle = color === 0xffaa00 ? '#ff8800' : 
                               color === 0x00aaff ? '#0088ff' : '#ff4400';
            context.font = 'bold 32px Arial';
            context.textAlign = 'center';
            context.fillText(name, 128, 42);
            
            const texture = new THREE.CanvasTexture(canvas);
            const textMaterial = new THREE.MeshLambertMaterial({ map: texture });
            const textSign = new THREE.Mesh(signGeometry, textMaterial);
            textSign.position.set(0, fenceHeight + 1, -size.z/2 - 0.4);
            
            workshopGroup.add(sign, textSign);

            return workshopGroup;
        }

        // 创建设备
        function createEquipment() {
            // 颚式破碎机
            const crusher = createCrusher();
            scene.add(crusher);

            // 皮带输送机
            const conveyor = createConveyor();
            scene.add(conveyor);

            // 球磨机
            const ballMill = createBallMill();
            scene.add(ballMill);

            // 选粉机
            const separator = createSeparator();
            scene.add(separator);

            // 回转窑
            const rotaryKiln = createRotaryKiln();
            scene.add(rotaryKiln);
        }

        // 创建颚式破碎机
        function createCrusher() {
            const crusherGroup = new THREE.Group();
            crusherGroup.userData = { id: 'crusher-1', name: '颚式破碎机', type: 'equipment' };
            crusherGroup.position.set(-25, 0, -10);

            // 主体
            const bodyGeometry = new THREE.BoxGeometry(6, 4, 4);
            const bodyMaterial = new THREE.MeshLambertMaterial({ color: 0x666666 });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.position.set(0, 2, 0);
            body.castShadow = true;
            crusherGroup.add(body);

            // 进料口
            const inletGeometry = new THREE.ConeGeometry(2, 3, 8);
            const inletMaterial = new THREE.MeshLambertMaterial({ color: 0x555555 });
            const inlet = new THREE.Mesh(inletGeometry, inletMaterial);
            inlet.position.set(0, 5.5, 0);
            crusherGroup.add(inlet);

            // 基础
            const baseGeometry = new THREE.BoxGeometry(8, 1, 6);
            const baseMaterial = new THREE.MeshLambertMaterial({ color: 0x444444 });
            const base = new THREE.Mesh(baseGeometry, baseMaterial);
            base.position.set(0, 0.5, 0);
            crusherGroup.add(base);

            return crusherGroup;
        }

        // 创建皮带输送机
        function createConveyor() {
            const conveyorGroup = new THREE.Group();
            conveyorGroup.userData = { id: 'conveyor-1', name: '皮带输送机', type: 'equipment' };
            conveyorGroup.position.set(-15, 0, -10);

            // 皮带
            const beltGeometry = new THREE.BoxGeometry(12, 0.3, 1.2);
            const beltMaterial = new THREE.MeshLambertMaterial({ color: 0x222222 });
            const belt = new THREE.Mesh(beltGeometry, beltMaterial);
            belt.position.set(0, 1.5, 0);
            conveyorGroup.add(belt);

            // 支撑架
            for (let i = -5; i <= 5; i += 2.5) {
                const supportGeometry = new THREE.BoxGeometry(0.2, 3, 0.2);
                const supportMaterial = new THREE.MeshLambertMaterial({ color: 0x555555 });
                const support = new THREE.Mesh(supportGeometry, supportMaterial);
                support.position.set(i, 1.5, 0.7);
                conveyorGroup.add(support);
                
                const support2 = support.clone();
                support2.position.z = -0.7;
                conveyorGroup.add(support2);
            }

            return conveyorGroup;
        }

        // 创建球磨机
        function createBallMill() {
            const millGroup = new THREE.Group();
            millGroup.userData = { id: 'ball-mill', name: '球磨机', type: 'equipment' };
            millGroup.position.set(0, 0, -10);

            // 主筒体
            const cylinderGeometry = new THREE.CylinderGeometry(3.5, 3.5, 10, 20);
            const cylinderMaterial = new THREE.MeshLambertMaterial({ color: 0xffdd44 });
            const cylinder = new THREE.Mesh(cylinderGeometry, cylinderMaterial);
            cylinder.rotation.z = Math.PI / 2;
            cylinder.position.set(0, 3.5, 0);
            cylinder.castShadow = true;
            millGroup.add(cylinder);

            // 支撑座
            const support1Geometry = new THREE.BoxGeometry(2, 7, 3);
            const supportMaterial = new THREE.MeshLambertMaterial({ color: 0x555555 });
            const support1 = new THREE.Mesh(support1Geometry, supportMaterial);
            support1.position.set(-4, 3.5, 0);
            millGroup.add(support1);

            const support2 = support1.clone();
            support2.position.x = 4;
            millGroup.add(support2);

            // 端盖
            const endCapGeometry = new THREE.CylinderGeometry(3.5, 3.5, 0.5, 20);
            const endCapMaterial = new THREE.MeshLambertMaterial({ color: 0x444444 });
            const endCap1 = new THREE.Mesh(endCapGeometry, endCapMaterial);
            endCap1.rotation.z = Math.PI / 2;
            endCap1.position.set(-5.25, 3.5, 0);
            millGroup.add(endCap1);

            const endCap2 = endCap1.clone();
            endCap2.position.x = 5.25;
            millGroup.add(endCap2);

            return millGroup;
        }

        // 创建选粉机
        function createSeparator() {
            const separatorGroup = new THREE.Group();
            separatorGroup.userData = { id: 'separator', name: '选粉机', type: 'equipment' };
            separatorGroup.position.set(10, 0, -10);

            // 主体圆柱
            const bodyGeometry = new THREE.CylinderGeometry(2, 2.5, 6, 12);
            const bodyMaterial = new THREE.MeshLambertMaterial({ color: 0x777777 });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.position.set(0, 3, 0);
            body.castShadow = true;
            separatorGroup.add(body);

            // 顶部锥体
            const topGeometry = new THREE.ConeGeometry(2, 2, 12);
            const topMaterial = new THREE.MeshLambertMaterial({ color: 0x666666 });
            const top = new THREE.Mesh(topGeometry, topMaterial);
            top.position.set(0, 7, 0);
            separatorGroup.add(top);

            // 进料管
            const pipeGeometry = new THREE.CylinderGeometry(0.5, 0.5, 3, 8);
            const pipeMaterial = new THREE.MeshLambertMaterial({ color: 0x555555 });
            const pipe = new THREE.Mesh(pipeGeometry, pipeMaterial);
            pipe.position.set(0, 8.5, 0);
            separatorGroup.add(pipe);

            return separatorGroup;
        }

        // 创建回转窑
        function createRotaryKiln() {
            const kilnGroup = new THREE.Group();
            kilnGroup.userData = { id: 'rotary-kiln', name: '回转窑', type: 'equipment' };
            kilnGroup.position.set(25, 0, 0);

            // 主筒体
            const kilnGeometry = new THREE.CylinderGeometry(2.5, 3, 15, 20);
            const kilnMaterial = new THREE.MeshLambertMaterial({ color: 0x888888 });
            const kiln = new THREE.Mesh(kilnGeometry, kilnMaterial);
            kiln.rotation.z = Math.PI / 2;
            kiln.rotation.x = 0.1; // 稍微倾斜
            kiln.position.set(0, 3, 0);
            kiln.castShadow = true;
            kilnGroup.add(kiln);

            // 支撑轮
            for (let i = 0; i < 4; i++) {
                const wheelGeometry = new THREE.CylinderGeometry(0.8, 0.8, 0.5, 12);
                const wheelMaterial = new THREE.MeshLambertMaterial({ color: 0x333333 });
                const wheel = new THREE.Mesh(wheelGeometry, wheelMaterial);
                wheel.position.set(-6 + i * 4, 0.8, 0);
                kilnGroup.add(wheel);
            }

            // 窑头罩
            const hoodGeometry = new THREE.CylinderGeometry(3.5, 3, 4, 12);
            const hoodMaterial = new THREE.MeshLambertMaterial({ color: 0x666666 });
            const hood = new THREE.Mesh(hoodGeometry, hoodMaterial);
            hood.rotation.z = Math.PI / 2;
            hood.position.set(9, 3, 0);
            kilnGroup.add(hood);

            return kilnGroup;
        }

        // 创建子部件
        function createComponents() {
            // 破碎机电机
            const crusherMotor = createMotor('crusher-motor', '破碎机电机', 
                new THREE.Vector3(-28, 2, -8), 0xff4444);
            scene.add(crusherMotor);

            // 破碎机轴承
            const crusherBearing = createBearing('crusher-bearing', '破碎机轴承', 
                new THREE.Vector3(-22, 3, -10));
            scene.add(crusherBearing);

            // 球磨机主电机
            const millMotor = createMotor('mill-motor', '球磨机主电机', 
                new THREE.Vector3(-6, 1, -8), 0x4444ff);
            scene.add(millMotor);

            // 球磨机减速器
            const gearbox = createGearbox('mill-gearbox', '球磨机减速器', 
                new THREE.Vector3(-3, 2, -10));
            scene.add(gearbox);

            // 回转窑燃烧器
            const burner = createBurner('kiln-burner', '回转窑燃烧器', 
                new THREE.Vector3(32, 3, 0));
            scene.add(burner);

            // 回转窑筒体（作为子部件标识）
            const cylinder = createKilnCylinder('kiln-cylinder', '窑筒体', 
                new THREE.Vector3(25, 3, 0));
            scene.add(cylinder);
        }

        // 创建电机子部件
        function createMotor(id, name, position, color = 0x4444ff) {
            const motorGroup = new THREE.Group();
            motorGroup.userData = { id: id, name: name, type: 'component' };
            motorGroup.position.copy(position);

            const bodyGeometry = new THREE.CylinderGeometry(0.8, 0.8, 2, 12);
            const bodyMaterial = new THREE.MeshLambertMaterial({ color: color });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.castShadow = true;
            motorGroup.add(body);

            // 接线盒
            const boxGeometry = new THREE.BoxGeometry(0.5, 0.5, 0.3);
            const boxMaterial = new THREE.MeshLambertMaterial({ color: 0x333333 });
            const box = new THREE.Mesh(boxGeometry, boxMaterial);
            box.position.set(0.6, 0, 0);
            motorGroup.add(box);

            return motorGroup;
        }

        // 创建轴承子部件
        function createBearing(id, name, position) {
            const bearingGroup = new THREE.Group();
            bearingGroup.userData = { id: id, name: name, type: 'component' };
            bearingGroup.position.copy(position);

            const bearingGeometry = new THREE.CylinderGeometry(0.5, 0.5, 0.8, 16);
            const bearingMaterial = new THREE.MeshLambertMaterial({ color: 0x888888 });
            const bearing = new THREE.Mesh(bearingGeometry, bearingMaterial);
            bearing.rotation.z = Math.PI / 2;
            bearingGroup.add(bearing);

            return bearingGroup;
        }

        // 创建减速器子部件
        function createGearbox(id, name, position) {
            const gearboxGroup = new THREE.Group();
            gearboxGroup.userData = { id: id, name: name, type: 'component' };
            gearboxGroup.position.copy(position);

            const bodyGeometry = new THREE.BoxGeometry(2, 1.5, 1.5);
            const bodyMaterial = new THREE.MeshLambertMaterial({ color: 0x555555 });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.castShadow = true;
            gearboxGroup.add(body);

            return gearboxGroup;
        }

        // 创建燃烧器子部件
        function createBurner(id, name, position) {
            const burnerGroup = new THREE.Group();
            burnerGroup.userData = { id: id, name: name, type: 'component' };
            burnerGroup.position.copy(position);

            const nozzleGeometry = new THREE.CylinderGeometry(0.3, 0.5, 2, 8);
            const nozzleMaterial = new THREE.MeshLambertMaterial({ color: 0xff6600 });
            const nozzle = new THREE.Mesh(nozzleGeometry, nozzleMaterial);
            nozzle.rotation.z = Math.PI / 2;
            burnerGroup.add(nozzle);

            // 火焰效果（用橙色球体模拟）
            const flameGeometry = new THREE.SphereGeometry(0.8, 8, 6);
            const flameMaterial = new THREE.MeshLambertMaterial({ 
                color: 0xff3300, 
                transparent: true, 
                opacity: 0.7 
            });
            const flame = new THREE.Mesh(flameGeometry, flameMaterial);
            flame.position.x = 1.5;
            burnerGroup.add(flame);

            return burnerGroup;
        }

        // 创建窑筒体标识
        function createKilnCylinder(id, name, position) {
            const cylinderGroup = new THREE.Group();
            cylinderGroup.userData = { id: id, name: name, type: 'component' };
            cylinderGroup.position.copy(position);

            // 创建一个透明的圆环来标识筒体
            const ringGeometry = new THREE.TorusGeometry(3, 0.2, 8, 16);
            const ringMaterial = new THREE.MeshLambertMaterial({ 
                color: 0x00ff00, 
                transparent: true, 
                opacity: 0.6 
            });
            const ring = new THREE.Mesh(ringGeometry, ringMaterial);
            ring.rotation.y = Math.PI / 2;
            cylinderGroup.add(ring);

            return cylinderGroup;
        }

        // 创建基础设施（管道、输送带等）
        function createInfrastructure() {
            // 工段间连接管道
            createPipeline(new THREE.Vector3(-15, 2, -10), new THREE.Vector3(-5, 2, -10), 0x555555);
            createPipeline(new THREE.Vector3(5, 2, -10), new THREE.Vector3(15, 2, -10), 0x555555);
            createPipeline(new THREE.Vector3(15, 4, -5), new THREE.Vector3(25, 4, -2), 0x555555);
            
            // 物料流向指示箭头
            createFlowArrow(new THREE.Vector3(-10, 3, -10), new THREE.Vector3(1, 0, 0));
            createFlowArrow(new THREE.Vector3(10, 3, -10), new THREE.Vector3(1, 0, 0));
        }

        // 创建管道
        function createPipeline(start, end, color) {
            const direction = new THREE.Vector3().subVectors(end, start);
            const length = direction.length();
            const pipeGeometry = new THREE.CylinderGeometry(0.3, 0.3, length, 8);
            const pipeMaterial = new THREE.MeshLambertMaterial({ color: color });
            const pipe = new THREE.Mesh(pipeGeometry, pipeMaterial);
            
            pipe.position.copy(start).add(end).multiplyScalar(0.5);
            pipe.lookAt(end);
            pipe.rotateX(Math.PI / 2);
            pipe.userData = { name: '输送管道', type: 'infrastructure', selectable: false };
            
            scene.add(pipe);
        }

        // 创建物料流向箭头
        function createFlowArrow(position, direction) {
            const arrowGroup = new THREE.Group();
            arrowGroup.position.copy(position);
            arrowGroup.userData = { name: '物料流向', type: 'infrastructure', selectable: false };

            // 箭头主体
            const arrowGeometry = new THREE.ConeGeometry(0.5, 2, 6);
            const arrowMaterial = new THREE.MeshLambertMaterial({ 
                color: 0x00ff00,
                transparent: true,
                opacity: 0.8 
            });
            const arrow = new THREE.Mesh(arrowGeometry, arrowMaterial);
            arrow.rotation.z = -Math.PI / 2; // 水平指向
            
            // 根据方向调整箭头朝向
            if (direction.x < 0) arrow.rotation.z = Math.PI / 2;
            if (direction.z > 0) arrow.rotation.x = Math.PI / 2;
            if (direction.z < 0) arrow.rotation.x = -Math.PI / 2;
            
            arrowGroup.add(arrow);

            // 添加流动动画
            arrowGroup.userData.animate = (deltaTime) => {
                arrow.material.opacity = 0.5 + 0.3 * Math.sin(Date.now() * 0.005);
            };

            scene.add(arrowGroup);
        }

        // 保存所有模型的原始颜色
        function saveOriginalColors() {
            scene.traverse((child) => {
                if (child instanceof THREE.Mesh && child.material && child.material.color) {
                    child.userData.originalColor = child.material.color.getHex();
                }
            });
        }

        // 应用告警效果到3D模型
        function apply3DAlarmEffects() {
            // 获取所有告警节点
            const alarmNodes = document.querySelectorAll('.tree-node-content[class*="alarm"]');
            
            alarmNodes.forEach(node => {
                const nodeId = node.dataset.id;
                const alarmLevel = node.classList.contains('alarm-high') ? 'high' :
                                 node.classList.contains('alarm-medium') ? 'medium' : 'low';
                
                // 在3D场景中找到对应的对象
                const object3D = findObjectById(nodeId);
                if (object3D) {
                    applyAlarmMaterial(object3D, alarmLevel);
                }
            });
        }

        // 在场景中查找指定ID的对象
        function findObjectById(id) {
            let foundObject = null;
            
            scene.traverse((child) => {
                if (child.userData && child.userData.id === id) {
                    foundObject = child;
                }
            });
            
            return foundObject;
        }

        // 应用告警材质效果
        function applyAlarmMaterial(object, alarmLevel) {
            const colors = {
                high: 0xff0000,    // 红色
                medium: 0xff8800,  // 橙色  
                low: 0xffff00      // 黄色
            };
            
            const color = colors[alarmLevel] || 0x666666;
            
            object.traverse((child) => {
                if (child instanceof THREE.Mesh) {
                    // 存储原始颜色
                    if (!child.userData.originalColor) {
                        child.userData.originalColor = child.material.color.getHex();
                    }
                    
                    // 创建闪烁材质
                    const originalMaterial = child.material;
                    const alarmMaterial = new THREE.MeshLambertMaterial({
                        color: color,
                        transparent: true,
                        opacity: 0.8
                    });
                    
                    // 存储原始材质
                    child.userData.originalMaterial = originalMaterial;
                    child.userData.alarmMaterial = alarmMaterial;
                    child.userData.isBlinking = true;
                    child.userData.blinkPhase = 0;
                }
            });
        }

        // 更新闪烁动画
        function updateBlinkingEffects() {
            scene.traverse((child) => {
                if (child instanceof THREE.Mesh && child.userData.isBlinking) {
                    child.userData.blinkPhase += 0.1;
                    const alpha = (Math.sin(child.userData.blinkPhase) + 1) * 0.5;
                    
                    if (alpha > 0.5) {
                        child.material = child.userData.alarmMaterial;
                    } else {
                        child.material = child.userData.originalMaterial;
                    }
                }
            });
        }

        // 添加设备运转动画
        function addEquipmentAnimations() {
            // 球磨机旋转动画
            const ballMill = findObjectById('ball-mill');
            if (ballMill) {
                ballMill.userData.animate = (deltaTime) => {
                    ballMill.children[0].rotation.x += deltaTime * 0.5; // 主筒体旋转
                };
            }

            // 回转窑旋转动画
            const rotaryKiln = findObjectById('rotary-kiln');
            if (rotaryKiln) {
                rotaryKiln.userData.animate = (deltaTime) => {
                    rotaryKiln.children[0].rotation.x += deltaTime * 0.2; // 窑体缓慢旋转
                };
            }

            // 皮带输送机动画
            const conveyor = findObjectById('conveyor-1');
            if (conveyor) {
                conveyor.userData.animate = (deltaTime) => {
                    // 可以添加皮带运动效果
                    const belt = conveyor.children[0];
                    if (belt.material.map) {
                        belt.material.map.offset.x += deltaTime * 0.5;
                    }
                };
            }

            // 燃烧器火焰动画
            const burner = findObjectById('kiln-burner');
            if (burner) {
                burner.userData.animate = (deltaTime) => {
                    const flame = burner.children[1]; // 火焰球体
                    if (flame) {
                        flame.scale.setScalar(1 + Math.sin(Date.now() * 0.01) * 0.2);
                        flame.material.opacity = 0.5 + Math.sin(Date.now() * 0.02) * 0.2;
                    }
                };
            }
        }

        // 更新设备动画
        function updateEquipmentAnimations(deltaTime) {
            scene.traverse((child) => {
                if (child.userData && typeof child.userData.animate === 'function') {
                    child.userData.animate(deltaTime);
                }
            });
        }

        // 根据运行模式更新3D模型显示
        function update3DModelForMode(mode) {
            scene.traverse((child) => {
                if (child.userData && child.userData.type) {
                    const originalColor = child.userData.originalColor;
                    
                    if (child instanceof THREE.Mesh) {
                        switch(mode) {
                            case 'realtime':
                                // 实时模式：恢复正常颜色，启用动画
                                if (originalColor) {
                                    child.material.color.setHex(originalColor);
                                }
                                child.userData.animationEnabled = true;
                                break;
                            case 'history':
                                // 历史模式：稍微暗化，禁用动画
                                if (originalColor) {
                                    child.material.color.setHex(originalColor);
                                    child.material.color.multiplyScalar(0.7);
                                }
                                child.userData.animationEnabled = false;
                                break;
                            case 'simulation':
                                // 模拟模式：蓝色调，启用预测动画
                                if (originalColor) {
                                    child.material.color.setHex(originalColor);
                                    child.material.color.lerp(new THREE.Color(0x0088ff), 0.3);
                                }
                                child.userData.animationEnabled = true;
                                break;
                        }
                    }
                }
            });
        }

        // 重新生成3D工厂模型
        function regenerateFactoryModel() {
            // 清除现有模型
            const objectsToRemove = [];
            scene.children.forEach(child => {
                if (child instanceof THREE.Mesh || child instanceof THREE.Group) {
                    if (child.userData && child.userData.type !== 'light') {
                        objectsToRemove.push(child);
                    }
                }
            });
            objectsToRemove.forEach(obj => scene.remove(obj));

            // 重新创建模型
            createFactoryModel();
            
            // 重新应用效果
            setTimeout(() => {
                saveOriginalColors();
                apply3DAlarmEffects();
                addEquipmentAnimations();
                update3DModelForMode(currentMode);
            }, 100);
        }

        // 重置相机到最佳观看角度
        function resetCameraView() {
            if (camera && controls) {
                // 平滑动画到最佳位置
                animateCamera(
                    camera.position,
                    new THREE.Vector3(0, 25, 30),
                    new THREE.Vector3(0, 0, -10)
                );
            }
        }

        // 资产层级结构定义
        const assetHierarchy = {
            'cement-factory': {
                type: 'factory',
                name: '水泥工厂',
                children: ['crushing-workshop', 'grinding-workshop', 'burning-workshop']
            },
            'crushing-workshop': {
                type: 'workshop',
                name: '破碎工段',
                parent: 'cement-factory',
                children: ['crusher-1', 'conveyor-1']
            },
            'grinding-workshop': {
                type: 'workshop',
                name: '粉磨工段',
                parent: 'cement-factory',
                children: ['ball-mill', 'separator']
            },
            'burning-workshop': {
                type: 'workshop',
                name: '煅烧工段',
                parent: 'cement-factory',
                children: ['rotary-kiln']
            },
            'crusher-1': {
                type: 'equipment',
                name: '颚式破碎机',
                parent: 'crushing-workshop',
                children: ['crusher-motor', 'crusher-bearing']
            },
            'conveyor-1': {
                type: 'equipment',
                name: '皮带输送机',
                parent: 'crushing-workshop',
                children: []
            },
            'ball-mill': {
                type: 'equipment',
                name: '球磨机',
                parent: 'grinding-workshop',
                children: ['mill-motor', 'mill-gearbox']
            },
            'separator': {
                type: 'equipment',
                name: '选粉机',
                parent: 'grinding-workshop',
                children: []
            },
            'rotary-kiln': {
                type: 'equipment',
                name: '回转窑',
                parent: 'burning-workshop',
                children: ['kiln-burner', 'kiln-cylinder']
            },
            'crusher-motor': {
                type: 'component',
                name: '破碎机电机',
                parent: 'crusher-1',
                children: []
            },
            'crusher-bearing': {
                type: 'component',
                name: '破碎机轴承',
                parent: 'crusher-1',
                children: []
            },
            'mill-motor': {
                type: 'component',
                name: '球磨机主电机',
                parent: 'ball-mill',
                children: []
            },
            'mill-gearbox': {
                type: 'component',
                name: '球磨机减速器',
                parent: 'ball-mill',
                children: []
            },
            'kiln-burner': {
                type: 'component',
                name: '回转窑燃烧器',
                parent: 'rotary-kiln',
                children: []
            },
            'kiln-cylinder': {
                type: 'component',
                name: '窑筒体',
                parent: 'rotary-kiln',
                children: []
            }
        };

        // 3D视图下钻
        function drillDown3D(nodeId) {
            if (!assetHierarchy[nodeId]) return;
            
            const node = assetHierarchy[nodeId];
            console.log('3D下钻到:', node.name);
            
            // 更新下钻路径
            if (drillPath.length === 0 || drillPath[drillPath.length - 1] !== nodeId) {
                // 如果点击的是更上级节点，回退到该层级
                const nodeIndex = drillPath.indexOf(nodeId);
                if (nodeIndex >= 0) {
                    drillPath = drillPath.slice(0, nodeIndex + 1);
                } else {
                    drillPath.push(nodeId);
                }
            }
            
            // 更新选中节点
            selectedNode = { id: nodeId, name: node.name, type: node.type };
            currentDrillLevel = node.type;
            
            // 更新面包屑
            updateBreadcrumb();
            
            // 更新指标面板
            updateMetricsForNode(nodeId);
            
            // 更新3D视图
            update3DViewForDrillDown(nodeId);
            
            // 更新左侧树选中状态
            updateTreeSelection(nodeId);
            
            // 更新下钻层级指示器
            updateDrillLevelIndicator(nodeId);
        }

        // 2D视图下钻
        function drillDown2D(nodeId) {
            if (!assetHierarchy[nodeId]) return;
            
            const node = assetHierarchy[nodeId];
            console.log('2D下钻到:', node.name);
            
            // 更新下钻路径
            if (drillPath.length === 0 || drillPath[drillPath.length - 1] !== nodeId) {
                // 如果点击的是更上级节点，回退到该层级
                const nodeIndex = drillPath.indexOf(nodeId);
                if (nodeIndex >= 0) {
                    drillPath = drillPath.slice(0, nodeIndex + 1);
                } else {
                    drillPath.push(nodeId);
                }
            }
            
            // 更新选中节点
            selectedNode = { id: nodeId, name: node.name, type: node.type };
            currentDrillLevel = node.type;
            
            // 更新面包屑
            updateBreadcrumb();
            
            // 更新指标面板
            updateMetricsForNode(nodeId);
            
            // 更新2D视图
            update2DViewForDrillDown(nodeId);
            
            // 更新左侧树选中状态
            updateTreeSelection(nodeId);
            
            // 更新下钻层级指示器
            updateDrillLevelIndicator(nodeId);
        }

        // 更新3D视图以适应下钻
        function update3DViewForDrillDown(nodeId) {
            const node = assetHierarchy[nodeId];
            
            // 隐藏其他不相关的对象
            scene.traverse((child) => {
                if (child.userData && child.userData.id) {
                    const childData = assetHierarchy[child.userData.id];
                    if (childData) {
                        // 显示逻辑：显示当前节点及其子节点
                        if (child.userData.id === nodeId || 
                            isChildOf(child.userData.id, nodeId) ||
                            isParentOf(child.userData.id, nodeId)) {
                            child.visible = true;
                        } else {
                            child.visible = false;
                        }
                    }
                }
            });
            
            // 聚焦到目标对象
            focusOn3DNode(nodeId);
        }

        // 更新2D视图以适应下钻
        function update2DViewForDrillDown(nodeId) {
            const node = assetHierarchy[nodeId];
            
            if (node.type === 'factory') {
                // 工厂层级：显示总览
                init2DView();
            } else if (node.type === 'workshop') {
                // 工段层级：生成详细的工段内部布局
                generate2DWorkshopDetail(nodeId);
            } else if (node.type === 'equipment') {
                // 设备层级：生成设备详细视图
                generate2DEquipmentDetail(nodeId);
            } else if (node.type === 'component') {
                // 部件层级：生成部件详细视图
                generate2DComponentDetail(nodeId);
            }
        }

        // 判断是否为子节点
        function isChildOf(childId, parentId) {
            const child = assetHierarchy[childId];
            if (!child) return false;
            
            let currentParent = child.parent;
            while (currentParent) {
                if (currentParent === parentId) return true;
                const parentNode = assetHierarchy[currentParent];
                currentParent = parentNode ? parentNode.parent : null;
            }
            return false;
        }

        // 判断是否为父节点
        function isParentOf(parentId, childId) {
            return isChildOf(childId, parentId);
        }

        // 更新左侧树选中状态
        function updateTreeSelection(nodeId) {
            // 移除所有选中状态
            document.querySelectorAll('.tree-node-content').forEach(node => {
                node.classList.remove('active');
            });
            
            // 添加当前选中状态
            const treeNode = document.querySelector(`[data-id="${nodeId}"]`);
            if (treeNode) {
                treeNode.classList.add('active');
                
                // 展开到该节点的路径
                expandToNode(treeNode);
            }
        }
        
        // 展开到指定节点
        function expandToNode(targetNode) {
            let parent = targetNode.parentElement;
            while (parent) {
                if (parent.classList && parent.classList.contains('tree-children')) {
                    parent.classList.add('expanded');
                    
                    // 找到对应的展开图标并标记为展开
                    const parentContent = parent.previousElementSibling;
                    if (parentContent) {
                        const expandIcon = parentContent.querySelector('.tree-expand-icon');
                        if (expandIcon && expandIcon.style.visibility !== 'hidden') {
                            expandIcon.classList.add('expanded');
                        }
                    }
                }
                parent = parent.parentElement;
            }
        }



         // 更新下钻层级指示器
         function updateDrillLevelIndicator(nodeId) {
             const indicator = document.getElementById('drill-indicator');
             const node = assetHierarchy[nodeId];
             
             if (!indicator || !node) return;
             
             let levelText = '';
             switch (node.type) {
                 case 'factory':
                     levelText = '工厂总览';
                     break;
                 case 'workshop':
                     levelText = `工段视图：${node.name}`;
                     break;
                 case 'equipment':
                     levelText = `设备视图：${node.name}`;
                     break;
                 case 'component':
                     levelText = `部件视图：${node.name}`;
                     break;
                 default:
                     levelText = '未知层级';
             }
             
             indicator.textContent = levelText;
         }

        // 生成2D工段详细视图
        function generate2DWorkshopDetail(workshopId) {
            const svg = document.getElementById('svg-canvas');
            const workshop = assetHierarchy[workshopId];
            
            let detailLayout = '';
            
            if (workshopId === 'crushing-workshop') {
                detailLayout = `
                    <defs>
                        <marker id="detail-arrow" markerWidth="8" markerHeight="6" 
                                refX="8" refY="3" orient="auto">
                            <polygon points="0 0, 8 3, 0 6" fill="#00ff88" />
                        </marker>
                    </defs>
                    <g transform="translate(50, 50)">
                        <rect x="0" y="0" width="800" height="600" fill="#554400" stroke="#ffaa00" stroke-width="3"/>
                        <text x="400" y="30" text-anchor="middle" fill="#fff" font-size="20">${workshop.name} - 详细视图</text>
                        
                        <!-- 原料入口 -->
                        <rect x="50" y="100" width="80" height="60" fill="#8b4513" stroke="#666" stroke-width="2"/>
                        <text x="90" y="135" text-anchor="middle" fill="#fff" font-size="12">原料仓</text>
                        
                        <!-- 颚式破碎机详细结构 -->
                        <g class="equipment" data-id="crusher-1">
                            <rect x="200" y="80" width="120" height="100" fill="#666" stroke="#333" stroke-width="2"/>
                            <text x="260" y="100" text-anchor="middle" fill="#fff" font-size="14">颚式破碎机</text>
                            
                            <!-- 破碎机部件 -->
                            <circle cx="220" cy="140" r="15" fill="#ff4444" class="component" data-id="crusher-motor"/>
                            <text x="220" y="145" text-anchor="middle" fill="#fff" font-size="8">电机</text>
                            
                            <rect x="280" y="130" width="20" height="20" fill="#888" class="component" data-id="crusher-bearing"/>
                            <text x="290" y="155" text-anchor="middle" fill="#fff" font-size="8">轴承</text>
                        </g>
                        
                        <!-- 皮带输送机 -->
                        <g class="equipment" data-id="conveyor-1">
                            <rect x="380" y="125" width="200" height="20" fill="#222" stroke="#444" stroke-width="1"/>
                            <text x="480" y="120" text-anchor="middle" fill="#ccc" font-size="12">皮带输送机</text>
                            
                            <!-- 支撑架 -->
                            <rect x="390" y="145" width="5" height="30" fill="#555"/>
                            <rect x="430" y="145" width="5" height="30" fill="#555"/>
                            <rect x="470" y="145" width="5" height="30" fill="#555"/>
                            <rect x="510" y="145" width="5" height="30" fill="#555"/>
                            <rect x="550" y="145" width="5" height="30" fill="#555"/>
                        </g>
                        
                        <!-- 出料口 -->
                        <rect x="650" y="100" width="80" height="60" fill="#444" stroke="#666" stroke-width="2"/>
                        <text x="690" y="135" text-anchor="middle" fill="#fff" font-size="12">出料口</text>
                        
                        <!-- 物料流向 -->
                        <line x1="130" y1="130" x2="200" y2="130" stroke="#00ff88" stroke-width="3" marker-end="url(#detail-arrow)"/>
                        <line x1="320" y1="130" x2="380" y2="135" stroke="#00ff88" stroke-width="3" marker-end="url(#detail-arrow)"/>
                        <line x1="580" y1="135" x2="650" y2="130" stroke="#00ff88" stroke-width="3" marker-end="url(#detail-arrow)"/>
                        
                        <!-- 返回按钮 -->
                        <g class="back-button" onclick="goBackLevel()" style="cursor: pointer;">
                            <rect x="20" y="20" width="60" height="25" fill="#0078d4" stroke="#005a9e" stroke-width="1" rx="3"/>
                            <text x="50" y="37" text-anchor="middle" fill="#fff" font-size="12">返回</text>
                        </g>
                    </g>
                `;
            } else if (workshopId === 'grinding-workshop') {
                detailLayout = `
                    <defs>
                        <marker id="detail-arrow" markerWidth="8" markerHeight="6" 
                                refX="8" refY="3" orient="auto">
                            <polygon points="0 0, 8 3, 0 6" fill="#00ff88" />
                        </marker>
                    </defs>
                    <g transform="translate(50, 50)">
                        <rect x="0" y="0" width="800" height="600" fill="#004455" stroke="#00aaff" stroke-width="3"/>
                        <text x="400" y="30" text-anchor="middle" fill="#fff" font-size="20">${workshop.name} - 详细视图</text>
                        
                        <!-- 来料 -->
                        <rect x="50" y="100" width="80" height="60" fill="#666" stroke="#888" stroke-width="2"/>
                        <text x="90" y="135" text-anchor="middle" fill="#fff" font-size="12">粗碎料</text>
                        
                        <!-- 球磨机详细结构 -->
                        <g class="equipment" data-id="ball-mill">
                            <ellipse cx="280" cy="140" rx="60" ry="30" fill="#ffdd44" stroke="#333" stroke-width="2"/>
                            <text x="280" y="115" text-anchor="middle" fill="#333" font-size="14">球磨机</text>
                            
                            <!-- 球磨机部件 -->
                            <circle cx="220" cy="140" r="12" fill="#4444ff" class="component" data-id="mill-motor"/>
                            <text x="220" y="165" text-anchor="middle" fill="#ccc" font-size="8">主电机</text>
                            
                            <rect x="330" y="130" width="20" height="20" fill="#555" class="component" data-id="mill-gearbox"/>
                            <text x="340" y="160" text-anchor="middle" fill="#ccc" font-size="8">减速器</text>
                        </g>
                        
                        <!-- 选粉机 -->
                        <g class="equipment" data-id="separator">
                            <circle cx="500" cy="140" r="40" fill="#777" stroke="#333" stroke-width="2"/>
                            <text x="500" y="145" text-anchor="middle" fill="#fff" font-size="12">选粉机</text>
                        </g>
                        
                        <!-- 成品出料 -->
                        <rect x="620" y="100" width="80" height="60" fill="#444" stroke="#666" stroke-width="2"/>
                        <text x="660" y="135" text-anchor="middle" fill="#fff" font-size="12">细料</text>
                        
                        <!-- 物料流向 -->
                        <line x1="130" y1="130" x2="220" y2="130" stroke="#00ff88" stroke-width="3" marker-end="url(#detail-arrow)"/>
                        <line x1="340" y1="140" x2="460" y2="140" stroke="#00ff88" stroke-width="3" marker-end="url(#detail-arrow)"/>
                        <line x1="540" y1="140" x2="620" y2="130" stroke="#00ff88" stroke-width="3" marker-end="url(#detail-arrow)"/>
                        
                        <!-- 返料流 -->
                        <path d="M 480 180 Q 380 220, 260 180" stroke="#ffa500" stroke-width="2" 
                              fill="none" marker-end="url(#detail-arrow)" opacity="0.7"/>
                        <text x="380" y="230" text-anchor="middle" fill="#ffa500" font-size="10">返料</text>
                        
                        <!-- 返回按钮 -->
                        <g class="back-button" onclick="goBackLevel()" style="cursor: pointer;">
                            <rect x="20" y="20" width="60" height="25" fill="#0078d4" stroke="#005a9e" stroke-width="1" rx="3"/>
                            <text x="50" y="37" text-anchor="middle" fill="#fff" font-size="12">返回</text>
                        </g>
                    </g>
                `;
            } else if (workshopId === 'burning-workshop') {
                detailLayout = `
                    <defs>
                        <marker id="detail-arrow" markerWidth="8" markerHeight="6" 
                                refX="8" refY="3" orient="auto">
                            <polygon points="0 0, 8 3, 0 6" fill="#00ff88" />
                        </marker>
                    </defs>
                    <g transform="translate(50, 50)">
                        <rect x="0" y="0" width="800" height="600" fill="#550022" stroke="#ff6600" stroke-width="3"/>
                        <text x="400" y="30" text-anchor="middle" fill="#fff" font-size="20">${workshop.name} - 详细视图</text>
                        
                        <!-- 生料入口 -->
                        <rect x="50" y="100" width="80" height="60" fill="#666" stroke="#888" stroke-width="2"/>
                        <text x="90" y="135" text-anchor="middle" fill="#fff" font-size="12">生料</text>
                        
                        <!-- 回转窑详细结构 -->
                        <g class="equipment" data-id="rotary-kiln">
                            <ellipse cx="400" cy="140" rx="150" ry="40" fill="#888" stroke="#333" stroke-width="2"/>
                            <text x="400" y="115" text-anchor="middle" fill="#fff" font-size="14">回转窑</text>
                            
                            <!-- 燃烧器 -->
                            <circle cx="520" cy="140" r="20" fill="#ff6600" class="component" data-id="kiln-burner">
                                <animate attributeName="fill" values="#ff6600;#ff3300;#ff6600" dur="1s" repeatCount="indefinite"/>
                            </circle>
                            <text x="520" y="170" text-anchor="middle" fill="#ccc" font-size="8">燃烧器</text>
                            
                            <!-- 窑筒体标识 -->
                            <rect x="300" y="125" width="200" height="30" fill="none" stroke="#00ff00" 
                                  stroke-width="2" stroke-dasharray="5,5" class="component" data-id="kiln-cylinder"/>
                            <text x="400" y="200" text-anchor="middle" fill="#00ff00" font-size="8">窑筒体</text>
                            
                            <!-- 支撑轮 -->
                            <circle cx="320" cy="180" r="8" fill="#333"/>
                            <circle cx="360" cy="180" r="8" fill="#333"/>
                            <circle cx="440" cy="180" r="8" fill="#333"/>
                            <circle cx="480" cy="180" r="8" fill="#333"/>
                        </g>
                        
                        <!-- 熟料出口 -->
                        <rect x="620" y="100" width="80" height="60" fill="#444" stroke="#666" stroke-width="2"/>
                        <text x="660" y="135" text-anchor="middle" fill="#fff" font-size="12">熟料</text>
                        
                        <!-- 物料流向 -->
                        <line x1="130" y1="130" x2="250" y2="130" stroke="#00ff88" stroke-width="3" marker-end="url(#detail-arrow)"/>
                        <line x1="550" y1="140" x2="620" y2="130" stroke="#00ff88" stroke-width="3" marker-end="url(#detail-arrow)"/>
                        
                        <!-- 返回按钮 -->
                        <g class="back-button" onclick="goBackLevel()" style="cursor: pointer;">
                            <rect x="20" y="20" width="60" height="25" fill="#0078d4" stroke="#005a9e" stroke-width="1" rx="3"/>
                            <text x="50" y="37" text-anchor="middle" fill="#fff" font-size="12">返回</text>
                        </g>
                    </g>
                `;
            }
            
            svg.innerHTML = detailLayout;
            
            // 重新绑定事件
            bindDetailViewEvents();
        }

        // 生成2D设备详细视图
        function generate2DEquipmentDetail(equipmentId) {
            const svg = document.getElementById('svg-canvas');
            const equipment = assetHierarchy[equipmentId];
            
            let detailLayout = '';
            
            if (equipmentId === 'crusher-1') {
                detailLayout = `
                    <g transform="translate(50, 50)">
                        <rect x="0" y="0" width="800" height="600" fill="#333" stroke="#666" stroke-width="2"/>
                        <text x="400" y="30" text-anchor="middle" fill="#fff" font-size="20">${equipment.name} - 内部结构</text>
                        
                        <!-- 破碎机主体 -->
                        <rect x="300" y="150" width="200" height="150" fill="#666" stroke="#333" stroke-width="3"/>
                        <text x="400" y="140" text-anchor="middle" fill="#fff" font-size="16">破碎腔</text>
                        
                        <!-- 可动颚板 -->
                        <rect x="320" y="170" width="80" height="110" fill="#777" stroke="#555" stroke-width="2"/>
                        <text x="360" y="230" text-anchor="middle" fill="#fff" font-size="10">可动颚板</text>
                        
                        <!-- 固定颚板 -->
                        <rect x="420" y="170" width="60" height="110" fill="#555" stroke="#333" stroke-width="2"/>
                        <text x="450" y="230" text-anchor="middle" fill="#fff" font-size="10">固定颚板</text>
                        
                        <!-- 电机 -->
                        <circle cx="200" cy="225" r="30" fill="#ff4444" stroke="#333" stroke-width="2" 
                                class="component" data-id="crusher-motor"/>
                        <text x="200" y="230" text-anchor="middle" fill="#fff" font-size="12">驱动电机</text>
                        
                        <!-- 轴承 -->
                        <circle cx="550" cy="200" r="20" fill="#888" stroke="#555" stroke-width="2" 
                                class="component" data-id="crusher-bearing"/>
                        <text x="550" y="235" text-anchor="middle" fill="#fff" font-size="10">主轴承</text>
                        
                        <!-- 传动系统 -->
                        <line x1="230" y1="225" x2="300" y2="225" stroke="#666" stroke-width="8"/>
                        <text x="265" y="240" text-anchor="middle" fill="#ccc" font-size="8">传动轴</text>
                        
                        <!-- 返回按钮 -->
                        <g class="back-button" onclick="goBackLevel()" style="cursor: pointer;">
                            <rect x="20" y="20" width="60" height="25" fill="#0078d4" stroke="#005a9e" stroke-width="1" rx="3"/>
                            <text x="50" y="37" text-anchor="middle" fill="#fff" font-size="12">返回</text>
                        </g>
                    </g>
                `;
            }
            // 可以添加其他设备的详细视图...
            
            svg.innerHTML = detailLayout;
            bindDetailViewEvents();
        }

        // 生成2D部件详细视图
        function generate2DComponentDetail(componentId) {
            const svg = document.getElementById('svg-canvas');
            const component = assetHierarchy[componentId];
            
            let detailLayout = `
                <g transform="translate(50, 50)">
                    <rect x="0" y="0" width="800" height="600" fill="#333" stroke="#666" stroke-width="2"/>
                    <text x="400" y="30" text-anchor="middle" fill="#fff" font-size="20">${component.name} - 详细信息</text>
                    
                    <!-- 部件详细图 -->
                    <rect x="250" y="150" width="300" height="200" fill="#444" stroke="#666" stroke-width="2"/>
                    <text x="400" y="180" text-anchor="middle" fill="#fff" font-size="16">${component.name}</text>
                    <text x="400" y="200" text-anchor="middle" fill="#ccc" font-size="12">详细技术参数和状态信息</text>
                    <text x="400" y="220" text-anchor="middle" fill="#ccc" font-size="12">将在此显示</text>
                    
                    <!-- 返回按钮 -->
                    <g class="back-button" onclick="goBackLevel()" style="cursor: pointer;">
                        <rect x="20" y="20" width="60" height="25" fill="#0078d4" stroke="#005a9e" stroke-width="1" rx="3"/>
                        <text x="50" y="37" text-anchor="middle" fill="#fff" font-size="12">返回</text>
                    </g>
                </g>
            `;
            
            svg.innerHTML = detailLayout;
            bindDetailViewEvents();
        }

        // 绑定详细视图事件
        function bindDetailViewEvents() {
            const svg = document.getElementById('svg-canvas');
            
            // 重新绑定鼠标事件
            svg.addEventListener('mousemove', function(event) {
                const target = event.target;
                if (target.classList.contains('equipment') || target.classList.contains('component')) {
                    showTooltip(event, target.dataset);
                } else {
                    hideTooltip();
                }
            });
            
            svg.addEventListener('click', function(event) {
                const target = event.target;
                if (target.dataset && target.dataset.id && target.classList.contains('component')) {
                    // 使用统一的节点切换函数
                    switchToNode(target.dataset.id, '2d_component_click');
                }
            });
        }

                 // 通过面包屑导航到指定节点
         function navigateToBreadcrumbNode(nodeId) {
             // 使用统一的节点切换函数
             switchToNode(nodeId, 'breadcrumb_click');
         }

         // 返回上一级
         function goBackLevel() {
            // 默认回到工厂总览
            const parentId = 'cement-factory';
            
            // 使用统一的节点切换函数
            switchToNode(parentId, 'back_level');
        }

                // 初始化事件监听器
        function initEventListeners() {
            // 运行模式切换
            document.querySelectorAll('[data-mode]').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('[data-mode]').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentMode = this.dataset.mode;
                    switchMode(currentMode);
                });
            });

            // 视图模式切换
            document.querySelectorAll('[data-view]').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('[data-view]').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentView = this.dataset.view;
                    switchView();
                });
            });

            // 编辑模式切换
            document.getElementById('edit-toggle').addEventListener('click', function(e) {
                e.stopPropagation();
                editMode = !editMode;
                this.classList.toggle('active');
                document.getElementById('edit-panel').classList.toggle('visible');
                // 隐藏模式控制面板
                if (editMode) {
                    document.getElementById('mode-control-panel').classList.remove('visible');
                }
                // 隐藏工具提示
                const globalTooltip = document.getElementById('global-tooltip');
                if (globalTooltip) {
                    globalTooltip.classList.remove('show');
                }
            });
            
            // 面包屑导航
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('breadcrumb-item')) {
                    const nodeId = e.target.dataset.id;
                    navigateToBreadcrumbNode(nodeId);
                }
            });
            
            // 编辑模式设置
            document.querySelectorAll('#edit-panel input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    applyEditSettings();
                });
            });

            // 全屏切换功能
            document.getElementById('expand-toggle').addEventListener('click', function() {
                toggleFullscreenView();
            });
            
            // 初始化图标按钮工具提示
            initIconButtonTooltips();
            
            // 初始化告警系统
            initAlarmSystem();
            
            // 重置视角按钮悬停效果
            const resetButton = document.getElementById('reset-view-btn');
            if (resetButton) {
                resetButton.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-1px) rotate(180deg)';
                });
                resetButton.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0) rotate(0deg)';
                });
            }

            // 模拟参数滑块事件
            initSimulationControls();
        }

        // 初始化模拟控制
        function initSimulationControls() {
            // 生产负荷滑块
            const loadSlider = document.getElementById('load-slider');
            if (loadSlider) {
                loadSlider.addEventListener('input', function() {
                    document.getElementById('load-value').textContent = this.value + '%';
                    simulationParams.loadFactor = this.value / 100;
                });
            }

            // 质量系数滑块
            const qualitySlider = document.getElementById('quality-slider');
            if (qualitySlider) {
                qualitySlider.addEventListener('input', function() {
                    document.getElementById('quality-value').textContent = this.value;
                    simulationParams.qualityFactor = parseFloat(this.value);
                });
            }

            // 效率系数滑块
            const efficiencySlider = document.getElementById('efficiency-slider');
            if (efficiencySlider) {
                efficiencySlider.addEventListener('input', function() {
                    document.getElementById('efficiency-value').textContent = this.value + '%';
                    simulationParams.efficiencyFactor = this.value / 100;
                });
            }
        }

        // 切换视图
        function switchView() {
            const threeCanvas = document.getElementById('three-canvas');
            const svgCanvas = document.getElementById('svg-canvas');
            
            if (currentView === '3d') {
                threeCanvas.style.display = 'block';
                svgCanvas.style.display = 'none';
            } else {
                threeCanvas.style.display = 'none';
                svgCanvas.style.display = 'block';
            }
        }

        // 显示提示框
        function showTooltip(event, data) {
            const tooltip = document.getElementById('tooltip');
            const content = tooltip.querySelector('.tooltip-content');
            
            if (data && data.id) {
                const deviceData = getEnhancedDeviceData(data.id);
                let htmlContent = `<div class="tooltip-header">${deviceData.name}</div>`;
                
                // 根据当前模式显示不同的数据
                switch(currentMode) {
                    case 'realtime':
                        htmlContent += `
                            <div class="tooltip-section">
                                <div class="tooltip-label">实时指标</div>
                                <div class="tooltip-metric">温度: <span class="metric-value">${deviceData.temperature}°C</span></div>
                                <div class="tooltip-metric">压力: <span class="metric-value">${deviceData.pressure} MPa</span></div>
                                <div class="tooltip-metric">转速: <span class="metric-value">${deviceData.speed} rpm</span></div>
                                <div class="tooltip-metric">效率: <span class="metric-value">${deviceData.efficiency}%</span></div>
                                <div class="tooltip-metric">功率: <span class="metric-value">${deviceData.power} kW</span></div>
                                <div class="tooltip-metric">振动: <span class="metric-value">${deviceData.vibration} mm/s</span></div>
                            </div>
                            <div class="tooltip-status ${deviceData.status.toLowerCase()}">
                                状态: ${deviceData.status}
                            </div>
                        `;
                        break;
                    case 'history':
                        htmlContent += `
                            <div class="tooltip-section">
                                <div class="tooltip-label">历史数据 (${getCurrentHistoryTime()})</div>
                                <div class="tooltip-metric">温度: <span class="metric-value">${(deviceData.temperature * 0.9).toFixed(1)}°C</span></div>
                                <div class="tooltip-metric">压力: <span class="metric-value">${(deviceData.pressure * 0.9).toFixed(1)} MPa</span></div>
                                <div class="tooltip-metric">转速: <span class="metric-value">${Math.round(deviceData.speed * 0.9)} rpm</span></div>
                                <div class="tooltip-metric">效率: <span class="metric-value">${(deviceData.efficiency * 0.9).toFixed(1)}%</span></div>
                                <div class="tooltip-metric">功率: <span class="metric-value">${Math.round(deviceData.power * 0.9)} kW</span></div>
                            </div>
                            <div class="tooltip-note">
                                📊 显示历史时段平均值
                            </div>
                        `;
                        break;
                    case 'simulation':
                        const simData = applySimulationParams(deviceData);
                        htmlContent += `
                            <div class="tooltip-section">
                                <div class="tooltip-label">预测数据</div>
                                <div class="tooltip-metric">温度: <span class="metric-value">${simData.temperature}°C</span> 
                                    <span class="prediction-indicator">↗️</span></div>
                                <div class="tooltip-metric">压力: <span class="metric-value">${simData.pressure} MPa</span> 
                                    <span class="prediction-indicator">↗️</span></div>
                                <div class="tooltip-metric">转速: <span class="metric-value">${simData.speed} rpm</span> 
                                    <span class="prediction-indicator">↗️</span></div>
                                <div class="tooltip-metric">效率: <span class="metric-value">${simData.efficiency}%</span> 
                                    <span class="prediction-indicator">↗️</span></div>
                                <div class="tooltip-metric">功率: <span class="metric-value">${simData.power} kW</span> 
                                    <span class="prediction-indicator">↗️</span></div>
                            </div>
                            <div class="tooltip-note">
                                🔮 基于当前参数预测
                            </div>
                        `;
                        break;
                }
                
                // 添加趋势信息
                if (currentMode !== 'history') {
                    htmlContent += `
                        <div class="tooltip-trend">
                            <div class="tooltip-label">24小时趋势</div>
                            <div class="trend-indicators">
                                <span class="trend-up">温度 ↗️</span>
                                <span class="trend-stable">压力 →</span>
                                <span class="trend-down">振动 ↘️</span>
                            </div>
                        </div>
                    `;
                }
                
                content.innerHTML = htmlContent;
                tooltip.style.display = 'block';
                tooltip.style.left = event.clientX + 8 + 'px';
                tooltip.style.top = event.clientY + 8 + 'px';
                
                // 确保工具提示不会超出屏幕边界
                setTimeout(() => {
                    const rect = tooltip.getBoundingClientRect();
                    if (rect.right > window.innerWidth) {
                        tooltip.style.left = event.clientX - rect.width - 8 + 'px';
                    }
                    if (rect.bottom > window.innerHeight) {
                        tooltip.style.top = event.clientY - rect.height - 8 + 'px';
                    }
                }, 0);
            }
        }

        // 隐藏提示框
        function hideTooltip() {
            document.getElementById('tooltip').style.display = 'none';
        }

        // 检测指标是否异常
        function isMetricAbnormal(metricName, value, nodeId) {
            // 定义各设备各指标的正常范围
            const normalRanges = {
                'crusher-1': {
                    temperature: { min: 60, max: 80 },
                    pressure: { min: 2.0, max: 3.5 },
                    speed: { min: 280, max: 380 },
                    efficiency: { min: 80, max: 100 },
                    power: { min: 380, max: 520 },
                    vibration: { min: 0, max: 16 }
                },
                'ball-mill': {
                    temperature: { min: 70, max: 95 },
                    pressure: { min: 1.5, max: 2.5 },
                    speed: { min: 15, max: 25 },
                    efficiency: { min: 75, max: 100 },
                    power: { min: 1000, max: 1500 },
                    vibration: { min: 0, max: 12 }
                },
                'rotary-kiln': {
                    temperature: { min: 800, max: 1000 },
                    pressure: { min: 0.6, max: 1.2 },
                    speed: { min: 3.0, max: 4.5 },
                    efficiency: { min: 80, max: 100 },
                    power: { min: 650, max: 1000 },
                    vibration: { min: 0, max: 8 }
                },
                'cement-mill': {
                    temperature: { min: 65, max: 85 },
                    pressure: { min: 1.8, max: 2.8 },
                    speed: { min: 12, max: 20 },
                    efficiency: { min: 80, max: 100 },
                    power: { min: 550, max: 800 },
                    vibration: { min: 0, max: 14 }
                },
                'conveyor-1': {
                    temperature: { min: 40, max: 55 },
                    pressure: { min: 0.4, max: 0.7 },
                    speed: { min: 100, max: 150 },
                    efficiency: { min: 85, max: 100 },
                    power: { min: 120, max: 200 },
                    vibration: { min: 0, max: 5 }
                },
                'cement-factory': {
                    temperature: { min: 20, max: 35 },
                    pressure: { min: 0.9, max: 1.2 },
                    efficiency: { min: 80, max: 100 },
                    power: { min: 2000, max: 3500 },
                    vibration: { min: 0, max: 4 }
                }
            };

            // 工厂级别指标的正常范围
            const factoryRanges = {
                totalProduction: { min: 2000, max: 2600 },
                overallEfficiency: { min: 80, max: 100 },
                totalPower: { min: 2000, max: 3500 },
                onlineEquipment: { min: 22, max: 26 },
                alarmCount: { min: 0, max: 3 }
            };

            // 工段级别指标的正常范围
            const workshopRanges = {
                workshopEfficiency: { min: 75, max: 100 },
                workshopPower: { min: 500, max: 2000 },
                materialThroughput: { min: 120, max: 220 },
                avgVibration: { min: 0, max: 15 },
                avgTemperature: { min: 800, max: 1000 }
            };

            // 组件级别指标的正常范围
            const componentRanges = {
                'crusher-motor': {
                    voltage: { min: 360, max: 420 },
                    current: { min: 50, max: 80 },
                    temperature: { min: 60, max: 85 },
                    power: { min: 250, max: 320 },
                    efficiency: { min: 88, max: 100 },
                    vibration: { min: 0, max: 12 }
                },
                'crusher-bearing': {
                    temperature: { min: 40, max: 60 },
                    lubrication: { min: 80, max: 100 },
                    vibration: { min: 0, max: 20 },
                    wear: { min: 0, max: 25 },
                    runningTime: { min: 2500, max: 3200 }
                },
                'mill-motor': {
                    voltage: { min: 5800, max: 6200 },
                    current: { min: 160, max: 220 },
                    temperature: { min: 65, max: 95 },
                    power: { min: 850, max: 1100 },
                    efficiency: { min: 90, max: 100 },
                    vibration: { min: 0, max: 8 }
                },
                'mill-gearbox': {
                    temperature: { min: 45, max: 65 },
                    oilPressure: { min: 0.2, max: 0.32 },
                    oilTemperature: { min: 40, max: 60 },
                    vibration: { min: 0, max: 6 },
                    efficiency: { min: 92, max: 100 }
                },
                'kiln-burner': {
                    flameTemperature: { min: 1100, max: 1500 },
                    fuelPressure: { min: 1.2, max: 2.0 },
                    airPressure: { min: 2.4, max: 3.5 },
                    fuelFlow: { min: 35, max: 60 },
                    efficiency: { min: 82, max: 100 }
                },
                'kiln-cylinder': {
                    shellTemperature: { min: 280, max: 380 },
                    thickness: { min: 36, max: 42 },
                    runoutValue: { min: 0, max: 3.5 },
                    vibration: { min: 0, max: 4 },
                    rotationSpeed: { min: 2.8, max: 3.8 }
                }
            };

            // 系统级别指标的正常范围
            const systemRanges = {
                overallEfficiency: { min: 80, max: 100 },
                equipmentRuntime: { min: 85, max: 100 },
                avgEnergyConsumption: { min: 220, max: 280 },
                production: { min: 2000, max: 2800 },
                alarmCount: { min: 0, max: 3 },
                onlineDevices: { min: 22, max: 26 }
            };

            const numValue = parseFloat(value);
            
            // 检查设备级别指标
            if (nodeId && normalRanges[nodeId] && normalRanges[nodeId][metricName]) {
                const range = normalRanges[nodeId][metricName];
                return numValue < range.min || numValue > range.max;
            }
            
            // 检查组件级别指标
            if (nodeId && componentRanges[nodeId] && componentRanges[nodeId][metricName]) {
                const range = componentRanges[nodeId][metricName];
                return numValue < range.min || numValue > range.max;
            }
            
            // 检查工厂级别指标
            if (factoryRanges[metricName]) {
                const range = factoryRanges[metricName];
                return numValue < range.min || numValue > range.max;
            }
            
            // 检查工段级别指标
            if (workshopRanges[metricName]) {
                const range = workshopRanges[metricName];
                return numValue < range.min || numValue > range.max;
            }
            
            // 检查系统级别指标
            if (systemRanges[metricName]) {
                const range = systemRanges[metricName];
                return numValue < range.min || numValue > range.max;
            }

            return false; // 默认不异常
        }

        // 获取增强设备数据
        function getEnhancedDeviceData(nodeId) {
            const baseData = {
                'cement-factory': {
                    name: '水泥工厂',
                    level: 'factory',
                    totalProduction: 2300 + Math.random() * 200,
                    overallEfficiency: 85 + Math.random() * 10,
                    totalPower: 2500 + Math.random() * 500,
                    onlineEquipment: 24 + Math.floor(Math.random() * 3),
                    totalEquipment: 26,
                    alarmCount: Math.floor(Math.random() * 5) + 1,
                    status: Math.random() > 0.05 ? '正常' : '告警'
                },
                'crushing-workshop': {
                    name: '破碎工段',
                    level: 'workshop',
                    workshopEfficiency: 88 + Math.random() * 8,
                    workshopPower: 650 + Math.random() * 100,
                    materialThroughput: 180 + Math.random() * 20,
                    equipmentCount: 3,
                    runningCount: 3,
                    avgVibration: 10 + Math.random() * 3,
                    status: Math.random() > 0.1 ? '正常' : '告警'
                },
                'grinding-workshop': {
                    name: '粉磨工段',
                    level: 'workshop',
                    workshopEfficiency: 82 + Math.random() * 10,
                    workshopPower: 1400 + Math.random() * 200,
                    materialThroughput: 160 + Math.random() * 15,
                    equipmentCount: 3,
                    runningCount: 3,
                    avgVibration: 8 + Math.random() * 2,
                    status: Math.random() > 0.15 ? '正常' : '告警'
                },
                'burning-workshop': {
                    name: '煅烧工段',
                    level: 'workshop',
                    workshopEfficiency: 90 + Math.random() * 6,
                    workshopPower: 800 + Math.random() * 150,
                    materialThroughput: 170 + Math.random() * 20,
                    equipmentCount: 1,
                    runningCount: 1,
                    avgTemperature: 850 + Math.random() * 100,
                    status: Math.random() > 0.08 ? '正常' : '告警'
                },
                'crusher-1': {
                    name: '颚式破碎机 #1',
                    level: 'equipment',
                    temperature: 65 + Math.random() * 10,
                    pressure: 2.5 + Math.random() * 0.5,
                    speed: 300 + Math.random() * 50,
                    efficiency: 85 + Math.random() * 10,
                    power: 450 + Math.random() * 50,
                    vibration: 12 + Math.random() * 3,
                    status: Math.random() > 0.1 ? '正常' : '告警'
                },
                'conveyor-1': {
                    name: '皮带输送机',
                    level: 'equipment',
                    temperature: 45 + Math.random() * 8,
                    pressure: 0.5 + Math.random() * 0.1,
                    speed: 120 + Math.random() * 20,
                    efficiency: 92 + Math.random() * 5,
                    power: 150 + Math.random() * 30,
                    vibration: 3 + Math.random() * 1,
                    status: Math.random() > 0.05 ? '正常' : '告警'
                },
                'separator': {
                    name: '选粉机',
                    level: 'equipment',
                    temperature: 55 + Math.random() * 10,
                    pressure: 1.2 + Math.random() * 0.3,
                    speed: 450 + Math.random() * 50,
                    efficiency: 89 + Math.random() * 7,
                    power: 200 + Math.random() * 40,
                    vibration: 5 + Math.random() * 1,
                    status: Math.random() > 0.08 ? '正常' : '告警'
                },
                'ball-mill': {
                    name: '球磨机',
                    level: 'equipment',
                    temperature: 78 + Math.random() * 15,
                    pressure: 1.8 + Math.random() * 0.4,
                    speed: 18 + Math.random() * 3,
                    efficiency: 82 + Math.random() * 8,
                    power: 1200 + Math.random() * 200,
                    vibration: 8 + Math.random() * 2,
                    status: Math.random() > 0.15 ? '正常' : '告警'
                },
                'rotary-kiln': {
                    name: '回转窑',
                    level: 'equipment',
                    temperature: 850 + Math.random() * 100,
                    pressure: 0.8 + Math.random() * 0.2,
                    speed: 3.5 + Math.random() * 0.5,
                    efficiency: 88 + Math.random() * 7,
                    power: 800 + Math.random() * 150,
                    vibration: 5 + Math.random() * 1,
                    status: Math.random() > 0.08 ? '正常' : '告警'
                },
                // 组件级别数据
                'crusher-motor': {
                    name: '破碎机电机',
                    level: 'component',
                    temperature: 68 + Math.random() * 12,
                    voltage: 380 + Math.random() * 20,
                    current: 65 + Math.random() * 10,
                    power: 280 + Math.random() * 30,
                    efficiency: 92 + Math.random() * 5,
                    vibration: 8 + Math.random() * 2,
                    status: Math.random() > 0.2 ? '正常' : '告警'
                },
                'crusher-bearing': {
                    name: '破碎机轴承',
                    level: 'component',
                    temperature: 45 + Math.random() * 8,
                    lubrication: 85 + Math.random() * 10,
                    vibration: 15 + Math.random() * 3,
                    wear: 15 + Math.random() * 5,
                    runningTime: 2800 + Math.random() * 200,
                    status: Math.random() > 0.15 ? '正常' : '告警'
                },
                'mill-motor': {
                    name: '球磨机主电机',
                    level: 'component',
                    temperature: 75 + Math.random() * 15,
                    voltage: 6000 + Math.random() * 200,
                    current: 180 + Math.random() * 20,
                    power: 950 + Math.random() * 100,
                    efficiency: 94 + Math.random() * 4,
                    vibration: 6 + Math.random() * 1,
                    status: Math.random() > 0.1 ? '正常' : '告警'
                },
                'mill-gearbox': {
                    name: '球磨机减速器',
                    level: 'component',
                    temperature: 52 + Math.random() * 8,
                    oilPressure: 0.25 + Math.random() * 0.05,
                    oilTemperature: 48 + Math.random() * 7,
                    vibration: 4 + Math.random() * 1,
                    efficiency: 96 + Math.random() * 3,
                    status: Math.random() > 0.08 ? '正常' : '告警'
                },
                'kiln-burner': {
                    name: '回转窑燃烧器',
                    level: 'component',
                    flameTemperature: 1200 + Math.random() * 200,
                    fuelPressure: 1.5 + Math.random() * 0.3,
                    airPressure: 2.8 + Math.random() * 0.4,
                    fuelFlow: 45 + Math.random() * 8,
                    efficiency: 88 + Math.random() * 6,
                    status: Math.random() > 0.12 ? '正常' : '告警'
                },
                'kiln-cylinder': {
                    name: '回转窑筒体',
                    level: 'component',
                    shellTemperature: 320 + Math.random() * 40,
                    thickness: 38 + Math.random() * 2,
                    runoutValue: 2.5 + Math.random() * 0.5,
                    vibration: 3 + Math.random() * 0.5,
                    rotationSpeed: 3.2 + Math.random() * 0.3,
                    status: Math.random() > 0.05 ? '正常' : '告警'
                }
            };
            
            const data = baseData[nodeId];
            if (data) {
                // 安全格式化数值 - 只格式化存在的属性
                const formattedData = { ...data };
                
                // 格式化数值类型的属性
                if (typeof data.temperature === 'number') {
                    formattedData.temperature = data.temperature.toFixed(1);
                }
                if (typeof data.pressure === 'number') {
                    formattedData.pressure = data.pressure.toFixed(1);
                }
                if (typeof data.speed === 'number') {
                    formattedData.speed = Math.round(data.speed);
                }
                if (typeof data.efficiency === 'number') {
                    formattedData.efficiency = data.efficiency.toFixed(1);
                }
                if (typeof data.power === 'number') {
                    formattedData.power = Math.round(data.power);
                }
                if (typeof data.vibration === 'number') {
                    formattedData.vibration = data.vibration.toFixed(1);
                }
                
                // 工厂级别指标格式化
                if (typeof data.totalProduction === 'number') {
                    formattedData.totalProduction = data.totalProduction.toFixed(0);
                }
                if (typeof data.overallEfficiency === 'number') {
                    formattedData.overallEfficiency = data.overallEfficiency.toFixed(1);
                }
                if (typeof data.totalPower === 'number') {
                    formattedData.totalPower = data.totalPower.toFixed(0);
                }
                
                // 工段级别指标格式化
                if (typeof data.workshopEfficiency === 'number') {
                    formattedData.workshopEfficiency = data.workshopEfficiency.toFixed(1);
                }
                if (typeof data.workshopPower === 'number') {
                    formattedData.workshopPower = data.workshopPower.toFixed(0);
                }
                if (typeof data.materialThroughput === 'number') {
                    formattedData.materialThroughput = data.materialThroughput.toFixed(1);
                }
                if (typeof data.avgVibration === 'number') {
                    formattedData.avgVibration = data.avgVibration.toFixed(1);
                }
                if (typeof data.avgTemperature === 'number') {
                    formattedData.avgTemperature = data.avgTemperature.toFixed(0);
                }
                
                // 组件级别特殊指标格式化
                if (typeof data.voltage === 'number') {
                    formattedData.voltage = data.voltage.toFixed(0);
                }
                if (typeof data.current === 'number') {
                    formattedData.current = data.current.toFixed(1);
                }
                if (typeof data.lubrication === 'number') {
                    formattedData.lubrication = data.lubrication.toFixed(1);
                }
                if (typeof data.wear === 'number') {
                    formattedData.wear = data.wear.toFixed(1);
                }
                if (typeof data.runningTime === 'number') {
                    formattedData.runningTime = data.runningTime.toFixed(0);
                }
                if (typeof data.oilPressure === 'number') {
                    formattedData.oilPressure = data.oilPressure.toFixed(2);
                }
                if (typeof data.oilTemperature === 'number') {
                    formattedData.oilTemperature = data.oilTemperature.toFixed(1);
                }
                if (typeof data.flameTemperature === 'number') {
                    formattedData.flameTemperature = data.flameTemperature.toFixed(0);
                }
                if (typeof data.fuelPressure === 'number') {
                    formattedData.fuelPressure = data.fuelPressure.toFixed(2);
                }
                if (typeof data.airPressure === 'number') {
                    formattedData.airPressure = data.airPressure.toFixed(1);
                }
                if (typeof data.fuelFlow === 'number') {
                    formattedData.fuelFlow = data.fuelFlow.toFixed(1);
                }
                if (typeof data.shellTemperature === 'number') {
                    formattedData.shellTemperature = data.shellTemperature.toFixed(0);
                }
                if (typeof data.thickness === 'number') {
                    formattedData.thickness = data.thickness.toFixed(1);
                }
                if (typeof data.runoutValue === 'number') {
                    formattedData.runoutValue = data.runoutValue.toFixed(1);
                }
                if (typeof data.rotationSpeed === 'number') {
                    formattedData.rotationSpeed = data.rotationSpeed.toFixed(1);
                }
                
                return formattedData;
            }
            
            return {
                name: '未知设备',
                temperature: '25.0',
                pressure: '1.0',
                speed: 0,
                efficiency: '0.0',
                power: 0,
                vibration: '0.0',
                status: '未知'
            };
        }

        // 应用模拟参数
        function applySimulationParams(data) {
            const temp = parseFloat(data.temperature);
            const pressure = parseFloat(data.pressure);
            const speed = parseInt(data.speed);
            const efficiency = parseFloat(data.efficiency);
            const power = parseInt(data.power);
            const vibration = parseFloat(data.vibration);
            
            return {
                name: data.name,
                temperature: (temp * (1 + (simulationParams.loadFactor - 1) * 0.3)).toFixed(1),
                pressure: (pressure * simulationParams.loadFactor).toFixed(1),
                speed: Math.round(speed * simulationParams.loadFactor * simulationParams.efficiencyFactor),
                efficiency: (efficiency * simulationParams.efficiencyFactor * simulationParams.qualityFactor).toFixed(1),
                power: Math.round(power * simulationParams.loadFactor),
                vibration: (vibration * (2 - simulationParams.efficiencyFactor)).toFixed(1),
                status: data.status
            };
        }

        // 获取当前历史时间
        function getCurrentHistoryTime() {
            const dateInput = document.getElementById('history-date');
            const startTimeInput = document.getElementById('history-time-start');
            const endTimeInput = document.getElementById('history-time-end');
            
            const date = dateInput ? dateInput.value : '2024-01-15';
            const startTime = startTimeInput ? startTimeInput.value : '08:00';
            const endTime = endTimeInput ? endTimeInput.value : '18:00';
            
            return `${date} ${startTime}-${endTime}`;
        }

        // 初始化图标按钮工具提示
        function initIconButtonTooltips() {
            const globalTooltip = document.getElementById('global-tooltip');
            const iconButtons = document.querySelectorAll('.icon-button');
            
            iconButtons.forEach(button => {
                button.addEventListener('mouseenter', function(e) {
                    const tooltipText = this.getAttribute('data-tooltip');
                    if (tooltipText && globalTooltip) {
                        const rect = this.getBoundingClientRect();
                        const tooltipX = rect.left + rect.width / 2;
                        const tooltipY = rect.bottom + 8;
                        
                        globalTooltip.textContent = tooltipText;
                        globalTooltip.style.left = tooltipX + 'px';
                        globalTooltip.style.top = tooltipY + 'px';
                        globalTooltip.classList.add('show');
                    }
                });
                
                button.addEventListener('mouseleave', function() {
                    if (globalTooltip) {
                        globalTooltip.classList.remove('show');
                    }
                });
            });
            
            // 窗口大小改变时隐藏工具提示
            window.addEventListener('resize', function() {
                if (globalTooltip) {
                    globalTooltip.classList.remove('show');
                }
            });
            
            // 页面滚动时隐藏工具提示
            window.addEventListener('scroll', function() {
                if (globalTooltip) {
                    globalTooltip.classList.remove('show');
                }
            });
            
            // 点击页面时隐藏工具提示
            document.addEventListener('click', function(e) {
                if (globalTooltip && !e.target.closest('.icon-button')) {
                    globalTooltip.classList.remove('show');
                }
            });
        }

        // 初始化告警系统
        function initAlarmSystem() {
            const alarmModal = document.getElementById('alarm-modal');
            const alarmToggle = document.getElementById('alarm-toggle');
            const alarmClose = document.getElementById('alarm-close');
            
            // 打开告警弹框
            alarmToggle.addEventListener('click', function(e) {
                e.stopPropagation();
                showAlarmModal();
            });
            
            // 关闭告警弹框
            alarmClose.addEventListener('click', function() {
                hideAlarmModal();
            });
            
            // 点击背景关闭
            alarmModal.addEventListener('click', function(e) {
                if (e.target === alarmModal) {
                    hideAlarmModal();
                }
            });
            
            // ESC键关闭
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && alarmModal.classList.contains('show')) {
                    hideAlarmModal();
                }
            });
            
            // 告警级别过滤
            document.querySelectorAll('.alarm-stat').forEach(stat => {
                stat.addEventListener('click', function() {
                    const filterLevel = this.getAttribute('data-filter');
                    setAlarmFilter(filterLevel);
                });
            });
            
            // 初始化告警数据显示
            updateAlarmDisplay();
        }

        // 显示告警弹框
        function showAlarmModal() {
            const alarmModal = document.getElementById('alarm-modal');
            const globalTooltip = document.getElementById('global-tooltip');
            
            // 隐藏工具提示
            if (globalTooltip) {
                globalTooltip.classList.remove('show');
            }
            
            generateAlarmList();
            alarmModal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        // 隐藏告警弹框
        function hideAlarmModal() {
            const alarmModal = document.getElementById('alarm-modal');
            alarmModal.classList.remove('show');
            document.body.style.overflow = '';
        }

        // 更新告警显示
        function updateAlarmDisplay() {
            const alarmStats = getAlarmStats();
            
            // 更新告警按钮数量
            const alarmCount = document.getElementById('alarm-count');
            if (alarmCount) {
                alarmCount.textContent = alarmStats.total;
            }
            
            // 更新统计数量
            const highCount = document.getElementById('high-alarm-count');
            const mediumCount = document.getElementById('medium-alarm-count');
            const lowCount = document.getElementById('low-alarm-count');
            
            if (highCount) highCount.textContent = alarmStats.high;
            if (mediumCount) mediumCount.textContent = alarmStats.medium;
            if (lowCount) lowCount.textContent = alarmStats.low;
        }

        // 获取告警统计
        function getAlarmStats() {
            const stats = { high: 0, medium: 0, low: 0, total: 0 };
            
            alarmData.forEach(alarm => {
                if (alarm.status === 'active') {
                    stats[alarm.level]++;
                    stats.total++;
                }
            });
            
            return stats;
        }

        // 生成告警列表
        function generateAlarmList() {
            const alarmList = document.getElementById('alarm-list');
            if (!alarmList) return;
            
            // 过滤告警数据
            let filteredAlarms = alarmData.filter(alarm => alarm.status === 'active');
            if (currentAlarmFilter) {
                filteredAlarms = filteredAlarms.filter(alarm => alarm.level === currentAlarmFilter);
            }
            
            // 按时间戳倒序排列（最新的在前）
            const sortedAlarms = filteredAlarms.sort((a, b) => b.timestamp - a.timestamp);
            
            if (sortedAlarms.length === 0) {
                alarmList.innerHTML = `
                    <div style="padding: 40px 20px; text-align: center; color: #888;">
                        ${currentAlarmFilter ? '该级别暂无告警' : '暂无告警'}
                    </div>
                `;
                return;
            }
            
            alarmList.innerHTML = sortedAlarms.map(alarm => `
                <div class="alarm-item" data-alarm-id="${alarm.id}">
                    <div class="alarm-item-level ${alarm.level}"></div>
                    <div class="alarm-item-content" onclick="navigateToAlarmDevice('${alarm.deviceId}')">
                        <div class="alarm-item-title">${alarm.title}</div>
                        <div class="alarm-item-desc">${alarm.deviceName} - ${alarm.description}</div>
                    </div>
                    <div class="alarm-item-time">${alarm.time}</div>
                    <div class="alarm-actions">
                        <button class="alarm-action-btn alarm-action-handle" onclick="handleAlarmAction('${alarm.id}', 'handle')">处理</button>
                        <button class="alarm-action-btn alarm-action-forward" onclick="handleAlarmAction('${alarm.id}', 'forward')">转发</button>
                        <button class="alarm-action-btn alarm-action-ignore" onclick="handleAlarmAction('${alarm.id}', 'ignore')">忽略</button>
                    </div>
                </div>
            `).join('');
        }

        // 导航到告警设备
        function navigateToAlarmDevice(deviceId) {
            // 关闭告警弹框
            hideAlarmModal();
            
            // 使用统一的节点切换函数
            const success = switchToNode(deviceId, 'alarm_click');
            
            if (success) {
                // 显示成功提示
                showNotification(`已切换到告警设备：${getDeviceDisplayName(deviceId)}`, 'success');
            } else {
                showNotification('设备未找到', 'error');
            }
        }

        // 设置告警过滤
        function setAlarmFilter(level) {
            const alarmStats = document.querySelectorAll('.alarm-stat');
            const filterTip = document.getElementById('alarm-filter-tip');
            const filterText = document.getElementById('filter-text');
            
            // 清除所有激活状态
            alarmStats.forEach(stat => stat.classList.remove('active'));
            
            if (currentAlarmFilter === level) {
                // 如果点击当前激活的过滤器，则取消过滤
                currentAlarmFilter = null;
                filterTip.classList.remove('show');
            } else {
                // 设置新的过滤器
                currentAlarmFilter = level;
                const activeStat = document.querySelector(`[data-filter="${level}"]`);
                if (activeStat) {
                    activeStat.classList.add('active');
                }
                
                const levelNames = {
                    'high': '高级告警',
                    'medium': '中级告警',
                    'low': '低级告警'
                };
                
                filterText.textContent = levelNames[level];
                filterTip.classList.add('show');
            }
            
            // 重新生成告警列表
            generateAlarmList();
        }

        // 清除告警过滤
        function clearAlarmFilter() {
            currentAlarmFilter = null;
            document.querySelectorAll('.alarm-stat').forEach(stat => stat.classList.remove('active'));
            document.getElementById('alarm-filter-tip').classList.remove('show');
            generateAlarmList();
        }

        // 处理告警操作
        function handleAlarmAction(alarmId, action) {
            const alarm = alarmData.find(a => a.id === alarmId);
            if (!alarm) return;
            
            let actionText = '';
            let newStatus = 'active';
            
            switch (action) {
                case 'handle':
                    actionText = '处理';
                    newStatus = 'handled';
                    break;
                case 'forward':
                    actionText = '转发';
                    // 这里可以打开转发对话框
                    showNotification(`告警"${alarm.title}"已转发`, 'success');
                    return;
                case 'ignore':
                    actionText = '忽略';
                    newStatus = 'ignored';
                    break;
            }
            
            // 更新告警状态
            alarm.status = newStatus;
            
            // 更新显示
            updateAlarmDisplay();
            generateAlarmList();
            
            // 显示操作结果
            showNotification(`告警"${alarm.title}"已${actionText}`, 'success');
        }

        // 获取设备显示名称
        function getDeviceDisplayName(deviceId) {
            const deviceNames = {
                'crusher-motor': '颚式破碎机电机',
                'crusher-bearing': '颚式破碎机轴承',
                'crusher-1': '颚式破碎机',
                'ball-mill': '球磨机',
                'mill-motor': '球磨机主电机',
                'mill-gearbox': '球磨机减速器',
                'rotary-kiln': '回转窑',
                'crushing-workshop': '破碎工段',
                'grinding-workshop': '粉磨工段',
                'burning-workshop': '煅烧工段'
            };
            return deviceNames[deviceId] || deviceId;
        }

        // 全屏视图切换
        let isFullscreenView = false;
        function toggleFullscreenView() {
            const leftPanel = document.getElementById('metrics-panel');
            const rightPanel = document.getElementById('right-metrics-panel');
            const expandButton = document.getElementById('expand-toggle');
            const globalTooltip = document.getElementById('global-tooltip');
            
            isFullscreenView = !isFullscreenView;
            
            // 隐藏工具提示
            if (globalTooltip) {
                globalTooltip.classList.remove('show');
            }
            
            if (isFullscreenView) {
                // 隐藏左右面板
                leftPanel.style.display = 'none';
                rightPanel.style.display = 'none';
                expandButton.textContent = '⤡';
                expandButton.classList.add('active');
                expandButton.setAttribute('data-tooltip', '退出全屏');
            } else {
                // 显示左右面板
                leftPanel.style.display = 'block';
                rightPanel.style.display = 'block';
                expandButton.textContent = '⤢';
                expandButton.classList.remove('active');
                expandButton.setAttribute('data-tooltip', '全屏视图');
            }
        }

        // 获取节点指标数据 (保留兼容性)
        function getNodeMetrics(nodeId) {
            const deviceData = getEnhancedDeviceData(nodeId);
            return [
                { label: '温度', value: deviceData.temperature, unit: '°C' },
                { label: '压力', value: deviceData.pressure, unit: ' MPa' },
                { label: '效率', value: deviceData.efficiency, unit: '%' },
                { label: '功率', value: deviceData.power, unit: ' kW' }
            ];
        }

        // 安全的数值格式化函数
        function safeFormat(value, decimals = 1) {
            if (typeof value === 'number' && !isNaN(value)) {
                return decimals === 0 ? Math.round(value).toString() : value.toFixed(decimals);
            } else if (typeof value === 'string' && !isNaN(parseFloat(value))) {
                const num = parseFloat(value);
                return decimals === 0 ? Math.round(num).toString() : num.toFixed(decimals);
            }
            return value ? value.toString() : '0';
        }

        // 统一的节点切换函数 - 处理所有切换场景
        function switchToNode(nodeId, source = 'unknown') {
            try {
                console.log(`从${source}切换到节点:`, nodeId);
                
                // 检查节点ID是否有效
                if (!nodeId || typeof nodeId !== 'string') {
                    console.warn('无效的节点ID:', nodeId);
                    return false;
                }
                
                // 获取节点数据
                const deviceData = getEnhancedDeviceData(nodeId);
                if (!deviceData || !deviceData.name) {
                    console.warn('未找到节点数据:', nodeId);
                    // 如果找不到数据，使用默认的工厂数据
                    if (nodeId !== 'cement-factory') {
                        return switchToNode('cement-factory', 'fallback');
                    }
                    return false;
                }
                
                // 更新全局选中节点
                selectedNode = {
                    id: nodeId,
                    level: deviceData.level || 'unknown',
                    name: deviceData.name || nodeId
                };
                
                // 1. 更新树形结构选中状态
                try {
                    updateTreeSelection(nodeId);
                } catch (e) {
                    console.warn('更新树形结构失败:', e);
                }
                
                // 2. 更新下拉框显示
                try {
                    const selectedAssetSpan = document.getElementById('selected-asset');
                    if (selectedAssetSpan) {
                        selectedAssetSpan.textContent = deviceData.name;
                    }
                } catch (e) {
                    console.warn('更新下拉框显示失败:', e);
                }
                
                // 3. 更新面包屑导航
                try {
                    updateBreadcrumb();
                } catch (e) {
                    console.warn('更新面包屑失败:', e);
                }
                
                // 4. 更新左侧指标面板
                try {
                    updateMetricsForNode(nodeId);
                } catch (e) {
                    console.warn('更新左侧指标面板失败:', e);
                }
                
                // 5. 更新右侧系统概览面板
                try {
                    updateRightMetricsPanel();
                } catch (e) {
                    console.warn('更新右侧系统概览面板失败:', e);
                }
                
                // 6. 更新3D视图
                try {
                    if (scene && camera) {
                        update3DViewForNode(nodeId);
                    }
                } catch (e) {
                    console.warn('更新3D视图失败:', e);
                }
                
                // 7. 更新2D视图
                try {
                    if (document.getElementById('svg-canvas')) {
                        update2DViewForNode(nodeId);
                    }
                } catch (e) {
                    console.warn('更新2D视图失败:', e);
                }
                
                // 8. 如果是告警节点，自动放大/聚焦
                try {
                    const treeNode = document.querySelector(`[data-id="${nodeId}"]`);
                    if (treeNode && (treeNode.classList.contains('alarm-low') || 
                        treeNode.classList.contains('alarm-medium') || 
                        treeNode.classList.contains('alarm-high'))) {
                        zoomToNode(selectedNode);
                    }
                } catch (e) {
                    console.warn('放大告警节点失败:', e);
                }
                
                // 9. 关闭下拉框（如果是从下拉框切换的）
                try {
                    const dropdownContent = document.getElementById('tree-dropdown-content');
                    if (dropdownContent) {
                        dropdownContent.classList.remove('show');
                    }
                } catch (e) {
                    console.warn('关闭下拉框失败:', e);
                }
                
                console.log('节点切换完成:', selectedNode);
                return true;
                
            } catch (error) {
                console.error('节点切换过程中发生错误:', error);
                console.error('错误发生在节点:', nodeId, '来源:', source);
                
                // 如果不是工厂节点，尝试回退到工厂节点
                if (nodeId !== 'cement-factory') {
                    console.log('尝试回退到工厂节点...');
                    return switchToNode('cement-factory', 'error_fallback');
                }
                
                return false;
            }
        }

        // 更新3D视图以显示指定节点
        function update3DViewForNode(nodeId) {
            // 重置所有对象的可见性
            scene.traverse((child) => {
                if (child.userData && child.userData.id) {
                    child.visible = true;
                }
            });
            
            // 聚焦到目标节点
            focusOn3DNode(nodeId);
        }

        // 更新2D视图以显示指定节点
        function update2DViewForNode(nodeId) {
            const deviceData = getEnhancedDeviceData(nodeId);
            
            switch(deviceData.level) {
                case 'factory':
                    // 显示工厂总览
                    init2DView();
                    break;
                case 'workshop':
                    // 显示工段详情
                    generate2DWorkshopDetail(nodeId);
                    break;
                case 'equipment':
                    // 显示设备详情
                    generate2DEquipmentDetail(nodeId);
                    break;
                case 'component':
                    // 显示组件详情
                    generate2DComponentDetail(nodeId);
                    break;
                default:
                    // 默认显示工厂总览
                    init2DView();
                    break;
            }
        }

        // 更新视图 (保留兼容性)
        function updateView() {
            if (selectedNode) {
                console.log('更新视图:', selectedNode);
                // 调用统一的切换函数
                switchToNode(selectedNode.id, 'view_update');
            }
        }

        // 更新面包屑导航
        function updateBreadcrumb() {
            const breadcrumbContent = document.querySelector('.breadcrumb-content');
            if (selectedNode && breadcrumbContent) {
                // 根据当前选中节点生成面包屑路径
                const breadcrumbPath = generateBreadcrumbPath(selectedNode.id);
                breadcrumbContent.innerHTML = breadcrumbPath.map((item, index) => 
                    `<span class="breadcrumb-item" data-id="${item.id}">${item.name}</span>` +
                    (index < breadcrumbPath.length - 1 ? '<span class="breadcrumb-separator">></span>' : '')
                ).join('');
            }
        }

        // 生成面包屑路径
        function generateBreadcrumbPath(nodeId) {
            const path = [];
            
            // 始终包含工厂根节点
            path.push({ id: 'cement-factory', name: '水泥工厂' });
            
            if (nodeId === 'cement-factory') {
                return path;
            }
            
            // 根据nodeId确定层级路径
            const deviceData = getEnhancedDeviceData(nodeId);
            if (!deviceData) return path;
            
            // 根据不同层级添加父级路径
            switch(deviceData.level) {
                case 'workshop':
                    path.push({ id: nodeId, name: deviceData.name });
                    break;
                    
                case 'equipment':
                    // 添加所属工段
                    if (nodeId.includes('crusher') || nodeId.includes('conveyor')) {
                        path.push({ id: 'crushing-workshop', name: '破碎工段' });
                    } else if (nodeId.includes('ball-mill') || nodeId.includes('separator')) {
                        path.push({ id: 'grinding-workshop', name: '粉磨工段' });
                    } else if (nodeId.includes('rotary-kiln')) {
                        path.push({ id: 'burning-workshop', name: '煅烧工段' });
                    }
                    path.push({ id: nodeId, name: deviceData.name });
                    break;
                    
                case 'component':
                    // 添加所属工段和设备
                    if (nodeId.includes('crusher')) {
                        path.push({ id: 'crushing-workshop', name: '破碎工段' });
                        path.push({ id: 'crusher-1', name: '颚式破碎机' });
                    } else if (nodeId.includes('mill')) {
                        path.push({ id: 'grinding-workshop', name: '粉磨工段' });
                        path.push({ id: 'ball-mill', name: '球磨机' });
                    } else if (nodeId.includes('kiln')) {
                        path.push({ id: 'burning-workshop', name: '煅烧工段' });
                        path.push({ id: 'rotary-kiln', name: '回转窑' });
                    }
                    path.push({ id: nodeId, name: deviceData.name });
                    break;
            }
            
            return path;
        }

        // 根据下钻路径生成面包屑
        function generateBreadcrumbFromDrillPath() {
            const breadcrumbPath = [];
            
            // 总是从工厂开始
            if (drillPath.length === 0 || drillPath[0] !== 'cement-factory') {
                breadcrumbPath.push({ id: 'cement-factory', name: '水泥工厂' });
            }
            
            // 添加下钻路径中的节点
            drillPath.forEach(nodeId => {
                const node = assetHierarchy[nodeId];
                if (node) {
                    breadcrumbPath.push({ id: nodeId, name: node.name });
                }
            });
            
            return breadcrumbPath;
        }

        // 获取面包屑路径
        function getBreadcrumbPath(node) {
            const paths = {
                'cement-factory': [{ id: 'cement-factory', name: '水泥工厂' }],
                'crushing-workshop': [
                    { id: 'cement-factory', name: '水泥工厂' },
                    { id: 'crushing-workshop', name: '破碎工段' }
                ],
                'grinding-workshop': [
                    { id: 'cement-factory', name: '水泥工厂' },
                    { id: 'grinding-workshop', name: '粉磨工段' }
                ],
                'calcining-workshop': [
                    { id: 'cement-factory', name: '水泥工厂' },
                    { id: 'calcining-workshop', name: '煅烧工段' }
                ],
                'crusher-1': [
                    { id: 'cement-factory', name: '水泥工厂' },
                    { id: 'crushing-workshop', name: '破碎工段' },
                    { id: 'crusher-1', name: '颚式破碎机 #1' }
                ],
                'ball-mill': [
                    { id: 'cement-factory', name: '水泥工厂' },
                    { id: 'grinding-workshop', name: '粉磨工段' },
                    { id: 'ball-mill', name: '球磨机' }
                ],
                'rotary-kiln': [
                    { id: 'cement-factory', name: '水泥工厂' },
                    { id: 'calcining-workshop', name: '煅烧工段' },
                    { id: 'rotary-kiln', name: '回转窑' }
                ],
                'cement-mill': [
                    { id: 'cement-factory', name: '水泥工厂' },
                    { id: 'grinding-workshop', name: '粉磨工段' },
                    { id: 'cement-mill', name: '水泥磨' }
                ],
                'crusher-motor': [
                    { id: 'cement-factory', name: '水泥工厂' },
                    { id: 'crushing-workshop', name: '破碎工段' },
                    { id: 'crusher-1', name: '颚式破碎机 #1' },
                    { id: 'crusher-motor', name: '驱动电机' }
                ],
                'crusher-bearing': [
                    { id: 'cement-factory', name: '水泥工厂' },
                    { id: 'crushing-workshop', name: '破碎工段' },
                    { id: 'crusher-1', name: '颚式破碎机 #1' },
                    { id: 'crusher-bearing', name: '轴承' }
                ],
                'ball-mill-motor': [
                    { id: 'cement-factory', name: '水泥工厂' },
                    { id: 'grinding-workshop', name: '粉磨工段' },
                    { id: 'ball-mill', name: '球磨机' },
                    { id: 'ball-mill-motor', name: '主电机' }
                ]
            };
            
            return paths[node.id] || [{ id: node.id, name: node.name || node.id }];
        }

        // 导航到指定节点
        function navigateToNode(nodeId) {
            console.log('导航到节点:', nodeId);
            
            // 更新选中节点
            const treeNode = document.querySelector(`[data-id="${nodeId}"]`);
            if (treeNode) {
                // 移除所有选中状态
                document.querySelectorAll('.tree-node').forEach(node => {
                    node.classList.remove('selected');
                });
                
                // 添加选中状态
                treeNode.classList.add('selected');
                
                // 展开父节点
                expandParentNodes(treeNode);
                
                // 更新选中节点
                selectedNode = { id: nodeId, name: treeNode.textContent.trim() };
                
                // 更新面包屑
                updateBreadcrumb();
                
                // 更新视图 - 自动聚焦到选中节点
                focusOnNode(nodeId);
                
                // 更新指标面板
                updateMetricsForNode(nodeId);
            }
        }

        // 展开父节点
        function expandParentNodes(node) {
            let parent = node.parentElement;
            while (parent) {
                if (parent.classList && parent.classList.contains('tree-children')) {
                    parent.style.display = 'block';
                    // 找到对应的父节点并标记为展开
                    const parentNode = parent.previousElementSibling;
                    if (parentNode && parentNode.querySelector('.tree-toggle')) {
                        parentNode.querySelector('.tree-toggle').textContent = '−';
                    }
                }
                parent = parent.parentElement;
            }
        }

        // 聚焦到指定节点
        function focusOnNode(nodeId) {
            if (currentView === '3d') {
                focusOn3DNode(nodeId);
            } else {
                focusOn2DNode(nodeId);
            }
        }

        // 3D视图聚焦
        function focusOn3DNode(nodeId) {
            // 尝试多种方式找到对象
            let targetObject = scene.children.find(child => 
                child.userData && child.userData.id === nodeId
            );
            
            // 如果直接找不到，尝试递归查找
            if (!targetObject) {
                scene.traverse(child => {
                    if (child.userData && child.userData.id === nodeId && !targetObject) {
                        targetObject = child;
                    }
                });
            }
            
            if (targetObject && camera && controls) {
                // 计算目标位置
                const box = new THREE.Box3().setFromObject(targetObject);
                const center = box.getCenter(new THREE.Vector3());
                const size = box.getSize(new THREE.Vector3());
                
                // 根据层级调整相机距离
                const node = assetHierarchy[nodeId];
                let distanceMultiplier = 2;
                
                if (node) {
                    switch (node.type) {
                        case 'factory':
                            distanceMultiplier = 3;
                            break;
                        case 'workshop':
                            distanceMultiplier = 2;
                            break;
                        case 'equipment':
                            distanceMultiplier = 1.5;
                            break;
                        case 'component':
                            distanceMultiplier = 1;
                            break;
                    }
                }
                
                // 设置相机位置
                const maxDim = Math.max(size.x, size.y, size.z);
                const fov = camera.fov * (Math.PI / 180);
                let cameraZ = Math.abs(maxDim / 2 / Math.tan(fov / 2));
                
                cameraZ *= distanceMultiplier; // 根据层级调整距离
                cameraZ = Math.max(cameraZ, 10); // 最小距离
                
                // 平滑动画到目标位置
                animateCamera(
                    camera.position,
                    new THREE.Vector3(center.x, center.y, center.z + cameraZ),
                    center
                );
            } else {
                console.warn(`无法找到节点 ${nodeId} 对应的3D对象`);
            }
        }

        // 2D视图聚焦
        function focusOn2DNode(nodeId) {
            const svgElement = document.querySelector(`#svg-container rect[id="${nodeId}"]`);
            if (svgElement) {
                const rect = svgElement.getBoundingClientRect();
                const container = document.getElementById('svg-container');
                
                // 滚动到目标元素
                container.scrollTo({
                    left: rect.left - container.offsetWidth / 2,
                    top: rect.top - container.offsetHeight / 2,
                    behavior: 'smooth'
                });
                
                // 高亮显示
                svgElement.style.stroke = '#0078d4';
                svgElement.style.strokeWidth = '3';
                
                // 2秒后恢复
                setTimeout(() => {
                    svgElement.style.stroke = '#333';
                    svgElement.style.strokeWidth = '1';
                }, 2000);
            }
        }

        // 相机动画
        function animateCamera(startPos, endPos, lookAt) {
            const duration = 1000; // 1秒
            const startTime = Date.now();
            
            function animate() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // 使用easeInOutCubic缓动函数
                const eased = progress < 0.5 
                    ? 4 * progress * progress * progress
                    : 1 - Math.pow(-2 * progress + 2, 3) / 2;
                
                // 插值计算当前位置
                camera.position.lerpVectors(startPos, endPos, eased);
                
                // 更新控制器目标
                if (controls) {
                    controls.target.copy(lookAt);
                    controls.update();
                }
                
                if (progress < 1) {
                    requestAnimationFrame(animate);
                }
            }
            
            animate();
        }

        // 更新节点指标
        function updateMetricsForNode(nodeId) {
            const deviceData = getEnhancedDeviceData(nodeId);
            
            // 更新左侧指标面板
            const metricsPanel = document.getElementById('metrics-panel');
            if (metricsPanel) {
                const statusAbnormal = deviceData.status === '告警' ? ' abnormal' : '';
                
                let metricsHTML = `
                    <div class="sidebar-header">
                        <h3>${deviceData.name}</h3>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">运行状态</div>
                        <div class="metric-value${statusAbnormal}">${deviceData.status}</div>
                    </div>
                `;

                // 根据设备层级显示不同指标
                switch(deviceData.level) {
                    case 'factory':
                        const prodAbnormal = isMetricAbnormal('totalProduction', deviceData.totalProduction, nodeId) ? ' abnormal' : '';
                        const overallEffAbnormal = isMetricAbnormal('overallEfficiency', deviceData.overallEfficiency, nodeId) ? ' abnormal' : '';
                        const totalPowerAbnormal = isMetricAbnormal('totalPower', deviceData.totalPower, nodeId) ? ' abnormal' : '';
                        const onlineEquipAbnormal = isMetricAbnormal('onlineEquipment', deviceData.onlineEquipment, nodeId) ? ' abnormal' : '';
                        const alarmCountAbnormal = isMetricAbnormal('alarmCount', deviceData.alarmCount, nodeId) ? ' abnormal' : '';

                        metricsHTML += `
                            <div class="metric-item">
                                <div class="metric-label">总产量</div>
                                <div class="metric-value${prodAbnormal}">${safeFormat(deviceData.totalProduction, 0)}<span class="metric-unit">t</span></div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">整体效率</div>
                                <div class="metric-value${overallEffAbnormal}">${safeFormat(deviceData.overallEfficiency, 1)}<span class="metric-unit">%</span></div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">总功率</div>
                                <div class="metric-value${totalPowerAbnormal}">${safeFormat(deviceData.totalPower, 0)}<span class="metric-unit">kW</span></div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">在线设备</div>
                                <div class="metric-value${onlineEquipAbnormal}">${safeFormat(deviceData.onlineEquipment, 0)}/${safeFormat(deviceData.totalEquipment, 0)}<span class="metric-unit">台</span></div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">告警数量</div>
                                <div class="metric-value${alarmCountAbnormal}">${safeFormat(deviceData.alarmCount, 0)}<span class="metric-unit">项</span></div>
                            </div>
                        `;
                        break;

                    case 'workshop':
                        const workshopEffAbnormal = isMetricAbnormal('workshopEfficiency', deviceData.workshopEfficiency, nodeId) ? ' abnormal' : '';
                        const workshopPowerAbnormal = isMetricAbnormal('workshopPower', deviceData.workshopPower, nodeId) ? ' abnormal' : '';
                        const throughputAbnormal = isMetricAbnormal('materialThroughput', deviceData.materialThroughput, nodeId) ? ' abnormal' : '';
                        const avgVibrationAbnormal = isMetricAbnormal('avgVibration', deviceData.avgVibration, nodeId) ? ' abnormal' : '';

                        metricsHTML += `
                            <div class="metric-item">
                                <div class="metric-label">工段效率</div>
                                <div class="metric-value${workshopEffAbnormal}">${safeFormat(deviceData.workshopEfficiency, 1)}<span class="metric-unit">%</span></div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">工段功率</div>
                                <div class="metric-value${workshopPowerAbnormal}">${safeFormat(deviceData.workshopPower, 0)}<span class="metric-unit">kW</span></div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">物料处理量</div>
                                <div class="metric-value${throughputAbnormal}">${safeFormat(deviceData.materialThroughput, 1)}<span class="metric-unit">t/h</span></div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">设备状态</div>
                                <div class="metric-value">${safeFormat(deviceData.runningCount, 0)}/${safeFormat(deviceData.equipmentCount, 0)}<span class="metric-unit">台运行</span></div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">平均振动</div>
                                <div class="metric-value${avgVibrationAbnormal}">${safeFormat(deviceData.avgVibration, 1)}<span class="metric-unit">mm/s</span></div>
                            </div>
                        `;

                        // 煅烧工段特殊显示平均温度
                        if (deviceData.avgTemperature) {
                            const avgTempAbnormal = isMetricAbnormal('avgTemperature', deviceData.avgTemperature, nodeId) ? ' abnormal' : '';
                            metricsHTML += `
                                <div class="metric-item">
                                    <div class="metric-label">平均温度</div>
                                    <div class="metric-value${avgTempAbnormal}">${safeFormat(deviceData.avgTemperature, 0)}<span class="metric-unit">°C</span></div>
                                </div>
                            `;
                        }
                        break;

                    case 'equipment':
                        const tempAbnormal = isMetricAbnormal('temperature', deviceData.temperature, nodeId) ? ' abnormal' : '';
                        const pressureAbnormal = isMetricAbnormal('pressure', deviceData.pressure, nodeId) ? ' abnormal' : '';
                        const speedAbnormal = isMetricAbnormal('speed', deviceData.speed, nodeId) ? ' abnormal' : '';
                        const efficiencyAbnormal = isMetricAbnormal('efficiency', deviceData.efficiency, nodeId) ? ' abnormal' : '';
                        const powerAbnormal = isMetricAbnormal('power', deviceData.power, nodeId) ? ' abnormal' : '';
                        const vibrationAbnormal = isMetricAbnormal('vibration', deviceData.vibration, nodeId) ? ' abnormal' : '';

                        metricsHTML += `
                            <div class="metric-item">
                                <div class="metric-label">温度</div>
                                <div class="metric-value${tempAbnormal}">${safeFormat(deviceData.temperature, 1)}<span class="metric-unit">°C</span></div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">压力</div>
                                <div class="metric-value${pressureAbnormal}">${safeFormat(deviceData.pressure, 1)}<span class="metric-unit">MPa</span></div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">转速</div>
                                <div class="metric-value${speedAbnormal}">${safeFormat(deviceData.speed, 0)}<span class="metric-unit">rpm</span></div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">效率</div>
                                <div class="metric-value${efficiencyAbnormal}">${safeFormat(deviceData.efficiency, 1)}<span class="metric-unit">%</span></div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">功率</div>
                                <div class="metric-value${powerAbnormal}">${safeFormat(deviceData.power, 0)}<span class="metric-unit">kW</span></div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">振动</div>
                                <div class="metric-value${vibrationAbnormal}">${safeFormat(deviceData.vibration, 1)}<span class="metric-unit">mm/s</span></div>
                            </div>
                        `;
                        break;

                    case 'component':
                        // 根据不同组件显示特定指标
                        if (nodeId.includes('motor')) {
                            const voltageAbnormal = isMetricAbnormal('voltage', deviceData.voltage, nodeId) ? ' abnormal' : '';
                            const currentAbnormal = isMetricAbnormal('current', deviceData.current, nodeId) ? ' abnormal' : '';
                            const tempAbnormal = isMetricAbnormal('temperature', deviceData.temperature, nodeId) ? ' abnormal' : '';
                            const powerAbnormal = isMetricAbnormal('power', deviceData.power, nodeId) ? ' abnormal' : '';
                            const efficiencyAbnormal = isMetricAbnormal('efficiency', deviceData.efficiency, nodeId) ? ' abnormal' : '';
                            const vibrationAbnormal = isMetricAbnormal('vibration', deviceData.vibration, nodeId) ? ' abnormal' : '';

                            metricsHTML += `
                                <div class="metric-item">
                                    <div class="metric-label">电压</div>
                                    <div class="metric-value${voltageAbnormal}">${safeFormat(deviceData.voltage, 0)}<span class="metric-unit">V</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">电流</div>
                                    <div class="metric-value${currentAbnormal}">${safeFormat(deviceData.current, 1)}<span class="metric-unit">A</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">温度</div>
                                    <div class="metric-value${tempAbnormal}">${safeFormat(deviceData.temperature, 1)}<span class="metric-unit">°C</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">功率</div>
                                    <div class="metric-value${powerAbnormal}">${safeFormat(deviceData.power, 0)}<span class="metric-unit">kW</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">效率</div>
                                    <div class="metric-value${efficiencyAbnormal}">${safeFormat(deviceData.efficiency, 1)}<span class="metric-unit">%</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">振动</div>
                                    <div class="metric-value${vibrationAbnormal}">${safeFormat(deviceData.vibration, 1)}<span class="metric-unit">mm/s</span></div>
                                </div>
                            `;
                        } else if (nodeId.includes('bearing')) {
                            const tempAbnormal = isMetricAbnormal('temperature', deviceData.temperature, nodeId) ? ' abnormal' : '';
                            const lubricationAbnormal = isMetricAbnormal('lubrication', deviceData.lubrication, nodeId) ? ' abnormal' : '';
                            const vibrationAbnormal = isMetricAbnormal('vibration', deviceData.vibration, nodeId) ? ' abnormal' : '';
                            const wearAbnormal = isMetricAbnormal('wear', deviceData.wear, nodeId) ? ' abnormal' : '';
                            const runningTimeAbnormal = isMetricAbnormal('runningTime', deviceData.runningTime, nodeId) ? ' abnormal' : '';

                            metricsHTML += `
                                <div class="metric-item">
                                    <div class="metric-label">温度</div>
                                    <div class="metric-value${tempAbnormal}">${safeFormat(deviceData.temperature, 1)}<span class="metric-unit">°C</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">润滑状态</div>
                                    <div class="metric-value${lubricationAbnormal}">${safeFormat(deviceData.lubrication, 1)}<span class="metric-unit">%</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">振动</div>
                                    <div class="metric-value${vibrationAbnormal}">${safeFormat(deviceData.vibration, 1)}<span class="metric-unit">mm/s</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">磨损程度</div>
                                    <div class="metric-value${wearAbnormal}">${safeFormat(deviceData.wear, 1)}<span class="metric-unit">%</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">运行时间</div>
                                    <div class="metric-value${runningTimeAbnormal}">${safeFormat(deviceData.runningTime, 0)}<span class="metric-unit">h</span></div>
                                </div>
                            `;
                        } else if (nodeId.includes('gearbox')) {
                            const tempAbnormal = isMetricAbnormal('temperature', deviceData.temperature, nodeId) ? ' abnormal' : '';
                            const oilPressureAbnormal = isMetricAbnormal('oilPressure', deviceData.oilPressure, nodeId) ? ' abnormal' : '';
                            const oilTempAbnormal = isMetricAbnormal('oilTemperature', deviceData.oilTemperature, nodeId) ? ' abnormal' : '';
                            const vibrationAbnormal = isMetricAbnormal('vibration', deviceData.vibration, nodeId) ? ' abnormal' : '';
                            const efficiencyAbnormal = isMetricAbnormal('efficiency', deviceData.efficiency, nodeId) ? ' abnormal' : '';

                            metricsHTML += `
                                <div class="metric-item">
                                    <div class="metric-label">箱体温度</div>
                                    <div class="metric-value${tempAbnormal}">${safeFormat(deviceData.temperature, 1)}<span class="metric-unit">°C</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">油压</div>
                                    <div class="metric-value${oilPressureAbnormal}">${safeFormat(deviceData.oilPressure, 2)}<span class="metric-unit">MPa</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">油温</div>
                                    <div class="metric-value${oilTempAbnormal}">${safeFormat(deviceData.oilTemperature, 1)}<span class="metric-unit">°C</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">振动</div>
                                    <div class="metric-value${vibrationAbnormal}">${safeFormat(deviceData.vibration, 1)}<span class="metric-unit">mm/s</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">传动效率</div>
                                    <div class="metric-value${efficiencyAbnormal}">${safeFormat(deviceData.efficiency, 1)}<span class="metric-unit">%</span></div>
                                </div>
                            `;
                        } else if (nodeId.includes('burner')) {
                            const flameTempAbnormal = isMetricAbnormal('flameTemperature', deviceData.flameTemperature, nodeId) ? ' abnormal' : '';
                            const fuelPressureAbnormal = isMetricAbnormal('fuelPressure', deviceData.fuelPressure, nodeId) ? ' abnormal' : '';
                            const airPressureAbnormal = isMetricAbnormal('airPressure', deviceData.airPressure, nodeId) ? ' abnormal' : '';
                            const fuelFlowAbnormal = isMetricAbnormal('fuelFlow', deviceData.fuelFlow, nodeId) ? ' abnormal' : '';
                            const efficiencyAbnormal = isMetricAbnormal('efficiency', deviceData.efficiency, nodeId) ? ' abnormal' : '';

                            metricsHTML += `
                                <div class="metric-item">
                                    <div class="metric-label">火焰温度</div>
                                    <div class="metric-value${flameTempAbnormal}">${safeFormat(deviceData.flameTemperature, 0)}<span class="metric-unit">°C</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">燃料压力</div>
                                    <div class="metric-value${fuelPressureAbnormal}">${safeFormat(deviceData.fuelPressure, 2)}<span class="metric-unit">MPa</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">风压</div>
                                    <div class="metric-value${airPressureAbnormal}">${safeFormat(deviceData.airPressure, 1)}<span class="metric-unit">MPa</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">燃料流量</div>
                                    <div class="metric-value${fuelFlowAbnormal}">${safeFormat(deviceData.fuelFlow, 1)}<span class="metric-unit">m³/h</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">燃烧效率</div>
                                    <div class="metric-value${efficiencyAbnormal}">${safeFormat(deviceData.efficiency, 1)}<span class="metric-unit">%</span></div>
                                </div>
                            `;
                        } else if (nodeId.includes('cylinder')) {
                            const shellTempAbnormal = isMetricAbnormal('shellTemperature', deviceData.shellTemperature, nodeId) ? ' abnormal' : '';
                            const thicknessAbnormal = isMetricAbnormal('thickness', deviceData.thickness, nodeId) ? ' abnormal' : '';
                            const runoutAbnormal = isMetricAbnormal('runoutValue', deviceData.runoutValue, nodeId) ? ' abnormal' : '';
                            const vibrationAbnormal = isMetricAbnormal('vibration', deviceData.vibration, nodeId) ? ' abnormal' : '';
                            const rotationSpeedAbnormal = isMetricAbnormal('rotationSpeed', deviceData.rotationSpeed, nodeId) ? ' abnormal' : '';

                            metricsHTML += `
                                <div class="metric-item">
                                    <div class="metric-label">筒体表面温度</div>
                                    <div class="metric-value${shellTempAbnormal}">${safeFormat(deviceData.shellTemperature, 0)}<span class="metric-unit">°C</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">壁厚</div>
                                    <div class="metric-value${thicknessAbnormal}">${safeFormat(deviceData.thickness, 1)}<span class="metric-unit">mm</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">径向跳动</div>
                                    <div class="metric-value${runoutAbnormal}">${safeFormat(deviceData.runoutValue, 1)}<span class="metric-unit">mm</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">振动</div>
                                    <div class="metric-value${vibrationAbnormal}">${safeFormat(deviceData.vibration, 1)}<span class="metric-unit">mm/s</span></div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-label">转速</div>
                                    <div class="metric-value${rotationSpeedAbnormal}">${safeFormat(deviceData.rotationSpeed, 1)}<span class="metric-unit">rpm</span></div>
                                </div>
                            `;
                        }
                        break;

                    default:
                        // 默认显示通用指标
                        metricsHTML += `
                            <div class="metric-item">
                                <div class="metric-label">无可用指标</div>
                                <div class="metric-value">-</div>
                            </div>
                        `;
                        break;
                }

                metricsPanel.innerHTML = metricsHTML;
            }
            
            // 更新右侧系统概览面板
            updateRightMetricsPanel();
        }

        // 更新右侧指标面板
        function updateRightMetricsPanel() {
            const rightPanel = document.getElementById('right-metrics-panel');
            if (!rightPanel) return;
            
            // 根据当前模式生成不同的系统概览数据
            let systemData;
            switch(currentMode) {
                case 'realtime':
                    systemData = generateRealtimeSystemData();
                    break;
                case 'history':
                    systemData = generateHistorySystemData();
                    break;
                case 'simulation':
                    systemData = generateSimulationSystemData();
                    break;
                default:
                    systemData = generateRealtimeSystemData();
            }
            
            // 检测系统级指标是否异常
            const efficiencyAbnormal = isMetricAbnormal('overallEfficiency', systemData.overallEfficiency) ? ' abnormal' : '';
            const runtimeAbnormal = isMetricAbnormal('equipmentRuntime', systemData.equipmentRuntime) ? ' abnormal' : '';
            const energyAbnormal = isMetricAbnormal('avgEnergyConsumption', systemData.avgEnergyConsumption) ? ' abnormal' : '';
            const productionAbnormal = isMetricAbnormal('production', systemData.production) ? ' abnormal' : '';
            const alarmAbnormal = isMetricAbnormal('alarmCount', systemData.alarmCount) ? ' abnormal' : '';
            const onlineAbnormal = isMetricAbnormal('onlineDevices', systemData.onlineDevices) ? ' abnormal' : '';

            rightPanel.innerHTML = `
                <div class="sidebar-header">
                    <h3>系统概览 - ${getModeDisplayName(currentMode)}</h3>
                </div>
                <div class="metric-item">
                    <div class="metric-label">整体生产效率</div>
                    <div class="metric-value${efficiencyAbnormal}">${systemData.overallEfficiency}<span class="metric-unit">%</span></div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">设备总运行率</div>
                    <div class="metric-value${runtimeAbnormal}">${systemData.equipmentRuntime}<span class="metric-unit">%</span></div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">平均能耗</div>
                    <div class="metric-value${energyAbnormal}">${systemData.avgEnergyConsumption}<span class="metric-unit">kWh/t</span></div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">${systemData.productionLabel}</div>
                    <div class="metric-value${productionAbnormal}">${systemData.production}<span class="metric-unit">t</span></div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">告警数量</div>
                    <div class="metric-value${alarmAbnormal}">${systemData.alarmCount}<span class="metric-unit">项</span></div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">在线设备</div>
                    <div class="metric-value${onlineAbnormal}">${systemData.onlineDevices}/${systemData.totalDevices}<span class="metric-unit">台</span></div>
                </div>
            `;
        }

        // 获取模式显示名称
        function getModeDisplayName(mode) {
            const modeNames = {
                'realtime': '实时监控',
                'history': '历史回看',
                'simulation': '模拟推演'
            };
            return modeNames[mode] || '未知模式';
        }

        // 生成实时系统数据
        function generateRealtimeSystemData() {
            return {
                overallEfficiency: (85 + Math.random() * 10).toFixed(1),
                equipmentRuntime: (90 + Math.random() * 8).toFixed(1),
                avgEnergyConsumption: (240 + Math.random() * 20).toFixed(1),
                productionLabel: '今日产量',
                production: Math.round(2300 + Math.random() * 200),
                alarmCount: Math.floor(Math.random() * 5) + 1,
                onlineDevices: 24 + Math.floor(Math.random() * 3),
                totalDevices: 26
            };
        }

        // 生成历史系统数据
        function generateHistorySystemData() {
            return {
                overallEfficiency: (80 + Math.random() * 8).toFixed(1),
                equipmentRuntime: (88 + Math.random() * 6).toFixed(1),
                avgEnergyConsumption: (250 + Math.random() * 15).toFixed(1),
                productionLabel: '历史产量',
                production: Math.round(2100 + Math.random() * 150),
                alarmCount: Math.floor(Math.random() * 3) + 2,
                onlineDevices: 23 + Math.floor(Math.random() * 2),
                totalDevices: 26
            };
        }

        // 生成模拟系统数据
        function generateSimulationSystemData() {
            const baseEfficiency = 85;
            const baseRuntime = 92;
            const baseEnergy = 245;
            const baseProduction = 2300;
            
            // 根据模拟参数调整数据
            const efficiency = (baseEfficiency * simulationParams.efficiencyFactor * simulationParams.qualityFactor).toFixed(1);
            const runtime = (baseRuntime * simulationParams.efficiencyFactor).toFixed(1);
            const energy = (baseEnergy / (simulationParams.efficiencyFactor * simulationParams.qualityFactor)).toFixed(1);
            const production = Math.round(baseProduction * simulationParams.loadFactor * simulationParams.qualityFactor);
            
            return {
                overallEfficiency: efficiency,
                equipmentRuntime: runtime,
                avgEnergyConsumption: energy,
                productionLabel: '预测产量',
                production: production,
                alarmCount: Math.floor(Math.random() * 4) + 1,
                onlineDevices: 25,
                totalDevices: 26
            };
        }

        // 模式切换
        function switchMode(mode) {
            // 清除现有的实时更新
            if (realTimeInterval) {
                clearInterval(realTimeInterval);
                realTimeInterval = null;
            }

            // 隐藏编辑面板
            document.getElementById('edit-panel').classList.remove('visible');
            
            // 显示对应的控制面板
            const modePanel = document.getElementById('mode-control-panel');
            const panelTitle = document.getElementById('mode-panel-title');
            const historyControls = document.getElementById('history-controls');
            const simulationControls = document.getElementById('simulation-controls');

            // 先隐藏所有控制面板内容
            historyControls.style.display = 'none';
            simulationControls.style.display = 'none';

            switch(mode) {
                case 'realtime':
                    panelTitle.textContent = '实时监控';
                    // 完全隐藏模式控制面板
                    modePanel.classList.remove('visible');
                    modePanel.style.display = 'none';
                    startRealTimeUpdates();
                    break;
                case 'history':
                    panelTitle.textContent = '历史回看';
                    historyControls.style.display = 'block';
                    modePanel.style.display = 'block';
                    modePanel.classList.add('visible');
                    break;
                case 'simulation':
                    panelTitle.textContent = '模拟推演';
                    simulationControls.style.display = 'block';
                    modePanel.style.display = 'block';
                    modePanel.classList.add('visible');
                    break;
            }

            // 确保左侧指标面板始终可见
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.style.display = 'block';
                sidebar.style.visibility = 'visible';
                sidebar.style.opacity = '1';
                sidebar.style.pointerEvents = 'auto';
            }
            
            // 特别处理实时模式，确保左侧指标面板完全可见
            if (mode === 'realtime') {
                setTimeout(() => {
                    const sidebar = document.querySelector('.sidebar');
                    if (sidebar) {
                        sidebar.style.display = 'block';
                        sidebar.style.visibility = 'visible';
                        sidebar.style.zIndex = '1001';
                    }
                }, 100);
            }

            updateMetrics();
            
            // 更新右侧指标面板
            updateRightMetricsPanel();
            
            // 更新3D模型显示
            update3DModelForMode(mode);
        }

        // 启动实时数据更新
        function startRealTimeUpdates() {
            realTimeInterval = setInterval(() => {
                if (currentMode === 'realtime') {
                    // 如果有选中节点，刷新其指标数据
                    if (selectedNode && selectedNode.id) {
                        // 只更新指标面板，不触发视图切换
                        updateMetricsForNode(selectedNode.id);
                        updateRightMetricsPanel();
                    } else {
                        // 默认更新工厂级别指标
                        updateMetricsForNode('cement-factory');
                        updateRightMetricsPanel();
                    }
                    
                    // 模拟告警数据变化（偶尔）
                    if (Math.random() < 0.1) { // 10%概率更新告警
                        simulateAlarmChanges();
                    }
                }
            }, 2000);
        }

        // 获取当前选中的节点ID
        function getCurrentSelectedNodeId() {
            const activeNode = document.querySelector('.tree-node-content.active');
            return activeNode ? activeNode.getAttribute('data-id') : null;
        }

        // 模拟告警变化
        function simulateAlarmChanges() {
            // 随机更新告警时间或状态
            const randomIndex = Math.floor(Math.random() * alarmData.length);
            const now = new Date();
            alarmData[randomIndex].time = now.getHours().toString().padStart(2, '0') + ':' + 
                                         now.getMinutes().toString().padStart(2, '0');
            alarmData[randomIndex].timestamp = Date.now();
            
            // 更新告警显示
            updateAlarmDisplay();
        }

        // 更新指标 (保留兼容性)
        function updateMetrics() {
            // 如果有选中节点，使用统一的切换函数更新
            if (selectedNode && selectedNode.id) {
                switchToNode(selectedNode.id, 'metrics_update');
            } else {
                // 默认更新工厂级别指标
                switchToNode('cement-factory', 'metrics_default');
            }
        }

        // 加载历史数据
        function loadHistoryData() {
            if (isDataLoading) return;
            isDataLoading = true;

            const date = document.getElementById('history-date').value;
            const startTime = document.getElementById('history-time-start').value;
            const endTime = document.getElementById('history-time-end').value;

            // 模拟数据加载
            setTimeout(() => {
                // 更新历史信息显示
                document.getElementById('history-time-range').textContent = 
                    `${date} ${startTime} - ${endTime}`;
                document.getElementById('history-data-points').textContent = 
                    Math.floor(Math.random() * 500 + 100);

                // 模拟加载历史数据到全局变量
                historyData = generateHistoryData(date, startTime, endTime);
                
                // 应用历史数据到指标显示
                updateMetrics();
                
                isDataLoading = false;
                
                // 提示加载完成
                showNotification('历史数据加载完成！', 'success');
            }, 1000);
        }

        // 生成模拟历史数据
        function generateHistoryData(date, startTime, endTime) {
            const data = {};
            const nodes = ['cement-factory', 'crusher-1', 'ball-mill', 'rotary-kiln'];
            
            nodes.forEach(nodeId => {
                data[nodeId] = {
                    efficiency: Math.random() * 20 + 75, // 75-95%
                    temperature: Math.random() * 100 + 50, // 50-150°C
                    pressure: Math.random() * 2 + 1.5, // 1.5-3.5 MPa
                    vibration: Math.random() * 5 + 10, // 10-15 mm/s
                    power: Math.random() * 100 + 400 // 400-500 kW
                };
            });
            
            return data;
        }

        // 运行模拟推演
        function runSimulation() {
            if (isDataLoading) return;
            isDataLoading = true;

            const baseDate = document.getElementById('sim-base-date').value;
            const baseTime = document.getElementById('sim-base-time').value;
            const targetHours = document.getElementById('sim-target-time').value;

            // 模拟推演计算
            setTimeout(() => {
                const predictions = calculatePredictions();
                
                // 更新预测结果显示
                document.getElementById('predicted-output').textContent = predictions.output;
                document.getElementById('predicted-energy').textContent = predictions.energy;
                document.getElementById('predicted-status').textContent = predictions.status;
                
                // 应用预测数据到指标显示
                updateMetrics();
                
                isDataLoading = false;
                
                // 提示推演完成
                showNotification('模拟推演完成！', 'success');
            }, 1500);
        }

        // 计算预测结果
        function calculatePredictions() {
            const baseOutput = 180; // 基础产量 t/h
            const baseEnergy = 245; // 基础能耗 kWh/t
            
            const outputPrediction = (baseOutput * simulationParams.loadFactor * 
                                    simulationParams.qualityFactor * 
                                    simulationParams.efficiencyFactor).toFixed(1);
            
            const energyPrediction = (baseEnergy / (simulationParams.efficiencyFactor * 
                                    simulationParams.qualityFactor)).toFixed(1);
            
            let status = '正常';
            if (simulationParams.loadFactor > 1.2) status = '高负荷运行';
            else if (simulationParams.efficiencyFactor < 0.9) status = '效率偏低';
            
            return {
                output: outputPrediction,
                energy: energyPrediction,
                status: status
            };
        }

        // 显示通知
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                background: ${type === 'success' ? '#1a4d3a' : '#4d1a1a'};
                color: white;
                border-radius: 4px;
                border-left: 4px solid ${type === 'success' ? '#00ff88' : '#ff4444'};
                z-index: 10000;
                font-size: 14px;
                opacity: 0;
                transform: translateX(100%);
                transition: all 0.3s ease;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // 显示动画
            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // 自动消失
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // 缩放到节点
        function zoomToNode(node) {
            if (currentView === '3d' && camera && controls) {
                // 3D视图中缩放到对应设备
                const targetPositions = {
                    'crusher-1': { x: -10, y: 2, z: -5 },
                    'ball-mill': { x: 0, y: 3, z: -5 },
                    'rotary-kiln': { x: 10, y: 2, z: 0 }
                };
                
                const target = targetPositions[node.id];
                if (target) {
                    // 动画缩放到目标位置
                    const duration = 1000;
                    const startPos = camera.position.clone();
                    const endPos = new THREE.Vector3(target.x + 10, target.y + 10, target.z + 10);
                    
                    const startTime = Date.now();
                    function animateZoom() {
                        const elapsed = Date.now() - startTime;
                        const progress = Math.min(elapsed / duration, 1);
                        
                        camera.position.lerpVectors(startPos, endPos, progress);
                        controls.target.set(target.x, target.y, target.z);
                        controls.update();
                        
                        if (progress < 1) {
                            requestAnimationFrame(animateZoom);
                        }
                    }
                    animateZoom();
                }
            }
        }

        // 导航到节点
        function navigateToNode(nodeId) {
            const nodeElement = document.querySelector(`[data-id="${nodeId}"]`);
            if (nodeElement) {
                nodeElement.click();
            }
        }

        // 应用编辑设置
        function applyEditSettings() {
            // 指标显示/隐藏
            const metricItems = document.querySelectorAll('.metric-item');
            document.querySelectorAll('#edit-panel input[id^="metric-"]').forEach((checkbox, index) => {
                if (metricItems[index]) {
                    metricItems[index].style.display = checkbox.checked ? 'block' : 'none';
                }
            });
            
            // 布局组件显示/隐藏
            const sidebar = document.querySelector('.sidebar');
            const rightMetricsPanel = document.getElementById('right-metrics-panel');
            const breadcrumb = document.querySelector('.breadcrumb');
            
            if (document.getElementById('layout-sidebar').checked) {
                sidebar.style.display = 'block';
            } else {
                sidebar.style.display = 'none';
            }
            
            if (document.getElementById('layout-right-metrics').checked) {
                rightMetricsPanel.classList.remove('hidden');
                rightMetricsPanel.style.display = 'block';
            } else {
                rightMetricsPanel.classList.add('hidden');
                rightMetricsPanel.style.display = 'none';
            }
            
            if (document.getElementById('layout-breadcrumb').checked) {
                breadcrumb.style.display = 'block';
            } else {
                breadcrumb.style.display = 'none';
            }
        }

        // 加载工厂数据
        function loadFactoryData() {
            // 模拟从服务器加载数据
            factoryData = {
                factory: {
                    name: '水泥工厂',
                    status: 'running',
                    workshops: ['crushing', 'grinding', 'burning']
                }
            };
        }

        // 强制显示左侧指标面板的调试函数
        function forceShowSidebar() {
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.style.cssText = `
                    width: 300px !important;
                    background: #2d2d2d !important;
                    border-right: 1px solid #444 !important;
                    overflow-y: auto !important;
                    position: relative !important;
                    z-index: 1001 !important;
                    display: block !important;
                    visibility: visible !important;
                    opacity: 1 !important;
                `;
                console.log('强制显示左侧指标面板');
            } else {
                console.error('找不到左侧指标面板元素');
            }
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            init();
            
            // 延迟确保左侧指标面板可见
            setTimeout(forceShowSidebar, 500);
            
            // 延迟初始化工具提示，确保DOM完全加载
            setTimeout(initIconButtonTooltips, 100);
            
            // 添加调试信息
            console.log('页面初始化完成，当前模式:', currentMode);
        });

        // 全局函数，供HTML调用
        window.goBackLevel = goBackLevel;
        window.navigateToBreadcrumbNode = navigateToBreadcrumbNode;
        window.navigateToAlarmDevice = navigateToAlarmDevice;
        window.handleAlarmAction = handleAlarmAction;
        window.clearAlarmFilter = clearAlarmFilter;
    </script>
</body>
</html> 